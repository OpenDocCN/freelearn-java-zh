

# 第十六章：代码监控和维护

编写高效的代码不足以确保我们的 Java 应用程序在系统初始发布后仍能以高水平运行。我们必须采用强大的代码监控和维护策略，以确保我们的系统即使在数据和使用量增加以及环境发生变化的情况下，也能继续以期望的水平运行。本章重点介绍了代码监控和维护的关键实践和相关工具。

我们本章从探索我们可以使用的**应用性能管理（APM**）工具开始，这些工具可以用于实时监控并获取诊断数据，帮助我们保持应用程序的高效运行。我们的 APM 工具探索将包括用例和实施策略。

**代码审查**的重要性也得到了涵盖，目的是培养对持续过程改进的奉献精神，特别是持续维护代码质量。对最佳实践和自动化工具的见解将为您提供有关如何使用所选工具和实践来识别代码中潜在问题的知识，从而在它们导致不期望的系统行为并负面影响用户体验之前。

本章还介绍了日志记录的概念，并分享了它如何有效地用于监控应用程序。我们将探讨最佳实践、日志框架以及如何分析日志数据。我们的目标是记录正确的数据，并学会使用记录的数据来识别优化机会，而不会引入过多的系统开销。

本章涵盖了以下主要主题：

+   APM 工具

+   代码审查

+   记录

+   监控和警报

+   维护策略

# APM 工具

Java 开发者花费在维护系统上的时间比开发系统的时间多。这是因为我们的系统在生产中的时间比编写和测试代码的时间长。因此，我们应该认真对待**应用性能管理（APM**），并认识到它在确保我们的系统持续以最佳性能运行并最大化用户体验方面所起的至关重要作用。

## APM 工具概述

APM 工具旨在帮助我们监控系统，以管理其性能。这些工具提供了对我们应用程序性能的实时洞察。它们可以帮助我们识别潜在的瓶颈和可能的优化机会，例如资源使用。由 APM 工具生成的度量标准可以与基线进行比较，并为我们提供系统整体健康状况的真实画面。

APM 工具的主要目标包括以下内容：

+   确保应用可靠性

+   确保应用可扩展性

+   识别性能问题

+   提供可操作的见解

+   实时应用监控

+   用户交互跟踪

接下来，让我们看看 APM 工具的关键特性。

## APM 工具关键特性

APM 工具的范围从基础到强大，可以具有各种功能。以下是 APM 工具的 10 个关键功能，不分先后顺序：

+   根据性能阈值提供可配置的警报

+   监控系统资源使用情况

+   持续监控应用程序性能，如响应时间

+   通过跟踪单个事务来识别性能瓶颈

+   识别并记录异常和错误，提供足够的详细信息以支持故障排除

+   跟踪和测量用户交互，如事务持续时间和加载时间

+   进行深入分析

+   提供分析数据的数字和可视化报告

+   与其他工具（如 CI/CD 管道）集成

+   自动化性能管理流程

既然我们已经认识到 APM 工具的重要性、它们的目标和关键特性，让我们回顾一下用于 Java 应用程序监控的五个常见 APM 工具。

## 流行的事务性能管理（APM）工具

可用于 Java 应用程序开发者的 APM 工具种类繁多。下表列出了五个常见工具，并为每个工具提供了简要描述和 URL。

| **工具** | **描述** | **URL** |
| --- | --- | --- |
| **AppDynamics** | 具有出色 Java 应用程序可见性的强大性能监控工具 | [`www.appdynamics.com/product/application-performance-monitoring`](https://www.appdynamics.com/product/application-performance-monitoring) |
| **Datadog** | 基于云的监控和分析工具 | [`www.dynatrace.com/monitoring/solutions/cloud-monitoring-cio-report/`](https://www.dynatrace.com/monitoring/solutions/cloud-monitoring-cio-report/) |
| **Dynatrace** | 利用人工智能进行性能监控的高级工具 | [`www.dynatrace.com/monitoring/platform/application-observability/`](https://www.dynatrace.com/monitoring/platform/application-observability/) |
| **Elastic APM** | 开源性能监控工具 | [`www.elastic.co/observability/application-performance-monitoring`](https://www.elastic.co/observability/application-performance-monitoring) |
| **New Relic** | 可能是使用最广泛的工具，具有广泛的监控和分析功能 | [`www.newrelic.com`](https://www.newrelic.com) |

表 16.1：Java 应用程序的流行 APM 工具

关于 URL 的说明

以下表中列出的 URL 在本书首次出版时是有效的。如果您发现链接已不再有效，您可以搜索工具名称加上*Java 应用程序的 APM 工具*（例如，*Java 应用程序的 Dynatrace APM 工具*）来找到新的链接。

您应该花时间尝试每个 APM 工具，以确定您想使用哪一个或哪几个。一旦您有了使用哪一个或哪几个的想法，您就可以查看下一节中提出的最佳实践。

## APM 工具最佳实践

无论您采用哪种 APM 工具，都有一些最佳实践可以帮助您充分利用所选工具来支持您的监控工作。以下是一些您可以考虑的最佳实践：

+   定期分析您的性能数据。这可以帮助您识别趋势和异常。

+   安排并定期审查您的 APM 配置和性能数据。

+   建立明确的表现监控目标，并与您的组织目标保持一致。

+   创建您的**关键绩效指标**（**KPIs**），并定期审查它们的相关性。

+   在您的团队中建立性能意识文化。

+   实施全面的仪器化方法，确保可以监控到所有内容。

+   将 APM 工具集成到您的 DevOps 流程中。

+   优先监控您最关键的指标，如错误率、响应时间、资源使用等。

+   配置您的 APM 工具，以便为您提供警报和通知，以提高效率。

遵循这里提出的最佳实践可以帮助您最大化使用 APM 工具的益处。

# 代码审查

代码审查是软件开发的基本组成部分。正如我们之前建议的，代码质量在上线后不会保持不变。环境会变化，新的数据会被引入，可能会发生扩展，用户行为也可能发生变化。这强调了进行代码审查的重要性。

代码审查的目的如下：

+   确保遵守标准和指南的一致性

+   鼓励协作

+   促进团队之间的知识转移，并增加个人对代码质量的承诺

+   提高优化

+   使用质量保证识别缺陷和安全漏洞

接下来，让我们回顾一下进行代码审查时的最佳实践。

## 最佳实践

在进行代码审查时，以下是一些自我描述性的最佳实践供您考虑：

+   尽可能实现自动化

+   鼓励建设性的反馈

+   建立编码标准

+   限制代码更改的大小

+   优先处理关键代码部分

+   设定代码审查时间限制

+   使用清单以确保审阅者的统一性

第一项最佳实践建议您尽可能实现自动化。有一些自动代码审查工具值得您独立研究和分析。以下是一些供您审查的列表：

+   **Checkstyle**

+   **Code Climate**

+   **FindBugs**及其继任者**SpotBugs**

+   **PMD**

+   **SonarQube**

仔细审查自动化工具。一旦您选择了最喜欢的一个，在正式将其用于实际项目之前，先对其进行实验。接下来，让我们看看同行评审流程。

## 同行评审流程

代码审查通常由同行进行，如果不正确处理，可能会显得尴尬。以下是一些进行正确和高效同行评审的建议：

+   指派具有适当专业知识和经验的审阅者

+   轮换审阅者以减轻懈怠

+   通过强制在代码中添加注释标准来为审查做准备

+   使用代码审查工具（如 GitHub 拉取请求）来简化流程

+   鼓励相互尊重和开放沟通的氛围

+   跟进所有反馈

遵循这些提示可以减轻尴尬并提高同行审查的效率。接下来，让我们看看一些关于代码审查的常见陷阱。

## 常见陷阱

在进行代码审查时存在几个陷阱，尽管这些陷阱被我们从过程中获得的益处所掩盖。本节将探讨进行代码审查时遇到的前五大陷阱，并提出解决方案。

| **陷阱** | **解决方案** |
| --- | --- |
| 延迟审查 | 设定清晰的截止时间并将它们整合到你的开发工作流程中。 |
| 标准不统一 | 建立明确的指南并使用清单。 |
| 缺乏建设性反馈 | 专注于提供建设性反馈。要具体，并确保反馈是可操作的。 |
| 忽视自动化工具 | 利用自动化工具的优势。它们可以在你的开发者审查更复杂问题时捕捉到常规问题。 |
| 审查时间过长 | 保持审查简短且频繁。 |

表 16.2：常见的代码审查陷阱及解决方案

了解这些陷阱可以帮助确保你的代码审查无缝集成到你的工作流程中。

在下一节中，我们将审查日志。

# 日志

日志数据是代码监控和维护的基本组成部分。这些数据可以揭示有关我们的代码性能、失败的地方、可能存在的安全担忧等方面的信息。它涉及记录程序运行的信息。我们可以使用这些信息进行审计、调试和监控。

日志的关键方面包括以下内容：

+   `DEBUG`、`ERROR`和`INFO`。

+   **日志消息**：这是应用程序事件的叙述性描述。

+   **日志轮转**：我们通过存档旧日志并开始新的日志来轮转日志。这防止了难以管理的大型日志，并可能导致存储问题。

+   **日志目标**：目标是日志的存储目的地。

现在我们对日志有了基本了解，让我们来回顾一些最佳实践。

## 最佳实践

我们的日志实现应专注于所捕获内容的相关性和系统的效率。考虑到这些目标，以下是关于日志的一些最佳实践：

+   对日志采用简洁但描述性的心态。你希望它们清晰，而不是过于冗长。

+   将日志集中化以方便聚合和综合处理。

+   考虑使用结构化日志格式，如 JSON，以便更容易解析和分析。

+   专注于与你的系统最关键流程相一致的日志级别。

+   将你的日志实践规范化，包括格式和命名约定。

+   保护个人可识别信息或其他敏感数据不被包含在日志中。

+   定期审查你的日志。

接下来，我们将审查有用的日志框架。

## 日志框架

我们可以使用几个日志框架来为我们的 Java 应用程序服务。开发者通常在审查了他们的选项后选择一个。以下是一些更受欢迎的框架列表：

+   `java.util.logging`）。虽然它只提供基本的日志功能，但我们可以在不需要额外库的情况下使用它。如果您刚开始使用日志，这是一个很好的框架。

+   **Log4j2**：这是一个支持各种配置、日志级别、类型和目的地的先进框架。

+   **Logback**：这个框架提供了一个与**Java**的**Simple Logging Facade**（SLF4J）兼容的高性能选项。

+   **SLF4J**：这个框架提供了一个抽象层，以支持多个日志框架，如 Logback。

+   **Tinylog**：正如其名所示，这是一个轻量级框架，具有低开销。它非常适合小型应用程序。

这些框架可以帮助简化我们的日志实现和管理。接下来，让我们看看分析我们日志数据的关键策略。

## 分析日志数据

日志系统数据的一个主要原因是提供给我们分析它的能力，以改善我们系统整体性能。以下是一些您可以用于分析和管理日志数据的策略：

+   **聚合**：将您的日志输入到一个中央存储库中，以便更有效地分析。有几个工具（如**Logstash**和**Elasticsearch**）可以帮助实现这一策略。

+   **分析**：使用工具（如**Datadog**和**Graylog**）来帮助分析和可视化日志数据。使用统计分析来获得深入见解。

+   **自动化**：使用基于您设置的阈值的自动警报来通知您活动情况。

+   **存档**：存档日志以避免日志膨胀。

遵循最佳实践并利用选定的框架和工具可以帮助确保您的日志工作是有目的和高效的。接下来，让我们看看如何设置监控和警报。

# 监控和警报

当我们想要回顾日志数据时，我们的日志数据总是可用的，但更重要的是，它可以基于我们如何设置来提供自动警报。有效的监控和警报是维护我们的 Java 应用程序并确保其高性能和安全性的关键操作。

监控和警报可以帮助我们实时了解应用程序的性能，并及时提醒我们任何需要立即采取行动的问题。

## 监控系统设置

设置监控系统的步骤将取决于您选择的框架和工具。以下是一个六步流程，无论您选择哪些框架和工具都可以使用：

1.  **识别关键指标**：您需要知道您想要收集什么，以便收集的内容是有用的。您的重要指标可能包括 CPU 使用率、内存使用、错误率、响应时间等。一旦您确定了关键指标，您就可以建立性能目标。

1.  **选择监控工具**：选择最适合你的应用程序架构和要求的监控工具（例如**Grafana**、**New Relic**或**Prometheus**）。

1.  **集成监控代理**：将监控代理集成到你的 Java 应用程序中以收集性能数据。根据你的解决方案，你可能需要添加特定的监控代码，利用现有框架的内置功能，或者使用 API。

1.  **设置数据收集**：配置你的监控系统以收集和存储性能数据。要谨慎，并确保数据收集操作高效，不会导致显著的应用程序开销。

1.  **可视化**：创建或使用由你的监控工具提供的仪表板来直观地表示收集到的数据。你可以使用 Grafana 等工具构建交互式仪表板，这有助于你快速了解应用程序的性能状态。

1.  **审查和调整**：定期审查你的监控设置的有效性，并做出必要的调整。每次引入新的组件或服务时，都要重新评估这一点。

一旦你的监控系统已经设置好，你就可以准备配置它以提供信息丰富的警报。

## 警报配置

配置警报涉及设置阈值和规则，当满足某些性能条件时触发通知。按照以下步骤设置有效的警报架构：

1.  **定义标准**：确定你想要警报的条件，并具体说明。例如，你可能会选择 92%的 CPU 使用率、增加的响应时间、错误激增等。你可以根据历史应用程序数据和性能基准来设置你的阈值。

1.  **设置级别**：根据严重性（即**信息**、**警告**、**关键**）对警报进行分类，以便你的团队能够优先处理响应工作。

1.  **配置通道**：设置警报通知的通道，以便你的团队能够得到通知。你可能只需要使用**短信**、电子邮件、**Slack**或**Discord**，或者实施一个事故管理平台，如**PagerDuty**。

1.  **微调阈值**：在设置警报时，你想要避免警报疲劳。这将需要你微调你的警报阈值。用不必要的警报淹没你的团队将抵消你的警报系统的有效性。

1.  **测试**：定期测试你的警报设置以确保其正常工作。你甚至可以进行演习来模拟性能情况，以验证你系统的有效性。

一旦你的警报系统已经设置好，你需要确定你的响应方法。

## 警报和事故响应

建立正式的事故响应方法很重要。在建立你的警报响应架构时，考虑以下问题：

+   哪些警报需要响应？

+   谁响应哪些警报？

+   需要哪些内部沟通？

+   需要哪些外部沟通？

+   需要哪些后续操作？

采用结构化的方法来应对警报和事件，可以帮助确保关键问题得到适当的处理。这可以导致快速解决和最小化停机时间。

有效的警报和事件响应方法的关键组成部分包括以下内容：

+   **警报确认**：收到警报时，应立即确认。您可以为您团队设定最大响应时间。

+   **评估**：调查每个警报以了解根本原因。目标是不仅解决当前问题，还要防止问题在未来重复发生。

+   **计划的执行**：确保您的团队在问题解决过程中遵循预定义的事件响应计划。这些计划应包括针对常见问题和复杂问题的文档化步骤。

+   **沟通**：使用预定义的沟通渠道，让内部和外部利益相关者了解事件状态和解决进度。

+   **文档**：在解决事件后，应记录根本原因、解决步骤和经验教训。在适当的情况下，与您的团队进行事件后审查，以确定改进机会。

当我们设置了一个强大而有目的的监控和警报系统时，我们显著提高了维护和改进 Java 应用程序性能的能力，即使它们在扩展。

# 维护策略

我们需要一个策略来维护我们的应用程序代码，这超出了仅仅响应系统警报的范围。当我们采取有目的的代码维护方法时，我们可以确保 Java 应用程序的持续可靠性、可用性和性能。

主要概念是在计划维护和反应性维护之间保持平衡。下表提供了每种方法的见解，包括它们的优点和最佳实践。

|  | **预定维护** | **反应性维护** |
| --- | --- | --- |
| **方法细节** | 计划在预定间隔更新代码 | 随时解决出现的问题 |
| **优点** |

+   可预测的停机时间

+   降低故障风险

+   持续优化

|

+   立即解决问题

+   相比于预定维护方法，需要的资源更少

|

| **最佳实践** |
| --- |

+   建立并遵循维护计划

+   在维护窗口期间测试变更

+   将计划传达给内部和外部利益相关者

|

+   实施强大的监控和警报系统

+   创建事件响应计划

+   创建文档以支持故障排除

|

表 16.3：预定维护和反应性维护方法比较

一旦您已经建立了维护方法，您应该考虑文档化和知识管理。让我们在下一节中看看这一点。

## 文档化和知识管理

有效的文档和知识管理对于维护健康的代码库无疑是至关重要的。它还可以帮助确保维护活动期间平稳过渡。

文档应该是全面的，特别是对于大型系统。全面的文档应包括以下主要组件：

+   API 文档

+   代码文档

+   配置文档

同时，拥有一个知识共享组件也很重要，这可能包括内部维基和为新团队成员提供培训。随着系统的更新，知识共享工件应进行更新，以确保它们保持相关性。知识共享的方式几乎与共享的内容一样重要。可以使用**团队**、**SharePoint**、**Confluence**和**GitHub 维基**等协作工具来促进协作文档和知识共享。

维护策略通常包括**重构**，我们将在下一节中对其进行回顾。

## 重构策略

重构是重新利用现有代码而不改变其外部行为的过程。重构的目的是提高代码的可读性、可维护性和性能。

我们可以通过**代码异味**来识别重构的需求，这些异味是设计不良的代码、重复代码、大型或长类和方法等迹象。性能瓶颈和复杂逻辑也是代码应该重构的额外指标。

以下技术可用于重构您的代码：

+   将大型类和方法分解为更小、更易于管理的组件。

+   重命名类、方法和变量，使它们具有意义且自我描述。这种增加的代码清晰度提高了整体的可读性和可维护性。

+   删除未使用的代码。

+   将复杂的条件逻辑简化为更清晰、更易读的结构。

当重构我们的代码时，我们应该努力以小步骤、增量方式进行重构。这将最小化引入新错误的风险。我们应该在重构前后始终编写**单元测试**（见*第十七章*，*单元和性能测试*）。这有助于我们确保功能保持不变。最后，我们应该使用版本控制系统来跟踪我们的更改，并在必要时支持代码**回滚**。

有时我们继承系统并必须维护遗留代码。这将在下一节中介绍。

## 遗留代码

遗留代码是指较老的代码库。由于过时的实践、缺乏文档或已弃用的技术（即使用**通用商业面向** **语言**（**COBOL**）编写的系统），它们通常难以维护。

当继承遗留代码库时，我们应首先进行全面代码审查，以识别问题区域、过时的依赖项和安全漏洞。凭借代码审查的知识，我们可以优先考虑代码中需要立即关注或存在重大风险或安全漏洞的关键部分。

当可行时，我们应该采用针对遗留代码的现代化策略。这可能包括以下组件：

+   实施增量更新

+   使用代码包装器实现新功能

+   自动化变更的测试

+   记录遗留代码及其变更

+   实施备份方案

+   使用版本控制系统

+   将遗留组件从系统其余部分隔离

+   对开发者进行遗留代码和维修计划的培训

实施这些维护策略可以帮助你确保 Java 应用程序的持续稳定性和性能。这些策略旨在使代码更容易更新、维护和随时间扩展。

# 摘要

本章探讨了有效代码监控和维护的基本实践和工具，重点关注确保长期性能、可靠性、安全性和可扩展性。我们首先概述了 APM 工具，详细介绍了它们的关键功能，如实时监控、事务跟踪、错误跟踪和用户体验监控。我们回顾了 Java 中流行的 APM 工具，以及它们的实施和使用最佳实践。

我们强调了代码审查对于保持高质量代码的重要性。我们涵盖了最佳实践，详细说明了同行评审流程，并分享了常见的陷阱，提供了避免解决方案。

检查了日志的概念，从基础开始，包括日志级别、消息和目标。我们概述了有效日志记录的最佳实践，例如使用适当的级别、避免敏感信息以及集中日志。我们还介绍了 Java 中流行的日志框架，并讨论了分析和管理日志数据的技术。

强调了监控和警报。我们介绍了如何设置全面的监控系统，以及警报配置和事件响应策略。我们通过介绍维护策略来结束本章。我们比较了计划性和反应性维护方法，强调了主动规划的重要性。我们强调了文档和知识管理在维护健康代码库中的作用。最后，我们探讨了有效的重构策略，并提供了如何处理遗留代码的指导。

在下一章中，我们将介绍创建和使用单元测试和性能测试的策略，以帮助创建和维护高性能的 Java 应用程序。具体来说，我们将探讨单元测试、性能测试和总体策略。
