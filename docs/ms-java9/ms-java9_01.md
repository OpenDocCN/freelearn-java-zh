# 第一章：Java 9 的景象

Java 自从第一个版本发布以来，已经是一个成熟的成年人了。拥有令人惊叹的开发者社区，并在多个行业中得到广泛应用，该平台继续发展和与世界其他地区保持一致，无论是在性能、安全性还是可扩展性方面。我们将从探索 Java 9 引入的最显著特性开始，探讨它们背后的最大推动力，以及我们可以在平台后续发展中期待什么，以及一些没有包含在本版本中的内容。

在本章中，我们将涵盖以下主题：

+   Java 9 从 20,000 英尺的高度看

+   打破单体架构

+   在 Java Shell 中玩耍

+   掌控外部进程

+   使用 G1 提升性能

+   使用 JMH 测量性能

+   准备迎接 HTTP 2.0

+   包含响应式编程

+   扩展愿望清单

# Java 9 从 20,000 英尺的高度看

你可能会问自己——Java 9 不就是一个包含了一些没有进入 Java 8 的特性的维护版本吗？Java 9 中有很多新特性，使其成为一个独特的版本。

毫无疑问，Java 平台（作为 Jigsaw 项目的一部分开发）的模块化是使其在 Java 9 中成功的关键部分。最初计划在 Java 8 中实施，但被推迟，Jigsaw 项目也是 Java 9 最终发布进一步推迟的主要原因之一。Jigsaw 还引入了 Java 平台的一些显著变化，这也是 Java 9 被认为是重大版本的原因之一。我们将在后续章节中详细探讨这些特性。

**JCP**（**Java 社区进程**）提供了将一组特性提案（也称为**Java 增强提案**或**JEPs**）转化为正式规范的手段，这些规范为通过新功能扩展平台提供了基础。在这方面，Java 9 并无不同。除了与 Jigsaw 相关的 Java 增强提案外，还有许多其他增强功能被纳入 Java 9。在本书中，我们将根据相应的增强提案，以逻辑组的形式讨论各种特性，包括以下内容：

+   **Java Shell**（也称为**JShell**）——Java 平台的交互式 Shell

+   新的 API，用于以可移植的方式与操作系统进程一起工作

+   在 Java 7 中引入的**垃圾收集器**（**G1**）在 Java 9 中被设置为默认的垃圾收集器

+   添加**Java 微基准工具**（**JMH**），该工具可以用于对 Java 应用程序进行性能基准测试，作为 Java 发行版的一部分

+   通过新的客户端 API 支持 HTTP 2.0 和 WebSocket 标准

+   并发增强，其中定义了`Flow`类，该类描述了 Java 平台中响应式流规范的接口

一些最初被接受用于发布 9 的提案没有成功实现，并推迟到了以后的版本，以及其他开发者可能期待的未来有趣事物。

如果您渴望在尝试浏览其他章节和尝试新引入的示例和概念之前动手实践，可以从 [`www.oracle.com/technetwork/java/javase/downloads/index.html`](http://www.oracle.com/technetwork/java/javase/downloads/index.html) 下载适用于您系统的 JDK 9 分发版。

# 打破单体

几年来，Java 平台的实用性持续发展和增加，使其成为了一个庞大的单体。为了使平台更适合嵌入式和移动设备，有必要发布简化版，如 Java CDC 和 Java ME。然而，这些版本在满足 JDK 提供的功能性方面变化多端的应用需求时，证明还不够灵活。在这方面，模块化系统的需求变得迫切，不仅是为了解决 Java 工具的模块化（总体而言，超过 5000 个 Java 类和 1500 个 C++ 源文件，Hotspot 运行时拥有超过 25,0000 行代码），而且还为了提供一个机制，让开发者可以使用与 JDK 中相同的模块系统来创建和管理模块化应用程序。Java 8 提供了一种中间机制，允许应用程序仅使用整个 JDK 提供的 API 子集，这种机制被命名为紧凑配置文件。实际上，紧凑配置文件还为后续工作奠定了基础，这些工作是为了打破 JDK 各个不同组件之间的依赖关系，从而实现 Java 中的模块化。

模块化系统本身是在名为 Jigsaw 项目的名称下开发的，基于此，形成了几个 Java 增强提案和一个目标 JSR（376）。为了满足 Jigsaw 项目的需求，已经做了很多工作——有概念实现的经验，提出的特性比成功进入 Java 9 的特性要多。除此之外，还对 JDK 代码库进行了完全重构，并对 JDK 可分发镜像进行了完全重组。

在社区中，关于是否应该采用现有的成熟 Java 模块系统（如 OSGi）作为 JDK 的一部分，而不是提供一个全新的模块系统，存在相当大的争议。然而，OSGi 针对运行时行为，如模块依赖的解析、安装、卸载、模块（在 OSGi 中也称为捆绑包）的启动和停止、自定义模块类加载器等。然而，Project Jigsaw 针对的是编译时模块系统，其中依赖关系的解析发生在应用程序编译时。此外，将模块作为 JDK 的一部分进行安装和卸载，消除了在编译时显式将其作为依赖项包含的需要。此外，通过现有的类加载器层次结构（引导、扩展和系统类加载器），可以实现模块类的加载，尽管，使用与 OSGi 模块类加载器相当的自定义模块类加载器是可能的。然而，后者已被放弃；当我们讨论 Java 模块系统细节时，我们将更详细地讨论 Java 模块类加载。

Java 模块系统带来的额外好处包括增强的安全性和性能。通过将 JDK 和应用程序模块化成 Jigsaw 模块，我们能够在组件及其对应的领域之间创建明确的边界。这种关注点的分离与平台的安全架构相一致，并且是提高资源利用率的推动力。我们专门用两章详细介绍了所有上述要点，以及采用 Java 9 的主题，这也需要对将现有项目迁移到 Java 9 的可能方法有一定的了解。

# 在 Java Shell 中玩耍

很长一段时间以来，Java 编程语言没有提供标准 shell 以供实验新的语言特性或库，或者用于快速原型设计。如果您想这样做，可以编写一个带有 main 方法的测试应用程序，使用 `javac` 编译它，然后运行。这可以在命令行或使用 Java IDE 中完成；然而，在这两种情况下，这都不如拥有一个交互式 shell 来得方便。

在 JDK 9 中启动交互式 shell 与运行以下命令一样简单（假设 JDK 9 安装中的 `bin` 目录位于当前路径）：

```java
jshell
```

你可能会觉得有些困惑，因为在 Java 平台上，交互式外壳之前没有被引入，就像许多编程语言（如 Python、Ruby 以及其他一些语言）在它们的早期版本中已经包含了交互式外壳一样；然而，这仍然没有成为早期 Java 版本的优先功能列表，直到现在，它已经出现并准备好使用。Java 外壳利用了 JShell API，该 API 提供了启用自动完成或评估表达式和代码片段等功能。有一整章专门讨论 Java 外壳的细节，以便开发者能够最大限度地利用它。

# 在 JDK 9 之前，如果你想要创建一个 Java 进程并处理进程的输入/输出，你必须使用 `Runtime.getRuntime.exec()` 方法，它允许我们在单独的 OS 进程中执行一个命令，并获取一个 `java.lang.Process` 实例，通过它提供某些操作来管理外部进程，或者使用新的 `java.lang.ProcessBuilder` 类，它在与外部进程交互方面提供了一些增强，并创建了一个 `java.lang.Process` 实例来表示外部进程。这两种机制都不灵活，也不便携，因为外部进程执行的命令集高度依赖于操作系统（需要付出额外的努力才能使特定的进程操作在多个操作系统之间便携）。有一章专门介绍新的进程 API，为开发者提供创建和管理外部进程的更简单方式的知识。

控制外部进程

# 使用 G1 提升性能

G1 垃圾收集器在 JDK 7 中已经被引入，现在在 JDK 9 中默认启用。它针对的是具有多个处理核心和大量可用内存的系统。与之前的垃圾收集器类型相比，G1 的优势是什么？它是如何实现这些改进的？是否需要手动调整它，以及在什么场景下？这些问题以及更多关于 G1 的问题将在单独的章节中讨论。

# 使用 JMH 测量性能

在许多情况下，Java 应用程序可能会遭受性能下降。加剧这个问题的是缺乏性能测试，这些测试至少可以提供一组保证，即满足性能要求，而且某些功能的性能不会随时间下降。测量 Java 应用程序的性能并不简单，特别是由于存在许多可能影响性能统计信息的编译器和运行时优化。因此，必须使用额外的措施，如预热阶段和其他技巧，以提供更准确的性能测量。Java Microbenchmark Harness 是一个框架，它结合了多种技术，并提供了方便的 API，可用于此目的。它不是一个新工具，但包含在 Java 9 的发行版中。如果您还没有将 JMH 添加到您的工具箱中，请阅读关于在 Java 9 应用程序开发中使用 JMH 的详细章节。

# 开始使用 HTTP 2.0

HTTP 2.0 是 HTTP 1.1 协议的继任者，这个新版本的协议解决了前一个版本的一些局限性和缺点。HTTP 2.0 在多个方面提高了性能，并提供了如请求/响应多路复用、服务器推送响应、流量控制和请求优先级等功能。

Java 提供了`java.net.HttpURLConnection`实用工具，可用于建立非安全的 HTTP 1.1 连接。然而，该 API 被认为难以维护，并且随着对 HTTP 2.0 的支持而进一步扩展，因此引入了一个全新的客户端 API，用于通过 HTTP 2.0 或 WebSocket 协议建立连接。新的 HTTP 2.0 客户端及其提供的能力将在专门的章节中介绍。

# 包含响应式编程

响应式编程是一种用于描述系统变化传播特定模式的范式。响应性并非 Java 本身所固有的，但可以使用 RxJava 或项目 Reactor（Spring 框架的一部分）等第三方库建立响应式数据流。JDK 9 也通过提供`java.util.concurrent.Flow`类来满足开发基于响应式流理念的高度响应性应用程序的 API 需求。`Flow`类以及 JDK 9 中引入的其他相关更改将在单独的章节中介绍。

# 扩展愿望清单

除了 JDK 9 中的所有新功能外，平台未来版本预计还将引入一系列全新的功能。其中以下是一些：

+   **原始类型上的泛型**：这是 JDK 10 计划中的功能之一，作为 Valhalla 项目的一部分。其他语言增强功能，如值处理，已经包含在 Java 9 中，并将在此书的后续章节中介绍。

+   **具现泛型**：这是 Valhalla 项目另一个特色部分，旨在提供在运行时保留泛型类型的能力。相关目标如下：

    +   外部功能接口旨在引入一个新的 API 来调用和管理本地函数。该 API 解决了 JNI 的一些缺点，特别是为应用程序开发者使用时的缺乏简便性。外部功能接口是作为 JDK 生态系统中的 Panama 项目的一部分开发的。

    +   新的货币和货币 API（在 JSR 354 下开发）最初计划在 Java 9 中推出，但被推迟。

    +   新的轻量级 JSON API（在 JSR 353 下开发）也计划在 Java 9 中推出，但推迟到 Java 10。

这些只是 JDK 后续版本中可能期待的一些新功能。Penrose 项目旨在弥合 Java 模块系统与 OSGi 模块系统之间的差距，并为两个系统之间的互操作性提供不同的方法。

Graal VM 是另一个有趣的研究项目，是 Java 平台后续版本的一个潜在候选者。它旨在将 Java 的运行时性能提升到动态语言如 JavaScript 或 Ruby 的水平。

一章专门讨论 JDK 的未来，详细讨论了所有这些观点。

# 摘要

在这一简短的介绍性章节中，我们揭示了 JDK 9 提供的功能小宇宙。在这个平台版本中引入的模块系统无疑是 Java 应用程序开发的一个基石。我们还发现，JDK 9 中引入了许多其他重要功能和变更，值得特别关注，将在后续章节中详细讨论。

在下一章中，我们将探讨 Java 平台 26 项内部变更。
