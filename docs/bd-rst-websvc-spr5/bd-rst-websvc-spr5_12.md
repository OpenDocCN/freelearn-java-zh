# 第十二章：微服务基础知识

尽管单体架构有其自身的好处，但当应用程序变得越来越大以支持各种类型的业务逻辑时，它给开发人员和部署工程师带来了很大的困难。即使是后端的一个小 bug 修复也会迫使开发人员在服务器上重新部署整个应用程序，导致不必要的维护。另一方面，微服务提供了将业务逻辑分离成服务的选项。因此，应用程序可以在不中断流程的情况下推送到服务器，尤其是最终用户不应该注意到任何中断。在本章中，我们将深入探讨一些关于微服务和相关主题的基础知识。

在本章中，我们将讨论：

+   单体架构及其缺点

+   微服务及其优势

+   微服务的基本特征

+   微服务组件

+   微服务工具

# 单体架构及其缺点

尽管微服务架构如今越来越受欢迎，但大多数公司仍然使用单体架构。作为单体应用程序，您可以将所有业务模块捆绑成一个单一单元，并将它们部署在所有需要的服务器上。如果应用程序需要进行任何更改，开发人员必须提供这些更改并重新部署应用程序的更新版本。在单体架构中，我们遵循服务模块之间的紧密耦合。

尽管单体架构有一些好处，但其缺点为另一种架构设计——微服务铺平了道路。在这里，我们将简要讨论单体架构的缺点：

+   对于每个 bug 修复或代码更改，我们必须在所有服务器上重新部署整个应用程序

+   如果单体应用程序存在任何常见问题，比如性能问题，它将影响整个应用程序，这可能很难找出并快速修复

+   更大的应用程序在部署期间可能需要更长的启动时间

+   库需求和冲突可能影响整个应用程序。我们将很难修复库以支持所有模块

+   单体架构的扩展可能很困难，因为所有模块都在一个统一的范围内

+   应用程序增长时，业务逻辑和实现的复杂性也会增加，这可能需要更多的时间来开发和维护

+   不经常、昂贵和大规模的部署选项：如果我们有多种类型的业务逻辑和层，并且想要升级一个业务逻辑，我们将需要部署所有其他层/服务

+   紧密耦合的服务在一个服务/层需要升级时会带来困难

# 服务发现

在微服务架构中，根据业务需求和服务负载，我们可能需要增加服务实例。在这种情况下，跟踪所有可用的服务实例及其信息，如端口号，可能很难管理。服务发现将帮助我们通过自动配置服务实例并在需要时查找它们来管理这些任务。

# 微服务简介

在一个大型应用程序中做一些改变对开发人员来说是一个不断的痛苦。每次我们在代码中做一个小改变，我们可能需要将整个应用程序部署到服务器上，这是一个耗时且繁琐的过程，特别是当我们有多个服务，比如会计、报告、用户管理等。微服务帮助我们摆脱这种痛苦。微服务的主要目标是将应用程序拆分为服务，并独立部署每个服务到我们的服务器上。通过这样做，我们在应用程序中提供了松散耦合的进程。此外，微服务可以部署在云中，以避免服务中断问题，并为消费者提供不间断的服务。

在微服务中，每个模块或业务部分都可以编写为一个单独的服务，以提供持续交付和集成。这些服务旨在满足特定的业务需求，并且可以通过自动化部署基础设施独立部署。管理这些服务可以是分散的，并且可以以不同的语言进行编程。

在转向组件之前，我们将简要讨论微服务的基本特征。

# 独立性和自治性

微服务作为单片环境的更好替代品。在微服务中，每个服务都可以在任何时候启动、停止、升级或替换，而不会中断其他服务。所有服务都是独立的，并且可以自动注册到我们的中央注册表中。

# 弹性和容错性

在复杂的应用程序设计中，创建一个具有弹性的系统对每个服务都至关重要。大多数云环境都需要一种架构设计，其中所有服务都能应对意外情况，比如停机等。这些情况可能包括接收到坏数据（损坏的数据），可能无法到达所需的服务，或者可能在并发系统中请求冲突。微服务需要对故障具有弹性，并且应该能够快速重启自己。

微服务应该防止故障通过系统中的其他依赖服务进行级联。

# 自动化环境

自动化应该是微服务架构设计中的一个重要因素，因为应用程序中将涉及许多服务，因此服务之间的交互将非常复杂。必须实施自动化监控和警报管理系统来增强微服务设计。所有服务都应记录其数据和指标，并且这些指标应得到适当监控，因为这将改善服务管理。

# 无状态

微服务是无状态的，这意味着它们不会在一个会话中保留数据到另一个会话。此外，微服务实例不会相互交互。当应用程序中有更多的微服务实例可用时，每个实例都不会知道其他实例，无论下一个实例是否存活。当我们扩展我们的应用程序时，这一特征非常有帮助。

# 微服务的好处

在本节中，我们将讨论在我们的应用程序中开发微服务的好处：

+   业务逻辑可以分组并开发成易于开发和部署的服务，具有多个服务实例

+   微服务可以通过将应用程序拆分为多个服务来避免复杂的应用程序，提供易于开发和维护业务逻辑，特别是在升级特定部分时

+   服务可以独立部署，而不会中断应用程序；因此，最终用户永远不会感受到任何服务中断

+   松散耦合的服务将在扩展应用程序方面提供更多的灵活性

+   单独升级服务以满足时尚的业务需求是方便的，开发人员可以引入新技术来开发服务

+   借助微服务，可以更容易地实现持续部署；因此，可以对所需的模块进行快速升级

+   扩展这些服务将非常灵活，特别是当特定的业务需求需要更多实例以为最终用户提供不间断的服务时

+   组织可以专注于可以快速移至生产环境的小批量工作，特别是在为特定客户测试新功能时

# 微服务组件

为了拥有完全功能的微服务应用程序，必须正确使用以下组件。这些组件帮助我们在服务之间解决复杂的业务逻辑分配：

+   配置服务器

+   负载均衡器

+   服务发现

+   断路器

+   边缘服务器

我们将在本节中简要讨论这些组件。

# 配置服务器

配置服务器将帮助我们存储将要部署的每个服务的所有可配置参数。如果需要，这些属性可以保存在存储库中。此外，配置服务器将提供更改应用程序配置的选项，而无需部署代码。一旦配置更改，它将自动反映在应用程序中，因此我们可以避免重新部署我们的服务。

由于我们的微服务应用中将有许多服务，拥有配置服务器将帮助我们避免服务重新部署，并且服务可以从服务器获取相应的配置。这也是持续交付的原则之一：将源代码与配置解耦。

# 负载均衡器

负载均衡器通过将负载分配给特定服务来作为扩展应用程序的支柱。负载均衡器被认为是微服务架构中的重要组成部分。与分布在服务器之间的常规负载均衡器不同，这些负载均衡器管理服务实例并在这些实例之间分配负载。借助服务发现组件的帮助，它们将获取有关可用服务实例的信息并分配负载。

Netflix Ribbon 被用作负载均衡器；我们将在本章的*微服务工具*部分探讨这一点。

# 断路器

由于我们的架构中有许多服务共同工作，每个服务可能相互依赖。有些情况会导致一些服务失败，并可能导致其他服务随之失败。为了避免这种情况，我们的架构应该具有容错性。使用断路器等模式可以减少微服务架构中的故障。

# 边缘服务器

边缘服务器实现了 API 网关模式，并且对外部世界的 API 行为像一堵墙。借助边缘服务器，所有公共流量将被转发到我们的内部服务。通过这样做，最终用户在未来我们的服务和内部结构发生任何变化时不会受到影响。Netflix Zuul 被用作边缘服务器，我们将在下一节中分享一些关于 Zuul 的内容。

# 微服务工具

Netflix 工程师为微服务开发做出了很大贡献，并为微服务生态系统引入了各种组件。在这里，我们将讨论可能涉及微服务的更多组件：

+   Netflix Eureka

+   Netflix Zuul

+   Spring Cloud Config 服务器

+   Netflix Ribbon

+   Spring Cloud Netflix

+   Spring Security OAuth2

+   Netflix Hystrix 和 Turbine

+   Eclipse Microprofile

我们将在接下来的部分中更多地讨论它们。

# Netflix Eureka

Eureka 在微服务中扮演着服务发现服务的角色。它允许微服务在运行时注册自己，并在需要时帮助我们定位服务。它用于中间层服务器的负载平衡和故障转移。此外，Eureka 还配备了一个 Java 客户端（Eureka 客户端）以使服务交互更加容易。Eureka 服务器通过定位中间层服务器中的服务来充当中间层（服务级别）负载平衡工具。这些中间层（服务级别）负载平衡工具可能在类似 AWS 的云中不可用。

尽管 AWS 的弹性负载均衡器（ELB）可用于负载均衡服务，但它仅支持传统负载均衡器等端用户 Web 服务，而不支持中间层负载均衡。

在 Eureka 服务器中，客户端的实例知道他们需要与哪些服务通信，因为 Eureka 负载均衡器也专注于实例级别。Eureka 服务是无状态的，因此它们支持可伸缩性。由于服务器信息被缓存在客户端，负载均衡在负载均衡器宕机的情况下非常有帮助。

Eureka 在 Netflix 中用于 memcached 服务、cassandra 部署和其他操作。强烈建议在本地服务应该对公共服务禁用的中间层服务中使用 Eureka 服务器。

Netflix 开发人员启动了 Eureka 服务器并将其开源。后来，Spring 将其纳入了 Spring Cloud。在微服务架构中，服务应该是细粒度的，以提高应用程序的模块化，便于开发、测试和维护。

# Netflix Zuul

Zuul 充当公共前门的门卫，并且不允许未经授权的外部请求通过。它还提供了我们服务器中微服务的入口点。Zuul 使用 Netflix Ribbon 来查找可用的服务并将外部请求路由到正确的服务实例。Zuul 支持动态路由、监控和安全性。

Zuul 的不同类型的过滤器，如`PRE`、`ROUTING`、`POST`和`ERROR`，有助于实现以下操作：

+   动态路由

+   洞察和监控

+   认证和安全

+   压力测试

+   多区域弹性

+   静态响应处理

Zuul 有多个组件：

+   `zuul-core`

+   `zuul-simple-webapp`

+   `zuul-netflix`

+   `zuul-netflix-webapp`

# Spring Cloud Netflix

Spring Cloud 提供了第三方云技术与 Spring 编程模型之间的交互。Spring Cloud Netflix 为 Spring Boot 提供了 Netflix **开源软件** (**OSS**)集成支持，通过自动配置和绑定到 Spring 环境来使用。通过在 Spring Boot 中添加一些注解，我们可以构建一个包括 Netflix 组件在内的大型分布式应用程序。

Spring Cloud Netfix 可以实现诸如服务发现、服务创建、外部配置、路由器和过滤器等功能。

# Netflix Ribbon

Netflix 被服务消费者用于在运行时查找服务。Ribbon 从 Eureka 服务器获取信息以定位适当的服务实例。在 Ribbon 有多个实例可用的情况下，它将应用负载均衡机制来将请求分布到可用的实例上。Ribbon 不作为一个独立的服务运行，而是作为每个服务消费者中的一个嵌入式组件。具有客户端负载均衡是使用服务注册表的一个重大好处，因为负载均衡器让客户端选择服务的注册实例。

Ribbon 提供以下功能：

+   负载均衡规则（多个和可插拔的）

+   服务发现集成

+   对故障的弹性

+   云支持

Ribbon 有子组件，如`ribbon-core`、`ribbon-eureka`和`ribbon-httpclient`。

Netflix Ribbon 充当客户端负载均衡器，并且可以与 Spring Cloud 集成。

# Netflix Hystrix

每个分布式环境都容易发生服务故障，这种情况可能经常发生。为了解决这个问题，我们的架构应该具有容错和延迟容忍性。Hystrix 是一个断路器，可以帮助我们避免这种情况，如服务依赖失败。Hystrix 可以防止服务过载，并在发生故障时隔离故障。

通过 Hystrix 支持，我们可以通过在微服务中添加延迟容忍和容错逻辑来控制它们之间的交互。在服务失败的情况下，Hystrix 提供了强大的回退选项，从而提高了系统的整体弹性。如果没有 Hystrix，如果内部服务失败，可能会中断 API 并破坏用户体验。

Hystrix 遵循一些基本的弹性原则，如下：

+   服务依赖的失败不应该对最终用户造成任何中断

+   在服务依赖失败的情况下，API 应该做出正确的反应

Hystrix 还有一个断路器回退机制，使用以下方法：

+   **自定义回退**：当客户端库提供回退或本地数据以生成响应时

+   **失败静默**：回退返回 null，在某些情况下很有帮助

+   **快速失败**：在特定情况下使用，如 HTTP 5XX 响应

# Netflix Turbine

Turbine 用于将所有**服务器发送事件**（SSE）JSON 数据流聚合成一个流，可用于仪表板目的。Turbine 工具用于 Hystrix 应用程序，该应用程序具有实时仪表板，可从多台机器中聚合数据。Turbine 可以与支持 JSON 格式的任何数据源一起使用。Turbine 是数据不可知的，并且能够将 JSON 块视为键值对的映射。

Netflix 使用 Turbine 与 Eureka 服务器插件来处理因各种原因加入和离开集群的实例，例如自动缩放、不健康等。

# HashiCorp Consul

Consul 是一个服务发现和配置工具，用于支持微服务。Consul 是由 Hashi Corp 于 2014 年发起的，主要专注于跨多个数据中心的分布式服务。此外，Consul 可以保护数据并与大型基础设施配合工作。通过使用键和值配置服务，并找到所需的服务，Consul 解决了微服务的核心问题。

Consul 有服务器和客户端，形成一个单一的 Consul 集群。在 Consul 集群中，节点将能够存储和复制数据。通过至少一个成员的地址的帮助，自动发现集群中的其他成员。此外，Consul 提供了动态基础设施，因此不需要额外的编码/开发来自动发现服务。

Consul 旨在为 DevOps 社区和应用程序开发人员提供支持现代和弹性基础设施的工具。

# Eclipse MicroProfile

Eclipse MicroProfile 是由 RedHat、IBM 等公司和其他团体发起的，旨在为构建微服务提供规范。该项目始于 2016 年，最近发布了 MicroProfile 的 1.2 版本。它主要专注于优化企业 Java 以适应微服务架构。Payara Micro 和 Payara Servers 都与 Eclipse MicroProfile 兼容。

Eclipse MicroProfile 1.2 版本配备了配置 API、健康检查、容错、度量和其他支持微服务的必要工具。

# 总结

在本章中，我们简要讨论了单体应用及其缺点。然后我们谈到了微服务及其优点以及相关主题。此外，我们还讨论了微服务的基本原则，包括弹性和容错。

在本章的后面部分，我们讨论了微服务组件，并涵盖了与微服务相关的工具，如 Netflix Eureka、Zuul 等。在下一章和最后一章中，我们将处理一个包括身份验证和授权在内的高级 CRUD 操作的实时票务管理场景。
