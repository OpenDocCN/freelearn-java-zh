# 第十一章：扩展

随着世界对网络的关注越来越多，我们所有的网络应用程序都需要处理更多的请求。为了应对更多的请求，我们可能需要扩展我们的应用程序来支持它们。

本章主要集中讨论可以应用于我们常规应用程序的技术、库和工具，以解决可扩展性问题。

在本章中，我们将讨论以下主题：

+   集群及其优势

+   负载均衡

+   扩展数据库

+   分布式缓存

# 集群

简而言之，集群就是添加多个服务器以提供相同的服务。这将帮助我们在灾难（如系统崩溃和其他不幸情况）期间避免中断。集群可以用作故障转移系统、负载均衡系统或并行处理单元。

故障转移集群是一组具有相同应用程序副本的服务器，以向客户端提供相同的服务，以维护应用程序和服务的高可用性。如果某个服务器因某种原因失败，其余服务器将接管负载，并为消费者提供不间断的服务。

+   **扩展（垂直扩展）**：这是指向我们的服务器添加更多资源，例如增加 RAM、硬盘容量和处理器。虽然这可能是一个不错的选择，但它只适用于某些情况，而不是所有情况。在某些情况下，增加更多资源可能会很昂贵。

+   **扩展（水平扩展）**：与在一个服务器内添加更多资源不同，扩展关注的是添加更多服务器/节点来处理请求。这种分组称为集群，因为所有服务器都在执行相同类型的任务，但在不同的服务器上复制，以避免中断。

# 集群的优势

集群是扩展服务的更受欢迎的解决方案，因为它提供了一种快速灵活的选项，可以在需要时添加更多服务器，而不会中断现有服务。在扩展期间可以提供不间断的服务。在扩展应用程序时，消费者不需要等待任何接近停机的事情。所有服务器负载都由中央负载平衡服务器正确平衡。

# 负载均衡

负载均衡器是集群中最有用的工具。负载均衡器使用各种算法，如轮询、最小连接等，将传入的请求转发到正确的后端服务器进行处理。

市场上有很多第三方负载均衡器可用，例如 F5（[`f5.com`](https://f5.com)）、HAProxy（[`www.haproxy.org`](http://www.haproxy.org)）等。尽管这些负载均衡工具的行为不同，但它们都专注于主要角色：将请求负载分发到可用的后端服务器，并在所有服务器之间保持平衡。通过适当的负载平衡，我们可以防止单个后端服务器过载。此外，大多数负载均衡器都配备了健康监控，例如检查可服务服务器的可用性。

除了在服务器之间进行主要请求分发外，负载均衡器还保护后端服务器免受前端服务器的影响。前端服务器不会知道将请求发送到哪个后端服务器，因为负载均衡器隐藏了所有关于后端服务器的细节。

# 扩展数据库

扩展数据库是架构设计中具有挑战性的部分之一。在这里，我们将讨论一些数据库扩展技术，以扩展我们的应用程序。

# 垂直扩展

正如我们之前讨论的，在应用程序服务器级别，我们也可以利用扩展技术来对我们的数据库服务器进行扩展。增加更多的计算能力，比如 CPU 和 RAM，将提高查询数据库的性能。通过使用垂直扩展技术，我们可以获得一致的性能，并且在出现问题时也很容易调试。此外，与水平扩展相比，垂直扩展提供了更高的效率。然而，垂直扩展可能需要定期停机来安装新硬件，并且受硬件容量的限制。

# 水平扩展

正如我们在应用程序级别讨论的水平扩展一样，我们可以通过向我们的集群添加更多机器来对数据库服务器进行相同的操作，以处理数据库负载。与垂直扩展相比，这要便宜得多；然而，这也伴随着集群配置、维护和管理成本。

# 读取副本

通过保留多个可用于读取的从库，我们可以显著改进我们的应用程序。读取副本有助于在所有只读从库中读取数据。然而，当我们需要发送写入请求时，我们可以使用主数据库。主数据库可以用于写入和读取，而从库只能用于读取。我们安装的从库越多，就可以处理更多基于读取的查询。这种读取副本技术在我们需要处理最小写入查询和最大读取查询的情况下非常有用。

# 连接池

当应用程序查询数据库时，它会创建客户端连接，发送查询并获取结果。由于与数据库的客户端连接是昂贵的操作，连接必须被重用以进行进一步的查询。连接池将在这种情况下有所帮助，通过防止为每个请求建立到数据库的连接。通过保持更好的连接池，比如 HikariCP，我们可以提高应用程序的性能。

# 使用多个主数据库

与读取副本不同，多主机制提供了复制多个数据库服务器的选项。与使用读取副本复制从库不同，这里我们复制主数据库以进行写入和读取数据。这种模式对于特定场景非常有用，比如 REST API 数据事务集中的应用程序。在多主模式中，我们需要我们的应用程序生成**通用唯一标识符**（**UUID**），以防止在多主复制过程中发生数据冲突。

# 数据库服务器的负载均衡

由于应用程序服务器的客户端连接限制是基于数据库供应商的，当应用程序服务器请求更多连接时，处理情况可能会有些棘手。通过保持负载均衡器，我们可以使用它们的连接池将数据库查询分发到可用的数据库服务器。借助负载均衡器，我们将确保所有数据库服务器负载均衡；然而，这取决于特定负载均衡器中使用的算法。

# 数据库分区

当我们处理需要高端服务器并且需要大量时间来查询的大型数据库时，分区数据库非常有帮助。此外，当我们的应用程序需要查询大量读取和写入请求时，这也是有用的。分区可以进行水平和垂直两种方式。水平和垂直分区都在以下部分中描述。

# 分片（水平分区）

数据库表可以根据任何特定属性分成多个表。例如，用户数据库可以分成两个不同的数据库，比如`user_1`和`user_2`，其中`user_1`表的用户名以*A*-*N*开头，而`user_2`表的用户名以*O*-*Z*开头。通过像之前那样分割数据库，我们可以减少每个表中的行数，从而提高性能。

# 垂直分区

在垂直分区中，数据库表可以根据业务概念分成多个表。例如，一个表可能有更多的列，以便其他表可以轻松访问以获得更好的性能。

通过进行水平和垂直分区，查询数据库所需的时间将减少，从而提高性能。此外，通过将大型数据库划分为小块，我们可以避免需要高端计算机。这些数据分片可以分布到低成本的服务器上以节省成本。然而，在特定场景下，数据共享可能是一个复杂的过程。

# 分布式缓存

分布式缓存技术将有助于提高 Web 服务的可伸缩性。与进程内缓存不同，分布式缓存不需要在相同的应用程序空间中构建。它们可以存储在集群的多个节点上。尽管分布式缓存部署在多个节点上，但它们提供单一的缓存状态。

# 数据层缓存

在数据库中添加缓存层将提供更好的性能。这被认为是改善性能的常见策略，特别是当我们的应用程序中读取请求很多时。在这里，我们将讨论 Hibernate 的缓存级别。

# 一级缓存

一级缓存是 Hibernate 启用的内置会话缓存，是通过所有请求的强制性缓存。在 Hibernate 中没有禁用一级缓存的选项。一级缓存与会话对象相关联，一旦会话过期，缓存将丢失。当我们第一次查询 Web 服务时，对象将从数据库中检索并存储在一级缓存中，该缓存与 Hibernate 会话相关联。如果我们再次请求相同的实体，它将从缓存中检索，而无需查询数据库。

# 二级缓存

二级缓存是 Hibernate 中的可选缓存。在我们的请求到达二级缓存之前，一级缓存将是联系点。二级缓存可以按类或集合配置，并负责在会话之间缓存对象。

由于只有少数类受益于缓存，默认情况下禁用了二级缓存。可以启用以服务设计师。

# 应用层缓存

与在数据库中缓存类似，我们还可以在应用程序层缓存任何对象以提高应用程序的性能。在这里，我们将讨论各种对象缓存，特别是键值缓存工具，并检查它们在市场上的独特性。

# Memcached

由于大多数公司在其应用程序中使用 Memcached (`https://memcached.org`)，我们认为 Memcached 是最强大的分布式缓存系统之一。它遵循分布式内存缓存机制，在重复的场景中非常有帮助，例如当多次请求相同的服务时。

# Redis

Redis ([`redis.io`](https://redis.io)) 是另一个可以用于缓存的内存键值存储。Redis 支持诸如哈希、列表、集合等数据结构。Redis 被认为是最受欢迎的键值存储之一，支持高级键值缓存。Redis 支持交集和并集等操作。由于其高级功能和速度，它比 Memcached 更受青睐。

# Hazelcast

Hazelcast（[`hazelcast.com`](https://hazelcast.com)）是一个支持分布式集合并简化分布式计算的内存数据网格。它提供了一个简单的 API 和简单直接的部署策略。由于 Hazelcast 提供了 Memcached 客户端库，使用 Memcached 集群的应用程序可能能够适应 Hazelcast 集群。Hazelcast 架构支持在集群平台上的数据分发和高可伸缩性。它还提供智能同步和自动发现。Hazelcast 提供了分布式数据结构、分布式查询和分布式计算等功能。Spring Boot 在其框架中明确支持 Hazelcast 缓存。

# Ehcache

Ehcache（[`www.ehcache.org`](http://www.ehcache.org)）由于其简化的可扩展选项，主要用于小型到中型部署。它被认为是最广泛使用的分布式缓存之一。此外，Ehcache 提供了与其他流行库和框架集成的选项。Ehcache 的扩展从进程内缓存开始，经过混合的进程内和进程外部署。此外，Ehcache 推出了 Terracotta 服务器，以提高缓存性能。

# Riak

Riak（[`github.com/basho/riak`](https://github.com/basho/riak)）是基于 Erlang 的键值数据存储，具有容错性和高可用性。在 Riak 中，数据可以存储在内存、磁盘或两者兼有。Riak 可以通过诸如 HTTP API 或本机 Erlang 接口之类的协议进行访问。Riak 支持主要语言，如 Java、C 和 Python。此外，它支持 MapReduce，可以在大数据相关操作中灵活使用。

# Aerospike

Aerospike（[`www.aerospike.com`](https://www.aerospike.com)）是一个开源的、针对闪存优化的、内存 NoSQL 数据库和键值存储。Aerospike 在三个层面上运行：针对闪存优化的数据层、自管理的分布层和集群感知的客户端层。为了确保一致性，分布层在所有数据中心都有副本。即使单个服务器节点失败或从集群中移除，这些副本也会保持功能正常。

# Infinispan

Infinispan（[`infinispan.org/`](http://infinispan.org/)）是一个分布式的内存键值数据存储，可以用作缓存或数据网格。它可以作为库或通过诸如 REST 之类的协议进行访问。此外，Infinispan 可以与 JPA、JCache、Spring 和 Spark 集成。Infinispan 支持大多数与 MapReduce 相关的操作。

# Cache2k

Cache2k（[`cache2k.org/`](https://cache2k.org/)）提供了 Java 应用程序中的内存对象缓存选项。Cache2k 主要侧重于 JVM 内部的缓存。

# 其他分布式缓存

之前，我们讨论了主要的缓存工具及其机制。在这里，我们将更多地讨论市场上可用的其他分布式缓存：

# Amazon ElastiCache

ElastiCache 主要用作内存数据存储和缓存服务；它是由 AWS 引入的。借助 Amazon ElastiCache 的支持，我们可以快速部署我们的缓存环境，而无需进行任何复杂的安装。它支持 Memcached 和 Redis 缓存。

# Oracle 分布式缓存（Coherence）

在这个分布式缓存中，数据被分区在集群中的所有计算机上。这些分区缓存将被配置为在集群中的节点上保留每个数据片段。分布式缓存是 Coherence 中最常用的缓存。

尽管市场上有很多缓存解决方案可供选择，但选择特定的解决方案取决于许多因素，如业务需求、性能需求、数据完整性、容错性、成本等。在应用程序层和数据库层添加正确的分布式缓存层将会带来更好的性能。

# 总结

在本章中，我们讨论了不同的库、工具和技术，以扩展 RESTful Web 服务。在开发应用程序时，我们将不得不通过使用明确定义的接口来寻找系统组件之间的松耦合。在接下来的章节中，我们将讨论微服务及其优势。
