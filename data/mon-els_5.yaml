- en: Chapter 5. System Monitoring
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 5 章. 系统监控
- en: The previous two chapters focused on Elasticsearch monitoring tools, including
    Elasticsearch-head, Bigdesk, and Marvel. This chapter will introduce another monitoring
    tool, **Kopf**. We will also discuss **Elasticsearch, Logstash, and Kibana** (**ELK**),
    Nagios, and various GNU/Linux command line tools in terms of general purpose system
    monitoring.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 前两章重点介绍了 Elasticsearch 监控工具，包括 Elasticsearch-head、Bigdesk 和 Marvel。本章将介绍另一个监控工具，**Kopf**。我们还将从通用系统监控的角度讨论
    **Elasticsearch、Logstash 和 Kibana**（**ELK**）、Nagios 以及各种 GNU/Linux 命令行工具。
- en: 'This chapter covers these topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖以下主题：
- en: Monitoring Elasticsearch with Kopf
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Kopf 监控 Elasticsearch
- en: Configuring an Elasticsearch, Logstash, and Kibana (ELK) stack for system log
    file aggregation and analysis
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置 Elasticsearch、Logstash 和 Kibana（ELK）堆栈以进行系统日志文件聚合和分析
- en: System-level monitoring of a cluster using Nagios
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Nagios 对集群进行系统级监控
- en: GNU/Linux command line tools for system and process management
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于系统和进程管理的 GNU/Linux 命令行工具
- en: Working with Kopf
  id: totrans-7
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 Kopf
- en: Kopf is a web-based cluster management tool like Elasticsearch-head, but has
    a more modern look and a few different features. With Kopf, users can check the
    state of nodes and indices, run REST queries, and perform basic management tasks.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: Kopf 是一个类似于 Elasticsearch-head 的基于 Web 的集群管理工具，但外观更现代，并具有一些不同的功能。使用 Kopf，用户可以检查节点和索引的状态，运行
    REST 查询，并执行基本的管理任务。
- en: Installing Kopf
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装 Kopf
- en: 'Kopf works on Elasticsearch 0.90.x and up. Use the following table to determine
    which Kopf version is best suited to your cluster:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: Kopf 支持从 Elasticsearch 0.90.x 版本开始。使用以下表格确定哪个 Kopf 版本最适合你的集群：
- en: '| Elasticsearch Version | Kopf Branch |'
  id: totrans-11
  prefs: []
  type: TYPE_TB
  zh: '| Elasticsearch 版本 | Kopf 分支 |'
- en: '| --- | --- |'
  id: totrans-12
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| 0.90.x | 0.90 |'
  id: totrans-13
  prefs: []
  type: TYPE_TB
  zh: '| 0.90.x | 0.90 |'
- en: '| 1.x | 1.0 |'
  id: totrans-14
  prefs: []
  type: TYPE_TB
  zh: '| 1.x | 1.0 |'
- en: '| 2.x | 2.0 |'
  id: totrans-15
  prefs: []
  type: TYPE_TB
  zh: '| 2.x | 2.0 |'
- en: 'To install Kopf, follow these steps:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 要安装 Kopf，请按照以下步骤操作：
- en: 'Install Kopf on at least one node in your cluster as an Elasticsearch plugin
    with the following command, replacing `{branch}` with the value from the `branch`
    column in the preceding table:'
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令在集群中至少一个节点上安装 Kopf 作为 Elasticsearch 插件，将 `{branch}` 替换为前表中 `branch` 列的值：
- en: '[PRE0]'
  id: totrans-18
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'This example will install Kopf on `elasticsearch-node-01`. Since this node
    is running Elasticsearch 2.3.2, the command will look like this:'
  id: totrans-19
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此示例将在 `elasticsearch-node-01` 上安装 Kopf。由于此节点运行 Elasticsearch 2.3.2，命令将如下所示：
- en: '[PRE1]'
  id: totrans-20
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'To open Kopf, browse to:'
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要打开 Kopf，浏览到：
- en: '[PRE2]'
  id: totrans-22
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'You should see something like this:'
  id: totrans-23
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你应该看到类似以下内容：
- en: '![Installing Kopf](img/B03798_05_01.jpg)'
  id: totrans-24
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![安装 Kopf](img/B03798_05_01.jpg)'
- en: Kopf cluster page
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: Kopf 集群页面
- en: '| No. | Description |'
  id: totrans-26
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| 编号 | 描述 |'
- en: '| --- | --- |'
  id: totrans-27
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| **1** | Titlebar and cluster state |'
  id: totrans-28
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| **1** | 标题栏和集群状态 |'
- en: '| **2** | Cluster summary |'
  id: totrans-29
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| **2** | 集群摘要 |'
- en: '| **3** | Display filters |'
  id: totrans-30
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| **3** | 显示过滤器 |'
- en: '| **4** | Node and index actions |'
  id: totrans-31
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| **4** | 节点和索引操作 |'
- en: '| **5** | Indices |'
  id: totrans-32
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| **5** | 索引 |'
- en: '| **6** | Nodes |'
  id: totrans-33
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| **6** | 节点 |'
- en: '| **7** | Shard allocations |'
  id: totrans-34
  prefs:
  - PREF_IND
  type: TYPE_TB
  zh: '| **7** | 分片分配 |'
- en: The green title bar on this page indicates that the cluster is in a `green`
    state. Likewise, the title bar changes to yellow or red if it enters either of
    those states.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 此页面的绿色标题栏表示集群处于 `绿色` 状态。同样，如果集群进入黄色或红色状态，标题栏将相应地变为黄色或红色。
- en: All Kopf dashboard pages also show the indicators listed on the top of this
    screenshot, including number of nodes, indices, shards, documents, and total index
    size.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 所有 Kopf 仪表板页面也显示了此截图顶部的指标，包括节点数、索引、分片、文档和总索引大小。
- en: The cluster page
  id: totrans-37
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 集群页面
- en: 'The screenshot in the previous section shows the Kopf cluster page. The Elasticsearch
    cluster''s nodes, indices, and shard allocations are listed on this page. This
    page also provides the following administrative capabilities:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 上一节中的截图显示了 Kopf 集群页面。Elasticsearch 集群的节点、索引和分片分配都列在此页面上。此页面还提供以下管理功能：
- en: Closing and opening indices
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 关闭和打开索引
- en: Optimizing indices
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 优化索引
- en: Refreshing indices
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 刷新索引
- en: Clearing index caches
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 清除索引缓存
- en: Deleting indices
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 删除索引
- en: Disabling/enabling shard allocation
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 禁用/启用分片分配
- en: Viewing index settings
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 查看索引设置
- en: Viewing index mappings
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 查看索引映射
- en: Like the **Cluster Overview** tab in Elasticsearch-head, the Kopf **cluster**
    page is a great first stop when diagnosing Elasticsearch issues. It will inform
    you of the cluster state, whether a node is down, and if the node has a high heap/disk/CPU/load.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 与 Elasticsearch-head 中的 **集群概览** 选项卡类似，Kopf 的 **集群** 页面是诊断 Elasticsearch 问题时的一个好起点。它将通知你集群状态，节点是否已关闭，以及节点是否有高堆/磁盘/CPU/负载。
- en: The nodes page
  id: totrans-48
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 节点页面
- en: 'The **nodes** page, shown in the following screenshot, provides figures for
    load, CPU usage, JVM heap usage, disk usage, and uptime for all nodes in the cluster:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 如下截图所示的 **节点** 页面提供了集群中所有节点的负载、CPU 使用率、JVM 堆使用率、磁盘使用率和运行时间：
- en: '![The nodes page](img/B03798_05_02.jpg)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
  zh: '![节点页面](img/B03798_05_02.jpg)'
- en: Kopf nodes page
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: Kopf 节点页面
- en: This page, like the **cluster** page, is a good starting point when diagnosing
    Elasticsearch issues.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 此页面，就像 **集群** 页面一样，是诊断 Elasticsearch 问题时的良好起点。
- en: The rest page
  id: totrans-53
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: rest 页面
- en: 'The Kopf **rest** page is a general-purpose tool for running arbitrary queries
    against Elasticsearch. You can run any query in the Elasticsearch API using this
    page. The following screenshot is running a simple **Search** **API** query against
    the Elasticsearch cluster:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: Kopf 的 **rest** 页面是一个通用的工具，可以运行任意查询针对 Elasticsearch。您可以使用此页面运行 Elasticsearch
    API 中的任何查询。以下截图显示了在 Elasticsearch 集群上运行一个简单的 **搜索** **API** 查询：
- en: '![The rest page](img/B03798_05_03.jpg)'
  id: totrans-55
  prefs: []
  type: TYPE_IMG
  zh: '![rest 页面](img/B03798_05_03.jpg)'
- en: Kopf rest page
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: Kopf rest 页面
- en: The **rest** page is useful for everything from testing query syntax to retrieving
    cluster metrics, and can help in gauging and optimizing query performance. For
    example, if a particular query is running slowly, use the **rest** page to test
    different variations of the query and determine which query components have the
    highest performance impact.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '**rest** 页面对于从测试查询语法到检索集群指标的所有事情都很有用，并有助于衡量和优化查询性能。例如，如果某个特定查询运行缓慢，请使用 **rest**
    页面测试查询的不同变体，并确定哪些查询组件具有最高的性能影响。'
- en: The more dropdown
  id: totrans-58
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**更多**下拉菜单'
- en: 'The **more** dropdown has a variety of other cluster management tools, including:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '**更多**下拉菜单包含各种其他集群管理工具，包括：'
- en: '| Tool Name | Description |'
  id: totrans-60
  prefs: []
  type: TYPE_TB
  zh: '| 工具名称 | 描述 |'
- en: '| --- | --- |'
  id: totrans-61
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| Create Index | Create an index and assign a number of shards, replicas, mapping,
    and other settings |'
  id: totrans-62
  prefs: []
  type: TYPE_TB
  zh: '| 创建索引 | 创建索引并分配一些分片、副本、映射和其他设置 |'
- en: '| Cluster Settings | Configure cluster, routing, and recovery settings |'
  id: totrans-63
  prefs: []
  type: TYPE_TB
  zh: '| 集群设置 | 配置集群、路由和恢复设置 |'
- en: '| Aliases | View existing and create new index aliases |'
  id: totrans-64
  prefs: []
  type: TYPE_TB
  zh: '| 别名 | 查看现有和创建新的索引别名 |'
- en: '| Analysis | Test and verify index analyzers |'
  id: totrans-65
  prefs: []
  type: TYPE_TB
  zh: '| 分析 | 测试和验证索引分析器 |'
- en: '| Percolator | View existing and create new percolator queries |'
  id: totrans-66
  prefs: []
  type: TYPE_TB
  zh: '| 过滤器 | 查看现有和创建新的过滤器查询 |'
- en: '| Warmers | View existing and create new index warmer queries |'
  id: totrans-67
  prefs: []
  type: TYPE_TB
  zh: '| 加热器 | 查看现有和创建新的索引加热查询 |'
- en: '| Snapshot | Create new index snapshots on the local filesystem, URL, S3, HDFS,
    or Azure |'
  id: totrans-68
  prefs: []
  type: TYPE_TB
  zh: '| 快照 | 在本地文件系统、URL、S3、HDFS 或 Azure 上创建新的索引快照 |'
- en: '| Index Templates | View existing and create new index templates |'
  id: totrans-69
  prefs: []
  type: TYPE_TB
  zh: '| 索引模板 | 查看现有和创建新的索引模板 |'
- en: '| Cat APIs | Run a subset of all possible Elasticsearch API "Cat" methods |'
  id: totrans-70
  prefs: []
  type: TYPE_TB
  zh: '| Cat API | 运行所有可能的 Elasticsearch API “Cat”方法的一个子集 |'
- en: '| Hot Threads | Query for Elasticsearch "Hot" threads |'
  id: totrans-71
  prefs: []
  type: TYPE_TB
  zh: '| 热点线程 | 查询 Elasticsearch 的“热点”线程 |'
- en: 'The following screenshot shows the **HOT THREADS** page. This page is helpful
    when diagnosing slow search and indexing performance:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 以下截图显示了 **热点线程** 页面。当诊断慢速搜索和索引性能时，此页面非常有用：
- en: '![The more dropdown](img/B03798_05_04.jpg)'
  id: totrans-73
  prefs: []
  type: TYPE_IMG
  zh: '![更多下拉菜单](img/B03798_05_04.jpg)'
- en: Hot Threads
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 热点线程
- en: Working with Logstash and Kibana
  id: totrans-75
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 Logstash 和 Kibana
- en: Logstash is a utility for aggregating and normalizing log files from disparate
    sources and storing them in an Elasticsearch cluster. Once logs are stored in
    Elasticsearch, we will use Kibana, the same tool Marvel's user interface is built
    on, to view and explore our aggregated logs.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: Logstash 是一个用于从不同来源聚合和标准化日志文件并将其存储在 Elasticsearch 集群中的实用工具。一旦日志存储在 Elasticsearch
    中，我们将使用 Kibana，这是 Marvel 用户界面所基于的工具，来查看和探索我们的聚合日志。
- en: ELK
  id: totrans-77
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ELK
- en: The Elasticsearch community refers to the Elasticsearch, Logstash, and Kibana
    tool combination as the ELK stack. This section shows how to load NGINX server
    logs into ELK, but there are many other potential use cases for these technologies.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: Elasticsearch 社区将 Elasticsearch、Logstash 和 Kibana 工具组合称为 ELK 堆栈。本节展示了如何将 NGINX
    服务器日志加载到 ELK 中，但还有许多其他潜在的使用案例。
- en: 'ELK can help us explore NGINX server logs by:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: ELK 可以帮助我们通过以下方式探索 NGINX 服务器日志：
- en: Visualizing server traffic over time
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 随时间可视化服务器流量
- en: Plotting server visits by location on a map
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在地图上按位置绘制服务器访问
- en: Searching logs by resource extension (HTML, JS, CSS, and so on), IP address,
    byte count, or user-agent strings
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过资源扩展（HTML、JS、CSS 等）、IP 地址、字节数或用户代理字符串搜索日志
- en: Discovering web requests that result in internal server errors
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 发现导致内部服务器错误的网络请求
- en: Finding attackers in a distributed denial of service attack
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在分布式拒绝服务攻击中寻找攻击者
- en: 'Other uses for ELK include:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: ELK 的其他用途包括：
- en: Logging all Elasticsearch queries in a web application for future performance
    analysis
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 Web 应用程序中记录所有 Elasticsearch 查询以供未来性能分析
- en: Aggregating server system logs into one location for analysis and visualization
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将服务器系统日志聚合到一个位置以进行分析和可视化
- en: Logging operations from a data processing or ingestion pipeline for future analysis
    and auditing
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从数据处理或摄取管道进行日志操作以供未来分析和审计
- en: Installation
  id: totrans-89
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装
- en: Although this example will store aggregate log data from Logstash directly into
    Elasticsearch, it's important to ensure that these aggregated logs do not affect
    the performance of the production cluster. To avoid this potential performance
    problem, we'll configure Logstash to route logs to a secondary monitoring cluster;
    in our case, this is the `elasticsearch-marvel-01` node.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管此示例将直接将 Logstash 的聚合日志数据存储到 Elasticsearch 中，但确保这些聚合日志不会影响生产集群的性能是很重要的。为了避免这种潜在的性能问题，我们将配置
    Logstash 将日志路由到辅助监控集群；在我们的案例中，这是 `elasticsearch-marvel-01` 节点。
- en: Installing Logstash
  id: totrans-91
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 安装 Logstash
- en: 'It doesn''t matter what host Logstash lives on, since it can redirect logs
    to any Elasticsearch instance. Since Kibana will be installed on `elasticsearch-marvel-01`,
    we''ll put Logstash there as well:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: Logstash 所在的主机并不重要，因为它可以将日志重定向到任何 Elasticsearch 实例。由于 Kibana 将安装在 `elasticsearch-marvel-01`
    上，因此我们也将 Logstash 安装在那里：
- en: 'From `elasticsearch-marvel-01`, run the following:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 从 `elasticsearch-marvel-01` 运行以下命令：
- en: '[PRE3]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Loading NGINX logs
  id: totrans-95
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 加载 NGINX 日志
- en: 'Now let''s load some sample NGINX logs into Elasticsearch using Logstash. While
    Logstash has built-in parsers for many different log types (Apache, Linux syslogs,
    and so on), it doesn''t natively support NGINX logs. This means that users have
    to explicitly tell Logstash how to deal with these files. To address this, follow
    these steps:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们使用 Logstash 将一些示例 NGINX 日志加载到 Elasticsearch 中。虽然 Logstash 对许多不同的日志类型（Apache、Linux
    系统日志等）具有内置的解析器，但它并不原生支持 NGINX 日志。这意味着用户必须明确告诉 Logstash 如何处理这些文件。为了解决这个问题，请按照以下步骤操作：
- en: Put some sample NGINX log files in `/opt/logstash/``logs:`
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `/opt/logstash/logs` 放置一些示例 NGINX 日志文件：
- en: '[PRE4]'
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '![Loading NGINX logs](img/B03798_05_05.jpg)'
  id: totrans-99
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![加载 NGINX 日志](img/B03798_05_05.jpg)'
- en: NGINX log files for Logstash
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: Logstash 的 NGINX 日志文件
- en: 'Create a new file on `/opt/logstash/patterns/nginx.grok` on `elasticsearch-marvel-01`
    with the following content:'
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `elasticsearch-marvel-01` 上 `/opt/logstash/patterns/nginx.grok` 创建一个新文件，内容如下：
- en: '[PRE5]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Then create a Logstash configuration file at `/opt/logstash/logstash.conf`
    with the following content:'
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然后在 `/opt/logstash/logstash.conf` 创建一个 Logstash 配置文件，内容如下：
- en: '[PRE6]'
  id: totrans-104
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: This configuration tells Logstash to read all `access.log*` files from the filesystem
    using our newly defined `nginx` format, identifies the timestamp column used by
    our NGINX format, tells Logstash to use a Geo IP lookup on the visitor's IP address,
    and finally tells Logstash to save logs to the Elasticsearch host instance at
    `elasticsearch-marvel-01:9200`.
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此配置告诉 Logstash 从文件系统读取所有 `access.log*` 文件，使用我们新定义的 `nginx` 格式，识别我们 NGINX 格式使用的时戳列，告诉
    Logstash 对访问者的 IP 地址使用 Geo IP 查找，并最终告诉 Logstash 将日志保存到 `elasticsearch-marvel-01:9200`
    的 Elasticsearch 主机实例。
- en: Note
  id: totrans-106
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: 'Read more about the Logstash configuration file format at: [https://www.elastic.co/guide/en/logstash/current/configuration.html](https://www.elastic.co/guide/en/logstash/current/configuration.html).'
  id: totrans-107
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在 [https://www.elastic.co/guide/en/logstash/current/configuration.html](https://www.elastic.co/guide/en/logstash/current/configuration.html)
    了解更多关于 Logstash 配置文件格式的信息。
- en: 'Now run Logstash, specifying the configuration file:'
  id: totrans-108
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在运行 Logstash，指定配置文件：
- en: '[PRE7]'
  id: totrans-109
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: After a few minutes, Logstash will load all of the data into Elasticsearch.
    The new index created in Kopf should now be viewable.
  id: totrans-110
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 几分钟后，Logstash 将将所有数据加载到 Elasticsearch 中。在 Kopf 中创建的新索引现在应该可以查看。
- en: The next section will focus on exploring the data in Kibana.
  id: totrans-111
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 下一个部分将专注于在 Kibana 中探索数据。
- en: '![Loading NGINX logs](img/B03798_05_06.jpg)'
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![加载 NGINX 日志](img/B03798_05_06.jpg)'
- en: Viewing Logstash index from Kopf
  id: totrans-113
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 从 Kopf 查看Logstash索引
- en: Note
  id: totrans-114
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: This process will go much faster if the `geoip` configuration setting from the
    `logstash.conf` configuration file is removed.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 如果从 `logstash.conf` 配置文件中删除 `geoip` 配置设置，此过程将更快。
- en: Installing Kibana
  id: totrans-116
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 安装 Kibana
- en: 'Follow these steps to install Kibana on your system:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤在您的系统上安装 Kibana：
- en: Determine the appropriate version of Kibana to download from [https://www.elastic.co/downloads/kibana](https://www.elastic.co/downloads/kibana).
    Since this example is using Elasticsearch 2.3.2, we'll install Kibana 4.5.4.
  id: totrans-118
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确定从 [https://www.elastic.co/downloads/kibana](https://www.elastic.co/downloads/kibana)
    下载的 Kibana 适当版本。由于此示例使用 Elasticsearch 2.3.2，我们将安装 Kibana 4.5.4。
- en: 'Download and unpackage Kibana on `elasticsearch-marvel-01` in the `/opt/kibana/`
    directory:'
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`/opt/kibana/`目录中下载并解包`elasticsearch-marvel-01`上的Kibana：
- en: '[PRE8]'
  id: totrans-120
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Edit Kibana''s `conf/kibana.yml` file to point to the correct Elasticsearch
    host. In this case, change this:'
  id: totrans-121
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑Kibana的`conf/kibana.yml`文件，将其指向正确的Elasticsearch主机。在这种情况下，更改如下：
- en: '[PRE9]'
  id: totrans-122
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'To:'
  id: totrans-123
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 到：
- en: '[PRE10]'
  id: totrans-124
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Now start Kibana:'
  id: totrans-125
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在启动Kibana：
- en: '[PRE11]'
  id: totrans-126
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Visit `http://elasticsearch-marvel-01:5601/` to view the Kibana landing page.
    It should look like the following screenshot:![Installing Kibana](img/B03798_05_07.jpg)
  id: totrans-127
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 访问`http://elasticsearch-marvel-01:5601/`以查看Kibana登录页面。它应该看起来像以下截图：![安装Kibana](img/B03798_05_07.jpg)
- en: Configuring Kibana
  id: totrans-128
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 配置Kibana
- en: Notice `logstash-*` is already selected by default, so just click the **Create**
    button to continue.
  id: totrans-129
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 注意`logstash-*`已经默认选中，因此只需点击**创建**按钮继续。
- en: Navigate to the **Discover** tab to start exploring your log data:![Installing
    Kibana](img/B03798_05_08.jpg)
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到**发现**选项卡以开始探索您的日志数据：![安装Kibana](img/B03798_05_08.jpg)
- en: Search for data in Kibana
  id: totrans-131
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在Kibana中搜索数据
- en: You may not see any data here at first. This is because all of the data loaded
    is more than 15 minutes old.
  id: totrans-132
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 您可能一开始看不到任何数据。这是因为所有加载数据都超过15分钟了。
- en: Click the date range filter in the upper-right of the page, by default set to
    **Last 15 Minutes**. Now select a more appropriate range, such as **This Month**.
    You should now start to see some results:![Installing Kibana](img/B03798_05_09.jpg)
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击页面右上角的日期范围过滤器，默认设置为**最后15分钟**。现在选择一个更合适的范围，例如**本月**。现在你应该开始看到一些结果：![安装Kibana](img/B03798_05_09.jpg)
- en: Viewing log data from this month
  id: totrans-134
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 查看本月的日志数据
- en: 'The `default _source` column is a little hard to read, so specify some columns
    from the left-hand side of the page: `http_user_agent`, `remote_addr`, and `status`.
    Clicking on any of these selected columns will run an aggregation query displaying
    the most commonly occurring values for each field:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: '`default _source`列有点难以阅读，因此指定页面左侧的一些列：`http_user_agent`、`remote_addr`和`status`。点击这些选定的任何一列将运行一个聚合查询，显示每个字段的常见值：'
- en: '![Installing Kibana](img/B03798_05_10.jpg)'
  id: totrans-136
  prefs: []
  type: TYPE_IMG
  zh: '![安装Kibana](img/B03798_05_10.jpg)'
- en: Applying search filters to Kibana results
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 应用搜索过滤器到Kibana结果
- en: 'The **Visualize** page lets us create arbitrary data visualizations. As an
    example, we''ll create two sample visualizations: a Tile map to plot the geolocated
    IP addresses in our dataset, and a Vertical bar chart for displaying counts of
    different HTTP status codes in the log files. Follow these steps:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: '**可视化**页面允许我们创建任意数据可视化。例如，我们将创建两个示例可视化：一个瓦片地图来绘制数据集中的地理位置IP地址，以及一个垂直条形图来显示日志文件中不同HTTP状态码的计数。请按照以下步骤操作：'
- en: First, configure the Tile map visualization as shown here:![Installing Kibana](img/B03798_05_11.jpg)
  id: totrans-139
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，配置瓦片地图可视化，如图所示：![安装Kibana](img/B03798_05_11.jpg)
- en: Geospatial visualization of Kibana results
  id: totrans-140
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: Kibana结果的地理空间可视化
- en: Click **Save** to save your changes, and create the Vertical bar chart:![Installing
    Kibana](img/B03798_05_12.jpg)
  id: totrans-141
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**保存**以保存您的更改，并创建垂直条形图：![安装Kibana](img/B03798_05_12.jpg)
- en: Breakdown by HTTP status code
  id: totrans-142
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 按HTTP状态码细分
- en: After saving this chart, go to the **Dashboard** page in order to display both
    components on the same page.
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存此图表后，转到**仪表板**页面，以便在同一页面上显示两个组件。
- en: Select the two components by clicking the **Add Visualization** button. Move
    them around the dashboard to resize and reorder them until you get something like
    this:![Installing Kibana](img/B03798_05_13.jpg)
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过点击**添加可视化**按钮选择两个组件。将它们在仪表板上移动以调整大小和重新排序，直到得到类似以下内容：![安装Kibana](img/B03798_05_13.jpg)
- en: Kibana dashboard view
  id: totrans-145
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: Kibana仪表板视图
- en: Note
  id: totrans-146
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: 'Learn more about Kibana and Logstash by visiting the official Elasticsearch
    documentation at:'
  id: totrans-147
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 通过访问官方Elasticsearch文档了解有关Kibana和Logstash的更多信息：
- en: '[https://www.elastic.co/videos/kibana-logstash](https://www.elastic.co/videos/kibana-logstash)'
  id: totrans-148
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[https://www.elastic.co/videos/kibana-logstash](https://www.elastic.co/videos/kibana-logstash)'
- en: '[https://www.elastic.co/products/kibana](https://www.elastic.co/products/kibana)'
  id: totrans-149
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[https://www.elastic.co/products/kibana](https://www.elastic.co/products/kibana)'
- en: '[https://www.elastic.co/products/logstash](https://www.elastic.co/products/logstash)'
  id: totrans-150
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[https://www.elastic.co/products/logstash](https://www.elastic.co/products/logstash)'
- en: Working with Nagios
  id: totrans-151
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用Nagios
- en: Nagios is a system monitoring and alerting tool. This section will focus on
    configuring a simple Nagios installation that monitors the nodes in our Elasticsearch
    cluster, as well as the Elasticsearch process on those. If a node or process shuts
    down, Nagios will send us an alert.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios是一个系统监控和警报工具。本节将重点介绍配置一个简单的Nagios安装，该安装监控我们的Elasticsearch集群中的节点以及这些节点上的Elasticsearch进程。如果一个节点或进程关闭，Nagios将向我们发送警报。
- en: It's a good idea to install Nagios on a host outside of the Elasticsearch clusters
    in order to avoid affecting the monitoring process due to other things going on
    in the system, such as high Elasticsearch load. Create a new host for Nagios and
    call it `elasticsearc` `h-nagios-01.`
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 在Elasticsearch集群之外的主机上安装Nagios是个好主意，以避免由于系统中的其他事情（如高Elasticsearch负载）而影响监控过程。为Nagios创建一个新的主机并命名为`elasticsearc`
    `h-nagios-01.`
- en: Installing Nagios
  id: totrans-154
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装Nagios
- en: 'In addition to the dedicated Nagios host, `elasticsearch-nagios-01`, install
    the **Nagios Remote Plugin Executor** (**NRPE**) server on all of the Elasticsearch
    cluster nodes in order to monitor the Elasticsearch process. Follow these steps:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 除了专门的Nagios主机`elasticsearch-nagios-01`之外，还需要在所有Elasticsearch集群节点上安装**Nagios远程插件执行器**（**NRPE**）服务器，以监控Elasticsearch进程。按照以下步骤操作：
- en: 'Run the following command on each of the Elasticsearch nodes: `elasticsearch-node-01`,
    `elasticsearch-node-02`, `elasticsearch-node-03`, and `elasticsea``rch-marvel-01`:'
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在每个Elasticsearch节点上运行以下命令：`elasticsearch-node-01`、`elasticsearch-node-02`、`elasticsearch-node-03`和`elasticsea``rch-marvel-01`：
- en: '[PRE12]'
  id: totrans-157
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Then install Nagios on the new host `elasticsearch-nagios-01`:'
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后在新的主机`elasticsearch-nagios-01`上安装Nagios：
- en: '[PRE13]'
  id: totrans-159
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: This process will ask you to enter a password. Make sure you remember it.
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此过程将要求您输入密码。请确保您记住它。
- en: 'Now a Nagios plugin is needed to ensure that Elasticsearch is running. There
    are several plugins available, but this book uses a simple script available on
    GitHub: [https://github.com/orthecreedence/check_elasticsearch](https://github.com/orthecreedence/check_elasticsearch).'
  id: totrans-161
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 现在，需要一个Nagios插件来确保Elasticsearch正在运行。有多个插件可供选择，但本书使用GitHub上可用的简单脚本：[https://github.com/orthecreedence/check_elasticsearch](https://github.com/orthecreedence/check_elasticsearch)。
- en: 'To download and install this script on `elasticsearch-nagios-01`, run:'
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要在`elasticsearch-nagios-01`上下载和安装此脚本，请运行：
- en: '[PRE14]'
  id: totrans-163
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Next, add a Nagios command to run this plugin. On `elasticsearch-nagios-01`,
    create a new file, `/etc/nagios-plugins/config/elasticsearch.cfg`, with this content:'
  id: totrans-164
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，添加一个Nagios命令来运行此插件。在`elasticsearch-nagios-01`上创建一个新文件，`/etc/nagios-plugins/config/elasticsearch.cfg`，内容如下：
- en: '[PRE15]'
  id: totrans-165
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Lastly, specify which hosts to monitor for the Nagios server. Be sure to have
    it monitor the Elasticsearch process on those hosts, using the `check_elasticsearch`
    utility, by editing the configuration file `/etc/nagios3/conf.d/localhost_nagios2.cfg`:'
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，指定要监控的Nagios服务器的主机。确保使用`check_elasticsearch`实用程序在这些主机上监控Elasticsearch进程，通过编辑配置文件`/etc/nagios3/conf.d/localhost_nagios2.cfg`：
- en: '[PRE16]'
  id: totrans-167
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Next, configure `elasticsearch-node-01`, `elasticsearch-node-02`, `elasticsearch-node-03`,
    and `elasticsearch-marvel-01` to allow our Nagios host `elasticsearch-nagios-01`
    to collect metrics:'
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，配置`elasticsearch-node-01`、`elasticsearch-node-02`、`elasticsearch-node-03`和`elasticsearch-marvel-01`，以允许我们的Nagios主机`elasticsearch-nagios-01`收集指标：
- en: '[PRE17]'
  id: totrans-169
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Edit the `allowed_hosts` setting to include the `elasticsearch-nagios-01` IP
    address; in our case, this is `192.168.56.130`:'
  id: totrans-170
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑`allowed_hosts`设置以包括`elasticsearch-nagios-01`的IP地址；在我们的例子中，这是`192.168.56.130`：
- en: '[PRE18]'
  id: totrans-171
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Now restart the NRPE server on all nodes in our Elasticsearch clusters:'
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，在Elasticsearch集群的所有节点上重启NRPE服务器：
- en: '[PRE19]'
  id: totrans-173
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'And finally, restart `nagios3` on `elasticsearch-nagios-01`:'
  id: totrans-174
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，在`elasticsearch-nagios-01`上重启`nagios3`：
- en: '[PRE20]'
  id: totrans-175
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Open a web browser to see the Nagios web administration portal, with the username
    `nagiosadmin` and the password you entered earlier:'
  id: totrans-176
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开一个网页浏览器以查看Nagios网络管理门户，用户名为`nagiosadmin`，密码为之前输入的密码：
- en: '[PRE21]'
  id: totrans-177
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: After giving Nagios a few minutes to collect metrics on all nodes, click on
    the **Hosts** sidebar link to see the state of all nodes in the clusters:![Installing
    Nagios](img/B03798_05_14.jpg)
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在Nagios收集所有节点上的指标几分钟之后，点击**主机**侧边栏链接以查看集群中所有节点的状态：![安装Nagios](img/B03798_05_14.jpg)
- en: Viewing Elasticsearch hosts in Nagios
  id: totrans-179
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在Nagios中查看Elasticsearch主机
- en: Click **Services** in the left-hand menu to see the state of the Elasticsearch
    process on each node:![Installing Nagios](img/B03798_05_15.jpg)
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击左侧菜单中的**服务**以查看每个节点上Elasticsearch进程的状态：![安装Nagios](img/B03798_05_15.jpg)
- en: Viewing Elasticsearch status in Nagios
  id: totrans-181
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在Nagios中查看Elasticsearch状态
- en: Note
  id: totrans-182
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Notice that in `elasticsearch-marvel-01`, the Elasticsearch process is in a
    yellow **WARNING** state. This means that the cluster is in a `yellow` state,
    because there is only one node in the Marvel cluster and not all shards are replicated.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，在`elasticsearch-marvel-01`中，Elasticsearch进程处于黄色**警告**状态。这意味着集群处于`黄色`状态，因为Marvel集群中只有一个节点，并且不是所有分片都进行了复制。
- en: Now we'll demonstrate what Nagios does when one node shuts down and we stop
    the Elasticsearch process on a different node.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们将演示当某个节点关闭并且我们在另一个节点上停止Elasticsearch进程时，Nagios会做什么。
- en: 'Shut down `elasticsearch-node-01` and disable Elasticsearch on `elasticsearch-node-02`:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 关闭`elasticsearch-node-01`并禁用`elasticsearch-node-02`上的Elasticsearch：
- en: '[PRE22]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'The next time Nagios polls for the cluster state (this will take a few minutes),
    the following will display on the Nagios web dashboard''s services page:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 下次Nagios轮询集群状态（这需要几分钟）时，以下内容将在Nagios网页仪表板的“服务”页面上显示：
- en: '![Installing Nagios](img/B03798_05_16.jpg)'
  id: totrans-188
  prefs: []
  type: TYPE_IMG
  zh: '![安装Nagios](img/B03798_05_16.jpg)'
- en: Error reporting in Nagios
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios的错误报告
- en: Nagios now indicates that `elasticsearch-node-01` is down and that it can't
    connect to the Elasticsearch process on `elasticsearch-node-02`. Nagios also indicates
    Elasticsearch has entered a `red` state on `elasticsearch-node-03` because not
    all shards are available. Nagios will send `admin@your-domain.com` an email about
    the warnings and errors, based on our previous configuration. Things will return
    to normal after starting `elasticsearch-node-01` and restarting Elasticsearch
    on `elast` `icsearch-node-02`.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios现在显示`elasticsearch-node-01`已关闭，并且无法连接到`elasticsearch-node-02`上的Elasticsearch进程。Nagios还显示`elasticsearch-node-03`上的Elasticsearch已进入`红色`状态，因为并非所有分片都可用。根据我们之前的配置，Nagios将向`admin@your-domain.com`发送关于警告和错误的电子邮件。在启动`elasticsearch-node-01`并重新启动`elast`
    `icsearch-node-02`上的Elasticsearch后，一切将恢复正常。
- en: Command line tools for system and process management
  id: totrans-191
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 系统和进程管理的命令行工具
- en: The command line is an invaluable tool for system monitoring. In this section,
    we'll go over a few basic GNU/Linux command line utilities for system and process
    management. Knowing these tools is essential for anyone managing an Elasticsearch
    cluster on GNU/Linux.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 命令行是系统监控的无价工具。在本节中，我们将介绍一些基本的GNU/Linux命令行工具，用于系统和进程管理。了解这些工具对于管理Elasticsearch集群在GNU/Linux上的人来说至关重要。
- en: top
  id: totrans-193
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: top
- en: The `top` command lists processes with the highest CPU and memory. This tool
    is useful to determine whether a process other than Elasticsearch is hogging resources,
    or to check whether Elasticsearch is using an abnormal amount of CPU or memory.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: '`top`命令列出了占用CPU和内存最高的进程。这个工具有助于确定是否有除了Elasticsearch之外的进程正在占用资源，或者检查Elasticsearch是否使用了异常的CPU或内存量。'
- en: The `top` command refreshes automatically, so you only have to run it once and
    watch.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: '`top`命令会自动刷新，所以你只需要运行一次并观察。'
- en: 'When running the command, you should see the following result:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 运行命令时，你应该看到以下结果：
- en: '![top](img/B03798_05_17.jpg)'
  id: totrans-197
  prefs: []
  type: TYPE_IMG
  zh: '![top](img/B03798_05_17.jpg)'
- en: The top command
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: '`top`命令'
- en: Tip
  id: totrans-199
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: Press *Shift*+*M* while `top` is running to sort processes by those using the
    most memory instead of CPU.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 在`top`运行时按*Shift*+*M*以按使用最多内存的进程排序，而不是按CPU。
- en: tail
  id: totrans-201
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: tail
- en: 'The `tail -f` command is useful for viewing log files in real time. Use it
    to view Elasticsearch log files as follows:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: '`tail -f`命令用于实时查看日志文件。使用它来查看Elasticsearch日志文件如下：'
- en: '[PRE23]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: '![tail](img/B03798_05_18.jpg)'
  id: totrans-204
  prefs: []
  type: TYPE_IMG
  zh: '![tail](img/B03798_05_18.jpg)'
- en: '"tailing" Elasticsearch log files'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: “跟踪”Elasticsearch日志文件
- en: grep
  id: totrans-206
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: grep
- en: 'The `grep` command is a general purpose text search tool. One useful application
    of `grep` is to search through a directory of log files for a specific string.
    To *grep* or search `/var/log/elasticsearch` for all logged exceptions, run the
    following command with the `-r` (recursive) and `-i` (case insensitive search)
    options:'
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: '`grep`命令是一个通用的文本搜索工具。`grep`的一个有用应用是搜索日志文件目录中的特定字符串。要使用`grep`或搜索`/var/log/elasticsearch`中的所有已记录异常，请使用带有`-r`（递归）和`-i`（不区分大小写搜索）选项的以下命令：'
- en: '[PRE24]'
  id: totrans-208
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Assuming there are some exceptions logged in your Elasticsearch log files,
    you should see something like this:'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 假设你的Elasticsearch日志文件中记录了一些异常，你应该会看到如下内容：
- en: '![grep](img/B03798_05_19.jpg)'
  id: totrans-210
  prefs: []
  type: TYPE_IMG
  zh: '![grep](img/B03798_05_19.jpg)'
- en: '"grepping" log files for exceptions'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: “grep”日志文件以查找异常
- en: ps
  id: totrans-212
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ps
- en: Use the `ps` command along with the `grep` command to see whether a particular
    process is running. This is a useful sanity check if you are running into issues
    stopping or starting Elasticsearch (or another process).
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`ps`命令和`grep`命令来查看特定进程是否正在运行。如果你在停止或启动Elasticsearch（或其他进程）时遇到问题，这是一个有用的检查。
- en: 'To check whether Elasticsearch is running, use the following command:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 要检查Elasticsearch是否正在运行，请使用以下命令：
- en: '[PRE25]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'This command will output nothing if Elasticsearch is not running. If it''s
    running, you should see something like this:'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Elasticsearch没有运行，此命令将不会输出任何内容。如果它在运行，你应该会看到如下内容：
- en: '![ps](img/B03798_05_20.jpg)'
  id: totrans-217
  prefs: []
  type: TYPE_IMG
  zh: '![ps](img/B03798_05_20.jpg)'
- en: Using ps to view the Elasticsearch process
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 使用ps查看Elasticsearch进程
- en: kill
  id: totrans-219
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: kill
- en: 'Use the `kill` command stop a process that won''t shut down gracefully. For
    example, to shut down the Elasticsearch process listed previously, run the following
    command:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `kill` 命令停止不会优雅关闭的进程。例如，要关闭之前列出的 Elasticsearch 进程，请运行以下命令：
- en: '[PRE26]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: '![kill](img/B03798_05_21.jpg)'
  id: totrans-222
  prefs: []
  type: TYPE_IMG
  zh: '![kill](img/B03798_05_21.jpg)'
- en: Kill the Elasticsearch process and verify it with the ps command
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 ps 命令杀死 Elasticsearch 进程并验证
- en: free
  id: totrans-224
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: free
- en: 'The `free` command tells us how much memory is in use on a system. Its usage
    is:'
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: '`free` 命令告诉我们系统中有多少内存正在使用。其用法如下：'
- en: '[PRE27]'
  id: totrans-226
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Running this command will yield something similar to:'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 运行此命令将产生类似以下的结果：
- en: '![free](img/B03798_05_22.jpg)'
  id: totrans-228
  prefs: []
  type: TYPE_IMG
  zh: '![free](img/B03798_05_22.jpg)'
- en: The free command shows the amount of RAM on the system
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: '`free` 命令显示系统中的 RAM 量'
- en: This output means that we are using 333 MB of our available 490 MB memory store.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 此输出表示我们正在使用 333 MB 的可用 490 MB 内存存储。
- en: du and df
  id: totrans-231
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: du 和 df
- en: 'The `du` and `df` commands tell us how much disk space is available on the
    host. Use `du` to see how much data is stored in the current directory, as shown
    here:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: '`du` 和 `df` 命令告诉我们主机上有多少磁盘空间可用。使用 `du` 命令查看当前目录中存储了多少数据，如下所示：'
- en: '[PRE28]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'You should see a result similar to this:'
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该看到类似以下的结果：
- en: '![du and df](img/B03798_05_23.jpg)'
  id: totrans-235
  prefs: []
  type: TYPE_IMG
  zh: '![du and df](img/B03798_05_23.jpg)'
- en: The du command calculates the size of a directory
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: '`du` 命令计算目录的大小'
- en: In this case, there are 15 MB of log files in `/var/log/elasticsearch/`.
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，在 `/var/log/elasticsearch/` 目录中有 15 MB 的日志文件。
- en: 'Use `df` to see how much disk space is available across the system, as shown
    here:'
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `df` 命令查看系统中有多少磁盘空间可用，如下所示：
- en: '[PRE29]'
  id: totrans-239
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'You should see a result similar to this:'
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该看到类似以下的结果：
- en: '![du and df](img/B03798_05_24.jpg)'
  id: totrans-241
  prefs: []
  type: TYPE_IMG
  zh: '![du and df](img/B03798_05_24.jpg)'
- en: Disk usage on elasticsearch-node-01
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: elasticsearch-node-01 的磁盘使用情况
- en: The output here says there is `1.3G` of available storage left on the `/` mount
    point.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 此处的输出表明 `/` 挂载点上还有 `1.3G` 的可用存储空间。
- en: Note
  id: totrans-244
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Note that in both of these commands, the `-h` flag stands for **human readable**,
    meaning they will output values in terms of KB, MB, or GB, as opposed to just
    bytes.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，在这两个命令中，`-h` 标志代表**可读性**，意味着它们将以 KB、MB 或 GB 的形式输出值，而不是仅仅以字节为单位。
- en: Summary
  id: totrans-246
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: This chapter examined the Elasticsearch monitoring tool Kopf, the Elasticsearch,
    Logstash, and Kibana (ELK) log aggregation stack, the system monitoring tool Nagios,
    and various GNU/Linux command line utilities.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 本章探讨了 Elasticsearch 监控工具 Kopf、Elasticsearch、Logstash 和 Kibana (ELK) 日志聚合堆栈、系统监控工具
    Nagios 以及各种 GNU/Linux 命令行实用工具。
- en: 'Some takeaways are:'
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 一些要点包括：
- en: Kopf is an Elasticsearch monitoring tool similar to Elasticsearch-head, but
    provides a few different metrics.
  id: totrans-249
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Kopf 是一个类似于 Elasticsearch-head 的 Elasticsearch 监控工具，但提供了一些不同的指标。
- en: The Elasticsearch, Logstash, and Kibana (ELK) stack is a tool for searching,
    analyzing, enriching, and visualizing log files.
  id: totrans-250
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Elasticsearch、Logstash 和 Kibana (ELK) 堆栈是一个用于搜索、分析、丰富和可视化日志文件的工具。
- en: Consider using a tool such as Nagios to monitor an Elasticsearch cluster. Nagios
    can be configured to send out email notifications when a process goes down or
    if the node itself goes down.
  id: totrans-251
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 考虑使用 Nagios 等工具监控 Elasticsearch 集群。Nagios 可以配置为在进程崩溃或节点本身崩溃时发送电子邮件通知。
- en: Using a few GNU/Linux command tools, we can gather many of the same metrics
    provided by the various Elasticsearch monitoring tools.
  id: totrans-252
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过使用一些 GNU/Linux 命令行工具，我们可以收集到与各种 Elasticsearch 监控工具提供的相同指标。
- en: The next chapter will discuss troubleshooting Elasticsearch performance and
    reliability issues. The monitoring tools discussed in this chapter will be useful
    when tackling the real-world problems outlined in upcoming chapters.
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 下一章将讨论解决 Elasticsearch 性能和可靠性问题的方法。本章讨论的监控工具将在解决即将到来的章节中概述的现实世界问题中非常有用。
