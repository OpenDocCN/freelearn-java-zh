<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Integrating jBPM with Enterprise Architecture"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Integrating jBPM with Enterprise Architecture</h1></div></div></div><p>We have an enterprise infrastructure in place, now we want to separate and centralize the process management to a single component, and of course, our choice is jBPM. So, the million dollar question would be "How do we integrate jBPM to the enterprise application in place?"</p><p>The answer to this question varies according to requirements and how the enterprise application is built. The architecture describes how the application is built, and from a broader perspective, a set of architecture patterns are used (either alone or in combination) as guidelines to model the architecture. This chapter focuses on provisions available in jBPM for integrating it with applications that follow these architecture patterns.</p><p>The chapter starts by discussing the context of enterprise application integration and continues to discuss the following in detail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Integrating jBPM into a JEE-based application</li><li class="listitem" style="list-style-type: disc">Integrating jBPM into a service-oriented architecture</li><li class="listitem" style="list-style-type: disc">Integrating jBPM into an event-driven architecture</li></ul></div><div class="section" title="Setting the context"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec47"/>Setting the context</h1></div></div></div><p>System integration of a <a id="id861" class="indexterm"/>software component to an existing software architecture indicates that we should provide two windows (interfaces), listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To access services provided by the new component. In case of jBPM, it is represented by various services provided by jBPM, for example, the process runtime provision for managing the life cycle of a business process. JBPM exposes these services as APIs of its core engine.</li><li class="listitem" style="list-style-type: disc">To enable jBPM to access the services provided by other components in the application architecture. The extension points that JBPM provides for integration with external components are the workitem handlers. We can create handlers <a id="id862" class="indexterm"/>and write the logic for accessing the external components.</li></ul></div><p>The following figure depicts this context:</p><div class="mediaobject"><img src="graphics/9578OS_08_01.jpg" alt="Setting the context"/></div></div></div>
<div class="section" title="Services provided by jBPM"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec48"/>Services provided by jBPM</h1></div></div></div><p>As we discussed in the<a id="id863" class="indexterm"/> previous section, one of the critical part of system integration with jBPM is the ability to access the features of jBPM. JBPM provides an application programming interface to access these features. This API can be directly invoked within the<a id="id864" class="indexterm"/> same JVM, and if needed to be accessed from outside the system boundary, it has to be wrapped and provided as a remotely accessible service. For this, we have an array of options, right from an <span class="strong"><strong>Enterprise JavaBeans</strong></span> (<span class="strong"><strong>EJB</strong></span>) remote interface to REST-based web services. Each of these will be detailed in the subsequent sections of this chapter.</p><p>The following are the services provided by jBPM:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Definition service</strong></span>: This helps to<a id="id865" class="indexterm"/> define a process and analyze its content</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Deployment service</strong></span>: This<a id="id866" class="indexterm"/> helps to deploy a business process and the associated artifacts</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Process service</strong></span>: This<a id="id867" class="indexterm"/> helps to start a process instance from the process definitions, manage the life cycle of the instance, and interact with them using signals</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>User task service</strong></span>: This helps to <a id="id868" class="indexterm"/>manage the human task life cycle</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Runtime data service</strong></span>: This <a id="id869" class="indexterm"/>helps to get the details of the data during jBPM runtime regarding process, process instance, tasks, and audit trails</li></ul></div><p>Each service is detailed in the following section with (important) operations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">org.jbpm.services.api.DefinitionService</code>: This service helps to define a process<a id="id870" class="indexterm"/> from the BPMN text and provides operations to analyze a business process definition:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operation</p>
</th><th style="text-align: left" valign="bottom">
<p>Operation signature</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">buildProcessDefinition</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">ProcessDefinition buildProcessDefinition(String deploymentId, String bpmn2Content, ClassLoader classLoader, boolean cache) throws IllegalArgumentException;</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>Builds the process definition from the given process definition content (<code class="literal">bpmn2Content</code>)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getReusableSubProcesses</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Collection&lt;String&gt; getReusableSubProcesses(String deploymentId, String processId);</pre></div>
</td><td style="text-align: left" valign="top">
<p>Gets the process identifiers of the reusable subprocesses inside a process definition</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getProcess Variables</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Map&lt;String, String&gt; getProcessVariables(String deploymentId, String processId);</pre></div>
</td><td style="text-align: left" valign="top">
<p>Retrieves the name and type of all process variables in a business process</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getServiceTasks</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Map&lt;String, String&gt; getServiceTasks(String deploymentId, String processId);</pre></div>
</td><td style="text-align: left" valign="top">
<p>Gets the identifiers of all service tasks associated in a business process definition</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getTasks Definitions</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Collection&lt;UserTaskDefinition&gt; getTasksDefinitions(String deploymentId, String processId);</pre></div>
</td><td style="text-align: left" valign="top">
<p>Retrieves all the tasks defined in the business process</p>
</td></tr></tbody></table></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">org.jbpm.services.api.DeploymentService</code>: This service helps to deploy and manage an application<a id="id871" class="indexterm"/> deployment unit:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operation</p>
</th><th style="text-align: left" valign="bottom">
<p>Operation signature</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">deploy</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void deploy(DeploymentUnit unit);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">undeploy</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void undeploy(DeploymentUnit unit);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">activate</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void activate(String deploymentId)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">deactivate</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void deactivate(String deploymentId);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IsDeployed</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">boolean isDeployed(String deploymentUnitId)</pre></div>
</td></tr></tbody></table></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">org.jbpm.services.api.ProcessService</code>: This process service is used to manage the life cycle <a id="id872" class="indexterm"/>and to interact with a started process instance:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operation</p>
</th><th style="text-align: left" valign="bottom">
<p>Operation signature</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">startProcess</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Long startProcess(String deploymentId, String processId);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">startProcess</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Long startProcess(String deploymentId, String processId, Map&lt;String, Object&gt; params);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">abortProcessInstance</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void abortProcessInstance(Long processInstanceId);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">abortProcessInstances</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void abortProcessInstances(List&lt;Long&gt; processInstanceIds);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signalProcessInstance</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void signalProcessInstance(Long processInstanceId, String signalName, Object event);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signalProcessInstances</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void signalProcessInstances(List&lt;Long&gt; processInstanceIds, String signalName, Object event);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">completeWorkItem</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void completeWorkItem(Long id, Map&lt;String, Object&gt; results);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">abortWorkItem</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">abortWorkItem(Long id);</pre></div>
</td></tr></tbody></table></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">org.jbpm.services.api.UserTaskService</code>: This service helps to perform life cycle <a id="id873" class="indexterm"/>management operations of a user task:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operation</p>
</th><th style="text-align: left" valign="bottom">
<p>Operation signature</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">activate</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void activate(Long taskId, String userId)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">claim</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void claim(Long taskId, String userId)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Complete</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void complete(Long taskId, String userId, Map&lt;String, Object&gt; params)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Delegate</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void delegate(Long taskId, String userId, String targetUserId)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">exit</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void exit(Long taskId, String userId)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">fail</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void fail(Long taskId, String userId, Map&lt;String, Object&gt; faultData)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Forward</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void forward(Long taskId, String userId, String targetEntityId)</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">release</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void release(Long taskId, String userId);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">resume</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void resume(Long taskId, String userId);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">skip</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void skip(Long taskId, String userId);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">start</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void start(Long taskId, String userId);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">stop</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">void stop(Long taskId, String userId);</pre></div>
</td></tr></tbody></table></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">org.jbpm.services.api.RuntimeDataService</code>: This API is used to retrieve information <a id="id874" class="indexterm"/>about the jBPM runtime including the data of process instances, tasks, and audit logs:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operation</p>
</th><th style="text-align: left" valign="bottom">
<p>Operation signature</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getProcesses</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Collection&lt;ProcessDefinition&gt; getProcesses(QueryContext queryContext);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getProcessInstances</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Collection&lt;ProcessInstanceDesc&gt; getProcessInstances(QueryContext queryContext);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getProcessInstance FullHistory</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Collection&lt;NodeInstanceDesc&gt; getProcessInstanceFullHistory(long processInstanceId, QueryContext queryContext);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getVariableHistory</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">Collection&lt;VariableDesc&gt; getVariableHistory(long processInstanceId, String variableId, QueryContext queryContext);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getTaskEvents</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">List&lt;TaskEvent&gt; getTaskEvents(long taskId, QueryFilter filter);</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getTasksOwned</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">List&lt;TaskSummary&gt; getTasksOwned(String userId, QueryFilter filter);</pre></div>
</td></tr></tbody></table></div></li></ul></div></div>
<div class="section" title="Creating custom workitem handlers"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec49"/>Creating custom workitem handlers</h1></div></div></div><p>In order for jBPM to access <a id="id875" class="indexterm"/>services of other components in the application, we can use the workitem handler extension point provided by jBPM. Workitem handlers are used to specify domain-specific services to a BPMN activity. There are several inbuilt generic workitem handlers prebuilt in jBPM.</p><p>For creating a workitem handler, we have to implement the <code class="literal">org.kie.runtime.instance.WorkItemHandler</code> interface. This interface holds two methods to be implemented:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">WorkItemManager.completeWorkItem(long workItemId, Map&lt;String, Object&gt; results)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">WorkItemManager.abortWorkItem(long workItemId)</code></li></ul></div><p>A custom workitem has to be registered to the engine by using the workitem manager. For example, for registering a customer task, we can use the following:</p><div class="informalexample"><pre class="programlisting">ksession.getWorkItemManager().registerWorkItemHandler("Notification",
new NotificationWorkItemHandler());</pre></div><p>In conclusion, we have discussed the provisions available in jBPM for integrating it with generic software architecture. In the following sections, we will discuss how to integrate jBPM into widely used <a id="id876" class="indexterm"/>enterprise architectures.</p></div>
<div class="section" title="Integrating with JEE"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec50"/>Integrating with JEE</h1></div></div></div><p>The Java Enterprise <a id="id877" class="indexterm"/>Edition provides an API and a runtime environment for developing and deploying enterprise applications. Further, EJB defines a set of lightweight APIs<a id="id878" class="indexterm"/> that can be used to build applications and leverage capabilities such as transactions, remote procedure calls, concurrency control, and access control.</p><p>EJB can be accessed in two modes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Remote interface</strong></span>: This<a id="id879" class="indexterm"/> is where the component that wants to access the EJB is not packed together with jBPM</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Local interface</strong></span>: This is where<a id="id880" class="indexterm"/> the component that wants to access the EJB is packed together with a jBPM service</li></ul></div><p>JBPM provides out-of-the-box support for JEE integrations. It provides EJB remote and local interfaces for accessing the above-listed services.</p><div class="section" title="EJB remote interfaces"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec131"/>EJB remote interfaces</h2></div></div></div><p>The EJB remote interfaces are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Service name</p>
</th><th style="text-align: left" valign="bottom">
<p>EJB remote service class</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Definition service</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">
<code class="literal">org.jbpm.services.ejb.api.DefinitionServiceEJBRemote</code>
</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Deployment service</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">
<code class="literal">org.jbpm.services.ejb.api.DeploymentServiceEJBRemote</code>
</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Process service</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">
<code class="literal">org.jbpm.services.ejb.api.ProcessServiceEJBRemote</code>
</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Runtime data service</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">
<code class="literal">org.jbpm.services.ejb.api.RuntimeDataServiceEJBRemote</code>
</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>User task service</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">
<code class="literal">org.jbpm.services.ejb.api.UserTaskServiceEJBRemote</code>
</pre></div>
</td></tr></tbody></table></div><p>These remote services can be accessed from other Java applications. First, we need to access the <code class="literal">ejb</code> remote interface.</p><p>For example (specific to the <code class="literal">jboss</code> application server), the following code shows the lookup <a id="id881" class="indexterm"/>of the <code class="literal">ProcessService</code>:</p><div class="informalexample"><pre class="programlisting">final Hashtable&lt;String, String&gt; jndiProperties = new Hashtable&lt;String, String&gt;();
  //Set the JNDI properties
  jndiProperties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");

  final Context context = new InitialContext(jndiProperties);
  //Set the bean name
  String beanName = "ProcessServiceEJBImpl!org.jbpm.services.ejb.api.ProcessServiceEJB Remote";

  String jndi = "ejb:/" + application + "/" + mappedName;
  ProcessService bean = (ProcessService) context.lookup(jndi);</pre></div><p>After looking up the service, the service can be accessed seamlessly.</p></div><div class="section" title="The EJB local interface"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec132"/>The EJB local interface</h2></div></div></div><p>The EJB local interface <a id="id882" class="indexterm"/>can be accessed in two ways. One is by using the <code class="literal">javax.ejb.EJB</code> annotation and specifying the enterprise bean's local business interface name:</p><p>For example:</p><div class="informalexample"><pre class="programlisting">@EJB
ProcessService processservice;</pre></div><p>The container will inject the EJB access for the API.</p><p>The other syntactical way to access a local EJB service is by using the JNDI lookup and the <code class="literal">javax.naming.InitialContext</code> interface's <code class="literal">lookup</code> method:</p><div class="informalexample"><pre class="programlisting">ProcessService processservice = (Processservice)
  InitialContext.lookup("java:jbpm/Processservice");</pre></div></div></div>
<div class="section" title="Integrating in SOA and EDA environments"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec51"/>Integrating in SOA and EDA environments</h1></div></div></div><p>The first part of this section covers how to integrate jBPM acting as a client into external services; <a class="link" href="ch05.html" title="Chapter 5. BPMN Constructs">Chapter 5</a>, <span class="emphasis"><em>BPMN Constructs</em></span>, and <a class="link" href="ch06.html" title="Chapter 6. Core Architecture">Chapter 6</a>, <span class="emphasis"><em>Core Architecture</em></span>, introduced jBPM elements specifically designed to call external web services from a process definition: the service task<a id="id883" class="indexterm"/> and the WS or the REST workitem handlers. The latter are jBPM ready-to-use, configurable components, but keep in mind that jBPM gives the user all the tools to develop custom handlers so as to <a id="id884" class="indexterm"/>perform interactions with generic external services (see <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span>). The second part of the section will examine how to integrate the jBPM API as a server using REST, SOAP, and JMS. We will provide you with two example projects (<code class="literal">jbpm-remote-client</code> and <code class="literal">jbpm-remote-server</code>) in order to put into action these jBPM features.</p><p>We are going to see how to connect to both REST and SOAP services.</p><div class="section" title="Integrating with REST services"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec133"/>Integrating with REST services</h2></div></div></div><p>Before starting a commented step-by-step tour of a jBPM application integrated with a REST service, let us review the basics of the support jBPM offers when coming to REST integration. The jBPM<a id="id885" class="indexterm"/> REST workitem handler (class <code class="literal">org.jbpm.process.workitem.rest.RESTWorkItemHandler</code>) is designed to interact <a id="id886" class="indexterm"/>with REST services (both secured and not secured); it supports the following parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Url</code>: Target resource endpoint</li><li class="listitem" style="list-style-type: disc"><code class="literal">Method</code>: HTTP method (defaults to <code class="literal">GET</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">ContentType</code>: Datatype when sending data (required with <code class="literal">POST</code> and <code class="literal">PUT</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">Content</code>: Data to send (required with <code class="literal">POST</code> and <code class="literal">PUT</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">ConnectTimeout</code>: Connection timeout (defaults to 60 seconds)</li><li class="listitem" style="list-style-type: disc"><code class="literal">ReadTimeout</code>: Read timeout (defaults to 60 seconds)</li><li class="listitem" style="list-style-type: disc"><code class="literal">Username</code>: Authentication username</li><li class="listitem" style="list-style-type: disc"><code class="literal">Password</code>: Authentication password</li></ul></div><p>The handler returns an output result that defines the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Result</code>: The REST service text body response</li><li class="listitem" style="list-style-type: disc"><code class="literal">Status</code>: The integer HTTP response code</li><li class="listitem" style="list-style-type: disc"><code class="literal">StatusMsg</code>: A string description for the operation outcome</li></ul></div><p>Our example application sets up a REST server and starts a process that has a REST service task node: the<a id="id887" class="indexterm"/> REST node performs an HTTP POST operation passing an <code class="literal">Order</code> instance (as a XML string) to the REST server; the server modifies the order's note and returns the order.</p><div class="section" title="The REST service"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec104"/>The REST service</h3></div></div></div><p>Our REST server is started inside the test class (the <code class="literal">RestTest.initializeRestServer</code> method) by using the JAX-RS Apache CXF implementation (the CXF version is 2.7.14, check the project <code class="literal">pom.xml</code> file for dependencies); the initialization code sets a JAXB provider in order to support data binding for beans.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note54"/>Note</h3><p>Please check the <a id="id888" class="indexterm"/>Apache CXF documentation for JAX-RS at <a class="ulink" href="http://cxf.apache.org/docs/jax-rs.html">http://cxf.apache.org/docs/jax-rs.html</a>.</p></div></div><p>The server is set up<a id="id889" class="indexterm"/> around a REST resource (the <code class="literal">RestResource</code> class), which defines the available operations through the JAX-RS <code class="literal">jax.ws.rs</code> package annotations.</p></div><div class="section" title="The client – REST handler configuration"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec105"/>The client – REST handler configuration</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The example test <a id="id890" class="indexterm"/>class method <code class="literal">RestTest.testRestProcess</code> starts a process instance (see the <code class="literal">rest.bpmn2</code> process definition); the process has a REST task node configured with the following mandatory parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Url</code>: <code class="literal">http://localhost:9998/pizzarestservice/order</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ContentType</code>: <code class="literal">application/xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Content</code>: <code class="literal">&lt;order&gt;&lt;note&gt;my note&lt;/note&gt;&lt;/order&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Method</code>: <code class="literal">POST</code></li></ul></div></li></ul></div><p>The node handler performs the REST call to the <code class="literal">postOrder(Order order)</code> method of the <code class="literal">RestResource</code> class; the method is annotated with <code class="literal">@Path("/order")</code>, and the XML bean serialization is taken care of, as we said, by JAXB. The REST task output variable is mapped back to the process instance and printed by the script task.</p><p>With the jUnit test class (<code class="literal">TestRest</code>), you can exercise the REST handler and the REST service outside the process definition (the <code class="literal">testPOSTOperation</code> method).</p><p>In case the default jBPM REST handler cannot meet your requirements (because of serialization constraints, frameworks lock-ins, and so on), it's important to point out that the developer can provide a brand new handler implementation: follow the <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span>, guidelines describing the workitem handler development process. Let<a id="id891" class="indexterm"/> us now see how to set up and call a SOAP web service from a process definition.</p></div></div><div class="section" title="The SOAP WebService"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec134"/>The SOAP WebService</h2></div></div></div><p>jBPM ships with a<a id="id892" class="indexterm"/> specialized <code class="literal">ServiceTaskHandler</code> (see <a class="link" href="ch05.html" title="Chapter 5. BPMN Constructs">Chapter 5</a>, <span class="emphasis"><em>BPMN Constructs</em></span>), which features web service interactions based on WSDL. The service task is marked as having an implementation of the <code class="literal">WebService</code> type (the task also supports plain Java implementation execution through the <code class="literal">Reflection</code> class). Please check the <span class="emphasis"><em>Service task</em></span> section of <a class="link" href="ch05.html" title="Chapter 5. BPMN Constructs">Chapter 5</a>, <span class="emphasis"><em>BPMN Constructs</em></span>, for additional details and a working example description. Our jUnit class (<code class="literal">WsTest</code>) sets up a web service (the <code class="literal">startWebService</code> method) and then, starts a process that has two service task nodes, one calling the web service <code class="literal">addSmallOrder</code> operation, and the other calling the <code class="literal">addLargeOrder</code> operation: both the operations take an <code class="literal">Order</code> instance as the input and return a Boolean result, which is printed by the script task. The service tasks are on different process branches, which are taken by the exclusive gateway by evaluating the submitted order's total amount.</p><div class="section" title="The JAX-WS service"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec106"/>The JAX-WS service</h3></div></div></div><p>The <code class="literal">TestWebService</code> service is<a id="id893" class="indexterm"/> an annotated JAX-WS service; it is started from the <code class="literal">WsTest.startWebService</code> method class, and its endpoint is set to <code class="literal">http://127.0.0.1:9931/testwebservice/order</code> (you can easily configure this in the unit test class). The <code class="literal">http://127.0.0.1:9931/testwebservice/order?WSDL</code> link returns the service WSDL interface. The<a id="id894" class="indexterm"/> service exposes the two aforementioned methods: <code class="literal">addSmallOrder</code> and <code class="literal">addLargeOrder</code>. Let us see how to call our web service operation from our process definition.</p><div class="section" title="The client – process and service task handler configuration"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec23"/>The client – process and service task handler configuration</h4></div></div></div><p>In order to call the web <a id="id895" class="indexterm"/>service operation, we must perform the following steps, by editing the process definition and its service task node element:</p></div><div class="section" title="Process definition"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec24"/>Process definition</h4></div></div></div><p>Things to be aware of are that we<a id="id896" class="indexterm"/> need to import the service WSDL definition. In the process definition import section, add the service WSDL location and namespace. The WSDL is passed to Apache CXF <code class="literal">JaxWsDynamicClientFactory</code>, which parses it when creating a dynamic web service client.</p><div class="mediaobject"><img src="graphics/9578OS_08_03.jpg" alt="Process definition"/></div></div><div class="section" title="Service task handler"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec25"/>Service task handler</h4></div></div></div><p>The service task handler invokes the web service automatically by setting its parameters appropriately; this speeds up the integration process but may fall short when developing against service interfaces with complex types since, as we have already pointed out, the handler leverages the Apache <a id="id897" class="indexterm"/>CXF Dynamic Clients pattern. In this case, you are strongly suggested to develop a custom handler integrating your web service framework of choice. We set the handler parameters as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Implementation</strong></span>: <code class="literal">WSDL</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>serviceInterface</strong></span>: <code class="literal">TestWebService</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>serviceOperation</strong></span>: <code class="literal">addSmallOrder (addLargeOrder)</code></li></ul></div><p>The <code class="literal">mode</code> parameter value is left to <code class="literal">SYNC</code> (default), which translates in a blocking operation; when the <code class="literal">ASYNC</code> mode is set, the handler is forced to perform the web service call on a thread, returning the control to the process engine, and the workitem is completed as soon as the remote call returns.</p></div><div class="section" title="The WebServiceWorkItemHandler class"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec26"/>The WebServiceWorkItemHandler class</h4></div></div></div><p>jBPM offers a web service-oriented<a id="id898" class="indexterm"/> alternative to the service task handler with the <code class="literal">WebServiceWorkItemHandler</code> class. This handler improves over the service task handler in terms of parameter array handling, web service endpoint setting (it accepts the <code class="literal">Endpoint</code> parameter), and shortcut WSDL location loading (the <code class="literal">Url</code> and <code class="literal">Namespace</code> parameters instead of <a id="id899" class="indexterm"/>having to define the WSDL URL at the process definition level). The <code class="literal">serviceInterface</code> and <code class="literal">serviceOperation</code> parameters are renamed <code class="literal">Interface</code> and <code class="literal">Operation</code>, respectively.</p></div></div></div></div>
<div class="section" title="jBPM as a remote service"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec52"/>jBPM as a remote service</h1></div></div></div><p>The jBPM platform is offering<a id="id900" class="indexterm"/> a number of ready-to-use remote APIs in an effort to provide developers with an improved level of flexibility when designing solutions that require out-of-the-box jBPM integration. This remote service layer opens up a number of possibilities for providing the stakeholders with a flexible, open architecture, in<a id="id901" class="indexterm"/> order to satisfy and to quickly react to changing application requirements, for instance:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A number of external application systems may require to occasionally connect to the jBPM runtime in order to check some task or retrieve some process information</li><li class="listitem" style="list-style-type: disc">The jBPM operations manager may be constrained to perform administration tasks by submitting a batch of commands via HTTP only</li></ul></div><p>jBPM ships with the<a id="id902" class="indexterm"/> following remote service interfaces:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>REST API</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>JMS API</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Java Remote API</strong></span>: This API provides the developer with local stubs of the <code class="literal">KieSession</code>, <code class="literal">TaskService</code>, and <code class="literal">AuditService</code> core engine services. These service stubs of the API methods are wrappers for lower-level REST or JMS API calls.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>SOAP API</strong></span>.</li></ul></div><p>All of these services are exposed by the jBPM KIE workbench, and as such, they are available only when the jbpm-console web application is deployed in a container.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note55"/>Note</h3><p>The source code for the<a id="id903" class="indexterm"/> remote services project is hosted at <a class="ulink" href="https://github.com/droolsjbpm/droolsjbpm-integration/tree/master/kie-remote">https://github.com/droolsjbpm/droolsjbpm-integration/tree/master/kie-remote</a>.</p></div></div><p>The required <a id="id904" class="indexterm"/>Maven dependency for the remote service client is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.kie.remote&lt;/groupId&gt;
  &lt;artifactId&gt;kie-remote-client&lt;/artifactId&gt;
  &lt;version&gt;6.2.0&lt;/version&gt;
&lt;/dependency&gt;</pre></div><p>Let us now review the main remote service functionalities and how you can access them.</p><div class="section" title="The REST API"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec135"/>The REST API</h2></div></div></div><p>This API provides functionalities<a id="id905" class="indexterm"/> in the following areas:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Runtime</strong></span>: (<code class="literal">/runtime/</code> path) provides the user with process instance creation, process instance querying, and workitem operations</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>History</strong></span>: (<code class="literal">/history/</code> path) provides with auditing data</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Task</strong></span>: (<code class="literal">/task/</code> path) provides task operation and task query methods</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Deployments</strong></span>: (<code class="literal">/deployments/</code> and <code class="literal">/deployment/</code> path) provides deployments management operations</li></ul></div><p>For additional details, please check the jBPM user manual reference (<span class="emphasis"><em>Chapter 17</em></span>, <span class="emphasis"><em>jBPM Process Definition Language (JPDL)</em></span>).</p><div class="section" title="Authentication"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec107"/>Authentication</h3></div></div></div><p>Upon invocation, the<a id="id906" class="indexterm"/> REST service operations check for the basic authentication user ID of your current HTTP session. For example, assume that you are performing REST operations in an unauthorized session by executing the following code from your command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>curl -v http://localhost:8080/jbpm-console/rest/deployment/com.packt.masterjbpm6:pizzadelivery:1.0</strong></span>
</pre></div><p>You will get an HTTP <code class="literal">401 Unauthorized</code> error (output edited for clarity; it may vary):</p><div class="informalexample"><pre class="programlisting">&lt; HTTP/1.1 401 Unauthorized
&lt; WWW-Authenticate: Basic realm="KIE Workbench Realm"
&lt;html&gt;&lt;head&gt;&lt;title&gt;Error&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Unauthorized&lt;/body&gt;&lt;/html&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note56"/>Note</h3><p>The Kie workbench default security mechanism leverages JAAS; the default configuration, for both jBoss WildFly and EAP, is stored in the application server XML configuration file (standalone and the like). See <a class="link" href="ch04.html" title="Chapter 4. Operation Management">Chapter 4</a>, <span class="emphasis"><em>Operation Management</em></span>, for user and role configurations.</p></div></div><p>Otherwise, set the<a id="id907" class="indexterm"/> user ID and password (Workbench Realm) as follows:</p><div class="informalexample"><pre class="programlisting">http://admin:admin@localhost:8080/jbpm-console/rest/deployment/com.packt.masterjbpm6:pizzadelivery:1.0</pre></div><p>This will return the following response:</p><div class="informalexample"><pre class="programlisting">&lt;deployment-unit&gt;
  &lt;groupId&gt;com.packt.masterjbpm6&lt;/groupId&gt;
  &lt;artifactId&gt;pizzadelivery&lt;/artifactId&gt;
  &lt;version&gt;1.0&lt;/version&gt;
  &lt;kbaseName/&gt;
  &lt;ksessionName/&gt;
  &lt;strategy&gt;SINGLETON&lt;/strategy&gt;
  &lt;status&gt;DEPLOYED&lt;/status&gt;
&lt;/deployment-unit&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note57"/>Note</h3><p>For a complete jBPM REST reference, please see the jBPM official documentation (<span class="emphasis"><em>Chapter 17</em></span>, <span class="emphasis"><em>Remote API</em></span>).</p></div></div></div></div><div class="section" title="The remote Java API"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec136"/>The remote Java API</h2></div></div></div><p>The remote<a id="id908" class="indexterm"/> Java API is a high-level API that uses REST or JMS to interact with the remote engine services in order to provide<a id="id909" class="indexterm"/> the user with familiar service API classes (<code class="literal">TaskService</code>, <code class="literal">KieSession</code>, and so on).</p><div class="section" title="Dependencies"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec108"/>Dependencies</h3></div></div></div><p>The API depends on the jBoss RESTEasy REST implementation and the HornetQ JMS client library. The<a id="id910" class="indexterm"/> Maven dependency required to interact with the Remote API is, as we have pointed out earlier, the <code class="literal">kie-remote-client</code> module and the additional <code class="literal">kie-remote-common</code> artifact. Be sure not to have dependencies to the Apache CXF framework, which may cause issues with the jBoss RESTEasy framework.</p></div><div class="section" title="The REST client"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec109"/>The REST client</h3></div></div></div><p>The initialization is done <a id="id911" class="indexterm"/>with a builder<a id="id912" class="indexterm"/> <span class="strong"><strong>fluent</strong></span> API obtained from <code class="literal">RemoteRuntimeEngineFactory</code>:</p><div class="informalexample"><pre class="programlisting">// the deploymentId identifies the KIE module
public static String deploymentId = "com.packt.masterjbpm6:pizzadelivery:1.0";
RemoteRestRuntimeEngineBuilder restEngineBuilder = RemoteRuntimeEngineFactory.newRestBuilder()
.addDeploymentId(deploymentId)
.addUrl(instanceurl).addUserName(user)
.addPassword(password);
RemoteRestRuntimeEngineFactory engineFactory = restEngineBuilder
.buildFactory();
// get the engine
RemoteRuntimeEngine engine = engineFactory.newRuntimeEngine();
// and the services
TaskService taskService = engine.getTaskService();
KieSession ksession = engine.getKieSession();
ProcessInstance processInstance = ksession.startProcess(processID);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note58"/>Note</h3><p>Please see the <code class="literal">jbpm-remote-server</code> Maven project and its <code class="literal">RestTest</code> jUnit class for a full working example.</p></div></div></div><div class="section" title="Client for jBPM JMS service"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec110"/>Client for jBPM JMS service</h3></div></div></div><p>When using the<a id="id913" class="indexterm"/> JMS Remote API client, we need to add a number of library dependencies, notably HornetQ and the jBoss remote client. We are going to see how to configure and run a remote client application, which creates a jBPM process instance.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note59"/>Note</h3><p>Please see the <code class="literal">jbpm-remote-server</code> Maven project and its <code class="literal">JmsTest</code> jUnit class for a full working example (WildFly 8.1 is required to be up-and-running).</p></div></div><div class="section" title="Server JMS configuration"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec27"/>Server JMS configuration</h4></div></div></div><p>WildFly comes with HornetQ as JMS MQ middleware; in order to have JMS to properly work, we need to check<a id="id914" class="indexterm"/> the jBPM JMS queues are registered with the JNDI service and that the user security settings are set. By default, HornetQ will use the "other" JAAS security domain, which is the one used by KIE Workbench Realm for authentication (recall the <code class="literal">user.properties</code> and <code class="literal">roles.properties</code> files). In addition, HornetQ defines authorization settings in the following element of the WildFly <code class="literal">standalone-full.xml</code> configuration file (under the messaging subsystem):</p><div class="informalexample"><pre class="programlisting">  &lt;security-settings&gt;
    &lt;security-setting match="#"&gt;
      &lt;permission type="send" roles="admin guest"/&gt;
      &lt;permission type="consume" roles="admin guest"/&gt;
      &lt;permission type="createNonDurableQueue" roles="admin guest"/&gt;
      &lt;permission type="deleteNonDurableQueue" roles="admin guest"/&gt;
    &lt;/security-setting&gt;
  &lt;/security-settings&gt;</pre></div><p>Here, we just add the KIE console <code class="literal">admin</code> role (along the default <code class="literal">guest</code> role); the <code class="literal">admin</code> role is already configured for JAAS.</p><p>Now, to check whether our JMS user is properly configured, open the jBoss management console (<code class="literal">http://localhost:9990/console</code>) and select <span class="strong"><strong>Configuration/Subsystems/Messaging/Destinations</strong></span> and select <span class="strong"><strong>Default Provider</strong></span> and <span class="strong"><strong>Security Settings</strong></span> on the top navigation bar; you shall view the defined users.</p><div class="mediaobject"><img src="graphics/9578OS_08_05.jpg" alt="Server JMS configuration"/></div><p>The WildFly jBPM <a id="id915" class="indexterm"/>JMS queue configuration is defined in the <code class="literal">jbpm-console.war\WEB-INF\bpms-jms.xml</code> file; the remotely accessible queues are registered in the <code class="literal">java:jboss/exported</code> JNDI namespace.</p><p>To check whether the jBPM JMS queues are correctly bound to JNDI, open the jBoss management console (<code class="literal">http://localhost:9990/console</code>) and select <span class="strong"><strong>Runtime/Status/Subsystems/JNDI View</strong></span>; here, you shall view the <span class="strong"><strong>KIE.AUDIT</strong></span>, <span class="strong"><strong>KIE.SESSION</strong></span>, <span class="strong"><strong>KIE.RESPONSE</strong></span>, and <span class="strong"><strong>KIE.TASK</strong></span> queues. Here, you should also have <code class="literal">RemoteConnectionFactory</code> listed; this factory allows for remote connection to the jBoss JNDI namespaces (we are going to see this in a moment).</p><div class="mediaobject"><img src="graphics/9578OS_08_02.jpg" alt="Server JMS configuration"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note60"/>Note</h3><p>For the WildFly messaging<a id="id916" class="indexterm"/> security<a id="id917" class="indexterm"/> configuration, please refer to <a class="ulink" href="https://docs.jboss.org/author/display/WFLY8/Messaging+configuration">https://docs.jboss.org/author/display/WFLY8/Messaging+configuration</a>. For the official HornetQ reference, please see<a id="id918" class="indexterm"/> the latest documentation at <a class="ulink" href="http://docs.jboss.org/hornetq/2.4.0.Final/docs/user-manual/html">http://docs.jboss.org/hornetq/2.4.0.Final/docs/user-manual/html</a>.</p></div></div></div><div class="section" title="JMS client implementation"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec28"/>JMS client implementation</h4></div></div></div><p>To set up a remote JMS<a id="id919" class="indexterm"/> client connection, we use the same approach that we used for the REST client; we configure a specialized builder, provided by the good old <code class="literal">RemoteRuntimeEngineFactory</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note61"/>Note</h3><p>Please see the <code class="literal">jbpm-remote-server</code> Maven project and its <code class="literal">JmsTest</code> jUnit class for the full working example.</p></div></div><div class="informalexample"><pre class="programlisting">// the deploymentId identifies the KIE module
public static String deploymentId = "com.packt.masterjbpm6:pizzadelivery:1.0";
/* the remoteInitialContext is an instance of the jBoss Naming
 service (InitialContext) and gives you access to the container
 remoting services for JMS */
/* the connectionfactory represents the JMS connection configuration settings */

RemoteJmsRuntimeEngineBuilder jmsEngineBuilder = RemoteRuntimeEngineFactory
  .newJmsBuilder().addDeploymentId(deploymentId)
  .addRemoteInitialContext(remoteInitialContext)
  .addUserName(jms_user).addPassword(jms_password)
  .addConnectionFactory(connectionfactory)
  .addTimeout(maxTimeoutSecs);</pre></div><p>We get the factory from the builder and the engine from the factory:</p><div class="informalexample"><pre class="programlisting">RemoteJmsRuntimeEngineFactory engineFactory = jmsEngineBuilder
  .buildFactory();
RuntimeEngine engine = remoteJmsFactory.newRuntimeEngine();</pre></div><p>Then, we get the service classes from the engine:</p><div class="informalexample"><pre class="programlisting">TaskService taskService = engine.getTaskService();</pre></div><p>In order to make<a id="id920" class="indexterm"/> the jBPM remote client resolve the remote jBPM queues, we need to configure the jBoss JNDI provider URL as follows:</p><div class="informalexample"><pre class="programlisting">initialProps.setProperty(InitialContext.PROVIDER_URL,
"http-remoting://" + jbossServerHostName + ":8080");</pre></div><p>WildFly utilizes an HTTP upgrade and features port multiplexing for nearly all of its protocols. The jBoss remote JNDI historically listened on port 4447, but is now, on port 8080.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note62"/>Note</h3><p>For a complete WildFly reference, please<a id="id921" class="indexterm"/> see <a class="ulink" href="https://docs.jboss.org/author/display/WFLY8/Documentation">https://docs.jboss.org/author/display/WFLY8/Documentation</a>.</p></div></div></div></div></div><div class="section" title="The SOAP API"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec137"/>The SOAP API</h2></div></div></div><p>The jBPM workbench features<a id="id922" class="indexterm"/> additional interoperability by exposing a SOAP service as described by the <code class="literal">/jbpm-console/CommandService?WSDL</code> endpoint; the service implements a single <code class="literal">execute</code> operation. At the time of writing this book, the WSDL available for the jBPM 6.2.0 release could not be used to generate the client classes because of some typos in WSDL.</p><p>The client Maven dependency is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.kie.remote.ws&lt;/groupId&gt;
  &lt;artifactId&gt;kie-remote-ws-common&lt;/artifactId&gt;
  &lt;version&gt;6.2.0.Final&lt;/version&gt;
&lt;/dependency&gt;</pre></div><p>For the sake of completeness, we will now describe how to call into jBPM by using its SOAP API. Our <code class="literal">jbpm-remote-server</code> test project, the <code class="literal">SOAPTest</code> jUnit test class, creates a web service client and then, starts a new process instance.</p><p>First, we get the WSDL resource from the endpoint URL as follows:</p><div class="informalexample"><pre class="programlisting">URL commandWsdlUrl = new URL(
"http://localhost:8080/jbpm-console/CommandService?WSDL");</pre></div><p>The <code class="literal">execute</code> command operation accepts the <code class="literal">JaxbCommandsRequest</code> command, which is a DTO (serializable) wrapper for plain jBPM command classes (see <a class="link" href="ch06.html" title="Chapter 6. Core Architecture">Chapter 6</a>, <span class="emphasis"><em>Core Architecture</em></span>). All jBPM command classes are also JAXB-annotated classes.</p><div class="informalexample"><pre class="programlisting">StartProcessCommand startProcessCommand = new StartProcessCommand();
startProcessCommand.setProcessId(processID);
JaxbCommandsRequest request = new JaxbCommandsRequest(deploymentId, startProcessCommand);</pre></div><p>
<code class="literal">JaxbCommandsRequest</code> can also<a id="id923" class="indexterm"/> accept a batch of commands unlike REST or the JMS remote API.</p></div><div class="section" title="Transactions"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec138"/>Transactions</h2></div></div></div><p>When calling into jBPM by using REST, SOAP, or the remote Java API, you are in control of your transaction<a id="id924" class="indexterm"/> management. If the jBPM call is supposed to be part of a transaction and this call fails or throws an exception, you must handle it and perform rollback operations or compensate the business logic on your side.</p><p>All the remote API methods throw a <code class="literal">RemoteApiException</code> exception to indicate that the remote call (either REST or JMS) has failed.</p><p>The SOAP API <code class="literal">execute</code> operations throws <code class="literal">CommandWebServiceException</code>. If you need a tight integration and transaction propagation mechanism, you should consider moving to an EJB layer wrapping the full-fledged jBPM services (see the <span class="emphasis"><em>Integrating with JEE</em></span> section at the start of this chapter).</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec53"/>Summary</h1></div></div></div><p>In this chapter, we expanded on the jBPM features targeted at enterprise architecture integration. We discussed the core services exposed by jBPM and how they can be accessed by using different technologies such as JEE, SOAP, REST, and JMS.</p><p>In the next chapter, we will focus on details that have to be taken care of while deploying jBPM to production.</p></div></body></html>