<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Running Batch Jobs"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Running Batch Jobs</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing and configuring Spring Batch</li><li class="listitem" style="list-style-type: disc">Creating a job</li><li class="listitem" style="list-style-type: disc">Executing a job from the command line</li><li class="listitem" style="list-style-type: disc">Executing a job from a controller method</li><li class="listitem" style="list-style-type: disc">Using job parameters</li><li class="listitem" style="list-style-type: disc">Executing a system command</li><li class="listitem" style="list-style-type: disc">Scheduling a job</li><li class="listitem" style="list-style-type: disc">Creating a read/process/write step</li><li class="listitem" style="list-style-type: disc">Reading an XML file</li><li class="listitem" style="list-style-type: disc">Generating a CSV file</li><li class="listitem" style="list-style-type: disc">Reading from a database</li><li class="listitem" style="list-style-type: disc">Unit testing batch jobs</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec76"/>Introduction</h1></div></div></div><p>A <span class="strong"><strong>batch job</strong></span> is a <a id="id367" class="indexterm"/>task executed outside the normal web application workflow (receiving an HTTP request and sending back an HTTP response). It can be executed by the web server as a separate process. It can also be launched directly from the command line.</p><p>Typically, a batch job either:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Imports or exports data at a scheduled time. For example, importing a CSV file in the database every night.</li><li class="listitem" style="list-style-type: disc">Executes some code asynchronously to avoid long page loads. For example, processing a video <a id="id368" class="indexterm"/>uploaded by the user or generating a big file that will be downloaded by the user.</li></ul></div><p>Spring Batch provides a structure to define, run, and monitor batch jobs. A <span class="strong"><strong>Job</strong></span> is defined as a sequence of steps:</p><div class="mediaobject"><img src="graphics/5807OS_08_01.jpg" alt="Introduction"/></div><p>A <span class="strong"><strong>Job Instance</strong></span> is the <a id="id369" class="indexterm"/>combination of a <span class="strong"><strong>job</strong></span> and some <span class="strong"><strong>parameters</strong></span>. For example, the day's date and the name of the file to process. A <span class="strong"><strong>Job Execution</strong></span> is created for <a id="id370" class="indexterm"/>a job instance. If the job execution fails, another job execution can be created for the same job instance.</p><div class="mediaobject"><img src="graphics/5807OS_08_02.jpg" alt="Introduction"/></div><p>A <span class="strong"><strong>Job Execution</strong></span> generates a <a id="id371" class="indexterm"/>
<span class="strong"><strong>Step Execution</strong></span> for each step of the job. If a step execution fails, another step execution can be created for that same step:</p><div class="mediaobject"><img src="graphics/5807OS_08_03.jpg" alt="Introduction"/></div></div></div>
<div class="section" title="Installing and configuring Spring Batch"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec77"/>Installing and configuring Spring Batch</h1></div></div></div><p>Spring <a id="id372" class="indexterm"/>automatically saves some metadata (start time, end time, and <a id="id373" class="indexterm"/>status) about jobs and their steps in a job repository, which consists of several database tables. In this recipe, we'll create these tables. We will also create a Spring configuration class dedicated to batch jobs.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec171"/>How to do it…</h2></div></div></div><p>Here are the steps to install and configure Spring Batch:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependencies for Spring Batch in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.batch&lt;/groupId&gt;
    &lt;artifactId&gt;spring-batch-core&lt;/artifactId&gt;
    &lt;version&gt;3.0.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.batch&lt;/groupId&gt;
    &lt;artifactId&gt;spring-batch-infrastructure&lt;/artifactId&gt;
    &lt;version&gt;3.0.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">Add the <a id="id374" class="indexterm"/>Maven dependencies for Spring JDBC and Spring Transaction in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework&lt;/groupId&gt;
  &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;
  &lt;version&gt;4.1.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-tx&lt;/artifactId&gt;
    &lt;version&gt;4.1.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">Add the <a id="id375" class="indexterm"/>Maven dependency for your database in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;mysql&lt;/groupId&gt;
  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;version&gt;5.1.34&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">In the database, create the tables for Spring Batch's job repository. The SQL code can be found inside the spring-batch-core dependency in the <code class="literal">org.springframework.batch.core</code> package. It's also available online at <a class="ulink" href="https://github.com/spring-projects/spring-batch/tree/master/spring-batch-core/src/main/resources/org/springframework/batch/core">https://github.com/spring-projects/spring-batch/tree/master/spring-batch-core/src/main/resources/org/springframework/batch/core</a>.</li><li class="listitem">Create a Java <a id="id376" class="indexterm"/>package for your Spring Batch classes. For example, <code class="literal">com.spring_cookbook.batch</code>.</li><li class="listitem">Create a Spring configuration class for Spring Batch with the <code class="literal">@EnableBatchProcessing</code> annotation:<div class="informalexample"><pre class="programlisting">@Configuration
@EnableBatchProcessing
public class BatchConfig {
...
}</pre></div></li><li class="listitem">Add a <code class="literal">DataSource</code> <a id="id377" class="indexterm"/>bean with the database connection <a id="id378" class="indexterm"/>details to the configuration class:<div class="informalexample"><pre class="programlisting">@Bean
public DataSource dataSource() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        
dataSource.setDriverClassName("com.mysql.jdbc.Driver");
dataSource.setUrl("jdbc:mysql://localhost:3306/db1");
        dataSource.setUsername("root");
        dataSource.setPassword("123");
                     
        return dataSource;
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec172"/>How it works…</h2></div></div></div><p>In the configuration class, the <code class="literal">@EnableBatchProcessing</code> annotation enables Spring Batch and provides reasonable defaults for batch jobs, which can be overridden if necessary (the default <code class="literal">JobLauncher</code> object, the default <code class="literal">TransactionManager</code> object, and so on).</p></div></div>
<div class="section" title="Creating a job"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec78"/>Creating a job</h1></div></div></div><p>We'll create a <a id="id379" class="indexterm"/>job that will simply execute some Java code. It will be a job with only one step. The step will be a <code class="literal">Tasklet</code> object (a single task, as opposed to a read-process-write step, which we'll cover later). We will execute this job in two different ways in the next two recipes.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec173"/>How to do it…</h2></div></div></div><p>Create a <code class="literal">Tasklet</code> class, which you will use to define a step and the job:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">Task1</code> class implementing <code class="literal">Tasklet</code>:<div class="informalexample"><pre class="programlisting">public class Task1 implements Tasklet {    

}</pre></div></li><li class="listitem">In the <code class="literal">Task1</code> class, add an <code class="literal">execute()</code> method with the code to be executed for the job:<div class="informalexample"><pre class="programlisting">public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext)
        throws Exception {
    System.out.println("Starting job..");

    // ... your code
    
    System.out.println("Job done..");
    return RepeatStatus.FINISHED;
}</pre></div></li><li class="listitem">In the <a id="id380" class="indexterm"/>configuration class, add an autowired <code class="literal">JobBuilderFactory</code> attribute and an autowired <code class="literal">StepBuilderFactory</code> attribute:<div class="informalexample"><pre class="programlisting">@Autowired
private JobBuilderFactory jobs;

@Autowired
private StepBuilderFactory steps;</pre></div></li><li class="listitem">Define the <code class="literal">step1</code> bean, which will execute our code, from the <code class="literal">Task1</code> class:<div class="informalexample"><pre class="programlisting">@Bean
public Step step1(){
    return steps.get("step1")
            .tasklet(new Task1())
            .build();
}   </pre></div></li><li class="listitem">Define the <code class="literal">job1</code> bean that will execute <code class="literal">step1</code>:<div class="informalexample"><pre class="programlisting">@Bean
public Job job1(){
    return jobs.get("job1")
            .start(step1())
            .build();
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec174"/>How it works…</h2></div></div></div><p>We defined a <code class="literal">job1</code> job <a id="id381" class="indexterm"/>executing the <code class="literal">step1</code> step, which will call the <code class="literal">execute()</code> method in the <code class="literal">Task1</code> class.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec175"/>There's more…</h2></div></div></div><p>To execute more than one step, use the <code class="literal">next()</code> method in the job definition:</p><div class="informalexample"><pre class="programlisting">@Bean
public Job job1(){
    return jobs.get("job1")
            .start(step1())
<span class="strong"><strong>            .next(step2())</strong></span>
            .build();
}</pre></div></div></div>
<div class="section" title="Executing a job from the command line"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec79"/>Executing a job from the command line</h1></div></div></div><p>A simple <a id="id382" class="indexterm"/>and robust way to execute a job is to use the <a id="id383" class="indexterm"/>command-line interface. This allows you to use a standard <code class="literal">cron</code> job (use the <code class="literal">AT</code> command on Windows) to schedule it, so that the job will be executed even if the web application is down. It's also convenient for testing and debugging a job.</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec176"/>Getting Ready</h2></div></div></div><p>We'll use the job defined in the <span class="emphasis"><em>Creating a job</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec177"/>How to do it…</h2></div></div></div><p>Follow these steps to execute the job from the command line:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Declare the <code class="literal">maven-assembly-plugin</code> in <code class="literal">pom.xml</code> (under <code class="literal">build</code>/<code class="literal">plugins</code>):<div class="informalexample"><pre class="programlisting">    &lt;plugin&gt;
        &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
            &lt;archive&gt;
                &lt;manifest&gt;
                    &lt;mainClass&gt;
                        org.springframework.batch.core.launch.support. CommandLineJobRunner
                    &lt;/mainClass&gt;
                &lt;/manifest&gt;
            &lt;/archive&gt;
            &lt;descriptorRefs&gt;
                &lt;descriptorRef&gt; jar-with-dependencies&lt;/descriptorRef&gt;
            &lt;/descriptorRefs&gt;
        &lt;/configuration&gt;
    &lt;/plugin&gt;</pre></div></li><li class="listitem">Generate a JAR file:<div class="informalexample"><pre class="programlisting">mvn clean compile assembly:single</pre></div></li><li class="listitem">Execute the job by running the JAR file generated in the <code class="literal">target</code> folder, with the class where the job is defined (<code class="literal">BatchConfig</code>) and the job name (<code class="literal">job1</code>) as arguments:<div class="informalexample"><pre class="programlisting">java -jar target/springwebapp-jar-with-dependencies.jar com.spring_cookbook.batch.BatchConfig job1</pre></div></li><li class="listitem">The console output should look like this:<div class="informalexample"><pre class="programlisting">...
INFO: Job: [SimpleJob: [name=job1]] launched with the following parameters: [{}]
...
INFO: Executing step: [step1]
Starting job..
Job done..
...
INFO: Job: [SimpleJob: [name=job1]] completed with the following parameters: [{}] and the following status: [COMPLETED]
...</pre></div></li></ol></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec178"/>There's more…</h2></div></div></div><p>A job can be executed <a id="id384" class="indexterm"/>only once for a given set of parameters. To be able to execute the job again, just add a parameter using the <code class="literal">parameterName=parameterValue</code> syntax:</p><div class="informalexample"><pre class="programlisting">java -jar target/springwebapp-jar-with-dependencies.jar com.spring_cookbook.batch.BatchConfig job1 p=1
java -jar target/springwebapp-jar-with-dependencies.jar com.spring_cookbook.batch.BatchConfig job1 p=2
java -jar target/springwebapp-jar-with-dependencies.jar com.spring_cookbook.batch.BatchConfig job1 p=3</pre></div><p>In this case, the <a id="id385" class="indexterm"/>console output will look like this:</p><div class="informalexample"><pre class="programlisting">...
INFO: Job: [SimpleJob: [name=job1]] launched with the following parameters: [{p=3}]
...</pre></div><p>When testing and debugging the job, you can use a Unix timestamp to automatically get a different parameter value each time:</p><div class="informalexample"><pre class="programlisting">java -jar target/springwebapp-jar-with-dependencies.jar com.spring_cookbook.batch.BatchConfig job1 p=`date +'%s'`</pre></div><p>A job can be also <a id="id386" class="indexterm"/>be executed directly without <a id="id387" class="indexterm"/>having to generate a JAR file first:</p><div class="informalexample"><pre class="programlisting">mvn compile exec:java - Dexec.mainClass=org.springframework.batch.core.launch.support. CommandLineJobRunner - Dexec.args="com.spring_cookbook.batch.BatchConfig job1 p=4"</pre></div></div></div>
<div class="section" title="Executing a job from a controller method"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec80"/>Executing a job from a controller method</h1></div></div></div><p>It's <a id="id388" class="indexterm"/>convenient to launch a job from a controller <a id="id389" class="indexterm"/>method when that job is triggered by a user action. For example, launching a job to process a video just uploaded by the user.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec179"/>Getting ready</h2></div></div></div><p>We'll use the job defined in the <span class="emphasis"><em>Creating a job</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec180"/>How to do it…</h2></div></div></div><p>Follow these steps to execute the job from a controller method:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Spring Batch configuration class to the <code class="literal">getServletConfigClasses()</code>method in your class extending <code class="literal">AbstractAnnotationConfigDispatcherServletInitializer</code>:<div class="informalexample"><pre class="programlisting">public class ServletInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {

@Override
protected Class&lt;?&gt;[] getServletConfigClasses() {
    return new Class&lt;?&gt;[]{AppConfig.class, BatchConfig.class};
}</pre></div></li><li class="listitem">In your controller class, add a <code class="literal">JobLauncher</code> attribute and <code class="literal">Job</code> attribute both autowired:<div class="informalexample"><pre class="programlisting">@Autowired
JobLauncher jobLauncher;

@Autowired
Job job;</pre></div></li><li class="listitem">In the <a id="id390" class="indexterm"/>controller method, define the job parameters and launch the job:<div class="informalexample"><pre class="programlisting">try {
  JobParametersBuilder jobParametersBuilder = new JobParametersBuilder();
  jobParametersBuilder.addDate("d", new Date());
        
  jobLauncher.run(job, jobParametersBuilder.toJobParameters());
} catch (Exception e) {
  ...
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec181"/>How it works…</h2></div></div></div><p>We declared <code class="literal">BatchConfig</code> in the <code class="literal">ServletInitializer</code> class to make our Spring Batch configuration <a id="id391" class="indexterm"/>available to the controller methods.</p><p>In the controller method, the job parameters are the same as those in the command line.</p></div></div>
<div class="section" title="Using job parameters"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec81"/>Using job parameters</h1></div></div></div><p>In this recipe, you'll <a id="id392" class="indexterm"/>learn how to retrieve and use a job parameter value in <code class="literal">Tasklet</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec182"/>Getting ready</h2></div></div></div><p>We'll use the job defined in the <span class="emphasis"><em>Creating a job</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec183"/>How to do it…</h2></div></div></div><p>Follow these steps to use the job parameters:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">Task1</code> class, add <code class="literal">@StepScope</code> to the <code class="literal">execute()</code> method:<div class="informalexample"><pre class="programlisting">@StepScope
public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext)
        throws Exception {
...</pre></div></li><li class="listitem">In the <code class="literal">execute()</code> method, retrieve a job parameter value by using the job parameter name:<div class="informalexample"><pre class="programlisting">String test = (String)chunkContext.getStepContext().getJobParameters(). get("test")</pre></div></li><li class="listitem">Run the job with a parameter named <code class="literal">test</code>:<div class="informalexample"><pre class="programlisting">mvn compile exec:java - Dexec.mainClass=org.springframework.batch.core.launch. support.CommandLineJobRunner - Dexec.args="com.spring_cookbook.batch.BatchConfig job1 <span class="strong"><strong>test=hello</strong></span>"</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec184"/>How it works…</h2></div></div></div><p>The <code class="literal">String</code> test will <a id="id393" class="indexterm"/>contain the <code class="literal">hello</code> parameter value passed on the command line. This recipe will also work if the job is launched from a controller method.</p></div></div>
<div class="section" title="Executing a system command"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec82"/>Executing a system command</h1></div></div></div><p>A step can <a id="id394" class="indexterm"/>consist of just an execution of a system command. Spring Batch provides a convenient class for this, <code class="literal">SystemCommandTasklet</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec185"/>Getting ready</h2></div></div></div><p>We'll use the job defined in the <span class="emphasis"><em>Creating a job</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec186"/>How to do it…</h2></div></div></div><p>In Spring Batch's configuration file, add a <code class="literal">SystemCommandTasklet</code> bean. Declare the system command to be executed (here, we used the touch Unix command to create an empty file), the directory to execute it from, and the maximum time allowed for its execution:</p><div class="informalexample"><pre class="programlisting">@Bean
public SystemCommandTasklet task1() {
  SystemCommandTasklet tasklet = new SystemCommandTasklet();

  tasklet.<span class="strong"><strong>setCommand</strong></span>("touch test.txt");
  tasklet.<span class="strong"><strong>setWorkingDirectory</strong></span>("/home/merlin");
  tasklet.<span class="strong"><strong>setTimeout</strong></span>(5000);

  return tasklet;
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec187"/>How it works…</h2></div></div></div><p>The <code class="literal">SystemCommandTasklet</code> class will execute a command from the working directory <a id="id395" class="indexterm"/>and kill the process if it exceeds the timeout value.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec188"/>There's more…</h2></div></div></div><p>For a more advanced use of system commands (for example, to get the output of the system command) extend <code class="literal">SystemCommandTasklet</code> and override its <code class="literal">execute()</code> method.</p></div></div>
<div class="section" title="Scheduling a job"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec83"/>Scheduling a job</h1></div></div></div><p>Some jobs need to <a id="id396" class="indexterm"/>be executed regularly-every night, every hour, and so on. Spring makes this easy with the <code class="literal">@Scheduled</code> annotation.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec189"/>Getting ready</h2></div></div></div><p>We will use the job defined in the <span class="emphasis"><em>Creating a job</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec190"/>How to do it…</h2></div></div></div><p>Follow these steps to schedule the job:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If it's not done already, add the Spring Batch configuration class to the <code class="literal">getServletConfigClasses()</code>method in your class extending <code class="literal">AbstractAnnotationConfigDispatcherServletInitializer</code>:<div class="informalexample"><pre class="programlisting">public class ServletInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {

@Override
protected Class&lt;?&gt;[] getServletConfigClasses() {
    return new Class&lt;?&gt;[]{AppConfig.class, BatchConfig.class};
}</pre></div></li><li class="listitem">Add the <code class="literal">@EnableScheduling</code> annotation to the Spring Batch configuration class:<div class="informalexample"><pre class="programlisting">@Configuration
@EnableBatchProcessing
@EnableScheduling
public class BatchConfig {
...</pre></div></li><li class="listitem">Add an autowired <code class="literal">JobLauncher</code> field:<div class="informalexample"><pre class="programlisting">@Autowired
JobLauncher jobLauncher;</pre></div></li><li class="listitem">Add a method annotated with <code class="literal">@Scheduled</code> with a <code class="literal">fixedDelay</code> attribute in ms:<div class="informalexample"><pre class="programlisting">@Scheduled(fixedDelay=10000)
public void runJob1() throws Exception {
...
}</pre></div></li><li class="listitem">In that <a id="id397" class="indexterm"/>method, run the job:<div class="informalexample"><pre class="programlisting">JobParametersBuilder jobParametersBuilder = new JobParametersBuilder();
jobParametersBuilder.addDate("d", new Date());      
jobLauncher.run(job1(), jobParametersBuilder.toJobParameters());</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec191"/>How it works…</h2></div></div></div><p>The job will start getting executed again and again with a 10-second (10000 ms) interval as soon as the web application is deployed. The <code class="literal">job</code> parameter with the <code class="literal">new Date()</code>value is used to set a different parameter value for each launch.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec192"/>There's more…</h2></div></div></div><p>The <code class="literal">fixedDelay</code> attribute sets a delay of 10 seconds after a job has finished its execution before launching the next one. To actually run a job every 10 seconds, use <code class="literal">fixedRate</code>:</p><div class="informalexample"><pre class="programlisting">@Scheduled(fixedRate=10000)
public void runJob1() throws Exception {
...
}</pre></div><p>It's also possible to use <a id="id398" class="indexterm"/>a regular <code class="literal">cron</code> expression:</p><div class="informalexample"><pre class="programlisting">@Scheduled(cron="*/5 * * * *")
public void runJob1() throws Exception {
...
}</pre></div></div></div>
<div class="section" title="Creating a read/process/write step"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec84"/>Creating a read/process/write step</h1></div></div></div><p>A read/process/write step is a common type of step where some data is read somewhere, processed in some <a id="id399" class="indexterm"/>way, and finally, saved somewhere else. In this recipe, we'll read a CSV file of users, increment their age, and save the modified users in a database as shown in the following image:</p><div class="mediaobject"><img src="graphics/5807OS_08_04.jpg" alt="Creating a read/process/write step"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec193"/>Getting ready</h2></div></div></div><p>This is our CSV file of users, <code class="literal">input_data.txt</code>:</p><div class="informalexample"><pre class="programlisting">Merlin, 333
Arthur, 37
Lancelot, 35
Tristan, 20
Iseult, 22
Mark, 56</pre></div><p>For each line of the <a id="id400" class="indexterm"/>CSV file, we'll create a <code class="literal">User</code> object. So, make sure that the <code class="literal">User</code> class exists:</p><div class="informalexample"><pre class="programlisting">public class User {
  private String firstName;
  private int age;
…
}</pre></div><p>Each <code class="literal">User</code> object will be saved in the database. Make sure that the <code class="literal">user</code> table exists:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE user  (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
  first_name TEXT,
  age INT
);</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec194"/>How to do it…</h2></div></div></div><p>Follow these steps to process the CSV file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the Spring Batch configuration class, add a method returning a <code class="literal">LineMapper</code> object, which generates an <code class="literal">User</code> object from a line in the CSV file:<div class="informalexample"><pre class="programlisting">private LineMapper&lt;User&gt; lineMapper() {
  DefaultLineMapper&lt;User&gt; lineMapper = new DefaultLineMapper&lt;User&gt;();
    
  DelimitedLineTokenizer lineTokenizer = new DelimitedLineTokenizer();
    lineTokenizer.setNames(new String[]{"firstName","age"});
    lineTokenizer.setIncludedFields(new int[]{0,1});
    lineMapper.setLineTokenizer(lineTokenizer);
    
    BeanWrapperFieldSetMapper&lt;User&gt; fieldSetMapper = new BeanWrapperFieldSetMapper&lt;User&gt;();
    fieldSetMapper.setTargetType(User.class);
    lineMapper.setFieldSetMapper(fieldSetMapper);
    
    return lineMapper;
}</pre></div></li><li class="listitem">Add a <code class="literal">reader()</code> method returning a <code class="literal">FlatFileItemReader</code> object, which will read a CSV file (whose path is the file path of the CSV file), and use the previously defined <code class="literal">LineMapper</code> object to generate users:<div class="informalexample"><pre class="programlisting">@Bean
@StepScope
public FlatFileItemReader&lt;User&gt; reader(@Value("#{jobParameters[<span class="strong"><strong>file</strong></span>]}") String csvFilePath) {
    FlatFileItemReader&lt;User&gt; reader = new FlatFileItemReader&lt;User&gt;();
    reader.setLineMapper(<span class="strong"><strong>lineMapper()</strong></span>);
    reader.setResource(new PathResource(csvFilePath));
    
    reader.setLinesToSkip(1);
    reader.setEncoding("utf-8");
    
    return reader;
}</pre></div></li><li class="listitem">Define a class <a id="id401" class="indexterm"/>implementing <code class="literal">ItemProcessor</code> with a <code class="literal">process()</code> method that takes a <code class="literal">User</code> object, increments its <code class="literal">age</code>, and returns the modified <code class="literal">User</code> object:<div class="informalexample"><pre class="programlisting">public class UserProcessorIncrementAge implements ItemProcessor&lt;User, User&gt; {
     
    public User process(User user) throws Exception {
        int age = user.getAge();
        age++;
        user.setAge(age);
        return user;
    }
 
}</pre></div></li><li class="listitem">Back in the Batch configuration class, define a <code class="literal">UserProcessorIncrementAge</code> bean:<div class="informalexample"><pre class="programlisting">@Bean
private ItemProcessor&lt;User,User&gt; processor() {
    return new UserProcessorIncrementAge();
}</pre></div></li><li class="listitem">Define a <code class="literal">Datasource</code> bean with the database connection details:<div class="informalexample"><pre class="programlisting">@Bean
public DataSource dataSource() {
  DriverManagerDataSource dataSource = new DriverManagerDataSource();

  dataSource.setDriverClassName("com.mysql.jdbc.Driver");
  dataSource.setUrl("jdbc:mysql://localhost:3306/db1");
  dataSource.setUsername("root");
  dataSource.setPassword("123");

  return dataSource;
}</pre></div></li><li class="listitem">Add a <a id="id402" class="indexterm"/><code class="literal">writer()</code> bean that will take a <code class="literal">User</code> object and save it in the database:<div class="informalexample"><pre class="programlisting">@Bean
public JdbcBatchItemWriter&lt;User&gt; writer(){
    JdbcBatchItemWriter&lt;User&gt; writer = new JdbcBatchItemWriter&lt;User&gt;();
    writer.setDataSource(dataSource());
    writer.setSql("INSERT INTO user (first_name, age) " +
        "VALUES ( :firstName, :age)");
    ItemSqlParameterSourceProvider&lt;User&gt; paramProvider = new BeanPropertyItemSqlParameterSourceProvider&lt;User&gt;();
    writer.setItemSqlParameterSourceProvider(paramProvider);
    return writer;
}</pre></div></li><li class="listitem">Add a <code class="literal">JobBuilderFactory</code> field and a <code class="literal">StepBuilderFactory</code> field, both autowired:<div class="informalexample"><pre class="programlisting">@Autowired
private JobBuilderFactory jobs;

@Autowired
private StepBuilderFactory steps;</pre></div></li><li class="listitem">Define a step calling our <code class="literal">reader()</code>, <code class="literal">processor()</code>, and <code class="literal">writer()</code> methods:<div class="informalexample"><pre class="programlisting">@Bean
public Step step1(){
    return steps.get("step")
            .&lt;User,User&gt;chunk(1)
            .reader(reader(null))
            .processor(processor())
            .writer(writer())
            .build();
}</pre></div></li><li class="listitem">Define a job with the previous defined step:<div class="informalexample"><pre class="programlisting">@Bean
public Job job1(){
    return jobs.get("job1")
            .start(step1())
            .build();
}</pre></div></li><li class="listitem">Execute the job with the path to the CSV file as parameter:<div class="informalexample"><pre class="programlisting">mvn compile exec:java - Dexec.mainClass=org.springframework.batch.core.launch. support.CommandLineJobRunner - Dexec.args="com.spring_cookbook.batch.BatchConfig job1 <span class="strong"><strong>file=input_data.txt</strong></span>"</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec195"/>How it works…</h2></div></div></div><p>In the <code class="literal">reader()</code> method, we used <code class="literal">FlatFileItemReader</code>, which is a class provided by Spring Batch for reading CSV files. Each line is processed by <code class="literal">LineMapper</code>, which takes a line and returns an object. In this recipe, we used <code class="literal">DefaultLineMapper</code>, which converts a line to <code class="literal">Fieldset</code> (using <code class="literal">DelimitedLineTokenizer</code>) and then saves each field in an object (all of this is done behind the scenes by <code class="literal">BeanWrapperFieldSetMapper</code>).</p><p>In the <code class="literal">writer()</code> method, we supplied the SQL query, which will create the user in the database. The values come automatically from the <code class="literal">User</code> object, thanks to the <code class="literal">BeanPropertyItemSqlParameterSourceProvider</code> class. For example, <code class="literal">:firstName</code> will get its value from the <code class="literal">User</code> object's <code class="literal">firstName</code> field.</p><p>In the <code class="literal">step1()</code> method, we declared the reader, processor, and writer methods. The <code class="literal">chunk()</code> method allows the data to be processed and saved by groups (in chunks). This is more efficient for large sets of data.</p><p>The <code class="literal">@StepScope</code> annotation is necessary for the <code class="literal">reader()</code> and <code class="literal">writer()</code> methods, to allow them to access the job parameters. Otherwise, they are executed too early in the job initialization process.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec196"/>There's more…</h2></div></div></div><p>The reader-processor-writer separation makes it easy to swap one component with another. For example, if our CSV file becomes an XML file one day, we will only have to update the <code class="literal">reader()</code> method. In the next recipes, we will cover other types of readers and writers.</p><p>A processor is not required in a read/process/write job, so skip it if you don't need it. It also doesn't need to return an object from the same class. For example, it could take a <code class="literal">UserCSV</code> object, which would be a direct mapping of a line of the CSV file and return an actual <code class="literal">User</code> object. This would allow you to keep the CSV reader straightforward and separate the code converting its data to an actual <code class="literal">User</code> object, your real domain object, making that code easier to understand and maintain.</p><p>Our reader and <a id="id403" class="indexterm"/>writer code is short enough, so we will put it directly in the Spring Batch configuration. However, it could be moved to separate classes.</p></div></div>
<div class="section" title="Reading an XML file"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec85"/>Reading an XML file</h1></div></div></div><p>In this <a id="id404" class="indexterm"/>recipe, you'll learn to read an XML file as part of a read/process/write step.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec197"/>Getting ready</h2></div></div></div><p>We'll read this XML file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;records&gt;
    &lt;person&gt;
        &lt;firstName&gt;Shania&lt;/firstName&gt;
    &lt;age&gt;49&lt;/age&gt;
    &lt;/person&gt;
    &lt;person&gt;
        &lt;firstName&gt;Nelly&lt;/firstName&gt;
    &lt;age&gt;36&lt;/age&gt;
    &lt;/person&gt;
&lt;/records&gt;</pre></div><p>For each person's record in the XML file, a <code class="literal">User</code> object will be created. Make sure that the <code class="literal">User</code> class exists:</p><div class="informalexample"><pre class="programlisting">public class User {
  private String firstName;
  private int age;</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec198"/>How to do it…</h2></div></div></div><p>To parse the XML file, use <code class="literal">StaxEventItemReader</code>, which is provided by Spring Batch. To generate <code class="literal">User</code> objects, use <code class="literal">XStreamMarshaller</code>, a class from the Spring Object/XML Mapping project. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependency for Spring Object/XML Mapping in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework&lt;/groupId&gt;
  &lt;artifactId&gt;spring-oxm&lt;/artifactId&gt;
  &lt;version&gt;${spring.version}&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">Add a <code class="literal">reader()</code> method returning a <code class="literal">StaxEventItemReader</code> object to read the XML file and generate <code class="literal">User</code> objects from its contents:<div class="informalexample"><pre class="programlisting">@Bean
@StepScope
public StaxEventItemReader&lt;User&gt; reader(@Value("#{jobParameters[file]}") String xmlFilePath) {        
    StaxEventItemReader&lt;User&gt; reader = new StaxEventItemReader&lt;User&gt;();
    reader.setResource(new PathResource(xmlFilePath));
    reader.setFragmentRootElementName("person");

  XStreamMarshaller marshaller = new XStreamMarshaller();
  marshaller.setAliases(Collections.singletonMap("person", User.class)); 
  reader.setUnmarshaller(marshaller);
  
  return reader;
}</pre></div></li><li class="listitem">Execute the job with the path to the XML file as a parameter. For example:<div class="informalexample"><pre class="programlisting">mvn compile exec:java - Dexec.mainClass=org.springframework.batch.core.launch. support.CommandLineJobRunner - Dexec.args="com.spring_cookbook.batch.BatchConfig job1 <span class="strong"><strong>file=input_data.xml</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec199"/>How it works…</h2></div></div></div><p><code class="literal">XStreamMarshaller</code> generates a <code class="literal">User</code> automatically for each person's record. This is configured <a id="id405" class="indexterm"/>with the following line:</p><div class="informalexample"><pre class="programlisting">marshaller.setAliases(Collections.singletonMap("person", User.class)); </pre></div><p>Note that the <code class="literal">User</code> fields have to match the XML fields (<code class="literal">firstName</code> and <code class="literal">age</code>).</p></div></div>
<div class="section" title="Generating a CSV file"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec86"/>Generating a CSV file</h1></div></div></div><p>Write a CSV <a id="id406" class="indexterm"/>file as part of a read/process/write step.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec200"/>Getting ready</h2></div></div></div><p>We will generate a CSV file from <code class="literal">User</code> objects. Make sure that the <code class="literal">User</code> class exists:</p><div class="informalexample"><pre class="programlisting">public class User {
  private String firstName;
  private int age;</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec201"/>How to do it…</h2></div></div></div><p>Use <code class="literal">FlatFileItemWriter</code> provided by Spring Batch:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a <code class="literal">writer()</code> method that will get the fields of a <code class="literal">User</code> object, build a comma-separated line with them, and write the line to a CSV file:<div class="informalexample"><pre class="programlisting">@Bean
@StepScope
public FlatFileItemWriter&lt;User&gt; writer(@Value("#{jobParameters[fileOut]}") String csvFilePath) {
    BeanWrapperFieldExtractor&lt;User&gt; fieldExtractor = new BeanWrapperFieldExtractor&lt;User&gt;();
    fieldExtractor.setNames(new String[]{"firstName","age"});

    DelimitedLineAggregator&lt;User&gt; lineAggregator = new DelimitedLineAggregator&lt;User&gt;();
    lineAggregator.setDelimiter(",");
    lineAggregator.setFieldExtractor(fieldExtractor);
    
    FlatFileItemWriter&lt;User&gt; writer = new FlatFileItemWriter&lt;User&gt;();
    writer.setLineAggregator(lineAggregator); 
    writer.setResource(new PathResource(csvFilePath));
    
    return writer;
}</pre></div></li><li class="listitem">Execute the <a id="id407" class="indexterm"/>job with the path to the output CSV file as a parameter:<div class="informalexample"><pre class="programlisting">mvn compile exec:java - Dexec.mainClass=org.springframework.batch.core.launch. support.CommandLineJobRunner - Dexec.args="com.spring_cookbook.batch.BatchConfig job1 file=input_data.txt <span class="strong"><strong>fileOut=output_data.txt</strong></span> </pre></div></li><li class="listitem">The resulting CSV file will look like this:<div class="informalexample"><pre class="programlisting">Merlin,334
Arthur,38
Lancelot,36
Tristan,21
Iseult,23
Mark,57</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec202"/>How it works…</h2></div></div></div><p><code class="literal">BeanWrapperFieldExtractor</code> extracts the declared fields (<code class="literal">firstName</code> and <code class="literal">age</code>) from the <code class="literal">User</code> object. <code class="literal">DelimitedLineAggregator</code> builds a comma-separated line with them. <code class="literal">FlatFileItemWriter</code> <a id="id408" class="indexterm"/>writes the line to the file.</p></div></div>
<div class="section" title="Reading from a database"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec87"/>Reading from a database</h1></div></div></div><p>This recipe shows <a id="id409" class="indexterm"/>you how to read data from a database as part of a read/process/write step.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec203"/>Getting ready</h2></div></div></div><p>Each user will be read from the database. Make sure that the <code class="literal">user</code> database table exists with some data in it:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE user  (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
  first_name TEXT,
  age INT
);</pre></div><p>For each user row in the database, we'll create a <code class="literal">User</code> object. Make sure that the <code class="literal">User</code> class exists:</p><div class="informalexample"><pre class="programlisting">public class User {
  private String firstName;
  private int age;</pre></div><p>Make sure that the <code class="literal">Datasource</code> bean is defined with the database connection information.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec204"/>How to do it…</h2></div></div></div><p>Add a <code class="literal">reader()</code> method returning <code class="literal">JdbcCursorItemReader</code>-a class provided by Spring Batch:</p><div class="informalexample"><pre class="programlisting">@Bean
@StepScope
public JdbcCursorItemReader&lt;User&gt; reader() {
  JdbcCursorItemReader&lt;User&gt; reader = new JdbcCursorItemReader&lt;User&gt;();
  reader.setDataSource(dataSource());

  reader.setSql("SELECT first_name, age FROM user");

  reader.setRowMapper(new BeanPropertyRowMapper&lt;User&gt;(User.class));

  return reader;
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec205"/>How it works…</h2></div></div></div><p>A SQL query is executed to get users from the database. <code class="literal">BeanPropertyRowMapper</code> generates <code class="literal">User</code> objects <a id="id410" class="indexterm"/>from the result. Note that the SQL result's columns (<code class="literal">first_name</code>, <code class="literal">age</code>) have to match the User fields (<code class="literal">firstName</code> and <code class="literal">age</code>). If the database table has different column names, use SQL aliases to ensure that:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT name1 as first_name, the_age as age FROM user</strong></span>
</pre></div></div></div>
<div class="section" title="Unit testing batch jobs"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec88"/>Unit testing batch jobs</h1></div></div></div><p>Spring Batch <a id="id411" class="indexterm"/>provides different ways to test a batch job; the whole job, only one step, or just a <code class="literal">Tasklet</code> class can be tested.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec206"/>How to do it…</h2></div></div></div><p>Follow these steps to unit test batch jobs:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependency for <code class="literal">spring-batch-test</code> in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.batch&lt;/groupId&gt;
  &lt;artifactId&gt;spring-batch-test&lt;/artifactId&gt;
  &lt;version&gt;3.0.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">In the unit test class, if using JUnit, load the Spring Batch configuration class like this:<div class="informalexample"><pre class="programlisting">@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(classes = {BatchConfig.class})
public class BatchJob1Test {
...</pre></div></li><li class="listitem">If using TestNG, load the Spring Batch configuration class as follows:<div class="informalexample"><pre class="programlisting">@ContextConfiguration(classes = {BatchConfig.class})
public class BatchJob1Test extends AbstractTestNGSpringContextTests {
...</pre></div></li><li class="listitem">Add an autowired <code class="literal">JobLauncherTestUtils</code> field:<div class="informalexample"><pre class="programlisting">@Autowired
private JobLauncherTestUtils jobLauncherTestUtils;</pre></div></li><li class="listitem">This is how you can test an entire job, check its exit status, and the number of steps that were executed:<div class="informalexample"><pre class="programlisting">@Test
public void testJob() throws Exception {
    JobExecution jobExecution = jobLauncherTestUtils.<span class="strong"><strong>launchJob</strong></span>();
    Assert.assertEquals(ExitStatus.COMPLETED, jobExecution.getExitStatus());
    Assert.assertEquals(1, jobExecution.getStepExecutions().size());
}</pre></div></li><li class="listitem">This is <a id="id412" class="indexterm"/>how you can test a specific step:<div class="informalexample"><pre class="programlisting">@Test
public void testStep() throws Exception {
    JobExecution jobExecution = jobLauncherTestUtils.<span class="strong"><strong>launchStep</strong></span>("step1");
    Assert.assertEquals(ExitStatus.COMPLETED, jobExecution.getExitStatus());
}</pre></div></li><li class="listitem">This is how you can test Tasklet:<div class="informalexample"><pre class="programlisting">@Test
public void testTasklet() throws Exception {
    Task1 task1 = new Task1();
    Assert.assertEquals(RepeatStatus.FINISHED, task1.<span class="strong"><strong>execute</strong></span>(null, null));  
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec207"/>How it works…</h2></div></div></div><p>The Spring Batch configuration class has to be loaded, so that the test methods can access the job and its steps. <code class="literal">JobLauncherTestUtils</code> is a helper class that is used to easily execute a job or one of its steps.</p></div></div></body></html>