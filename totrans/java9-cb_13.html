<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">The Read-Evaluate-Print Loop (REPL) Using JShell</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Getting familiar with REPL</li>
<li>Navigating JShell and its commands</li>
<li>Evaluating code snippets</li>
<li>Object-oriented programming in JShell</li>
<li>Saving and restoring the JShell command history</li>
<li>Using the JShell Java API</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p><strong>REPL</strong> stands for the <strong>Read-Evaluate-Print Loop</strong> and, as the name states, it reads the command entered on the command line, evaluates it, prints the result of evaluation, and continues this process on any command entered. </p>
<p>All the major languages, such as Ruby, Scala, Python, JavaScript, and Groovy, among others, have REPL tools. Java was missing the much-needed REPL. If we had to try out some sample code, say using <kbd>SimpleDateFormat</kbd> to parse a string, we had to write a complete program with all the ceremonies, including creating a class, adding a main method, and then the single line of code we want to experiment. Then, we have to compile and run the code. These ceremonies make it harder to experiment and learn the features of the language. </p>
<p>With a REPL, you can type only the line of code that you are interested in experimenting with and you would have immediate feedback on whether the expression is syntactically correct and gives the desired results. REPL is a very powerful tool, especially for people coming to the language for the first time. Suppose you want to show how to print <em>Hello World</em> in Java; for this, you'd have to start writing the class definition, then the <kbd>public static void main(String [] args)</kbd> method, and by the end of it, you would have explained or tried to explain a lot of concepts that would otherwise be difficult for a newbie to comprehend. </p>
<p>Anyways, with Java 9, Java developers can now stop cribbing about the absence of a REPL tool. A new REPL called <span>JShell</span> is being bundled with the JDK installation. So, we can now proudly write <em>Hello World</em> as our first <em>Hello World</em> code. </p>
<p>In this chapter, we will explore the features of <span>JShell</span> and write code that will truly amaze us and appreciate the power of REPL. We will also see how we can create our own REPLs using the <span>JShell</span> Java API. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting familiar with REPL</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will look at a few basic operations to help us get familiarize us with the <span>JShell</span> tool.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Make sure you have the latest JDK 9 version installed, which has <span>JShell</span>. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>By now, you should have <kbd>%JAVA_HOME%/bin</kbd> (on Windows) or <kbd>$JAVA_HOME/bin</kbd> (on Linux) added to your <kbd>PATH</kbd> variable. If not, then please visit the recipe, <em>Installing JDK 9 on Windows and setting up the PATH variable</em> and <em>Installing JDK 9 on Linux (Ubuntu, x64) and configuring the PATH variable</em> in <a href="5cd0711b-a2f8-4129-9ec2-e80e4a0cf8db.xhtml">Chapter 1</a>, <em>Installation and a Sneak Peek into Java 9</em>.</li>
<li>In your command prompt, type <kbd>jshell</kbd> and press enter.</li>
</ol>
<p> </p>
<ol start="3">
<li>You will see a message and then a <kbd>jshell&gt;</kbd> prompt:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="48" width="226" class="image-border" src="assets/cc3a1d23-a727-417e-a8b2-aefca185d2f2.png"/></div>
<ol start="4">
<li>Forward slash<strong> </strong>(<kbd>/</kbd>)<strong>,</strong> followed by the <span>JShell</span>-supported commands, help you in interacting with <span>JShell</span>. Just like we try <kbd>/help intro</kbd> to get the following:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="156" width="437" class="image-border" src="assets/dd485fd1-e0a1-4960-a09f-ac1af706f7c9.png"/></div>
<ol start="5">
<li>Let's print a <kbd>Hello World</kbd> message:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="36" width="132" class="image-border" src="assets/273d1001-c971-4b6e-9633-5783bfc91063.png"/></div>
<ol start="6">
<li>Let's print a customized <kbd>Hello World</kbd> message:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="88" width="221" class="image-border" src="assets/debc42a8-b265-4d9b-b85d-ac668fe4c662.png"/></div>
<ol start="7">
<li>You can navigate through the executed commands using the up and down arrow keys.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The code snippets entered at the <kbd>jshell</kbd> prompt are wrapped with just enough code to execute them. So, variable, method and class declarations get wrapped within a class and expressions get wrapped within a method which is in turn wrapped within the class. Other things such as imports and class definitions remain as is because they are top-level entities that is, wrapping a class definition within another class is not required as a class definition is a top level entity and can exist by itself. Similarly, in Java, import statements can occur by themselves and they occur outside of a class declaration and hence need not be wrapped inside a class. </p>
<p>In the subsequent recipes, we will see how to define a method, import additional packages, define classes, and so on.</p>
<p>In the preceding recipe, we saw <kbd>$1 ==&gt; "Hello World"</kbd>. If we have some value without any variable associated with it, then <kbd>jshell</kbd> gives it a variable name, such as <kbd>$1</kbd>, <kbd>$2</kbd>, and so on. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Navigating JShell and its commands</h1>
                </header>
            
            <article>
                
<p>In order to leverage a tool, we need to be familiar with how to use it, the commands it provides, and the various shortcut keys that we can use to be productive. In this recipe, we will look at the different ways we can navigate through JShell and also at the different keyboard shortcuts it provides to be productive while using it.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Spawn the <span>JShell</span> by typing <kbd>jshell</kbd> in the command prompt, and you will be greeted with a welcome message containing the instructions to get started. </li>
<li>Type <kbd>/help intro</kbd> to get a brief introduction to <span>JShell</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="148" width="407" class="image-border" src="assets/b4668e7b-a5d3-47e4-907e-638d7e06c3e5.png"/></div>
<ol start="3">
<li>Type <kbd>/help</kbd> to get a list of the supported commands:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="152" width="367" class="image-border" src="assets/f5e02b24-9f26-4c14-8e43-6c097e9042fa.png"/></div>
<ol start="4">
<li>To get more information about a command, type <kbd>/help &lt;command&gt;</kbd>. For example, to get information about <kbd>/edit</kbd>, type <kbd>/help /edit</kbd>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="182" width="503" class="image-border" src="assets/363a77a7-4b4b-4646-8e0d-aca0ba82888c.png"/></div>
<ol start="5">
<li>There is autocompletion support in <span>JShell</span>. This makes Java developers feel at home. You can invoke autocompletion using the <em>Tab</em> key:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="315" width="443" class="image-border" src="assets/8b2030c3-d41d-4221-9754-f7bbcef3ca11.png"/></div>
<ol start="6">
<li>You can use <kbd>/!</kbd> to execute a previously executed command and <kbd>/line_number</kbd> to re-execute an expression at the line number.</li>
<li>To navigate the cursor through the command line, use <em>Ctrl</em> + <em>A</em> to reach the beginning of the line and <em>Ctrl</em> + <em>E</em> to reach the end of the line.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Evaluating code snippets</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will look at executing the following code snippets:</p>
<ul>
<li>Import statements</li>
<li>Class declarations</li>
<li>Interface declarations</li>
<li>Method declarations</li>
<li>Field declarations</li>
<li>Statements</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Open the command prompt and launch <span>JShell</span>.</li>
<li>By default, <span>JShell</span> imports a few libraries. We can check that by issuing the <kbd>/imports</kbd> command:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="159" width="226" class="image-border" src="assets/5bf0109e-27f8-464a-9f52-b1a3953dbaac.png"/></div>
<ol start="3">
<li>Let's import <kbd>java.text.SimpleDateForm</kbd> by issuing the <kbd>import java.text.SimpleDateFormat</kbd> command. This imports the <kbd>SimpleDateFormat</kbd> class. </li>
<li>Let's declare an <kbd>Employee</kbd> class. We will issue one statement in each line so that it's an incomplete statement, and we'll proceed in the same way as we do in any ordinary editor. The following illustration will clarify this:</li>
</ol>
<pre>        class Employee{<br/>          private String empId;<br/>          public String getEmpId() {<br/>            return empId;<br/>          }<br/>          public void setEmpId ( String empId ) {<br/>            this.empId = empId;<br/>          }<br/>        }</pre>
<div class="CDPAlignCenter CDPAlign"><img height="126" width="307" class="image-border" src="assets/5fbba3f1-7cff-4244-9d67-088ab47122fc.png"/></div>
<ol start="5">
<li>Let's declare an <kbd>Employability</kbd> interface, which defines a method, <kbd>employable()</kbd>, as shown in the following code snippet:</li>
</ol>
<pre>        interface Employability { <br/>          public boolean employable();<br/>        }</pre>
<p style="padding-left: 60px">The preceding interface when created via the <kbd>jshell</kbd> is shown below:</p>
<div class="CDPAlignCenter CDPAlign"><img height="63" width="245" class="image-border" src="assets/b5b02234-5755-4dc9-bae9-0408b426d4e6.png"/></div>
<ol start="6">
<li>Let's declare a <kbd>newEmployee(String empId)</kbd> method, which constructs an <kbd>Employee</kbd> object with the given <kbd>empId</kbd>:</li>
</ol>
<pre>        public Employee newEmployee(String empId ) {<br/>          Employee emp = new Employee();<br/>          emp.setEmpId(empId);<br/>          return emp;<br/>        }</pre>
<p style="padding-left: 60px">The preceding method defined in JShell is shown below:</p>
<div class="CDPAlignCenter CDPAlign"><img height="60" width="304" class="image-border" src="assets/51e480a9-dc9b-45c2-a229-baaf6286a1a4.png"/></div>
<ol start="7">
<li>We will use the method defined in the previous step to create a statement declaring an <kbd>Employee</kbd> variable:</li>
</ol>
<pre>        Employee e = newEmployee("1234");</pre>
<p>The above statement and its output when executed from within JShell are shown below. The snippet <kbd>e.get + Tab</kbd> key generates auto-completion as supported by the IDEs.</p>
<div class="CDPAlignCenter CDPAlign"><img height="91" width="214" class="image-border" src="assets/a7fa1073-34f1-41bf-ab4a-82c1d59188f2.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>We can invoke an undefined method. Take a look at the following example:</p>
<pre>public void newMethod(){<br/>  System.out.println("New  Method");<br/>  undefinedMethod();<br/>}</pre>
<div class="CDPAlignCenter CDPAlign"><img height="97" width="578" class="image-border" src="assets/556ab767-952d-4ac1-b43b-c25a036c583e.png"/></div>
<p>However, the method cannot be invoked before the method being used has been defined:</p>
<pre>public void undefinedMethod(){<br/>  System.out.println("Now defined");<br/>}</pre>
<div class="CDPAlignCenter CDPAlign"><img height="108" width="263" class="image-border" src="assets/e4b66e3f-6e06-41da-8873-0dc2013be06b.png"/></div>
<p>We can invoke <kbd>newMethod()</kbd> only after we have defined <kbd>undefinedMethod()</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Object-oriented programming in JShell</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will make use of predefined Java class definition files and import them into <span>JShell</span>. Then, we will play around with those classes in the <span>JShell</span>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>The class definition files we will use in this recipe are available at the location, <kbd>chp13/4_oo_programming</kbd>, in the code downloads for this book.</li>
<li>There are three class definition files: <kbd>Engine.java</kbd>, <kbd>Dimensions.java</kbd>, and <kbd>Car.java</kbd>.</li>
<li>Navigate to the directory where these three class definition files are available.</li>
<li>The <kbd>/open</kbd> command allows loading the code from within a file. </li>
<li>We will load the <kbd>Engine</kbd> class definition and create an <kbd>Engine</kbd> object. </li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="61" width="302" class="image-border" src="assets/a66a4725-1fd9-4d3f-87f7-5b2dd87c70cb.png"/></div>
<ol start="6">
<li>Next, we will load the <kbd>Dimensions</kbd> class definition and create a <kbd>Dimensions</kbd> object:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="83" width="309" class="image-border" src="assets/700d6bd9-7540-4dcf-a742-3fa3a211421d.png"/></div>
<ol start="7">
<li>Finally, we will load the <kbd>Car</kbd> class definition and create a <kbd>Car</kbd> object:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="63" width="312" class="image-border" src="assets/472eb927-a529-4017-9a11-37a051b3d48a.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Saving and restoring the JShell command history</h1>
                </header>
            
            <article>
                
<p>We will want to try out some code snippets in <kbd>jshell</kbd> as a means to explain Java programming to someone who is new to it. Moreover, some form of record of what code snippets were executed will be useful for the person who is learning the language. </p>
<p>In this recipe, we will execute a few code snippets and save them into a file. We will then load the code snippets from the saved file. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Let's execute a series of code snippets, as follows:</li>
</ol>
<pre>        "Hello World"<br/>        String msg = "Hello, %s. Good Morning"<br/>        System.out.println(String.format(msg, "Friend"))<br/>        int someInt = 10<br/>        boolean someBool = false<br/>        if ( someBool ) {<br/>          System.out.println("True block executed");<br/>        }<br/>        if ( someBool ) {<br/>          System.out.println("True block executed");<br/>        }else{<br/>          System.out.println("False block executed");<br/>        }<br/>        for ( int i = 0; i &lt; 10; i++ ){<br/>          System.out.println("I is : " + i );<br/>        }</pre>
<div class="CDPAlignCenter CDPAlign"><img height="437" width="317" class="image-border" src="assets/eb5891bd-fa29-478e-afef-6d46e85fc22c.png"/></div>
<ol start="2">
<li>Save the code snippets executed into a file called <kbd>history</kbd> using the <kbd>/save history</kbd> command.</li>
<li>Exit the shell using <kbd>/exit</kbd> and list the files in the directory by using <kbd>dir</kbd> or <kbd>ls</kbd>, depending on the OS. There will be a <kbd>history</kbd> file in the listing.</li>
<li>Open <kbd>jshell</kbd> and check for the history of code snippets executed using <kbd>/list</kbd>. You will see that there are no code snippets executed.</li>
<li>Load the <kbd>history</kbd> file using <kbd>/open history</kbd> and then check for the history of the code snippets executed using <kbd>/list</kbd>. You will see all the previous code snippets being executed and added to the history:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="377" width="293" class="image-border" src="assets/94763af0-658f-4657-8a2f-423ad1538e03.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using the JShell Java API</h1>
                </header>
            
            <article>
                
<p>JDK 9 provides the Java API for creating tools such as <kbd>jshell</kbd> for evaluating Java code snippets. This Java API is present in the <kbd>jdk.jshell</kbd> module (<a href="http://cr.openjdk.java.net/~rfield/arch/doc/jdk/jshell/package-summary.html">http://cr.openjdk.java.net/~rfield/arch/doc/jdk/jshell/package-summary.html</a>). So, if you want to use the API in your application, then you need to declare a dependency on the <kbd>jdk.jshell</kbd> module.</p>
<p>In this recipe, we will use the <span>JShell</span> JDK API to evaluate simple code snippets, and you'll also see different APIs to get the state of <span>JShell</span>. The idea is not to recreate <span>JShell</span> but to show how to make use of its JDK API.</p>
<div class="packt_infobox">For this recipe, we will not be using <span>JShell</span>; instead, we will follow the usual way of compiling using <kbd>javac</kbd> and running using <kbd>java</kbd>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Our module will depend on the <kbd>jdk.jshell</kbd> module. So, the module definition will look like the following:</li>
</ol>
<pre>        module jshell{<br/>          requires jdk.jshell;<br/>        }</pre>
<ol start="2">
<li>Let's create an instance of the <kbd>jdk.jshell.JShell</kbd> class by using its <kbd>create()</kbd> method or the builder API in <kbd>jdk.jshell.JShell.Builder</kbd>:</li>
</ol>
<pre>        JShell myShell = JShell.create();</pre>
<ol start="3">
<li>Let's read the code snippet from <kbd>System.in</kbd> using <kbd>java.util.Scanner</kbd>:</li>
</ol>
<pre>        try(Scanner reader = new Scanner(System.in)){<br/>          while(true){<br/>            String snippet = reader.nextLine();<br/>            if ( "EXIT".equals(snippet)){<br/>              break;<br/>            }<br/>            //TODO: Code here for evaluating the snippet using JShell API<br/>          }<br/>        }</pre>
<ol start="4">
<li>We will use the <kbd>jdk.jshell.JShell#eval(String snippet)</kbd> method to evaluate the input. Evaluation will result in a list of <kbd>jdk.jshell.SnippetEvent</kbd>, which contains the status and output of evaluation. The TODO in the preceding code snippet will be replaced by the following lines:</li>
</ol>
<pre>        List&lt;SnippetEvent&gt; events = myShell.eval(snippet);<br/>        events.stream().forEach(se -&gt; {<br/>          System.out.print("Evaluation status: " + se.status());<br/>          System.out.println(" Evaluation result: " + se.value());<br/>        });</pre>
<ol start="5">
<li>After the evaluation is completed, we will print the snippets processed by using the <kbd>jdk.jshell.JShell.snippets()</kbd> method, which will return <kbd>Stream</kbd> of <kbd>Snippet</kbd> processed.</li>
</ol>
<pre>        System.out.println("Snippets processed: ");<br/>        myShell.snippets().forEach(s -&gt; {<br/>          String msg = String.format("%s -&gt; %s", s.kind(), s.source());<br/>          System.out.println(msg);<br/>        });</pre>
<ol start="6">
<li>Similarly, we can print the active method and variables as follows:</li>
</ol>
<pre>        System.out.println("Methods: ");<br/>        myShell.methods().forEach(m -&gt; <br/>          System.out.println(m.name() + " " + m.signature()));<br/><br/>        System.out.println("Variables: ");<br/>        myShell.variables().forEach(v -&gt; <br/>          System.out.println(v.typeName() + " " + v.name()));</pre>
<ol start="7">
<li>Before the application exits, we close the <kbd>JShell</kbd> instance by invoking its <kbd>close()</kbd> method:</li>
</ol>
<pre>        myShell.close();</pre>
<p>The code for this recipe can be found at the location, <kbd>chp13/6_jshell_api</kbd>. You can run the sample by using the <kbd>run.bat</kbd> or <kbd>run.sh</kbd> scripts available in the same directory. The sample execution and output is shown here:</p>
<div class="CDPAlignCenter CDPAlign"><img height="238" width="309" class="image-border" src="assets/ec75236a-c45f-471a-b7ca-18de3ba63d98.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The central class in the API is the <kbd>jdk.jshell.JShell</kbd> class. This class is the evaluation state engine, whose state is modified with every evaluation of the snippet. As we saw earlier, the snippets are evaluated using the <kbd>eval(String snippet)</kbd> method. We can even drop the previously evaluated snippet using the <kbd>drop(Snippet snippet)</kbd> method. Both these methods result in a change of the internal state maintained by <kbd>jdk.jshell.JShell</kbd>.</p>
<p>The code snippets passed to the <kbd>JShell</kbd> evaluation engine are categorized as follows:</p>
<ul>
<li><strong>Erroneous</strong>: Syntactically incorrect input</li>
<li><strong>Expressions</strong>: An input which might or might not result in some output</li>
<li><strong>Import</strong>: An import statement</li>
<li><strong>Method</strong>: A method declaration</li>
<li><strong>Statement</strong>: A statement</li>
<li><strong>Type declaration</strong>: A type, that is, class/interface declaration</li>
<li><strong>Variable declaration</strong>: A variable declaration</li>
</ul>
<p>All these categories are captured in the <kbd>jdk.jshell.Snippet.Kind</kbd> enum.</p>
<p>We also saw different APIs to get the evaluated snippets, created methods, variable declarations, and other specific snippet types executed. Each snippet type is backed by a class extending the <kbd>jdk.jshell.Snippet</kbd> class.</p>
<p> </p>


            </article>

            
        </section>
    </body></html>