<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer088">
<h1 class="chapter-number" id="_idParaDest-207"><a id="_idTextAnchor314"/>10</h1>
<h1 id="_idParaDest-208"><a id="_idTextAnchor315"/>SAML 2 Support</h1>
<p>SAML is predominantly employed as a web-based authentication mechanism, relying on the browser agent to facilitate the authentication process. In broad terms, the authentication flow of SAML can be outlined <span class="No-Break">as follows.</span></p>
<p>Spring Security provides comprehensive SAML 2 support. This section discusses how to integrate SAML 2 into your <span class="No-Break">Servlet-based application.</span></p>
<p>Starting from 2009, support for relying parties has been available as part of an extension project. In 2019, efforts were initiated to integrate this support into the core of Spring Security. This mirrors a similar process initiated in 2017 for incorporating Spring Security’s OAuth <span class="No-Break">2.0 support.</span></p>
<p>This chapter will explore the <span class="No-Break">following subjects:</span></p>
<ul>
<li>Fundamental aspects of the <span class="No-Break">SAML protocol</span></li>
<li>Establishing your SAML 2 Login using <span class="No-Break">Spring Security</span></li>
<li>Acquiring the SAML 2 <span class="No-Break">Authenticated Principal</span></li>
<li>Parsing and generating SAML <span class="No-Break">2.0 metadata</span></li>
<li>Tailoring authorities using Spring <span class="No-Break">Security SAML</span></li>
<li>Executing <span class="No-Break">Single Logout</span></li>
</ul>
<p>This chapter’s code in action link is <span class="No-Break">here: </span><a href="https://packt.link/7qRvM"><span class="No-Break">https://packt.link/7qRvM</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-209"><a id="_idTextAnchor316"/>What is SAML?</h1>
<p><strong class="bold">Security Assertion Markup Language</strong> (<strong class="bold">SAML</strong>) stands <a id="_idIndexMarker673"/>as a widely embraced open standard based on XML, specifically crafted<a id="_idIndexMarker674"/> for the secure exchange<a id="_idIndexMarker675"/> of <strong class="bold">authentication and authorization</strong> (<strong class="bold">AA</strong>) information among<a id="_idIndexMarker676"/> federated organizations. It serves to streamline <strong class="bold">Single Sign-On</strong> (<strong class="bold">SSO</strong>) capabilities for <span class="No-Break">browser-based access.</span></p>
<p>Established in 2005 as an <a id="_idIndexMarker677"/>OASIS standard and consistently upheld by the <strong class="bold">Organization for the Advancement of Structured Information Standards</strong> (<strong class="bold">OASIS</strong>), SAML 2.0 amalgamates elements <a id="_idIndexMarker678"/>from SAML 1.1, the <strong class="bold">Liberty Alliance Identity Federation Framework</strong> (<strong class="bold">ID-FF</strong>) 1.2, and <span class="No-Break">Shibboleth 1.3.</span></p>
<p>Within the SAML 2.0 <a id="_idIndexMarker679"/>specification, three crucial entities assume distinct roles: the principal, the service provider, and the <span class="No-Break">identity provider.</span></p>
<p>As an illustration, consider Sally accessing her investment account on ucanbeamillionaire.com. To log her in and let her access her account, the site employs SAML <span class="No-Break">for authentication.</span></p>
<p>SAML 2.0 is widely adopted and used in various scenarios, such as enterprise applications, cloud services, and web-based authentication systems, to establish a secure and interoperable framework for identity and <span class="No-Break">access management.</span></p>
<p>Key components<a id="_idIndexMarker680"/> and concepts of SAML <span class="No-Break">2.0 include:</span></p>
<ul>
<li>A <strong class="bold">Service Provider</strong> (<strong class="bold">SP</strong>) functions<a id="_idIndexMarker681"/> as the entity <a id="_idIndexMarker682"/>delivering a service, often in the form of <span class="No-Break">an application.</span></li>
<li>An <strong class="bold">Identity Provider</strong> (<strong class="bold">IdP</strong>) serves <a id="_idIndexMarker683"/>as the entity furnishing <a id="_idIndexMarker684"/>identities, encompassing the capability to authenticate a user. Typically, the IdP also houses the user profile, which includes additional information such as the first name, last name, job code, phone number, address, and more. The extent of user data required by SPs may vary, ranging from a basic profile (username, email) to a more comprehensive set (job code, department, address, location, manager, etc.), depending on <span class="No-Break">the application.</span></li>
<li>A <strong class="bold">SAML Request</strong>, which<a id="_idIndexMarker685"/> is<a id="_idIndexMarker686"/> <span class="P---Regular-Char">also known as an authentication request, is initiated by the SP to formally </span><span class="No-Break"><span class="P---Regular-Char">request authentication.</span></span></li>
<li>The IdP generates<a id="_idIndexMarker687"/> a <strong class="bold">SAML Response</strong>, which includes the actual assertion of the authenticated user. Additionally, the <a id="_idIndexMarker688"/>SAML Response may incorporate extra information, such as user profile details and group/role information, based on the capabilities supported by <span class="No-Break">the SP.</span></li>
<li><strong class="bold">SP-initiated</strong> sign-in <a id="_idIndexMarker689"/>denotes the SAML sign-in flow instigated by the SP. This typically occurs when an end user attempts to access a resource or sign in directly on the SP side, such as when the browser endeavors to access a protected resource on the <span class="No-Break">SP’s platform.</span></li>
<li><strong class="bold">IdP-initiated</strong> sign-in <a id="_idIndexMarker690"/>characterizes the SAML sign-in flow instigated by the IdP. In this scenario, instead of the SAML flow being prompted by a redirection from the SP, the IdP initiates a SAML Response redirected to the SP to validate the <span class="No-Break">user’s identity.</span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer078">
<img alt="Figure 10.1 – Exploring the SAML protocol" height="380" src="image/B21757_10_01.jpg" width="565"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – Exploring the SAML protocol</p>
<p>Here are a few key points <span class="No-Break">to consider:</span></p>
<ul>
<li>Direct interaction between the SP and the IdP never occurs. All interactions are facilitated through a browser, which serves as the intermediary for <span class="No-Break">all redirections.</span></li>
<li>The SP <a id="_idIndexMarker691"/>must be aware of the IdP to redirect to before obtaining information about <span class="No-Break">the user.</span></li>
<li>The SP remains unaware of the user’s identity until it receives the SAML assertion from <span class="No-Break">the IdP.</span></li>
<li>The initiation of this flow is not restricted to the SP; an IdP can also kickstart an <span class="No-Break">authentication flow.</span></li>
<li>The SAML authentication flow operates asynchronously. The SP is uncertain if the IdP will complete the entire process. Consequently, the SP does not retain any state related to authentication requests. When the SP receives a response from the IdP, it must include all <span class="No-Break">necessary information.</span></li>
</ul>
<p>Following the introduction of the SAML protocol, we’ll delve into the functionality of SAML 2.0 Login within the context of <span class="No-Break">Spring Security.</span></p>
<h1 id="_idParaDest-210"><a id="_idTextAnchor317"/>SAML 2.0 Login with Spring Security</h1>
<p>The <a id="_idIndexMarker692"/>SAML 2.0 Login functionality empowers an application to function as a SAML 2.0 relying party. This enables users to log in to the application using their pre-existing accounts with a SAML 2.0 Asserting Party, such as ADFS, Okta, and <span class="No-Break">other IdPs.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">The implementation of SAML 2.0 Login <a id="_idIndexMarker693"/>utilizes the <strong class="bold">Web Browser Single Sign-On (SSO) Profile</strong>, as outlined in the SAML 2 Profiles <span class="No-Break">Specification: </span><a href="https://groups.oasis-open.org/higherlogic/ws/public/document?document_id=35389#page=15"><span class="No-Break">https://groups.oasis-open.org/higherlogic/ws/public/document?document_id=35389#page=15</span></a><span class="No-Break">.</span></p>
<p>To begin our exploration of SAML 2.0 relying party authentication in the context of Spring Security, we observe that Spring Security guides the user to a third party for authentication. This is accomplished through a sequence <span class="No-Break">of redirections:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer079">
<img alt="Figure 10.2 – Redirecting to asserting party authentication" height="788" src="image/B21757_10_02.jpg" width="1295"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – Redirecting to asserting party authentication</p>
<p>Let’s delve deeper<a id="_idIndexMarker694"/> into this sequence of <span class="No-Break">SAML redirections:</span></p>
<ol>
<li>Initially, a user submits an unauthenticated request to the <strong class="source-inline">/private</strong> resource without <span class="No-Break">proper authorization.</span></li>
<li>Spring Security’s <strong class="source-inline">AuthorizationFilter</strong> signals the denial of the unauthenticated request by throwing <span class="No-Break">an </span><span class="No-Break"><strong class="source-inline">AccessDeniedException</strong></span><span class="No-Break">.</span></li>
<li>Due to the lack of authorization, the <strong class="source-inline">ExceptionTranslationFilter</strong> triggers the <span class="P---Regular-Char">start of authentication</span>. The configured <strong class="source-inline">AuthenticationEntryPoint</strong> is an instance of <strong class="source-inline">LoginUrlAuthenticationEntryPoint</strong>, redirecting to the endpoint that generates the <strong class="source-inline">&lt;saml2:AuthnRequest&gt;</strong>, managed by the <strong class="source-inline">Saml2WebSsoAuthenticationRequestFilter</strong>. If multiple asserting parties are configured, it may first redirect to a <span class="No-Break">picker page.</span></li>
<li>Subsequently, the <strong class="source-inline">Saml2WebSsoAuthenticationRequestFilter</strong> generates, signs, serializes, and encodes a <strong class="source-inline">&lt;saml2:AuthnRequest&gt;</strong> using its <span class="No-Break">configured </span><span class="No-Break"><strong class="source-inline">Saml2AuthenticationRequestFactory</strong></span><span class="No-Break">.</span></li>
<li>The <a id="_idIndexMarker695"/>browser then takes the <strong class="source-inline">&lt;saml2:AuthnRequest&gt;</strong> and presents it to the asserting party, initiating the user authentication process. Upon successful authentication, the asserting party returns a <strong class="source-inline">&lt;saml2:Response&gt;</strong> to <span class="No-Break">the browser.</span></li>
<li>The browser proceeds to <strong class="source-inline">POST</strong> the <strong class="source-inline">&lt;saml2:Response&gt;</strong> to the assertion consumer <span class="No-Break">service endpoint.</span><p class="list-inset">The following diagram illustrates the authentication process of a <strong class="source-inline">&lt;saml2:Response&gt;</strong> in <span class="No-Break">Spring Security:</span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer080">
<img alt="Figure 10.3 – Authenticating a &lt;saml2:Response&gt;" height="699" src="image/B21757_10_03.jpg" width="766"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.3 – Authenticating a &lt;saml2:Response&gt;</p>
<p class="list-inset">We can summarize the interactions <span class="No-Break">as follow:</span></p>
<ol>
<li value="7">Upon submission of a <strong class="source-inline">&lt;saml2:Response&gt;</strong> by the browser to the application, the process is handed over to <span class="P---Regular-Char">the </span><strong class="source-inline">Saml2WebSsoAuthenticationFilter</strong>. This filter employs its configured <strong class="source-inline">AuthenticationConverter</strong> to generate a <strong class="source-inline">Saml2AuthenticationToken</strong> by extracting the response from the <strong class="source-inline">HttpServletRequest</strong>. Additionally, the converter resolves the <strong class="source-inline">RelyingPartyRegistration</strong> and provides it to <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">Saml2AuthenticationToken</strong></span><span class="No-Break">.</span></li>
<li>Subsequently, the filter transfers the token to its configured <strong class="source-inline">AuthenticationManager</strong>, defaulting to <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">OpenSamlAuthenticationProvider</strong></span><span class="No-Break">.</span></li>
<li>In the<a id="_idIndexMarker696"/> event of <span class="No-Break">authentication failure:</span><ul><li>The <strong class="source-inline">SecurityContextHolder</strong> <span class="No-Break">is cleared.</span></li><li>The <strong class="source-inline">AuthenticationEntryPoint</strong> is invoked to initiate the authentication <span class="No-Break">process anew.</span></li></ul></li>
<li>If <span class="No-Break">authentication succeeds:</span><ul><li>The <strong class="source-inline">Authentication</strong> is set on <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">SecurityContextHolder</strong></span><span class="No-Break">.</span></li><li>The <strong class="source-inline">Saml2WebSsoAuthenticationFilter</strong> invokes <strong class="source-inline">FilterChain#doFilter(request, response)</strong> to proceed with the remaining <span class="No-Break">application logic.</span></li></ul></li>
</ol>
<p>After the introduction of SAML 2.0 Login with Spring Security, we will explore a real-world SAML example <span class="No-Break">using OKTA.</span></p>
<h2 id="_idParaDest-211"><a id="_idTextAnchor318"/>Add a SAML application on OKTA</h2>
<p>To begin, you’ll <a id="_idIndexMarker697"/>need an OKTA <span class="No-Break">developer account.</span></p>
<ol>
<li>First, visit the OKTA developer website: <a href="https://developer.okta.com/signup">https://developer.okta.com/signup</a>. You will be presented with the following options to create <span class="No-Break">an account:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer081">
<img alt="Figure 10.4 – OKTA developer portal" height="552" src="image/B21757_10_04.jpg" width="1325"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.4 – OKTA developer portal</p>
<ol>
<li value="2">Choose <strong class="bold">Access the Okta Developer Edition Service</strong>, then create your <span class="No-Break">developer account.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer082">
<img alt="Figure 10.5 – OKTA developer account creation" height="508" src="image/B21757_10_05.jpg" width="1279"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.5 – OKTA developer account creation</p>
<ol>
<li value="3">The<a id="_idIndexMarker698"/> second step is to log in with your account, then go to <strong class="bold">Applications</strong> | <strong class="bold">Create </strong><span class="No-Break"><strong class="bold">App Integration</strong></span><span class="No-Break">.</span></li>
<li>Choose <strong class="bold">SAML 2.0</strong> and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
<li>Give a <a id="_idIndexMarker699"/>name to your application like <strong class="source-inline">JBCP Calendar SAML</strong> and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
<li>Use the <span class="No-Break">following configuration:</span><ul><li>Single sign on <span class="No-Break">URL: </span><span class="No-Break"><strong class="source-inline">https://localhost:8443/login/saml2/sso/okta</strong></span></li><li>For the recipient URL and Destination URL: (<span class="No-Break">the default)</span></li><li>For the audience <span class="No-Break">URI: </span><span class="No-Break"><strong class="source-inline">https://localhost:8443/saml2/service-provider-metadata/okta</strong></span></li></ul></li>
<li>After that click <strong class="bold">Next</strong>. Select these options: <strong class="bold">I’m an Okta customer adding an internal app</strong> and <strong class="bold">This is an internal app that we </strong><span class="No-Break"><strong class="bold">have created</strong></span><span class="No-Break">.</span></li>
<li><span class="No-Break">Select </span><span class="No-Break"><strong class="bold">Finish</strong></span><span class="No-Break">.</span></li>
<li>OKTA will create <span class="No-Break">your application.</span></li>
<li>Go to the <strong class="bold">SAML Signing Certificates</strong> and go to <strong class="bold">SHA-2</strong> | <strong class="bold">Actions</strong> | <strong class="bold">View IdP Metadata</strong>. You can <em class="italic">right-click</em> and copy this menu item’s link or open <span class="No-Break">its URL.</span></li>
<li>Copy the resulting link to your clipboard. It should look something like the <span class="No-Break">following: </span><span class="No-Break"><strong class="source-inline">https://dev-xxxxx.okta.com/app/&lt;random-characters&gt;/sso/saml/metadata</strong></span><span class="No-Break">.</span></li>
<li>Go to your application’s <strong class="bold">Assignment</strong> tab and assign access to the <span class="No-Break"><strong class="bold">Everyone</strong></span><span class="No-Break"> group.</span></li>
</ol>
<h2 id="_idParaDest-212"><a id="_idTextAnchor319"/>Creating the user principal in OKTA</h2>
<p>Let’s first <a id="_idIndexMarker700"/>create a user principal <span class="No-Break">in OKTA.</span></p>
<ol>
<li>Log in to OKTA and go to the OKTA <span class="No-Break">administrator console.</span></li>
<li>Navigate to the <span class="No-Break"><strong class="bold">Users</strong></span><span class="No-Break"> page.</span></li>
<li>Once logged in, navigate to the <span class="No-Break"><strong class="bold">Admin</strong></span><span class="No-Break"> section.</span></li>
<li>Select <strong class="bold">Directory</strong> from the menu. Then choose the <span class="No-Break"><strong class="bold">People</strong></span><span class="No-Break"> sub-menu.</span></li>
<li>Click the <strong class="bold">Add Person</strong> button <span class="No-Break">or similar.</span></li>
<li>Fill in <a id="_idIndexMarker701"/>user details: Provide the necessary information for the new user, such as first name, last name, email address, and any other required fields. You may also set a username and assign a role or group to <span class="No-Break">the user.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer083">
<img alt="Figure 10.6 – Adding users with OKTA" height="1033" src="image/B21757_10_06.jpg" width="1117"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.6 – Adding users with OKTA</p>
<h2 id="_idParaDest-213"><a id="_idTextAnchor320"/>Additional required dependencies</h2>
<p>We include<a id="_idIndexMarker702"/> the following additional dependencies in your <strong class="source-inline">build.gradle</strong> file if you are leveraging the OAuth <span class="No-Break">2 feature:</span></p>
<pre class="source-code">
//build.gradle
dependencies {
...
    constraints {
        implementation "org.opensaml:opensaml-core:4.2.0"
        implementation "org.opensaml:opensaml-saml-api:4.2.0"
        implementation "org.opensaml:opensaml-saml-impl:4.2.0"
    }
    implementation 'org.springframework.security:spring-security-saml2-service-provider'
...</pre> <h2 id="_idParaDest-214"><a id="_idTextAnchor321"/>Specifying IdP Metadata</h2>
<p>In a Spring Boot application, configure<a id="_idIndexMarker703"/> the metadata for an IdP by creating a setup resembling <span class="No-Break">the following:</span></p>
<pre class="source-code">
spring:
  security:
    saml2:
      relyingparty:
        registration:
          okta:
            assertingparty:
              metadata-uri: https://dev-xxxxx.okta.com/app/ &lt;random-characters&gt;/sso/saml/metadata</pre> <p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like that <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">chapter10.01-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-215"><a id="_idTextAnchor322"/>Retrieving the SAML 2 Authenticated Principal</h2>
<p>Once the<a id="_idIndexMarker704"/> relying party is appropriately configured for a specific asserting party, it is prepared to receive assertions. Following the validation of an assertion by the relying party, the outcome is a <strong class="source-inline">Saml2Authentication</strong> containing a <strong class="source-inline">Saml2AuthenticatedPrincipal</strong>. Consequently, you can access the principal, as demonstrated in <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">SpringSecurityUserContext</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/ SpringSecurityUserContext.java
@Component
public class SpringSecurityUserContext implements UserContext {
    private static final Logger logger = LoggerFactory
          .getLogger(SpringSecurityUserContext.class);
    private final CalendarService calendarService;
    public SpringSecurityUserContext(final CalendarService calendarService) {
       if (calendarService == null) {
          throw new IllegalArgumentException("calendarService cannot be null");
       }
       this.calendarService = calendarService;
    }
    @Override
    public CalendarUser getCurrentUser() {
       SecurityContext context = SecurityContextHolder.getContext();
       Authentication authentication = context.getAuthentication();
       if (authentication == null) {
          return null;
       }
       if(authentication.getPrincipal() instanceof DefaultSaml2AuthenticatedPrincipal saml2AuthenticatedPrincipal ) {
          String email = saml2AuthenticatedPrincipal.getName();
          CalendarUser result = calendarService.findUserByEmail(email);
          if (result == null) {
             throw new IllegalStateException(
                   "Spring Security is not in synch with CalendarUsers. Could not find user with email " + email);
          }
          logger.info("CalendarUser: {}", result);
          return result;
       }
       return null;
    }
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like that <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">chapter10.02-calendar</strong></span><span class="No-Break">.</span></p>
<p>Spring Security can parse <a id="_idIndexMarker705"/>asserting party metadata to produce an <strong class="source-inline">AssertingPartyDetails</strong> instance as well as publish relying party metadata from a <span class="No-Break"><strong class="source-inline">RelyingPartyRegistration</strong></span><span class="No-Break"> instance.</span></p>
<h2 id="_idParaDest-216"><a id="_idTextAnchor323"/>Parsing SAML 2 metadata</h2>
<p>By<a id="_idIndexMarker706"/> utilizing <strong class="source-inline">RelyingPartyRegistrations</strong>, it becomes possible to parse metadata from an asserting party. If you’re utilizing OpenSAML vendor support, the resultant <strong class="source-inline">AssertingPartyDetails</strong> will be in the form of <strong class="source-inline">OpenSamlAssertingPartyDetails</strong>. Consequently, you can access the underlying OpenSAML XMLObject by following <span class="No-Break">these steps:</span></p>
<pre class="source-code">
OpenSamlAssertingPartyDetails details = (OpenSamlAssertingPartyDetails)
       registration.getAssertingPartyDetails();
EntityDescriptor openSamlEntityDescriptor = details.getEntityDescriptor();</pre> <h2 id="_idParaDest-217"><a id="_idTextAnchor324"/>Generating SAML 2 Metadata</h2>
<p>You can <a id="_idIndexMarker707"/>expose a metadata endpoint with the <strong class="source-inline">saml2Metadata</strong> DSL method, as you can <span class="No-Break">see below:</span></p>
<pre class="source-code">
http
       // ...
       .saml2Login(withDefaults())
       .saml2Metadata(withDefaults());</pre> <p>Utilize the metadata endpoint for registering your relying party with the asserting party. This typically involves identifying the appropriate form field to provide the <span class="No-Break">metadata endpoint.</span></p>
<p>The default metadata endpoint is <strong class="source-inline">/saml2/metadata</strong>. It also responds to <strong class="source-inline">/saml2/metadata/{registrationId}</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">/saml2/service-provider-metadata/{registrationId}</strong></span><span class="No-Break">.</span></p>
<p>You can adapt this by calling the <strong class="source-inline">metadataUrl</strong> method in <span class="No-Break">the DSL:</span></p>
<pre class="source-code">
.saml2Metadata((saml2) -&gt; saml2.metadataUrl("/saml/metadata"))</pre> <h2 id="_idParaDest-218"><a id="_idTextAnchor325"/>Adapting RelyingPartyRegistration lookup</h2>
<p>To <a id="_idIndexMarker708"/>configure your own <strong class="source-inline">Saml2MetadataResponseResolver</strong>, you should use <strong class="source-inline">RelyingPartyRegistration</strong> as <span class="No-Break">described below:</span></p>
<pre class="source-code">
@Bean
Saml2MetadataResponseResolver metadataResponseResolver(RelyingPartyRegistrationRepository registrations) {
    RequestMatcherMetadataResponseResolver metadata = new RequestMatcherMetadataResponseResolver(
          (id) -&gt; registrations.findByRegistrationId("relying-party"), new OpenSamlMetadataResolver());
    metadata.setMetadataFilename("metadata.xml");
    return metadata;
}</pre> <p>Now that<a id="_idIndexMarker709"/> we have explored the SAML 2.0 Login functionality with Spring Security, we’ll move on to use custom SAML Spring Boot <span class="No-Break">Auto Configuration.</span></p>
<h1 id="_idParaDest-219"><a id="_idTextAnchor326"/>Overriding SAML Spring Boot Auto Configuration</h1>
<p>Spring Boot <a id="_idIndexMarker710"/>generates two <strong class="source-inline">@Bean</strong> objects for a <span class="No-Break">relying party.</span></p>
<p>The first is a <strong class="source-inline">SecurityFilterChain</strong> that configures the application as a relying party. When including <strong class="source-inline">spring-security-saml2-service-provider</strong>, the <strong class="source-inline">SecurityFilterChain</strong> <span class="No-Break">looks like:</span></p>
<p>You will notice that every authenticated user has a <strong class="source-inline">ROLE_USER</strong> role <span class="No-Break">by default.</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/ SecurityConfig.java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
       http.authorizeHttpRequests( authz -&gt; authz
                   .requestMatchers("/webjars/**").permitAll()
                   .requestMatchers("/css/**").permitAll()
                   .requestMatchers("/favicon.ico").permitAll()
                   // H2 console:
                   .requestMatchers("/admin/h2/**").fullyAuthenticated()
                   .requestMatchers("/").permitAll()
                   .requestMatchers("/login/*").permitAll()
                   .requestMatchers("/logout").permitAll()
                   .requestMatchers("/signup/*").permitAll()
                   .requestMatchers("/errors/**").permitAll()
                   .requestMatchers("/events/").hasRole("ADMIN")
                   .requestMatchers("/**").hasRole("USER"))
             .exceptionHandling(exceptions -&gt; exceptions
                   .accessDeniedPage("/errors/403"))
             .logout(form -&gt; form
                   .logoutUrl("/logout")
                   .logoutSuccessUrl("/")
                   .permitAll())
             // CSRF is enabled by default, with Java Config
             .csrf(AbstractHttpConfigurer::disable);
       // @formatter:off
       http
             .saml2Login(withDefaults());
       // For H2 Console
       http.headers(headers -&gt; headers.frameOptions(FrameOptionsConfig::disable));
       return http.build();
    }
...ommited for breviy
}</pre> <p>To test<a id="_idIndexMarker711"/> the application, open a web browser and navigate <span class="No-Break">to: </span><span class="No-Break"><strong class="source-inline">https://localhost:8443</strong></span><span class="No-Break">.</span></p>
<p>Next, proceed to the <strong class="source-inline">/events</strong> page. You should get an <strong class="bold">Access </strong><span class="No-Break"><strong class="bold">Denied</strong></span><span class="No-Break"> error.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like that <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">chapter10.03-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-220"><a id="_idTextAnchor327"/>Creating a custom RelyingPartyRegistrationRepository</h2>
<p>Spring Boot creates a <strong class="source-inline">RelyingPartyRegistrationRepository</strong>, which represents <a id="_idIndexMarker712"/>the asserting party and relying party metadata. This includes things such as the location of the SSO endpoint the relying party should use when requesting authentication from the <span class="No-Break">asserting party.</span></p>
<p>You can override the default by publishing your own <strong class="source-inline">RelyingPartyRegistrationRepository</strong> bean. You can also remove the existing <strong class="source-inline">spring.security.saml2.relyingparty.registration</strong> configuration <span class="No-Break">properties programmatically.</span></p>
<p>For example, you can look up the asserting party’s configuration by hitting its <span class="No-Break">metadata endpoint:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/ SecurityConfig.java
@Value("${metadata.location}")
private String assertingPartyMetadataLocation;
@Bean
public RelyingPartyRegistrationRepository relyingPartyRegistrations() {
    RelyingPartyRegistration registration = RelyingPartyRegistrations
          .fromMetadataLocation(assertingPartyMetadataLocation)
          .registrationId("okta")
          .build();
    return new InMemoryRelyingPartyRegistrationRepository(registration);
}</pre> <p>Alternatively, you<a id="_idIndexMarker713"/> can directly wire up the repository by using the DSL, which also overrides the <span class="No-Break">auto-configured </span><span class="No-Break"><strong class="source-inline">SecurityFilterChain</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/ SecurityConfig.java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
... omitted for brevity
       http
             .saml2Login(saml2 -&gt; saml2
                   .relyingPartyRegistrationRepository(relyingPartyRegistrations())
             );
       return http.build();
    }
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">The <strong class="source-inline">registrationId</strong> is a user-defined value chosen to distinguish between <span class="No-Break">different registrations.</span></p>
<p class="callout">Your code should now look like that <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">chapter10.04-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-221"><a id="_idTextAnchor328"/>Creating custom authorities with Spring Security SAML</h2>
<p>Upon logging in, you may observe that the displayed page indicates a <span class="No-Break"><strong class="source-inline">ROLE_USER</strong></span><span class="No-Break"> authority.</span></p>
<p>Despite <a id="_idIndexMarker714"/>granting access to all users initially, you can configure your <strong class="bold">SAML</strong> application to transmit a user’s groups as an attribute. Additionally, you have the option to include other attributes such as name <span class="No-Break">and email.</span></p>
<ol>
<li>Start by choosing to edit your OKTA application SAML <span class="No-Break">settings section.</span></li>
<li>Complete the Group Attribute <span class="No-Break">Statements section.</span><ul><li><span class="No-Break">Name: </span><span class="No-Break"><strong class="source-inline">groups</strong></span></li><li>Filter: <strong class="source-inline">Matches regex</strong> and use <strong class="source-inline">.*</strong> for <span class="No-Break">the value</span></li><li>Name <span class="No-Break">format: </span><span class="No-Break"><strong class="source-inline">Unspecified</strong></span></li></ul></li>
<li>You can add additional attributes. As <span class="No-Break">an example:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer084">
<img alt="Figure 10.7 – Additional custom user attributes in OKTA" height="155" src="image/B21757_10_07.jpg" width="398"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.7 – Additional custom user attributes in OKTA</p>
<ol>
<li value="4">Go to <a id="_idIndexMarker715"/>the <strong class="bold">Groups</strong> menu and add a group <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">ROLE_ADMIN</strong></span><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer085">
<img alt="Figure 10.8 – Defining a custom group in OKTA" height="515" src="image/B21757_10_08.jpg" width="1294"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.8 – Defining a custom group in OKTA</p>
<ol>
<li value="5">Then assign to this group the <span class="No-Break">user </span><span class="No-Break"><strong class="source-inline">admin1@example.com</strong></span><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer086">
<img alt="Figure 10.9 – Assigning users to groups in OKTA" height="495" src="image/B21757_10_09.jpg" width="1317"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.9 – Assigning users to groups in OKTA</p>
<ol>
<li value="6">Adapt the <strong class="source-inline">SecurityConfig.java</strong> class to override the default configuration. Then, use a converter to map the values in the <strong class="source-inline">groups</strong> attribute to <span class="P---Regular-Char">Spring</span><span class="P---Regular-Char"><a id="_idIndexMarker716"/></span><span class="P---Regular-Char"> </span><span class="No-Break"><span class="P---Regular-Char">Security authorities</span></span><span class="No-Break">.</span></li>
</ol>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/ SecurityConfig.java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
       http.authorizeRequests( authz -&gt; authz
         ... omitted for brevity
                   .requestMatchers(antMatcher("/errors/**")).permitAll()
                   .requestMatchers(antMatcher("/events/")).hasRole("ADMIN")
                   .requestMatchers(antMatcher("/**")).hasAuthority("Everyone"))
             .exceptionHandling(exceptions -&gt; exceptions
                   .accessDeniedPage("/errors/403"))
             .logout(form -&gt; form
                   .logoutUrl("/logout")
                  .logoutSuccessUrl("/")
                   .permitAll())
             .csrf(AbstractHttpConfigurer::disable);
       OpenSaml4AuthenticationProvider authenticationProvider = new OpenSaml4AuthenticationProvider();
       authenticationProvider.setResponseAuthenticationConverter(groupsConverter());
       // @formatter:off
       http
             .saml2Login(saml2 -&gt; saml2
                   .authenticationManager(new ProviderManager(authenticationProvider)))
             .saml2Logout(withDefaults());
       // For H2 Console
       http.headers(headers -&gt; headers.frameOptions(FrameOptionsConfig::disable));
       return http.build();
    }
    private Converter&lt;OpenSaml4AuthenticationProvider.ResponseToken, Saml2Authentication&gt; groupsConverter() {
       Converter&lt;ResponseToken, Saml2Authentication&gt; delegate =
             OpenSaml4AuthenticationProvider.createDefaultResponseAuthenticationConverter();
       return (responseToken) -&gt; {
          Saml2Authentication authentication = delegate.convert(responseToken);
          Saml2AuthenticatedPrincipal principal = (Saml2AuthenticatedPrincipal) authentication.getPrincipal();
          List&lt;String&gt; groups = principal.getAttribute("groups");
          Set&lt;GrantedAuthority&gt; authorities = new HashSet&lt;&gt;();
          if (groups != null) {
             groups.stream().map(SimpleGrantedAuthority::new).forEach(authorities::add);
          } else {
             authorities.addAll(authentication.getAuthorities());
          }
          return new Saml2Authentication(principal, authentication.getSaml2Response(), authorities);
       };
    }
}</pre> <ol>
<li value="7">Now, you <a id="_idIndexMarker717"/>should see your user’s groups as authorities. That comes from the OKTA SAML context related to the <span class="No-Break">authenticated user.</span><p class="list-inset">You will notice that with these changes, you will now have access to the <strong class="bold">All Events</strong> page when you log in with the <span class="No-Break">user </span><span class="No-Break"><strong class="source-inline">admin1@example.com</strong></span><span class="No-Break"><span class="P---Regular-Char">.</span></span></p></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like that <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">chapter10.05</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-222"><a id="_idTextAnchor329"/>Performing Single Logout</h1>
<p>Spring Security’s SAML support<a id="_idIndexMarker718"/> includes a logout feature that requires <span class="No-Break">some configuration.</span></p>
<p>You can use <strong class="source-inline">OpenSSL</strong> to create <a id="_idIndexMarker719"/>a private key and certificate. Ensure you provide a value for at least one of the questions during the process, and the setup should <span class="No-Break">be successful.</span></p>
<pre class="source-code">
openssl req -newkey rsa:2048 -nodes -keyout rp-private.key -x509 -days 365 -out rp-certificate.crt</pre> <p>Copy the generated files to your app’s <span class="No-Break"><strong class="source-inline">src/main/resources/credentials</strong></span><span class="No-Break"> directory.</span></p>
<p>Configure in <strong class="source-inline">application.yml</strong>, the generated key, the certificates location and the IdP’s logout configuration similar to <span class="No-Break">the following:</span></p>
<pre class="source-code">
spring:
  security:
    saml2:
      relyingparty:
        registration:
          okta:
            signing:
              credentials:
                - private-key-location: classpath:credentials/rp-private.key
                  certificate-location: classpath:credentials/rp-certificate.crt
            assertingparty:
              metadata-uri: https://dev-xxxxx.okta.com/app/ &lt;random-characters&gt;/sso/saml/metadata
            singlelogout:
              binding: POST
              url: "{baseUrl}/logout/saml2/slo"</pre> <p>On the <a id="_idIndexMarker720"/>OKTA <span class="No-Break">configuration</span><span class="No-Break"><a id="_idIndexMarker721"/></span><span class="No-Break"> page:</span></p>
<ol>
<li>Open the OKTA <span class="No-Break">Admin Console.</span></li>
<li>Choose <strong class="bold">Applications</strong> | <span class="No-Break"><strong class="bold">Applications</strong></span><span class="No-Break">.</span></li>
<li>Go to the <strong class="bold">SAML </strong><span class="No-Break"><strong class="bold">Settings</strong></span><span class="No-Break"> section:</span><ol><li class="upper-roman">Click <strong class="bold">Show </strong><span class="No-Break"><strong class="bold">Advanced Settings</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Choose <strong class="bold">Allow application to initiate Single Logout</strong> for <strong class="bold">Enable </strong><span class="No-Break"><strong class="bold">Single Logout</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Set <strong class="bold">Single Logout URL</strong>. For <span class="No-Break">example, </span><span class="No-Break"><strong class="source-inline">https://localhost:8443/logout/saml2/slo</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Set <strong class="bold">SP Issuer</strong> to a URL. For <span class="No-Break">example, </span><span class="No-Break"><strong class="source-inline">https://localhost:8443/saml2/service-provider-metadata/okta</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Click <a id="_idIndexMarker722"/>the <strong class="bold">Browse</strong> button for <strong class="bold">Signature Certificate</strong>, locate the <strong class="source-inline">local.crt</strong> file you <a id="_idIndexMarker723"/>created in the previous steps, and click <span class="No-Break"><strong class="bold">Upload Certificate</strong></span><span class="No-Break">.</span></li></ol></li>
<li><span class="No-Break">Click </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer087">
<img alt="Figure 10.10 – Single Logout configuration with OKTA" height="1449" src="image/B21757_10_10.jpg" width="1367"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.10 – Single Logout configuration with OKTA</p>
<ol>
<li value="5"><span class="No-Break">Click </span><span class="No-Break"><strong class="bold">Finish</strong></span><span class="No-Break">.</span></li>
<li>Restart <a id="_idIndexMarker724"/>the Spring Boot<a id="_idIndexMarker725"/> application. You can now log out from OKTA <span class="No-Break">as well.</span></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">As the SAML 2.0 specification permits multiple values for each attribute, you have the option to use either <strong class="source-inline">getAttribute</strong> to retrieve the list of attributes or <strong class="source-inline">getFirstAttribute</strong> to obtain the first value in the list. The <strong class="source-inline">getFirstAttribute</strong> method proves particularly useful when it’s known that there is only <span class="No-Break">one value.</span></p>
<p class="callout">Your code should now look like that <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">chapter10.06-calendar</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-223"><a id="_idTextAnchor330"/>Summary</h1>
<p>This chapter delved into the realm of <strong class="bold">SAML</strong>, a robust standard for achieving SSO in modern identity management. Beginning with an introduction to SAML’s foundational principles, it progressed to practical implementation, guiding developers through the seamless integration of <strong class="bold">SAML 2</strong> Login within the Spring <span class="No-Break">Security framework.</span></p>
<p>Key highlights included the practical steps involved in adding a <strong class="bold">SAML</strong> application on OKTA, a widely used IdP, and the creation of user principals within OKTA for streamlined user management. Essential dependencies for successful <strong class="bold">SAML</strong> integration were outlined, emphasizing the crucial tools and libraries for building a resilient <span class="No-Break">authentication system.</span></p>
<p>You have gained insights into critical configuration steps, such as specifying IdP metadata to ensure a standardized and secure communication channel. The chapter explored the retrieval of the <strong class="bold">SAML 2</strong> authenticated principal and parsing <strong class="bold">SAML 2</strong> metadata, and producing <strong class="bold">SAML 2</strong> metadata, providing a comprehensive understanding of the technical <span class="No-Break">intricacies involved.</span></p>
<p>Flexibility in <strong class="bold">SAML</strong> integration was introduced through a demonstration of customizing the lookup process for <strong class="source-inline">RelyingPartyRegistration</strong>, overriding <strong class="bold">SAML</strong> Spring Boot auto-configuration, and creating a custom <strong class="source-inline">RelyingPartyRegistrationRepository</strong> for advanced customization. Practical guidance was provided on customizing authorities within Spring Security SAML, enabling the effective management of <span class="No-Break">user roles.</span></p>
<p>This chapter concluded by addressing the crucial aspect of Single Logout, showcasing how SAML supports a standardized mechanism for logging out users across various services. In essence, this chapter equips you with the knowledge and practical insights needed to implement SAML-based authentication, fostering a secure and seamless identity management experience in <span class="No-Break">your applications.</span></p>
<p>In the next chapter, we’ll learn more about Spring <span class="No-Break">Security authorization.</span></p>
</div>
</div>

<div id="sbo-rt-content"><div class="Content" id="_idContainer089">
<h1 id="_idParaDest-224" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor331"/>Part 4: Enhancing Authorization Mechanisms</h1>
<p>This part delves into fine-grained access control, exploring various methods to implement precise authorization that may impact specific sections of an application page. Initially, we examine two approaches for implementing fine-grained authorization. Subsequently, we explore Spring Security’s methodology for securing the business tier through method annotation, utilizing interface-based proxies for <strong class="bold">Aspect-Oriented Programming</strong> (<strong class="bold">AOP</strong>). Furthermore, we investigate annotation-based security’s capability for role-based filtering on data collections. Lastly, we compare class-based proxies with <span class="No-Break">interface-based proxies.</span></p>
<p>Within this section, we delve into the intricate topic of <strong class="bold">Access Control Lists</strong> (<strong class="bold">ACLs</strong>), offering a comprehensive overview of their potential for domain object instance-level authorization. Spring Security offers a robust, albeit complex, ACL module that effectively caters to the needs of small to <span class="No-Break">medium-sized implementations.</span></p>
<p>Moreover, we undertake the task of crafting custom implementations for Spring Security’s essential authorization APIs. This hands-on approach enables a deeper understanding of Spring Security’s <span class="No-Break">authorization architecture.</span></p>
<p>This part has the <span class="No-Break">following chapters:</span></p>
<ul>
<li><a href="B21757_11.xhtml#_idTextAnchor332"><em class="italic">Chapter 11</em></a>, <em class="italic">Fine-Grained Access Control</em></li>
<li><a href="B21757_12.xhtml#_idTextAnchor375"><em class="italic">Chapter 12</em></a>, <em class="italic">Access Control Lists</em></li>
<li><a href="B21757_13.xhtml#_idTextAnchor415"><em class="italic">Chapter 13</em></a>, <em class="italic">Custom Authorization</em></li>
</ul>
</div>
<div>
<div id="_idContainer090">
</div>
</div>
<div>
<div class="Basic-Graphics-Frame" id="_idContainer091">
</div>
</div>
</div></body></html>