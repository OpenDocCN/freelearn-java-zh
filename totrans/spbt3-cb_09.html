<html><head></head><body>
		<div id="_idContainer118">
			<h1 class="chapter-number" id="_idParaDest-371"><a id="_idTextAnchor407"/>9</h1>
			<h1 id="_idParaDest-372"><a id="_idTextAnchor408"/>Upgrading from Spring Boot 2.x to Spring Boot 3.0</h1>
			<p>Most of the time invested in an application’s lifetime is related to maintenance. A successful application may last for years or decades. During this time, it may require upgrades for its evolution. You probably have an application that you want to evolve by taking advantage of the Spring Boot 3 features. In this chapter, we’ll use a sample application that I created using Spring Boot 2.6 and perform gradual upgrades in each recipe. The recipes in this chapter should be done in order, as we’ll use the outcome of one recipe as the starting point for the next. A couple of recipes won’t produce a working version, as there can be compilation errors to be fixed in the following recipes. The last recipe, <em class="italic">Using OpenRewrite for migration automation</em>, can be done without completing any previous recipes. However, it requires some of the manual actions explained in the <span class="No-Break">previous recipes.</span></p>
			<p>In this chapter, we’re going to cover the <span class="No-Break">following</span><span class="No-Break"> recipes:</span></p>
			<ul>
				<li>Preparing <span class="No-Break">the application</span></li>
				<li>Preparing <span class="No-Break">Spring Security</span></li>
				<li>Detecting <span class="No-Break">property changes</span></li>
				<li>Upgrade the project to Spring <span class="No-Break">Boot 3</span></li>
				<li>Upgrading <span class="No-Break">Spring Data</span></li>
				<li>Managing <span class="No-Break">Actuator changes</span></li>
				<li>Managing web <span class="No-Break">application changes</span></li>
				<li>Using OpenRewrite for <span class="No-Break">migration automation</span></li>
			</ul>
			<h1 id="_idParaDest-373"><a id="_idTextAnchor409"/>Technical requirements</h1>
			<p>In this chapter, we won’t need any additional tools apart from the JDK and the IDE, as in the <span class="No-Break">previous chapters.</span></p>
			<p>Keep in mind that Spring Boot 3.0 requires Java 17 or a later version. To migrate an existing project to Spring Boot 3.0 and use Java 11, you must upgrade to <span class="No-Break">Java 17.</span></p>
			<p>Before migrating to Spring Boot 3.0, I recommend that you upgrade to the latest Spring Boot 2 <span class="No-Break">version, 2.7.x.</span></p>
			<p>In this chapter, we’ll use a Spring Boot 2 sample and make changes to it until it’s finally migrated to the latest version of Spring Boot 3. This application accesses a PostgreSQL database and a Cassandra database. We’ll run both servers using Docker. The official page for running Docker on your computer is <a href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a>. The application has some Testcontainers-based tests, so that you will need Docker on <span class="No-Break">your computer.</span></p>
			<p>To run PostgreSQL on Docker, you can run the following command in <span class="No-Break">your terminal:</span></p>
			<pre class="console">
docker run -itd -e POSTGRES_USER=packt -e POSTGRES_PASSWORD=packt \
-p 5432:5432 --name postgresql postgres</pre>			<p>You will need to create a database named <strong class="source-inline">football</strong>. You can do this by running the following <span class="No-Break">PSQL command:</span></p>
			<pre class="console">
CREATE DATABASE football;</pre>			<p>To run Cassandra on Docker, you can run the following command in <span class="No-Break">your terminal:</span></p>
			<pre class="console">
docker run -p 9042:9042 --name cassandra -d cassandra:latest</pre>			<p><a id="_idTextAnchor410"/><a id="_idTextAnchor411"/><a id="_idTextAnchor412"/>All the recipes that will be demonstrated in this chapter can be found <span class="No-Break">at: </span><a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/tree/main/chapter9"><span class="No-Break">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/tree/main/chapter9</span></a><span class="No-Break">.</span></p>
			<p>Next, we will learn about preparing <span class="No-Break">the application.</span></p>
			<h1 id="_idParaDest-374"><a id="_idTextAnchor413"/>Preparing the application</h1>
			<p>On each version of <a id="_idIndexMarker968"/>Spring Boot, some components are marked for deprecation, and normally, there is a proposal for change to avoid the deprecated components. As upgrading from Spring Boot 2 to Spring Boot 3 is a major change, upgrading to the latest Spring Boot 2 version is <span class="No-Break">strongly recommended.</span></p>
			<p>Before migrating an application to Spring Boot 3, the following preparation <span class="No-Break">is recommended:</span></p>
			<ul>
				<li>Upgrade the Spring Boot version to the latest 2.7.x available. At the time of writing this book, it is 2.7.18. This will facilitate the upgrade to Spring <span class="No-Break">Boot 3</span></li>
				<li>Update the Java version to Java 17, the minimum supported version in Spring <span class="No-Break">Boot 3.</span></li>
				<li>Address all <span class="No-Break">deprecated components.</span></li>
			</ul>
			<p>In this recipe, we’ll prepare a sample application that uses Spring 2.6 and Java 11. By the end of the recipe, the application will use Spring 2.7.18, Java 17, and all deprecated components and APIs will <span class="No-Break">be addressed.</span></p>
			<h2 id="_idParaDest-375"><a id="_idTextAnchor414"/>Getting ready</h2>
			<p>You will <a id="_idIndexMarker969"/>prepare an application using Spring 2.6 and Java 11 in this recipe. The sample application is in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/football</strong></span><span class="No-Break"> folder.</span></p>
			<p>Depending on your operating system, you may use different tools to manage the current JDK version. For instance, you can use SDKMAN! tool<a id="_idIndexMarker970"/> on Linux and Mac. You can install it by following the instructions on the project page <span class="No-Break">at </span><a href="https://sdkman.io/"><span class="No-Break">https://sdkman.io/</span></a><span class="No-Break">.</span></p>
			<p>To run the application, you will need a PostgreSQL server running on your computer. To acquire this, follow the instructions in the <em class="italic">Technical </em><span class="No-Break"><em class="italic">requirements</em></span><span class="No-Break"> section.</span></p>
			<h2 id="_idParaDest-376"><a id="_idTextAnchor415"/>How to do it...</h2>
			<p>Let’s put the application at the starting line. Ready, <span class="No-Break">steady, go!</span></p>
			<ol>
				<li>First, we’ll address all deprecation warnings. For instance, if you compile the football project by executing <strong class="source-inline">mvn compile</strong>, you will see one deprecation warning about the <strong class="source-inline">DataSourceInitializationMode</strong> class. If you open the documentation of that class at <a href="https://docs.spring.io/spring-boot/docs/2.6.15/api/org/springframework/boot/jdbc/DataSourceInitializationMode.html">https://docs.spring.io/spring-boot/docs/2.6.15/api/org/springframework/boot/jdbc/DataSourceInitializationMode.html</a>, you will see the <span class="No-Break">following information:</span><p class="list-inset"><span class="No-Break"><strong class="bold">Deprecated.</strong></span></p><p class="list-inset"><strong class="bold">since 2.6.0 for removal in 3.0.0 in favor </strong><span class="No-Break"><strong class="bold">of DatabaseInitializationMode</strong></span></p><p class="list-inset">You can see this information directly in the editor if you use an IDE, such as IntelliJ or <a id="_idIndexMarker971"/>Visual Studio Code. For instance, in Visual Studio Code, you would see <span class="No-Break">the following:</span></p></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer111">
					<img alt="Figure 9.1﻿: Deprecation message in Visual Studio Code" src="image/B21646_09_1.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.1: Deprecation message in Visual Studio Code</p>
			<ol>
				<li value="2">Now, let’s replace <strong class="source-inline">DataSourceInitializationMode</strong> with <strong class="source-inline">DatabaseInitializationMode</strong>. This change is very straightforward, as just a simple replacement is enough. Other deprecation changes may require some code refactoring. Usually, the deprecated class documentation guides the implementation of <span class="No-Break">the changes.</span></li>
				<li>The next<a id="_idIndexMarker972"/> step will be updating the Spring Boot version to 2.7.18. For that, open the <strong class="source-inline">pom.xml</strong> file and find the following <span class="No-Break">code snippet:</span><pre class="source-code">
&lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
    <strong class="bold">&lt;version&gt;2.6.15&lt;/version&gt;</strong>
    &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
&lt;/parent&gt;</pre><p class="list-inset">That refers to the Spring Boot version in use. In the highlighted code, you can see that the actual version is 2.6.15. Let’s update it to the latest version 2 available. At the time of writing this book, it <span class="No-Break">is 2.7.18.</span></p><p class="list-inset">If you recompile the application, you will see some deprecation warnings related to Spring Security in the <strong class="source-inline">SecurityConfiguration.java</strong> file. We’ll fix those warnings in the <em class="italic">Upgrading Spring </em><span class="No-Break"><em class="italic">Security</em></span><span class="No-Break"> recipe.</span></p></li>				<li>Now, update the Java version to Java 17. You should ensure you are using the <span class="No-Break">JDK 17:</span><ul><li>If you are on Linux or Mac, you can <span class="No-Break">use SDKMan!</span></li><li>On Windows, you may have to update the Java Home <span class="No-Break">environment variable.</span></li><li>Regardless of the operating system, you can manage the Java version using <span class="No-Break">the IDE:</span><ul><li>For instance, in Visual Studio Code, you can follow the instructions at <a href="https://code.visualstudio.com/docs/java/java-project#_configure-runtime-for-projects">https://code.visualstudio.com/docs/java/java-project#_configure-runtime-for-projects</a> to configure the Java runtime for <span class="No-Break">your project.</span></li><li>In IntelliJ, you can follow the instructions at https://www.jetbrains.com/help/idea/sdk.html#manage_sdks for <span class="No-Break">this purpose.</span></li></ul></li></ul><p class="list-inset">You should<a id="_idIndexMarker973"/> change the Java version in your project as well. For that, open the <strong class="source-inline">pom.xml</strong> file and look for the <span class="No-Break">property </span><span class="No-Break"><strong class="source-inline">java.version</strong></span><span class="No-Break">:</span></p><pre class="source-code">
&lt;properties&gt;
<strong class="bold">    &lt;java.version&gt;11&lt;/java.version&gt;</strong>
    &lt;testcontainers.version&gt;1.19.7&lt;/testcontainers.version&gt;
&lt;/properties&gt;</pre><p class="list-inset">Replace the <strong class="source-inline">java.version</strong> property <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">17</strong></span><span class="No-Break">.</span></p></li>				<li>Build the application again and verify that the only deprecation warnings are related to Spring Security in the <strong class="source-inline">SecurityConfiguration.java</strong> file. Again, if there are other deprecation warnings, try to use the alternative solution proposed by the deprecation <span class="No-Break">warning message.</span></li>
			</ol>
			<h2 id="_idParaDest-377"><a id="_idTextAnchor416"/>How it works...</h2>
			<p>Every time there is a new version, there can be components marked for deprecation, and as we saw in this recipe, usually, it’s also known in which version they will be removed from. It’s convenient to install the upgrades gradually and not skip intermediate versions. As we saw in this example, migrating all revision versions, such as 2.7.1, 2.7.2, and so on, is unnecessary. However, you should not skip minor versions, such as 2.7.x, as there can be new components marked for deprecation that will be removed in version 3. Skipping the 2.7 upgrade won’t let you see the warning and the alternative <a id="_idIndexMarker974"/>replacement. Suddenly, you will find that the class you used is <span class="No-Break">not found.</span></p>
			<h2 id="_idParaDest-378"><a id="_idTextAnchor417"/>See also</h2>
			<p>Spring Boot 3.0 uses Spring Framework 6.0. If your project has explicit dependencies on prior versions, you will also need to upgrade them. You can find the migration guide for Spring <a id="_idIndexMarker975"/>Framework <span class="No-Break">at </span><a href="https://github.com/spring-projects/spring-framework/wiki/Upgrading-to-Spring-Framework-6.x"><span class="No-Break">https://github.com/spring-projects/spring-framework/wiki/Upgrading-to-Spring-Framework-6.x</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-379"><a id="_idTextAnchor418"/>Preparing Spring Security</h1>
			<p>The main change regarding<a id="_idIndexMarker976"/> security in Spring Boot 3 is the upgrading from Spring Security 5 to Spring Security 6. There are many changes related to this upgrade, but in the recipe, we’ll focus on the most common one, which is how <span class="No-Break">it’s configured.</span></p>
			<p>In Spring Security 5, most of the settings were configured by extending the <strong class="source-inline">WebSecurityConfigurerAdapter</strong> class, and in Spring Security 6, those changes are applied by configuring specific beans in <span class="No-Break">our application.</span></p>
			<p>In this recipe, we’ll transform the <strong class="source-inline">WebSecurityConfigurerAdapter</strong> class into a configuration class that exposes the beans to apply an <span class="No-Break">equivalent configuration.</span></p>
			<h2 id="_idParaDest-380"><a id="_idTextAnchor419"/>Getting ready</h2>
			<p>The starting point of this recipe is the outcome of the <em class="italic">Preparing the application</em> recipe. I prepared a working version in case you haven’t completed it yet. You can find it in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/recipe9-2/start</strong></span><span class="No-Break"> folder.</span></p>
			<h2 id="_idParaDest-381"><a id="_idTextAnchor420"/>How to do it...</h2>
			<p>Let’s complete the preparation of our application by adapting the deprecated components related to <span class="No-Break">Spring Security:</span></p>
			<ol>
				<li>If you compile the project as-is now, you will see that the <strong class="source-inline">SecurityConfig</strong> class contains some deprecation warnings. Let’s <span class="No-Break">tackle them:</span><ul><li>The <strong class="source-inline">WebSecurityConfigurerAdapter</strong> class is deprecated. Now, the application won’t extend <span class="No-Break">any class.</span></li><li>The <strong class="source-inline">withDefaultPasswordEncoder</strong> method is deprecated and not recommended for production environments. However, as the documentation states, it’s acceptable for demos and getting started. We won’t <span class="No-Break">change it.</span></li></ul></li>
				<li>The <strong class="source-inline">SecurityConfig</strong> class is annotated with <strong class="source-inline">@EnableWebSecurity</strong>. In addition, it <a id="_idIndexMarker977"/>should be annotated with <strong class="source-inline">@Configuration</strong>. It should look <span class="No-Break">like this:</span><pre class="source-code">
<strong class="bold">@Configuration</strong>
@EnableWebSecurity
public class SecurityConfig</pre></li>				<li>Next, we’ll change the <strong class="source-inline">configure</strong> method that receives <strong class="source-inline">AuthenticationManagerBuilder</strong> as a parameter to create a method configuring an <span class="No-Break"><strong class="source-inline">InMemoryUserDetailsManager</strong></span><span class="No-Break"> bean:</span><pre class="source-code">
<strong class="bold">@Bean</strong>
<strong class="bold">InMemoryUserDetailsManager</strong> userDetailsManager() {
    UserDetails userAdmin = User.withDefaultPasswordEncoder()
            .username("packt")
            .password("packt")
            .roles("ADMIN")
            .build();
    UserDetails simpleUser = User.withDefaultPasswordEncoder()
            .username("user1")
            .password("user1")
            .roles("USER")
            .build();
    return new InMemoryUserDetailsManager(userAdmin, simpleUser);
}</pre></li>				<li>Now, we’ll <a id="_idIndexMarker978"/>replace the <strong class="source-inline">configure</strong> method that receives a <strong class="source-inline">WebSecurity</strong> with a method returning a <strong class="source-inline">WebSecurityCustomizer</strong> bean. It should look <span class="No-Break">like this:</span><pre class="source-code">
<strong class="bold">@Bean</strong>
<strong class="bold">WebSecurityCustomizer</strong> webSecurityCustomizer() {
    return (web) -&gt; web.ignoring()
            .antMatchers("/security/public/**");
}</pre></li>				<li>To complete the <strong class="source-inline">SecurityConfig</strong> class, we must replace the <strong class="source-inline">configure</strong> method receiving a <strong class="source-inline">HttpSecurity</strong> parameter with a method creating a <span class="No-Break"><strong class="source-inline">SecurityFilterChain</strong></span><span class="No-Break"> bean:</span><pre class="source-code">
<strong class="bold">@Bean</strong>
<strong class="bold">SecurityFilterChain</strong> filterChain(HttpSecurity http)
                                             throws Exception {
    return http
            .authorizeRequests(authorizeRequests -&gt; {
                try {
                    authorizeRequests
                            .antMatchers("/").permitAll()
                            .antMatchers("/security/private/**")
                                .hasRole("ADMIN")
                            .and()
                            .httpBasic();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }).build();
}</pre></li>				<li>Now, if we execute <a id="_idIndexMarker979"/>the tests, we’ll realize that the tests related to controllers using the <strong class="source-inline">@WebMvcTest</strong> annotation no longer work as expected. We’ll include the <strong class="source-inline">@Import</strong> annotation in the <strong class="source-inline">FootballControllerTest</strong> and <strong class="source-inline">SecurityControllerTest</strong> classes to <span class="No-Break">fix it.</span><ul><li><span class="No-Break"><strong class="source-inline">FootballControllerTest</strong></span><span class="No-Break">:</span><pre class="source-code">
@WebMvcTest(FootballController.class)
<strong class="bold">@Import(SecurityConfig.class)</strong>
class FootballControllerTest</pre></li><li><span class="No-Break"><strong class="source-inline">SecurityControllerTest</strong></span><span class="No-Break">:</span><pre class="source-code">@WebMvcTest(SecurityController.class)
<strong class="bold">@Import(SecurityConfig.class)</strong>
class SecurityControllerTest</pre></li></ul></li>				<li>Finally, execute the tests and verify that all of <span class="No-Break">them pass.</span></li>
			</ol>
			<h2 id="_idParaDest-382"><a id="_idTextAnchor421"/>How it works...</h2>
			<p>The main<a id="_idIndexMarker980"/> change is the deprecation of the <strong class="source-inline">WebSecurityConfigurerAdapter</strong> class. This class is removed in Spring Security 6 and, hence, from Spring Boot 3. In this recipe, we prepared the application for a smooth security migration to upgrade the project to Spring Boot 3. The new approach is to create beans for each security aspect we want <span class="No-Break">to configure.</span></p>
			<p>Spring Security 6 introduces new methods to replace the <strong class="source-inline">antMatcher</strong> method; for instance, the <strong class="source-inline">requestMatcher</strong> method. To avoid more changes in this stage, we haven’t replaced the <strong class="source-inline">antMatcher</strong> method yet. But we’ll do that once we upgrade to Spring Boot 3, as it will <span class="No-Break">be deprecated.</span></p>
			<p>We keep using <strong class="source-inline">withDefaultPasswordEncoder</strong> in this recipe. Although it’s deprecated and not recommended for production environments, using it in development environments is acceptable. The deprecation warning is present in Spring Boot 2, and this method won’t be removed any time soon. Deprecation was introduced to warn about usage in <span class="No-Break">production environments.</span></p>
			<p>As the security settings are now defined as a configuration class annotated with <strong class="source-inline">@Configuration</strong>, importing them into our <strong class="source-inline">@WebMvcTest</strong> tests is necessary. The <strong class="source-inline">@WebMvcTest</strong> annotation only loads the MVC-related components, and it doesn’t load <strong class="source-inline">SecurityConfig</strong> by default. For that reason, importing them into our <strong class="source-inline">@WebMvcTest</strong> tests <span class="No-Break">is necessary.</span></p>
			<h2 id="_idParaDest-383"><a id="_idTextAnchor422"/>See also</h2>
			<p>The upgrade from <a id="_idIndexMarker981"/>Spring Security 5 to Spring Security 6 includes more changes than the ones tackled in this recipe. You can find the full migration guide on the official website <span class="No-Break">at </span><a href="https://docs.spring.io/spring-security/reference/6.0/migration/index.html"><span class="No-Break">https://docs.spring.io/spring-security/reference/6.0/migration/index.html</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-384"><a id="_idTextAnchor423"/>Detecting property changes</h1>
			<p>As we learned in this book, one<a id="_idIndexMarker982"/> of the main tasks when developing a Spring Boot application is configuring its components. It’s important to note that every time a new component version is released, there may be changes to the properties. This is especially true when upgrading to a major version, such as from version 2.x to 3.0. Typically, the changes are gradual. For example, a property might be marked as <em class="italic">deprecated</em> in one version, meaning it will be removed in a future version. Therefore, it’s recommended not to skip any versions when upgrading. For instance, if you plan to upgrade from version 2.6 to version 3.2, it’s best to upgrade first to version 2.7, then to 3.0, then 3.1, and <span class="No-Break">finally 3.2.</span></p>
			<p>To address the property changes between versions, Spring Boot provides a tool named Spring Boot Properties Migrator. It’s a dependency that analyzes the application environment during the application start-up and prints <span class="No-Break">a diagnostic.</span></p>
			<p>In this recipe, we’ll <a id="_idIndexMarker983"/>use the Spring Boot Properties Migrator in our project to detect the deprecated properties in the configuration file and <span class="No-Break">fix them.</span></p>
			<h2 id="_idParaDest-385"><a id="_idTextAnchor424"/>Getting ready</h2>
			<p>We’ll start this recipe using the outcome of the <em class="italic">Preparing Spring Security</em> recipe. You can use the project I prepared as a starting point if you haven’t completed it yet. You can find it in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/recipe9-3/start</strong></span><span class="No-Break"> folder.</span></p>
			<p>You will need the PostgreSQL server and Cassandra running on your computer to run the application. For instructions, see the <em class="italic">Technical requirements</em> section in <span class="No-Break">this chapter.</span></p>
			<h2 id="_idParaDest-386"><a id="_idTextAnchor425"/>How to do it...</h2>
			<p>Our application uses deprecated properties; let’s fix them with Spring Boot <span class="No-Break">Properties Migrator!</span></p>
			<ol>
				<li>First, we’ll add the Spring Boot Properties Migrator dependency to our project. For that, open the <strong class="source-inline">pom.xml</strong> file and add the <span class="No-Break">following dependency:</span><pre class="source-code">
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-properties-migrator&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</pre></li>				<li>Next, you can <a id="_idIndexMarker984"/>run the application and see an error with the property in the properties file that should be migrated. For instance, I executed <strong class="source-inline">mvn spring-boot:run</strong> in the terminal and I received the <span class="No-Break">following message:</span></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer112">
					<img alt="Figure 9.2 – Error when executing the application with Spring Boot Properties Migration" src="image/B21646_09_2.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.2 – Error when executing the application with Spring Boot Properties Migration</p>
			<p class="list-inset">As you can see, we need to migrate the <strong class="source-inline">spring.datasource.initialization-mode</strong> property and use <span class="No-Break"><strong class="source-inline">spring.sql.init.mode</strong></span><span class="No-Break"> instead.</span></p>
			<ol>
				<li value="3">Then, we’ll replace the <strong class="source-inline">spring.datasource.initialization-mode</strong> property with <strong class="source-inline">spring.sql.init.mode</strong>. To do this, open the <strong class="source-inline">application.yml</strong> file, find the <strong class="source-inline">initialization-mode</strong> property, and remove it. Then, add the <strong class="source-inline">spring.sql.init.mode</strong> property. The <strong class="source-inline">spring</strong> configuration should look <span class="No-Break">like this:</span><pre class="source-code">
spring:
    application:
        name: football
    jpa:
        database-platform: org.hibernate.dialect.PostgreSQLDialect
        open-in-view: false
    datasource:
        url: jdbc:postgresql://localhost:5432/football
        username: packt
        password: packt
        hikari:
            maximum-pool-size: 4
  <strong class="bold">sql:</strong>
<strong class="bold">    init:</strong>
<strong class="bold">      mode: embedded</strong></pre><p class="list-inset">For clarity, I didn’t include the entire <strong class="source-inline">application.yml</strong> file. The complete file can be found<a id="_idIndexMarker985"/> in the book’s <span class="No-Break">GitHub repository.</span></p></li>				<li>The <strong class="source-inline">dataSourceInicitalizationMode</strong> parameter of the <strong class="source-inline">CustomDatasourceService</strong> class references the <strong class="source-inline">spring.datasource.initialization-mode</strong> configuration property. We must point to the new property, <strong class="source-inline">spring.sql.init.mode</strong>. For that, replace the <strong class="source-inline">@Value</strong> annotation in the constructor with the new property. It should look <span class="No-Break">like this:</span><pre class="source-code">
public CustomDatasourceService(<strong class="bold">@Value("${spring.sql.init.mode}")</strong> DatabaseInitializationMode dataSourceInitializationMode) {
    this.dataSourceInitializationMode = dataSourceInitializationMode;
}</pre></li>				<li>Now that the changes are applied, let’s execute the application again. You can do it by running the <strong class="source-inline">spring-boot:run</strong> command in <span class="No-Break">your terminal.</span><p class="list-inset">You will see that the application <span class="No-Break">runs normally.</span></p></li>
				<li>Now that the properties have been migrated, the last step is to remove the Spring Boot Properties Migration dependency. To do this, open the <strong class="source-inline">pom.xml</strong> file and remove the dependency you added in <span class="No-Break"><em class="italic">step 1</em></span><span class="No-Break">.</span></li>
			</ol>
			<h2 id="_idParaDest-387"><a id="_idTextAnchor426"/>How it works...</h2>
			<p>The Spring Boot<a id="_idIndexMarker986"/> Properties Migration dependency first tries to map the deprecated properties to the new ones when possible and then prints a warning. Without direct mapping to a new property, it throws an error and prints the issue. In this recipe, we used a dependency that Spring Boot Properties Migration cannot map automatically. For that reason, there was an error. Once fixed, the Spring Boot Migration doesn’t show any <span class="No-Break">additional errors.</span></p>
			<p>As the Spring Boot Properties Migration performs an additional check upon application start-up, it can slow down the application. Removing the Spring Boot Properties Migration from your application is a good practice once the deprecated prope<a id="_idTextAnchor427"/>rties <span class="No-Break">are fixed.</span></p>
			<h1 id="_idParaDest-388"><a id="_idTextAnchor428"/>Upgrade the project to Spring Boot 3</h1>
			<p>In <a id="_idIndexMarker987"/>this recipe, we’ll take the first steps in Spring Boot 3 by <a id="_idIndexMarker988"/>updating the references in our project. When we update to Spring Boot 3, we’ll see some compilation errors that need to be addressed; in this recipe, we’ll take the first steps toward <span class="No-Break">fixing them.</span></p>
			<p>Spring Boot 3 depends on Jakarta EE 9 or a later version, while Spring Boot relies on Jakarta 7 and 8. In Jakarta 9, all namespaces changed from <strong class="source-inline">javax.*</strong> to <strong class="source-inline">jakarta.*</strong>. This is probably the biggest impact that can be seen when upgrading to Spring Boot 3, as it requires changing many references in <span class="No-Break">our projects.</span></p>
			<p>In this recipe, we’ll finally upgrade our project to Spring Boot 3, which will require updating all <strong class="source-inline">javax</strong> namespace references to <strong class="source-inline">jakarta</strong>. We’ll also perform the latest updates to Spring Security. By the end of this recipe, the application won’t work yet; you must complete two recipes, <em class="italic">Upgrading Spring Data</em> and <em class="italic">Managing Actuator changes</em>, to make <span class="No-Break">it work.</span></p>
			<h2 id="_idParaDest-389"><a id="_idTextAnchor429"/>Getting ready</h2>
			<p>We’ll use<a id="_idIndexMarker989"/> the outcome of the <em class="italic">Detecting property changes</em> recipe <a id="_idIndexMarker990"/>as the starting point for this recipe. You can use the version I prepared if you haven’t completed it yet. You can find it in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/recipe9-4/start</strong></span><span class="No-Break"> folder.</span></p>
			<h2 id="_idParaDest-390"><a id="_idTextAnchor430"/>How to do it...</h2>
			<p>We’ll upgrade the application to Spring Boot 3, and we’ll see the Jakarta EE-related errors. Let’s fix them and start using Spring <span class="No-Break">Boot 3!</span></p>
			<ol>
				<li>First, we’ll upgrade the project to use Spring Boot 3. For that, open the <strong class="source-inline">pom.xml</strong> file and find the following <span class="No-Break">code snippet:</span><pre class="source-code">
&lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
    <strong class="bold">&lt;version&gt;2.7.18&lt;/version&gt;</strong>
    &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
&lt;/parent&gt;</pre><p class="list-inset">You should replace the version property with the latest Spring Boot version, which, at the time of writing this book, <span class="No-Break">is 3.2.4.</span></p></li>				<li>You will see that the project doesn’t compile, as all references to <strong class="source-inline">javax.*</strong> namespaces no longer work. To fix it, replace <strong class="source-inline">javax</strong> with <strong class="source-inline">jakarta</strong> in all files. There are a significant number of changes to make, so I recommend using the replace features of your favorite editor. For instance, you can use the <strong class="bold">Search: Replace in files</strong> command in Visual <span class="No-Break">Studio Code:</span></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer113">
					<img alt="Figure 9.3 ﻿: Replacing javax with jakarta in files in Visual Studio Code" src="image/B21646_09_3.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.3 : Replacing javax with jakarta in files in Visual Studio Code</p>
			<ol>
				<li value="3">If you<a id="_idIndexMarker991"/> try to compile the project, you will see that there<a id="_idIndexMarker992"/> are still three files with <span class="No-Break">compilation errors:</span><ul><li><strong class="source-inline">MatchEventEntity.java</strong>: There are errors related to fields mapped as JSON in the database. This issue will be tackled in the <em class="italic">Upgrading Spring </em><span class="No-Break"><em class="italic">Data</em></span><span class="No-Break"> recipe.</span></li><li><strong class="source-inline">FootballConfig.java</strong>: There are errors related to <strong class="source-inline">HttpTrace</strong>. This issue will be fixed in the <em class="italic">Managing Actuator </em><span class="No-Break"><em class="italic">changes</em></span><span class="No-Break"> recipe.</span></li><li><strong class="source-inline">SecurityConfig.java</strong>: There are new errors related to Spring Security changes that we’ll fix in the <span class="No-Break">following step.</span></li></ul></li>
				<li>To fix the issues with the <strong class="source-inline">SecurityConfig</strong> class, we need to do <span class="No-Break">the following:</span><ul><li>Replace the <strong class="source-inline">antMatchers</strong> call with a <strong class="source-inline">requestMatchers</strong> call in the <strong class="source-inline">webSecurityCustomizer</strong> method. It should look <span class="No-Break">like this:</span><pre class="source-code">
@Bean
WebSecurityCustomizer webSecurityCustomizer() {
    return (web) -&gt; web.ignoring()
            .<strong class="bold">requestMatchers</strong>("/security/public/**");
}</pre></li><li>In <a id="_idIndexMarker993"/>the <strong class="source-inline">filterChain</strong> method, we need to make <a id="_idIndexMarker994"/><span class="No-Break">several changes:</span><ul><li>Replace <strong class="source-inline">authorizeRequests</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">authorizeHttpRequests</strong></span><span class="No-Break">.</span></li><li>Replace the <strong class="source-inline">requestMatchers("/")</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">anyRequest()</strong></span><span class="No-Break">.</span></li><li>Replace the <strong class="source-inline">antMatchers</strong> call with <span class="No-Break">a </span><span class="No-Break"><strong class="source-inline">requestsMatchers</strong></span><span class="No-Break">.</span></li><li>We need to switch the call order in the previous <span class="No-Break">two calls.</span></li><li>Remove the <strong class="source-inline">and</strong> call and just chain <strong class="source-inline">authorizeHttpRequests</strong> with the <span class="No-Break"><strong class="source-inline">httpBasic</strong></span><span class="No-Break"> call.</span></li></ul><pre class="source-code">@Bean
SecurityFilterChain filterChain(HttpSecurity http)
                                             throws Exception {
    return http
            .authorizeHttpRequests(authorizeRequests -&gt; {
                authorizeRequests
                        .requestMatchers("/security/private/**")
                              .hasRole("ADMIN")
                        .anyRequest().permitAll();
            })
            .httpBasic(withDefaults())
            .build();
}</pre></li></ul></li>			</ol>
			<h2 id="_idParaDest-391"><a id="_idTextAnchor431"/>How it works...</h2>
			<p>Jakarta EE was<a id="_idIndexMarker995"/> formerly <strong class="bold">Java EE</strong>, which stands for <strong class="bold">Java Enterprise Edition</strong>. Java EE is a set of API specifications for building enterprise-grade <a id="_idIndexMarker996"/>applications. You can<a id="_idIndexMarker997"/> build your application based on these specifications and select the vendor implementation that fits your requirements without changing your code or with little changes. In 2017, Oracle transferred Java EE to the Eclipse Foundation and then changed its name to Jakarta EE. With Jakarta EE version 9, the package names shifted from <strong class="source-inline">javax</strong> to <strong class="source-inline">jakarta</strong>, allowing Jakarta EE to evolve independently from Oracle, as it keeps some Java trademarks. These changes only imply namespace changes, and there are no behavior changes. For that reason, the application works just by replacing <span class="No-Break">the namespaces.</span></p>
			<p>In this recipe, we moved from Spring Boot 2.7.18 directly to Spring Boot 3.2.4. If we first moved to intermediate versions, we would see the Spring Security-related errors as deprecation warnings. As we know the mechanism for gradual deprecation and upgrades, I decided to skip the intermediate versions for brevity. I recommend that you perform gradual migrations in your projects. The deprecation warning messages can guide most of the changes. However, there’s a change that’s not very evident. In Spring Boot 6, the <strong class="source-inline">permitAll</strong> method is deprecated for <strong class="source-inline">requestMatcher</strong> and should be replaced by <strong class="source-inline">anyRequest</strong>, and this method should be called at the end of the chain; if you chain more matchers after, an exception is thrown <span class="No-Break">during runtime.</span></p>
			<h1 id="_idParaDest-392"><a id="_idTextAnchor432"/>Upgrading Spring Data</h1>
			<p>Spring Boot 3 uses<a id="_idIndexMarker998"/> Hibernate 6.1 by default, while Spring Boot 2 uses Hibernate 5. Therefore, we need to prepare the application to match <span class="No-Break">Hibernate 6.1.</span></p>
			<p>Hibernate uses Jakarta EE, and that requires upgrading the <strong class="source-inline">javax.*</strong> namespaces to <strong class="source-inline">jakarta.*</strong>, but we already did this step in the <em class="italic">First step to Spring </em><span class="No-Break"><em class="italic">3.0</em></span><span class="No-Break"> recipe.</span></p>
			<p>Some changes in Hibernate 6.1 are internal, but some APIs changed and should be upgraded in <span class="No-Break">the application.</span></p>
			<p>Some changes related to the configuration of Spring Data are specific <span class="No-Break">to Cassandra.</span></p>
			<p>In this recipe, we’ll make the necessary changes to align the sample application with Hibernate 6.1 <span class="No-Break">and Cassandra.</span></p>
			<h2 id="_idParaDest-393"><a id="_idTextAnchor433"/>Getting ready</h2>
			<p>We’ll use the outcome of the <em class="italic">First step to Spring 3.0</em> recipe as the starting point for this recipe. You can use the version I created if you haven’t completed it yet. You can find it in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/recipe9-5/start</strong></span><span class="No-Break"> folder.</span></p>
			<p>As explained in the previous recipes, the sample application uses a PostgreSQL server database and Cassandra, and the tests use Testcontainers. For that reason, you need Docker running on <span class="No-Break">your computer.</span></p>
			<h2 id="_idParaDest-394"><a id="_idTextAnchor434"/>How to do it...</h2>
			<p>Let’s make the necessary Spring Data adjustments in <span class="No-Break">our application:</span></p>
			<ol>
				<li>We’ll start by fixing the configuration of <span class="No-Break">our application:</span><ul><li>We’ll replace <strong class="source-inline">PostgreSQL82Dialect</strong> with <strong class="source-inline">PostgreSQLDialect</strong>. To do that, we’ll open the <strong class="source-inline">application.yml</strong> file, locate the <strong class="source-inline">spring.jpa.database-platform</strong> property, and then set the <span class="No-Break">following value:</span><pre class="source-code">
spring:
  jpa:
    database-platform: <strong class="bold">org.hibernate.dialect.PostgreSQLDialect</strong></pre></li><li>We’ll <a id="_idIndexMarker999"/>fix the Cassandra settings: <strong class="source-inline">spring.data.cassandra.*</strong> settings now should be <strong class="source-inline">spring.cassandra.*</strong>. In the same <strong class="source-inline">application.yml</strong> file, ensure that the <strong class="source-inline">cassandra</strong> settings are defined <span class="No-Break">as follows:</span><pre class="source-code"><strong class="bold">spring</strong>:
    <strong class="bold">cassandra</strong>:
        keyspace-name: footballKeyspace
        schema-action: CREATE_IF_NOT_EXISTS
        contact-points: localhost
        local-datacenter: datacenter1
        session-name: cassandraSession
        port: 9042</pre></li></ul><p class="list-inset">Note that <strong class="source-inline">cassandra</strong> is now under <strong class="source-inline">spring</strong>. Previously, <strong class="source-inline">cassandra</strong> was <span class="No-Break">under </span><span class="No-Break"><strong class="source-inline">spring.data</strong></span><span class="No-Break">.</span></p></li>				<li>The tests based on Testcontainers create a Cassandra container and then set the settings of the application context. The tests should be aligned with the new settings structure with <strong class="source-inline">spring.cassandra</strong> instead of <strong class="source-inline">spring.data.cassandra</strong>. You can apply this change by using the string replace features in your editor. For instance, you can use the <strong class="bold">Search: Replace in files</strong> feature in Visual <span class="No-Break">Studio Code:</span></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer114">
					<img alt="Figure 9.4 ﻿: Replacing spring.data.cassandra references in Visual Studio Code" src="image/B21646_09_4.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.4 : Replacing spring.data.cassandra references in Visual Studio Code</p>
			<ol>
				<li value="3">Next, we’ll <a id="_idIndexMarker1000"/>use the new capability in Hibernate 6 to define JSON fields for our entities. To do that, open the <strong class="source-inline">MatchEventEntity</strong> class and modify the annotation of the <strong class="source-inline">details</strong> field <span class="No-Break">as follows:</span><pre class="source-code">
<strong class="bold">@JdbcTypeCode(SqlTypes.JSON)</strong>
private MatchEventDetails details;</pre><p class="list-inset">We replaced the <em class="italic">hypersistence utils</em> type to define the <span class="No-Break">JSON field.</span></p></li>				<li>As we no longer need the particular type to define the JSON field, you can remove the following dependency from the <span class="No-Break"><strong class="source-inline">pom.xml</strong></span><span class="No-Break"> file:</span><pre class="source-code">
&lt;dependency&gt;
    &lt;groupId&gt;io.hypersistence&lt;/groupId&gt;
    &lt;artifactId&gt;hypersistence-utils-hibernate-55&lt;/artifactId&gt;
    &lt;version&gt;3.7.3&lt;/version&gt;
&lt;/dependency&gt;</pre></li>				<li>At this point, we<a id="_idIndexMarker1001"/> want to leverage the project’s tests. However, there are some compilation errors related to the <strong class="source-inline">httptrace</strong> endpoint. We’ll now comment all the code in the <strong class="source-inline">FootballConfig</strong> class to avoid the compilation errors, and we’ll tackle this component in the <em class="italic">Managing Actuator </em><span class="No-Break"><em class="italic">changes</em></span><span class="No-Break"> recipe.</span></li>
				<li>Next, we’ll run the tests to verify that the application still works. You can run the tests from the IDE or just run the following Maven command in <span class="No-Break">your terminal:</span><pre class="source-code">
mvn test</pre><p class="list-inset">You will see that the tests related to the services succeed, but two tests, <strong class="source-inline">findPlayerById</strong> and <strong class="source-inline">countPlayers</strong>, fail. There are other tests related to the controllers that fail, but we’ll cover them in the <em class="italic">Managing web application changes</em> recipe. These tests fail due to some behavior changes in Hibernate 6. Let’s <span class="No-Break">fix them:</span></p><ul><li>The <strong class="source-inline">findPlayerById</strong> method in the <strong class="source-inline">DynamicQueriesService</strong> class uses an ordinal parameter binding. The behavior of ordinal parameters was changed in Hibernate 6. To fix this issue, modify <strong class="source-inline">findPlayerById</strong> in the <strong class="source-inline">DynamicQueriesService</strong> class <span class="No-Break">as follows:</span><pre class="source-code">public Player findPlayerById(Integer id) {
    Query query = em.createQuery(
                    "SELECT p FROM PlayerEntity p WHERE p.id=<strong class="bold">?1</strong>",
                    PlayerEntity.class);
    query.setParameter(<strong class="bold">1</strong>, id);
    return playerMapper.map((PlayerEntity)
                                  query.getSingleResult());
}</pre></li><li>The change <a id="_idIndexMarker1002"/>is subtle. In the query string, replace <strong class="source-inline">?0</strong> with <strong class="source-inline">?1</strong>; the parameter in the <strong class="source-inline">setParameter</strong> method is <strong class="source-inline">1</strong> instead <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">0</strong></span><span class="No-Break">.</span></li><li>The <strong class="source-inline">countPlayers</strong> test validates the method with the same name in the <strong class="source-inline">DynamicQueriesService</strong> class. To fix this test, do <span class="No-Break">the following:</span><ol><li class="lower-roman">First, change the <strong class="source-inline">return</strong> type of the <strong class="source-inline">countPlayers</strong> method in the <strong class="source-inline">DynamicQueriesService</strong> class from <strong class="source-inline">BigInteger</strong> to <strong class="source-inline">Long</strong>. It should look <span class="No-Break">like this:</span></li></ol><pre class="source-code">public Player findPlayerById(Integer id) {
    Query query = em.createQuery(
            "SELECT p FROM PlayerEntity p WHERE p.id=?1",
            PlayerEntity.class);
    query.setParameter(1, id);
    return playerMapper
            .map((PlayerEntity) query.getSingleResult());
}</pre></li></ul><ol><li class="lower-roman" value="2">Then, update the test to match the return type <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">Long</strong></span><span class="No-Break">:</span></li></ol><pre class="source-code">@Test
void countPlayers() {
    <strong class="bold">Long</strong> count = dynamicQueriesService.countPlayers();
    assertThat(count, not(0));
 }</pre><p class="list-inset">You can rerun the services-related tests, and now they <span class="No-Break">should succeed.</span></p></li>			</ol>
			<h2 id="_idParaDest-395"><a id="_idTextAnchor435"/>How it works...</h2>
			<p>Spring Data relies on Hibernate for most of its functionalities. In Spring Boot 3, it uses Hibernate 6.1 by default. For that reason, most of the tasks related to the Spring Data upgrade are related to the <span class="No-Break">Hibernate upgrade.</span></p>
			<p>One of the changes related to the Hibernate upgrade is the change in the references from <strong class="source-inline">javax.*</strong> to <strong class="source-inline">jakarta.*</strong>. We haven’t explained that in this recipe, as it was already covered in the <em class="italic">First step to Spring 3.0</em> recipe; you should keep it in mind when upgrading to Spring Boot 3 or <span class="No-Break">Hibernate 6.</span></p>
			<p>In Hibernate 6, the<a id="_idIndexMarker1003"/> property <strong class="source-inline">spring.jpa.database-platform</strong> no longer uses specific version values. For that reason, <strong class="source-inline">PostgreSQL82Dialect</strong> was deprecated and should be replaced with the database dialect without the version. As we use PostgreSQL as a relational database, we replaced <strong class="source-inline">PostgreSQL82Dialect</strong> with <strong class="source-inline">PostgreSQLDialect</strong>. If you use another database engine such as MySQL, you should use <strong class="source-inline">MySQLDialect</strong> without a <span class="No-Break">version-specific dialect.</span></p>
			<p>In Hibernate 6, the queries that return a <strong class="source-inline">BIGINT</strong> are now mapped to the <strong class="source-inline">Long</strong> type. In previous versions, they were incorrectly mapped to <strong class="source-inline">BigInteger</strong>. The result of the count clause is a <strong class="source-inline">BIGINT</strong>, so we need to change it in the <strong class="source-inline">countPlayers</strong> method. Even though the number of players in our application can be represented by an integer, if our tables were larger, it could cause a casting error <span class="No-Break">in runtime.</span></p>
			<p>Hibernate 6 changed how it binds the ordinal parameters and now uses 1-based ordering instead of <span class="No-Break">0-based ordering.</span></p>
			<p>Hibernate 6 introduced the possibility of defining entity fields mapped as JSON parameters if the database supports it. Before Hibernate 6, it was necessary to use third-party libraries, such as Hypersistence. This excellent library developed by Vlad Mihalcea was handy in the previous versions for JSON field management, but it’s no longer necessary in Hibernate 6. We can keep this dependency and upgrade it to the matching version for Hibernate 6. You can find more information <span class="No-Break">at </span><a href="https://github.com/vladmihalcea/hypersistence-utils"><span class="No-Break">https://github.com/vladmihalcea/hypersistence-utils</span></a><span class="No-Break">.</span></p>
			<p>There are <a id="_idIndexMarker1004"/>other changes related to Spring Data that are not related to Hibernate. For instance, the <strong class="source-inline">spring.data</strong> prefix for the properties is now reserved for Spring Data; for that reason, <strong class="source-inline">spring.data.cassandra</strong> has moved <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">spring.cassandra</strong></span><span class="No-Break">.</span></p>
			<p>In this recipe, we only covered the changes related to Spring Data for the features we used in this book. I recommend that you check the migration guide <span class="No-Break">at </span><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#data-access-changes"><span class="No-Break">https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#data-access-changes</span></a><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-396"><a id="_idTextAnchor436"/>There’s more...</h2>
			<p>Spring Boot 3 introduced some capabilities that facilitate the usage of standard database technologies in our applications. Before Spring Boot 3, we could use alternative solutions, and it’s unnecessary to migrate them; however, it is worth knowing they exist. In this section, we’ll <a id="_idIndexMarker1005"/>demonstrate two of them: stored procedures and union clauses<a id="_idIndexMarker1006"/> <span class="No-Break">in JQL.</span></p>
			<p>You can use the <strong class="source-inline">@Procedure</strong> annotation instead of the <strong class="source-inline">@Query</strong> annotation. The <strong class="source-inline">@Query</strong> annotation must be native and use the <strong class="source-inline">call</strong> clause. For instance, you can modify the <strong class="source-inline">getTotalPlayersWithMoreThanNMatches</strong> method of the <strong class="source-inline">PlayerRepository</strong> interface <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
<strong class="bold">@Procedure</strong>("FIND_PLAYERS_WITH_MORE_THAN_N_MATCHES")
Integer getTotalPlayersWithMoreThanNMatches(int num_matches);</pre>			<p>Hibernate 6 JQL now supports the <strong class="source-inline">Union</strong> clause. For instance, we can write <strong class="source-inline">findPlayersByMatchId</strong> in the <strong class="source-inline">MatchRepository</strong> interface <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
@Query("SELECT p1 FROM MatchEntity m JOIN m.team1 t1 JOIN t1.players p1 WHERE m.id = ?1 <strong class="bold">UNION</strong> SELECT p2 FROM MatchEntity m JOIN m.team2 t2 JOIN t2.players p2 WHERE m.id = ?1")
public List&lt;PlayerEntity&gt; findPlayersByMatchId(Integer matchId);</pre>			<h2 id="_idParaDest-397"><a id="_idTextAnchor437"/>See also</h2>
			<p>In this recipe, we covered some scenarios on the Hibernate 5 to 6 migration, but there are many more. If you find issues related to Hibernate in the migration of your projects, please take a look at the Hibernate <span class="No-Break">migration guides:</span></p>
			<ul>
				<li>Hibernate 6.0 <a id="_idIndexMarker1007"/>migration <span class="No-Break">guide: </span><a href="https://docs.jboss.org/hibernate/orm/6.0/migration-guide/migration-guide.html"><span class="No-Break">https://docs.jboss.org/hibernate/orm/6.0/migration-guide/migration-guide.html</span></a></li>
				<li>Hibernate 6.1 <a id="_idIndexMarker1008"/>migration <span class="No-Break">guide: </span><a href="https://docs.jboss.org/hibernate/orm/6.1/migration-guide/migration-guide.html"><span class="No-Break">https://docs.jboss.org/hibernate/orm/6.1/migration-guide/migration-guide.html</span></a></li>
			</ul>
			<h1 id="_idParaDest-398"><a id="_idTextAnchor438"/>Managing Actuator changes</h1>
			<p>Most of the <a id="_idIndexMarker1009"/>Actuator changes are related to the default behavior of the exposed endpoints. For instance, the JMX endpoint behavior is aligned with the web endpoint behavior; for that reason, it only exposes the <strong class="bold">Health</strong> endpoint by default, while previously, all JMX endpoints were exposed by default. If your project relies on that functionality, you must expose <span class="No-Break">it explicitly.</span></p>
			<p>In addition to Actuator’s default behavior, our project uses the <strong class="source-inline">httptrace</strong> endpoint, which changes the behavior and the required implementation. In this recipe, we’ll fix the <strong class="source-inline">httptrace</strong> endpoint and make the necessary configuration changes to keep the same behavior we had <span class="No-Break">for Actuator.</span></p>
			<h2 id="_idParaDest-399"><a id="_idTextAnchor439"/>Getting ready</h2>
			<p>To start this recipe, you will need the outcome of the previous recipe, <em class="italic">Upgrading Spring Data</em>. In case you haven’t completed it yet, I prepared a version that you can find in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/recipe9-6/start</strong></span><span class="No-Break"> folder.</span></p>
			<p>In addition to the requirements of our previous recipes, we’ll need a JMX client to explore the behavior of the Actuator’s JMX endpoints. We can use JConsole, which is part of <span class="No-Break">the JDK.</span></p>
			<h2 id="_idParaDest-400"><a id="_idTextAnchor440"/>How to do it...</h2>
			<p>We’ll first fix the <strong class="source-inline">httptrace</strong> endpoint, and then we’ll align the actuator to behave as in Spring <span class="No-Break">Boot 2:</span></p>
			<ol>
				<li>To fix the <strong class="source-inline">httptrace</strong> configuration, open the <strong class="source-inline">application.yml</strong> file and replace <span class="No-Break">the following:</span><ul><li>Replace the web endpoint <strong class="source-inline">httptrace</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">httpexchanges</strong></span><span class="No-Break">.</span></li><li>Replace the <strong class="source-inline">management.trace.http.enabled</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">management.httpexchanges.recording.enabled</strong></span><span class="No-Break">.</span></li><li>It <a id="_idIndexMarker1010"/>should look <span class="No-Break">like this:</span><pre class="source-code">
management:
  endpoints:
    web:
      exposure:
        include: health,env,metrics,beans,loggers,<strong class="bold">httpexchanges</strong>
  <strong class="bold">httpexchanges</strong>:
    <strong class="bold">recording</strong>:
      <strong class="bold">enabled</strong>: true</pre></li></ul><p class="list-inset">For clarity, I am not including the rest of the <span class="No-Break"><strong class="source-inline">application.yml</strong></span><span class="No-Break"> file.</span></p></li>				<li>Next, for the <strong class="source-inline">FootballConfig</strong> class, replace the <strong class="source-inline">HttpTraceRepository</strong> interface with <strong class="source-inline">HttpExchangeRepository</strong> and <strong class="source-inline">InMemoryHttpTraceRepository</strong> with <strong class="source-inline">InMemoryHttpExchangeRepository</strong>. Remember that we commented the contents of this class in the previous recipe to be able to compile the solution; now, we’ll tackle this component. The <strong class="source-inline">FootballConfig</strong> class should look <span class="No-Break">as follows:</span><pre class="source-code">
@Configuration
public class FootballConfig {
    @Bean
    public <strong class="bold">HttpExchangeRepository</strong> httpTraceRepository() {
        return new <strong class="bold">InMemoryHttpExchangeRepository</strong>();
    }
}</pre></li>				<li>We can now run the application and validate the new <strong class="source-inline">httpexchanges</strong> repository. To validate it, open it in your browser or execute a curl command with the address <strong class="source-inline">http://localhost:8080/actuator/httpexchanges</strong>. It should return the latest requests to <span class="No-Break">our application.</span></li>
				<li>Next, we’ll <a id="_idIndexMarker1011"/>validate whether the application exposes the same JMX endpoints as Spring Boot 2. While the application is running, run the JConsole tool. For that, open your terminal and run <strong class="source-inline">jconsole</strong>. You will see that it shows a list of the Java applications running on <span class="No-Break">your computer:</span></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer115">
					<img alt="Figure 9.5: JConsole process selection" src="image/B21646_09_5.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.5: JConsole process selection</p>
			<p class="list-inset">Select the <a id="_idIndexMarker1012"/>application and click <strong class="bold">Connect</strong>. A message indicating that the secure connection failed may appear, suggesting that you connect insecurely. Use the <span class="No-Break">insecure connection.</span></p>
			<p class="list-inset">If you open the <strong class="bold">MBeans</strong> tab, you’ll see that under the <strong class="source-inline">org.springframework.boot</strong> namespace, only the <strong class="bold">Health</strong> <span class="No-Break">endpoint appears:</span></p>
			<div>
				<div class="IMG---Figure" id="_idContainer116">
					<img alt="Figure 9.6: Default JMX endpoints exposed by Spring Boot 3" src="image/B21646_09_6.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.6: Default JMX endpoints exposed by Spring Boot 3</p>
			<p class="list-inset">Before Spring <a id="_idIndexMarker1013"/>Boot 3, all endpoints were enabled by default. To achieve the same behavior, open the <strong class="source-inline">application.yml</strong> file and set <strong class="source-inline">management.endpoints.jmx.exposure.include=*</strong> property. It should look <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
management:
    endpoints:
        jmx:
            exposure:
                include: '*'</pre>			<p class="list-inset">If you restart the application and connect to the application with JConsole, you will see that it now exposes all MBean endpoints, as in previous versions of <span class="No-Break">Spring Boot:</span></p>
			<div>
				<div class="IMG---Figure" id="_idContainer117">
					<img alt="Figure 9.7: All JMX endpoints exposed using Spring Boot 3" src="image/B21646_09_7.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.7: All JMX endpoints exposed using Spring Boot 3</p>
			<p>You can see the exposed<a id="_idIndexMarker1014"/> endpoints in <span class="No-Break"><em class="italic">Figure 9</em></span><span class="No-Break"><em class="italic">.7</em></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-401"><a id="_idTextAnchor441"/>How it works...</h2>
			<p>The Spring Boot team changed the name of <strong class="source-inline">httptrace</strong> to avoid confusion with <strong class="source-inline">Micrometer Tracing</strong>. For that reason, it has been renamed to <strong class="source-inline">http exchanges</strong>. That change also impacted the repository supporting the implementation of the traces. In this example, we used an in-memory repository, which we used only for demonstration purposes. In a production environment, you will probably use a <span class="No-Break">persistent repository.</span></p>
			<p>In Spring Boot 3, the JMX endpoint only exposes the <strong class="bold">Health</strong> endpoint to align with its web counterpart. Only the <strong class="bold">Health</strong> endpoint is exposed in the web endpoint in Spring Boot 3 and previous versions. Some endpoints can reveal sensitive information or provide unwanted access. All endpoints except the <strong class="bold">Health</strong> endpoint are not enabled to reduce the surface attack. In this recipe, we exposed all JMX endpoints. However, it’s recommended<a id="_idIndexMarker1015"/> that you only expose the ones that are <span class="No-Break">really necessary.</span></p>
			<h2 id="_idParaDest-402"><a id="_idTextAnchor442"/>See also</h2>
			<p>In this recipe, we covered some scenarios related to Actuator. Still, I recommend reviewing the Spring Boot 3 migration guide and verifying whether you use an Actuator feature from previous versions of Spring Boot that requires attention in Spring Boot 3. You can find the guide <span class="No-Break">at </span><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#actuator-changes"><span class="No-Break">https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#actuator-changes</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-403"><a id="_idTextAnchor443"/>Managing web application changes</h1>
			<p>Web applications, and hence<a id="_idIndexMarker1016"/> RESTful applications, as we mostly worked with in this book, have a few behavior changes between Spring Boot 2 and 3. Some of them may impact your application. Some changes are related to internal components, and you won’t be affected unless your application relies on those internal components. The changes between Spring Boot 2 and 3 are <span class="No-Break">as follows:</span></p>
			<ul>
				<li>The <strong class="source-inline">server.max-http-header-size</strong> property is a setting that indicates the maximum size that the headers of the requests managed by the application may have. That property was managed differently depending on the embedded web server used. It has been deprecated in favor of <strong class="source-inline">server.max-http-request-header-size,</strong> and it’s managed consistently by all possible embedded <span class="No-Break">web servers.</span></li>
				<li>The phases for graceful shutdown have changed. When an application is shut down, Spring Boot sends events in different phases, and the application can be subscribed to those events to perform custom <span class="No-Break">shutdown actions.</span></li>
				<li>If you use a Jetty-embedded web server instead of the default Tomcat, you will need to set the Servlet API to 5.0. Jetty does not yet support the Servlet API 6.0 used by default in Spring <span class="No-Break">Boot 3.</span></li>
				<li>The Spring Framework 6 used by Spring Boot 3 removed the support for Apache HttpClient. If you used Apache HttpClient in your application in previous versions of Spring Boot, you may notice <span class="No-Break">behavior changes.</span></li>
			</ul>
			<p>As mentioned, you <a id="_idIndexMarker1017"/>won’t notice these changes unless your application explicitly relies on some of these features. However, there is a behavior change that may impact your application. In versions before Spring Boot 3, the URLs ending with a <strong class="source-inline">/</strong> would match with controllers without that trailing slash. For instance, <strong class="source-inline">GET /teams</strong> and <strong class="source-inline">GET /teams/</strong> would match the same controller in our application. In Spring Boot 3 <strong class="source-inline">GET</strong> <strong class="source-inline">/teams/</strong> will fail unless we prepare the application <span class="No-Break">for that.</span></p>
			<p>In this recipe, we’ll prepare our application to manage the trailing slash of the requests as in previous versions to ensure that the clients relying on our application are not impacted by the Spring <span class="No-Break">Boot upgrade.</span></p>
			<h2 id="_idParaDest-404"><a id="_idTextAnchor444"/>Getting ready</h2>
			<p>We’ll use the outcome of the <em class="italic">Managing Actuator changes</em> recipe for this recipe. I prepared a completed version in case you haven’t done so yet. You may find it in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/recipe9-7/start</strong></span><span class="No-Break"> folder.</span></p>
			<h2 id="_idParaDest-405"><a id="_idTextAnchor445"/>How to do it...</h2>
			<p>Let’s ensure our application consumers don’t get disrupted by our upgrade to Spring <span class="No-Break">Boot 3!</span></p>
			<ol>
				<li>Let’s add a custom web configuration. For that, create a file named <strong class="source-inline">WebConfiguration</strong> that implements the <span class="No-Break"><strong class="source-inline">WebMvcConfigurer</strong></span><span class="No-Break"> interface:</span><pre class="source-code">
@Configuration
public class WebConfiguration implements <strong class="bold">WebMvcConfigurer</strong></pre><p class="list-inset">Then, override the <strong class="source-inline">configurePathMatch</strong> method <span class="No-Break">as follows:</span></p><pre class="source-code">@Override
public void <strong class="bold">configurePathMatch</strong>(PathMatchConfigurer configurer) {
    <strong class="bold">configurer.setUseTrailingSlashMatch(true);</strong>
}</pre></li>				<li>Now, you can validate the application’s behavior by opening <strong class="source-inline">http://localhost:8080/teams/</strong> in your browser. You can check that it works with or without a <span class="No-Break">trailing slash.</span></li>
				<li>If you run the application tests, you will realize that all of them have now succeeded, as only the tests related to trailing slash in the controller were <span class="No-Break">still failing.</span></li>
			</ol>
			<h2 id="_idParaDest-406"><a id="_idTextAnchor446"/>How it works...</h2>
			<p>Rather than<a id="_idIndexMarker1018"/> relying on default behaviors that may change, the ending slash has been deprecated to enforce explicit matches for more stable and predictable applications as new <span class="No-Break">versions appear.</span></p>
			<p>Spring Boot provides the mechanism to maintain the same behavior as previous versions. However, you probably realized that the <strong class="source-inline">setUseTrailingSlashMatch</strong> method is deprecated. This is to warn developers about this non-recommended behavior and enforce the move to <span class="No-Break">explicit matches.</span></p>
			<h2 id="_idParaDest-407"><a id="_idTextAnchor447"/>There’s more...</h2>
			<p>The same approach can be used with WebFlux. Instead of implementing <strong class="source-inline">WebMvcConfigurer</strong>, you would implement <strong class="source-inline">WebFluxConfigurer</strong>. It would look <span class="No-Break">like this:</span></p>
			<pre class="source-code">
@Configuration
public class WebConfiguration implements <strong class="bold">WebFluxConfigurer</strong> {
    @Override
    public void configurePathMatching(PathMatchConfigurer configurer){
      configurer.setUseTrailingSlashMatch(true);
    }
}</pre>			<h2 id="_idParaDest-408"><a id="_idTextAnchor448"/>See also</h2>
			<p>I recommend that you check the official guidelines for Spring Boot 3 migration at <a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#web-application-changes">https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#web-application-changes</a>. As mentioned during the introduction of this recipe, if your application relies on some of the internal components impacted by the migration, you can find more details for fixing <span class="No-Break">your issues.</span></p>
			<h1 id="_idParaDest-409"><a id="_idTextAnchor449"/>Using OpenRewrite for migration automation</h1>
			<p>In this chapter, we made all migration upgrades manually. However, this approach can be too slow and error-prone in large code bases. Some tools try to automate this process, and the most popular one is OpenRewrite. OpenRewrite is a platform tool that aims to refactor any source code. According <a id="_idIndexMarker1019"/>to its documentation, it aims to eliminate the technical debt of the developers’ repositories. It provides a mechanism to run recipes for source code refactoring. A popular open source recipe tackles the subject of this chapter: Spring <span class="No-Break">Boot migrations.</span></p>
			<h2 id="_idParaDest-410"><a id="_idTextAnchor450"/>Getting ready</h2>
			<p>We’ll use the original sample targeting Spring Boot 2.6.15 in this recipe. You can find it in the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a> in the <span class="No-Break"><strong class="source-inline">chapter9/football</strong></span><span class="No-Break"> folder.</span></p>
			<h2 id="_idParaDest-411"><a id="_idTextAnchor451"/>How to do it...</h2>
			<p>We’ll do<a id="_idIndexMarker1020"/> the same <a id="_idIndexMarker1021"/>upgrade from Spring 2.6 to Spring 3.2.4, automating most of the process. Seven recipes <span class="No-Break">in one!</span></p>
			<ol>
				<li>Let’s start by adding the OpenRewrite plugin to our project. To do that, add the following snippet to the plugins section of the <span class="No-Break"><strong class="source-inline">pom.xml</strong></span><span class="No-Break"> file:</span><pre class="source-code">
&lt;plugin&gt;
    &lt;groupId&gt;org.openrewrite.maven&lt;/groupId&gt;
    &lt;artifactId&gt;rewrite-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;5.27.0&lt;/version&gt;
    &lt;configuration&gt;
        &lt;activeRecipes&gt;
            &lt;recipe&gt;org.openrewrite.java.spring.<strong class="bold">boot2.UpgradeSpringBoot_2_7</strong>&lt;/recipe&gt;
        &lt;/activeRecipes&gt;
     &lt;/configuration&gt;
     &lt;dependencies&gt;
         &lt;dependency&gt;
             &lt;groupId&gt;org.openrewrite.recipe&lt;/groupId&gt;
             &lt;artifactId&gt;rewrite-spring&lt;/artifactId&gt;
             &lt;version&gt;5.7.0&lt;/version&gt;
         &lt;/dependency&gt;
     &lt;/dependencies&gt;
&lt;/plugin&gt;</pre><p class="list-inset">When writing this book, the latest version of the OpenRewrite plugin is 5.7.0. Use the latest one when you <span class="No-Break">try it.</span></p><p class="list-inset">We are using the OpenRewrite recipe to upgrade to Spring 2.7 because we’ll do the upgrade gradually. In further steps, we’ll upgrade to Spring Boot 3.0, then 3.1, and <span class="No-Break">finally 3.2.</span></p></li>				<li>Next, we’ll<a id="_idIndexMarker1022"/> execute the OpenRewrite plugin. For that, open your terminal in the root folder of the project and <a id="_idIndexMarker1023"/>execute the following <span class="No-Break">Maven command:</span><pre class="source-code">
./mvnw rewrite:run</pre><p class="list-inset">You will see that it makes <span class="No-Break">some changes:</span></p><ul><li>It upgrades the Spring Boot version <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">2.7.18</strong></span><span class="No-Break">.</span></li><li>It adds a test dependency <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">org.junit.jupiterter:junit-jupiter</strong></span><span class="No-Break">.</span></li><li>It replaces the property <strong class="source-inline">spring.datasource.initialization-mode</strong> with <strong class="source-inline">spring.sql.init.mode</strong> in the <strong class="source-inline">application.yml</strong> file only. Take note of this change, as we’ll need in the <span class="No-Break">next step.</span></li><li>It modifies the references to <strong class="source-inline">org.junit</strong> to <strong class="source-inline">org.junit.jupiter</strong> equivalents in the <span class="No-Break">test classes.</span></li></ul></li>				<li>Let’s check if the upgrade to Spring Boot <span class="No-Break">2.7 works.</span><ul><li>If you run the tests, you will see that the tests that rely on Testcontainers don’t work. This is because OpenRewrite excluded some required dependencies for Testcontainers. To fix it, open <strong class="source-inline">pom.xml</strong> and remove the <strong class="source-inline">exclusion</strong> <strong class="source-inline">junit</strong> on the <span class="No-Break">Testcontainers dependency:</span><pre class="source-code">
&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;
    &lt;version&gt;${testcontainers.version}&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
    &lt;!-- &lt;exclusions&gt;
             &lt;exclusion&gt;
             &lt;groupId&gt;junit&lt;/groupId&gt;
             &lt;artifactId&gt;junit&lt;/artifactId&gt;
             &lt;/exclusion&gt;
      &lt;/exclusions&gt; --&gt;
&lt;/dependency&gt;</pre></li></ul><p class="list-inset">In this <a id="_idIndexMarker1024"/>example, I just commented<a id="_idIndexMarker1025"/> the <strong class="source-inline">exclusions</strong> section for clarity. In your code, you can <span class="No-Break">remove it.</span></p><ul><li>Once the exclusion is fixed, you will see that it cannot load the application context because it cannot resolve the <strong class="source-inline">spring.datasource.initialization-mode</strong> configuration. To fix it, open the <strong class="source-inline">CustomDatasourceService</strong> class and modify the <strong class="source-inline">@Value</strong> annotation used in the constructor. You should replace the <strong class="source-inline">spring.datasource.initialization-mode</strong> setting with the <span class="No-Break"><strong class="source-inline">spring.sql.init.mode</strong></span><span class="No-Break"> setting.</span></li><li>Rerun the tests and you will see that all of <span class="No-Break">them succeed.</span></li></ul></li>				<li>It’s time to start with Spring Boot 3.0. To perform this upgrade, open the <strong class="source-inline">pom.xml</strong> file and modify <strong class="source-inline">activeRecipes/recipe</strong> to <strong class="source-inline">org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_0</strong>. The OpenRewrite plugin configuration should look <span class="No-Break">like this:</span><pre class="source-code">
&lt;configuration&gt;
    &lt;activeRecipes&gt;
        &lt;recipe&gt;org.openrewrite.java.spring.<strong class="bold">boot3.UpgradeSpringBoot_3_0</strong>&lt;/recipe&gt;
    &lt;/activeRecipes&gt;
&lt;/configuration&gt;</pre></li>				<li>Then, execute the plugin again. The changes performed by this upgrade are <span class="No-Break">as follows:</span><ul><li>It replaced all <strong class="source-inline">javax</strong> references <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">jakarta</strong></span><span class="No-Break">.</span></li><li>It migrated the Spring Security changes. It properly migrated <strong class="source-inline">UserDetailsManager</strong> and <strong class="source-inline">WebSecurityCustomizer</strong>. However, as we’ll see in <em class="italic">step 7</em>, the <strong class="source-inline">SecurityFilterChain</strong> bean requires <span class="No-Break">some adjustments.</span></li><li>It migrated the settings defined in the <span class="No-Break"><strong class="source-inline">application.yml</strong></span><span class="No-Break"> file:</span><ul><li>It replaced <strong class="source-inline">management.trace.http.enabled</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">management.httpexchanges.recording.enabled</strong></span><span class="No-Break">.</span></li><li>It migrated the <strong class="source-inline">spring.data.cassandra</strong> settings <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">spring.cassandra</strong></span><span class="No-Break">.</span></li></ul></li></ul></li>
				<li>In the <a id="_idIndexMarker1026"/>Spring Boot 3.0 upgrade, the<a id="_idIndexMarker1027"/> application doesn’t compile. Let’s fix the <span class="No-Break">compilation errors:</span><ul><li>The <strong class="source-inline">DataSourceInitializationMode</strong> class has been removed in Spring Boot 3, but OpenRewrite has not migrated it. As we studied in the <em class="italic">Preparing the application</em> recipe, this change can be easily fixed by replacing <strong class="source-inline">DataSourceInitializationMode</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">DatabaseInitializationMode</strong></span><span class="No-Break">.</span></li><li>Some Actuator changes were correctly applied, but others were not. The <strong class="source-inline">application.yml</strong> was correctly modified, replacing <strong class="source-inline">management.trace.http.enabled</strong> with <strong class="source-inline">management.httpexchanges.recording.enabled</strong>. However, <strong class="source-inline">HttpTraceRepository</strong> and <strong class="source-inline">InMemoryHttpTraceRepository</strong> were not migrated. You can replace them with <strong class="source-inline">HttpExchangeRepository</strong> and <strong class="source-inline">InMemoryHttpExchangeRepository</strong>. For more details, you can check out the <em class="italic">Managing Actuator </em><span class="No-Break"><em class="italic">changes</em></span><span class="No-Break"> recipe.</span></li><li>In the <strong class="source-inline">details</strong> field in the <strong class="source-inline">MatchEventEntity</strong> class, replace the annotation <strong class="source-inline">@Type(JsonType.class)</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">@JdbcTypeCode(SqlTypes.JSON)</strong></span><span class="No-Break">.</span></li></ul></li>
				<li>Next, let’s fix<a id="_idIndexMarker1028"/> <span class="No-Break">the tests:</span><ul><li>As<a id="_idIndexMarker1029"/> explained in <em class="italic">step 3</em>, you should remove the <strong class="source-inline">exclusion</strong> <strong class="source-inline">junit</strong> from the <span class="No-Break">Testcontainers dependency.</span></li><li>As we no longer use the Hypersistence library, we can remove it from our project. For more details, check the <em class="italic">Upgrading Spring </em><span class="No-Break"><em class="italic">Data</em></span><span class="No-Break"> recipe.</span></li><li>OpenRewrite properly migrated the <strong class="source-inline">spring.data.cassandra.*</strong> settings to <strong class="source-inline">spring.cassandra.*</strong> in the <strong class="source-inline">application.yml</strong> file. However, it didn’t modify the references in the tests. To fix it, just replace all references to <strong class="source-inline">spring.data.cassandra</strong> with <strong class="source-inline">spring.cassandra</strong>. See the <em class="italic">Upgrading Spring Data</em> recipe for <span class="No-Break">more details.</span></li><li>The MVC tests don’t work. To fix them, we need to include the <strong class="source-inline">@Import(SecurityConfig.class)</strong> annotation in the <strong class="source-inline">FootballControllerTest</strong> and <strong class="source-inline">SecurityControllerTest</strong> classes. As mentioned previously, the <strong class="source-inline">SecurityFilterChain</strong> bean is migrated but requires some adjustments. As explained in the <em class="italic">Upgrade the project to Spring Boot 3</em> recipe, we need to switch the order of some calls. The method should look <span class="No-Break">like this:</span><pre class="source-code">
@Bean
SecurityFilterChain filterChain(HttpSecurity http)
                                              throws Exception {
  http.authorizeHttpRequests(requests -&gt; requests
      .requestMatchers("/security/private/**").hasRole("ADMIN")
      .requestMatchers("/**").permitAll())
      .httpBasic(withDefaults());
  return http.build();
}</pre></li><li>OpenRewrite<a id="_idIndexMarker1030"/> didn’t migrate <strong class="source-inline">BigInteger</strong> to <strong class="source-inline">Long</strong> and the parameter order binding we studied<a id="_idIndexMarker1031"/> in the <em class="italic">Upgrading Spring Data</em> recipe. To fix it, apply both changes explained in the <em class="italic">Upgrading Spring </em><span class="No-Break"><em class="italic">Data</em></span><span class="No-Break"> recipe.</span></li><li>The tests that check the trailing slash fail. If we want to keep the same behavior, we’ll need to add a <strong class="source-inline">WebMvcConfigurer</strong> as explained in the <em class="italic">Managing web application </em><span class="No-Break"><em class="italic">changes</em></span><span class="No-Break"> recipe.</span></li></ul><p class="list-inset">After applying these fixes, both the tests and the application <span class="No-Break">should work.</span></p></li>				<li>Next, let’s upgrade to Spring Boot 3.1. For that, change the recipe in the <strong class="source-inline">pom.xml</strong> file <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_1</strong></span><span class="No-Break">.</span><p class="list-inset">When writing this book, I found an issue related to the Testcontainers version when running this recipe. The message is similar <span class="No-Break">to this:</span></p><pre class="source-code">
[ERROR] Failed to execute goal org.openrewrite.maven:rewrite-maven-plugin:5.27.0:run (default-cli) on project football: Execution default-cli of goal org.openrewrite.maven:rewrite-maven-plugin:5.27.0:run failed: Error while visiting chapter9/recipe9-8/end/football/pom.xml: java.lang.IllegalStateException: Illegal state while comparing versions : [1.19.7] and [${testcontainers.version}.0.0.0.0.0.0]. Metadata = [null]</pre><p class="list-inset">To <a id="_idIndexMarker1032"/>avoid a runtime error, replace the <strong class="source-inline">testcontainers.version</strong> project variable in the <strong class="source-inline">pom.xml</strong> file with the <a id="_idIndexMarker1033"/>real version in the Testcontainers dependencies. For instance, see <span class="No-Break">this dependency:</span></p><pre class="source-code">&lt;dependency&gt;
   &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
   &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;
<strong class="bold">   &lt;version&gt;${testcontainers.version}&lt;/version&gt;</strong>
   &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre><p class="list-inset">Replace it with <span class="No-Break">the following:</span></p><pre class="source-code">&lt;dependency&gt;
   &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
   &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;
<strong class="bold">   &lt;version&gt;1.19.7&lt;/version&gt;</strong>
   &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre><p class="list-inset">After executing the OpenRewrite plugin, you will see that only a few changes were applied to the <strong class="source-inline">pom.xml</strong> file. You will need to remove the <strong class="source-inline">exclusion</strong> <strong class="source-inline">junit</strong> on the Testcontainers <span class="No-Break">dependency again.</span></p></li>				<li>In the Spring Boot 3.1 upgrade, there are no compilation errors. However, some tests fail. This can be fixed just by changing <strong class="source-inline">spring.jpa.database-platform</strong> to <strong class="source-inline">org.hibernate.dialect.PostgreSQLDialect</strong> as explained in the <em class="italic">Upgrading Spring Data</em> recipe. Rerun the test after applying this fix; all of them <span class="No-Break">should succeed.</span></li>
				<li>Lastly, upgrade<a id="_idIndexMarker1034"/> to Spring Boot 3.2. For that, change the OpenRewrite recipe to <strong class="source-inline">org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2</strong>. Again, you will need to remove the <strong class="source-inline">exclusion</strong> <strong class="source-inline">junit</strong>, but this time, no other actions are<a id="_idIndexMarker1035"/> required. If you run the tests, they should succeed, and the application will <span class="No-Break">run smoothly.</span></li>
			</ol>
			<h2 id="_idParaDest-412"><a id="_idTextAnchor452"/>How it works...</h2>
			<p>OpenRewrite loads a representation of your code known as a <strong class="bold">Lossless Semantic Trees</strong> (<strong class="bold">LSTs</strong>) and then applies <a id="_idIndexMarker1036"/>modifications to that representation by using <strong class="bold">visitors</strong>. Once the <a id="_idIndexMarker1037"/>visitors are applied, OpenRewrite transforms the LSTs to code again. An OpenRewrite recipe is a set of visitors. For instance, one visitor changes the javax references to jakarta references in the LST, another visitor changes the Spring Data configuration settings, and so on, transforming the LSTs to the final upgraded version. Finally, the transformed LSTs are converted <span class="No-Break">into code.</span></p>
			<p>Usually, one OpenRewrite recipe definition does the migration of one Spring Boot version to the next one, e.g., from 2.6 to 2.7. The OpenRewrite Maven plugin detects all the recipes that it should apply from the current application version to the desired target version, and then it applies the recipes in order to make the upgrade gradual. For more information, see the <em class="italic">There’s </em><span class="No-Break"><em class="italic">more</em></span><span class="No-Break"> section.</span></p>
			<p>As you might realize, in this recipe, many scenarios are not covered by the existing recipes. The OpenRewrite recipes are open source and maintained by the community. They handle the most common migration scenarios. For this chapter, I tried to prepare a sample with some scenarios that are not very rare but not very common, such as Hibernate scenarios using the <strong class="source-inline">BigInteger</strong> class. In any case, it’s important to understand what changes are made to each upgrade so that if an error appears, we can fix <span class="No-Break">it manually.</span></p>
			<p>Having a good set of tests is always helpful, as they may help detect behavior changes between versions. In this chapter, we used extensive tests, specifically Testcontainers. They helped detect incompatibilities when accessing PostgreSQL <span class="No-Break">and Cassandra.</span></p>
			<h2 id="_idParaDest-413"><a id="_idTextAnchor453"/>There’s more...</h2>
			<p>In this recipe, we made a gradual upgrade, but you can run the migration directly by applying the OpenRewrite <strong class="source-inline">org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2</strong> recipe. You must apply the same additional fixes <a id="_idIndexMarker1038"/>performed during the <span class="No-Break">gradual migration:</span></p>
			<ul>
				<li>Before executing the <strong class="source-inline">OpenRewrite</strong> plugin, replace the Testcontainers version using a variable with a <span class="No-Break">constant version.</span></li>
				<li>Remove the <strong class="source-inline">exclusion</strong> <strong class="source-inline">junit</strong> in the <span class="No-Break">Testcontainers dependency.</span></li>
				<li>Replace <strong class="source-inline">DataSourceInitializationMode</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">DatabaseInitializationMode</strong></span><span class="No-Break">.</span></li>
				<li>Replace <strong class="source-inline">HttpTraceRepository</strong> and <strong class="source-inline">InMemoryHttpTraceRepository</strong> with <strong class="source-inline">HttpExchangeRepository</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">InMemoryHttpExchangeRepository</strong></span><span class="No-Break">.</span></li>
				<li>Replace the annotation <strong class="source-inline">@Type(JsonType.class)</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">@JdbcTypeCode(SqlTypes.JSON)</strong></span><span class="No-Break">.</span></li>
				<li>Replace all references to <strong class="source-inline">spring.data.cassandra</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">spring.cassandra</strong></span><span class="No-Break">.</span></li>
				<li>Add the <strong class="source-inline">@Import(SecurityConfig.class)</strong> annotation in the <strong class="source-inline">FootballControllerTest</strong> and <span class="No-Break"><strong class="source-inline">SecurityControllerTest</strong></span><span class="No-Break"> classes.</span></li>
				<li>Fix the <strong class="source-inline">SecurityFilterChain</strong> bean in the <span class="No-Break"><strong class="source-inline">SecurityConfig</strong></span><span class="No-Break"> class.</span></li>
				<li>Replace the <strong class="source-inline">BigInteger</strong> class with <strong class="source-inline">Long</strong> and the parameter order binding in the class in the <span class="No-Break"><strong class="source-inline">DynamicQueriesService</strong></span><span class="No-Break"> class.</span></li>
				<li>Add a <strong class="source-inline">WebMvcConfigurer</strong> if you want to keep the trailing <span class="No-Break">slash behavior.</span></li>
				<li>Replace <strong class="source-inline">org.hibernate.dialect.PostgreSQL82Dialect</strong> <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">org.hibernate.dialect.PostgreSQLDialect</strong></span><span class="No-Break">.</span></li>
			</ul>
			<h2 id="_idParaDest-414"><a id="_idTextAnchor454"/>See also</h2>
			<p>I recommend visiting the <a id="_idIndexMarker1039"/>OpenRewrite website at <a href="https://docs.openrewrite.org">https://docs.openrewrite.org</a>. There are many recipes that can be used to maintain our code, not only for Spring <span class="No-Break">Boot migrations.</span></p>
			<p>Other tools aim to automate the migration process as much as possible. For instance, the Spring team developed an experimental project named Spring Boot Migrator. You can find more information <span class="No-Break">at </span><a href="https://github.com/spring-projects-experimental/spring-boot-migrator"><span class="No-Break">https://github.com/spring-projects-experimental/spring-boot-migrator</span></a><span class="No-Break">.</span></p>
		</div>
	</body></html>