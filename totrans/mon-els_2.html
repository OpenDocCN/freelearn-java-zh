<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Installation and the Requirements for Elasticsearch"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Installation and the Requirements for Elasticsearch</h1></div></div></div><p>The <span class="strong"><strong>Java Runtime Environment</strong></span> (<span class="strong"><strong>JRE</strong></span>) is the only requirement to run Elasticsearch.</p><p>The official Elasticsearch <a id="id41" class="indexterm"/>documentation recommends that you use either Oracle Java 8 (update 20 or later), or Oracle Java 7 (update 55 or later). Once you choose your version of the JRE, we recommend that all your nodes use the same version to maintain compatibility. Using different versions of Java across your cluster or using Java versions earlier than the ones specified here, can lead to data corruption. Once you choose a version of Elasticsearch, all the nodes in your cluster should use the same version.</p><p>While it is possible to run Elasticsearch on both Windows and Linux, this book focuses on using it exclusively in a Linux environment. The Elasticsearch documentation is centered on Linux and most of the Elasticsearch community runs the software on Linux. However, there is no reason a production cluster of Elasticsearch cannot run on Windows.</p><p>This chapter will specifically cover installation<a id="id42" class="indexterm"/> instructions for Ubuntu, CentOS, and Red Hat Enterprise Linux (RHEL), but any Linux distribution will work. Readers should use 64-bit operating systems rather than 32-bit operating systems because the former allows more memory allocation for the JRE.</p><p>This chapter covers the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing Elasticsearch</li><li class="listitem" style="list-style-type: disc">Configuring Elasticsearch</li><li class="listitem" style="list-style-type: disc">Installing monitoring tools (Elasticsearch-head, Bigdesk, and Marvel)</li><li class="listitem" style="list-style-type: disc">Cluster requirements</li></ul></div><div class="section" title="Installing Elasticsearch"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Installing Elasticsearch</h1></div></div></div><p>At the time of writing this book, Elasticsearch 2.3.2 is the current stable release and Elasticsearch 5 is in alpha testing. For<a id="id43" class="indexterm"/> production clusters, we recommend using the 2.3.2 release and quickly updating to the 5 general availability (GA) release once it is available. Note that while Elasticsearch 5 is compatible with indices created in Elasticsearch 2.x, there have also been some API changes and feature deprecations after the 1.x release. Readers should account for these important changes before upgrading. More <a id="id44" class="indexterm"/>details on upgrading from 2.x to 5 can be found on the Elastic website at the following URLS:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://www.elastic.co/blog/elasticsearch-5-0-0-alpha1-released">https://www.elastic.co/blog/elasticsearch-5-0-0-alpha1-released</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://www.elastic.co/blog/elasticsearch-5-0-0-alpha2-released">https://www.elastic.co/blog/elasticsearch-5-0-0-alpha2-released</a></li></ul></div><p>Notable API changes include the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Indices from Elasticsearch 1.x must first be upgraded to 2.x before finally moving to version 5</li><li class="listitem" style="list-style-type: disc">The deprecated <code class="literal">filtered</code>, <code class="literal">or</code>, and <code class="literal">and</code> queries were removed in favor of the <code class="literal">bool</code>, <code class="literal">must</code>, and <code class="literal">should</code> queries</li><li class="listitem" style="list-style-type: disc">The <code class="literal">string</code> mapping was deprecated in favor of the <code class="literal">text</code> and <code class="literal">keyword</code> fields</li><li class="listitem" style="list-style-type: disc">The <code class="literal">index</code> mapping property is now set to <code class="literal">true</code> / <code class="literal">false</code> instead of <code class="literal">analyzed</code> / <code class="literal">not_analyzed</code> / <code class="literal">no</code></li><li class="listitem" style="list-style-type: disc">Significant changes to the Percolate API</li><li class="listitem" style="list-style-type: disc">The <code class="literal">_id</code> values are limited to 512 bytes</li></ul></div><p>While examples in this book use the 2.3.2 Elasticsearch release, all examples should be compatible with the upcoming 5.0 release.</p><p>The latest version of Elasticsearch is <a id="id45" class="indexterm"/>available at <a class="ulink" href="https://www.elastic.co/downloads/elasticsearch">https://www.elastic.co/downloads/elasticsearch</a> in <code class="literal">.zip</code>, <code class="literal">.tar.gz</code>, <code class="literal">.rpm</code>, and <code class="literal">.deb</code> formats. It doesn't matter how Elasticsearch is installed, but because it is simpler, we recommend using the <code class="literal">.deb</code> installer for Ubuntu users, the <code class="literal">.rpm</code> installer for CentOS or RHEL users, and the <code class="literal">.tar.gz</code> or <code class="literal">.zip</code> version for users of other Linux distributions, or for users who require a more customized setup. Elasticsearch also provides official <code class="literal">yum</code> and <code class="literal">apt-get</code> repositories.</p><p>Examples in this chapter assume that the user installed Elasticsearch with the <code class="literal">.rpm</code> or <code class="literal">.deb</code> installer, or through the official <code class="literal">yum</code> or <code class="literal">apt-get</code> repositories. This should also be similar for users who installed with the <code class="literal">.zip</code> and <code class="literal">.tar.gz</code> installers.</p><div class="section" title="DEB/RPM installation"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec11"/>DEB/RPM installation</h2></div></div></div><p>First, download the most up-to-date<a id="id46" class="indexterm"/> package from <a class="ulink" href="https://elastic.co">https://elastic.co</a>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the following to<a id="id47" class="indexterm"/> install the DEB package on an Ubuntu or Debian-compatible system:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-2.3</strong></span>
<span class="strong"><strong>.2.deb</strong></span>
<span class="strong"><strong>sudo dpkg -i elasticsearch-2.3.2.deb </strong></span>
</pre></div></li><li class="listitem">Run the following to install the RPM package on a CentOS, RHEL, or another compatible system:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-2.3.2.noar</strong></span>
<span class="strong"><strong>ch.rpm</strong></span>
<span class="strong"><strong>sudo rpm -i elasticsearch-2.3.2.noar</strong></span>
<span class="strong"><strong>ch.rpm</strong></span>
</pre></div></li></ol></div></div><div class="section" title="The yum and apt-get repositories"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec12"/>The yum and apt-get repositories</h2></div></div></div><p>The official <code class="literal">yum</code> and <code class="literal">apt-get</code> repositories are a great way to install Elasticsearch. However, make sure that <a id="id48" class="indexterm"/>you use the <span class="emphasis"><em>official</em></span> repositories. Many third-party <code class="literal">yum</code> and <code class="literal">apt-get</code> Elasticsearch repositories are available, but they may not have the latest stable release.</p></div><div class="section" title="Ubuntu/Debian and apt-get"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec13"/>Ubuntu/Debian and apt-get</h2></div></div></div><p>To install Elasticsearch<a id="id49" class="indexterm"/> using <code class="literal">apt-get</code> follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To enable the repository via <code class="literal">apt-get</code>, first add the <code class="literal">gpg</code> key:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -</strong></span>
</pre></div></li><li class="listitem">Then, add the repository via the following:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>echo "deb http://packages.elastic.co/elasticsearch/2.3/debian stab</strong></span>
<span class="strong"><strong>le</strong></span>
<span class="strong"><strong> main" | sudo tee -a /etc/apt/sources.list.d/elasticsearch-2.3.list</strong></span>
</pre></div></li><li class="listitem">Finally, use your package manager to install the following:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo apt-get install elast</strong></span>
<span class="strong"><strong>icsearch</strong></span>
</pre></div></li></ol></div></div><div class="section" title="CentOS/RHEL and yum"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec14"/>CentOS/RHEL and yum</h2></div></div></div><p>For <code class="literal">yum</code>, follow<a id="id50" class="indexterm"/> these <a id="id51" class="indexterm"/>steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the <code class="literal">gpg</code> key:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</strong></span>
</pre></div></li><li class="listitem">Then, create a <a id="id52" class="indexterm"/>new yum repository at <code class="literal">/etc/yum.repos.d/elasticsearch.repo</code> with the following content:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[elasticsearch-2.3]</strong></span>
<span class="strong"><strong>name=Elasticsearch 2.3.X repository</strong></span>
<span class="strong"><strong>baseurl=http://packages.elastic.co/elasticsearch/2.3/centos</strong></span>
<span class="strong"><strong>gpgcheck=1</strong></span>
<span class="strong"><strong>gpgkey=http://packages.elastic.co/GPG-KEY-elasticsearch</strong></span>
<span class="strong"><strong>enabled=1</strong></span>
</pre></div></li><li class="listitem">Install the package<a id="id53" class="indexterm"/> with the following:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo yum install e</strong></span>
<span class="strong"><strong>lasticsearch</strong></span>
</pre></div></li></ol></div></div><div class="section" title="Verification"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Verification</h2></div></div></div><p>Start Elasticsearch <a id="id54" class="indexterm"/>with the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /etc/init.d/elasticsearch start</strong></span>
</pre></div><p>Then verify installation, test to see whether Elasticsearch is running and loaded via the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl localhost:9200</strong></span>
</pre></div><p>You should get this response:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "status" : 200,</strong></span>
<span class="strong"><strong>    "name" : "Inertia",</strong></span>
<span class="strong"><strong>    "cluster_name" : "Elasticsearch",</strong></span>
<span class="strong"><strong>    "version" : {</strong></span>
<span class="strong"><strong>        "number" : "2.3.2",</strong></span>
<span class="strong"><strong>        "build_hash" : " b9e4a6acad4008027e4038f6abed7f7dba346f94",</strong></span>
<span class="strong"><strong>        "build_timestamp" : "2016-04-21T16:03:47Z ",</strong></span>
<span class="strong"><strong>        "build_snapshot" : false,</strong></span>
<span class="strong"><strong>        "lucene_version" : "5.5.0"</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    "tagline" : "You Know, for Search"</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>To verify that we are able to write data to Elasticsearch, use the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XPUT 'http://localhost:9200/twitter/user/lababidi' -d '{ "name" : "Mahmoud Lababidi" }'</strong></span>
</pre></div><p>This returns the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{"_index":"twitter","_type":"user","_id":"lababidi","_version":1,"created":true}</strong></span>
</pre></div><p>We fetch the data, as follows:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XGET 'http://localhost:9200/twitter/user/lababidi?pretty=true'</strong></span>
</pre></div><p>This returns the<a id="id55" class="indexterm"/> following output:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "_index" : "twitter",</strong></span>
<span class="strong"><strong>    "_type" : "user",</strong></span>
<span class="strong"><strong>    "_id" : "lababidi",</strong></span>
<span class="strong"><strong>    "_version" : 1,</strong></span>
<span class="strong"><strong>    "found" : true,</strong></span>
<span class="strong"><strong>    "_source":{ "name" : "Mahmoud Lababidi" }</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>As a sanity check, try a nonexisting record:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XGET 'http://localhost:9200/twitter/user/kimchy?pretty=true'</strong></span>
</pre></div><p>This should return an expected <code class="literal">false</code> for <code class="literal">found</code>:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "_index" : "twitter",</strong></span>
<span class="strong"><strong>    "_type" : "user",</strong></span>
<span class="strong"><strong>    "_id" : "kimchy",</strong></span>
<span class="strong"><strong>    "fo</strong></span>
<span class="strong"><strong>und" : false</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></div><div class="section" title="Configuration files"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Configuration files</h2></div></div></div><p>It is worth noting the Elasticsearch installation<a id="id56" class="indexterm"/> location, specifically the configuration files and the log files. For example, on Ubuntu, run the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>dpkg -L Elasticsearch</strong></span>
</pre></div><p>This will show that the installation placed the logs in <code class="literal">/var/log/elasticsearch</code> and the config files in <code class="literal">/etc/elasticsearch</code>. Any settings for Elasticsearch (not related to logging) are in <code class="literal">elasticsearch.yml</code> while <code class="literal">logging.yml</code> handles logging.</p><p>We will delve into these files and their respective settings further throughout the book.</p></div></div></div>
<div class="section" title="Configuring an Elasticsearch cluster"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Configuring an Elasticsearch cluster</h1></div></div></div><p>This section will cover <a id="id57" class="indexterm"/>some basic Elasticsearch configuration in addition to a few changes that will positively impact your cluster's performance.</p><p>Most Elasticsearch configuration <a id="id58" class="indexterm"/>changes will be applied to <code class="literal">elasticsearch.yml</code>. For our installation of Elasticsearch on Ubuntu, this file is located at <code class="literal">/etc/elasticsearch/elasticsearch.yml</code>. Elasticsearch internal configuration changes are applied to <code class="literal">elasticsearch.yml</code>. Environmental variables can be set in the application's startup script. For our installation of Elasticsearch 2.3.2 on Ubuntu, these files are in the following locations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Internal Configuration is located at <p>
<code class="literal">/etc/elasticsearch/</code>
<code class="literal">elasticsearch.yml</code>
</p></li><li class="listitem" style="list-style-type: disc">Environmental Variable Configuration is located at <p>
<code class="literal">/etc/defau</code>
<code class="literal">lts/elasticsearch</code>
</p></li></ul></div><div class="section" title="Cluster name"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>Cluster name</h2></div></div></div><p>A wonderful thing about Elasticsearch is the ease with which you can build a cluster. Elasticsearch nodes on the <a id="id59" class="indexterm"/>same local area network (LAN) will automatically form a cluster with each other if they have the configuration variable <code class="literal">cluster.name</code> set to the same value.</p><p>For example, if we store tweets from Twitter in our cluster, we may want to set <code class="literal">cluster.name</code> to <code class="literal">twitter_development</code>. Later on, we may want to create another cluster with the name <code class="literal">twitter_production</code> to hold all of our production data.</p><p>To modify this setting, edit the <code class="literal">Elasticsearch.yml</code> file and look for the <code class="literal">cluster.name</code> setting. Change this value to: <code class="literal">cluster.name: tw</code>
<code class="literal">itter_development</code>.</p><p>The default value for <code class="literal">cluster.name</code> is <code class="literal">elasticsearch</code>. It is fine to use this in solo development, but be careful using it when you are on a LAN with other developers. If you start a new Elasticsearch with the default <code class="literal">cluster.name</code> value and someone else on your network is also running Elasticsearch with the default configuration, you'll notice that data from their Elasticsearch instance will start replicating in your machine.</p></div><div class="section" title="Memory configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>Memory configuration</h2></div></div></div><p>Elasticsearch recommends<a id="id60" class="indexterm"/> setting the heap size to half of the available RAM on the machine, but no more than 30.5 GB. We are using a machine with 16 GB of RAM, so we'll set the heap size to 8 GB. This configuration change is made to the <code class="literal">ES_HEAP_SIZE</code> environment variable in <code class="literal">/etc/defaykts/elasticsear</code>
<code class="literal">ch</code>:</p><div class="informalexample"><pre class="programlisting">ES_HEAP_SIZE=8g</pre></div></div><div class="section" title="Open file limit"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Open file limit</h2></div></div></div><p>Linux limits the number of file descriptors a process can have open at one time. This limit exists because every time a process opens a file descriptor, it uses a little bit of memory. If there were no<a id="id61" class="indexterm"/> limit on the number of open files, a process could potentially open enough files to cause the entire system to run out of memory and crash.</p><p>By default, this limit is set to <code class="literal">1024</code>, which is too low for Elasticsearch. The official Elasticsearch documentation recommends upping this value to <code class="literal">32</code>
<code class="literal">k</code> or <code class="literal">64k</code> for open files.</p></div><div class="section" title="The maximum file limit"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec20"/>The maximum file limit</h2></div></div></div><p>The most up-to-date <code class="literal">.rpm</code> and <code class="literal">.deb</code> installers will automatically increase the maximum open file limit in Elasticsearch to <code class="literal">65535</code>. However, if you use an older version of the <code class="literal">.deb</code> or <code class="literal">.rpm</code>, or run Elasticsearch from the tarball, you'll have to increase the limit manually.</p><p>To check the maximum number of open files allocated to your current user, run the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ ulimit -n </strong></span>
<span class="strong"><strong>65535</strong></span>
</pre></div><p>The user has a maximum of <code class="literal">65535</code> files. However, this does <span class="emphasis"><em>not</em></span> mean Elasticsearch is assigned this number of files. This may mean that Elasticsearch is running as a different user or that it was started with different environment settings.</p><p>To check the maximum<a id="id62" class="indexterm"/> number of open files allocated to Elasticsearch, run the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XGET 'http://localhost:9200/_nodes?os=true&amp;process=true&amp;pretty=true'</strong></span>
</pre></div><p>The result should look something like this:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "ok" : true,</strong></span>
<span class="strong"><strong>  "cluster_name" : "Elasticsearch",</strong></span>
<span class="strong"><strong>  "nodes" : {</strong></span>
<span class="strong"><strong>    "-P1cQt9lThejPG_rj-reKw" : {</strong></span>
<span class="strong"><strong>      "name" : "Korg",</strong></span>
<span class="strong"><strong>      ...</strong></span>
<span class="strong"><strong>      "process" : {</strong></span>
<span class="strong"><strong>        "refresh_interval" : 1000,</strong></span>
<span class="strong"><strong>        "id" : 1407,</strong></span>
<span class="strong"><strong>        "max_file_descriptors" : 1024</strong></span>
<span class="strong"><strong>      }</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  }</strong></span>
</pre></div><p>We see that <code class="literal">max_file_descriptors</code> was set to <code class="literal">1024</code>, so we'll have to increase it. If your output says <code class="literal">65535</code>, skip to the next section.</p><p>Make sure that this is for the <a id="id63" class="indexterm"/>appropriate node; this <code class="literal">curl</code> command will display the <code class="literal">max_file</code> descriptors for all nodes in your cluster.</p></div><div class="section" title="Updating max file descriptors on Ubuntu Linux"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec21"/>Updating max file descriptors on Ubuntu Linux</h2></div></div></div><p>Edit the <code class="literal">/etc/security/limits.conf</code> file and <a id="id64" class="indexterm"/>add the following lines to the end <a id="id65" class="indexterm"/>of the file:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>*  soft  nofile 65536</strong></span>
<span class="strong"><strong>*  hard  nofile 65536</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>The <code class="literal">*</code> symbol means <span class="emphasis"><em>all users</em></span>. You can also set this to just the user that runs the Elasticsearch process.</p></div></div></div><div class="section" title="Enabling pluggable authentication modules"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec22"/>Enabling pluggable authentication modules</h2></div></div></div><p>If we connect to<a id="id66" class="indexterm"/> the Linux server over SSH, we'll have to ensure that PAM authentication is enabled. These instructions are the same if you use Ubuntu or CentOS/RHEL. To make this configuration change, edit the <code class="literal">sshd_config</code> file:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo vim /etc/ssh/sshd_config</strong></span>
</pre></div><p>Ensure that this line is present:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>UsePAM yes</strong></span>
</pre></div><p>Then, restart your SSH server:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo service ssh restart</strong></span>
</pre></div></div><div class="section" title="Verifying the open file limit"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec23"/>Verifying the open file limit</h2></div></div></div><p>Log out and log back in <a id="id67" class="indexterm"/>again to make these changes take effect, then restart the Elasticsearch server:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>exit</strong></span>
<span class="strong"><strong>ssh &lt;yo</strong></span>
<span class="strong"><strong>ur_username&gt;@&lt;your_server&gt;</strong></span>
<span class="strong"><strong>sudo service elasticsearch restart</strong></span>
</pre></div><p>Finally, be sure to verify that these changes took effect. It is not enough to verify that <code class="literal">ulimit -n</code> returns <code class="literal">65536</code>. It is also important to ensure that the Elasticsearch user was started up properly with the<a id="id68" class="indexterm"/> increased maximum open file limit:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XGET 'http://localhost:9200/_nodes?os=true&amp;process=true&amp;pretty=true'</strong></span>
</pre></div><p>This should result in the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "ok" : true,</strong></span>
<span class="strong"><strong>  "cluster_name" : "Elasticsearch",</strong></span>
<span class="strong"><strong>  "nodes" : {</strong></span>
<span class="strong"><strong>    "-P1cQt9lThejPG_rj-reKw" : {</strong></span>
<span class="strong"><strong>      "name" : "Korg",</strong></span>
<span class="strong"><strong>      ...</strong></span>
<span class="strong"><strong>      "process" : {</strong></span>
<span class="strong"><strong>        "refresh_interval" : 1000,</strong></span>
<span class="strong"><strong>        "id" : 1407,</strong></span>
<span class="strong"><strong>        "max_file_descriptors" : 65536</strong></span>
<span class="strong"><strong>      }</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  }</strong></span>
</pre></div><p>This time we see that <code class="literal">max_file_d</code>
<code class="literal">escriptors</code> is set to <code class="literal">65536</code>.</p></div><div class="section" title="Disabling swapping"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Disabling swapping</h2></div></div></div><p>It is important to disable memory <a id="id69" class="indexterm"/>swapping on your operating system or Elasticsearch process.</p><p>To disable swapping until your system is rebooted, run the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo swapoff -a</strong></span>
</pre></div><p>To disable swapping even after your system is rebooted, edit the <code class="literal">/etc/fstab</code> file, and comment out any lines with the word <code class="literal">swap</code> in them. For us, this looked like the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong># /dev/xvdb   none         swap    sw    </strong></span>
<span class="strong"><strong>                         0 0</strong></span>
</pre></div><p>To disable swap for just Elasticsearch, you'll first have to set your Elasticsearch heap size using <code class="literal">ES_HEAP_SIZE</code> and set the process maximum amount of locked memory to <code class="literal">ulimited</code> as the root user. If you use the <code class="literal">.rpm</code> or <code class="literal">.deb</code> installer, both of these settings can be changed in the <code class="literal">/etc/init.d/elasticsearch</code> startup script. Specifically, uncomment and update these lines, as follows:</p><p>(My machine has 512 MB of memory, so I'm setting <code class="literal">ES_HEAP_SIZE</code> to <code class="literal">256m</code>.)</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong># Set ES_HEAP_SIZE to 50% of available RAM, but no more than 31gES_HEAP_SIZE=256m</strong></span>
</pre></div><p>A little further down:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong># Maximum amount of locked memory</strong></span>
<span class="strong"><strong>MAX_LOCKED_MEMORY=unlimited</strong></span>
</pre></div><p>Next, edit your <code class="literal">elasticsearch.yml</code> file, and add the line:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>bootstrap.mlockall: true</strong></span>
</pre></div><p>Then, reboot your Elasticsearch node:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo service elasticsearch restart</strong></span>
</pre></div><p>Finally, verify<a id="id70" class="indexterm"/> that this setting worked by running the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl http://localhost:9200/_nodes/process?pretty</strong></span>
</pre></div><p>You should see the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>"mlockall"</strong></span>
<span class="strong"><strong> : true</strong></span>
</pre></div><p>This is the response.</p></div></div>
<div class="section" title="Understanding your cluster"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Understanding your cluster</h1></div></div></div><p>Elasticsearch has many<a id="id71" class="indexterm"/> different moving parts, and it can get a little complicated to ensure that everything runs properly. Fortunately, there are some great open source monitoring tools that are available to help you keep tabs on your cluster. This section will cover how to install some of the most popular and useful monitoring tools on your cluster, and the following two chapters will go into these tools in more detail.</p><div class="section" title="Installing Elasticsearch-head"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec25"/>Installing Elasticsearch-head</h2></div></div></div><p>Elasticsearch-head is a simple, free, open source tool that provides a high-level examination of your cluster. It is<a id="id72" class="indexterm"/> one of the most useful tools used when administering and monitoring the health of a cluster. Elasticsearch-head only needs to <a id="id73" class="indexterm"/>be installed on one node in your cluster. However, we recommend installing it on all nodes for redundancy. It's installed as an Elasticsearch plugin.</p><p>If you have an Internet connection, you can install Elasticsearch-head with the Elasticsearch <code class="literal">plugin</code> utility, as follows:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /usr/share/elasticsearch/bin/plugin install mobz/elasticsearch-head</strong></span>
</pre></div><p>The location of the <code class="literal">plugin</code> script may vary.</p><p>The next command assumes that you installed Elasticsearch using the <code class="literal">.rpm</code> or <code class="literal">.deb</code> file, but if you are<a id="id74" class="indexterm"/> unsure where the plugin script is in your installation, go ahead and try running the following commands:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo updatedb</strong></span>
<span class="strong"><strong>locate elasticsearch | grep plugin$</strong></span>
</pre></div><p>For me, this returns the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>/usr/share/elasticsearch/bin/plugin</strong></span>
</pre></div><p>If you don't have an Internet <a id="id75" class="indexterm"/>connection on your Elasticsearch instance, you can download the Elasticsearch-head plugin, transfer it to your server, and install it using the following methods.</p><p>From a machine with an Internet connection, we use the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>wget https://github.com/mobz/elasticsearch-head/archive/ma</strong></span>
<span class="strong"><strong>ster.zip -O Elasticsearch-head.zip</strong></span>
<span class="strong"><strong>scp Elasticsearch-head.zip your_server:~/</strong></span>
</pre></div><p>From the Elasticsearch server, we use the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /usr/share/elasticsearch/bin/plugin install file:///path/to/Elasticsearch-head.zip</strong></span>
</pre></div><p>If you run an old version of Elasticsearch, you may have to restart your node before you can open Elasticsearch-head:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo service elasticsearch restart</strong></span>
</pre></div><p>Try out the plugin by visiting <code class="literal">http://elasticsearch-server:9200/_plugin/head/</code> (for a test environment, <code class="literal">elasticsearch-server</code> is probably <code class="literal">localhost</code>). You should see something like the following:</p><div class="mediaobject"><img src="graphics/B03798_02_01.jpg" alt="Installing Elasticsearch-head"/></div></div><div class="section" title="Installing Bigdesk"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec26"/>Installing Bigdesk</h2></div></div></div><p>Bigdesk is a free, open source Elasticsearch plugin that allows you to see your cluster's CPU, memory, and disk<a id="id76" class="indexterm"/> usage. It's a great tool to dig into performance issues with a <a id="id77" class="indexterm"/>cluster and, like Elasticsearch-head, it only needs to be installed on one node in your cluster. We still recommend installing it on all nodes for redundancy.</p><p>Here's how to install Bigdesk.</p><p>Online installation is as follows:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /usr/share/elasticsearch/bin</strong></span>
<span class="strong"><strong>/plugin install AIsaac08/bigdesk</strong></span>
</pre></div><p>Offline installation is has more than one method.</p><p>From a machine with an Internet connection, use the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>wget https://github.com/AIsaac08/bigdesk/zipball/master -O bigdesk.zip</strong></span>
<span class="strong"><strong>scp bigdesk.zip your_server:~/</strong></span>
</pre></div><p>From the Elasticsearch server, use the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /usr/share/elasticsearch/bin/plugin install file:///path/to/bigdesk.zip </strong></span>
</pre></div><p>As with Elasticsearch-head, if you<a id="id78" class="indexterm"/> run an old version of Elasticsearch, you may have to restart your node before you can open Bigdesk:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo service elasticsearch restart</strong></span>
</pre></div><p>Try out the plugin by <a id="id79" class="indexterm"/>visiting <code class="literal">http://elasticsearch-server:9200/_plugin/bigdesk/</code> (for a test environment, elasticsearch-server is probably localhost). You should see something like the following:</p><div class="mediaobject"><img src="graphics/B03798_02_02.jpg" alt="Installing Bigdesk"/></div></div><div class="section" title="Marvel"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec27"/>Marvel</h2></div></div></div><p>Marvel is a powerful<a id="id80" class="indexterm"/> monitoring tool created by the makers of Elasticsearch. It's free for use in<a id="id81" class="indexterm"/> development, but there's a subscription fee to use it in <a id="id82" class="indexterm"/>production. Marvel consists of the following two components:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Marvel Agent (requires Marvel License).</li><li class="listitem">Marvel Dashboard (requires Kibana).</li></ol></div><p>To install the Marvel Agent:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Online installation is as follows:<div class="informalexample"><pre class="programlisting">sudo /usr/share/elasticsearch/bin/plugin install license
sudo /usr/share/elasticsearch/bin/plugin install marvel-agent</pre></div></li><li class="listitem" style="list-style-type: disc">Offline installation is as follows:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/plugin/license/2.3.3/license-2.3.3.zip</strong></span>
<span class="strong"><strong>wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/plugin/marvel-agent/2.3.3/marvel-agent-2.3.3.zip</strong></span>

<span class="strong"><strong>sudo bin/plugin install file:///absolute/path/to /license-2.3.3.zip</strong></span>
<span class="strong"><strong>sudo bin/plugin install file:///absolute/path/to/marvel-agent-2.3.3.zip </strong></span>
</pre></div></li></ul></div><p>Restart <a id="id83" class="indexterm"/>Elasticsearch after installing the Marvel Agent:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo service elasticsearch restart</strong></span>
</pre></div><p>To install the <a id="id84" class="indexterm"/>Marvel Dashboard, use the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, install Kibana:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>wget https://download.elastic.co/kibana/kibana/kibana-4.5.1-linux-x64.tar.gz</strong></span>
<span class="strong"><strong>tar xzvf kibana-4.5.1-linux-x64.tar.gz</strong></span>
</pre></div></li><li class="listitem">Next, install the Marvel Dashboard as a Kibana plugin:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>cd kibana-4.5.1</strong></span>
<span class="strong"><strong>wget https://download.elasticsearch.org/elasticsearch/marvel/marvel-2.3.3.tar.gz</strong></span>
<span class="strong"><strong>bin/kibana plugin --install marvel --url file:///tmp/marvel-2.3.3.tar.gz</strong></span>
</pre></div></li><li class="listitem">Start Kibana:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>./bin/kibana</strong></span>
</pre></div></li><li class="listitem">Open the Marvel Dashboard by visiting <code class="literal">http://server-name:5601/</code> (for a test environment, <code class="literal">server-name</code> is probably <code class="literal">localhost</code>). You should see something like the following:</li></ol></div><div class="mediaobject"><img src="graphics/B03798_02_03.jpg" alt="Marvel"/></div></div></div>
<div class="section" title="Cluster requirements"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Cluster requirements</h1></div></div></div><p>The requirements for your cluster—the number of nodes and the hardware specifications of each node—depend on several factors, including the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Total volume of data</li><li class="listitem" style="list-style-type: disc">Data ingest rate</li><li class="listitem" style="list-style-type: disc">Average record size</li><li class="listitem" style="list-style-type: disc">Data mapping</li><li class="listitem" style="list-style-type: disc">Types of queries being run</li><li class="listitem" style="list-style-type: disc">System performance requirements</li></ul></div><p>There's no one size fits all formula to determine cluster requirements for a given Elasticsearch use case. The best approach is to meticulously test performance while changing variables, such as shard size, the number of nodes in the cluster, and hardware configurations until an optimal solution is found. This section focuses on high-level guidelines to consider when configuring your cluster.</p><p>It's a good idea to run at least three nodes in a production environment and to set data replication to <span class="emphasis"><em>1</em></span>, which asks Elasticsearch to maintain one copy of each shard in the cluster. This configuration will ensure that if a node goes down, your cluster won't lose any data.</p><p>Elasticsearch tends to be more memory intensive than CPU intensive. Any modern 64-bit processor is likely adequate to run Elasticsearch. In general, this favors more processor cores over faster clock speeds.</p><p>Each node in the cluster should have minimum 512 MB of RAM, and half of this should be allocated to Elasticsearch. The Elasticsearch documentation recommends allocating no more than 30.5 GB of memory to an Elasticsearch node because the JVM compresses internally stored memory addresses when heap sizes are less than 30.5 GB but is no longer able to do so when the allocated heap is larger than 30.5 GB. A good rule of thumb is to have no more than 64 GB of total memory per node. Moreover, when determining your total memory requirement for a cluster, you will likely need much less total system memory than your total index size, but the specific amount will vary depending on your use case.</p><p>When considering storage for an Elasticsearch cluster, prefer internal drives to <span class="strong"><strong>network attached storage</strong></span> (<span class="strong"><strong>NAS</strong></span>) solutions. Using solid-state drives instead of traditional hard drives will greatly improve overall system performance.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Summary</h1></div></div></div><p>This chapter covered Elasticsearch installation, configuration, monitoring tools, and cluster requirements. Tools such as Elasticsearch-head, Bigdesk, and Marvel all lay the groundwork to monitor your cluster and analyze its performance. However, you still have to know what aspects to look for and how to find them. In the next chapter, we will examine Elasticsearch-head and Bigdesk further, and discuss important things to look for in these tools when monitoring an Elasticsearch cluster.</p></div></body></html>