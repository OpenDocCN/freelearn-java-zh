<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Building OpenJDK 8"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Building OpenJDK 8</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Working with GNU Autoconf</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 8 on Ubuntu Linux 12.04 LTS</li><li class="listitem" style="list-style-type: disc">Using ccache to speed up the OpenJDK 8 build process</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 8 on Mac OS X</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 8 on Windows 7 SP1</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Introduction</h1></div></div></div><p>The Java 8 specification brings a lot of innovations to the Java platform. Besides new language features such as functional interfaces and Lamda expression support, and library features such as streams and a new date/time API, OpenJDK 8 has a new build system. As this chapter is about building OpenJDK, we will explore the last innovation in depth.</p><p>For a long time, the Sun Java and OpenJDK build system grew around the release process. Requirements from the release engineers always came before the developers' requirements, and developers' requirements for the build process differ greatly from release ones. For the release preparation, the build process must be stable. Release builds are usually built from scratch, they always include the whole project and speed, and environment configuration complexities are not issues for them. On the contrary, partial, incremental, and fast as possible builds are required as air for the development. Also, build scripts must be as clean and manageable as possible to allow easy changes and fine tuning.</p><p>Up to the time when OpenJDK 7 was released, the build process had all the following <span class="emphasis"><em>misfeatures</em></span> of the huge cross-platform project, listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Complex environment setup</li><li class="listitem" style="list-style-type: disc">No reliable incremental builds</li><li class="listitem" style="list-style-type: disc">Broken support for parallel builds</li><li class="listitem" style="list-style-type: disc">No support for compilation cache</li><li class="listitem" style="list-style-type: disc">Unreasonably slow builds in some parts</li><li class="listitem" style="list-style-type: disc">Different types of build scripts (some for GNU, some for Apache Ant)</li><li class="listitem" style="list-style-type: disc">Implicit compilation of Java sources with limited source list selection abilities</li><li class="listitem" style="list-style-type: disc">Too-strict checks for the environment (required for release, but encumbering in the non-standard environment)</li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Drops</em></span> of additional binary components</li><li class="listitem" style="list-style-type: disc">Dependency on specific versions of build tools</li><li class="listitem" style="list-style-type: disc">No support for cross-compilation</li></ul></div><p>Public access to the build caused by the appearance of the OpenJDK project triggered the evolution of the build system to become more developer and "casual builder" friendly. In the timeline of OpenJDK 7, the build process has undergone some cleanup, the builds became easier but fundamental issues stayed the same.</p><p>At last, a huge effort was made during the OpenJDK 8 development. The build system was completely rewritten, with major parts of it rewritten from scratch. Besides the cleanup and restructuring of the Makefiles and the removal of Apache Ant, the main problems were addressed: speed, multicore support, partial and incremental builds, cross–compilation, and a much easier environment setup.</p><p>The latter improvement was largely caused by the introduction of the prebuild step that prepares the project for the current environment. This build configuration step is performed using the GNU Autoconf build system. We will explore it more closely in the following recipe.</p><p>OpenJDK 8<a id="id145" class="indexterm"/> is supported on Linux, Windows, Mac OS X, and Solaris operating systems. Only Windows, Linux, and Mac OS X versions will be discussed further. On both Linux and Windows operating systems, x86 and x86_64 architectures are supported. On Mac OS X, only x86_64 is supported.</p><p>Processor architecture configuration is changed in OpenJDK 8. Previously the x86 architecture was named i586 and x86_64 was named amd64. But now the x86 and x86_64 names are used as is. Also, due to the cross-compilation support, x86 versions can be built on x86_64 operating systems with minor configuration changes. So in this chapter, we will focus on x86_64 and will mention x86 builds where required.</p></div></div>
<div class="section" title="Working with GNU Autoconf"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Working with GNU Autoconf</h1></div></div></div><p><span class="strong"><strong>GNU Autoconf</strong></span><a id="id146" class="indexterm"/>, or simply the GNU build system, is a suite of build tools <a id="id147" class="indexterm"/>designed to assist in making source code packages portable across multiple Unix-like systems.</p><p>Autoconf contains multiple build-related tools and generally acts as a Makefile generator. Makefile templates are processed in the configure build step using environment information and configuration options specified by the user.</p><p>The Autoconf system is quite complex and there exists some controversy about its usage in modern projects. For some projects it may be too old, too complex, and too directed towards Unix-like systems compared to the cost of other platforms. But for OpenJDK, the highly cross-platform project that already heavily relies on Unix-like tools, autotool adoption for the configure build step is well justified.</p><p>The Autoconf system uses GNU make for the actual build step, but in contrast to the make tool, the whole Autoconf package is less portable, and a particular build setup may have restrictions on required versions of the Autoconf packages. Fortunately, this burden can be moved from developers to build system engineers. For the build configuration step, Autoconf generates a standalone shell script. Such a script, usually named <code class="literal">configure</code>, can not only be used without other build system tools, but also run in limited Unix-like environments such as Cygwin on the Windows platform.</p><p>In OpenJDK, the <code class="literal">configure</code> script is prepared beforehand and added to the source code tarball, so the build process does not require any of the autotools' build tools besides GNU make.</p><p>In this recipe, we will explore the OpenJDK 8 build configuration with different options.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec107"/>Getting ready</h2></div></div></div><p>For this recipe, you will need an operating system with a Unix-like environment: Linux, Mac OS X, or Windows with Cygwin installed. Please see the <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span> about installing Cygwin.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec108"/>How to do it...</h2></div></div></div><p>The following procedures will help us to configure the <a id="id148" class="indexterm"/>OpenJDK 8 build environment:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the JDK 7 from Oracle or the prebuilt OpenJDK binaries.</li><li class="listitem">Download and decompress the official OpenJDK 8 source code archive (this archive was not available at the time of writing this book).</li><li class="listitem">Run the build configuration script with the <code class="literal">--help</code> option:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure --help</strong></span>
</pre></div><p>You can now see the list of available configuration options. Let's try some of them.</p></li><li class="listitem">Run the<a id="id149" class="indexterm"/> following command to directly specify the JDK to use as the boot JDK during the build:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure --with-boot-jdk=path/to/jdk</strong></span>
</pre></div></li><li class="listitem">Run the following command to take the default restrictions off the included cryptographic algorithm implementation:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure –-enable-unlimited-crypto</strong></span>
</pre></div></li><li class="listitem">Run<a id="id150" class="indexterm"/> the following command to not generate debug symbols during the build and not include them in target distribution:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure --disable-debug-symbols --disable-zip-debug-info</strong></span>
</pre></div></li><li class="listitem">Run the following command to force bundle the FreeType libraries with OpenJDK on all platforms:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure --enable-freetype-bundling</strong></span>
</pre></div></li><li class="listitem">Run the following command to specify CA certificates to the <code class="literal">keystore</code> file. Please see the <span class="emphasis"><em>Preparing CA certificates</em></span> recipe about preparing such a file in <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure --with-cacerts-file=path/to/cacerts</strong></span>
</pre></div></li><li class="listitem">Run the following command to specify the milestone and build number for the build instead of the generated ones:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure –with-milestone=my-milestone --with-build-number=b42</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec109"/>How it works...</h2></div></div></div><p>In OpenJDK, the configure script is not marked as executable by default due to the OpenJDK source repository policy. So <code class="literal">bash</code> is used explicitly to run the script in this recipe.</p><p>The <code class="literal">configure</code> script prepares the build configuration in the <code class="literal">build</code> directory. It performs a lot of checks and writes the environment-specific details, and the user provides options in the form of environment variables. These variables will be read automatically during the actual build.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec110"/>There's more...</h2></div></div></div><p>OpenJDK supports a lot of options; most of the options may be specified to configure the script simultaneously.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec111"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The following recipes in this chapter for actually building of OpenJDK 8</li><li class="listitem" style="list-style-type: disc">The official website of GNU Autoconf project at <a class="ulink" href="http://www.gnu.org/software/autoconf/">http://www.gnu.org/software/autoconf/</a></li><li class="listitem" style="list-style-type: disc">The mailing list thread with a discussion about adopting Autoconf at <a class="ulink" href="http://mail.openjdk.java.net/pipermail/build-infra-dev/2011-August/000030.html">http://mail.openjdk.java.net/pipermail/build-infra-dev/2011-August/000030.html</a></li></ul></div></div></div>
<div class="section" title="Building OpenJDK 8 Ubuntu Linux 12.04 LTS"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Building OpenJDK 8 Ubuntu Linux 12.04 LTS</h1></div></div></div><p>This recipe<a id="id151" class="indexterm"/> is similar to the recipe <span class="emphasis"><em>Building OpenJDK 7 on Ubuntu Linux 12.04 LTS</em></span> from <a class="link" href="ch03.html" title="Chapter 3. Building OpenJDK 7">Chapter 3</a>, <span class="emphasis"><em>Building OpenJDK 7</em></span>.</p><p>The build process of OpenJDK relies heavily on Unix-like development tools. Linux-based operating systems usually have top notch support for such tools, so building OpenJDK on Linux (and on Mac OS X) can be simpler than on Windows. For major distributions such as Fedora or Ubuntu, the build toolchain and all the dependencies are already included in distributions as packages and can be installed easily.</p><p>Ubuntu 12.04 LTS was chosen for this book because it is one of the most popular Linux distributions. For readers running other operating systems, Ubuntu 12.04 virtual images may be found online for the most popular virtualization tools like Oracle VirtualBox or VMware.</p><p>To build binaries for x86 and x86_64 architectures, corresponding versions of Ubuntu should be used. The build instructions are exactly the same for both architectures so they won't be mentioned further in this recipe. OpenJDK 8 supports cross-compilation, so the x86 version may be built on the x86_64 operating system. But such cross-compilation requires non-trivial library configurations and we will not use it in this recipe.</p><p>The minimum build environment that should produce the most compatible OpenJDK 8 binaries on Linux is Oracle Linux 6.4 amd64 with GCC Version 4.7. We will configure Ubuntu 12.04 to use GCC 4.7 to be close to the minimum build environment.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec112"/>Getting ready</h2></div></div></div><p>For this recipe, we will need clean Ubuntu 12.04 (server or desktop version) running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec113"/>How to do it...</h2></div></div></div><p>The following procedures will help us to build OpenJDK 8:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the prepackaged binaries of OpenJDK 7:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install openjdk-7-jdk</strong></span>
</pre></div></li><li class="listitem">Install the GCC toolchain and build dependencies:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get build-dep openjdk-7</strong></span>
</pre></div></li><li class="listitem">Add an additional packages repository:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo add-apt-repository ppa:ubuntu-toolchain-r/test</strong></span>
<span class="strong"><strong>sudo apt-get update</strong></span>
</pre></div></li><li class="listitem">Install the C and C++ compilers, Version 4.7:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install gcc-4.7</strong></span>
<span class="strong"><strong>sudo apt-get install g++-4.7</strong></span>
</pre></div></li><li class="listitem">Go to<a id="id152" class="indexterm"/> the <code class="literal">/usr/bin</code> directory and set up default compiler-symbolic links:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo rm gcc</strong></span>
<span class="strong"><strong>sudo ln -s gcc-4.7 gcc</strong></span>
<span class="strong"><strong>sudo rm g++</strong></span>
<span class="strong"><strong>sudo ln -s g++-4.7 g++</strong></span>
</pre></div></li><li class="listitem">Download and decompress the official OpenJDK 8 source code archive (this archive was not available at the time of writing this book)</li><li class="listitem">Run the autotools configuration script:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure</strong></span>
</pre></div></li><li class="listitem">Start the build:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make all 2&gt;&amp;1 | tee make_all.log</strong></span>
</pre></div></li><li class="listitem">Run the build binaries:<div class="informalexample"><pre class="programlisting">cd build/linux-x86_64-normal-server-release/images/
./bin/java -version
openjdk version "1.8.0-internal"
OpenJDK Runtime Environment (build 1.8.0-internal-ubuntu_2014_02_22_08_51-b00)
OpenJDK 64-Bit Server VM (build 25.0-b69, mixed mode)</pre></div></li><li class="listitem">Go back to the source's root and build the compact profile's images:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make profiles 2&gt;&amp;1 | tee make_profiles.log</strong></span>
</pre></div></li><li class="listitem">Check the profiles images in the <code class="literal">build/linux-x86_64-normal-server-release/images</code> directory:<div class="informalexample"><pre class="programlisting">j2re-compact1-image
j2re-compact2-image
j2re-compact3-image</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec114"/>How it works...</h2></div></div></div><p>The prepackaged binaries of OpenJDK 7 are required because some of the build steps are run using the external Java runtime.</p><p>The <a id="id153" class="indexterm"/>
<code class="literal">build-dep</code> command<a id="id154" class="indexterm"/> is used to install all the dependencies that are required to build the specified package. As Ubuntu packaged OpenJDK 6 is quite close to the official OpenJDK 6, this command will install almost all the required dependencies.</p><p>Ubuntu 12.04 does not have the GCC 4.7 compilers in a default packages repository, so additional repository configuration is required.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec115"/>There's more...</h2></div></div></div><p>Default GCC 4.6 compilers also may be used to build OpenJDK 8.</p><p>OpenJDK 8 supports cross-compiling x86 binaries on a x86_64 host platform. But the <code class="literal">build-dep -a i386 openjdk-7</code> command to install all the required x86 dependencies won't work (some of the x86 dependencies are not installable on x86_64 OS) and manual dependencies installation may be non-trivial. It may be easier to build x86 binaries on a separate instance of x86 Ubuntu 12.04 using exactly the same steps from this recipe.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec116"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Working with GNU Autoconf</em></span> recipe from this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The official instructions about building OpenJDK 8 at <a class="ulink" href="http://hg.openjdk.java.net/jdk8u/jdk8u/raw-file/2f40422f564b/README-builds.html">http://hg.openjdk.java.net/jdk8u/jdk8u/raw-file/2f40422f564b/README-builds.html</a></li><li class="listitem" style="list-style-type: disc">Unofficial instructions about building OpenJDK 8 packages for Linux distributions at <a class="ulink" href="https://github.com/hgomez/obuildfactory/wiki/How-to-build-and-package-OpenJDK-8-on-Linux">https://github.com/hgomez/obuildfactory/wiki/How-to-build-and-package-OpenJDK-8-on-Linux</a></li></ul></div></div></div>
<div class="section" title="Using ccache to speed up the OpenJDK 8 build process"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Using ccache to speed up the OpenJDK 8 build process</h1></div></div></div><p>Besides the<a id="id155" class="indexterm"/> Java source code, the OpenJDK source repository contains a lot of native C and C++ source code. Native code compilation is<a id="id156" class="indexterm"/> much longer than Java and may take a lot of time. During development, the same code may be compiled multiple times with minor changes. Intermediate binary results for parts of the code may be completely equal between the compilations, but usually parts of the code are recompiled even if no changes are added in those parts. It is natural to expect a more clever approach to code recompiling from modern advanced compilation/linking toolchains.</p><p>The<a id="id157" class="indexterm"/> <span class="strong"><strong>ccache</strong></span> tool provides such cleverness for native compilation. This tool caches the output of C/C++ compilation so that the next time, the same compilation can be avoided and the results can be taken from the cache. This can greatly speed up recompiling time. The detection is done by hashing different kinds of information that should be unique for the compilation, and<a id="id158" class="indexterm"/> then using the hash sum to identify the cached output.</p><p>OpenJDK 8 supported ccache on Linux and Mac OS X but did not support Windows at the time of writing this book.</p><p>In this recipe, we <a id="id159" class="indexterm"/>will set up ccache for the OpenJDK 8 build on Ubuntu 12.04.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec117"/>Getting ready</h2></div></div></div><p>For this recipe, we will need Ubuntu 12.04 (server or desktop version) set up to build OpenJDK 8 (please see the previous recipe).</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec118"/>How to do it...</h2></div></div></div><p>The following procedure will help us in enabling ccache:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">ccache</code> package:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install ccache</strong></span>
</pre></div></li><li class="listitem">Reconfigure the project, running the following command from the OpenJDK 8 source directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure</strong></span>
</pre></div></li><li class="listitem">Check this line in the <code class="literal">configure</code> script output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ccache status:  installed and in use</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec119"/>How it works...</h2></div></div></div><p>In OpenJDK 8, the <code class="literal">configure</code> script checks the cache availability and automatically enables its use during further builds.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec120"/>There's more...</h2></div></div></div><p>For product-like builds when result binaries are going to be used in production, it may be safer to reconfigure the project disabling <code class="literal">ccache</code> with the <code class="literal">--disable-ccache</code> option.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec121"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The previous recipe <span class="emphasis"><em>Building OpenJDK 8 on Ubuntu Linux 12.04 LTS</em></span> from this chapter</li><li class="listitem" style="list-style-type: disc">The official website of ccache at <a class="ulink" href="http://ccache.samba.org/">http://ccache.samba.org/</a></li></ul></div></div></div>
<div class="section" title="Building OpenJDK 8 on Mac OS X"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Building OpenJDK 8 on Mac OS X</h1></div></div></div><p>OpenJDK 8 <a id="id160" class="indexterm"/>supports Mac OS X platform as a first class <a id="id161" class="indexterm"/>citizen and building it (using a proper version of toolchain) is almost as easy as on Linux.</p><p>Historically, Java had first class support on Mac OS X. JDK was based on the Sun code base but built by Apple and integrated finely into operating system environment. Up to Mac OS X 10.4 Tiger, graphical user interface applications written using the standard Swing toolkit had access to most of the Cocoa native interface features. Applications written in Java were felt to be very close to native ones, while still being cross-platform.</p><p>However, for the next releases, the level of Java support went down. Starting from Mac OS X 10.5 Leopard, newer Cocoa features became unsupported for Java. The release of Apple Java 6 was postponed (comparing to Sun releases for other platforms) for more than a year. Java 6 was released in December 2006 but was not available for Mac OS X users until April 2008. Finally, in October 2010, Apple officially announced its decision to discontinue Java support. Apple Java 6 is still being updated with security updates and may be installed on Mac OS X 10.9 Mavericks (the latest version at the time of writing this book) but no following Java versions will be released by Apple.</p><p>Third-party open source Java distributions do exist for Mac OS X. The most notable one is the SoyLatte X11-based port of the FreeBSD Java 1.6 patch set to Mac OS X Intel machines. SoyLatte predated OpenJDK, was licensed under the Java Research license and supported Java 6 builds. Now it is part of the OpenJDK BSD Port project.</p><p>Full support for Mac OS X on a par with other platforms was added in OpenJDK 7 and was continued in OpenJDK 8.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec122"/>Getting ready</h2></div></div></div><p>For this recipe, we will need clean Mac OS X 10.7.5 Lion (or any later version that supports Xcode 4) running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec123"/>How to do it...</h2></div></div></div><p>The following procedures will help us to build OpenJDK 8:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download Xcode 4.6.2 for Lion (April 15, 2013) from <a class="ulink" href="https://developer.apple.com/xcode/">https://developer.apple.com/xcode/</a> (an Apple developer's account is required, registration is free) and install it.</li><li class="listitem">Download the <a id="id162" class="indexterm"/>Command Line Tools for Xcode, April 2013 (April 15, 2013) using the same download link as mentioned in the previous point, and install it.</li><li class="listitem">Run this command from the terminal to set up the Command Line Tools:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer/</strong></span>
</pre></div></li><li class="listitem">Navigate to <span class="strong"><strong>Applications</strong></span> | <span class="strong"><strong>Utilities</strong></span> and run <span class="strong"><strong>X11.app</strong></span> to set up the X-server.</li><li class="listitem">Install the JDK 7 Oracle distribution, or prebuilt OpenJDK binaries can be used.</li><li class="listitem">Download and decompress the official OpenJDK 8 source code archive (this archive is not available at the time of writing this book).</li><li class="listitem">Run<a id="id163" class="indexterm"/> the autotools configuration script:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure –-with-boot-jdk=path/to/jdk7</strong></span>
</pre></div></li><li class="listitem">Start the build:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make all 2&gt;&amp;1 | tee make_all.log</strong></span>
</pre></div></li><li class="listitem">Run the built binaries:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd build/macosx-x86_64-normal-server-release/images/j2sdk-image</strong></span>
<span class="strong"><strong>./bin/java -version</strong></span>
<span class="strong"><strong>openjdk version "1.8.0-internal"</strong></span>
<span class="strong"><strong>OpenJDK Runtime Environment (build 1.8.0-internal-obf_2014_02_20_19_08-b00)</strong></span>
<span class="strong"><strong>OpenJDK 64-Bit Server VM (build 25.0-b69, mixed mode)</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec124"/>How it works...</h2></div></div></div><p>Despite the Xcode Command Line Tools that are used for the main part of the native source, Xcode itself is also required to build the platform specific code.</p><p>OpenJDK on Mac OS X is moving from using the X11 server, but it is still required for Version 8 builds. Mac OS X 10.7 Lion has X11 preinstalled, it just needs to be run once to be configured for the build.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec125"/>There's more...</h2></div></div></div><p>This recipe uses the official Apple builds of GCC (and G++) Version 4.2 as compilers. After that version official Apple support for GCC was discontinued for licensing reasons. Clang—the open source compiler initially developed by Apple—is the default and preferred compiler in newer versions of Mac OS X.</p><p>Despite<a id="id164" class="indexterm"/> the initial developers' plans, OpenJDK 8 still requires GCC and cannot be built using Clang. This is the reason for using Version 4 of Xcode and not <a id="id165" class="indexterm"/>Version 5, which does not ship GCC at all. At the time of writing this book, Xcode 5 and Clang support was being added to the OpenJDK 9 project. Such support may be backported to OpenJDK 8 later; if you want to build Version 8 with Clang, it is best to check the OpenJDK mailing lists for up-to-date information.</p><p>On Mac OS X 10.8 Mountain Lion, a 10.9 Mavericks X11 server should be installed separately using the XQuartz project.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec126"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Working with GNU Autoconf</em></span> recipe from this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">Official instructions about building OpenJDK 8 at <a class="ulink" href="http://hg.openjdk.java.net/jdk8u/jdk8u/raw-file/2f40422f564b/README-builds.html">http://hg.openjdk.java.net/jdk8u/jdk8u/raw-file/2f40422f564b/README-builds.html</a></li><li class="listitem" style="list-style-type: disc">Unofficial instructions about building OpenJDK 8 packages for Mac OS X at <a class="ulink" href="https://github.com/hgomez/obuildfactory/wiki/Building-and-Packaging-OpenJDK8-for-OSX">https://github.com/hgomez/obuildfactory/wiki/Building-and-Packaging-OpenJDK8-for-OSX</a></li></ul></div></div></div>
<div class="section" title="Building OpenJDK 8 on Windows 7 SP1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Building OpenJDK 8 on Windows 7 SP1</h1></div></div></div><p>The OpenJDK 8 build <a id="id166" class="indexterm"/>process on Windows platform included major improvements compared to Version 7. Despite that, the build environment <a id="id167" class="indexterm"/>setup is still much more complex than on Linux and Mac OS X. Much of the complexity of the build comes from its usage of a Unix-like build environment through Cygwin tools.</p><p>The official compiler requirement for i586 builds is Microsoft Visual Studio C++ 2010 Professional Edition. The Express Edition of Visual Studio 2010 may also be used for the x86 build. For x86_64 builds, instead of Visual Studio 2010 Professional Edition, we will use the Microsoft Windows SDK Version 7.1 for Windows 7. This SDK is available for free from the Microsoft website. It uses the same compiler as Visual Studio 2010 Express. It contains only the Command Line Tools (no GUI) but may be used as an external toolset from Visual Studio 2010 if GUI is desired.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec127"/>Getting ready</h2></div></div></div><p>For this recipe, we should have Windows 7 SP1 amd64 running with no antivirus software installed. Antivirus software is not allowed because it may interfere with Cygwin runtime.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec128"/>How to do it...</h2></div></div></div><p>The <a id="id168" class="indexterm"/>following<a id="id169" class="indexterm"/> procedure will help us to build OpenJDK 8:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download Microsoft .NET Framework 4 from the Microsoft website and install it.</li><li class="listitem">Download the amd64 version of the Microsoft Windows SDK for Windows 7 (the <code class="literal">GRMSDKX_EN_DVD.iso</code> file) from the Microsoft website and install it to the default location. The <code class="literal">.NET Development</code> and <code class="literal">Common Utilities</code> components are not required.</li><li class="listitem">Download Visual Studio 2010 Express Edition from the Microsoft website and install it to the default location. Only the Visual C++ component is required.</li><li class="listitem">Download and install the Microsoft DirectX 9.0 SDK (summer 2004) to the default installation path. Note that this distribution is not available any more on the Microsoft website. It may be downloaded from another place online, and the file details are as follows:<div class="informalexample"><pre class="programlisting">name: dxsdk_sum2004.exe
size: 239008008 bytes
sha1sum: 73d875b97591f48707c38ec0dbc63982ff45c661</pre></div></li><li class="listitem">Install or copy the preinstalled version of Cygwin to <code class="literal">c:\cygwin</code>.</li><li class="listitem">Create a <code class="literal">c:\path_prepend</code> directory and copy to it the <code class="literal">find.exe</code> and <code class="literal">sort.exe</code> files from the Cygwin installation.</li><li class="listitem">Download the GNU make utility binary from the <a class="ulink" href="http://www.cmake.org/">http://www.cmake.org/</a> website using <a class="ulink" href="http://www.cmake.org/files/cygwin/make.exe-cygwin1.7">http://www.cmake.org/files/cygwin/make.exe-cygwin1.7</a>, rename it to <code class="literal">make.exe</code>, and put it into the <code class="literal">c:\make</code> directory.</li><li class="listitem">Download the prebuilt FreeType libraries from the <code class="literal">openjdk-unofficial-builds GitHub</code> project (directory <code class="literal">7_64</code>) and put binaries into the <code class="literal">c:\freetype\lib</code> directory and header files into the <code class="literal">c:\freetype\include</code> directory.</li><li class="listitem">Install the OpenJDK 7 binaries or Oracle Java 7 into <code class="literal">c:\jdk7</code>.</li><li class="listitem">Download the official OpenJDK 8 source code archive (this archive was not available at the time of writing this book) and decompress it into the <code class="literal">c:\sources</code> directory.</li><li class="listitem">Write the following command into the <code class="literal">build.bat</code> text file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>@echo off</strong></span>
<span class="strong"><strong>set PATH=C:/path_prepend;C:/WINDOWS/system32;C:/WINDOWS;C:/make;C:/cygwin/bin;C:/jdk7/bin</strong></span>
<span class="strong"><strong>bash</strong></span>
<span class="strong"><strong>echo Press any key to close window ...</strong></span>
<span class="strong"><strong>pause &gt; nul</strong></span>
</pre></div></li><li class="listitem">Run <code class="literal">build.bat</code> from <a id="id170" class="indexterm"/>Windows Explorer. The <code class="literal">cmd.exe</code> window should appear with bash launched.</li><li class="listitem">From the <a id="id171" class="indexterm"/>bash Command Prompt run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd /cygdrive/c/sources</strong></span>
<span class="strong"><strong>bash ./configure \</strong></span>
<span class="strong"><strong>    --with-boot-jdk=c:/jdk7 \</strong></span>
<span class="strong"><strong>    --with-freetype=c:/freetype \</strong></span>
<span class="strong"><strong>chmod –R 777 .</strong></span>
<span class="strong"><strong>make &gt; make.log 2&gt;&amp;1</strong></span>
</pre></div></li><li class="listitem">Launch another Cygwin console and run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd /cygdrive/c/sources</strong></span>
<span class="strong"><strong>tail -f make.log</strong></span>
</pre></div></li><li class="listitem">Wait for the build to finish.</li><li class="listitem">Run the following build binaries:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd build/windows-x86_64-normal-server-release/images/j2sdk-image</strong></span>
<span class="strong"><strong>./bin/java -version</strong></span>
<span class="strong"><strong>    openjdk version "1.8.0-internal"</strong></span>
<span class="strong"><strong>    OpenJDK Runtime Environment (build 1.8.0-internal-obf_2014_02_22_17_13-b00)</strong></span>
<span class="strong"><strong>    OpenJDK 64-Bit Server VM (build 25.0-b69, mixed mode)</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec129"/>How it works...</h2></div></div></div><p>Cygwin installation is covered in the recipe <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> in <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span>. Directories in the root of disk C are used here for brevity. Generally, arbitrary paths consisting of ASCII letters or numbers without spaces can be used. Newer version of DirectX SDK also can be used.</p><p>Different GNU make versions may have different problems on Windows. This particular version from the cmake project was tested on different Windows versions and works fine.</p><p>This recipe uses prebuilt FreeType 2.4.10 libraries from the <code class="literal">openjdk-unofficial-builds GitHub</code> project. FreeType may be built from sources using the same Windows SDK 7.1 toolchain.</p><p>The <code class="literal">make</code> output will be redirected to the <code class="literal">make.log</code> file. The <code class="literal">2&gt;&amp;1</code> statement ensures that both <code class="literal">stdout</code> and <code class="literal">stderr</code> will be redirected.</p><p>The <code class="literal">tail -f</code> command<a id="id172" class="indexterm"/> allows us to watch the contents of the <code class="literal">make.log</code> file as they are written during the build process.</p><p>The <a id="id173" class="indexterm"/>
<code class="literal">pause &gt; nul</code> command <a id="id174" class="indexterm"/>added at the end of the batch file<a id="id175" class="indexterm"/> prevents the <code class="literal">cmd.exe</code> window from disappearing in the case of runtime errors.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec130"/>There's more...</h2></div></div></div><p>The <code class="literal">--with-target-bits=32</code> configure option can be used to build i586 binaries on the amd64 operating system. In this case, the x86 version of the FreeType libraries should be specified by the <code class="literal">--with-freetype</code> option and Express Edition of Visual Studio 2010 should be installed.</p><p>The <code class="literal">tee</code> command may be used instead of <code class="literal">&gt;</code> and <code class="literal">tail</code> to write the build log to the file and console simultaneously.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec131"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Working with GNU Autoconf</em></span> recipe from this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 64-bit FreeType libraries for OpenJDK 7 on Windows</em></span> recipe from <a class="link" href="ch03.html" title="Chapter 3. Building OpenJDK 7">Chapter 3</a>, <span class="emphasis"><em>Building OpenJDK 7</em></span></li><li class="listitem" style="list-style-type: disc">Official instructions about building OpenJDK 8 at <a class="ulink" href="http://hg.openjdk.java.net/jdk8u/jdk8u/raw-file/2f40422f564b/README-builds.html">http://hg.openjdk.java.net/jdk8u/jdk8u/raw-file/2f40422f564b/README-builds.html</a></li></ul></div></div></div></body></html>