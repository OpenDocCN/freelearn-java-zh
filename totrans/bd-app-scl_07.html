<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Creating Reports" id="aid-2H1VQ1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Creating Reports</h1></div></div></div><p>Up until now, we learned how to bootstrap our application using Activator, develop our web application using the Scala and Play framework, and a add reactive microservices call using RxScala for data flow computations. We also performed unit test and controller testing using the BDD and Play framework. Then, we persisted data into MySQL using Slick. Now we will move on with our application.</p><p>In this chapter, you will learn how to write reports with JasperReports. JasperReports is a very solid reporting solution for Java, and it can be used in Scala very easily. We will create database reports using Jasper, and change our application to have such functionality.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Understanding JasperReports</li><li class="listitem">Adding database reports to our application</li></ul></div><div class="section" title="Introducing JasperReports"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec77"/>Introducing JasperReports</h1></div></div></div><p>JasperReports (<a class="ulink" href="http://community.jaspersoft.com/project/jasperreports-library">http://community.jaspersoft.com/project/jasperreports-library</a>) is a very popular and solid reports solution that can generate reports in several formats, such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">HTML</li><li class="listitem">Excel</li><li class="listitem">Word</li><li class="listitem">Open Office format</li><li class="listitem">PDF</li></ul></div><p>In order to get your reports, you have a visual tool called Jaspersoft Studio, in which you can drag and drop elements such as labels, images, data fields, and much more. Jasper will store this metadata (the report definition) in an XML file, also known as <span class="strong"><strong>JRXML</strong></span>. If you want, you can edit and work with this XML without any editor; however, it is way better to use the Jaspersoft Studio tool to gain productivity.</p><p>Jasper can work with several data sources, such as databases, XML, or even objects in memory. For this book, we will use the database datasource to access our MySQL database.</p></div></div>
<div class="section" title="JasperReports workflow" id="aid-2I0GC1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec78"/>JasperReports workflow</h1></div></div></div><p>JasperReports has the same execution stages, including compiling your reports and rendering in a specific format, for example, HTML. The first stage is the report design. If you are not using the Jaspersoft Studio visual tool, we assume that you have your JRXML file. The next step is to compile JRXML into a Jasper file. This compilation phase doesn't need to happen every time; it's needed only if you change the JRXML. Otherwise, you can use the same Jasper file. There are some strategies to cache the Jasper file, so basically you can do it on the build time or you can cache on demand in the application. For our application, we will be using the second approach--caching on demand in the application.</p><p>The next phase is to render or export. You can export the report to the many formats Jasper supports, such as HTML, EXCEL, or PDF, for instance. It's possible to use the same report layout and export to as many formats as you like. For our application, we will be using the PDF format.</p></div>
<div class="section" title="Jasper sessions" id="aid-2IV0U1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec79"/>Jasper sessions</h1></div></div></div><p>A JRXML has sections that are evaluated in different ways and at different times. The following diagram shows all the available sessions:</p><p>
</p><div class="mediaobject"><img src="../Images/image00296.jpeg" alt="Jasper sessions"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>The different sections are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Title</strong></span>: This is printed just one time</li><li class="listitem"><span class="strong"><strong>Page Header</strong></span>: This is printed at the beginning of all printed pages</li><li class="listitem"><span class="strong"><strong>Column Header</strong></span>: This is printed at the beginning of each detail column</li><li class="listitem"><span class="strong"><strong>Detail</strong></span>: This is where every record read from the data source is printed</li><li class="listitem"><span class="strong"><strong>Column Footer</strong></span>: This is printed at the end of each detail column</li><li class="listitem"><span class="strong"><strong>Page Footer</strong></span>: This is printed at the end of all printed pages</li><li class="listitem"><span class="strong"><strong>Summary</strong></span>: This is printed at the end of the report, and is often used to show calculations, totals, and summarizations in general</li></ul></div><p>Jasper is a very flexible report solution that also allows us to run groovy scripts inside a Jasper report to do dynamic calculations as well as dynamic layouts. This is useful if you do not want to print a page given some condition, or based on what you have in the database, or you do not want to show some data.</p><p>Next, we will install Jaspersoft Studio and start creating reports for our application.</p></div>
<div class="section" title="Installing Jaspersoft Studio 6" id="aid-2JTHG1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec80"/>Installing Jaspersoft Studio 6</h1></div></div></div><p>For this, you will need to have Java 8 installed. If you don't have it, go back to <a class="link" title="Chapter 1. Introduction to FP, Reactive, and Scala" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Introduction to FP, Reactive, and Scala</em></span>, and follow the setup instructions. Jasper is really great because it works on multiple platforms; however, it works better on Windows. We are using Linux, so we will need to deal with fonts. JasperReports uses lots of Microsoft's core fonts, such as Arial and Times New Roman. There are some options to have the sources on Linux. You can look for a mscorefonts installer on Linux or just copy the fonts from Windows.</p><p>If you have a dual boot Linux/Windows installation, you can go to your Windows drive at the location <code class="literal">WindowsDrive/Windows/Fonts</code>. You will need to copy all font files to <code class="literal">/usr/share/fonts</code> on Linux and run <code class="literal">$ sudo fc-cache -fv</code>. This might take some time--for my Windows installation, it was about ~300 MB of fonts. You can test whether you have Windows core fonts on Linux. Open the writer and check for the fonts. You should see something similar to this:</p><p>
</p><div class="mediaobject"><img src="../Images/image00297.jpeg" alt="Installing Jaspersoft Studio 6"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Why is this so important? Because Jasper won't work if you don't have the right font in place. It will just throw you random exceptions that will not make sense, but it is very likely to be related to missing fonts.</p><p>Once we have the fonts, we can go ahead and download Jaspersoft Studio 6. For this book, we will be using the 6.2.2 version. You can download it from <a class="ulink" href="http://community.jaspersoft.com/project/jasperreports-library/releases">http://community.jaspersoft.com/project/jasperreports-library/releases</a>. If you are on Linux, it's highly recommended to use the <code class="literal">DEB</code> package; otherwise, you will need to install several other dependencies.</p><p>Once you download and install Jaspersoft Studio and open the program, you will see a UI similar to this one here:</p><p>
</p><div class="mediaobject"><img src="../Images/image00298.jpeg" alt="Installing Jaspersoft Studio 6"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>We have successfully installed Jaspersoft Studio. Now, we will need to configure our MySQL data source in order to start creating reports for our application.</p></div>
<div class="section" title="Configuring MySQL Data Adapter in Jaspersoft Studio"><div class="titlepage" id="aid-2KS222"><div><div><h1 class="title"><a id="ch07lvl1sec81"/>Configuring MySQL Data Adapter in Jaspersoft Studio</h1></div></div></div><p>Open Jaspersoft Studio 6 and click on <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Data Adapter Wizard</strong></span>. You will see the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00299.jpeg" alt="Configuring MySQL Data Adapter in Jaspersoft Studio"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>
<span class="strong"><strong>File name</strong></span> should be <code class="literal">MYSQL_DATAADAPTER.xml</code>, and then you can click <span class="strong"><strong>Next &gt;</strong></span>.</p><p>Next, we will need to choose the type of database adapter. There are several options, such as Cassandra, MongoDB, HBase, JSON file, and so on.</p><p>
</p><div class="mediaobject"><img src="../Images/image00300.jpeg" alt="Configuring MySQL Data Adapter in Jaspersoft Studio"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>We need to pick <span class="strong"><strong>Database JDBC Connection</strong></span> and click <span class="strong"><strong>Next &gt;</strong></span>.</p><p>Now, we will need to configure the connection details.</p><p>
</p><div class="mediaobject"><img src="../Images/image00301.jpeg" alt="Configuring MySQL Data Adapter in Jaspersoft Studio"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>The fields should be completed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Name: </strong></span><code class="literal">MySQL</code></li><li class="listitem"><span class="strong"><strong>JDBC Driver: </strong></span><code class="literal">com.mysql.jdbc.Driver</code></li><li class="listitem"><span class="strong"><strong>JDBC Url: </strong></span><code class="literal">jdbc:mysql://localhost/RWS_DB?useUnicode=true&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC</code></li><li class="listitem"><span class="strong"><strong>Username: </strong></span><code class="literal">root</code></li><li class="listitem"><span class="strong"><strong>Password: </strong></span><code class="literal">This needs be blank, or put the password if you are using one.</code></li></ul></div><p>We will also need to configure the driver into the Jaspersoft Studio classpath. As we are running the application in the same box, we already have the MySQL driver download with SBT on the<code class="literal"> ~/.ivy2/cache/mysql/mysql-connector-java/jars/mysql-connector-java-6.0.3.jar</code> folder. We will just need to point it out on the third tab, called <code class="literal">Driver Classpath</code>.</p><p>
</p><div class="mediaobject"><img src="../Images/image00302.jpeg" alt="Configuring MySQL Data Adapter in Jaspersoft Studio"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now we can test the connection to see if it's all good.</p><p>
</p><div class="mediaobject"><img src="../Images/image00303.jpeg" alt="Configuring MySQL Data Adapter in Jaspersoft Studio"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Great! Now we have our MySQL Database Adapter configured, and we are ready to start creating reports for your application.</p></div>
<div class="section" title="Creating a product report"><div class="titlepage" id="aid-2LQIK2"><div><div><h1 class="title"><a id="ch07lvl1sec82"/>Creating a product report</h1></div></div></div><p>To create a product report, click on <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Jasper Report</strong></span>. Then select the <span class="strong"><strong>Invoice</strong></span> template.</p><p>
</p><div class="mediaobject"><img src="../Images/image00304.jpeg" alt="Creating a product report"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now you can click on <span class="strong"><strong>Next &gt;</strong></span> and we will set up the name of the report. The file name will be <code class="literal">Products.jrxml</code>. Click on <span class="strong"><strong>Next</strong></span>
<span class="strong"><strong> &gt;</strong></span>. Then, we will need to select the <span class="strong"><strong>Data Source: </strong></span>
<code class="literal">MySQL</code>.</p><p>
</p><div class="mediaobject"><img src="../Images/image00305.jpeg" alt="Creating a product report"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now, you will need to run the <code class="literal">Select name, details, price from Product;</code> query.</p><p>After setting the SQL query, you can click on <span class="strong"><strong>Next &gt;</strong></span>.</p><p>
</p><div class="mediaobject"><img src="../Images/image00306.jpeg" alt="Creating a product report"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Next, you will need to pick the fields that will be used in the report. Select all the fields from the left list and move them to the right list. Then click on <span class="strong"><strong>Next &gt;</strong></span>. We don't need group ordering for this report, so just skip the group and click on <span class="strong"><strong>Next &gt;</strong></span> again.</p><p>Congratulations! We finished the setup. We can take a look (have a report preview) of the report using Jaspersoft Studio. Just click on the new report called <span class="strong"><strong>Products.jxml</strong></span>. We will remove all the fields that we don't need, as well as the logo. Then the report will look like this:</p><p>
</p><div class="mediaobject"><img src="../Images/image00307.jpeg" alt="Creating a product report"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>We will change the title to <code class="literal">Products</code> and drop all other information but the <span class="strong"><strong>NAME</strong></span>, <span class="strong"><strong>DETAILS</strong></span>, and <span class="strong"><strong>PRICE</strong></span> headers, which will be retained. We will also keep the <span class="strong"><strong>$F{NAME}</strong></span>, <span class="strong"><strong>$F{DETAILS}</strong></span>, and <span class="strong"><strong>$F{PRICE}</strong></span> fields, which will come from the MySQL database.</p><p>
</p><div class="mediaobject"><img src="../Images/image00308.jpeg" alt="Creating a product report"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now, we can see the report preview. We will need to click on the bottom tab named <span class="strong"><strong>Preview</strong></span>. There are several preview options. We will have to pick <span class="strong"><strong>MySQL</strong></span> as a data source from the top of the screen and the exported format; here, we are using <span class="strong"><strong>Java</strong></span> to see the UI. You can also pick other formats, such as <span class="strong"><strong>PDF,</strong></span> for instance.</p><p>Next, we will need to create reports for reviews and images.</p></div>
<div class="section" title="Creating a review report" id="aid-2MP361"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec83"/>Creating a review report</h1></div></div></div><p>Now, we will create the review report. We will use a very similar process to the one that we used for the product report. Let's get started on creating a review report:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Click on <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Jasper Report</strong></span>. Select the <span class="strong"><strong>Invoice</strong></span> template and click on <span class="strong"><strong>Next &gt;</strong></span>.</li><li class="listitem">The file name will be <code class="literal">Reviews.jrxml</code>. Then click on <span class="strong"><strong>Next &gt;</strong></span>.</li><li class="listitem">Choose <span class="strong"><strong>MySQL</strong></span> from <span class="strong"><strong>Data Adapter</strong></span> and click on <span class="strong"><strong>Next &gt;</strong></span>.</li><li class="listitem"><span class="strong"><strong>Query(Text)</strong></span> should contain the following code snippet:<pre class="programlisting">        Select p.name, r.author, r.comment 
        from Product p, Review r 
        where p.id = r.product_id; 
</pre></li><li class="listitem">Then click <span class="strong"><strong>Next &gt;</strong></span>.</li><li class="listitem">Select all the fields: <span class="strong"><strong>name</strong></span>, <span class="strong"><strong>author</strong></span>, and <span class="strong"><strong>comment</strong></span> then click <span class="strong"><strong>Next</strong></span>.&gt;</li><li class="listitem">Let's skip the <span class="strong"><strong>group by</strong></span> section and click on <span class="strong"><strong>Next</strong></span> and then <span class="strong"><strong>Finish</strong></span>.</li><li class="listitem">We will remove all template labels and fields and just keep the database fields, so we should have something like this:</li></ol><div style="height:10px; width: 1px"/></div><p>
</p><div class="mediaobject"><img src="../Images/image00309.jpeg" alt="Creating a review report"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>That's it! We have the review report. If you like, you can click on the <span class="strong"><strong>Preview</strong></span> tab at the bottom of the screen and select <span class="strong"><strong>MySQL</strong></span> and <span class="strong"><strong>Java</strong></span> to see the report. Keep in mind that you will need to have data; otherwise, it will be empty.</p></div>
<div class="section" title="Creating an image report" id="aid-2NNJO1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec84"/>Creating an image report</h1></div></div></div><p>Now we will create the image report. We will follow a very similar process to the one we used for the product and review report. As we have an image URL, we will also display the image, so we will need to use a different component. Let's get started on creating an image report:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Click on <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Jasper Report</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>Invoice</strong></span> template and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">The file name will be <code class="literal">Images.jrxml</code>. Then click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Choose <span class="strong"><strong>MySQL</strong></span> from <span class="strong"><strong>Data Adapter</strong></span> and click on <span class="strong"><strong>Next &gt;</strong></span>.</li><li class="listitem"><span class="strong"><strong>Query(Text)</strong></span> should contain the following code snippet:<pre class="programlisting">        Select p.name, i.url &#13;
        from Image i, Product p &#13;
        where p.id = i.product_id; &#13;
</pre></li><li class="listitem">Then click <span class="strong"><strong>Next &gt;</strong></span>.</li><li class="listitem">Select all the fields: <span class="strong"><strong>name</strong></span>, <span class="strong"><strong>url </strong></span>, and then click <span class="strong"><strong>Next &gt;</strong></span>.</li><li class="listitem">Let's skip the group by section and click on <span class="strong"><strong>Next &gt;</strong></span> and then <span class="strong"><strong>Finish</strong></span>.</li></ol><div style="height:10px; width: 1px"/></div><p>Now we will need to remove all labels and fields, as we did for the other reports, and just keep the labels and fields from the data adapter.</p><p>We need to add an image component called <span class="strong"><strong>Image</strong></span>. You can find it in the palette at the right-hand side called <span class="strong"><strong>Basic Elements</strong></span>. Just drag and drop it into the detail band, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00310.jpeg" alt="Creating an image report"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Select a custom expression and then type <code class="literal">$F{url}</code>.</p><p>That's it! Now that we have the image report with images, it's time to change the Play framework application in order to render this report in PDF format over there.</p></div>
<div class="section" title="Integrating JasperReports with Play framework"><div class="titlepage" id="aid-2OM4A2"><div><div><h1 class="title"><a id="ch07lvl1sec85"/>Integrating JasperReports with Play framework</h1></div></div></div><p>We will need to create a new folder under <code class="literal">ReactiveWebStore/app</code> called <code class="literal">reports</code>. Then, we will copy all three new <code class="literal">.jrxml</code> files from the Jaspersoft Studio to this folder and set up the build dependencies.</p><div class="section" title="build.sbt"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec95"/>build.sbt</h2></div></div></div><p>First of all, we will need to add new dependencies to the <code class="literal">build.sbt</code> file.</p><p>Your <code class="literal">build.sbt</code> file should look like this after adding the Jasper dependencies:</p><pre class="programlisting">    libraryDependencies ++= Seq( &#13;
      // .... Other dependencies .... &#13;
      "net.sf.jasperreports" % "jasperreports" % "6.2.2"  withSources() &#13;
      ,"net.sf.jasperreports" % "jasperreports-functions" % "6.2.2", &#13;
      "net.sf.jasperreports" % "jasperreports-chart-themes" % "6.2.2" &#13;
    ) &#13;
    resolvers += "Jasper" at &#13;
    "https://jaspersoft.artifactoryonline.com/jaspersoft/repo/" &#13;
    resolvers += "JasperSoft" at &#13;
    "https://jaspersoft.artifactoryonline.com/jaspersoft/jaspersoft-&#13;
    repo/" &#13;
    resolvers += "Jasper3rd" at &#13;
    "https://jaspersoft.artifactoryonline.com/jaspersoft/&#13;
    jaspersoft-3rd-party/" &#13;
    resolvers += "mondrian-repo-cache" at &#13;
    "https://jaspersoft.artifactoryonline.com/jaspersoft/&#13;
    mondrian-repo-cache/" &#13;
    resolvers += "spring-mil" at "http://repo.spring.io/libs-milestone" &#13;
    resolvers += "spring-rel" at "http://repo.spring.io/libs-release" &#13;
    resolvers += "oss" at &#13;
    "https://oss.sonatype.org/content/groups/public/" &#13;
</pre><p>So, basically, we added all JasperReports dependencies and resolvers, which are a bunch of remote repositories where SBT can look for the <code class="literal">jar</code> files. You can run the <code class="literal">$ activator compile</code> command on the console in order to reload the new dependencies. After running <code class="literal">compile</code>, it is important to generate eclipse files again, so you will need to run <code class="literal">$ activator eclipse</code>.</p></div><div class="section" title="Generic report builder"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec96"/>Generic report builder</h2></div></div></div><p>Now is the time to code in Scala. We will create a generic report builder in Scala. Under <code class="literal">ReactiveWebStore/app/reports</code>, we will create a new Scala class called <code class="literal">ReportBuilder.scala</code>.</p><p>Your <code class="literal">ReportBuilder.scala</code> file should have the following code:</p><pre class="programlisting">    package reports &#13;
    object ReportBuilder { &#13;
      private var reportCache:scala.collection.Map[String,Boolean] =  &#13;
      new scala.collection.mutable.HashMap[String,Boolean].empty &#13;
      def generateCompileFileName(jrxml:String): String =  &#13;
      "/tmp/report_" + jrxml + "_.jasper" &#13;
      def compile(jrxml:String){ &#13;
        if(reportCache.get(jrxml).getOrElse(true)){ &#13;
          JasperCompileManager.compileReportToFile( new  &#13;
          File(".").getCanonicalFile +     "/app/reports/" + jrxml ,  &#13;
          generateCompileFileName(jrxml)) &#13;
          reportCache += (jrxml -&gt; false) &#13;
        } &#13;
      } &#13;
      def toPdf(jrxml:String):ByteArrayInputStream = { &#13;
        try { &#13;
          val os:OutputStream = new ByteArrayOutputStream() &#13;
          val reportParams:java.util.Map[String,Object] = new  &#13;
          java.util.HashMap() &#13;
          val con:Connection = DriverManager.getConnection &#13;
          ("jdbc:mysql://localhost/RWS_DB?user=root&amp;password       &#13;
            =&amp;useUnicode=true&amp;useJDBCCompliantTimezoneShift       &#13;
          =true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC") &#13;
          compile(jrxml) &#13;
          val jrprint:JasperPrint = JasperFillManager.fillReport &#13;
          (generateCompileFileName(jrxml),  reportParams, con) &#13;
            val exporter:JRPdfExporter = new JRPdfExporter() &#13;
          exporter.setExporterInput(new SimpleExporterInput(jrprint)) &#13;
          exporter.setExporterOutput &#13;
          (new SimpleOutputStreamExporterOutput(os)); &#13;
          exporter.exportReport() &#13;
          new ByteArrayInputStream &#13;
          ((os.asInstanceOf[ByteArrayOutputStream]).toByteArray()) &#13;
        }catch { &#13;
          case e:Exception =&gt; throw new RuntimeException(e) &#13;
        } &#13;
      } &#13;
    } &#13;
</pre><p>First of all, we are setting a temporary directory to store the Jasper compiled files in the <code class="literal">generateCompileFileName</code> function. As you can see, we are storing the compiled reports at <code class="literal">/tmp/</code>. If you don't use Linux, you will need to change this path.</p><p>Next, we have the compile function, which receives a JRXML report in parameter. There is a report cache <code class="literal">Map</code> object to perform an on-demand cache for the Jasper files. This map has the JRXML report, is the key as a Boolean file. This solution allows you to compile reports on demand.</p><p>Finally, we have the <code class="literal">toPdf</code> function that will receive the <code class="literal">jrxml</code> function and compile the report that is needed. This function uses <code class="literal">DriverManager</code> to get the SQL connection in order to send the connection to the Jasper engine. Finally, there is the fill, process managed by <code class="literal">JasperFillManager</code>, which will receive the Jasper file and reports parameters (for us, an empty map) and the SQL connection.</p><p>After filling the report with data from database, we can export the report in PDF using the <code class="literal">JRPdfExporter</code> command. As this is a generic function, we will return a <code class="literal">ByteArrayInputStream</code>, which is an in-memory stream structure.</p><p>Now, the next step is to change our controllers in order to be able to generate reports for products, reviews, and images.</p></div><div class="section" title="Adding the report to the product controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec97"/>Adding the report to the product controller</h2></div></div></div><p>We will need to change the product controller in order to expose the new report function.</p><p>Your <code class="literal">ProductController.scala</code> file, after adding the report function, should look something like this:</p><pre class="programlisting">    @Singleton &#13;
    class ProductController @Inject() (val messagesApi:MessagesApi,val &#13;
    service:IProductService) extends Controller with I18nSupport { &#13;
      //... rest of the controller code... &#13;
      def report() = Action { &#13;
        import play.api.libs.concurrent. &#13;
        Execution.Implicits.defaultContext &#13;
        Ok.chunked( Enumerator.fromStream(  &#13;
        ReportBuilder.toPdf("Products.jrxml") ) ) &#13;
        .withHeaders(CONTENT_TYPE -&gt; "application/octet-stream") &#13;
        .withHeaders(CONTENT_DISPOSITION -&gt; "attachment;  &#13;
          filename=report-products.pdf" &#13;
        ) &#13;
      }&#13;
    }</pre><p>Right here, we have a new function called <code class="literal">report</code>. We will need to use our <code class="literal">ReportBuilder</code> method passing the <code class="literal">Products.jrxml</code> as parameter. We are using the <code class="literal">Ok.chunked</code> function in order to be able to stream the report to the browser. We are also setting some response headers, such as the content type and the name of the file, which will be reported to <code class="literal">products.pdf</code>.</p><p>Now, we will apply the same code to the review and image controllers.</p></div><div class="section" title="Adding the report to the review controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec98"/>Adding the report to the review controller</h2></div></div></div><p>Now is the time to create the report function for the review controller. Here we go.</p><p>Your <code class="literal">ReviewController.scala</code> file, after adding a report function, should look something like this:</p><pre class="programlisting">    @Singleton &#13;
    class ReviewController @Inject() &#13;
    (val messagesApi:MessagesApi, &#13;
      val productService:IProductService, &#13;
    val service:IReviewService) &#13;
    extends Controller with I18nSupport { &#13;
      //... rest of the controller code... &#13;
      def report() = Action { &#13;
        import play.api.libs.concurrent.Execution. &#13;
        Implicits.defaultContext &#13;
        Ok.chunked( Enumerator.fromStream(  &#13;
        ReportBuilder.toPdf("Reviews.jrxml") ) ) &#13;
        .withHeaders(CONTENT_TYPE -&gt; "application/octet-stream") &#13;
        .withHeaders(CONTENT_DISPOSITION -&gt; "attachment;  &#13;
        filename=report-reviews.pdf") &#13;
      } &#13;
    } &#13;
</pre><p>We have the same logic here as we have for the product controller. The main difference is the <code class="literal">jrxml</code> file and the filename response header. Now, we can move to the last controller--the image controller.</p></div><div class="section" title="Adding the report to the image controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec99"/>Adding the report to the image controller</h2></div></div></div><p>Finally, we will apply the same logic here as we did for the product and review controller, but now it is time to change the image controller.</p><p>Your <code class="literal">ImageController.scala</code> file, after adding report function, should look something like this:</p><pre class="programlisting">    @Singleton &#13;
    class ImageController @Inject() &#13;
    (val messagesApi:MessagesApi, &#13;
      val productService:IProductService, &#13;
    val service:IImageService) &#13;
    extends Controller with I18nSupport { &#13;
      // ... rest of the controller code ... &#13;
      def report() = Action { &#13;
        import play.api.libs.concurrent.Execution. &#13;
        Implicits.defaultContext &#13;
        Ok.chunked( Enumerator.fromStream(  &#13;
        ReportBuilder.toPdf("Images.jrxml") ) ) &#13;
        .withHeaders(CONTENT_TYPE -&gt; "application/octet-stream") &#13;
        .withHeaders(CONTENT_DISPOSITION -&gt; "attachment;  &#13;
        filename=report-images.pdf") &#13;
      } &#13;
    } &#13;
</pre><p>Alright, we have finished all the controllers. However, we will need to configure routes, otherwise, we won't be able to call the controllers--this is the next step.</p></div></div>
<div class="section" title="Routes - adding new report routes" id="aid-2PKKS1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec86"/>Routes - adding new report routes</h1></div></div></div><p>Now, we will need to add the new routes for the reports. For that, we will edit the <code class="literal">conf/routes</code> file, as follows:</p><pre class="programlisting">    GET     /reports           controllers.HomeController.reports  
    # 
    # Reports 
    # 
    GET  /product/report       controllers.ProductController.report 
    GET  /review/report        controllers.ReviewController.report 
    GET  /image/report         controllers.ImageController.report 
</pre><p>We are done with routes now, and we need to change the UI in order to expose the new report functionality. We will create a new view containing all reports, and, for the sake of ease, we will also add a button for each resource UI (product, review, and image).</p></div>
<div class="section" title="New centralized reports UI" id="aid-2QJ5E1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec87"/>New centralized reports UI</h1></div></div></div><p>We will need to create a new view at <code class="literal">ReactiveWebStore/views/reports_index.scala.html</code>.</p><p>Your <code class="literal">reports_index.scala.html</code> file should look something like this:</p><pre class="programlisting">    @()(implicit flash: Flash) &#13;
    @main("Reports") { &#13;
      &lt;a href="/product/report"&gt;&lt;img height="42" width="42"   &#13;
      src="@routes.Assets.at("images/product.png")"&gt; Products  &#13;
      Report&lt;/a&gt;&lt;BR&gt; &#13;
      &lt;a href="/review/report"&gt;&lt;img height="42" width="42"  &#13;
      src="@routes.Assets.at("images/review.png")"&gt; Reviews Report  &#13;
      &lt;/a&gt;&lt;BR&gt; &#13;
      &lt;a href="/image/report"&gt;&lt;img height="42" width="42"  &#13;
      src="@routes.Assets.at("images/image.png")"&gt; Images  &#13;
      Report&lt;/a&gt;&lt;BR&gt; &#13;
    } &#13;
</pre><p>So here, we will basically list all resources--product, review, and images and link the relative controllers, and when the user clicks on the respective link a PDF report will be downloaded. Now we need to edit each resource (product, image, and review) view in order to add a link for the reports there as well.</p><div class="section" title="Adding the report button for each view"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec100"/>Adding the report button for each view</h2></div></div></div><p>Let's edit the product view first.</p><p>Your <code class="literal">product_index.scala.html</code> file should look something like this:</p><pre class="programlisting">    @(products:Seq[Product])(implicit flash: Flash) &#13;
    @main("Products") { &#13;
      // ... rest of the ui code ... &#13;
      &lt;p&gt; &#13;
        &lt;a href="@routes.ProductController.blank" class="btn btn- &#13;
        success"&gt; &#13;
        &lt;i class="icon-plus icon-white"&gt;&lt;/i&gt;Add Product&lt;/a&gt;  &#13;
        &lt;a href="@routes.ProductController.report" class="btn btn- &#13;
        success"&gt; &#13;
        &lt;i class="icon-plus icon-white"&gt;&lt;/i&gt;Products Report&lt;/a&gt; &#13;
      &lt;/p&gt; &#13;
    } &#13;
</pre><p>As you can see here, we added a new button pointing to the new report function. We will need to do the same for the review and the image UI.</p><p>Your <code class="literal">review_index.scala.html</code> file should look something like this:</p><pre class="programlisting">    @(reviews:Seq[Review])(implicit flash: Flash) &#13;
    @main("Reviews") { &#13;
      // ... rest of the ui code ... &#13;
      &lt;p&gt; &#13;
        &lt;a href="@routes.ReviewController.blank" class="btn btn- &#13;
        success"&gt;&lt;i class="icon-plus icon-white"&gt;&lt;/i&gt;Add Review&lt;/a&gt;  &#13;
        &lt;a href="@routes.ReviewController.report" class="btn btn- &#13;
        success"&gt;&lt;i class="icon-plus icon-white"&gt;&lt;/i&gt;Review Report&lt;/a&gt;  &#13;
      &lt;/p&gt; &#13;
    } &#13;
</pre><p>Now we can add the final button to the image view.</p><p>Your <code class="literal">image_index.scala.html</code> file should look something like this:</p><pre class="programlisting">    @(images:Seq[Image])(implicit flash:Flash) &#13;
    @main("Images") { &#13;
      // ... rest of the ui template ... &#13;
      &lt;p&gt; &#13;
        &lt;a href="@routes.ImageController.blank" class=&#13;
        "btn btn-success"&gt;&lt;i class="icon-plus icon-white"&gt;&lt;/i&gt;Add &#13;
        Image&lt;/a&gt;  &#13;
        &lt;a href="@routes.ImageController.report" class=&#13;
        "btn btn-success"&gt;&lt;i class="icon-plus icon-white"&gt;&lt;/i&gt;&#13;
        Images Report&lt;/a&gt;  &#13;
      &lt;/p&gt; &#13;
    } &#13;
</pre><p>All set! Now we can run <code class="literal">$ activator run</code> and see the new UI and report buttons. Go to <code class="literal">http://localhost:9000/</code>:</p><p>
</p><div class="mediaobject"><img src="../Images/image00311.jpeg" alt="Adding the report button for each view"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>If you go to <code class="literal">http://localhost:9000/reports</code>, or click on <span class="strong"><strong>Reports</strong></span>, you will see the following:</p><p>
</p><div class="mediaobject"><img src="../Images/image00312.jpeg" alt="Adding the report button for each view"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>That's it! We have all the reports working on the Play framework application.</p></div></div>
<div class="section" title="Summary" id="aid-2RHM01"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec88"/>Summary</h1></div></div></div><p>In this chapter, you learned how to create custom reports using Jaspersoft Studio and JasperReports. Additionally, you also changed your application in order to integrate the Play framework and JasperReports.</p><p>In the next chapter, you will learn how to use the Akka framework. We will continue building our application and embrace the actor model for a new killer feature for your application.</p></div></body></html>