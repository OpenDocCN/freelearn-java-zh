<html><head></head><body><div id="sbo-rt-content"><div class="chapter" title="Chapter 5. Step Execution"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Step Execution</h1></div></div></div><p>In the previous chapter, we learned about transactions and managing the transactions in different scenarios, along with customizing the transactions with isolation levels, and attribute configurations for single and multiple data sources with patterns. So far, we have discussed the simple jobs, where the flow is linear and contains jobs with steps executing one after the other. In real world applications, we need to configure jobs with a combination of steps, sharing data between them and deciding which step to execute at runtime.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Controlling the job flow</li><li class="listitem" style="list-style-type: disc">Data sharing</li><li class="listitem" style="list-style-type: disc">Externalization and termination</li></ul></div><div class="section" title="Controlling the job flow"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec30"/>Controlling the job flow</h1></div></div></div><p>So far we <a id="id312" class="indexterm"/>have seen batch jobs configured with steps executing <a id="id313" class="indexterm"/>consecutively in a linear fashion. There could be scenarios to decide which step to execute based on the outcome of the previous step during the execution of a batch job, which is a nonlinear execution.</p><p>The following figure shows how the linear step execution happens in a batch job:</p><div class="mediaobject"><img src="Images/3372OS_05_01.jpg" alt="Controlling the job flow" width="500" height="163"/></div><p>The following <a id="id314" class="indexterm"/>figure shows how the nonlinear step execution <a id="id315" class="indexterm"/>happens in a batch job:</p><div class="mediaobject"><img src="Images/3372OS_05_02.jpg" alt="Controlling the job flow" width="600" height="327"/></div><p>Let's understand how to handle such a job flow. There are primarily two ways to handle it:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using an exit code</li><li class="listitem" style="list-style-type: disc">Using a decision logic</li></ul></div><div class="section" title="Using an exit code"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec36"/>Using an exit code</h2></div></div></div><p>Job flow can be <a id="id316" class="indexterm"/>handled based on the exit status of a step along <a id="id317" class="indexterm"/>with the configuration of the <code class="literal">next</code> tag with the <code class="literal">on</code> and <code class="literal">to</code> properties. The following is a sample configuration using an exit code:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt; 
&lt;beans:beans xmlns ="http://www.springframework.org/schema/batch" 

 
xsi:schemaLocation="http://www.springframework.org/schema/beans 
http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
http://www.springframework.org/schema/batch 
http://www.springframework.org/schema/batch/spring-batch-3.0.xsd"&gt;

&lt;beans:import resource="context.xml" /&gt;

&lt;beans:bean id="testTasklet" class=" batch.TestTasklet"&gt; 
&lt;beans:property name="success" value="true"/&gt; 
&lt;/beans:bean&gt; 
&lt;beans:bean id="successTasklet" class=" batch.StatusTasklet"&gt; 
&lt;beans:property name="status" value="Success"/&gt; 
&lt;/beans:bean&gt; 
&lt;beans:bean id="failTasklet" class=" batch.StatusTasklet"&gt; 
&lt;beans:property name="status" value="Failure"/&gt; 
&lt;/beans:bean&gt;

&lt;job id="nonLinearJob"&gt; 
&lt;step id="stepOne"&gt; 
  &lt;tasklet ref="testTasklet"/&gt; 
  &lt;next on="*" to="stepTwo"/&gt; 
  &lt;next on="FAILED" to="stepThree"/&gt; 
&lt;/step&gt; 
&lt;step id="stepTwo"&gt; 
  &lt;tasklet ref="successTasklet"/&gt; 
&lt;/step&gt; 
&lt;step id="stepThree"&gt; 
  &lt;tasklet ref="failTasklet"/&gt; 
&lt;/step&gt; 
&lt;/job&gt; 
&lt;/beans:beans&gt;</pre></div><p>In the preceding configuration, <code class="literal">stepOne</code> is the first step to be executed in the batch job. Based on the output (<code class="literal">ExitStatus</code>) of this step, which includes <code class="literal">testTasklet</code>, the next tag decides which step to execute. If <code class="literal">testTasklet</code> returns a <code class="literal">FAILED</code> status, it executes <code class="literal">stepThree</code>, otherwise <code class="literal">stepTwo</code>. The status can be returned either by the attribute of job execution or step execution. The following are the different statuses:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">String: The exit <a id="id318" class="indexterm"/>status should match with a String, for example, <code class="literal">COMPLETED</code>/<code class="literal">FAILED</code>, which can be verified from <code class="literal">FlowExecutionStatus</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">*</code>: This matches with zero or more characters. It matches any value.</li><li class="listitem" style="list-style-type: disc"><code class="literal">?</code>: This matches <a id="id319" class="indexterm"/>only one character.</li></ul></div></div><div class="section" title="Using a decision logic"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec37"/>Using a decision logic</h2></div></div></div><p>The nonlinear job <a id="id320" class="indexterm"/>execution can also be handled with the decision <a id="id321" class="indexterm"/>logic using the implementation of <code class="literal">JobExecutionDecider</code> and decision tag configuration.</p><p>The following is the <code class="literal">JobExecutionDecider</code> implementation to check the exit status and return <code class="literal">FlowExecutionStatus</code> accordingly:</p><div class="informalexample"><pre class="programlisting">package batch;
import org.springframework.batch.core.ExitStatus;
import org.springframework.batch.core.JobExecution;
import org.springframework.batch.core.StepExecution;
import org.springframework.batch.core.job.flow.FlowExecutionStatus;
import org.springframework.batch.core.job.flow.JobExecutionDecider;

public class JobFlowDecider implements JobExecutionDecider {
@Override
public FlowExecutionStatus decide(JobExecution jobExecution,
StepExecution stepExecution) {
  if(!ExitStatus.FAILED.equals(stepExecution.getExitStatus())) {
    return new FlowExecutionStatus(FlowExecutionStatus.FAILED.getName()); 
  } else {
    return new FlowExecutionStatus(FlowExecutionStatus.COMPLETED.getName()); 
  }
  }
}</pre></div><p>The following is the job configuration with the <code class="literal">JobExecutionDecider</code> implementation and decision tag configuration:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt; 
&lt;beans:beans xmlns ="http://www.springframework.org/schema/batch" 

 
xsi:schemaLocation="http://www.springframework.org/schema/beans 
http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
http://www.springframework.org/schema/batch 
http://www.springframework.org/schema/batch/spring-batch-3.0.xsd"&gt;

&lt;beans:bean id="decider" class="batch.JobFlowDecider"/&gt;
&lt;beans:bean id="successTasklet" class=" batch.StatusTasklet"&gt; 
&lt;beans:property name="status" value="Success"/&gt; 
&lt;/beans:bean&gt; 
&lt;beans:bean id="failTasklet" class=" batch.StatusTasklet"&gt; 
&lt;beans:property name="status" value="Failure"/&gt; 
&lt;/beans:bean&gt;
&lt;job id="nonLinearJob"&gt; 
  &lt;step id="stepOne" next="decision"&gt; 
  &lt;tasklet&gt; 
    &lt;chunk reader="itemReader" writer="itemWriter" 
    commit-interval="20"/&gt;
  &lt;/tasklet&gt; 
  &lt;/step&gt; 
  &lt;decision id="decision"&gt; decider="decider" 
    &lt;next on="*" to="stepTwo"/&gt; 
    &lt;next on="FAILED" to="stepThree"/&gt; 
  &lt;/decision&gt; 
  &lt;step id="stepTwo"&gt; 
    &lt;tasklet ref="successTasklet"/&gt; 
  &lt;/step&gt; 
  &lt;step id="stepThree"&gt; 
    &lt;tasklet ref="failTasklet"/&gt; 
  &lt;/step&gt; 
&lt;/job&gt;</pre></div><p>One can choose between <a id="id322" class="indexterm"/>these two options (exit codes and decision logic) based on the monitoring status needs; the job execution decider makes the <a id="id323" class="indexterm"/>configuration more readable.</p></div></div></div></div>



  
<div id="sbo-rt-content"><div class="section" title="Data sharing"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec31"/>Data sharing</h1></div></div></div><p>While each step <a id="id324" class="indexterm"/>should be configured to execute on its own in an ideal scenario, the steps need to share the data in real-world scenarios. The data can be shared between steps in different ways. The following are the options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using execution context</li><li class="listitem" style="list-style-type: disc">Using Spring holder beans</li></ul></div><div class="section" title="Using execution context"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Using execution context</h2></div></div></div><p>We learned from the <a id="id325" class="indexterm"/>previous chapters that the Spring Batch jobs maintain information about the job execution in a context called batch job metadata. We <a id="id326" class="indexterm"/>can use this context to share data between steps. The key-value-based data is maintained by <code class="literal">org.springframework.batch.item.ExecutionContext</code> in its usage. The following is the way to put/get the data from it:</p><div class="informalexample"><pre class="programlisting">String importId = jobExecutionContext.getString("importId");
executionContext.putString("importId", importId);</pre></div><p>Both job and step have their own execution context in the form of <code class="literal">JobExecutionContext</code> and <code class="literal">StepExecutionContext</code>. While jobs have a unique execution context, each step in a job maintains its own step execution context. Step context can be accessed from the chunk context (<code class="literal">org.springframework.batch.core.scope.context.ChunkContext</code>) and the job context can be accessed from the step context.</p></div><div class="section" title="Using Spring holder beans"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>Using Spring holder beans</h2></div></div></div><p>The data between <a id="id327" class="indexterm"/>steps can be shared using the concept of <a id="id328" class="indexterm"/>Spring holder beans as well. Metadata configuration is represented by <code class="literal">ImportMetadata</code>, through which we can set and get the data. We can write a bean that can hold the reference of <code class="literal">ImportMetadata</code> and configure the same as <code class="literal">ImportMetadataHolder</code> in job configuration. The following is the sample configuration for <code class="literal">ImportMetadataHolder</code>:</p><div class="informalexample"><pre class="programlisting">package batch;
public class ImportMetadataHolder {
  private ImportMetadata importMetadata;
  public ImportMetadata get() {
    return importMetadata;
  }
  public void set(ImportMetadata importMetadata) {
    this.importMetadata = importMetadata;
  }
}</pre></div><p>The data can be set and got from the holder by using following syntax:</p><div class="informalexample"><pre class="programlisting">importMetadataHolder.set(
batchService.extractMetadata(outputDirectory));
importMetadataHolder.get().getImportId();</pre></div><p>The <code class="literal">ImportMetadataHolder</code> can be configured just like any other bean and injected into the tasklets with the <a id="id329" class="indexterm"/>property specification.</p></div></div></div>



  
<div id="sbo-rt-content"><div class="section" title="Externalization and termination"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Externalization and termination</h1></div></div></div><p>Externalization and <a id="id330" class="indexterm"/>termination are the concepts that help to make reusable components of Spring Batch and handle job termination graciously.</p><div class="section" title="Externalization"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>Externalization</h2></div></div></div><p>Spring Batch allows code <a id="id331" class="indexterm"/>reuse using externalization, the concept of separating the reusable steps of operation and including them in desired jobs. Along with the configuration of the individual steps as beans and including them in each job, externalization can be achieved in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">External flow definition and including it in desired jobs</li><li class="listitem" style="list-style-type: disc">Inherited jobs mechanism</li></ul></div></div><div class="section" title="External flow definition and including it in desired jobs"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>External flow definition and including it in desired jobs</h2></div></div></div><p>The following is a <a id="id332" class="indexterm"/>sample configuration <a id="id333" class="indexterm"/>for external flow definition and including it in the desired job:</p><div class="informalexample"><pre class="programlisting">&lt;flow id="externalFlow"&gt; 
  &lt;step id="stepOne" next="stepTwo"&gt; 
    &lt;tasklet ref="taskletOne"/&gt; 
  &lt;/step&gt; 
  &lt;step id="stepTwo"&gt; 
    &lt;tasklet ref="taskletTwo"/&gt; 
  &lt;/step&gt; 
&lt;/flow&gt; 
&lt;job id="mainJob"&gt; 
  &lt;flow parent="externalFlow" id="mainStep" next="stepThree"/&gt; 
  &lt;step id="stepThree"&gt; 
    &lt;tasklet ref="taskletThree"/&gt; 
  &lt;/step&gt; 
&lt;/job&gt;</pre></div></div><div class="section" title="Inherited jobs mechanism"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec42"/>Inherited jobs mechanism</h2></div></div></div><p>The other way of <a id="id334" class="indexterm"/>externalizing the process is by inheriting one job into the other, which means defining an independent job and referring to it in another job as a part of it. The following is a sample configuration for it:</p><div class="informalexample"><pre class="programlisting">&lt;job id="mainJob"&gt; 
  &lt;step id="stepOne" next="stepTwo"&gt; 
    &lt;tasklet ref="taskletOne"/&gt; 
  &lt;/step&gt; 
  &lt;step id="stepTwo"&gt; 
    &lt;tasklet ref="taskletTwo"/&gt; 
  &lt;/step&gt; 
&lt;/job&gt;
&lt;job id="subJob"&gt; 
  &lt;step id="stepThree" next="stepFour"&gt; 
&lt;job ref="mainJob" job-parameters-extractor="jobParametersExtractor" /&gt; 
&lt;/step&gt; 
  &lt;step id="stepFour" parent="runBatch"/&gt; 
&lt;/job&gt;</pre></div><p>The main job has a <a id="id335" class="indexterm"/>couple of steps and the sub job is defined to refer to the main job as a part of its first step.</p></div><div class="section" title="Termination"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec43"/>Termination</h2></div></div></div><p>Ending the <a id="id336" class="indexterm"/>execution programmatically is an important aspect of the batch job execution. To be able to effectively program this, one should be aware of the different states in which the job can be terminated. The different states are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">COMPLETED</code>: This <a id="id337" class="indexterm"/>end state can be used to tell Spring Batch that the processing has ended successfully. When a job instance is terminated with this end state, it isn't allowed to rerun with the same set of parameters.</li><li class="listitem" style="list-style-type: disc"><code class="literal">FAILED</code>: This end state <a id="id338" class="indexterm"/>can be used to tell Spring Batch that the processing has failed. Spring Batch lets the failed jobs rerun with the same set of parameters.</li><li class="listitem" style="list-style-type: disc"><code class="literal">STOPPED</code>: This end <a id="id339" class="indexterm"/>state is like pausing an executing job. If ended with this state, Spring Batch not only lets us restart the job, it also lets us restart from where it left off, even though there are no errors in execution.</li></ul></div><div class="section" title="Terminating in the COMPLETED state"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec15"/>Terminating in the COMPLETED state</h3></div></div></div><p>The following <a id="id340" class="indexterm"/>is the configuration to terminate a <a id="id341" class="indexterm"/>job in the <code class="literal">COMPLETED</code> state, based on the <code class="literal">ExitStatus</code> with the end tag configuration:</p><div class="informalexample"><pre class="programlisting">&lt;job id="nonLinearJob"&gt; 
  &lt;step id="stepOne"&gt; 
    &lt;tasklet ref="successTasklet"/&gt; 
    &lt;end on="*"/&gt; 
    &lt;next on="FAILED" to="stepTwo"/&gt; 
  &lt;/step&gt; 
  &lt;step id="stepTwo"&gt; 
    &lt;tasklet ref="failureTasklet"/&gt; 
  &lt;/step&gt; 
&lt;/job&gt;</pre></div><p>This configuration ends the job after successful execution, and we can't rerun the job with the same set of <a id="id342" class="indexterm"/>parameters. The first step is configured to <a id="id343" class="indexterm"/>invoke the second step if it has failed.</p></div><div class="section" title="Terminating in the FAILED state"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec16"/>Terminating in the FAILED state</h3></div></div></div><p>The following is <a id="id344" class="indexterm"/>the configuration to terminate a job in the <code class="literal">FAILED</code> <a id="id345" class="indexterm"/>state, based on the <code class="literal">ExitStatus</code> with the fail tag configuration:</p><div class="informalexample"><pre class="programlisting">&lt;job id="nonLinearJob"&gt; 
  &lt;step id="stepOne"&gt; 
    &lt;tasklet ref="successTasklet"/&gt; 
    &lt;next on="*" to="stepTwo"/&gt; 
    &lt;fail on="FAILED" exit-code="STEP-ONE-FAILED"/&gt;
  &lt;/step&gt; 
  &lt;step id="stepTwo"&gt; 
    &lt;tasklet ref="failureTasklet"/&gt; 
  &lt;/step&gt; 
&lt;/job&gt;</pre></div><p>This configuration ends the job with the <code class="literal">FAILED</code> state if the exit status is <code class="literal">FAILED</code>, and we can rerun the job with the same set of parameters.</p></div><div class="section" title="Terminating in the STOPPED state"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec17"/>Terminating in the STOPPED state</h3></div></div></div><p>The following <a id="id346" class="indexterm"/>is the configuration to terminate a job in the <code class="literal">STOPPED</code> <a id="id347" class="indexterm"/>state, based on the <code class="literal">ExitStatus</code> with the stop tag configuration:</p><div class="informalexample"><pre class="programlisting">&lt;job id="nonLinearJob"&gt; 
  &lt;step id="stepOne"&gt; 
    &lt;tasklet ref="successTasklet"/&gt; 
    &lt;next on="*" to="stepTwo"/&gt; 
    &lt;stop on="FAILED" restart="stepTwo"/&gt;
  &lt;/step&gt; 
  &lt;step id="stepTwo"&gt; 
    &lt;tasklet ref="failureTasklet"/&gt; 
  &lt;/step&gt; 
&lt;/job&gt;</pre></div><p>This configuration ends <a id="id348" class="indexterm"/>the job with the <code class="literal">STOPPED</code> state if the exit status is <a id="id349" class="indexterm"/>
<code class="literal">FAILED</code>, and we can rerun the job with the same set of parameters.</p></div></div></div></div>



  
<div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Summary</h1></div></div></div><p>Through this chapter, we learned about controlling the flow of a batch job using exit codes and decision logic. We also learned how to share data between the steps in execution with the help of execution context and holder beans. We also learned about reusing the process by externalizing the flow and inherited job mechanisms. We finished this chapter with an understanding of terminating the batch job in different states and their importance. In the next chapter, we will learn in detail about the enterprise integration using Spring integration and RESTful job processing.</p></div></div>



  </body></html>