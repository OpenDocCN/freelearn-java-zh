<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Building OpenJDK 6"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Building OpenJDK 6</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Preparing CA certificates</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</li><li class="listitem" style="list-style-type: disc">Setting up the minimum build environment for the most compatible Linux builds</li><li class="listitem" style="list-style-type: disc">Installing Cygwin for Windows builds</li><li class="listitem" style="list-style-type: disc">Building 32-bit FreeType libraries for OpenJDK 6 on Windows</li><li class="listitem" style="list-style-type: disc">Building 64-bit FreeType libraries for OpenJDK 6 on Windows</li><li class="listitem" style="list-style-type: disc">Building 32-bit OpenJDK 6 on Windows 7 SP1</li><li class="listitem" style="list-style-type: disc">Building 64-bit OpenJDK 6 on Windows 7 x64 SP1</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Introduction</h1></div></div></div><p>OpenJDK 6<a id="id47" class="indexterm"/> is a free and open source implementation of the Java Platform, Standard Edition Version 6. Currently, this project is actively maintained by the community with the leading role held by Red Hat, Inc.</p><p>Among all Java Platform versions, Java 6 had the longest lifetime. Its Reference Implementation Sun Java 6 was released in December 2006, and OpenJDK 7, the Reference Implementation of the next version of the Java Platform, wasn't out until July 2011. During these 5 years, a lot of applications were built on this platform version.</p><p>Also, during these years the authors of Reference Implementation, Sun Microsystems, were acquired by the Oracle Corporation, and so the product was renamed Oracle Java. In February 2013, Oracle ended public support for Oracle Java 6, but it didn't mean the end of Java 6: Red Hat, Inc. took the leading role in OpenJDK 6 and now it continues to release new versions on a regular basis.</p><p>The OpenJDK 6 codebase differs greatly from both Oracle and Sun Java 6 and OpenJDK 7 codebases. It started as a fork of OpenJDK 7 build 20, and the first version that passed the Java Compatibility Kit test suite was released before the general availability of OpenJDK 7. The versioning scheme differs from the versioning of Oracle Java 6. Each release doesn't have an update number and only has a build number, such as b01 and b02. At the time of writing this book, the release from January 2014 is Version b30.</p><p>You can see the family tree <a id="id48" class="indexterm"/>of OpenJDK 6 in the following diagram:</p><div class="mediaobject"><img src="graphics/8405_02_01.jpg" alt="Introduction"/><div class="caption"><p>Diagram reference: <a class="ulink" href="https://blogs.oracle.com/darcy/entry/openjdk_6_genealogy">https://blogs.oracle.com/darcy/entry/openjdk_6_genealogy</a></p></div></div><p>OpenJDK 6<a id="id49" class="indexterm"/> is supported on Linux, Windows, and Solaris operating systems. Only Windows and Linux versions will be discussed further. For both Linux and Windows operating systems, x86 and x86_64 architectures are supported. To conform with the OpenJDK terminology, the <span class="strong"><strong>i586</strong></span> term<a id="id50" class="indexterm"/> will be used for x86 architecture and <span class="strong"><strong>amd64</strong></span><a id="id51" class="indexterm"/> will be used for the x86_64 one. OpenJDK 6 does not support cross compilation, so the i586 operating system must be used to build the i586 version, and the same is true for amd64. The build process for both architectures is almost the same for the Linux version, but differs a lot for the Windows one.</p></div></div>
<div class="section" title="Preparing CA certificates"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Preparing CA certificates</h1></div></div></div><p><span class="strong"><strong>Public-key cryptography</strong></span> is <a id="id52" class="indexterm"/>used widely on the Internet. When<a id="id53" class="indexterm"/> the web browser opens a secured website, it checks the server-side certificate against the website domain name. To perform such checks, all web browsers have a list of <span class="strong"><strong>Certificate Authority</strong></span> (<span class="strong"><strong>CA</strong></span>) certificates that may be used to sign server-side certificates of websites. Such checks may be disabled but they are a necessary part of secure web browsing, client banking, and so on.</p><p>When website access is used by a Java program (for example, to download a file from a secure site), programs such as the browser in the preceding example should check the site certificate. Such a check is usually performed by the underlying SSL API implementation, and with the browser, the list of CA certificates must be available to the OpenJDK runtime.</p><p>Such a list is stored in the <code class="literal">openjdk_directory/jre/security/cacerts</code> file in the <a id="id54" class="indexterm"/>
<span class="strong"><strong>Java KeyStore</strong></span> (<span class="strong"><strong>JKS</strong></span>) format. In official OpenJDK 6 tarballs, the <code class="literal">cacerts</code> file contains no certificates. If runtime with such empty file is used to access a secured website, an obscure exception will be thrown.</p><p>The following code snippet will cause the exception with the root cause:</p><div class="informalexample"><pre class="programlisting">new URL("https://github.com/").openStream().close();
Caused by: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty
    at java.security.cert.PKIXParameters.setTrustAnchors(PKIXParameters.java:...
        at java.security.cert.PKIXParameters.&lt;init&gt;(PKIXParameters.java:120)
        at java.security.cert.PKIXBuilderParameters.&lt;init&gt;(PKIXBuilderParameters....
        at sun.security.validator.PKIXValidator.&lt;init&gt;(PKIXValidator.java:73)
        ... 47 more</pre></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec36"/>Getting ready</h2></div></div></div><p>To prevent such an exception, a proper <code class="literal">cacerts</code> file should be prepared. It may be used during the OpenJDK build or added to the <code class="literal">jre/security</code> directory later. The list of CA certificates should be obtained and converted to the JKS format. To download and convert the CA list, we will need a recent version of the Ubuntu (or similar Linux-based) operating system with <code class="literal">cURL</code> and <code class="literal">keytool</code> utilities installed. You will also need <code class="literal">cat</code>, <code class="literal">awk</code>, and <code class="literal">csplit</code> standard utilities; these should be already installed as part of the <code class="literal">coreutils</code> package.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec37"/>How to do it...</h2></div></div></div><p>The following steps will help us to prepare CA certificates:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">cURL</code> utility:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install curl</strong></span>
</pre></div></li><li class="listitem">Install the <code class="literal">keytool</code> utility as part of the prebuilt OpenJDK package:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install openjdk-7-jdk</strong></span>
</pre></div></li><li class="listitem">Download the CA list used by the Firefox web browser, preconverted in the PEM format from the <code class="literal">cURL</code> library website into the <code class="literal">cacert.pem</code> file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>curl -L http://curl.haxx.se/ca/cacert.pem -o cacert.pem</strong></span>
</pre></div></li><li class="listitem">Split the <code class="literal">cacert.pem</code> file into multiple files with the <code class="literal">cert_</code> prefix. Each file will contain a single CA certificate:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cat cacert.pem | awk '/-----BEGIN CERTIFICATE-----/,/-----END CERTIFICATE-----/{ print $0; }' &gt; cacert-clean.pem</strong></span>
<span class="strong"><strong>csplit -k -f cert_ cacert-clean.pem "/-----BEGIN CERTIFICATE-----/" {*}</strong></span>
</pre></div></li><li class="listitem">Create a <a id="id55" class="indexterm"/>JKS keystore and load all CA certificates there using <code class="literal">keytool</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>for CERT_FILE in cert_*; do</strong></span>
<span class="strong"><strong>    ALIAS=$(basename ${CERT_FILE})</strong></span>
<span class="strong"><strong>    echo yes | keytool -import -alias ${ALIAS} -keystore cacerts -storepass 'changeit' -file ${CERT_FILE} || :</strong></span>
<span class="strong"><strong>done</strong></span>
</pre></div></li><li class="listitem">Check the <code class="literal">cacerts</code> file's contents:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>keytool -list -keystore cacerts -storepass 'changeit'</strong></span>
</pre></div></li></ol></div><p>Now the <code class="literal">cacerts</code> file is ready to use.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec38"/>How it works...</h2></div></div></div><p>A list of CA<a id="id56" class="indexterm"/> certificates used by the Firefox web browser is freely available as part of the open source security library from Mozilla called NSS. This list is available in text format at <a class="ulink" href="http://mxr.mozilla.org/mozilla/source/security/nss/lib/ckfw/builtins/certdata.txt">http://mxr.mozilla.org/mozilla/source/security/nss/lib/ckfw/builtins/certdata.txt</a>. We have used the same file but preconverted it in to PEM format, which is available at the cURL website.</p><p>The <code class="literal">keytool</code> utility understands certificates in the PEM format, but it can only load certificates one-by-one, so the big PEM file is split beforehand. Also, the <code class="literal">keytool</code> utility has strict requirements from the PEM files: no text content is allowed before <code class="literal">/-----BEGIN CERTIFICATE-----/</code> and after <code class="literal">/-----END CERTIFICATE-----/</code> strings. The <code class="literal">awk</code> utility is used to strip unneeded prefixes and postfixes.</p><p>Then the <code class="literal">csplit</code> utility is used to split the file using <code class="literal">/-----BEGIN CERTIFICATE-----/</code> separators.</p><p>Next, the<a id="id57" class="indexterm"/> split files are loaded into the keystore one by one. The keystore is created on the first certificate load.</p><p>The <code class="literal">changeit</code> password is used for this keystore, which may be quite an unsecure choice for the password. However, this does not matter for the <code class="literal">cacerts</code> file because the CA certificates contain only public keys and need not be hidden behind the password.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec39"/>There's more...</h2></div></div></div><p>Most of this recipe is not specific to the Ubuntu operating system; any Unix-like environment (for example, Cygwin on Windows) would suffice.</p><p>Bash scripts in this recipe can be replaced by any other scripting language such as Python or PowerShell.</p><p>Instead of the CA list from Firefox, any other set of CA certificates may be used. Some CA certificates may be removed, for example a particular CA certificate not trusted by the user, or some additional CA certificates may be added, for example inner corporate CA certificates to access a company's intranet resources.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec40"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The source of the script used in this recipe is the <code class="literal">obuildfactory</code> project on GitHub at <a class="ulink" href="https://github.com/hgomez/obuildfactory/blob/2075649116e32a5f0bbf8fc7b2791769387eda92/openjdk7/macosx/build.sh#L54">https://github.com/hgomez/obuildfactory/blob/2075649116e32a5f0bbf8fc7b2791769387eda92/openjdk7/macosx/build.sh#L54</a></li><li class="listitem" style="list-style-type: disc">The cURL utility manual at <a class="ulink" href="http://curl.haxx.se/docs/manpage.html">http://curl.haxx.se/docs/manpage.html</a></li><li class="listitem" style="list-style-type: disc">The keytool utility manual at <a class="ulink" href="http://docs.oracle.com/javase/6/docs/technotes/tools/windows/key">http://docs.oracle.com/javase/6/docs/technotes/tools/windows/key</a></li></ul></div></div></div>
<div class="section" title="Building OpenJDK 6 on Ubuntu Linux 12.04 LTS"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</h1></div></div></div><p>The build <a id="id58" class="indexterm"/>process of OpenJDK relies heavily on Unix-like development tools. Linux-based operating systems usually <a id="id59" class="indexterm"/>have top notch support for such tools, so building OpenJDK on Linux can be simpler than on Windows. For major distributions such as Fedora or Ubuntu, build toolchain and all dependencies are already included in distributions as packages and can be installed easily.</p><p>Ubuntu 12.04 LTS was chosen for this book because it is one of the most popular Linux distributions. For readers running other operating Ubuntu 12.04, virtual images may be found online for the most popular virtualization tools, such as Oracle VirtualBox or VMware.</p><p>To build binaries for i586 and amd64 architectures, corresponding versions of Ubuntu should be used. Build instructions are exactly the same for both architectures, so they won't be mentioned further in this recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec41"/>Getting ready</h2></div></div></div><p>For this recipe, we will need a clean Ubuntu 12.04 (server or desktop version) running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec42"/>How to do it...</h2></div></div></div><p>The following steps will help us to build OpenJDK:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install prepackaged binaries of OpenJDK 6:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install openjdk-6-jdk</strong></span>
</pre></div></li><li class="listitem">Install GCC toolchain and build dependencies:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get build-dep openjdk-6</strong></span>
<span class="strong"><strong>sudo apt-get install libmotif-dev</strong></span>
</pre></div></li><li class="listitem">Download and decompress official OpenJDK 6 build 30 tarball:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mkdir openjdk-6-src-b30-21_jan_2014</strong></span>
<span class="strong"><strong>cd openjdk-6-src-b30-21_jan_2014</strong></span>
<span class="strong"><strong>wget https://java.net/projects/openjdk6/downloads/download/openjdk-6-src-b30-21_jan_2014.tar.xz</strong></span>
<span class="strong"><strong>tar xJf openjdk-6-src-b30-21_jan_2014.tar.xz</strong></span>
<span class="strong"><strong>rm openjdk-6-src-b30-21_jan_2014.tar.xz</strong></span>
</pre></div></li><li class="listitem">Open the <code class="literal">jdk/make/javax/sound/jsoundalsa/Makefile</code> file with your favorite text editor and change line 68 from <code class="literal">LDFLAGS += -lasound</code> to:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>OTHER_LDLIBS += -lasound</strong></span>
</pre></div></li><li class="listitem">Create a new text file <code class="literal">buildenv.sh</code> with the following environment settings:<div class="informalexample"><pre class="programlisting">export LD_LIBRARY_PATH=
export CLASSPATH=
export JAVA_HOME=
export LANG=C
export ALT_BOOTDIR=/usr/lib/jvm/java-6-openjdk</pre></div></li><li class="listitem">Import the environment into the current shell session (note a dot and a space before it):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>. buildenv.sh</strong></span>
</pre></div></li><li class="listitem">Start<a id="id60" class="indexterm"/> the build process from the <code class="literal">openjdk-6-src-b30-21_jan_2014</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make 2&gt;&amp;1 | tee make.log</strong></span>
</pre></div></li><li class="listitem">Wait <a id="id61" class="indexterm"/>for the build to finish, and try to run the newly built binaries:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd build/linux-amd64/j2sdk-image/</strong></span>
<span class="strong"><strong>./bin/java –version</strong></span>
<span class="strong"><strong>openjdk version "1.6.0-internal"</strong></span>
<span class="strong"><strong>OpenJDK Runtime Environment (build 1.6.0-internal-ubuntu_22_jan_2014_13_12-b00)</strong></span>
<span class="strong"><strong>OpenJDK 64-Bit Server VM (build 23.25-b01, mixed mode)</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec43"/>How it works...</h2></div></div></div><p>Prepackaged binaries of OpenJDK 6 are required because some of the build steps are run using the external Java runtime.</p><p>The <code class="literal">build-dep</code> command is used to install all the dependencies that are required to build the specified package. As Ubuntu packaged OpenJDK 6 is quite close to the official OpenJDK 6, this command will install almost all of the required dependencies.</p><p>The <code class="literal">libmotif-dev</code> package is the only additional package required. It contains the Motif GUI toolkit header files.</p><p>The <code class="literal">jdk/make/javax/sound/jsoundalsa/Makefile</code> file adjustment is required to conform with the Ubuntu 12.04 GCC 4.6 toolchain. It is not required for the original GCC 4.2 toolchain and may not be required for more recent OpenJDK 6 official sources, because this change is going to be included in OpenJDK 6 upstream.</p><p>The <code class="literal">tee</code> command is used to write output to the logfile and the screen simultaneously.</p><p>After a successful build on the amd64 platform, JDK files will be placed in <code class="literal">build/linux-amd64/j2sdk-image</code> and JRE files will be placed in <code class="literal">build/linux-amd64/j2re-image</code>. On the i586 platform, the <code class="literal">build/linux-i586</code> path will be used instead.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec44"/>There's more...</h2></div></div></div><p>Javadoc generation takes a lot of time and is the most memory consuming step of the build. It may be skipped with an additional environment variable:</p><div class="informalexample"><pre class="programlisting">export NO_DOCS=true</pre></div><p>This build has generated a milestone tag and a build number <code class="literal">b00</code>. The predefined build number and milestone may be set using additional environment variables:</p><div class="informalexample"><pre class="programlisting">export MILESTONE=ubuntu-build
export BUILD_NUMBER=b30</pre></div><p>The <code class="literal">cacerts</code> file may be provided during the build using an additional environment variable:</p><div class="informalexample"><pre class="programlisting">export ALT_CACERTS_FILE=path/to/cacerts</pre></div><p>For <a id="id62" class="indexterm"/>amd64 builds, preinstalled Java provided by the <code class="literal">ALT_BOOTDIR</code> variable may be either the amd64 or i586 build. The<a id="id63" class="indexterm"/> i586 binaries consume less memory and may be used for amd64 builds on limited hardware.</p><p>The build process for OpenJDK 6 is effectively single-threaded; parallel builds (using <code class="literal">make -j N</code>) are not supported for this version.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec45"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The previous recipe <span class="emphasis"><em>Preparing CA certificates</em></span></li><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK 6 at <a class="ulink" href="http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html">http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html</a></li><li class="listitem" style="list-style-type: disc">The source bundles of the current OpenJDK 6 version from Red Hat, Inc. at <a class="ulink" href="https://java.net/projects/openjdk6/downloads">https://java.net/projects/openjdk6/downloads</a></li><li class="listitem" style="list-style-type: disc">The source bundles of older versions of OpenJDK 6 from Oracle at <a class="ulink" href="http://download.java.net/openjdk/jdk6/promoted/">http://download.java.net/openjdk/jdk6/promoted/</a></li><li class="listitem" style="list-style-type: disc">The mailing list thread about problems with <code class="literal">jsoundalsa</code> on Ubuntu 12.04 noted previously at <a class="ulink" href="http://mail.openjdk.java.net/pipermail/jdk6-dev/2014-January/003222.html">http://mail.openjdk.java.net/pipermail/jdk6-dev/2014-January/003222.html</a></li></ul></div></div></div>
<div class="section" title="Setting up the minimum build environment for the most compatible Linux builds"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Setting up the minimum build environment for the most compatible Linux builds</h1></div></div></div><p>OpenJDK 6 on <a id="id64" class="indexterm"/>Linux was developed for and most excessively tested with those GCC toolchains available at that time. Modern Linux distributions have newer toolchains, for example, Ubuntu 12.04 has GCC 4.6. Newer toolchains may have more advanced optimizations and provide slightly faster code, but older ones should be more stable for OpenJDK.</p><p>Oracle published the minimum build environment description for OpenJDK 6. It says:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"Building with the MBE will generate the most compatible bits that install on, and run correctly on, the most variations of the same base OS and hardware architecture."</em></span></p></blockquote></div><p>We are going to build OpenJDK 6 on one of the minimum build environment platforms—Debian Linux 5.0 Lenny. The build instructions are exactly the same for i586 and amd64 architectures, so they won't be mentioned further in this recipe.</p><p>The build steps are similar to the previous recipe so we'll concentrate on different steps.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec46"/>Getting ready</h2></div></div></div><p>In this recipe, we will need Debian Lenny running. Installation images may be downloaded from the Debian CDImage archive. Lenny may not be compatible with some of the hardware on newer laptops, but should run fine with virtualization tools such as Oracle VirtualBox or VMware.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec47"/>How to do it...</h2></div></div></div><p>The following steps will help us to set up the minimum build environment:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add archive repositories to the <code class="literal">/etc/apt/sources.list</code> file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>deb http://archive.kernel.org/debian-archive/debian lenny main contrib non-free</strong></span>
<span class="strong"><strong>deb-src http://archive.kernel.org/debian-archive/debian lenny main contrib non-free</strong></span>
</pre></div></li><li class="listitem">Install OpenJDK 6 binaries and build dependencies:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install openjdk-6-jdk</strong></span>
<span class="strong"><strong>sudo apt-get build-dep openjdk-6</strong></span>
<span class="strong"><strong>sudo apt-get install libmotif-dev</strong></span>
</pre></div></li><li class="listitem">Download and decompress Apache Ant:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wget http://archive.apache.org/dist/ant/binaries/apache-ant-1.8.4-bin.tar.gz</strong></span>
<span class="strong"><strong>tar xzf apache-ant-1.8.4-bin.tar.gz</strong></span>
</pre></div></li><li class="listitem">Create a new text file <code class="literal">buildenv.sh</code> with environment settings, and import its content into the current bash shell:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>export LD_LIBRARY_PATH=</strong></span>
<span class="strong"><strong>export CLASSPATH=</strong></span>
<span class="strong"><strong>export JAVA_HOME=</strong></span>
<span class="strong"><strong>export LANG=C</strong></span>
<span class="strong"><strong>export ALT_BOOTDIR=/usr/lib/jvm/java-6-openjdk</strong></span>
<span class="strong"><strong>export ANT_HOME=path/to/apache-ant-1.8.4/</strong></span>
<span class="strong"><strong>export PATH=$ANT_HOME/bin:$PATH</strong></span>
<span class="strong"><strong>. buildenv.sh</strong></span>
</pre></div></li><li class="listitem">Download<a id="id65" class="indexterm"/> and decompress the official OpenJDK 6 build 30 tarball:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mkdir openjdk-6-src-b30-21_jan_2014</strong></span>
<span class="strong"><strong>cd openjdk-6-src-b30-21_jan_2014</strong></span>
<span class="strong"><strong>wget https://java.net/projects/openjdk6/downloads/download/openjdk-6-src-b30-21_jan_2014.tar.gz</strong></span>
<span class="strong"><strong>tar xzf openjdk-6-src-b30-21_jan_2014.tar.gz</strong></span>
<span class="strong"><strong>rm openjdk-6-src-b30-21_jan_2014.tar.gz</strong></span>
</pre></div></li><li class="listitem">Start the build process from the <code class="literal">openjdk-6-src-b30-21_jan_2014</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make 2&gt;&amp;1 | tee make.log</strong></span>
</pre></div></li><li class="listitem">Wait for the build to finish.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec48"/>How it works...</h2></div></div></div><p>Archive repository setup is required because the official Lenny repositories are no longer available.</p><p>A newer version of Apache Ant is required because the bundled Version 1.7.0 in Lenny is too old and OpenJDK 6 requires Ant 1.7.1 or higher.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec49"/>There's more...</h2></div></div></div><p>Other older Linux distributions such as Ubuntu 8.04 or Fedora 9 also may be used as the minimum build environment.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec50"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS </em></span>recipe</li><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK, 6 with the description of minimum build platforms, at <a class="ulink" href="http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html#MBE">http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html#MBE</a></li><li class="listitem" style="list-style-type: disc">The Debian CDImages archive at <a class="ulink" href="http://cdimage.debian.org">http://cdimage.debian.org</a></li></ul></div></div></div>
<div class="section" title="Installing Cygwin for Windows builds"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Installing Cygwin for Windows builds</h1></div></div></div><p>Like most<a id="id66" class="indexterm"/> of the other cross-platform open source projects, OpenJDK uses<a id="id67" class="indexterm"/> Unix-like tools for the build process. Tools such as <code class="literal">gmake</code>, <code class="literal">awk</code>, and <code class="literal">cpio</code> are ubiquitous for the Unix and Linux world and may be found on almost any Unix-like platform. However, these tools are based on Unix process behavior, and that becomes a problem when we want to run them on Windows.</p><p>Cygwin is a set of free and open source tools being developed by Red Had, Inc. and provides limited support for the Unix-like environment in Windows. It is required to build OpenJDK on Windows.</p><p>OpenJDK requires Cygwin i586 for both i586 and amd64 builds. The installation procedure is the same for both Windows 7 SP1 i586 and Windows 7 SP1 amd64 so we won't mention architecture further in this recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec51"/>Getting ready</h2></div></div></div><p>To install and successfully use Cygwin, we'll need a clean installation of Windows 7 SP1 without antivirus software running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec52"/>How to do it...</h2></div></div></div><p>The following steps will help us to install Cygwin:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download <code class="literal">setup-x86.exe</code> from the <a class="ulink" href="http://cygwin.com/">http://cygwin.com/</a> website.</li><li class="listitem">Run the installer and choose <a class="ulink" href="http://mirrors.kernel.org">http://mirrors.kernel.org</a> as a packages' mirror.</li><li class="listitem">Choose the additional packages:<div class="informalexample"><pre class="programlisting">Devel/binutils
Interpreters/m4
Utils/cpio
Archive/zip
Archive/unzip
System/procps</pre></div></li><li class="listitem">Perform the installation into the directory with the path in ASCII letters or numbers without spaces.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec53"/>How it works...</h2></div></div></div><p>Any antivirus<a id="id68" class="indexterm"/> software (or similar software that may scan the memory of other applications) is prohibited because it may interfere with Cygwin. Cygwin uses complex techniques to simulate the fork functionality of Unix on Windows. These techniques may not work with antivirus scanners running.</p><p>Only the<a id="id69" class="indexterm"/> i586 version on Cygwin is supported to build OpenJDK. The amd64 Cygwin may or may not work.</p><p>The Cygwin community hosts a lot of packages' mirrors worldwide. We use the <a class="ulink" href="https://www.kernel.org/">https://www.kernel.org/</a> mirror as one that should have the most complete set of prebuilt packages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">binutils</code> package is required for the <code class="literal">ar</code> utility. This is a special kind of archiver that may be used to create and update static libraries</li><li class="listitem" style="list-style-type: disc">The <code class="literal">m4</code> package is required to work with classic Unix macro processor scripts</li><li class="listitem" style="list-style-type: disc">The <code class="literal">cpio</code> utility is used as an archiver because it may be much faster than the more popular tar utility in some environments</li><li class="listitem" style="list-style-type: disc">The <code class="literal">procps</code> package is required for the free utility, which is used to get information about free and used memory</li></ul></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec54"/>There's more...</h2></div></div></div><p>OpenJDK 6 can also be built using commercial MKS toolkit. This method provides shorter build times, but is not supported for OpenJDK 8 and above.</p><p>A Cygwin installation may be copied from one Windows box to another without installation. This may be useful for builds on clean Windows boxes. Besides the usual windows binaries, Cygwin uses special kinds of symlink files, for example, <code class="literal">bin/awk</code> actually points to <code class="literal">bin/gawk.exe</code>. These symlinks may be crippled if loaded into or from version control systems such as Git. This problem may be circumvented by replacing symlinks with copies of actual binaries with symlink names: <code class="literal">gawk.exe</code> to <code class="literal">awk.exe</code> and so on.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec55"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK 6 with the list of required Cygwin packages at <a class="ulink" href="http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html#cygwin">http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html#cygwin</a></li><li class="listitem" style="list-style-type: disc">The list of applications that may interfere with Cygwin at <a class="ulink" href="https://cygwin.com/faq/faq.html#faq.using.bloda">https://cygwin.com/faq/faq.html#faq.using.bloda</a></li><li class="listitem" style="list-style-type: disc">The Cygwin user's guide at <a class="ulink" href="https://www.cygwin.com/cygwin-ug-net/cygwin-ug-net.html">https://www.cygwin.com/cygwin-ug-net/cygwin-ug-net.html</a></li></ul></div></div></div>
<div class="section" title="Building 32-bit FreeType libraries for OpenJDK 6 on Windows"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Building 32-bit FreeType libraries for OpenJDK 6 on Windows</h1></div></div></div><p>The<a id="id70" class="indexterm"/> majority of fonts used in modern software are encoded in vector format for proper scaling support. There are multiple<a id="id71" class="indexterm"/> standards for vector fonts, for example, Metafont from Professor Donald E. Knuth, Type1 from Adobe, TrueType from Apple and Microsoft, and OpenType from Adobe and Microsoft.</p><p>Rasterization of vector fonts is a remarkably complex task and most desktop software (such as web browsers or text processors) use third-party libraries to work with fonts.</p><p>Sun Microsystems licensed a third-party closed-source font library for use in Sun Java implementations. Sources of this library could not be released to public along with the initial release of OpenJDK. The Font Scaler Replacement Project was launched in the early days of OpenJDK to adopt an open source font library instead.</p><p>FreeType <a id="id72" class="indexterm"/>is a free and open source (under permissive license) font rasterization library. It is used widely in open source desktop software. FreeType was chosen by the OpenJDK team as a replacement for the closed-source font library and is now used by OpenJDK on all supported platforms. Prebuilt static and dynamic FreeType libraries are required for OpenJDK builds on Windows.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec56"/>Getting ready</h2></div></div></div><p>For this recipe we should have Windows 7 SP1 i586 running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec57"/>How to do it...</h2></div></div></div><p>The following steps will help us in building FreeType:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install Visual Studio.NET 2003 to the default installation path. Only Prerequisites and Visual C++ components are required.</li><li class="listitem">Download the <a id="id73" class="indexterm"/>FreeType 2.5.2 source tarball from <a class="ulink" href="http://freetype.org/">http://freetype.org/</a> and decompress it.</li><li class="listitem">Open the file <code class="literal">include\config\ftoption.h</code> and uncomment:<div class="informalexample"><pre class="programlisting">#define FT_CONFIG_OPTION_SUBPIXEL_RENDERING</pre></div></li><li class="listitem">Change lines <code class="literal">/* #define FT_EXPORT(x) extern x */</code> and <code class="literal">/* #define FT_EXPORT_DEF(x)  x */</code> to:<div class="informalexample"><pre class="programlisting">#define FT_EXPORT(x) __declspec(dllexport) x
#define FT_EXPORT_DEF(x) __declspec(dllexport) x</pre></div></li><li class="listitem">Open the project file <code class="literal">builds\windows\visualc\freetype.dsw</code> in Visual Studio.NET 2003.</li><li class="listitem">Change <code class="literal">Solution Configuration</code> to <code class="literal">Release Multithreaded</code> and build the solution. The <code class="literal">freetype252MT.lib</code> file will be placed into the <code class="literal">objs</code> directory.</li><li class="listitem">Rename the file <code class="literal">freetype.lib</code> and save it for OpenJDK builds.</li><li class="listitem">In <span class="strong"><strong>Project Properties</strong></span> change <span class="strong"><strong>Configuration Type</strong></span> to <span class="strong"><strong>Dynamic Library (.dll)</strong></span> and build the solution. The <code class="literal">freetype.dll</code> and <code class="literal">freetype.exp</code> files will be placed into the <code class="literal">objs\release_mt</code> directory.</li></ol></div><p>The <a id="id74" class="indexterm"/>directory <a id="id75" class="indexterm"/>with three result files will be denoted by the <code class="literal">ALT_FREETYPE_LIB_PATH</code> environment variable during OpenJDK builds.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec58"/>How it works...</h2></div></div></div><p>The <code class="literal">FT_CONFIG_OPTION_SUBPIXEL_RENDERING</code> macro enables subpixel rendering functionality in FreeType implementation.</p><p>The <code class="literal">FT_EXPORT</code> and <code class="literal">FT_EXPORT_DEF</code> macros should be adjusted with the calling conventions for the current platform. We changed them to use Windows-specific calling conventions.</p><p>FreeType has no predefined project file for Visual Studio.NET 2003. Instead, we are using the project file created for Visual Studio 6.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec59"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 64-bit FreeType libraries for OpenJDK 6 on Windows</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The FreeType official website <a class="ulink" href="http://freetype.org/">http://freetype.org/</a></li><li class="listitem" style="list-style-type: disc">Professor Donald E. Knuth's interview covering Metafont and TrueType at <a class="ulink" href="http://www.advogato.org/article/28.html">http://www.advogato.org/article/28.html</a></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>OpenJDK: Font Scaler Replacement Project</em></span> page at <a class="ulink" href="http://openjdk.java.net/projects/font-sc">http://openjdk.java.net/projects/font-sc</a></li></ul></div></div></div>
<div class="section" title="Building 64-bit FreeType libraries for OpenJDK 6 on Windows"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Building 64-bit FreeType libraries for OpenJDK 6 on Windows</h1></div></div></div><p>The FreeType build<a id="id76" class="indexterm"/> for Windows amd64 is similar to the i586 build but has a much more complex configuration. <a id="id77" class="indexterm"/>Contrary to the i586 version, the amd64 library can be built with freely available tools using Microsoft Visual Studio 2005 Express Edition with the Windows Server 2003 SP1 Platform SDK.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec60"/>Getting ready</h2></div></div></div><p>For this recipe, we need to have Windows 7 SP1 amd64 running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec61"/>How to do it...</h2></div></div></div><p>The following steps will help us in building FreeType:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download the Visual Studio 2005 Express Edition<a id="id78" class="indexterm"/> from <a class="ulink" href="http://www.microsoft.com/en-in/default.aspx">http://www.microsoft.com/en-in/default.aspx</a> and install it to the default location. The messages about Windows 7 compatibility problems may be ignored.</li><li class="listitem">Install <code class="literal">VS80sp1-KB926748-X86-INTL</code> and <code class="literal">VS80sp1-KB932232-X86-ENU </code>Visual Studio updates.</li><li class="listitem">Download Windows Server 2003 SP1 Platform SDK<a id="id79" class="indexterm"/> from <a class="ulink" href="http://www.microsoft.com/en-in/default.aspx">http://www.microsoft.com/en-in/default.aspx</a> and install it using the default installation path. AMD-64 components are required for the build.</li><li class="listitem">Perform steps 2, 3, and 4 from the previous recipe to download and adjust FreeType sources.</li><li class="listitem">From the <span class="strong"><strong>Start</strong></span> menu go to <span class="strong"><strong>Microsoft Platform SDK for Windows Server 2003 SP1</strong></span> | <span class="strong"><strong>Open Build Environment Window</strong></span> | <span class="strong"><strong>Windows Server 2003 64-bit Build Environment</strong></span> | <span class="strong"><strong>Set Win Svr 2003 x64 Build Env (Retail)</strong></span>.</li><li class="listitem">From the <code class="literal">cmd.exe</code> window that appears, run (the administrator permissions warning may be ignored):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;"C:\Program Files (x86)\Microsoft Visual Studio 8\Common7\IDE\VCExpress.exe"</strong></span>
</pre></div></li><li class="listitem">In the main menu navigate to <span class="strong"><strong>Tools</strong></span> | <span class="strong"><strong>Options</strong></span> | <span class="strong"><strong>Projects and Solutions</strong></span> | <span class="strong"><strong>VC++ Directories</strong></span> and adjust the following directories:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Executable files:</strong></span>

C:\Program Files\Microsoft Platform SDK\Bin\win64\x86\AMD64
C:\Program Files\Microsoft Platform SDK\Bin
C:\Windows\System32

<span class="strong"><strong>Include files:</strong></span>
C:\Program Files\Microsoft Platform SDK\Include
C:\Program Files\Microsoft Platform SDK\Include\crt

<span class="strong"><strong>Library files:</strong></span>
C:\Program Files\Microsoft Platform SDK\Lib\AMD64</pre></div></li><li class="listitem">Open the FreeType solution at this path <code class="literal">freetype-2.5.2\builds\windows\vc2005\freetype.sln</code>.</li><li class="listitem">In the menu, navigate to <span class="strong"><strong>Project</strong></span> | <span class="strong"><strong>Properties</strong></span> | <span class="strong"><strong>Configuration Properties</strong></span> | <span class="strong"><strong>Configuration Manager</strong></span> and choose <span class="strong"><strong>&lt;New ...&gt; </strong></span>under<span class="strong"><strong> Active solution platform</strong></span>.</li><li class="listitem">Type <code class="literal">new platform x64</code> and choose<span class="strong"><strong> Win32 </strong></span>from <span class="strong"><strong>Copy settings from</strong></span>.</li><li class="listitem">On the <span class="strong"><strong>Configuration Manager</strong></span> form, navigate to <span class="strong"><strong>Active solution configuration</strong></span> | <span class="strong"><strong>LIB Release Multithreaded</strong></span> and then go to <span class="strong"><strong>Active solution platform</strong></span> | <span class="strong"><strong>x64</strong></span>.</li><li class="listitem">On the <a id="id80" class="indexterm"/>same form, in the grid for the FreeType project, navigate to <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Release multithreaded</strong></span> and leave the <span class="strong"><strong>Win32</strong></span> value under the <span class="strong"><strong>Platform</strong></span> menu.</li><li class="listitem">In the <span class="strong"><strong>Configuration Properties</strong></span> menu, check whether <span class="strong"><strong>Configuration Type</strong></span> is set to <span class="strong"><strong>Static Library (.lib)</strong></span>.</li><li class="listitem">Navigate<a id="id81" class="indexterm"/> to <span class="strong"><strong>Configuration Properties</strong></span> | <span class="strong"><strong>C/C++</strong></span> | <span class="strong"><strong>Preprocessor</strong></span> and change the <span class="strong"><strong>WIN32</strong></span> value in the <span class="strong"><strong>Processor Definitions</strong></span> string to <span class="strong"><strong>WIN64</strong></span>.</li><li class="listitem">Run <span class="strong"><strong>Build Solution </strong></span>under<span class="strong"><strong> Build</strong></span>, the <code class="literal">freetype252MT.lib</code> library will be placed into the <code class="literal">freetype-2.5.2\objs\win32\vc2005</code> directory. Rename it to <code class="literal">freetype.lib</code>, and save it for later.</li><li class="listitem">In the <span class="strong"><strong>Configuration Properties</strong></span> menu, change <span class="strong"><strong>Configuration Type</strong></span> to <span class="strong"><strong>Dynamic Library (.dll)</strong></span> and choose <span class="strong"><strong>Apply</strong></span>.</li><li class="listitem">Navigate to <span class="strong"><strong>Configuration Properties</strong></span> | <span class="strong"><strong>Linker</strong></span> | <span class="strong"><strong>Input</strong></span> and put <code class="literal">bufferoverflowU.lib</code> into the <span class="strong"><strong>Additional Dependencies</strong></span> field.</li><li class="listitem">Navigate to <span class="strong"><strong>Configuration Properties</strong></span> | <span class="strong"><strong>Linker</strong></span> | <span class="strong"><strong>Command Line</strong></span> and put <code class="literal">/MACHINE:AMD64</code> into the <span class="strong"><strong>Additional options</strong></span> field.</li><li class="listitem">Clean and build the solution. Target libraries <code class="literal">freetype.dll</code> and <code class="literal">freetype.exp</code> will be placed into the <code class="literal">freetype-2.5.2\objs\release_mt</code> directory.</li></ol></div><p>The directory with three result files will be denoted by the <code class="literal">ALT_FREETYPE_LIB_PATH</code> environment variable during OpenJDK builds.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec62"/>How it works...</h2></div></div></div><p>Visual Studio 2005 Express <a id="id82" class="indexterm"/>does not support amd64 architecture, so the setup to use amd64 compilers from Windows SDK takes most of this recipe.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec63"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 32-bit FreeType libraries for OpenJDK 6 on Windows</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The FreeType official website <a class="ulink" href="http://freetype.org/">http://freetype.org/</a></li></ul></div></div></div>
<div class="section" title="Building 32-bit OpenJDK 6 on Windows 7 SP1"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Building 32-bit OpenJDK 6 on Windows 7 SP1</h1></div></div></div><p>Windows builds are <a id="id83" class="indexterm"/>much more cumbersome than Linux ones. Despite that, GCC toolchain is available on Windows. Through<a id="id84" class="indexterm"/> the MinGW project, OpenJDK uses official Microsoft compilers from Visual Studio and Windows SDK. This brings a lot of complications because the Microsoft toolchain doesn't work well with the Unix-like environment provided by Cygwin.</p><p>Visual Studio.NET 2003 is required to build i586 binaries. OpenJDK 6 on Windows i586 is the only version in this book that cannot be built using freely available tools. VS 2003 was chosen for OpenJDK 6 because it supports Windows 2000, which was critical at the time of Sun Java 6's development.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec64"/>Getting ready</h2></div></div></div><p>For this recipe, we should have Windows 7 SP1 i586 running with no antivirus software installed. Antivirus software is not allowed because it may interfere with the Cygwin runtime.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec65"/>How to do it...</h2></div></div></div><p>The following steps will help us to build OpenJDK 6:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install Visual Studio.NET 2003 to the default installation path. Only the prerequisites and the Visual C++.NET component are required.</li><li class="listitem">Install or copy the preinstalled version of Cygwin to <code class="literal">c:\cygwin</code>.</li><li class="listitem">Download and install Microsoft DirectX 9.0 SDK (Summer 2004) to the default installation path. Note that this distribution is not available anymore from the <a class="ulink" href="http://www.microsoft.com/en-in/default.aspx">http://www.microsoft.com/en-in/default.aspx</a> website. We can download it from some other places online and check the file details:<div class="informalexample"><pre class="programlisting">name: dxsdk_sum2004.exe
size: 239008008 bytes
sha1sum: 73d875b97591f48707c38ec0dbc63982ff45c661</pre></div></li><li class="listitem">Download Platform Software Development Kit Redistributable: Microsoft Layer for Unicode on Windows 95, 98, and Me Systems, 1.1.3790.0 from <a class="ulink" href="http://www.microsoft.com/en-in/default.aspx">http://www.microsoft.com/en-in/default.aspx</a> and install it into the <code class="literal">c:\unicows</code> directory.</li><li class="listitem">Download <code class="literal">unicows.lib</code> from the <code class="literal">openjdk-unofficial-builds</code> GitHub project and put this into the <code class="literal">c:\unicows</code> directory too.</li><li class="listitem">Download the Apache Ant version 1.8.4 ZIP distribution from the <a class="ulink" href="http://apache.org/">http://apache.org/</a> website and decompress it into the <code class="literal">c:\ant</code> directory.</li><li class="listitem">Download <a id="id85" class="indexterm"/>GNU make utility binary from the <a class="ulink" href="http://www.cmake.org/">http://www.cmake.org/</a> website using <a class="ulink" href="http://www.cmake.org/files/cygwin/make.exe-cygwin1.7">http://www.cmake.org/files/cygwin/make.exe-cygwin1.7</a>, rename it to <code class="literal">make.exe</code>, and put it into the <code class="literal">c:\make</code> directory.</li><li class="listitem">Create the <code class="literal">c:\path_prepend</code> directory and copy the <code class="literal">find.exe</code> and <code class="literal">sort.exe</code> files from the Cygwin installation.</li><li class="listitem">Download the <a id="id86" class="indexterm"/>prebuilt FreeType libraries from the <code class="literal">openjdk-unofficial-builds</code> GitHub project (directory <code class="literal">6_32</code>) and put the binaries into the <code class="literal">c:\freetype</code> directory and header files into the <code class="literal">c:\freetype\include</code> directory.</li><li class="listitem">Install OpenJDK 6 binaries or Oracle Java 6 into <code class="literal">c:\jdk6</code>.</li><li class="listitem">Download the official OpenJDK 6 build 30 sources tarball from the <a class="ulink" href="https://java.net/projects/openjdk6/downloads">https://java.net/projects/openjdk6/downloads</a> web page and decompress it into the <code class="literal">c:\sources</code> directory (warning: the tarball does not include the <code class="literal">root</code> directory)</li><li class="listitem">In the <code class="literal">sa.make</code> file at <code class="literal">hotspot\make\windows\makefiles</code>, change line 100 from <code class="literal">SA_CFLAGS = $(SA_CFLAGS) /ZI</code> to:<div class="informalexample"><pre class="programlisting">SA_CFLAGS = $(SA_CFLAGS) /Zi</pre></div></li><li class="listitem">Create a <code class="literal">build.bat</code> batch file and write the following environment variables settings there:<div class="informalexample"><pre class="programlisting">@echo off
set LD_LIBRARY_PATH=
set CLASSPATH=
set JAVA_HOME=
set PATH=c:/path_prepend;C:/WINDOWS/system32;C:/WINDOWS;C:/WINDOWS/System32/Wbem;c:/make;c:/cygwin/bin;c:/jdk6/bin;c:/ant/bin
set ALT_BOOTDIR=c:/jdk6
set ALT_FREETYPE_LIB_PATH=c:/freetype
set ALT_FREETYPE_HEADERS_PATH=c:/freetype/include
set ALT_UNICOWS_LIB_PATH=c:/unicows
set ALT_UNICOWS_DLL_PATH=c:/unicows
call "C:/Program Files/Microsoft Visual Studio .NET 2003/Common7/Tools/vsvars32.bat"
bash
echo Press any key to close window ...
pause &gt; nul</pre></div></li><li class="listitem">Run <code class="literal">build.bat</code> from Windows Explorer. The <code class="literal">cmd.exe</code> window should appear with bash launched.</li><li class="listitem">From the<a id="id87" class="indexterm"/> bash Command Prompt run the following commands:<div class="informalexample"><pre class="programlisting">cd /cygdrive/c/sources
chmod –R 777
make &gt; make.log 2&gt;&amp;1</pre></div></li><li class="listitem">Launch another Cygwin console and run the following commands:<div class="informalexample"><pre class="programlisting">cd /cygdrive/c/sources
tail -f make.log</pre></div></li><li class="listitem">Wait for the build to finish.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec66"/>How it works...</h2></div></div></div><p>Cygwin<a id="id88" class="indexterm"/> installation is covered in the <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe of this chapter.</p><p>Directories in the root of disk <code class="literal">C</code> are used here for brevity. Generally, arbitrary paths consisting of ASCII letters or numbers and without spaces can be used.</p><p>Visual Studio 2003 is not officially supported on Windows 7. It warns about possible compatibility problems and may have glitches in the GUI interface, but its command-line tools work fine and the GUI interface is not needed for the OpenJDK build.</p><p>The newer version of DirectX SDK may also be used.</p><p>Different GNU make versions may have different problems on Windows. This particular version from the <code class="literal">cmake</code> project was tested on different Windows versions and works fine.</p><p>This recipe uses prebuilt FreeType 2.4.10 libraries from the <code class="literal">openjdk-unofficial-builds</code> GitHub project. FreeType may be built from sources using Visual Studio 2003. Please see the <span class="emphasis"><em>Building 32-bit FreeType libraries for OpenJDK 6 on Windows</em></span> recipe in this chapter.</p><p>A patch for HotSpot serviceability <code class="literal">Makefile</code> file is required to circumvent the VS2003 bug discovered after one of the recent security updates. This change is going to be upstreamed into official OpenJDK 6 sources and may not be required for more recent source tarballs.</p><p>In environment <a id="id89" class="indexterm"/>settings, additional attention should be paid to the order of the contents of the <code class="literal">PATH</code> variable order. The <code class="literal">sort</code> and <code class="literal">find</code> Cygwin utilities go at the start of the <code class="literal">PATH</code> variable so they are not overshadowed by Windows utilities with the same name but a different functionality. The <code class="literal">make</code> utility is going goes before Cygwin to not be so they are not overshadowed by another version of make that may be included in the Cygwin installation.</p><p>The <code class="literal">chmod 777</code> command is required to fix Cygwin file permissions that may cause errors in later stages of the build.</p><p>The <code class="literal">make</code> output will be redirected to the <code class="literal">make.log</code> file. The <code class="literal">2&gt;&amp;1</code> statement ensures that both <code class="literal">stdout</code> and <code class="literal">stderr</code> will be redirected.</p><p>The <code class="literal">tail -f</code> command allows us to watch the contents of the <code class="literal">make.log</code> file as they are written during the build process.</p><p>The <code class="literal">pause &gt; nul</code> command is added at the end of the batch file to prevent the <code class="literal">cmd.exe</code> window from disappearing in the case of runtime errors.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec67"/>There's more...</h2></div></div></div><p>To build the most compatible binaries, the same recipe should be used, but the Windows 2000 operating system should be used instead of Windows 7.</p><p>In Windows 2000, the <code class="literal">chmod 777</code> command is not required.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec68"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</em></span> recipe, for information about build tuning</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 32-bit FreeType libraries for OpenJDK 6 on Windows</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK 6 at <a class="ulink" href="http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html">http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html</a></li><li class="listitem" style="list-style-type: disc">The mailing list thread about the Serviceability HotSpot patch at <a class="ulink" href="http://mail.openjdk.java.net/pipermail/jdk6-dev/2013-December/003163.html">http://mail.openjdk.java.net/pipermail/jdk6-dev/2013-December/003163.html</a></li></ul></div></div></div>
<div class="section" title="Building 64-bit OpenJDK 6 on Windows 7 x64 SP1"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec24"/>Building 64-bit OpenJDK 6 on Windows 7 x64 SP1</h1></div></div></div><p>The<a id="id90" class="indexterm"/> amd64 build on<a id="id91" class="indexterm"/> Windows 7 is similar to the i586 build, but has additional complications.</p><p>Cygwin (at least the more common i586 version) works much worse on amd64 Windows. Due to a much bigger address space size, Cygwin fork techniques work much slower and are less reliable.</p><p>Visual Studio.NET 2003 does not support the amd64 architecture so the Windows Server 2003 SP1 Platform SDK is used instead.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec69"/>Getting ready</h2></div></div></div><p>For this recipe, we should have Windows 7 SP1 i586 running with no antivirus software installed. Antivirus software is not allowed because it may interfere with the Cygwin runtime.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec70"/>How to do it...</h2></div></div></div><p>The following steps will help us to build OpenJDK:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download the Windows Server 2003 SP1 Platform SDK from the Microsoft website and install it using the default installation path. AMD-64 and MDAC (Microsoft Data Access Services) components are required for the build.</li><li class="listitem">Perform steps 2 to 11 from the <span class="emphasis"><em>Building 32-bit OpenJDK 6 on Windows 7 SP1</em></span> recipe (for FreeType libraries use <code class="literal">6_64</code> directory).</li><li class="listitem">Step 12 from the previous recipe is not required for the amd64 build and may be skipped.</li><li class="listitem">Create a <code class="literal">build.bat</code> batch file and write the following environment variables settings:<div class="informalexample"><pre class="programlisting">@echo off
set LD_LIBRARY_PATH=
set CLASSPATH=
set JAVA_HOME=
set PATH=C:/path_prepend;C:/WINDOWS/system32;C:/WINDOWS;C:/WINDOWS/System32/Wbem;C:/make;C:/cygwin/bin;C:/jdk6/bin;C:/ant/bin
set ALT_BOOTDIR=c:/jdk6
set ALT_FREETYPE_LIB_PATH=c:/freetype
set ALT_FREETYPE_HEADERS_PATH=c:/freetype/include
set ALT_UNICOWS_LIB_PATH=c:/unicows
set ALT_UNICOWS_DLL_PATH=c:/unicows
call "C:/Program Files/Microsoft Platform SDK"/SetEnv.cmd /X64 /RETAIL
bash
echo Press any key to close window ...
pause &gt; nul</pre></div></li><li class="listitem">Follow steps 14 to 17 from the previous recipe.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec71"/>How it works...</h2></div></div></div><p>Most of the <a id="id92" class="indexterm"/>notes from the i586 build are also valid for the amd64 build except those specific to VS2003.</p><p>Patch to serviceability <code class="literal">Makefile</code> is not required because that part of <code class="literal">Makefile</code> is specific to i586 builds.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec72"/>There's more...</h2></div></div></div><p>To build the <a id="id93" class="indexterm"/>most compatible binaries, the same recipe should be used, but the Windows 2003 Server amd64 operating system should be used instead of Windows 7.</p><p>In Windows 2003, the <code class="literal">chmod 777</code> command is not required.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec73"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</em></span> recipe, for information about build tuning</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 64-bit FreeType libraries for OpenJDK 6 on Windows</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing</em></span><span class="emphasis"><em> CA certificates</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK 6 at <a class="ulink" href="http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html">http://hg.openjdk.java.net/jdk6/jdk6/raw-file/tip/README-builds.html</a></li></ul></div></div></div></body></html>