<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;5.&#xA0;Exploring Code Coverage"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Exploring Code Coverage</h1></div></div></div><p class="calibre9">This chapter explains the code coverage, coverage tools, and provides step-by-step guidance to generate a coverage report.</p><p class="calibre9">The following topics are covered in this chapter:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Code, branch, and line coverage</li><li class="listitem">Coverage tools such as Clover, Cobertura, EclEmma, and JaCoCo</li><li class="listitem">Measuring coverage using Eclipse plugins</li><li class="listitem">Using Ant, Maven, and Gradle to generate reports</li></ul></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Exploring Code Coverage">
<div class="book" title="Understanding code coverage"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec25" class="calibre1"/>Understanding code coverage</h1></div></div></div><p class="calibre9">
<span class="strong"><strong class="calibre10">Code coverage</strong></span> is a measurement <a id="id439" class="calibre1"/>of percentage of instructions of code being executed while the automated tests are running.</p><p class="calibre9">A piece of code with high code coverage implies that the code has been thoroughly unit tested and has a lower chance of containing bugs than code with a low code coverage. You should concentrate on writing meaningful (business logic) unit tests and not on having 100 percent coverage because it's easy to cheat and have 100 percent coverage with completely useless tests.</p><p class="calibre9">Numerous metrics can be used to measure the<a id="id440" class="calibre1"/> code coverage. The following are the ones that are widely used:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre10">Statement or line coverage</strong></span>: This measures<a id="id441" class="calibre1"/> the statements or lines being covered</li><li class="listitem"><span class="strong"><strong class="calibre10">Branch coverage</strong></span>: This measures <a id="id442" class="calibre1"/>the percentage of each branch of each control structure, such as the if else and switch case statements</li><li class="listitem"><span class="strong"><strong class="calibre10">Function or method coverage</strong></span>: This measures<a id="id443" class="calibre1"/> the function execution</li></ul></div><p class="calibre9">The following Java code will elucidate the metrics.</p><p class="calibre9">An <code class="literal">absSum</code> method takes two integer arguments and then returns the absolute sum of the two arguments. An <code class="literal">Integer</code> type can<a id="id444" class="calibre1"/> hold a <code class="literal">NULL</code> value, so the method checks for <code class="literal">NULL</code>. If both arguments are <code class="literal">NULL</code>, then the method returns <code class="literal">0</code> as given in the following code:</p><div class="informalexample"><pre class="programlisting">public class Metrics {
  public int absSum(Integer op1, Integer op2) {
    <span class="strong"><strong class="calibre10">if (op1 == null &amp;&amp; op2 == null) {</strong></span>
      return 0;
    }
    <span class="strong"><strong class="calibre10">if (op1 == null &amp;&amp; op2 != null) {</strong></span>
      return Math.abs(op2);
    }
    <span class="strong"><strong class="calibre10">if (op2 == null) {</strong></span>
      return Math.abs(op1);
    }
    return Math.abs(op1)+Math.abs(op2);
  }
}</pre></div><p class="calibre9">This example has 10 branches: the first <code class="literal">if(op1 == null &amp;&amp; op2 == null)</code> statement has four branches: <code class="literal">op1 == null</code>, <code class="literal">op1!= null</code>, <code class="literal">op2 == null</code>, and <code class="literal">op2 != null</code>. Similarly, the second <code class="literal">if</code> statement has four branches and the last <code class="literal">if (op2 == null)</code> statement has two branches, <code class="literal">op2== null</code> and <code class="literal">op2 != null</code>.</p><p class="calibre9">If a test passes two non-null integers to the <code class="literal">absSum</code> method, then it covers four lines, that is, three <code class="literal">if</code> statements and the final <code class="literal">return</code> statement, but the first three <code class="literal">return</code> statements remain uncovered. It covers three out of ten branches; the first <code class="literal">if</code> statement covers one out of four branches, that is, <code class="literal">op1 == null</code>. Similarly, the second <code class="literal">if</code> statement covers one branch out of four branches, and the last <code class="literal">if</code> statement covers one branch out of two branches <code class="literal">op2 != null</code>. So, the branch coverage becomes 30 percent.</p><p class="calibre9">To cover all instructions and all branches, the following four input pairs need to be passed to the method: <code class="literal">[null, null]</code>, <code class="literal">[null, value]</code>, <code class="literal">[value, null]</code>, and <code class="literal">[value, value]</code>.</p></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Exploring Code Coverage">
<div class="book" title="Understanding code coverage">
<div class="book" title="Learning the inner details of code instrumentation"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec33" class="calibre1"/>Learning the inner details of code instrumentation</h2></div></div></div><p class="calibre9">Coverage is measured by<a id="id445" class="calibre1"/> the ratio of basic code branches or instructions that were exercised by some tests to the total number of instructions or branches available in the system under test.</p><p class="calibre9">The ratio is measured in a series of steps. First, in a copy of source code, each block of statement is instrumented with an accumulator flag. Then, the tests run on the instrumented code and update the flags. Finally, a program collects the accumulator flags and measures the ratio of the flags turned on versus the total number of flags. Bytecode can be changed on the fly or during compilation. This is actually what test coverage frameworks do under the covers.</p><p class="calibre9">Two code instrumentation <a id="id446" class="calibre1"/>options are available: source code<a id="id447" class="calibre1"/> instrumentation and<a id="id448" class="calibre1"/> object code instrumentation. Object code instrumentation modifies the generated bytecode, so it is hard to implement.</p><p class="calibre9">The preceding code coverage example has seven lines, but if we expand the branches into lines, then it will result in 14 lines. If a coverage tool needs to instrument the code, then it will modify the source code and initialize an array of length 14 with <code class="literal">0</code> and set <code class="literal">1</code> when a line is executed while a test is being run. The following example demonstrates the source code instrumentation:</p><div class="informalexample"><pre class="programlisting">  int[] visitedLines = new int[14];
  public int absSumModified(Integer op1 , Integer op2) {
    visitedLines[0] = 1;
    if(op1 == null) {
      visitedLines[1] = 1;
      if(op2 == null) {
        visitedLines[2] = 1;
        return 0;
      }else {
        <span class="strong"><strong class="calibre10">visitedLines[3] = 1;</strong></span>
      }
    }else {
      visitedLines[4] = 1;
    }
    
    visitedLines[5] = 1;
    if(op1 == null) {
      <span class="strong"><strong class="calibre10">visitedLines[6] = 1;</strong></span>
      if(op2 != null) {
        <span class="strong"><strong class="calibre10">visitedLines[7] = 1;</strong></span>
        return Math.abs(op2);
      }else {
        <span class="strong"><strong class="calibre10">visitedLines[8] = 1;</strong></span>
      }
    }else {
      visitedLines[9] = 1;
    }
    
    visitedLines[10] = 1;
    if(op2 == null) {
      <span class="strong"><strong class="calibre10">visitedLines[11] = 1;</strong></span>
      return Math.abs(op1);
    }else {
      visitedLines[12] = 1;
    }
    visitedLines[13] = 1;
    return Math.abs(op1)+Math.abs(op2);
  }}</pre></div><p class="calibre9">After test execution, the coverage tool checks the <code class="literal">visitedLines</code> array and computes the ratio of all lines that have <code class="literal">visitedLines[index]</code> equal to <code class="literal">1</code> versus the total number of lines. If we test the<a id="id449" class="calibre1"/> method with the input sets <code class="literal">[null, null]</code> and <code class="literal">[value, value]</code>, then the five lines (lines 4, 7, 8, 9, and 12) remain uncovered. To cover 100 percent, we need to test the method with four possible combinations of null and non-null integers.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring the Eclipse plugin"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec26" class="calibre1"/>Configuring the Eclipse plugin</h1></div></div></div><p class="calibre9">We learned that the coverage tools can either instrument the object code or source code. Java code coverage tools can<a id="id450" class="calibre1"/> be categorized into two sections: tools that instrument the source code and tools that instrument the bytecode.</p><p class="calibre9">Source code<a id="id451" class="calibre1"/> instrumentation is easier but requires source code recompilation. Bytecode instrumentation is complex but doesn't require source code recompilation.</p><p class="calibre9">The following are the available Java code coverage tools:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre10">Cobertura</strong></span>: This tool instruments the bytecode offline and is a widely used coverage tool. Cobertura is<a id="id452" class="calibre1"/> an open source project (GNU GPL) and is very<a id="id453" class="calibre1"/> easy to configure with Eclipse and build tools. Version 1.9, which was released in March 2010, is the latest stable version.</li><li class="listitem"><span class="strong"><strong class="calibre10">EMMA</strong></span>: This tool instruments<a id="id454" class="calibre1"/> the bytecode offline or on the fly and is distributed under<a id="id455" class="calibre1"/> the <span class="strong"><strong class="calibre10">Common Public License</strong></span> (<span class="strong"><strong class="calibre10">CPL</strong></span>). Version 2.1, released in June 2005, is the latest version. <span class="strong"><strong class="calibre10">Google CodePro AnalytiX</strong></span><a id="id456" class="calibre1"/> is based on EMMA.</li><li class="listitem"><span class="strong"><strong class="calibre10">Clover</strong></span>: This tool instruments the source code and comes with a proprietary Atlassian license, and the<a id="id457" class="calibre1"/> latest stable version, 3.2, was<a id="id458" class="calibre1"/> released in February 2014.</li><li class="listitem"><span class="strong"><strong class="calibre10">JaCoCo</strong></span>: This tool is distributed under <a id="id459" class="calibre1"/><span class="strong"><strong class="calibre10">Eclipse Public License</strong></span> (<span class="strong"><strong class="calibre10">EPL</strong></span>). JaCoCo instruments<a id="id460" class="calibre1"/> the bytecode on the fly while running the code. The latest stable version, 0.6.4, was<a id="id461" class="calibre1"/> released in December 2013. JaCoCo was a replacement of EMMA. EclEmma is a JaCoCo-based Eclipse plugin.</li></ul></div><p class="calibre9">The following section will explore the Eclipse plugins based on the preceding Java-based coverage tools.</p></div>

<div class="book" title="Configuring the Eclipse plugin">
<div class="book" title="Uncovering the Clover plugin"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec34" class="calibre1"/>Uncovering the Clover plugin</h2></div></div></div><p class="calibre9">A trial version of the Clover plugin can be installed for a month. You can refer to the installation instruction at <a class="calibre1" href="https://confluence.atlassian.com/display/CLOVER/">https://confluence.atlassian.com/display/CLOVER/</a>. The Clover Eclipse plugin supports the site update and manual download installation.</p><p class="calibre9">The following are the<a id="id462" class="calibre1"/> steps to install and <a id="id463" class="calibre1"/>execute the Clover plugin:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">During installation, Clover<a id="id464" class="calibre1"/> shows a list of installable elements. Expand the <span class="strong"><strong class="calibre10">Clover</strong></span> blind and select <span class="strong"><strong class="calibre10">Clover 3</strong></span> and <span class="strong"><strong class="calibre10">Clover 3 Ant Support</strong></span>. The following screenshot displays the details:<div class="mediaobject"><img src="../images/00059.jpeg" alt="Uncovering the Clover plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="2">Open the <span class="strong"><strong class="calibre10">Show View</strong></span> menu and select all <span class="strong"><strong class="calibre10">Clover</strong></span> views. The following screenshot displays the <span class="strong"><strong class="calibre10">Clover</strong></span> views:<div class="mediaobject"><img src="../images/00060.jpeg" alt="Uncovering the Clover plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="3">Create a new Java project named <code class="literal">Chapter05</code> and add the <code class="literal">Metrics.java</code> and <code class="literal">MetricsTest.java</code> Java files<a id="id465" class="calibre1"/> as designed in the preceding section. Open Clover's <span class="strong"><strong class="calibre10">Coverage Explorer</strong></span> and click on the<a id="id466" class="calibre1"/> <span class="strong"><strong class="calibre10">Enable or disable Clover on one or more project</strong></span> button. The following screenshot shows the button details:<div class="mediaobject"><img src="../images/00061.jpeg" alt="Uncovering the Clover plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="4">Select the <code class="literal">Chapter05</code> project. Clover will enable the source code instrumentation on this project. Right-click on the <code class="literal">MetricsTest</code> file and go to <span class="strong"><strong class="calibre10">Run With Clover As</strong></span> | <span class="strong"><strong class="calibre10">JUnit Test</strong></span>. The following screenshot shows the pop-up menu:<div class="mediaobject"><img src="../images/00062.jpeg" alt="Uncovering the Clover plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="5">Open <span class="strong"><strong class="calibre10">Coverage Explorer</strong></span> and it will show the following coverage output:<div class="mediaobject"><img src="../images/00063.jpeg" alt="Uncovering the Clover plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="6">Open <span class="strong"><strong class="calibre10">Clover Dashboard</strong></span>. The dashboard will show you the coverage details, test results, complexity, and the<a id="id467" class="calibre1"/> least-tested methods. The following<a id="id468" class="calibre1"/> screenshot shows the dashboard details:<div class="mediaobject"><img src="../images/00064.jpeg" alt="Uncovering the Clover plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="7">Open the source code. The clover plugin decorates the source code; the uncovered lines become red and the covered lines become green. It also shows the execution count against each line. The following is the instrumented source code output:<div class="mediaobject"><img src="../images/00065.jpeg" alt="Uncovering the Clover plugin" class="calibre12"/></div><p class="calibre16"> </p></li></ol><div class="calibre17"/></div></div></div>

<div class="book" title="Configuring the Eclipse plugin">
<div class="book" title="Working with the EclEmma plugin"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec35" class="calibre1"/>Working with the EclEmma plugin</h2></div></div></div><p class="calibre9">EclEmma Version 2.0 is based on the JaCoCo code coverage library. Follow the instructions at <a class="calibre1" href="http://www.eclemma.org/index.html">http://www.eclemma.org/index.html</a> to install the<a id="id469" class="calibre1"/> EclEmma Eclipse plugin. Like Clover, EclEmma supports site update and its manual download.</p><p class="calibre9">Once EclEmma<a id="id470" class="calibre1"/> is installed, follow the steps to configure and execute tests using EclEmma:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Right-click on the test class and go to <span class="strong"><strong class="calibre10">Coverage As</strong></span> | <span class="strong"><strong class="calibre10">1 JUnit Test</strong></span>. This will instrument the bytecode<a id="id471" class="calibre1"/> on the fly and bring up the coverage report.</li><li class="listitem" value="2">After EclEmma installation, a new menu button appears under the main menu panel. When you expand this menu, it shows the JUnit tests that have been executed recently. Click on the menu button to generate the coverage report. The following screenshot shows the EclEmma code coverage menu button:<div class="mediaobject"><img src="../images/00066.jpeg" alt="Working with the EclEmma plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="3">When you open the <span class="strong"><strong class="calibre10">Coverage</strong></span> tab, it shows the coverage details. The following screenshot shows the output:<div class="mediaobject"><img src="../images/00067.jpeg" alt="Working with the EclEmma plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="4">The branch coverage report is more prominent in EclEmma. The following screenshot shows the coverage details:<div class="mediaobject"><img src="../images/00068.jpeg" alt="Working with the EclEmma plugin" class="calibre12"/></div><p class="calibre16"> </p><p class="calibre15">A green diamond signifies that the branch is 100 percent covered, a red diamond<a id="id472" class="calibre1"/> signifies the branch is not covered, and a yellow diamond signifies that the branch is partially covered.</p></li></ol><div class="calibre17"/></div></div></div>

<div class="book" title="Configuring the Eclipse plugin">
<div class="book" title="Examining the eCobertura plugin"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec36" class="calibre1"/>Examining the eCobertura plugin</h2></div></div></div><p class="calibre9">
<span class="strong"><strong class="calibre10">eCobertura</strong></span> is a Cobertura-based<a id="id473" class="calibre1"/> Eclipse plugin. eCobertura shows the branch coverage in a tabular format. To install the eCobertura<a id="id474" class="calibre1"/> plugin, go to <a class="calibre1" href="https://marketplace.eclipse.org/content/ecobertura#.UxYBmoVh85w">https://marketplace.eclipse.org/content/ecobertura#.UxYBmoVh85w</a> and drag the <span class="strong"><strong class="calibre10">Install</strong></span> button to your Eclipse workspace that is running. Eclipse will automatically install the <a id="id475" class="calibre1"/>plugin for you. The following screenshot shows the Marketplace <span class="strong"><strong class="calibre10">Install</strong></span> button:</p><div class="mediaobject"><img src="../images/00069.jpeg" alt="Examining the eCobertura plugin" class="calibre12"/></div><p class="calibre13"> </p><p class="calibre9">After installation, a new menu button appears under the menu panel for Cobertura, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00070.jpeg" alt="Examining the eCobertura plugin" class="calibre12"/></div><p class="calibre13"> </p><p class="calibre9">The following are the steps to <a id="id476" class="calibre1"/>measure code<a id="id477" class="calibre1"/> coverage using eCobertura:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Go to <span class="strong"><strong class="calibre10">Show View</strong></span> | <span class="strong"><strong class="calibre10">Other,</strong></span> and select the <span class="strong"><strong class="calibre10">Coverage Session View</strong></span> option under <span class="strong"><strong class="calibre10">eCobertura</strong></span>.</li><li class="listitem" value="2">Execute the test and then click on the Cobertura menu button, or from the dropdown, select the test you want to measure.</li><li class="listitem" value="3">Open the <span class="strong"><strong class="calibre10">Coverage Session View</strong></span> tab. This will show you the following output:<div class="mediaobject"><img src="../images/00071.jpeg" alt="Examining the eCobertura plugin" class="calibre12"/></div><p class="calibre16"> </p></li></ol><div class="calibre17"/></div><p class="calibre9">Note that the branch coverage is 60 percent. In the preceding section, we measured 10 branches. Using our custom coverage program, we measured that 4 out of 10 branches were covered. It proves that our custom code coverage program works fine.</p></div></div>
<div class="book" title="Measuring coverage using Gradle"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec27" class="calibre1"/>Measuring coverage using Gradle</h1></div></div></div><p class="calibre9">Gradle can be configured to generate coverage reports using JaCoCo. This section will explain how to configure the Gradle JaCoCo plugin in your project.</p><p class="calibre9">The following are the steps to<a id="id478" class="calibre1"/> configure the Gradle plugin:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a base folder named <code class="literal">Chapter05</code> under any directory, such as <code class="literal">D:/Packt</code>; then, add a <code class="literal">lib</code> folder under <code class="literal">Chapter05</code> and copy the <code class="literal">JUnit4</code> and <code class="literal">hamcrest</code> JARs to the <code class="literal">lib</code> folder. Add another folder named <code class="literal">Chapter05</code> under the base folder <code class="literal">Chapter05</code> for the Java project. As per Gradle conventions, source files are kept under <code class="literal">src/main/java</code> and test files are kept under <code class="literal">src/test/java</code>. Create the directories under <code class="literal">Chapter05\Chapter05</code>.<div class="note" title="Note"><h3 class="title2"><a id="tip11" class="calibre1"/>Tip</h3><p class="calibre9">This <code class="literal">Chapter05</code> naming strategy is used for you to easily track the project and download the code from the Packt Publishing website, but your code should express the intent of the code. The name <code class="literal">Chapter05</code> doesn't make any sense, maybe you can name it something like <code class="literal">SimpleGradleProject</code> or <code class="literal">GradleCoverageProject</code>.</p></div></li><li class="listitem" value="2">Copy the content of the Eclipse project and the <code class="literal">Metrics</code> and <code class="literal">MetricsTest</code> Java files that we <a id="id479" class="calibre1"/>created in the <span class="strong"><em class="calibre11">Uncovering the Clover plugin</em></span> section to the new directory. Copy the content of the <code class="literal">src</code> folder to <code class="literal">src/main/java</code> and the <code class="literal">test</code> folder to <code class="literal">src/test/java</code> (as per Gradle conventions).</li><li class="listitem" value="3">Create a <code class="literal">build.gradle</code> file directly under <code class="literal">Chapter05\Chapter05</code>, and add the following code snippet to the file to enable the JaCoCo coverage:<div class="informalexample"><pre class="programlisting">apply plugin: 'java'
<span class="strong"><strong class="calibre10">apply plugin: "jacoco"</strong></span>
repositories {
    flatDir(dir: '../lib', name: 'JUnit Library')
    <span class="strong"><strong class="calibre10">mavenCentral()</strong></span>
}
dependencies {
    testCompile'junit:junit:4.11', ':hamcrest-core:1.3'}
    <span class="strong"><strong class="calibre10">jacocoTestReport</strong></span> {
      reports {
        xml.enabled false
        csv.enabled false
        html.destination "${buildDir}/jacocoHtml"
    }
}</pre></div></li><li class="listitem" value="4">The<a id="id480" class="calibre1"/> <code class="literal">jaCoCo</code> plugin adds a new task, <code class="literal">jacocoTestReport</code>. To execute the <code class="literal">jacocoTestReport</code> task, a <code class="literal">mavenCentral()</code> repository dependency needs to be added to the <code class="literal">repositories</code> closure. Gradle downloads the required <code class="literal">jaCoCo</code> JARs from the <code class="literal">mavenCentral</code> repository.</li><li class="listitem" value="5">Open the command prompt, go to the <code class="literal">Chapter05\Chapter05</code> directory, and run the <code class="literal">gradle jacocoTestReport</code> command. This will download the JAR files and generate the coverage report. The following screenshot shows the console output:<div class="mediaobject"><img src="../images/00072.jpeg" alt="Measuring coverage using Gradle" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="6">Open <code class="literal">Chapter05\Chapter05\build\jacocoHtml</code> and launch the <code class="literal">index.html</code> file. The following<a id="id481" class="calibre1"/> is the JaCoCo coverage report output:<div class="mediaobject"><img src="../images/00073.jpeg" alt="Measuring coverage using Gradle" class="calibre12"/></div><p class="calibre16"> </p></li></ol><div class="calibre17"/></div></div>
<div class="book" title="Working with the Maven Cobertura plugin"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec28" class="calibre1"/>Working with the Maven Cobertura plugin</h1></div></div></div><p class="calibre9">Maven has a <a id="id482" class="calibre1"/>Cobertura plugin to measure code coverage; this section will explain how to <a id="id483" class="calibre1"/>configure the Cobertura Maven plugin in your project.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip12" class="calibre1"/>Tip</h3><p class="calibre9">Cobertura uses <code class="literal">asm</code> to instrument the bytecode. The <code class="literal">asm</code> framework is a Java bytecode manipulation and analysis framework. Visit <a class="calibre1" href="http://asm.ow2.org/">http://asm.ow2.org/</a> for <code class="literal">asm</code> details. Cobertura modifies the <code class="literal">.class</code> file, imports <code class="literal">net.sourceforge.cobertura.coveragedata.*</code>, implements the <code class="literal">HasBeenInstrumented</code> interface, and adds code to capture coverage, such as <code class="literal">ProjectData.getGlobalProjectData().getOrCreateClassData("com.packt.coverage.Metrics").touch(21);</code>.</p><p class="calibre9">After instrumenting the bytecode, Cobertura creates a <code class="literal">.ser</code> file and updates the file during test execution. This <code class="literal">.ser</code> file contains the test coverage details. The instrumented bytecode can be slightly slower than normal without it.</p></div><p class="calibre9">Follow<a id="id484" class="calibre1"/> the ensuing steps to configure Maven to generate <a id="id485" class="calibre1"/>a Cobertura report:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a <code class="literal">pom.xml</code> file and place it under <code class="literal">/Chapter05/Chapter05</code>.</li><li class="listitem" value="2">Modify the <code class="literal">pom.xml</code> file to add the project details as follows:<div class="informalexample"><pre class="programlisting">&lt;project  
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;org.packt&lt;/groupId&gt;
  &lt;artifactId&gt;Chapter05&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;jar&lt;/packaging&gt;

  &lt;name&gt;Chapter05&lt;/name&gt;
  &lt;url&gt;http://maven.apache.org&lt;/url&gt;</pre></div></li><li class="listitem" value="3">Add the Cobertura plugin details as follows:<div class="informalexample"><pre class="programlisting">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;<span class="strong"><strong class="calibre10">org.codehaus.mojo</strong></span>&lt;/groupId&gt;
      &lt;artifactId&gt;<span class="strong"><strong class="calibre10">cobertura-maven-plugin</strong></span>&lt;/artifactId&gt;
      &lt;version&gt;2.2&lt;/version&gt;
      &lt;configuration&gt;
        &lt;formats&gt;
          <span class="strong"><strong class="calibre10">&lt;format&gt;html&lt;/format&gt;</strong></span>
          &lt;format&gt;xml&lt;/format&gt;
        &lt;/formats&gt;
      &lt;/configuration&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;phase&gt;package&lt;/phase&gt;
          &lt;goals&gt;
            &lt;goal&gt;cobertura&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;          
  &lt;/plugins&gt;
&lt;/build&gt;</pre></div></li><li class="listitem" value="4">Open the command prompt, change the directory to <code class="literal">/Chapter05/Chapter05</code>, and issue the <code class="literal">mvn cobertura:cobertura </code>command. This will start<a id="id486" class="calibre1"/> downloading Cobertura plugin files and start instrumenting the <code class="literal">.class</code> files. The following screenshot portrays the Maven console output:<div class="mediaobject"><img src="../images/00074.jpeg" alt="Working with the Maven Cobertura plugin" class="calibre12"/></div><p class="calibre16"> </p></li><li class="listitem" value="5">Open <code class="literal">/Chapter05/Chapter05/target</code>. The <code class="literal">target</code> folder contains the following important subfolders:<div class="book"><ul class="itemizedlist1"><li class="listitem"><code class="literal">cobertura</code>: This contains<a id="id487" class="calibre1"/> the <code class="literal">cobertura.ser</code> file</li><li class="listitem"><code class="literal">generated-classes</code>: This <a id="id488" class="calibre1"/>contains the instrumented bytecode or the <code class="literal">.class</code> files</li><li class="listitem"><code class="literal">site</code>: This contains the<a id="id489" class="calibre1"/> coverage report in XML and HTML formats</li><li class="listitem"><code class="literal">surefire-reports</code>: This contains<a id="id490" class="calibre1"/> the test execution report</li></ul></div></li></ol><div class="calibre17"/></div><p class="calibre9">The following screenshot <a id="id491" class="calibre1"/>shows the coverage report generated in the HTML format in the <code class="literal">site</code> folder:</p><div class="mediaobject"><img src="../images/00075.jpeg" alt="Working with the Maven Cobertura plugin" class="calibre12"/></div><p class="calibre13"> </p></div>
<div class="book" title="Running the Cobertura Ant task"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec29" class="calibre1"/>Running the Cobertura Ant task</h1></div></div></div><p class="calibre9">This section will<a id="id492" class="calibre1"/> explain how to configure the Cobertura Ant task in your project.</p><p class="calibre9">The following are the<a id="id493" class="calibre1"/> steps for configuration:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Gradle and Maven can download the coverage tool JARs while running the build, but Ant needs the Cobertura JAR files to the classpath. Download the Cobertura ZIP file from <a class="calibre1" href="http://cobertura.github.io/cobertura/">http://cobertura.github.io/cobertura/</a>.</li><li class="listitem" value="2">Extract the ZIP file and copy all JAR files in the downloaded ZIP to <code class="literal">Chapter05\lib</code>. Include all JARs from the <code class="literal">lib</code> folder and <code class="literal">cobertura.jar</code> from the <code class="literal">root</code> folder.</li><li class="listitem" value="3">Create a <code class="literal">build.properties</code> file under <code class="literal">Chapter05\Chapter05</code> and enter the following information:<div class="informalexample"><pre class="programlisting">src.dir=src/main/java
test.dir=src/test/java
# The path to cobertura.jar
cobertura.dir=../lib
classes.dir=classes
instrumented.dir=instrumented
reports.dir=reports
# Unit test reports from JUnit are deposited into this directory
<span class="strong"><strong class="calibre10">reports.xml.dir=${reports.dir}/junit-xml</strong></span>
<span class="strong"><strong class="calibre10">reports.html.dir=${reports.dir}/junit-html</strong></span>
<span class="strong"><strong class="calibre10">coverage.xml.dir=${reports.dir}/cobertura-xml</strong></span>
<span class="strong"><strong class="calibre10">coverage.summaryxml.dir=${reports.dir}/cobertura-summary-xml</strong></span>
<span class="strong"><strong class="calibre10">coverage.html.dir=${reports.dir}/cobertura-html</strong></span>
</pre></div><p class="calibre15">The <code class="literal">src.dir</code> attribute represents the source folder location and <code class="literal">test.dir</code> represents the test file location. The <code class="literal">cobertura.dir</code> attribute refers to the Cobertura library or JAR files. The coverage tool needs to access the Cobertura library files. The other entries are required for report generation and bytecode instrumentation.</p></li><li class="listitem" value="4">Create a <code class="literal">build.xml</code> file under <code class="literal">Chapter05\Chapter05</code>, and add targets for Cobertura<a id="id494" class="calibre1"/> instrumentation and JUnit test to update the <code class="literal">.ser</code> file and generate the report. Download the <code class="literal">build.xml</code> file from the Packt Publishing website (the <code class="literal">Chapter05</code> code). The important targets are <code class="literal">init</code>, <code class="literal">compile</code>, <code class="literal">testcompile</code>, <code class="literal">instrument</code>, <code class="literal">test</code>, <code class="literal">coverage-report</code>, <code class="literal">summary-coverage-report</code>, <code class="literal">alternate-coverage-report</code>, and <code class="literal">clean</code>.</li><li class="listitem" value="5">Open the command prompt, change the directory to <code class="literal">Chapter05\Chapter05</code>, and issue the <code class="literal">ant</code> command. This will generate the report. The following is the console output of the command:<div class="mediaobject"><img src="../images/00076.jpeg" alt="Running the Cobertura Ant task" class="calibre12"/></div><p class="calibre16"> </p><p class="calibre15">Cobertura generates the report in <code class="literal">Chapter05\Chapter05\reports</code>. The <code class="literal">reports</code> folder contains various reports in XML and HTML formats.</p><div class="note" title="Note"><h3 class="title2"><a id="tip13" class="calibre1"/>Tip</h3><p class="calibre9">Code coverage is not a silver bullet that can deliver zero-defect software! The most important thing is writing effective tests and unit testing the logic. Writing tests for getters and setters or constructor doesn't add value.</p></div></li></ol><div class="calibre17"/></div></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec30" class="calibre1"/>Summary</h1></div></div></div><p class="calibre9">In this chapter, code coverage is described in depth and examples are provided to measure code coverage using Eclipse plugins and various coverage tools, such as Clover, JaCoCo, EclEmma, and Cobertura. We have also configured Ant, Maven, and Gradle to generate code coverage reports using coverage tools.</p><p class="calibre9">By the end of this chapter, you should be able configure Eclipse plugins and build scripts to measure code coverage.</p><p class="calibre9">The next chapter covers the static code analysis, code metrics, and various open source tools. It configures and uses PMD, Checkstyle, and FindBugs to analyze code quality and explores the Sonar code quality dashboard.</p></div></body></html>