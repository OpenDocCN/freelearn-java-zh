<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer099">
<h1 class="chapter-number" id="_idParaDest-249"><a id="_idTextAnchor375"/>12</h1>
<h1 id="_idParaDest-250"><a id="_idTextAnchor376"/>Access Control Lists</h1>
<p>In this chapter, we will address the complex topic of <strong class="bold">Access Control Lists</strong> (<strong class="bold">ACLs</strong>), which <a id="_idIndexMarker786"/>can provide a rich model of domain object instance-level authorization. Spring Security ships with a robust, but complicated, ACL module that can serve the needs of small to medium-sized implementations <span class="No-Break">reasonably well.</span></p>
<p>In this chapter, we’ll cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Understanding the conceptual model of <span class="No-Break">an ACL</span></li>
<li>Reviewing the terminology and application of ACL concepts in the Spring Security <span class="No-Break">ACL module</span></li>
<li>Building and reviewing the database schema required to support <span class="No-Break">Spring ACL</span></li>
<li>Configuring the <strong class="bold">Jim Bob CP Calendar</strong> (<strong class="bold">JBCP</strong>) calendar to use ACL-secured business methods via annotations and <span class="No-Break">Spring beans</span></li>
<li>Performing advanced configuration, including customized ACL permissions, ACL-enabled <strong class="bold">JavaServer Page</strong> (<strong class="bold">JSP</strong>) tag checks and method security, mutable ACLs, and <span class="No-Break">smart caching</span></li>
<li>Examining architectural considerations and planning scenarios for <span class="No-Break">ACL deployment</span></li>
</ul>
<p>This chapter’s code in action link is <span class="No-Break">here: </span><a href="https://packt.link/hRby2"><span class="No-Break">https://packt.link/hRby2</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-251"><a id="_idTextAnchor377"/>The conceptual module of an ACL</h1>
<p>The<a id="_idIndexMarker787"/> final piece of the non-web tier security puzzle is security at the business object level, applied at or below the business tier. Security at this level is implemented using a technique known as ACL, or ACLs. To sum up the objective of ACLs in a single sentence, ACLs allow the specification of a set of group permissions based on the unique combination of a group, business object, and <span class="No-Break">logical operation.</span></p>
<p>For example, an ACL declaration for the JBCP calendar might declare that a given user must write access to his or her own event. This can be shown <span class="No-Break">as follows:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-7">
<colgroup>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Username</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Group</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Object</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Permissions</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break">josh</span></p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p><span class="No-Break">event_01</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">read, write</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p><span class="No-Break">ROLE_USER</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">event_123</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">read</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p><span class="No-Break">ANONYMOUS</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Any event</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">none</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.1 – Example of user ACL declaration</p>
<p>You can see that this ACL is eminently readable by a human—<strong class="source-inline">josh</strong> has <strong class="source-inline">read</strong> and <strong class="source-inline">write</strong> access to his own event (<strong class="source-inline">event_01</strong>); other registered users can read the events of <strong class="source-inline">josh</strong>, but anonymous <span class="No-Break">users cannot.</span></p>
<p>This type of rule matrix is, in a nutshell, what ACL attempts to synthesize about a secured system and its business data into a combination of code, access checking, and metadata. Most true ACL-enabled systems have extremely complex ACL lists and may conceivably have millions of entries across the entire system. Although this sounds frighteningly complex, proper up-front reasoning and implementation with a capable security library can make ACL management <span class="No-Break">quite feasible.</span></p>
<p>If you use a Microsoft Windows or Unix/Linux-based computer, you experience the magic of ACLs every single day. Most modern computer <strong class="bold">Operating Systems</strong> (<strong class="bold">OSs</strong>) use ACL directives as part of their file storage systems, allowing permission granting based on a combination of a user or group, file, or directory, and permission. In Microsoft Windows, you can view some of the ACL capabilities of a file by right-clicking on a file and examining its security properties (<strong class="bold">Properties</strong> | <strong class="bold">Security</strong>), as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer094">
<img alt="Figure 12.1 – An example of ACL capabilities with Microsoft Windows" height="590" src="image/B21757_12_1.jpg" width="477"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.1 – An example of ACL capabilities with Microsoft Windows</p>
<p>You will be <a id="_idIndexMarker788"/>able to see that the combinations of inputs to the ACL are visible and intuitive <a id="_idTextAnchor378"/>as you navigate through the various groups or users <span class="No-Break">and permissions.</span></p>
<p>In this section, we’ve explored the conceptual module of ACL. In the following section, we will proceed to delve into the workings of ACLs in <span class="No-Break">Spring Security.</span></p>
<h1 id="_idParaDest-252"><a id="_idTextAnchor379"/>ACLs in Spring Security</h1>
<p>Spring<a id="_idIndexMarker789"/> Security supports ACL-driven authorization checks against access to individual domain objects by individual users of the secured system. As in the OS filesystem example, it is possible to use the Spring Security ACL components to build logical tree structures of both business objects and groups or principals. The intersection of permissions (inherited or explicit) on both the requestor and the requestee is used to determine <span class="No-Break">allowed access.</span></p>
<p>It’s quite common for users approaching the ACL capability of Spring Security to be overwhelmed by its complexity, combined with a relative dearth of documentation and examples. This is compounded by the fact that setting up the ACL infrastructure can be quite complicated, with many interdependencies and reliance on bean-based configuration mechanisms, which are quite unlike much of the rest of Spring Security (as you’ll see in a moment when we set up the <span class="No-Break">initial configuration).</span></p>
<p>The Spring Security ACL module was written to be a reasonable baseline, but users intending to build extensively on the functionality will likely run into a series of frustrating limitations and design choices, which have gone (for the most part) uncorrected as they were first introduced in the early days of Spring Security. Don’t let these limitations discourage you! The ACL module is a powerful way to embed rich access controls in your application, and further scrutinize and secure user actions <span class="No-Break">and data.</span></p>
<p>Before we dig into configuring Spring Security ACL support, we need to review some key terminology <span class="No-Break">and concepts.</span></p>
<p>The main unit of secured actor identity in the Spring ACL system is the <strong class="bold">Security IDentifier</strong> (<strong class="bold">SID</strong>). The<a id="_idIndexMarker790"/> SID is a logical construct that can be used to abstract the identity of either an individual principal or a group (<strong class="source-inline">GrantedAuthority</strong>). The SID object defined by the ACL data model you construct is used as the basis for explicit and derived access control rules when determining the allowed level of access for a <span class="No-Break">particular principal.</span></p>
<p>If SIDs are used to define actors in the ACL system, the opposite half of the security equation is the definition of the secured objects themselves. The <a id="_idIndexMarker791"/>identification of individual secured objects is called (unsurprisingly) an <strong class="bold">Object Identity</strong>. The default Spring ACL implementation of an object identity requires ACL rules to be defined at the individual object instance level, which means, if desired, every object in the system can have an individual <span class="No-Break">access rule.</span></p>
<p>Individual <a id="_idIndexMarker792"/>access rules are known as <strong class="bold">Access control Entries</strong> (<strong class="bold">ACEs</strong>). An ACE<a id="_idIndexMarker793"/> is the combination of the <span class="No-Break">following factors:</span></p>
<ul>
<li>The SID for the actor to which the <span class="No-Break">rule applies</span></li>
<li>The object identity to which the <span class="No-Break">rule applies</span></li>
<li>The permission that should be applied to the given <strong class="source-inline">SID</strong> and the stated <span class="No-Break">object identity</span></li>
<li>Whether or not the stated permission should be allowed or denied for the given <strong class="source-inline">SID</strong> and <span class="No-Break">object identity</span></li>
</ul>
<p>The purpose of the Spring ACL system is to evaluate each secured method invocation and determine whether the object or objects being acted on in the method should be allowed as per the applicable ACEs. Applicable ACEs are evaluated at runtime, based on the caller and the objects <span class="No-Break">in play.</span></p>
<p>Spring Security ACL is flexible in its implementation. Although most of this chapter details the out-of-the-box functionality of the Spring Security ACL module, keep in mind, however, that many of the rules indicated represent default implementations, which in many cases can be overridden based on more <span class="No-Break">complex requirements.</span></p>
<p>Spring Security uses helpful value objects to represent the data associated with each of these conceptual entities. These are listed in the <span class="No-Break">following table:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-5">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">ACL </strong><span class="No-Break"><strong class="bold">conceptual object</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Java object</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break">SID</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">o.s.s.acls.model.Sid</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break">Object identity</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">o.s.s.acls.model.ObjectIdentity</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break">ACL</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">o.s.s.acls.model.Acl</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break">ACE</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">o.s.s.acls.model.AccessControlEntry</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.2 – Spring Security ACL java objects</p>
<p>Let’s work through the process of enabling Spring Security ACL components for a simple <a id="_idTextAnchor380"/>demonstration in the JBCP <span class="No-Break">calendar application.</span></p>
<h1 id="_idParaDest-253"><a id="_idTextAnchor381"/>Basic configuration of Spring Security ACL support</h1>
<p>Although <a id="_idIndexMarker794"/>we hinted previously that configuring <a id="_idIndexMarker795"/>ACL support in Spring Security requires bean-based configuration (which it does), you can use ACL support while retaining the simpler security XML namespace configuration if you choose. In the remaining examples in this chapter, we will be focusing on <span class="No-Break">Java-based configuration.</span></p>
<h2 id="_idParaDest-254"><a id="_idTextAnchor382"/>Gradle dependencies</h2>
<p>As with <a id="_idIndexMarker796"/>most of the chapters, we will need to add some dependencies in order to use the functionality in this chapter. A list of the dependencies we have added with comments about when they are needed can be checked <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//build.gradle
//Spring ACL
implementation "org.springframework.security:spring-security-acl"</pre> <p>Once you’ve updated your project dependencies, we can investigate the implementation of fine-grained permission access controls in our JBCP <span class="No-Break">calendar application.</span></p>
<h2 id="_idParaDest-255"><a id="_idTextAnchor383"/>Defining a simple target scenario</h2>
<p>Our simple<a id="_idIndexMarker797"/> target scenario is to grant <strong class="source-inline">user2@example</strong>.com read access to only the birthday <span class="No-Break">party event.</span></p>
<p>All other users will not have any access to any events. You will observe that this differs from our other examples since <strong class="source-inline">user2@example.com</strong> is not otherwise associated with the birthday <span class="No-Break">party event.</span></p>
<p>Although<a id="_idIndexMarker798"/> there are several ways to set up ACL checking, our preference is to follow the annotation-based approach that we used in this chapter’s method-level annotations. This nicely abstracts the use of ACLs away from the actual interface declarations and allows for replacement (if you want) of the role declarations with something other than ACLs at a later date (should you <span class="No-Break">so choose).</span></p>
<p>We’ll add an annotation to the <strong class="source-inline">CalendarService.getEvents</strong> method, which filters each event based upon the current user’s permission to <span class="No-Break">the event:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/CalendarService.java
@PostFilter("hasPermission(filterObject, 'read')")
List&lt;Event&gt; getEvents();</pre> <p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter12.00-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-256"><a id="_idTextAnchor384"/>Adding ACL tables to the H2 database</h2>
<p>The first thing we’ll <a id="_idIndexMarker799"/>need to do is add the required tables and data to support persistent ACL entries in our in-memory H2 database. To do this, we’ll add a new SQL <strong class="bold">Data Definition Language</strong> (<strong class="bold">DDL</strong>) file<a id="_idIndexMarker800"/> and the corresponding data to our embedded database declaration in <strong class="source-inline">schema.sql</strong>. We will break down each of these files later in <span class="No-Break">the chapter.</span></p>
<p>We have included the following <strong class="source-inline">schema.sql</strong> file with this chapter’s source code, which is based upon the schema files included in the Spring Security reference’s <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional </em><span class="No-Break"><em class="italic">Reference Material</em></span><span class="No-Break">:</span></p>
<pre class="source-code">
// src/main/resources/schema.sql
--- ACLs ----------------------------------------
-- ACL Schema --
create table acl_sid (
  id bigint generated by default as identity(start with 23) not null primary key,
  principal boolean not null,
  sid varchar_ignorecase(100) not null,
  constraint uk_acl_sid unique(sid,principal) );
create table acl_class (
  id bigint generated by default as identity(start with 100) not null primary key,
  class varchar_ignorecase(500) not null,
  constraint uk_acl_class unique(class) );
create table acl_object_identity (
  id bigint generated by default as identity(start with 33) not null primary key,
  object_id_class bigint not null,
  object_id_identity bigint not null,
  parent_object bigint,
  owner_sid bigint not null,
  entries_inheriting boolean not null,
  constraint uk_acl_objid unique(object_id_class,object_id_identity),
  constraint fk_acl_obj_parent foreign key(parent_object)references acl_object_identity(id),
  constraint fk_acl_obj_class foreign key(object_id_class)references acl_class(id),
  constraint fk_acl_obj_owner foreign key(owner_sid)references acl_sid(id) );
create table acl_entry (
  id bigint generated by default as identity(start with 100) not null primary key,
  acl_object_identity bigint not null,
  ace_order int not null,
  sid bigint not null,
  mask integer not null,
  granting boolean not null,
  audit_success boolean not null,
  audit_failure boolean not null,
  constraint uk_acl_entry unique(acl_object_identity,ace_order),
  constraint fk_acl_entry_obj_id foreign key(acl_object_identity)
  references acl_object_identity(id),
  constraint fk_acl_entry_sid foreign key(sid) references acl_sid(id) );
-- the end --</pre> <p>The <a id="_idIndexMarker801"/>preceding code will result in the following <span class="No-Break">database schema:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer095">
<img alt="Figure 12.2 – ACL database schema" height="674" src="image/B21757_12_2.jpg" width="1294"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.2 – ACL database schema</p>
<p>You <a id="_idIndexMarker802"/>can see how the concepts of <strong class="source-inline">SIDs</strong>, <strong class="source-inline">OBJECT_IDENTITY</strong>, and <strong class="source-inline">ACEs</strong> map directly to the database schema. Conceptually, this is convenient, as we can map our mental model of the ACL system and how it is enforced directly to <span class="No-Break">the database.</span></p>
<p>If you’ve cross-referenced this with the H2 database schema supplied with the Spring Security documentation, you’ll note that we’ve made a few tweaks that commonly bite users. These are <span class="No-Break">as follows:</span></p>
<ul>
<li>Change the <strong class="source-inline">ACL_CLASS.CLASS</strong> column to <strong class="source-inline">500</strong> characters, from the default value of <strong class="source-inline">100</strong>. Some long, fully qualified class names don’t fit in <span class="No-Break"><strong class="source-inline">100</strong></span><span class="No-Break"> characters.</span></li>
<li>Name the foreign keys with something meaningful so that failures are more <span class="No-Break">easily diagnosed.</span></li>
</ul>
<p>If you are using another database, such as Oracle, you’ll have to translate the DDL into DDL and data types specific to <span class="No-Break">your database.</span></p>
<p>Once we configure the remainder of the ACL system, we’ll return to the database to<a id="_idTextAnchor385"/> set up some basic ACEs to prove the ACL functionality in its most <span class="No-Break">primitive form.</span></p>
<h2 id="_idParaDest-257"><a id="_idTextAnchor386"/>Configuring SecurityExpressionHandler</h2>
<p>We’ll need to <a id="_idIndexMarker803"/>configure <strong class="source-inline">@EnableMethodSecurity</strong> to enable <a id="_idIndexMarker804"/>annotations (where we’ll annotate based on the expected ACL privilege) and reference a custom access <span class="No-Break">decision manager.</span></p>
<p>We will also need to provide an <strong class="source-inline">o.s.s.access.expression.SecurityExpressionHandler</strong> implementation that is aware of how to evaluate permissions. Update your <strong class="source-inline">SecurityConfig.java</strong> configuration, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(securedEnabled = true)
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests( authz -&gt; authz
// NOTE: "/events/" is now protected by ACL:
//.requestMatchers(antMatcher("/events/")).hasRole("ADMIN")
...
        return http.build();
    }
}</pre> <p>This is a bean reference to the <strong class="source-inline">DefaultMethodSecurityExpressionHandler</strong> object that we have defined in <strong class="source-inline">AclConfig.java</strong> file for you, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.java
   @Bean
   public DefaultMethodSecurityExpressionHandler expressionHandler(){
       DefaultMethodSecurityExpressionHandler dmseh = new DefaultMethodSecurityExpressionHandler();
       dmseh.setPermissionEvaluator(permissionEvaluator());
       dmseh.setPermissionCacheOptimizer(permissionCacheOptimizer());
       return dmseh;
   }</pre> <p>With even a <a id="_idIndexMarker805"/>relatively straightforward ACL configuration, as we have in our scenario, there<a id="_idIndexMarker806"/> are a number of required dependencies to set up. As we mentioned previously, the Spring Security ACL module comes out of the box with a number of components that you can assemble to provide a decent set of <span class="No-Break">ACL capabilities.</span></p>
<h2 id="_idParaDest-258"><a id="_idTextAnchor387"/>The AclPermissionCacheOptimizer object</h2>
<p>The <strong class="source-inline">DefaultMethodSecurityExpressionHandler</strong> object has two dependencies. The <strong class="source-inline">AclPermissionCacheOptimizer</strong> object is used to prime the cache with all of the <a id="_idIndexMarker807"/>ACLs for a<a id="_idIndexMarker808"/> collection of objects in a single JDBC select statement. The relatively simple configuration included with this chapter can be checked, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.java @Bean
@Bean
public AclPermissionCacheOptimizer permissionCacheOptimizer(MutableAclService aclService){
    return new AclPermissionCacheOptimizer(aclService);
}</pre> <h2 id="_idParaDest-259"><a id="_idTextAnchor388"/>Optimizing AclPermission Cache</h2>
<p>The <strong class="source-inline">DefaultMethodSecurityExpressionHandler</strong> object then delegates to a <strong class="source-inline">PermissionEvalulator</strong> instance. For the purposes of this chapter, we are using ACLs so that the bean <a id="_idIndexMarker809"/>we will use <strong class="source-inline">AclPermissionEvaluator</strong>, which will read the ACLs that <a id="_idIndexMarker810"/>we define in our database. You can view the provided configuration for <strong class="source-inline">permissionEvaluator</strong>, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.j ava
@Bean
public AclPermissionEvaluator permissionEvaluator(MutableAclService aclService){
    return new AclPermissionEvaluator(aclService);
}</pre> <h2 id="_idParaDest-260"><a id="_idTextAnchor389"/>The JdbcMutableAclService object</h2>
<p>At this point, we have seen a<a id="_idIndexMarker811"/> reference<a id="_idIndexMarker812"/> to <strong class="source-inline">th</strong> with the <strong class="source-inline">aclService</strong> ID twice. The <strong class="source-inline">aclService</strong> ID resolves to an implementation of <strong class="source-inline">o.s.s.acls.model.AclService</strong> that is responsible (through delegation) for translating information about the object being secured by ACLs into <span class="No-Break">expected ACEs:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.j ava
@Bean
public MutableAclService aclService(LookupStrategy lookupStrategy, SpringCacheBasedAclCache aclCache){
    return new JdbcMutableAclService(dataSource,
                lookupStrategy,
                aclCache);
}</pre> <p>We’ll use <strong class="source-inline">o.s.s.acls.jdbc.JdbcMutableAclService</strong>, which is the default implementation of <strong class="source-inline">o.s.s.acls.model.AclService</strong>. This implementation comes out of the box and is ready to use the schema that we defined in the last step of this exercise. The <strong class="source-inline">JdbcMutableAclService</strong> object will additionally use recursive SQL and post-processing<a id="_idIndexMarker813"/> to understand the object and <strong class="source-inline">SID</strong> hierarchies and ensure that representations of these <a id="_idIndexMarker814"/>hierarchies are passed back <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">AclPermissionEvaluator</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-261"><a id="_idTextAnchor390"/>The BasicLookupStrategy class</h2>
<p>The <strong class="source-inline">JdbcMutableAclService</strong> class uses the<a id="_idIndexMarker815"/> same JDBC <strong class="source-inline">dataSource</strong> instance that we’ve defined with the embedded <a id="_idIndexMarker816"/>database declaration, and it also delegates to an implementation of <strong class="source-inline">o.s.s.acls.jdbc.LookupStrategy</strong>, which is solely responsible for actually making database queries and resolving requests for ACLs. The only <strong class="source-inline">LookupStrategy</strong> implementation supplied with Spring Security is <strong class="source-inline">o.s.s.acls.jdbc.BasicLookupStrategy</strong>, and is defined <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.j ava
@Bean
 public LookupStrategy lookupStrategy(AclCache aclCache,
                AclAuthorizationStrategy aclAuthorizationStrategy, ConsoleAuditLogger consoleAuditLogger){
     return new BasicLookupStrategy(
                  dataSource,
                  aclCache,
                  aclAuthorizationStrategy,
                  consoleAuditLogger);
 }</pre> <p>Now, <strong class="source-inline">BasicLookupStrategy</strong> is a relatively complex beast. Remember that its purpose is to translate a list of the <strong class="source-inline">ObjectIdentity</strong> declarations to be protected into the actual, applicable ACE list from <span class="No-Break">the database.</span></p>
<p>As <strong class="source-inline">ObjectIdentity</strong> declarations<a id="_idIndexMarker817"/> can be recursive, this proves to be quite a challenging problem, and a system <a id="_idIndexMarker818"/>that is likely to experience heavy use should consider the SQL’s, which is generated for performance, impact on <span class="No-Break">the database.</span></p>
<h3>Querying with the lowest common denominator</h3>
<p>Be aware <a id="_idIndexMarker819"/>that <strong class="source-inline">BasicLookupStrategy</strong> is intended to be compatible with all databases by strictly <a id="_idIndexMarker820"/>sticking with <strong class="bold">American National Standards Institute</strong> (<strong class="bold">ANSI</strong>) SQL syntax, notably <strong class="source-inline">left [outer] joins</strong>. Some older databases do not support this join syntax, so, ensure that you verify that the syntax and structure of SQL are compatible with <span class="No-Break">your database!</span></p>
<p>There are also most certainly more efficient database-dependent methods of performing hierarchical queries using non-standard SQL, for example, Oracle’s <strong class="source-inline">CONNECT BY</strong> statement and <a id="_idIndexMarker821"/>the <strong class="bold">common table expression</strong> (<strong class="bold">CTE</strong>) capability of many other databases, including PostgreSQL and Microsoft <span class="No-Break">SQL Server.</span></p>
<p>Much as you learned in the example in <a href="B21757_04.xhtml#_idTextAnchor106"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <em class="italic">JDBC-based Authentication</em>, using a custom schema for the <strong class="source-inline">JdbcDaoImpl</strong> implementation of the <strong class="source-inline">UserDetailsService</strong> properties are exposed to allow for configuration of the SQL utilized by <strong class="source-inline">BasicLookupStrategy</strong>. Consult the Javadoc and the source code itself to see how they are used so that they can be correctly applied to your <span class="No-Break">custom schema.</span></p>
<p>We can see that <strong class="source-inline">LookupStrategy</strong> requires a reference to the same JDBC <strong class="source-inline">dataSource</strong> instance that <strong class="source-inline">AclService</strong> utilizes. The other three references bring u<a id="_idTextAnchor391"/>s almost to the en<a id="_idTextAnchor392"/>d of the<a id="_idIndexMarker822"/> <span class="No-Break">dependency chain.</span></p>
<h3>AclCache interface</h3>
<p>The <strong class="source-inline">o.s.s.acls.model.AclCache</strong> interface declares an interface for a caching <strong class="source-inline">ObjectIdentity</strong> to ACL mappings, to prevent <a id="_idIndexMarker823"/>redundant (and expensive) database lookups. Spring Security supports any implementation of <span class="No-Break"><strong class="source-inline">JCache (JSR-107)</strong></span><span class="No-Break">.</span></p>
<p>For example, to enable third-party support for <strong class="source-inline">Ehcache</strong>, which is an open-source, memory- and disk-based caching library that is widely used in many open-source and commercial Java products, you need to add the following <span class="No-Break">Gradle dependency:</span></p>
<pre class="source-code">
//build.gradle
//Enabling Ehcache support
implementation "org.ehcache:ehcache"</pre> <p>We will set up <strong class="source-inline">ConcurrentMapCache</strong> in our example by updating the configuration <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">AclConfig.java</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.java
@Bean
public AclCache aclCache( Cache concurrentMapCache,
       PermissionGrantingStrategy permissionGrantingStrategy, AclAuthorizationStrategy aclAuthorizationStrategy){
    return new SpringCacheBasedAclCache(concurrentMapCache,
          permissionGrantingStrategy,
          aclAuthorizationStrategy);
}
@Bean
public PermissionGrantingStrategy permissionGrantingStrategy(){
    return new DefaultPermissionGrantingStrategy(consoleAuditLogger());
}
@Bean
public ConcurrentMapCache concurrentMapCache(){
    return new ConcurrentMapCache("aclCache");
}
@Bean
public CacheManager cacheManager(){
    return new ConcurrentMapCacheManager();
}</pre> <h3>The ConsoleAuditLogger class</h3>
<p>The next simple dependency hanging off<a id="_idIndexMarker824"/> of <strong class="source-inline">o.s.s.acls.jdbc.BasicLookupStrategy</strong> is an implementation of the <strong class="source-inline">o.s.s.acls.domain.AuditLogger</strong> interface, which is used by the <strong class="source-inline">BasicLookupStrategy</strong> class to audit ACL and ACE lookups. Similar to the <strong class="source-inline">AclCache</strong> interface, only one implementation is supplied with Spring Security, and it simply logs to the console. We’ll configure it with another one-line <span class="No-Break">bean declaration:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.j ava
@Bean
public ConsoleAuditLogger consoleAuditLogger(){
    retur<a id="_idTextAnchor393"/><a id="_idTextAnchor394"/>n new ConsoleAuditLogger();
}</pre> <h3>The AclAuthorizationStrategyImpl interface</h3>
<p>The<a id="_idIndexMarker825"/> final dependency to resolve is an implementation of the <strong class="source-inline">o.s.s.acls.domain.AclAuthorizationStrategy</strong> interface, which actually has no immediate responsibility at all during the load of the ACL from the database. Instead, the implementation of this interface is responsible for determining whether a runtime change to an ACL or ACE is allowed, based on the type <span class="No-Break">of change.</span></p>
<p>We’ll explain this more later when we cover mutable ACLs, as the logical flow is both somewhat complicated and not pertinent to getting our initial configuration complete. The final configuration requirements are <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.j ava
@Bean
public AclAuthorizationStrategy aclAuthorizationStrategy() {
    return new AclAuthorizationStrategyImpl(
            new SimpleGrantedAuthority("ROLE_ADMINISTRATOR")
    );
}</pre> <p>You might wonder what the reference to the bean with the <strong class="source-inline">adminAuthority</strong> ID is for—<strong class="source-inline">AclAuthorizationStrategyImpl</strong> provides the ability to specify <strong class="source-inline">GrantedAuthority</strong>, which is required to allow specific operations at runtime on mutable ACLs. We’ll cover these later in <span class="No-Break">this chapter.</span></p>
<p>We’re finally done with the basic configuration of an out-of-the-box Spring Security ACL implementation. The next and final step requires that we in<a id="_idTextAnchor395"/>sert a simple ACL and ACE into the H2 database and test <span class="No-Break">it out!</span></p>
<h2 id="_idParaDest-262"><a id="_idTextAnchor396"/>Creating a simple ACL entry</h2>
<p>Recall that our very <a id="_idIndexMarker826"/>simple scenario is<a id="_idIndexMarker827"/> to only allow <strong class="source-inline">user2@example.com</strong> access to the birthday party event and ensure that no other events <span class="No-Break">are accessible.</span></p>
<p>You may find it helpful to refer back several pages (<span class="No-Break"><em class="italic">Figure 12</em></span><em class="italic">.2</em>) to the database schema diagram to follow which data we are inserting <span class="No-Break">and why.</span></p>
<p>We have already included a file named <strong class="source-inline">data.sql</strong> in the <span class="No-Break">sample application.</span></p>
<p>All of the SQL explained in this section will be from the file—you may feel free to experiment and add more test cases based on the sample SQL we’ve provided. In fact, we encourage you experiment with <span class="No-Break">sample data!</span></p>
<p>Let’s take a look at the following steps for creating a simple <span class="No-Break">ACL entry:</span></p>
<ol>
<li>First, we’ll need to populate the <strong class="source-inline">ACL_CLASS</strong> table with any or all of the domain object classes, which may have ACL rules—in the case of our example, this is simply our <span class="No-Break"><strong class="source-inline">Event</strong></span><span class="No-Break"> class:</span></li>
</ol>
<pre class="source-code">
//src/main/resources/data.sql
insert into acl_class (id, class) values (10, 'com.packtpub.springsecurity.domain.Event');</pre> <p class="list-inset">We chose to use primary keys that are between 10 and 19 for the <strong class="source-inline">ACL_CLASS</strong> table, 20 and 29 for the <strong class="source-inline">ACL_SID</strong> table, and <span class="No-Break">so on.</span></p>
<p class="list-inset">This will help make it easier to understand which data associates with which table. Note that our <strong class="source-inline">Event</strong> table starts with a primary key of <strong class="source-inline">100</strong>. These conveniences are done for example purposes and are not suggested for <span class="No-Break">production purposes.</span></p>
<ol>
<li value="2">Next, the <strong class="source-inline">ACL_SID</strong> table is seeded with SIDs that will be associated with the ACEs. Remember that SIDs can either be roles or users—we’ll populate the roles and <span class="No-Break"><strong class="source-inline">user2@example.com</strong></span><span class="No-Break"> here.</span></li>
<li>While the SID object for roles is straightforward, the SID object for a user is not quite as clear cut. For our purposes, the username is used for the SID. To learn more about how the SIDs are resolved for roles and users, refer to <strong class="source-inline">o.s.s.acls.domain.SidRetrievalStrategyImpl</strong>. If the defaults do not meet your needs, a custom <strong class="source-inline">o.s.s.acls.model.SidRetrievalStrategy</strong> default can be injected into <strong class="source-inline">AclPermissionCacheOptimizer</strong> and <strong class="source-inline">AclPermissionEvaluator</strong>. We will not need this sort of customization for our example, but it is good to know that it is available <span class="No-Break">if necessary:</span></li>
</ol>
<pre class="source-code">
//src/main/resources/data.sql
-- User specific:
insert into acl_sid (id, principal, sid) values (20, true, 'user2@example.com');
-- Role specific:
insert into acl_sid (id, principal, sid) values (21, false, 'ROLE_USER');
insert into acl_sid (id, principal, sid) values (22, false, 'ROLE_ADMIN');</pre> <p class="list-inset">The table <a id="_idIndexMarker828"/>where things <a id="_idIndexMarker829"/>start getting complicated is the <strong class="source-inline">ACL_OBJECT_IDENTITY</strong> table, which is used to declare individual domain object instances, their parent (if any), and <span class="No-Break">owning </span><span class="No-Break"><strong class="source-inline">SID</strong></span><span class="No-Break">.</span></p>
<p>For example, this table represents the <strong class="source-inline">Event</strong> objects that we are securing. We’ll insert a row with the <span class="No-Break">following properties:</span></p>
<ul>
<li>A domain object of the <strong class="source-inline">Event</strong> type that is a foreign key, <strong class="source-inline">10</strong>, to our <strong class="source-inline">ACL_CLASS</strong> table via the <span class="No-Break"><strong class="source-inline">OBJECT_ID_CLASS</strong></span><span class="No-Break"> column.</span></li>
<li>A domain object primary key of <strong class="source-inline">100</strong> (the <strong class="source-inline">OBJECT_ID_IDENTITY</strong> column). This is a foreign key (although not enforced with a database constraint) to our <span class="No-Break"><strong class="source-inline">Event</strong></span><span class="No-Break"> object.</span></li>
<li>The <strong class="source-inline">SID</strong> owner of <strong class="source-inline">user2@example.com</strong>, which is a foreign key, <strong class="source-inline">20</strong>, to <strong class="source-inline">ACL_SID</strong> via the <span class="No-Break"><strong class="source-inline">OWNER_SID</strong></span><span class="No-Break"> column.</span></li>
</ul>
<p>The SQL to <a id="_idIndexMarker830"/>represent our events<a id="_idIndexMarker831"/> with IDs of <strong class="source-inline">100</strong> (birthday event), <strong class="source-inline">101</strong>, and <strong class="source-inline">102</strong> is <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/resources/data.sql
-- object identity
-- Event entry for user2 SID
insert into acl_object_identity (id,object_id_identity,object_id_class,parent_object,owner_sid,entries_inheriting)
values (30,100, 10, null, 20, false);
-- Event entry for ROLE_USER SID
insert into acl_object_identity (id,object_id_identity,object_id_class,parent_object,owner_sid,entries_inheriting)
values (31,101, 10, null, 21, false);
-- Event entry for ROLE_ADMIN SID
insert into acl_object_identity (id,object_id_identity,object_id_class,parent_object,owner_sid,entries_inheriting)
values (32,102, 10, null, 21, false);</pre> <p>Keep in mind that the owning <strong class="source-inline">SID</strong> could also represent a role—both types of rules function equally well as far as the ACL system <span class="No-Break">is concerned.</span></p>
<p>Finally, we’ll add an ACE related to this object instance, which declares that<strong class="source-inline"> user2@example.com</strong> is allowed read access to the <span class="No-Break">birthday event:</span></p>
<pre class="source-code">
//src/main/resources/data.sql
-- ACEntry list ---------------------------------
-- mask == R
-- Entry for Event entry for user2 SID
insert into acl_entry (acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure)
values(30, 1, 20, 1, true, true, true);</pre> <p>The <strong class="source-inline">MASK</strong> column here represents a bitmask, which is used to grant permission assigned to the stated <strong class="source-inline">SID</strong> on the object in question. We’ll explain the details of this later in this chapter—unfortunately, it doesn’t tend to be as useful as it <span class="No-Break">may sound.</span></p>
<p>Now, we can start the application and run through our sample scenario. Try logging in with <strong class="source-inline">user2@example.com/user2</strong> and accessing the <strong class="bold">All Events</strong> page. You will see that only the birthday event <span class="No-Break">is listed.</span></p>
<p>When logged in with <strong class="source-inline">admin1@example.com/admin1</strong> and viewing the <strong class="bold">All Events</strong> page, no events will <span class="No-Break">be displayed.</span></p>
<p>However, if we navigated directly to an event, it would not be protected. Can you figure out how to secure direct access to an event based on what you learned in <span class="No-Break">this chapter?</span></p>
<p>If you have<a id="_idIndexMarker832"/> not figured <a id="_idIndexMarker833"/>it out yet, you can secure direct access to an event by making the following update to <strong class="source-inline">CalendarService.java</strong>, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/CalendarService.java
@PostAuthorize("hasPermission(filterObject, 'read') ")
Event getEvent(int eventId);</pre> <p>We now have a basic working setup of ACL-based security (albeit, a very <span class="No-Break">simple scenario).</span></p>
<p>Let’s move on to some more explanations of concepts we saw during this walkthrough, and then review a couple of considerations in a typical Spring ACL implementation that you should consider before <span class="No-Break">using it.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter12.01-calendar</strong></span><span class="No-Break">.</span></p>
<p>It is worth noting that we have not created new ACL entries when we create events. Thus, in the current state, if you create an event, you will receive an error similar to <span class="No-Break">the following:</span></p>
<pre class="source-code">
<strong class="bold">Exception during execution of Spring Security application! Unable to find ACL information for object identity 'org.springframework.security.acls.domain.ObjectIdentityImpl[Type: com.packtpub.springsecurity.domain.Event; Identifier: 1]'</strong></pre> <p>After examining the process of creating a straightforward ACL entry, let’s now delve into a comprehensive understanding of how permissions operate, focusing on advanced <span class="No-Break">ACL configurations.</span></p>
<h1 id="_idParaDest-263"><a id="_idTextAnchor397"/>Advanced ACL topics</h1>
<p>Some high-level topics that we skimmed <a id="_idIndexMarker834"/>over during the configuration of our ACL environment had to do with ACE permissions and the use of the <strong class="source-inline">GrantedAuthority</strong> indicators to assist the ACL environment in determining whether certain types of runtime changes to ACLs were allowed. Now that we h<a id="_idTextAnchor398"/>ave a working environment, w<a id="_idTextAnchor399"/>e’ll review these more <span class="No-Break">advanced topics.</span></p>
<h2 id="_idParaDest-264"><a id="_idTextAnchor400"/>How permissions work</h2>
<p>Permissions are no<a id="_idIndexMarker835"/> more than single logical identifiers represented by<a id="_idIndexMarker836"/> bits in an integer. An ACE grants permissions to <strong class="source-inline">SIDs</strong> based on the bitmask, which comprises the logical and of all permissions applicable to <span class="No-Break">that ACE.</span></p>
<p>The default permission implementation, <strong class="source-inline">o.s.s.acls.domain.BasePermission</strong>, defines a series of integer values representing common ACL authorization verbs. These integer values correspond to single bits set in an integer, so a value of <strong class="source-inline">BasePermission</strong>, <strong class="source-inline">WRITE</strong>, with an integer value of <strong class="source-inline">1</strong> has a bitwise value of <strong class="source-inline">21</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">2</strong></span><span class="No-Break">.</span></p>
<p>These are illustrated in the <span class="No-Break">following diagram:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer096">
<img alt="Figure 12.3 – Default and custom permissions bitmask" height="301" src="image/B21757_12_3.jpg" width="987"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.3 – Default and custom permissions bitmask</p>
<p>We can see that the <strong class="source-inline">Sample</strong> permission bitmask would have an integer value of <strong class="source-inline">3</strong>, due to the application of both the <strong class="source-inline">Read</strong> and <strong class="source-inline">Write</strong> permissions to the <span class="No-Break">permission value.</span></p>
<p>All of the standard integer single permission values shown in the preceding diagram are defined in the <strong class="source-inline">BasePermission</strong> object as <span class="No-Break">static constants.</span></p>
<p>The logical constants that are included in <strong class="source-inline">BasePermission</strong> are just a sensible baseline of commonly used permissions in ACE and have no semantic meaning within the Spring Security framework. It’s quite common for very complex ACL implementations to invent their own custom permissions, augmenting best practice examples with domain- or <span class="No-Break">business-dependent ones.</span></p>
<p>One issue that often confuses users is how the bitmasks are used in practice, given that many databases either do not support bitwise logic or do not support it in a scalable way. Spring ACL intends to solve this problem by putting more of the load of calculating appropriate <a id="_idIndexMarker837"/>permissions related to bitmasks on the application rather than on <span class="No-Break">the database.</span></p>
<p>It’s important to review the resolution process, where we see how <strong class="source-inline">AclPermissionEvaluator</strong> resolves permissions declared on the method itself (in our example, with the <strong class="source-inline">@PostFilter</strong> annotation) to real <span class="No-Break">ACL permissions.</span></p>
<p>The following diagram illustrates the process that Spring ACL performs to evaluate the declared permission against the relevant ACEs for the <span class="No-Break">requesting principal:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer097">
<img alt="Figure 12.4 – Spring ACL permissions evaluation process" height="1419" src="image/B21757_12_4.jpg" width="1643"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.4 – Spring ACL permissions evaluation process</p>
<p>We see that <strong class="source-inline">AclPermissionEvaluator</strong> relies on classes implementing two interfaces, <strong class="source-inline">o.s.s.acls.model.ObjectIdentityRetrievalStrategy</strong> and <strong class="source-inline">o.s.s.acls.model.SidRetrievalStrategy</strong>, to retrieve <strong class="source-inline">ObjectIdentity</strong> and SIDs appropriate for the authorization check. The important thing to note about these strategies is how the <a id="_idIndexMarker838"/>default implementation classes actually determine the <strong class="source-inline">ObjectIdentity</strong> and SIDs objects to return, based on the context of the <span class="No-Break">authorization check.</span></p>
<p>The <strong class="source-inline">ObjectIdentity</strong> object has two properties, <strong class="source-inline">type</strong> and <strong class="source-inline">identifier</strong>, that are derived from the object being checked at runtime and used to declare ACE entries. The default <strong class="source-inline">ObjectIdentityRetrievalStrategy</strong> interface uses the fully-qualified class name to populate the <strong class="source-inline">type</strong> property. The <strong class="source-inline">identifier</strong> property is populated with the result of a method with the <strong class="source-inline">Serializable getId()</strong> signature, invoked on the actual <span class="No-Break">object instance.</span></p>
<p>As your object isn’t <a id="_idIndexMarker839"/>required to implement an interface to be compatible with ACL checks, the requirement to implement a method with a specific signature can be surprising for developers implementing Spring Security ACL. Plan ahead and ensure that your domain objects contain this method! You may also implement your own <strong class="source-inline">ObjectIdentityRetrievalStrategy</strong> class (or implement the out-of-the-box subclass) to call a method of your choice. The name and type signature of the method is, unfortunately, <span class="No-Break">not configurable.</span></p>
<p>Unfortunately, the actual implementation of <strong class="source-inline">AclImpl</strong> directly compares the permission specified in <a id="_idIndexMarker840"/>our <strong class="bold">Spring Expression Language</strong> (<strong class="bold">SpEL</strong>) expression specified in our <strong class="source-inline">@PostFilter</strong> annotation, and the permission stored on the ACE in the database, without using bitwise logic. You will need to take care when declaring a user with a combination of permissions, as either <strong class="source-inline">AclEntryVoter</strong> must be configured with all combinations of permissions or the ACEs need to ignore the fact that the permission field is intended to store multiple values and instead store a single permission <span class="No-Break">per ACE.</span></p>
<p>If you want to verify this with our simple scenario, change the <strong class="source-inline">READ</strong> permission we granted to the <strong class="source-inline">user2@example.com</strong> SID to the bitmask combination of <strong class="source-inline">Read and Write</strong>, which translates to a value of <strong class="source-inline">3</strong>. This would be updated in the <strong class="source-inline">data.sql</strong> file, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/resources/data.sql
-- READ / WRITE Entry for Event entry for user2 SID
insert into acl_entry
(acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure)
values(30, 1, 20, 3, true, true, true);</pre> <p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter12.02-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-265"><a id="_idTextAnchor401"/>The custom ACL permission declaration</h2>
<p>As stated <a id="_idIndexMarker841"/>in the earlier discussion on permission declarations, permissions <a id="_idIndexMarker842"/>are nothing but logical names for integer bit values. As such, it’s possible to extend the <strong class="source-inline">o.s.s.acls.domain.BasePermission</strong> class and declare your own permissions. We’ll cover a very straightforward scenario here, where we create a new ACL permission <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">ADMIN_READ</strong></span><span class="No-Break">.</span></p>
<p>This is a permission that will be granted only to administrative users and will be assigned to protect resources that only administrators can read. Although a contrived example for the JBCP calendar application, this type of use of custom permissions occurs quite often in situations dealing <a id="_idIndexMarker843"/>with <strong class="bold">Personally Identifiable Information</strong> (<strong class="bold">PII</strong>) (for example, social security number, and so on—recall that we covered PII in <a href="B21757_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, <em class="italic">Anatomy of an </em><span class="No-Break"><em class="italic">Unsafe Application</em></span><span class="No-Break">).</span></p>
<p>Let’s get started with making the changes required to support this by performing the <span class="No-Break">following steps:</span></p>
<ol>
<li>The first step is to extend the <strong class="source-inline">BasePermission</strong> class with our own <strong class="source-inline">com.packtpub.springsecurity.acls.domain.CustomPermission</strong> class, <span class="No-Break">as follows:</span><pre class="source-code">
package com.packtpub.springsecurity.acls.domain;
public class CustomPermission extends BasePermission {
    public static final Permission ADMIN_READ = new CustomPermission(1 &lt;&lt; 5, 'M'); // 32
    public CustomPermission(int mask, char code) {
        super(mask, code);
    }
}</pre></li> <li>Next, we will need to configure the <strong class="source-inline">o.s.s.acls.domain.PermissionFactory</strong> default implementation<span class="P---Regular-Char">,</span> <strong class="source-inline">o.s.s.acls.domain.DefaultPermissionFactory</strong>, to register our custom permission logical value. The role of <strong class="source-inline">PermissionFactory</strong> is to resolve permission bitmasks into logical permission values (which can be referenced by the constant value, or by name, such as <strong class="source-inline">ADMIN_READ</strong>, in other areas of the application). The <strong class="source-inline">PermissionFactory</strong> instance requires that any custom permission is registered with it for proper lookup. We have included the following <a id="_idIndexMarker844"/>configuration that registers our <strong class="source-inline">CustomPermission</strong> class, <span class="No-Break">as follows:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.java
@Bean
public DefaultPermissionFactory permissionFactory(){
    return new DefaultPermissionFactory(CustomPermission.class);
}</pre></li> <li>Next, we will need to override the default <strong class="source-inline">PermissionFactory</strong> instance for our <strong class="source-inline">BasicLookupStrategy</strong> and <strong class="source-inline">AclPermissionEvaluator</strong> interfaces with the customized <span class="No-Break"><strong class="source-inline">DefaultPermissionFactory</strong></span><span class="No-Break"> interface:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConf ig.java
@Bean
public AclPermissionEvaluator permissionEvaluator(MutableAclService aclService){
        AclPermissionEvaluator pe = new AclPermissionEvaluator(aclService);
        pe.setPermissionFactory(permissionFactory());
        return pe;
}
@Bean
public LookupStrategy lookupStrategy(AclCache aclCache,
       AclAuthorizationStrategy aclAuthorizationStrategy, ConsoleAuditLogger consoleAuditLogger) {
        BasicLookupStrategy lookupStrategy = new BasicLookupStrategy(
                dataSource,
                aclCache,
                aclAuthorizationStrategy,
                consoleAuditLogger);
        lookupStrategy.setPermissionFactory(permissionFactory());
        return lookupStrategy;
}</pre></li> <li>We also <a id="_idIndexMarker845"/>need to add the SQL query to utilize the new permission to grant access to the conference call (<strong class="source-inline">acl_object_identity ID of 31</strong>) event to <strong class="source-inline">admin1@example.com</strong>. Make the following updates <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">data.sql</strong></span><span class="No-Break">:</span><pre class="source-code">
-- custom permission
insert into acl_sid (id, principal, sid) values (23, true, 'admin1@example.com');
insert into acl_entry
(acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure)
values(31, 1, 23, 32, true, true, true);</pre><p class="list-inset">We can see that the new integer bitmask value of <strong class="source-inline">32</strong> has been referenced in the ACE data. This intentionally corresponds to our new <strong class="source-inline">ADMIN_READ ACL</strong> permission, as defined in Java code. The conference call event is referenced by its primary key (stored in the <strong class="source-inline">object_id_identity</strong> column) value of <strong class="source-inline">31</strong>, in the <span class="No-Break"><strong class="source-inline">ACL_OBJECT_IDENTITY</strong></span><span class="No-Break"> table.</span></p></li> <li>The last step is to update our <strong class="source-inline">CalendarService's getEvents()</strong> method to utilize our new permission, <span class="No-Break">as follows:</span></li>
</ol>
<pre class="source-code">
@PostFilter("hasPermission(filterObject, 'read') " +
       "or hasPermission(filterObject, 'admin_read')")
List&lt;Event&gt; getEvents()</pre> <p>With all of these <a id="_idIndexMarker846"/>configurations in place, we can start up the site again and test out the custom ACL permission. Based on the sample data we have configured, here is what should happen when the various available users click <span class="No-Break">on categories:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table003-3">
<colgroup>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Username/password</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Birthday </strong><span class="No-Break"><strong class="bold">party event</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Conference </strong><span class="No-Break"><strong class="bold">call event</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Other events</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">user2@example.com/user2</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Allowed via</span></p>
<p><span class="No-Break"><strong class="source-inline">READ</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Denied</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Denied</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">admin1@example.com/admin1</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Denied</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Allowed via</span></p>
<p><span class="No-Break"><strong class="source-inline">ADMIN_READ</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Denied</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">user1@example.com/user1</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Denied</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Denied</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Denied</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.3 – Users ACL Java objects</p>
<p>We can see that, even with the use of our simple cases, we’ve now been able to extend the Spring ACL functionality in a very limited way to illustrate the power of this fine-grained access <span class="No-Break">control system.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter12.03-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-266"><a id="_idTextAnchor402"/>Enabling ACL permission evaluation</h2>
<p>We saw in <a href="B21757_02.xhtml#_idTextAnchor043"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">Getting Started with Spring Security</em>, that the Spring Security JSP tag library offers <a id="_idIndexMarker847"/>functionality to expose authentication-related<a id="_idIndexMarker848"/> data to the user and to restrict what the user can see based on a variety of rules. So far in this book, we have used the <strong class="source-inline">Thymeleaf Security tag libraries</strong>, which are built on top of <span class="No-Break">Spring Security.</span></p>
<p>The very same tag library can also interact with an ACL-enabled system right out of the box! From our simple experiments, we have configured a simple ACL authorization scenario around the first two categories in the list on the home page. Let’s look at the following steps and learn how to enable ACL permission evaluation in our <span class="No-Break">Thymeleaf pages:</span></p>
<ol>
<li>First, we will need to remove our <strong class="source-inline">@PostFilter</strong> annotation from the <strong class="source-inline">getEvents()</strong> method in our <strong class="source-inline">CalendarService</strong> interface in order to give our JSP tag library a chance to filter out the events that are not allowed for display. Go ahead and remove <strong class="source-inline">@PostFilter</strong> now, <span class="No-Break">as follows:</span><pre class="source-code">
// src/main/java/com/packtpub/springsecurity/service/ CalendarService.java
List&lt;Event&gt; getEvents();</pre></li> <li>Now that we have removed <strong class="source-inline">@PostFilter</strong>, we can utilize the <strong class="source-inline">&lt;sec:authorize-acl&gt;</strong> tag to hide the events that the user doesn’t actually have access to. Refer to the table in the preceding section as a refresher on the access rules we’ve configured up to <span class="No-Break">this point!</span></li>
<li>We’ll wrap the display of each event with the <strong class="source-inline">&lt;sec:authorize-acl&gt;</strong> tag, declaring the list of permissions to check on the object to <span class="No-Break">be displayed:</span><pre class="source-code">
//src/main/resources/templates/events/list.xhtml
&lt;th:block th:each="event : ${events}"&gt;
    &lt;tr sec:authorize-acl="${event} :: '1,32'" &gt;
        &lt;td th:text="${#calendars.format(event.dateWhen, 'yyyy-MM-dd HH:mm')}"&gt;today&lt;/td&gt;
        &lt;td th:text="${event.owner.name}"&gt;Chuck Norris&lt;/td&gt;
        &lt;td th:text="${event.attendee.name}"&gt;Josh Knutson&lt;/td&gt;
        &lt;td&gt;&lt;a th:href="@{'/events/{id}'(id=${event.id})}" th:text="${event.summary}"&gt;-1&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/th:block&gt;</pre></li> <li>Think for a <a id="_idIndexMarker849"/>moment about <a id="_idIndexMarker850"/>what we want to occur here—we want the user to see only the items they actually have the <strong class="source-inline">READ</strong> or <strong class="source-inline">ADMIN_READ</strong> (our custom permission) access. However, to use the tag library, we need to use the permission mask, which can be referenced from the <span class="No-Break">following table:</span></li>
</ol>
<table class="No-Table-Style _idGenTablePara-1" id="table004-2">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Name</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Mask</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">READ</strong></span></p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">WRITE</strong></span></p>
</td>
<td class="No-Table-Style">
<p>2</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ADMIN_READ</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">32</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.4 – Permissions mask table</p>
<p class="list-inset">Behind the scenes, the tag implementation utilizes the same <strong class="source-inline">SidRetrievalStrategy</strong> and <strong class="source-inline">ObjectIdentityRetrievalStrategy</strong> interfaces that were discussed earlier in this chapter. So, the computation of access checking follows the same workflow as it does with ACL-enabled voting on method security. As we will see in a moment, the tag implementation will also use the <span class="No-Break">same </span><span class="No-Break"><strong class="source-inline">PermissionEvaluator</strong></span><span class="No-Break">.</span></p>
<p class="list-inset">We have already enabled our <strong class="source-inline">@EnableMethodSecurity</strong> annotation with an <strong class="source-inline">expressionHandler</strong> element that <span class="No-Break">references </span><span class="No-Break"><strong class="source-inline">DefaultMethodSecurity</strong></span><strong class="source-inline">
ExpressionHandler</strong>. The <strong class="source-inline">DefaultMethodSecurityExpressionHandler</strong> implementation is aware of our <strong class="source-inline">AclPermissionEvaluator</strong> interface, but we must also make Spring Security’s web tier aware of <strong class="source-inline">AclPermissionEvalulator</strong>. If you think about it, this symmetry makes sense, since securing methods and HTTP requests are protecting two very different resources. Fortunately, Spring Security’s abstractions make this <span class="No-Break">rather simple.</span></p>
<p>5.	Add a <strong class="source-inline">DefaultWebSecurityExpressionHandler</strong> handler that references the<a id="_idIndexMarker851"/> bean with the ID of <strong class="source-inline">permissionEvaluator</strong>, which<a id="_idIndexMarker852"/> we have <span class="No-Break">already defined:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/AclConfig.java
@Bean
public DefaultWebSecurityExpressionHandler webExpressionHandler(AclPermissionEvaluator permissionEvaluator){
    DefaultWebSecurityExpressionHandler webExpressionHandler = new DefaultWebSecurityExpressionHandler();
    webExpressionHandler.setPermissionEvaluator(permissionEvaluator);
    return webExpressionHandler;
}</pre> <p>You can see how these steps are very similar to how we added support for permission handling to our method security. This time, it was a bit simpler, since we were able to reuse the same bean with the ID of <strong class="source-inline">PermissionEvaluator</strong>, which we <span class="No-Break">already configured.</span></p>
<p>Start up<a id="_idIndexMarker853"/> our application and try accessing the <strong class="bold">All Events</strong> page as<a id="_idIndexMarker854"/> different users. You will find that the events that are not allowed for a user. They are now hidden using our tag library instead of the <strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">PostFilter</strong></span><span class="No-Break"> annotation.</span></p>
<p>We are still aware that accessing an event directly would allow a user to see it. However, this could easily be added by combining what you learned in this chapter with what you learned about the <strong class="source-inline">@PostAuthorize</strong> annotation in <span class="No-Break">this chapter.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter12.04-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-267"><a id="_idTextAnchor403"/>Mutable ACLs and authorization</h2>
<p>Although the JBCP calendar <a id="_idIndexMarker855"/>application doesn’t implement<a id="_idIndexMarker856"/> full user administration functionality, it’s likely that your application will have common features, such as new user registration and administrative user maintenance. To this point, a lack of these features—which we have worked around using SQL inserts at application startup—hasn’t stopped us from demonstrating many of the features of Spring Security and <span class="No-Break">Spring ACL.</span></p>
<p>However, the proper handling of runtime changes to declared ACLs, or the addition or removal of users in the system, is critical to maintaining the consistency and security of the ACL-based authorization environment. Spring ACL solves this issue through the concept of the mutable <span class="No-Break">ACL (</span><span class="No-Break"><strong class="source-inline">o.s.s.acls.model.MutableAcl</strong></span><span class="No-Break">).</span></p>
<p>Extending the standard ACL interface, the <strong class="source-inline">MutableAcl</strong> interface allows for runtime manipulation of ACL fields to change the in-memory representation of a particular ACL. This additional functionality includes the ability to create, update, or delete ACEs, change ACL ownership, and other <span class="No-Break">useful functions.</span></p>
<p>We might expect, then, that the Spring ACL module would come out of the box with a way to persist runtime ACL changes to the JDBC datastore, and indeed it does. The <strong class="source-inline">o.s.s.acls.jdbc.JdbcMutableAclService</strong> class may be used to create, update, and delete the <strong class="source-inline">MutableAcl</strong> instances in the database, as well as to do general maintenance on the other supporting tables for ACLs (handling <strong class="source-inline">SIDs</strong>, <strong class="source-inline">ObjectIdentity</strong>, and domain object <span class="No-Break">class names).</span></p>
<p>Recall from earlier in the<a id="_idIndexMarker857"/> chapter that the <strong class="source-inline">AclAuthorizationStrategyImpl</strong> class allows us to specify the administrative role for actions<a id="_idIndexMarker858"/> on mutable ACLs. These are supplied to the constructor as part of the bean configuration. The constructor arguments and their meaning are <span class="No-Break">as follows:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table005-1">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Arg #</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">What </strong><span class="No-Break"><strong class="bold">it does</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>It indicates the authority that a principal is required to have to take ownership of an ACL-protected object <span class="No-Break">at runtime</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>2</p>
</td>
<td class="No-Table-Style">
<p>It indicates the authority that a principal is required to have to change the auditing of an ACL-protected object <span class="No-Break">at runtime</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>It indicates the authority that a principal is required to have to make any other kind of change (create, update, and delete) to an ACL-protected object <span class="No-Break">at runtime</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.5 – Constructor arguments for AclAuthorizationStrategyImpl</p>
<p>It may be confusing that we only specified a single constructor argument when there are three arguments listed. The <strong class="source-inline">AclAuthorizationStrategyImpl</strong> class can also accept a single <strong class="source-inline">GrantedAuthority</strong>, which will then be used for all three arguments. This is convenient if we want the same <strong class="source-inline">GrantedAuthority</strong> to be used for all of <span class="No-Break">the operations.</span></p>
<p>The <strong class="source-inline">JdbcMutableAclService</strong> interface contains a number of methods used to manipulate ACL and ACE data at runtime. While the methods themselves are fairly understandable (<strong class="source-inline">createAcl</strong>, <strong class="source-inline">updateAcl</strong>, and <strong class="source-inline">deleteAcl</strong>), the correct way to configure and use <strong class="source-inline">JdbcMutableAclService</strong> is often difficult for even advanced Spring <span class="No-Break">Security users.</span></p>
<p>Let’s modify <strong class="source-inline">CalendarService</strong> to create a new ACL for newly <span class="No-Break">created events.</span></p>
<p><a id="_idTextAnchor404"/><a id="_idTextAnchor405"/>Currently, if a user creates a new event, it will not be visible to the user in the <strong class="bold">All Events</strong> view, since we are using the <strong class="source-inline">&lt;sec:authorize-acl&gt;</strong> tag to only display event objects that the user has access to. Let’s update our <strong class="source-inline">DefaultCalendarService</strong> interface so that when a user creates a new event, they are granted read access to that event and it will be displayed for them on the <strong class="bold">All </strong><span class="No-Break"><strong class="bold">Events</strong></span><span class="No-Break"> page.</span></p>
<p>Let’s look at the following <a id="_idIndexMarker859"/>steps to add ACLs to newly <a id="_idIndexMarker860"/><span class="No-Break">created events:</span></p>
<ol>
<li>The first step is to update our constructor to accept <strong class="source-inline">MutableAclService</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">UserContext</strong></span><span class="No-Break">:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/ DefaultCalendarService.java
@Repository
public class DefaultCalendarService implements CalendarService {
    private final EventDao eventDao;
    private final CalendarUserDao userDao;
    private final MutableAclService aclService;
    private final UserContext userContext;
    public DefaultCalendarService(EventDao eventDao, CalendarUserDao userDao, MutableAclService aclService, UserContext userContext) {
       this.eventDao = eventDao;
       this.userDao = userDao;
       this.aclService = aclService;
       this.userContext = userContext;
    }</pre></li> <li>Then, we <a id="_idIndexMarker861"/>need to update our <strong class="source-inline">createEvent</strong> method <a id="_idIndexMarker862"/>to also create an ACL for the current user. Make the <span class="No-Break">following changes:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/ DefaultCalendarService.java
@Transactional
@Override
public int createEvent(Event event) {
    int result = eventDao.createEvent(event);
    event.setId(result);
    // Add new ACL Entry:
    MutableAcl acl = aclService.createAcl(new ObjectIdentityImpl(event));
    PrincipalSid sid = new PrincipalSid(userContext.getCurrentUser().getEmail());
    acl.setOwner(sid);
    acl.insertAce(0,  BasePermission.READ, sid, true);
    aclService.updateAcl(acl);
    return result;
}</pre></li> <li>The <strong class="source-inline">JdbcMutableAclService</strong> interface uses the current user as the default owner for the created <strong class="source-inline">MutableAcl</strong> interface. We chose to explicitly set the owner again to demonstrate how this can <span class="No-Break">be overridden.</span></li>
<li>We then add a new ACE and save our ACL. That’s all there is <span class="No-Break">to it.</span></li>
<li>Start the application and log in <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">user1@example.com/user1</strong></span><span class="No-Break">.</span></li>
<li>Visit the <strong class="bold">All Events</strong> page and see that there are no events currently listed. Then, create a new event and it will be displayed the next time you visit the <strong class="bold">All Events</strong> page. If you log in as any other user, the event will not be visible on the <strong class="bold">All </strong><span class="No-Break"><strong class="bold">Events</strong></span><span class="No-Break"> page.</span><p class="list-inset">However, it will potentially be visible to the user since we have not applied security to other<a id="_idIndexMarker863"/> pages. Again, we<a id="_idIndexMarker864"/> encourage you to attempt to secure these pages on <span class="No-Break">your own.</span></p></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter12.05-calendar</strong></span><span class="No-Break">.</span></p>
<p>Upon grasping the workings of Spring Security ACL, the subsequent sections will address the factors to be considered in a standard <span class="No-Break">ACL deployment.</span></p>
<h1 id="_idParaDest-268"><a id="_idTextAnchor406"/>Considerations for a typical ACL deployment</h1>
<p>Actually, deploying Spring ACL<a id="_idIndexMarker865"/> in a true business application tends to be quite involved. We wrap up coverage of Spring ACL with some considerations that arise in most <a id="_idTextAnchor407"/>Spring ACL <span class="No-Break">implementation scen<a id="_idTextAnchor408"/>arios.</span></p>
<h2 id="_idParaDest-269"><a id="_idTextAnchor409"/>ACL scalability and performance modeling</h2>
<p>For small and medium-sized applications, the addition of ACLs is quite manageable, and while it adds overhead to database storage and runtime performance, the impact is not likely to be significant. However, depending on the granularity with which ACLs and ACEs are modeled, the numbers of database rows in a medium- to large-sized application can be truly staggering and can task even the most seasoned <span class="No-Break">database administrator.</span></p>
<p>Let’s assume we were to extend ACLs to cover an extended version of the JBCP calendar application. Let’s assume that users can manage accounts, post pictures to events, and administer (add/remove users) from an event. We’ll model the data <span class="No-Break">as follows:</span></p>
<ul>
<li>All users <span class="No-Break">have accounts.</span></li>
<li>10% of users are able to administer an event. The average number of events that a user can administer will <span class="No-Break">be two.</span></li>
<li>Events will be secured (read-only) per customer, but also need to be accessible (read/write) <span class="No-Break">by administrators.</span></li>
<li>10% of all customers will be allowed to post pictures. The average number of posts per user will <span class="No-Break">be 20.</span></li>
<li>Posted pictures will be secured (read/write) per user, as well as administrators. Posted pictures will be read-only for all <span class="No-Break">other users.</span></li>
</ul>
<p>Given what we know <a id="_idIndexMarker866"/>about the ACL system, we know that the database tables have the following <span class="No-Break">scalability attributes:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table006-1">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Table</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Scales </strong><span class="No-Break"><strong class="bold">with data</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Scalability notes</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_CLASS</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No</span></p>
</td>
<td class="No-Table-Style">
<p>One row is required per <span class="No-Break">domain class.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_SID</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Yes (users)</span></p>
</td>
<td class="No-Table-Style">
<p>One row is required per role (<strong class="source-inline">GrantedAuthority</strong>). One row is required for each user account (if individual domain objects are secured <span class="No-Break">per user).</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_OBJECT_IDENTITY</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Yes (domain class instances <span class="No-Break">per class)</span></p>
</td>
<td class="No-Table-Style">
<p>One row is required per instance of a secured <span class="No-Break">domain object.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_ENTRY</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Yes (domain object instances individual <span class="No-Break">ACE entries)</span></p>
</td>
<td class="No-Table-Style">
<p>One row is required per ACE; may require multiple rows for a single <span class="No-Break">domain object.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.6 – Database table’s scalability attributes</p>
<p>We can see that <strong class="source-inline">ACL_CLASS</strong> doesn’t really have scalability concerns (most systems will have fewer than 1,000 <span class="No-Break">domain classes).</span></p>
<p>The <strong class="source-inline">ACL_SID</strong> table will scale linearly based on the number of users in the system. This is probably not a matter of concern because other user-related tables will scale in this fashion as well (user account, and <span class="No-Break">so on).</span></p>
<p>The two tables of concern are <strong class="source-inline">ACL_OBJECT_IDENTITY</strong> and <strong class="source-inline">ACL_ENTRY</strong>. If we model the estimated rows required to model an order for an individual customer, we come up with the <span class="No-Break">following estimates:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table007">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Table</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">ACL data </strong><span class="No-Break"><strong class="bold">per event</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">ACL data per </strong><span class="No-Break"><strong class="bold">picture post</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_OBJECT_IDENTITY</strong></span></p>
</td>
<td class="No-Table-Style">
<p>One row is required for a single <span class="No-Break">event.</span></p>
</td>
<td class="No-Table-Style">
<p>One row is required for a <span class="No-Break">single post.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_ENTRY</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Three rows—one row is required for read access by the owner (the user SID) and two rows are required (one for read access, one for write access) for the administrative <span class="No-Break">group SID.</span></p>
</td>
<td class="No-Table-Style">
<p>Four rows—one row is required for read access by the user group SID, one row is required for write access by the owner, and two rows are required for the administrative group SID (as <span class="No-Break">with events).</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.7 – Scalability estimates per events or posted pictures</p>
<p>We can then take the<a id="_idIndexMarker867"/> usage assumptions from the previous page and calculate the following ACL scalability matrix <span class="No-Break">as follows:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table008">
<colgroup>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Table/Object</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Scale factor</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Estimates (Low)</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Estimates (High)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">Users</strong></span></p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">10,000</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">1,000,000</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">Events</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">#</strong> <strong class="source-inline">Users</strong> <strong class="source-inline">*</strong> <strong class="source-inline">0.1</strong> <strong class="source-inline">*</strong> <strong class="source-inline">2</strong></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">2,000</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">200,000</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">Picture Posts</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">#</strong> <strong class="source-inline">Users</strong> <strong class="source-inline">*</strong> <strong class="source-inline">0.1</strong> <strong class="source-inline">*</strong> <span class="No-Break"><strong class="source-inline">20</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">20,000</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">2,000,000</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_SID</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">#</strong> <span class="No-Break"><strong class="source-inline">Users</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">10,000</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">1,000,000</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_OBJECT_IDENTITY</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">#</strong> <strong class="source-inline">Events</strong> <strong class="source-inline">+</strong> <strong class="source-inline">#</strong> <span class="No-Break"><strong class="source-inline">Picture</strong></span><span class="No-Break"> </span><span class="No-Break"><strong class="source-inline">Posts</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">220,000</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">2,200,000</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ACL_ENTRY</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">(#</strong> <strong class="source-inline">Events</strong> <strong class="source-inline">*</strong> <strong class="source-inline">3)</strong> <strong class="source-inline">+</strong> <strong class="source-inline">(#</strong> <strong class="source-inline">Picture</strong> <strong class="source-inline">Posts</strong> <strong class="source-inline">*</strong> <span class="No-Break"><strong class="source-inline">4)</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">86,000</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">8,600,000</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 12.8 – ACL scalability matrix</p>
<p>From these projections based on only a subset of the business objects likely to be involved and secured in a typical ACL implementation, you can see that the number of database rows devoted to storing ACL information is likely to grow linearly (or faster) in relation to your actual business data. Especially in large system planning, forecasting the amount of ACL data that you are likely to use is extremely important. It is not uncommon for very <a id="_idTextAnchor410"/>complex systems to have hundreds of millions of rows related to <span class="No-Break">ACL storage.</span></p>
<h2 id="_idParaDest-270"><a id="_idTextAnchor411"/>Do not discount custom development costs</h2>
<p>Utilizing a Spring ACL-secured environment often requires significant development work above and beyond the configuration steps we’ve described to this point. Our sample configuration scenario has the <span class="No-Break">following limitations:</span></p>
<ul>
<li>No facility is provided for responding to the manipulation modification of events or modification <span class="No-Break">of permissions.</span></li>
<li>Not all of the applications use permissions. For example, the <strong class="bold">My Events</strong> page and directly navigating to an event are both <span class="No-Break">not secured.</span></li>
</ul>
<p>The application does <a id="_idIndexMarker868"/>not effectively use ACL hierarchies. These limitations would significantly impact the functionality if we were to roll out ACL security to the whole site. This is why it is critical that when planning Spring ACL rollout across an application, you must carefully review all the places where the domain data is manipulated and ensure that these locations correctly update ACL, ACE rules, and invalidate caches. Typically, the securing of methods and data takes place at the service or business application layer, and the hooks required to maintain ACLs and ACEs occur at the data <span class="No-Break">access layer.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer098">
<img alt="Figure 12.6 – Spring ACL permissions evaluation process" height="311" src="image/B21757_12_5.jpg" width="672"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.6 – Spring ACL permissions evaluation process</p>
<p>If you are dealing with a reasonably standard application architecture, with proper isolation and encapsulation of functionality, it’s likely that there’s an easily identified central location for these changes. On the other hand, if you’re dealing with an architecture that has devolved (or was never designed well in the first place), then adding ACL functionality and supporting hooks in data manipulation code can prove to be <span class="No-Break">very difficult.</span></p>
<p>As previously hinted, it’s important to keep in mind that the Spring ACL architecture hasn’t changed significantly since the days of <strong class="source-inline">Acegi 1.x (Parent project of </strong><span class="No-Break"><strong class="source-inline">Spring Security)</strong></span><span class="No-Break">.</span></p>
<p>The following are some <a id="_idIndexMarker869"/>of the most important and commonly encountered issues with the Spring <span class="No-Break">ACL architecture:</span></p>
<ul>
<li>The ACL<a id="_idIndexMarker870"/> infrastructure requires a numeric primary key. For applications that use a <strong class="bold">globally unique identifier</strong> (<strong class="bold">GUID</strong>) or <strong class="bold">Universal Unique Identifier </strong>(<strong class="bold">UUID</strong>) primary key (which occurs more frequently due to<a id="_idIndexMarker871"/> more efficient support in modern databases), this can be a <span class="No-Break">significant limitation.</span></li>
<li>Several inconsistencies exist between the method of configuring Spring ACL and the rest of Spring Security. In general, it is likely that you will run into areas where class delegates or properties are not exposed through <strong class="bold">Dependency Injection</strong> (<strong class="bold">DI</strong>), necessitating an <a id="_idIndexMarker872"/>override and rewrite strategy that can be time consuming and expensive <span class="No-Break">to maintain.</span></li>
<li>The permission bitmask is implemented as an integer and thus has 32 possible bits. It’s somewhat common to expand the default bit assignments to indicate permissions on individual object properties (for example, assigning a bit to read the social security number of an employee). Complex deployments may have well over 32 properties per domain object, in which case the only alternative would be to remodel your domain objects around <span class="No-Break">this limitation.</span></li>
</ul>
<p>Depending on your application requirements, it is likely that you will encounter additional issues, especially with regard to the number of classes requiring change w<a id="_idTextAnchor412"/>hen implementing certain types <span class="No-Break">of customizations.</span></p>
<h2 id="_idParaDest-271"><a id="_idTextAnchor413"/>Should I use Spring Security ACL?</h2>
<p>Just like the details of applying Spring Security are highly business dependent, so is the application of Spring <a id="_idIndexMarker873"/>ACL support. In fact, this tends to be even more true of ACL support due to its tight coupling to business methods and domain objects. We hope that this guide to Spring ACL has explained the important high-level and low-level configurations and concepts required to analyze Spring ACL for use in your application and can assist you in determining and matching its capabilities to <span class="No-Break">real-world use.</span></p>
<h1 id="_idParaDest-272"><a id="_idTextAnchor414"/>Summary</h1>
<p>In this chapter, we focused on security based on ACLs and the specific details of how this type of security is implemented by the Spring <span class="No-Break">ACL module.</span></p>
<p>We reviewed the basic concept of ACLs, and many reasons why they can be very effective solutions to authorization. Also, we learned about the key concepts related to the Spring ACL implementation, including ACEs, SIDs, and object identity. We examined the database schema and logical design required to support a hierarchical ACL system. We configured all the required Spring beans to enable the Spring ACL module and enhanced one of the service interfaces to use annotated <span class="No-Break">method authorization.</span></p>
<p>We then tied the existing users in our database, and business objects used by the site itself, into a sample set of ACE declarations and supporting data. We reviewed the concepts around Spring ACL permission handling. We expanded our knowledge of the Spring Security Thymeleaf tag library and SpEL (for method security) to utilize <span class="No-Break">ACL checks.</span></p>
<p>We discussed the mutable ACL concept and reviewed the basic configuration and custom coding required in a mutable ACL environment. We developed a custom ACL permission and configured the application to demonstrate its effectiveness. We configured and analyzed the use of the <strong class="source-inline">Spring</strong> cache manager to reduce the database impact of Spring ACL. We analyzed the impact and design considerations of using the Spring ACL system in a complex <span class="No-Break">business application.</span></p>
<p>This wraps up our discussion about Spring Security ACLs. In the next chapter, we’ll dig a bit further into how Spring <span class="No-Break">Security works.</span></p>
</div>
</div></body></html>