<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Hardening the WildFly Configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Hardening the WildFly Configuration</h1></div></div></div><p>In this chapter, you will learn the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Delivering your configuration using property files</li><li class="listitem" style="list-style-type: disc">Securing your configuration hashing passwords</li><li class="listitem" style="list-style-type: disc">Securing and protecting passwords using a vault</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec94"/>Introduction</h1></div></div></div><p>In this chapter, you will learn how to secure your WildFly system configuration using different methods. Securing the configuration means hiding sensitive data, such as passwords, from other people who might collaborate on your project or system in one way or another.</p><p>This goal can be achieved in different ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using property files to externalize the dynamic parameters, such as bindings, credentials, and so on</li><li class="listitem" style="list-style-type: disc">Hashing passwords—this is a quite common technique</li><li class="listitem" style="list-style-type: disc">Storing passwords in a vault—this is the most secure method that you can use to protect your passwords</li></ul></div><p>The first approach is not a totally secure one, thus it's a clean method to customize your settings. Still, it can give the freedom to distribute your configuration files without worrying about security concerns because there will just be default settings in it and nothing more. Furthermore, each of your WildFly infrastructure environments can rely on different property files. Configuration is the same; you just deliver a different property file.</p><p>The last two approaches are more focused on obfuscating passwords. Hashing uses a hash algorithm to encrypt the password. Thus, whoever sees the password in the XML configuration file will just see its hash value, not the real password.</p><p>Storing passwords in a vault is a little more complicated, but gives you better protection since a certificate is used to encrypt and decrypt the password.</p></div></div>
<div class="section" title="Delivering your configuration using property files"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec95"/>Delivering your configuration using property files</h1></div></div></div><p>In this <a id="id809" class="indexterm"/>recipe, you will learn how to deliver you <a id="id810" class="indexterm"/>configuration using property files. This might be handy if you do not want to put all your settings' hardcode <a id="id811" class="indexterm"/>into the XML files, thus having to change them for each of your environments. This way, you can provide the general configuration via XML files and provide specific settings for your specific environment via property files.</p><p>Thanks to the property substitution feature provided by WildFly, you can use the <code class="literal">${your.property.goes.here}</code> syntax inside the XML files (that are <code class="literal">standalone.xml</code> or <code class="literal">domain.xml</code> and <code class="literal">host.xml</code>).</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec266"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">ad-hoc</code> folder to run our WildFly. In a terminal window run the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone sec-std-cfg-node-1</pre></div><p>Now it's time to create some property!</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec267"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of all, let's create a property file named <code class="literal">wildflycookbook.properties</code> and add the following property and value:<div class="informalexample"><pre class="programlisting">jboss.bind.address=10.0.0.1</pre></div></li><li class="listitem">Now create the preceding virtual IP in your system. In Linux, you would do it by opening a terminal window and running the following command:<div class="informalexample"><pre class="programlisting">$ sudo ifconfig eth0:1 10.0.0.1 netmask 255.255.255.0</pre></div><p>where <code class="literal">eth0</code> is the name of your network interface.</p></li><li class="listitem">Now, in a terminal window, execute the following command:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=sec-std-cfg-node-1 -P wildflycookbook.properties
...
17:24:05,588 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-16) WFLYUT0006: Undertow HTTP listener default listening on /10.0.0.1:8080
...
17:24:06,019 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 9.0.0.Beta2 (WildFly Core 1.0.0.Beta2) started in 2822ms - Started 202 of 379 services (210 services are lazy, passive or on-demand)</pre></div><p>As you can see from the log output, the emphasized characters, the property has been read from WildFly and placed into its configuration at runtime. So now our WildFly instance is bound to <code class="literal">http://10.0.0.1:8080</code>.</p></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec268"/>How it works…</h2></div></div></div><p>This approach is pretty easy and straightforward; there is not much to talk about except its usage. The preceding example gives you just an idea of what you can do with it.</p><p>The <code class="literal">-P file.property</code> directive is a WildFly feature to load a bunch of system properties <a id="id812" class="indexterm"/>from a property file. WildFly takes <a id="id813" class="indexterm"/>advantage of this mechanism by <a id="id814" class="indexterm"/>providing property substitution for its configurations.</p><p>Imagine a datasource configuration as follows:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;datasources&gt;
    &lt;datasource jndi-name="java:jboss/MySqlDS" pool-name="MySqlDS"&gt;
      &lt;connection-url&gt;jdbc:mysql://mysql-prod-cluster-node-1:3306/store&lt;/connection-url&gt;
      &lt;driver&gt;mysql&lt;/driver&gt;
      &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;1password&lt;/password&gt;
      &lt;/security&gt;
    &lt;/datasource&gt;
    &lt;drivers/&gt;
    &lt;/datasources&gt;
&lt;/subsystem&gt;</pre></div><p>As you can see, parameters to connect to the database, such as server name, server port, database name, and credentials are all hardcoded into the file.</p><p>Now suppose you need to replicate your WildFly configuration somewhere else, but the actual work will be done by a person outside your company. Would you give this person all this information? I guess not.</p><p>Having a <a id="id815" class="indexterm"/>property file can somehow protect you <a id="id816" class="indexterm"/>from giving such information, as <a id="id817" class="indexterm"/>follows:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;datasources&gt;
    &lt;datasource jndi-name="java:jboss/MySqlDS" pool-name="MySqlDS"&gt;
      &lt;connection-url&gt;<span class="strong"><strong>${db.prod.conn.url}</strong></span>&lt;/connection-url&gt;
      &lt;driver&gt;mysql&lt;/driver&gt;
      &lt;security&gt;
        &lt;user-name&gt;<span class="strong"><strong>${db.prod.uid}</strong></span>&lt;/user-name&gt;
        &lt;password&gt;<span class="strong"><strong>${db.prod.pwd}</strong></span>&lt;/password&gt;
      &lt;/security&gt;
    &lt;/datasource&gt;
    &lt;drivers/&gt;
    &lt;/datasources&gt;
&lt;/subsystem&gt;</pre></div><p>Obviously, the preceding property needs to be found and matched into a property file, with the following content:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>db.prod.conn.url</strong></span>=jdbc:mysql://mysql-uat-cluster-node-1:3306/store
<span class="strong"><strong>db.prod.uid</strong></span>=uat
<span class="strong"><strong>dp.prod.pwd</strong></span>=uat-password</pre></div><p>Much better!</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec269"/>There's more…</h2></div></div></div><p>Keep in mind that passing property or property files in Java keeps precedence ordering. Thus, passing a property with <code class="literal">-D</code> notation after specifying a property file would take precedence over the same property. The last one wins!</p></div></div>
<div class="section" title="Securing your configuration hashing passwords"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec96"/>Securing your configuration hashing passwords</h1></div></div></div><p>In this <a id="id818" class="indexterm"/>recipe, you will learn how to mask <a id="id819" class="indexterm"/>passwords as configuration files so that they are not visible, or better, are meaningless for people looking at them.</p><p>You may have heard about transforming a text that should be secret or private, such as a password. Often times, terms such as encoding, encryption, and hashing are used indiscriminately, but they are not the same. Let's clear these concepts before we go.</p><p>Encoding a text is about transforming it to make it readable and acceptable for a different format (like the <code class="literal">&amp;</code> symbol in HTML should be converted to <code class="literal">&amp;amp;</code>).</p><p>Encryption is about transforming a text to make it secret and meaningless. The transformation is based on a key and an algorithm (like AES, RSA, and Blowfish), such that the mix of the key and the algorithm makes the text completely different from its original content. Just the client who knows the key and the algorithm can revert the encrypted text to its original value.</p><p>Hashing is about integrity. This means that it is used to check whether a message (a text, a password, a file, and so on) which has arrived at its destination has been changed during its trip or not. A hash is not reversible. Given an input value, you will always get the same hash output. If you make a tiny change to your source, you will get a totally different hash output. There are several hash function algorithms, like MD5, SHA-3, and so on.</p><p>Let's try the <a id="id820" class="indexterm"/>MD5 checksum on a small piece <a id="id821" class="indexterm"/>of text, as follows:</p><div class="informalexample"><pre class="programlisting">$ md5sum &lt;&lt;&lt; abcdef
5ab557c937e38f15291c04b7e99544ad  -
$ md5sum &lt;&lt;&lt; abcdeF
7ab0aeb4ce14fd8efa00f3c903f72cf5  -</pre></div><p>As you can see, by just changing the last character from <code class="literal">f</code> (lowercase) to <code class="literal">F</code> (uppercase), the MD5 checksum hash function gives a completely different output.</p><p>By the way, in this chapter, we will just use the term hash, either on transformed password by encoding, encrypting or hashing.</p><p>Okay, I hope I've given you a little more information on such topics that really need a deeper explanation. Other than a load of technical books which you can find for yourself, there is a quite interesting one named <span class="emphasis"><em>The Code Book</em></span>, <span class="emphasis"><em>Simon Singh</em></span>.</p><p>Let's go back to WildFly now.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec270"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">ad-hoc</code> folder to run our WildFly. In a terminal window execute the following:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone sec-std-cfg-node-2</pre></div><p>Now it's time to create the hash for our password.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec271"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a new terminal window and run the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ java -cp modules/system/layers/base/org/picketbox/main/picketbox-4.9.0.Beta2.jar org.picketbox.datasource.security.SecureIdentityLoginModule cookbook.2015
Encoded password: 2663ecfd3089b80f99cabb669aa2636e</pre></div><p>The output of the preceding script is your hashed password.</p></li><li class="listitem">To <a id="id822" class="indexterm"/>accomplish this task, we rely on security domains. Create a security domain like the following:<div class="informalexample"><pre class="programlisting">&lt;security-domain name="encrypted-security-domain" cache-type="default"&gt;
  &lt;authentication&gt;
    &lt;login-module 
    code="org.picketbox.datasource.security.SecureIdentityLoginModule" flag="required"&gt;
      &lt;module-option name="username" value="root"/&gt;
      &lt;module-option name="password" value="2663ecfd3089b80f99cabb669aa2636e"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</pre></div></li><li class="listitem">Now, let's <a id="id823" class="indexterm"/>go back to our datasource definition and reference the security domain as follows:<div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;datasources&gt;
    &lt;datasource jndi-name="java:jboss/MySqlDS" pool-
    name="MySqlDS"&gt;
      &lt;connection-url&gt;jdbc:mysql://mysql-prod-cluster-node-1:3306/store&lt;/connection-url&gt;
      &lt;driver&gt;mysql&lt;/driver&gt;
      &lt;security&gt;
        &lt;security-domain&gt;encrypted-security-domain&lt;/security-domain&gt;
      &lt;/security&gt;
    &lt;/datasource&gt;
    &lt;drivers/&gt;
    &lt;/datasources&gt;
&lt;/subsystem&gt;</pre></div></li></ol></div><p>Now it works. Neat!</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec272"/>How it works…</h2></div></div></div><p>All you have to do is generate the hash using the Pickbox security framework provided by WildFly and use its <code class="literal">SecurityIdentityLoginModule</code>.</p><p>After that, you need to create a security domain within your WildFly configuration, which uses the same program (that is the <code class="literal">SecurityIdentityLoginModule</code> class) that generated your password.</p><p>Next, whenever <a id="id824" class="indexterm"/>you need to provide a hashed password, just reference that security domain and you are done. In doing so, the security domain <a id="id825" class="indexterm"/>first generates a hash for the password it is receiving and then matches the generated hash with the one that you stored in your configuration. The rest is just a match/no-match matter.</p><p>To be able to use that password hash within our configuration file, we need to define a security domain which uses exactly the same functionality that generated the hash, otherwise it would be difficult to recognize a clear text password with an encrypted one.</p><p>For example, in a datasource definition, you cannot have the following XML code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;datasources&gt;
    &lt;datasource jndi-name="java:jboss/MySqlDS" pool-name="MySqlDS"&gt;
      &lt;connection-url&gt;jdbc:mysql://mysql-prod-cluster-node-1:3306/store&lt;/connection-url&gt;
      &lt;driver&gt;mysql&lt;/driver&gt;
      &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;2663ecfd3089b80f99cabb669aa2636e&lt;/password&gt;
      &lt;/security&gt;
    &lt;/datasource&gt;
    &lt;drivers/&gt;
    &lt;/datasources&gt;
&lt;/subsystem&gt;</pre></div><p>That is, using the password hash in place does not work! Who can tell if that password is a clear text one or a hashed one?</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec273"/>There's more...</h2></div></div></div><p>This kind <a id="id826" class="indexterm"/>of approach can be used not only for datasource, but even for <code class="literal">login-module</code> itself, JMS queues, and topics.</p></div></div>
<div class="section" title="Securing and protecting passwords using a vault"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec97"/>Securing and protecting passwords using a vault</h1></div></div></div><p>In this <a id="id827" class="indexterm"/>recipe, you will learn how to secure and protect <a id="id828" class="indexterm"/>our password, still providing them to our WildFly <a id="id829" class="indexterm"/>configuration. The vault is a place where you store <a id="id830" class="indexterm"/>passwords, encrypted using a keystore. For our recipe, we will create a keystore and store a password used to connect to the MySQL database. MySQL installation is out of the scope of this book; if you need more <a id="id831" class="indexterm"/>information, refer to the MySQL documentation site at <a class="ulink" href="https://dev.mysql.com/doc/refman/5.5/en/installing.html">https://dev.mysql.com/doc/refman/5.5/en/installing.html</a>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec274"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">ad-hoc</code> folder to run our WildFly:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In a terminal window run the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone sec-std-cfg-node-3</pre></div><p>Now it's time to create our keystore.</p></li><li class="listitem">Within the same terminal window, execute the following:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cd sec-std-cfg-node-3/configuration
$ mkdir vault
$ cd vault
$ keytool -v -genkey -alias wildfly.vault -keyalg RSA -keysize 2048 -sigalg SHA1withRSA -keystore wildfly.vault.keystore
Enter keystore password: [vault.2015]
Re-enter new password: [vault.2015]
What is your first and last name?
  [Unknown]:  WildFly Cookbook
What is the name of your organizational unit?
  [Unknown]:  Packt Publishing
What is the name of your organization?
  [Unknown]:  packtpub.com
What is the name of your City or Locality?
  [Unknown]:  Birmingham
What is the name of your State or Province?
  [Unknown]:  GB
What is the two-letter country code for this unit?
  [Unknown]:  UK
Is CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK correct?
  [no]:  yes

Generating 2,048 bit RSA key pair and self-signed certificate (SHA1withRSA) with a validity of 90 days
  for: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Enter key password for &lt;wildfly.vault&gt;
  (RETURN if same as keystore password):
[Storing wildfly.vault.keystore]</pre></div></li><li class="listitem">Okay, now <a id="id832" class="indexterm"/>we have created the keystore <a id="id833" class="indexterm"/>to encrypt our passwords. Let's <a id="id834" class="indexterm"/>check its integrity by executing <a id="id835" class="indexterm"/>the following command:<div class="informalexample"><pre class="programlisting">$ keytool -list -v -keystore wildfly.vault.keystore
Enter keystore password:

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: wildfly.vault
Creation date: Dec 6, 2014
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 6cfc82e9
Valid from: Sat Dec 06 14:43:16 CET 2014 until: Fri Mar 06 14:43:16 CET 2015
Certificate fingerprints:
   MD5:  FA:A6:5F:E6:7F:04:70:7E:70:FA:56:E7:9C:8A:B8:95
   SHA1: D2:18:BE:44:58:B1:57:54:0A:69:F9:E2:DB:3F:A7:82:7D:DE:DB:6B
   SHA256: 8D:DF:16:64:3D:F6:08:08:71:8A:5F:4C:16:27:82:C8:20:75:FC:67:DD:9D:68:0E:0C:6F:08:7F:FA:E8:5D:18
   Signature algorithm name: SHA1withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 68 21 C0 CE C1 A5 A0 11   3D 5B EE E8 18 92 72 ED  h!......=[....r.
0010: C4 28 46 2B                                        .(F+
]
]



*******************************************
*******************************************</pre></div></li></ol></div><p>Okay, everything <a id="id836" class="indexterm"/>is fine! We are now ready to encrypt our <a id="id837" class="indexterm"/>passwords and store them into a vault.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec275"/>How to do it…</h2></div></div></div><p>To generate a <a id="id838" class="indexterm"/>vault, WildFly provides us with a script, <code class="literal">vault.sh</code>, inside the <code class="literal">bin</code> folder.</p><p>As an example, we <a id="id839" class="indexterm"/>will generate a vault that stores a password that will be used to connect to a database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal window and execute the following:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/sec-std-cfg-node-3/configuration
$ $WILDFLY_HOME/bin/vault.sh -a PASSWORD -x cookbook.2015 -b DB-PROD -i 50 -k vault/wildfly.vault.keystore -p vault.2015 -s 86427531 -v wildfly.vault

...

Dec 06, 2014 10:28:20 PM org.picketbox.plugins.vault.PicketBoxSecurityVault init
INFO: PBOX000361: Default Security Vault Implementation Initialized and Ready
Secured attribute value has been stored in Vault.
Please make note of the following:
********************************************
Vault Block:DB-PROD
Attribute Name:PASSWORD
Configuration should be done as follows:
VAULT::DB-PROD::PASSWORD::1
********************************************
Vault Configuration in WildFly configuration file:
********************************************
...
&lt;/extensions&gt;
&lt;vault&gt;
  &lt;vault-option name="KEYSTORE_URL" value="vault/wildfly.vault.keystore"/&gt;
  &lt;vault-option name="KEYSTORE_PASSWORD" value="MASK-1cn1ENbx4KLXxve5VvGlPy"/&gt;
  &lt;vault-option name="KEYSTORE_ALIAS" value="wildfly.vault"/&gt;
  &lt;vault-option name="SALT" value="86427531"/&gt;
  &lt;vault-option name="ITERATION_COUNT" value="50"/&gt;
  &lt;vault-option name="ENC_FILE_DIR" value="vault/"/&gt;
&lt;/vault&gt;&lt;management&gt; ...
********************************************</pre></div><p>The <a id="id840" class="indexterm"/>preceding script is the <code class="literal">vault.sh</code> <a id="id841" class="indexterm"/>output and it depicts the <a id="id842" class="indexterm"/>following points:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to reference the password stored in the vault</li><li class="listitem" style="list-style-type: disc">A file named <code class="literal">VAULT.dat</code> inside a <code class="literal">vault</code> folder</li><li class="listitem" style="list-style-type: disc">An XML code snippet to be placed into the <code class="literal">standalone.xml</code> or <code class="literal">host.xml</code> file</li></ul></div></li><li class="listitem">We can <a id="id843" class="indexterm"/>now use the vault in our datasource <a id="id844" class="indexterm"/>configuration, as follows:<div class="informalexample"><pre class="programlisting">&lt;datasource jndi-name="java:jboss/datasources/VaultDS" pool-name="VaultDS" enabled="true" use-java-context="true"&gt;
    &lt;connection-url&gt;jdbc:mysql://192.168.59.103:3306/test
&lt;/connection-url&gt;
    &lt;driver&gt;mysql&lt;/driver&gt;
    &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;${VAULT::DB-PROD::PASSWORD::1}&lt;/password&gt;
    &lt;/security&gt;
&lt;/datasource&gt;</pre></div><p>To test <a id="id845" class="indexterm"/>our configuration, we need a <a id="id846" class="indexterm"/>running MySQL server. In my case, it is bound to a server running at <code class="literal">192.168.59.103:3306</code>. Furthermore, we need to configure the connection pool in order to instantly put valid connections into it that act as proof.</p></li><li class="listitem">So the datasource configuration is as follows:<div class="informalexample"><pre class="programlisting">&lt;datasource jndi-name="java:jboss/datasources/VaultDS" pool-name="VaultDS" enabled="true"&gt;
    &lt;connection-url&gt;jdbc:mysql://192.168.59.103:3306/test&lt;/connection-
    url&gt;
    &lt;driver&gt;mysql&lt;/driver&gt;
    &lt;pool&gt;
        &lt;min-pool-size&gt;5&lt;/min-pool-size&gt;
        &lt;max-pool-size&gt;5&lt;/max-pool-size&gt;
        &lt;prefill&gt;true&lt;/prefill&gt;
    &lt;/pool&gt;
    &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;${VAULT::DB-PROD::PASSWORD::1}&lt;/password&gt;
    &lt;/security&gt;
&lt;/datasource&gt;</pre></div></li><li class="listitem">Let's start our WildFly instance and take a look at the logs. Run the following command:<div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=sec-std-cfg-node-3
...
15:32:35,607 INFO  [org.jboss.as.server.deployment.scanner] (MSC service thread 1-4) JBAS015012: Started FileSystemDeploymentService for directory /opt/wildfly/sec-std-cfg-node-2/deployments
<span class="strong"><strong>15:32:35,636 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-1) JBAS010400: Bound data source [java:jboss/datasources/VaultDS]</strong></span>
15:32:35,636 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-13) JBAS010400: Bound data source [java:jboss/datasources/ExampleDS]
15:32:35,676 INFO  [org.jboss.ws.common.management] (MSC service thread 1-12) JBWS022052: Starting JBoss Web Services - Stack CXF Server 4.2.4.Final
15:32:35,722 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015961: Http management interface listening on http://127.0.0.1:9990/management
15:32:35,723 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015951: Admin console listening on http://127.0.0.1:9990
15:32:35,723 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: WildFly 8.1.0.Final "Kenny" started in 3854ms - Started 203 of 251 services (81 services are lazy, passive or on-demand)</pre></div></li><li class="listitem">In the <a id="id847" class="indexterm"/>log, I've emphasized the statement <a id="id848" class="indexterm"/>pointing out the <code class="literal">VaultDS</code> datasource, which is successfully bounded. Now open a new terminal window and <a id="id849" class="indexterm"/>connect to the CLI to check our <a id="id850" class="indexterm"/>available connections, as follows:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh
You are disconnected at the moment. Type 'connect' to connect to the server or 'help' for the list of supported commands.
[disconnected /] connect
[standalone@localhost:9990 /] /subsystem=datasources/data-source=VaultDS/statistics=pool:read-resource(include-runtime=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "ActiveCount" =&gt; "5",
        "AvailableCount" =&gt; "5",
        "AverageBlockingTime" =&gt; "0",
        "AverageCreationTime" =&gt; "36",
        "AverageGetTime" =&gt; "0",
        "BlockingFailureCount" =&gt; "0",
        "CreatedCount" =&gt; "5",
        "DestroyedCount" =&gt; "0",
        "IdleCount" =&gt; "5",
        "InUseCount" =&gt; "0",
        "MaxCreationTime" =&gt; "43",
        "MaxGetTime" =&gt; "0",
        "MaxUsedCount" =&gt; "1",
        "MaxWaitCount" =&gt; "0",
        "MaxWaitTime" =&gt; "0",
        "TimedOut" =&gt; "0",
        "TotalBlockingTime" =&gt; "0",
        "TotalCreationTime" =&gt; "180",
        "TotalGetTime" =&gt; "0",
        "WaitCount" =&gt; "0"
    }
}
[standalone@localhost:9990 /]</pre></div><p>Great! From the preceding output, we can say that the connection pool of our <code class="literal">VaultDS</code> datasource is filled with five available and active connections.</p></li><li class="listitem">Now, just <a id="id851" class="indexterm"/>to prove that we are doing well, let's <a id="id852" class="indexterm"/>try adding two more datasources connecting to the same database; one using a password in clear text, the <a id="id853" class="indexterm"/>other one using a wrong vault-block <a id="id854" class="indexterm"/>definition. Add the following datasource definition:<div class="informalexample"><pre class="programlisting">&lt;datasource jndi-name="java:jboss/datasources/UnsecureDS" pool-name="UnsecureDS" enabled="true"&gt;
    &lt;connection-url&gt;jdbc:mysql://192.168.59.103:3306/test&lt;/connection-url&gt;
    &lt;driver&gt;mysql&lt;/driver&gt;
    &lt;pool&gt;
        &lt;min-pool-size&gt;2&lt;/min-pool-size&gt;
        &lt;max-pool-size&gt;2&lt;/max-pool-size&gt;
        &lt;prefill&gt;true&lt;/prefill&gt;
    &lt;/pool&gt;
    &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;cookbook.2015&lt;/password&gt;
    &lt;/security&gt;
&lt;/datasource&gt;
&lt;datasource jndi-name="java:jboss/datasources/WrongVaultDS" pool-name="WrongVaultDS" enabled="true"&gt;
    &lt;connection-url&gt;jdbc:mysql://192.168.59.103:3306/test&lt;/connection-url&gt;
    &lt;driver&gt;mysql&lt;/driver&gt;
    &lt;pool&gt;
        &lt;min-pool-size&gt;1&lt;/min-pool-size&gt;
        &lt;max-pool-size&gt;1&lt;/max-pool-size&gt;
        &lt;prefill&gt;true&lt;/prefill&gt;
    &lt;/pool&gt;
    &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;${VAULT::DB-TEST::PASSWORD::1}&lt;/password&gt;
    &lt;/security&gt;
&lt;/datasource&gt;</pre></div></li><li class="listitem">The <a id="id855" class="indexterm"/><code class="literal">UnsecureDS</code> datasource connects <a id="id856" class="indexterm"/>to the database using a clear text <a id="id857" class="indexterm"/>password, whilst the <code class="literal">WrongVaultDS</code> is using a wrong <code class="literal">vault-block</code>, that is <code class="literal">DB-TEST</code> which we didn't create. Let's start our WildFly once again and catch the logs for errors. Execute the <a id="id858" class="indexterm"/>following command:<div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=sec-std-cfg-node-3
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>15:52:08,452 ERROR [org.jboss.as.controller.management-operation] (ServerService Thread Pool -- 27) JBAS014612: Operation ("add") failed - address: ([</strong></span>
 <span class="strong"><strong>   ("subsystem" =&gt; "datasources"),</strong></span>
<span class="strong"><strong>    ("data-source" =&gt; "WrongVaultDS")</strong></span>
<span class="strong"><strong>]): java.lang.SecurityException: JBAS013311: Security Exception</strong></span>
<span class="strong"><strong>  at  org.jboss.as.security.vault.RuntimeVaultReader.retrieveFromVault(RuntimeVaultReader.java:104)</strong></span>
<span class="strong"><strong>  at org.jboss.as.server.RuntimeExpressionResolver.resolvePluggableExpression(RuntimeExpressionResolver.java:45)</strong></span>
<span class="strong"><strong>...</strong></span>
15:52:08,499 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-2) JBAS017519: Undertow HTTP listener default listening on /127.0.0.1:8080
15:52:08,499 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-4) JBAS017519: Undertow AJP listener ajp listening on /127.0.0.1:8009
<span class="strong"><strong>15:52:08,631 ERROR [org.jboss.as.controller.management-operation] (Controller Boot Thread) "JBAS014784: Failed executing subsystem datasources boot operations"</strong></span>
<span class="strong"><strong>15:52:08,633 ERROR [org.jboss.as.controller.management-operation] (Controller Boot Thread) JBAS014613: Operation ("parallel-subsystem-boot") failed - address: ([]) - failure description: "\"JBAS014784: Failed executing subsystem datasources boot operations\""</strong></span>
15:52:08,670 INFO  [org.jboss.as.server.deployment.scanner] (MSC service thread 1-1) JBAS015012: Started FileSystemDeploymentService for directory /Users/foogaro/wildfly-8.1.0.Final/sec-std-cfg-node-2/deployments
15:52:08,705 INFO  [org.jboss.ws.common.management] (MSC service thread 1-5) JBWS022052: Starting JBoss Web Services - Stack CXF Server 4.2.4.Final
<span class="strong"><strong>15:52:08,706 ERROR [org.jboss.as.controller.management-operation] (Controller Boot Thread) JBAS014613: Operation ("add") failed - address: ([</strong></span>
<span class="strong"><strong>    ("subsystem" =&gt; "datasources"),</strong></span>
<span class="strong"><strong>    ("data-source" =&gt; "WrongVaultDS")</strong></span>
<span class="strong"><strong>]) - failure description: "JBAS014749: Operation handler failed: JBAS013311: Security Exception"</strong></span>
15:52:08,748 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015961: Http management interface listening on http://127.0.0.1:9990/management
15:52:08,748 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015951: Admin console listening on http://127.0.0.1:9990
15:52:08,749 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: WildFly 8.1.0.Final "Kenny" started in 3150ms - Started 183 of 231 services (81 services are lazy, passive or on-demand)</pre></div><p>As you <a id="id859" class="indexterm"/>can see, the log is showing errors and complaining about a <code class="literal">SecurityException</code> regarding the <code class="literal">WrongVaultDS</code>. Thus, all the datasource subsystem is in error and not initialized.</p></li><li class="listitem">Try <a id="id860" class="indexterm"/>removing <code class="literal">WrongVaultDS</code> from the <a id="id861" class="indexterm"/>datasource definition, start WildFly once again and you should find the following log entries:<div class="informalexample"><pre class="programlisting">15:57:07,585 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-11) JBAS010400: Bound data source [java:jboss/datasources/VaultDS]
15:57:07,585 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-16) JBAS010400: Bound data source [java:jboss/datasources/UnsecureDS]</pre></div></li></ol></div><p>As you can see, both <code class="literal">VaultDS</code> and <code class="literal">UnsecureDS</code> are properly bound.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec276"/>How it works…</h2></div></div></div><p>The <code class="literal">keytool</code> <a id="id862" class="indexterm"/>command is a tool provided by the Java SE <a id="id863" class="indexterm"/>platform, but understanding its usage and parameters is <a id="id864" class="indexterm"/>out of the scope of this book. However, a link to <a id="id865" class="indexterm"/>the official documentation provided by Oracle has been given in the <span class="emphasis"><em>See also...</em></span> section of this recipe.</p><p>Let's analyze the vault script used in this recipe and provided by WildFly for you. Let's first see what option we have with the preceding script, by issuing the following command in a terminal window:</p><div class="informalexample"><pre class="programlisting">$ ./bin/vault.sh --help
usage: vault.sh &lt;empty&gt; |  [-a &lt;arg&gt;] [-b &lt;arg&gt;] -c | -h | -x &lt;arg&gt; [-e
       &lt;arg&gt;]  [-i &lt;arg&gt;] [-k &lt;arg&gt;] [-p &lt;arg&gt;] [-s &lt;arg&gt;] [-v &lt;arg&gt;]
 -a,--attribute &lt;arg&gt;           Attribute name
 -b,--vault-block &lt;arg&gt;         Vault block
 -c,--check-sec-attr            Check whether the secured attribute
                                already exists in the Vault
 -e,--enc-dir &lt;arg&gt;             Directory containing encrypted files
 -h,--help                      Help
 -i,--iteration &lt;arg&gt;           Iteration count
 -k,--keystore &lt;arg&gt;            Keystore URL
 -p,--keystore-password &lt;arg&gt;   Keystore password
 -s,--salt &lt;arg&gt;                8 character salt
 -v,--alias &lt;arg&gt;               Vault keystore alias
 -x,--sec-attr &lt;arg&gt;            Secured attribute value (such as
                                password)to store</pre></div><p>Now check how we invoked the script:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/sec-std-cfg-node-3/configuration
$ $WILDFLY_HOME/bin/vault.sh -a PASSWORD -x cookbook.2015 -b DB-PROD -i 50 -k vault/wildfly.vault.keystore -p vault.2015 -s 86427531 -v wildfly.vault</pre></div><p>So, we created an attribute named <code class="literal">PASSWORD</code> using the <code class="literal">-a</code> (minus <code class="literal">a</code>) notation, we then set its value as <code class="literal">cookbook.2015</code> using the <code class="literal">-x</code> (minus <code class="literal">x</code>) notation. Then, we created a vault-block to store the attribute and its value using the <code class="literal">-b</code> (minus <code class="literal">b</code>) notation. The rest of the parameters are used to bind the keystore which encrypts the attribute value, which is our password.</p><p>The <code class="literal">vault.sh</code> script <a id="id866" class="indexterm"/>generates for us a helpful output to invoke and reference the vault and the vault-block, which maps to our password. Using the information that it needs, WildFly is able to  automatically extract the password and pass it to the component that is requesting it.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec277"/>There's more…</h2></div></div></div><p>The vault can store more passwords just by providing a different <code class="literal">vault-block</code>.</p><p>For example, at the <a id="id867" class="indexterm"/>end of the <span class="emphasis"><em>How to do it…</em></span> section of this <a id="id868" class="indexterm"/>recipe, we tried to bind a datasource (<code class="literal">WrongVaultDS</code>) using a different <code class="literal">vault-block</code>; we called it <code class="literal">DB-TEST</code>. As a result, we couldn't <a id="id869" class="indexterm"/>bind that datasource and thus, the whole datasource subsystem was in error. Let's now try to add the same datasource definition, but this time, we will also provide the <code class="literal">DB-TEST</code> vault-block to our vault file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal window, and execute the following command:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/sec-std-cfg-node-2/configuration
$ $WILDFLY_HOME/bin/vault.sh -a PASSWORD -x cookbook.2015 -b DB-TEST -i 50 -k vault/wildfly.vault.keystore -p vault.2015 -s 86427531 -v wildfly.vault
…
Dec 08, 2014 4:20:17 PM org.picketbox.plugins.vault.PicketBoxSecurityVault init
INFO: PBOX000361: Default Security Vault Implementation Initialized and Ready
Secured attribute value has been stored in Vault.
Please make note of the following:
********************************************
Vault Block:DB-TEST
Attribute Name:PASSWORD
Configuration should be done as follows:
VAULT::DB-TEST::PASSWORD::1
********************************************
Vault Configuration in WildFly configuration file:
********************************************
...
&lt;/extensions&gt;
&lt;vault&gt;
  &lt;vault-option name="KEYSTORE_URL" value="vault/wildfly.vault.keystore"/&gt;
  &lt;vault-option name="KEYSTORE_PASSWORD" value="MASK-1cn1ENbx4KLXxve5VvGlPy"/&gt;
  &lt;vault-option name="KEYSTORE_ALIAS" value="wildfly.vault"/&gt;
  &lt;vault-option name="SALT" value="86427531"/&gt;
  &lt;vault-option name="ITERATION_COUNT" value="50"/&gt;
  &lt;vault-option name="ENC_FILE_DIR" value="vault/"/&gt;
&lt;/vault&gt;&lt;management&gt; ...
********************************************</pre></div></li><li class="listitem">Now edit <a id="id870" class="indexterm"/>the <code class="literal">standalone.xml</code> file and add the <a id="id871" class="indexterm"/>following XML code snippet:<div class="informalexample"><pre class="programlisting">&lt;datasource jndi-name="java:jboss/datasources/WrongVaultDS" pool-name="WrongVaultDS" enabled="true"&gt;
    &lt;connection-url&gt;jdbc:mysql://192.168.59.103:3306/test&lt;/connection-url&gt;
    &lt;driver&gt;mysql&lt;/driver&gt;
    &lt;pool&gt;
        &lt;min-pool-size&gt;1&lt;/min-pool-size&gt;
        &lt;max-pool-size&gt;1&lt;/max-pool-size&gt;
        &lt;prefill&gt;true&lt;/prefill&gt;
    &lt;/pool&gt;
    &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;${VAULT::DB-TEST::PASSWORD::1}&lt;/password&gt;
    &lt;/security&gt;
&lt;/datasource&gt;</pre></div></li><li class="listitem">Now, start <a id="id872" class="indexterm"/>WildFly as usual and look at the log. Run the following command:<div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=sec-std-cfg-node-3
...
16:33:02,063 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-3) JBAS010400: Bound data source [java:jboss/datasources/<span class="strong"><strong>WrongVaultDS</strong></span>]
16:33:02,063 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-6) JBAS010400: Bound data source [java:jboss/datasources/ExampleDS]
16:33:02,063 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-2) JBAS010400: Bound data source [java:jboss/datasources/VaultDS]
16:33:02,063 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-9) JBAS010400: Bound data source [java:jboss/datasources/UnsecureDS]
16:33:02,064 INFO  [org.jboss.ws.common.management] (MSC service thread 1-5) JBWS022052: Starting JBoss Web Services - Stack CXF Server 4.2.4.Final
16:33:02,118 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015961: Http management interface listening on http://127.0.0.1:9990/management
16:33:02,119 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015951: Admin console listening on http://127.0.0.1:9990
16:33:02,120 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: WildFly 8.1.0.Final "Kenny" started in 1992ms - Started 203 of 251 services (81 services are lazy, passive or on-demand)</pre></div></li></ol></div><p>It worked! As <a id="id873" class="indexterm"/>you can see, you can define and store all <a id="id874" class="indexterm"/>passwords that you want in a vault as long as you <a id="id875" class="indexterm"/>declare a different vault-block.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec278"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a deep <a id="id876" class="indexterm"/>understanding of the keytool <a id="id877" class="indexterm"/>command, please refer to the Oracle official documentation at <a class="ulink" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html</a></li></ul></div></div></div></body></html>