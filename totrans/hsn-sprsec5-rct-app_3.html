<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Authentication Using SAML, LDAP, and OAuth/OIDC</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will look at the authentication mechanisms—namely SAML, LDAP, and OAuth/OIDC<span>—</span>supported by Spring Security. This will be a fully hands-on coding chapter. We will build small applications, most of them starting from the base application that we built in <a href="e43a2e26-5b28-4d37-a7f8-d3c992a07bc2.xhtml" target="_blank">Chapter 2</a>, <em><span>Deep Diving into Spring Security</span></em><a href="e43a2e26-5b28-4d37-a7f8-d3c992a07bc2.xhtml" target="_blank"/>.</p>
<p>The main goal of this chapter is to make you comfortable with implementing the authentication mechanisms most commonly used across your organization, and also to showcase Spring Security module capabilities.</p>
<p>Each of the authentication mechanisms has a project that you can see in the book's GitHub page. However, in the book, we will only cover important aspects of the sample code, to reduce clutter within the chapter.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Security Assertion Markup Language</li>
<li>Lightweight Directory Access Protocol</li>
<li>OAuth2 and OpenID Connect</li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Security Assertion Markup Language</h1>
                </header>
            
            <article>
                
<p class="mce-root"><strong>Security Assertion Markup Language</strong> (<strong>SAML</strong>), developed by the <em>Security Services Technical Committee of OASIS</em>, is an XML-based framework for communicating user authentication, entitlement and attribute information. SAML allows business entities to make assertions regarding the identity, attributes, and entitlements of a subject (an entity that is often a human user) to other entities, such as a partner company or another enterprise.</p>
<p class="mce-root">The module <kbd>application.SAML</kbd> is also:</p>
<ul>
<li>A set of XML-based protocol messages</li>
<li>A set of protocol message bindings</li>
<li>A set of profiles (utilizing all of the above)</li>
</ul>
<p class="mce-root"><strong><span>Identity Provider</span></strong> (<strong><span>IdP</span></strong>) is a system that creates, maintains, and manages identity information for principals (users, services, or systems), and provides principal authentication to other service providers (applications) within a federation or distributed network.</p>
<p class="mce-root"><strong><span>Service Provider</span></strong> (<strong><span>SP</span></strong>) is any system that provides services, typically the services for which users seek authentication, including web or enterprise applications. A special type of service provider, the identity provider, administers identity information.</p>
<div class="packt_tip"><span>For more information on SAML, IdP, and SP, you can also refer to the following links:<br/></span><a href="http://xml.coverpages.org/saml.html"><br/>
http://xml.coverpages.org/saml.html</a><span><br/>
<a href="http://kb.mit.edu/confluence/display/glossary/IdP+(Identity+Provider)">http://kb.mit.edu/confluence/display/glossary/IdP+(Identity+Provider)</a><br/>
<a href="https://searchsecurity.techtarget.com/definition/SAML">https://searchsecurity.techtarget.com/definition/SAML</a><br/></span></div>
<p>Spring Security has a top-level project named Spring Security SAML. It is considered an extension providing Spring applications to integrate with a variety of authentication and federation mechanisms that supports SAML 2.0. This extension also supports multiple SAML 2.0, profiles as well as IdP and SP initiated SSO.</p>
<p>There are a number of SAML 2.0 compliant products (IdP mode), such as <strong>Okta</strong>, <strong>Ping Federate</strong>, and <strong>ADFS</strong>, that can be integrated into your application quite easily using this Spring Security extension.</p>
<p>Going into detail on SAML is out of the scope of this book. However, we will try to integrate a Spring Boot application that we built earlier, in <a href="e43a2e26-5b28-4d37-a7f8-d3c992a07bc2.xhtml">Chapter 2</a>, <em>Deep Diving into Spring Security</em>, to tweak and convert it into authentication with an SAML 2.0 product: Okta. In the world of SSO, Okta is a well-known product, allowing applications to easily achieve SSO. In the following example, we will also be using the<span> </span><kbd>spring-security-saml-dsl</kbd><span> </span>project, a Spring Security extension project containing Okta DSL. The use of this eases Spring Security and Okta integration quite significantly. We will also run you through configurations that you will have to use in the Okta platform, to make sure that the example is self-contained and complete. This does not mean that you have to use Okta as the SSO platform for your application; instead, it showcases the Spring Security SAML module, using Okta as an example.</p>
<p>As mentioned previously, we will copy the Spring Boot project that we created in <a href="e43a2e26-5b28-4d37-a7f8-d3c992a07bc2.xhtml">Chapter 2</a>, <em>Deep Diving into Spring Security,</em> as a head start for this example. Now, let's go ahead and look at how we can set up the SSO provider (Okta) first; in subsequent sections, we will look at how we can tweak our copied Spring Boot application to achieve SAML 2.0 authentication.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up an SSO provider</h1>
                </header>
            
            <article>
                
<p>As detailed, we will be using Okta as our SSO provider to build our sample application, which covers Spring Security using SAML 2.0 as the authentication mechanism.</p>
<p class="mce-root">To set up an Okta user, perform the following steps:</p>
<ol>
<li>Go to<span> </span><a href="https://developer.okta.com">https://developer.okta.com</a><span> </span>and click on <span class="packt_screen">SIGN UP</span>.</li>
<li>Enter the relevant details and click on <span class="packt_screen">GET STARTED</span>.</li>
<li>Okta will send you an email with your <span class="packt_screen">Org Subdomain</span> and <span class="packt_screen">Temporary Password</span>.</li>
<li>Click on the <span class="packt_screen">Sign In</span> button in the email, enter your <span class="packt_screen">Username</span> (email) and <span class="packt_screen">Temporary Password</span>, and log in.</li>
<li>You will be presented with some more account-related information. Fill in the details and complete your account setup.</li>
<li>You now have an Okta account set up with one user (you) and no applications configured to do SSO.</li>
</ol>
<p class="mce-root">To set up the Okta application, perform the following steps:</p>
<ol>
<li>Log in to your account and click on the <span class="packt_screen">Admin</span> button.</li>
<li>On the screen, click on the <span class="packt_screen">Add Applications</span> shortcut link.</li>
<li>Click on the <span class="packt_screen">Create New App</span> button. Select <span class="packt_screen">Web</span> as the platform, select the <span class="packt_screen">SAML 2.0</span> radio button, and click on the <span class="packt_screen">Create</span> button.</li>
<li>In the <span class="packt_screen">App name</span> field, enter your app name, keep the rest of the fields as they are, and click on the <span class="packt_screen">Next</span> button.</li>
<li>In the <span class="packt_screen">Single sign on URL</span> field, enter the URL as <kbd>https://localhost:8443/saml/SSO</kbd>. In the <span class="packt_screen">Audience URI</span> field, enter the URI as <kbd>https://localhost:8443/saml/metadata</kbd>. Keep the rest of the fields as they are, and click on the <span class="packt_screen">Next</span> button.</li>
<li>Click on the radio button that says <span class="packt_screen">I'm an Okta customer adding an internal app</span>.</li>
<li>Select the checkbox that says, <span class="packt_screen">This is an internal app that we have created</span>, and click on the <span class="packt_screen">Finish</span> button.</li>
</ol>
<p class="mce-root">To assign an Okta application to a user, you need to follow the following steps:</p>
<ol>
<li>Navigate to the dashboard and click on the <span class="packt_screen">Assign Applications</span> shortcut link.</li>
<li>Click on the created application (in the <span class="packt_screen">Applications</span> section) on the left, click on your username (on the <span class="packt_screen">People</span> section) on the right, and click on the <span class="packt_screen">Next</span> button.</li>
<li>On the next page, click on the <span class="packt_screen">Confirm Assignments</span> button, and you will be done assigning the application to a user.</li>
</ol>
<p>You have <span>now</span><span> </span><span>created the Okta application, and your user assignment is complete. Now, let's try modifying the application created </span><span>earlier,</span><span> </span><span>so as to authenticate users using SAML 2.0, against the Okta application we created.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up the project</h1>
                </header>
            
            <article>
                
<p>We will be changing two files: namely,<span> </span><kbd>SpringSecuirtyConfig</kbd> (the Spring Security configuration file) and the Spring application properties file (<kbd>application.yml</kbd>). In the earlier application, instead of a YML (YAML) file, we used a properties file (<kbd>application.properties</kbd>). In this example, we will discard the <kbd>application.properties</kbd> file and will use the <kbd>application.yml</kbd> file for all of the setup. Let's begin now.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The pom.xml file setup</h1>
                </header>
            
            <article>
                
<p>Copy your previous project. Open the <kbd>pom.xml</kbd> file and add the following dependencies:</p>
<pre>&lt;!-- SAML2 --&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;org.springframework.security.extensions&lt;/groupId&gt;<br/>   &lt;artifactId&gt;spring-security-saml2-core&lt;/artifactId&gt;<br/>   &lt;version&gt;1.0.3.RELEASE&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;org.springframework.security.extensions&lt;/groupId&gt;<br/>   &lt;artifactId&gt;spring-security-saml-dsl-core&lt;/artifactId&gt;<br/>   &lt;version&gt;1.0.5.RELEASE&lt;/version&gt;<br/>&lt;/dependency&gt;</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The application.yml file setup</h1>
                </header>
            
            <article>
                
<p>Create a new <kbd>application.yml</kbd> file in the <kbd>src/main/resources</kbd> folder with the following content:</p>
<pre>server:<br/> port: 8443<br/> ssl:<br/>   enabled: true<br/>   key-alias: spring<br/>   key-store: src/main/resources/saml/keystore.jks<br/>   key-store-password: secret<br/><br/>security:<br/> saml2:<br/>   metadata-url: https://dev-858930.oktapreview.com/app/exkequgfgcSQUrK1N0h7/sso/saml/metadata<br/><br/>spring:<br/> mvc:<br/>   view:<br/>     prefix: /WEB-INF/views/<br/>     suffix: .jsp</pre>
<p>In lines 13-17  (in the <kbd>spring</kbd> section), we have migrated the configuration data that we had in the <kbd>application.properties</kbd> file into a YML format. You can keep all the preceding configuration same apart from the configurations of<span> </span><kbd>metadata-url</kbd> file. For this, you have to go back to the Okta application that you created and navigate to the <span class="packt_screen">Sign On</span> tab. Now, click on the <span class="packt_screen">Identity Provider</span> metadata <span>link</span> <span>and copy the link. It will look similar to the one shown previously, with <kbd>metadata</kbd> at the end of the URL.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The Spring Security configuration files</h1>
                </header>
            
            <article>
                
<p>Now, we will change (or rather, configure) our Spring Security configuration files, as follows:</p>
<pre>@EnableWebSecurity<br/>@Configuration<br/>@EnableGlobalMethodSecurity(securedEnabled = true)<br/>public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {<br/><br/>   @Value("${security.saml2.metadata-url}")<br/>   String metadataUrl;<br/><br/>   @Override<br/>   protected void configure(HttpSecurity http) throws Exception {<br/>      http<br/>               .authorizeRequests()<br/>               .antMatchers("/saml/**").permitAll()<br/>               .anyRequest().authenticated()<br/>               .and()<br/>               .apply(saml())<br/>               .serviceProvider()<br/>               .keyStore()<br/>               .storeFilePath("saml/keystore.jks")<br/>               .password("secret")<br/>               .keyname("spring")<br/>               .keyPassword("secret")<br/>               .and()<br/>               .protocol("https")<br/>               .hostname("localhost:8443")<br/>               .basePath("/")<br/>               .and()<br/>               .identityProvider()<br/>               .metadataFilePath(metadataUrl)<br/>               .and();<br/>   }<br/>}</pre>
<p>The file does not have to be modified in any way. It's good to go, through the all-important <kbd>configure</kbd> method. In <kbd>spring-security-saml-dsl-core</kbd><em>,</em><span> </span>the introduction of the <kbd>saml()</kbd><span> </span>method makes coding very concise and easy. With this, you are almost done, and the final step is to create the keystore.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The resources folder setup</h1>
                </header>
            
            <article>
                
<p>Navigate to your project (in the <kbd>src/main/resources</kbd><span> </span>folder). Create a folder named <kbd>saml</kbd> and open the Command Prompt in that location. Execute the following command:</p>
<pre><strong>keytool -genkey -v -keystore keystore.jks -alias spring -keyalg RSA -keysize 2048 -validity 10000</strong></pre>
<p>When prompted, give the required details and create the <kbd>keystore.jks</kbd> file within the<span> </span><kbd>src/main/resources/saml</kbd><span> </span>folder.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Running and testing the application</h1>
                </header>
            
            <article>
                
<p>Navigate to your project folder and execute the <kbd>spring-boot</kbd> command, as follows:</p>
<pre><strong>mvn spring-boot:run</strong></pre>
<p>Open a browser and navigate to<span> </span><kbd>https://localhost:8443</kbd>. Please note the <kbd>https</kbd> and the port <kbd>8443</kbd> (because we have SSL enabled). If you don't put <kbd>https</kbd> in your URL, you will get the following response:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/32f0d565-8822-427e-aa59-94cfdb1a78e2.png" style="width:29.17em;height:6.25em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 1: Browser response when HTTP is used</div>
<p>The browser will show a page stating that <span class="packt_screen">Your connection is not secure</span>. The message may vary, depending on the browser that you choose to open this URL. Just make sure that you accept the risks and move forward.</p>
<p class="mce-root"/>
<p>You will be navigated to the Okta URL, asking you to log in using your username/password, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5cbcd28e-98e5-4493-b215-6b50f319b8be.png" style="width:32.50em;height:40.08em;"/></p>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref">Figure 2: Okta login page shown to the user</div>
<p>Once it's done, you will be navigated back to the home page, showing what you have put in your<span> </span><kbd>home.jsp</kbd><span> </span>file. The next time you open the URL, you will be taken directly to the home page, and Okta will automatically sign you in.</p>
<p>This completes SAML authentication using Spring Security. You can see the full project by accessing the GitHub page and navigating to the<span> </span><kbd>spring-boot-in-memory-saml2-authentication</kbd><span> </span>project.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Lightweight Directory Access Protocol</h1>
                </header>
            
            <article>
                
<p class="mce-root CDPAlignLeft CDPAlign"><strong>Lightweight Directory Access Protocol</strong> (<strong>LDAP</strong>) is a directory service protocol that allows for connecting, searching, and modifying internet directories. Unfortunately, LDAP doesn't support reactive bindings; this means that reactive programming is not possible (similar to JDBC) with it. The function of LDAP authentication is shown in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/dec705b0-20da-458d-90c8-b03d1bfc945f.png" style="width:26.42em;height:20.42em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 3: LDAP authentication</div>
<p>Similar to the previous example, we will clone/copy the previous project (any Spring Boot project will do; I am cloning the<span> </span><kbd>spring-boot-in-memory-saml2-authentication</kbd><span> </span>project). Again, similar to the previous project, we will modify a couple of files and add a few more files to the project. We will use the built-in Java-based LDAP server to validate the user credentials.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Set up dependencies in the pom.xml file</h1>
                </header>
            
            <article>
                
<p>Open <kbd>pom.xml</kbd> and add the following dependencies:</p>
<pre>&lt;!-- LDAP --&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br/>   &lt;artifactId&gt;spring-tx&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;org.springframework.ldap&lt;/groupId&gt;<br/>   &lt;artifactId&gt;spring-ldap-core&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;<br/>   &lt;artifactId&gt;spring-security-ldap&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;com.unboundid&lt;/groupId&gt;<br/>   &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Spring Security configuration</h1>
                </header>
            
            <article>
                
<p>Modify the<span> </span><kbd>SpringSecurityConfiguration.java</kbd><span> </span>file, as follows:</p>
<pre>@EnableWebSecurity<br/>@Configuration<br/>@EnableGlobalMethodSecurity(securedEnabled = true)<br/>public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {<br/>   private static final Logger LOG = <br/>                LoggerFactory.getLogger(SpringSecurityConfig.class);<br/>   @Override<br/>   protected void configure(HttpSecurity http) throws Exception {<br/>       http.authorizeRequests()    .antMatchers("/admins").hasRole("ADMINS")<br/>               .antMatchers("/users").hasRole("USERS")<br/>               .anyRequest().fullyAuthenticated()<br/>               .and()<br/>               .httpBasic(); // Use Basic authentication<br/>   }<br/>   @Override<br/>   public void configure(AuthenticationManagerBuilder auth) throws Exception {<br/>       auth<br/>               .ldapAuthentication()<br/>               .userDnPatterns("uid={0},ou=people")<br/>               .userSearchBase("ou=people")<br/>               .userSearchFilter("uid={0}")<br/>               .groupSearchBase("ou=groups")<br/>               .groupSearchFilter("uniqueMember={0}")<br/>               .contextSource(contextSource())<br/>               .passwordCompare()<br/>               .passwordAttribute("userPassword");<br/>   }<br/>   @Bean<br/>   public DefaultSpringSecurityContextSource contextSource() {<br/>       LOG.info("Inside configuring embedded LDAP server");<br/>       DefaultSpringSecurityContextSource contextSource = new <br/>               DefaultSpringSecurityContextSource(<br/>               Arrays.asList("ldap://localhost:8389/"), "dc=packtpub,dc=com");<br/>       contextSource.afterPropertiesSet();<br/>       return contextSource;<br/>   }<br/>}</pre>
<p>The first <kbd>configure</kbd> method is very similar to what we saw in the previous SAML example. We have just added certain matches and separated the roles. With these changes, it will still perform basic authentication.</p>
<p>The second <kbd>configure</kbd> method is where we have set up authentication using the LDAP server. The LDAP server stores user information in a directory-like format. This method details how to find the user by navigating through the directory structure.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">LDAP server setup</h1>
                </header>
            
            <article>
                
<p>We are going to use Spring's default LDAP server to store our users, and then use this as a user store against which we can authenticate the users in our application. The LDAP configuration is done in our <kbd>application.yml</kbd> file, as follows:</p>
<pre>spring:<br/> ldap:<br/>   # Embedded Spring LDAP<br/>   embedded:<br/>     base-dn: dc=packtpub,dc=com<br/>     credential:<br/>       username: uid=admin<br/>       password: secret<br/>     ldif: classpath:ldap/ldapschema.ldif<br/>     port: 8389<br/>     validation:<br/>       enabled: false<br/> mvc:<br/>   view:<br/>     prefix: /WEB-INF/views/<br/>     suffix: .jsp</pre>
<p>The <kbd>ldap</kbd> section is self-explanatory—we are setting up the embedded LDAP server with various parameters.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up users in the LDAP server</h1>
                </header>
            
            <article>
                
<p>We are going to use the <strong>LDAP Data Interchange Format</strong> (<strong>LDIF</strong>) to set up our users on our LDAP server. The LDIF is a standard text-based representation for LDAP data, and changes to that data (<a href="https://ldap.com/ldif-the-ldap-data-interchange-format/">https://ldap.com/ldif-the-ldap-data-interchange-format/</a>).</p>
<p>In our <kbd>application.yml</kbd> file, we have shown Spring where to look for our LDIF file. The LDIF file is as follows:</p>
<pre>dn: dc=packtpub,dc=com<br/>objectclass: top<br/>objectclass: domain<br/>objectclass: extensibleObject<br/>dc: packtpub<br/><br/>dn: ou=groups,dc=packtpub,dc=com<br/>objectclass: top<br/>objectclass: organizationalUnit<br/>ou: groups<br/><br/>dn: ou=people,dc=packtpub,dc=com<br/>objectclass: top<br/>objectclass: organizationalUnit<br/>ou: people<br/><br/>dn: uid=john,ou=people,dc=packtpub,dc=com<br/>objectclass: top<br/>objectclass: person<br/>objectclass: organizationalPerson<br/>objectclass: inetOrgPerson<br/>cn: Tomcy John<br/>uid: tjohn<br/>userPassword: tjohn@password<br/><br/>dn: cn=admins,ou=groups,dc=packtpub,dc=com<br/>objectclass: top<br/>objectclass: groupOfUniqueNames<br/>cn: admins<br/>ou: admin<br/>uniqueMember: uid=tjohn,ou=people,dc=packtpub,dc=com<br/><br/>dn: cn=users,ou=groups,dc=packtpub,dc=com<br/>objectclass: top<br/>objectclass: groupOfUniqueNames<br/>cn: users<br/>ou: user<br/>uniqueMember: uid=tjohn,ou=people,dc=packtpub,dc=com</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Running the application</h1>
                </header>
            
            <article>
                
<p>There are not many changes in any of the other files within the project. Just like you run any other <kbd>spring-boot</kbd> project, go to the project folder and execute the following command:</p>
<pre><strong>mvn spring-boot:run</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Seeing the application in action on a browser</h1>
                </header>
            
            <article>
                
<p>Open a browser and enter <kbd>http://localhost:8080</kbd>. Enter the username/password as <kbd>tjohn/tjohn@password</kbd> (look for user setup in the <span>LDIF</span> file). You will be taken to <kbd>home.jsp</kbd><span>,</span> where you will see a friendly welcome message, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1a0891d5-48c9-4be9-a798-8d04bb64cd13.png" style="width:34.25em;height:12.50em;"/></p>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref">Figure 4: Message shown in home.jsp page after successful login using LDAP</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">OAuth2 and OpenID Connect</h1>
                </header>
            
            <article>
                
<p><strong>OAuth</strong> is an open standard/specification for achieving authorization. It works over HTTPS, and anyone can implement the specification. The specification works by validating access tokens, and then authorizes devices, APIs, servers, and so on.</p>
<p>Two versions<span>—</span>namely OAuth 1.0 (<a href="https://tools.ietf.org/html/rfc5849">https://tools.ietf.org/html/rfc5849</a>) and OAuth 2.0 (<a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)<span>—</span>exist. These versions are not compatible with each other and cannot work together. We will use version 2.0 and it will be referred to as OAuth 2.0,<span> </span>throughout this book.</p>
<p class="mce-root"/>
<p>SAML, released in 2005, is a good fit for the web browser (still). But with modern web and native applications (mobile devices), SAML required a serious overhaul, and that's when<span> </span>OAuth<span> came in</span>. <strong><span>Single Page Applications</span></strong> (<strong><span>SPAs</span></strong>) and native applications are different from traditional server-side web applications. SPAs do AJAX/XHR calls to the APIs that are exposed on the server and does many other operations on the client (browser). API development has also changed, from heavy SOAP-based web services using XML to lightweight REST over HTTP using JSON.</p>
<p>OAuth<span> </span>also enables you, as a developer, to gain access to minimal user data without having to give away a user's password. It is mainly for accessing the APIs (REST) exposed by an application, and is done by delegating the authorization function.</p>
<p>OAuth supports a variety of application types and decouples authentication from authorization.</p>
<p>In simple terms, this is how<span> </span>OAuth<span> </span>works:</p>
<ol>
<li>The app that wants to access resources requests the user to grant authorization.</li>
<li>If the user authorizes it, the app is given proof for this agreement.</li>
<li>Using this proof, the app goes to the actual server with the APIs and gets a token.</li>
<li>Using this token, the app can now ask for resources (APIs) to which the user has given access, while giving the proof.</li>
</ol>
<p>The preceding steps are depicted in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/03b56df2-a7e5-46f9-8dcb-5967110dc4f1.png" style="width:23.42em;height:19.33em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 5: Functionality of OAuth</div>
<p>OAuth was tweaked in such a way by using an access token, apps can get user information in the form of an API. Facebook Connect (an SSO application that allows users to interact with other web applications using Facebook credentials) used this as a mechanism to expose an endpoint (<kbd>http(s)://&lt;domain&gt;/me</kbd>) that would return minimal user information. This was never clearly there in OAuth specification, and this provoked <strong>Open ID Connect</strong> (<strong>OIDC</strong>), which combined the best parts of OAuth2, Facebook Connect, and SAML 2.0. OIDC brought in a new ID token (<kbd>id_token</kbd>), and also a <kbd>UserInfo</kbd> endpoint that will provide minimal user attributes. Many of the complexities that SAML had, and many of the shortcomings of OAuth2 were addressed by OIDC.</p>
<p>Going deep, into OAuth and OIDC is not in the scope of this book. I am sure that I have given adequate information, using which you can navigate through the rest of this section.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up a project</h1>
                </header>
            
            <article>
                
<p><span>The example code that we are going to create here has a different approach from our earlier samples. Here, we will use <em>Spring Initializr</em> (</span><a href="http://start.spring.io/">http://start.spring.io/</a><span>) to create the base project, and then we will inject the appropriate changes to make it log in with a provider, namely, Google.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Bootstrap Spring project using Spring Initializr</h1>
                </header>
            
            <article>
                
<p>Visit<span> </span><a href="http://start.spring.io/">http://start.spring.io/</a><span> </span>and enter the following details. Make sure that you select the right dependencies:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/af792e37-c364-4482-aad1-c53e326d543a.png" style="width:42.75em;height:19.67em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 6: Spring Initializr setup</div>
<p>Click on the <span class="packt_screen">Generate Project</span> button and download the ZIP file to a folder of your choice. Execute the <kbd>unzip</kbd> command as follows. I am using Macintosh for running all of my sample applications, so I will be using commands, if any, suitable for this platform:</p>
<pre><strong>unzip -a spring-boot-oauth-oidc-authentication.zip</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Inclusion of OAuth libraries in pom.xml</h1>
                </header>
            
            <article>
                
<p>Modify your project's <kbd>pom.xml</kbd> file by adding the following dependencies:</p>
<pre>&lt;!-- Provided --&gt;<br/>&lt;dependency&gt;<br/>  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>  &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;<br/>  &lt;scope&gt;provided&lt;/scope&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>  &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;<br/>  &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt;<br/>  &lt;scope&gt;provided&lt;/scope&gt;<br/>&lt;/dependency&gt;<br/>&lt;!-- OAuth --&gt;<br/>&lt;dependency&gt;<br/>  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>  &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;<br/>  &lt;artifactId&gt;spring-security-oauth2-client&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>  &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;<br/>  &lt;artifactId&gt;spring-security-oauth2-jose&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up provider details in application.properties</h1>
                </header>
            
            <article>
                
<p>If you run the application (<kbd>./mvnw spring-boot:run</kbd>) and then navigate your browser to <kbd>http://localhost:8080</kbd>, you will see a default login page, as follows. The entire magic behind this page is done for you by Spring Boot and Spring Security:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/47a39749-7010-4d48-bb90-2f9134f9b210.png" style="width:27.67em;height:11.00em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 7: Default Spring Boot + Spring Security project created using Spring Initializr</div>
<p>Open the <kbd>application.properties</kbd> file (<kbd>src/main/resources</kbd>) and add the following properties:</p>
<pre>#Google app details<br/>spring.security.oauth2.client.registration.google.client-id=1085570125650-l8j2r88b5i5gbe3vkhtlf8j7u3hvdu78.apps.googleusercontent.com<br/>spring.security.oauth2.client.registration.google.client-secret=MdtcKp-ArG51FeqfAUw4K8Mp<br/>#Facebook app details<br/>spring.security.oauth2.client.registration.facebook.client-id=229630157771581<br/>spring.security.oauth2.client.registration.facebook.client-secret=e37501e8adfc160d6c6c9e3c8cc5fc0b<br/>#Github app details<br/>spring.security.oauth2.client.registration.github.client-id=&lt;your client id&gt;<br/>spring.security.oauth2.client.registration.github.client-secret=&lt;your client secret&gt;<br/>#Spring MVC details<br/>spring.mvc.view.prefix: /WEB-INF/views/<br/>spring.mvc.view.suffix: .jsp</pre>
<p>Here, we declare two properties for each provider. We will be implementing the Google provider, but you can add any number of providers. Just adding these properties will create more magic, and your login page will suddenly change to the following:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4c9c49c6-c86f-4620-8977-6a45458bdd47.png" style="width:31.58em;height:14.17em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 8: OAuth default login page when application.properties file is modified</div>
<p>The providers (links) shown in the preceding screenshot are according to the configurations seen in the <kbd>application.properties</kbd> file. It just looks for two properties, as follows:</p>
<pre>spring.security.oauth2.client.registration.&lt;provider_name&gt;.client-id=&lt;client id&gt;<br/>spring.security.oauth2.client.registration.&lt;provider_name&gt;.client-secret=&lt;client secret&gt;</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Provider setup</h1>
                </header>
            
            <article>
                
<p>We will be using Google as our provider in this example. Navigate to<span> </span><a href="https://console.developers.google.com/">https://console.developers.google.com/</a> and perform the following steps:</p>
<ol>
<li class="mce-root">Create a project. Select an existing project or create a new project, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/05af3299-335b-4037-a1d3-ae4f1a39a803.png" style="width:51.58em;height:16.25em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 9: Project creation</div>
<ol start="2">
<li class="mce-root">Create the credentials. Select the newly created project (in the following screenshot, it is shown next to the <span class="packt_screen">Google APIs</span> <span>logo) and click o</span><span>n the</span> <span class="packt_screen">Credentials</span> <span>link in the side menu, as shown in the following screenshot:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/437a6fcd-1fc2-4ab2-91db-a6ddc5407ed9.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 10: Credential creation - step 1</div>
<ol start="3">
<li>Now, click on the <span class="packt_screen">Create credentials</span> drop-down menu, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5021c119-000c-4880-920e-5a9a60a9f0c2.png" style="width:26.08em;height:23.83em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 11: Credential creation - step 2</div>
<ol start="4">
<li>From the drop-down menu, click on <span class="packt_screen">OAuth client ID</span>. This will navigate you to the page shown in the following screenshot. Please note that the <span class="packt_screen">Application type</span> radio group will be disabled at this stage:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/fd8267bf-d1d0-44c1-91ae-ea081c71d5d8.png" style="width:47.58em;height:17.50em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 12: Credential creation - step 3</div>
<ol start="5">
<li>Click on <span class="packt_screen">Configure consent screen</span>. You will be navigated to the following page:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4854c9b4-75a4-4ce3-82e7-c9240c51ecca.png" style="width:59.08em;height:45.25em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 13: Credential creation - step 4</div>
<ol start="6">
<li>Enter the relevant details (leave the optional fields out while filling in the form), as shown in the preceding figure, and click on the <span class="packt_screen">Save</span> button. You will be navigated back to the page shown in the following figure.</li>
</ol>
<p class="mce-root"/>
<p>This time, the <span class="packt_screen">A<span class="packt_screen">p</span></span><span class="packt_screen">plication type</span> radio group will be enabled:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/40295f09-c3ac-4800-bb37-2d5e26176bed.png" style="width:47.67em;height:50.83em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 14: Credential Creation - step 5</div>
<ol start="7">
<li>Select the <span class="packt_screen">Application type</span> as <span class="packt_screen">Web application</span>, and enter the relevant details, as shown in the preceding figure. Click on the <span class="packt_screen">Create</span> button, and you will be shown the following popup:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/daaf459d-a618-4afa-a0d4-474041312c09.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 15: Credential creation - step 6</div>
<p>You now have your client ID and client secret from Google. Copy and paste these values into the <kbd>application.properties</kbd> file in the correct place.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Default application change</h1>
                </header>
            
            <article>
                
<p>To be in line with the previous example, we will make changes in the default application that was generated, bringing in the same components seen in the previous application. This will help you to understand the application in detail.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The HomeController class</h1>
                </header>
            
            <article>
                
<p>Copy the home controller class (<kbd>HomeController.java</kbd>) that we created in our previous example to a new package. Change the welcome message to whatever you want.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The home.jsp file</h1>
                </header>
            
            <article>
                
<p>Copy the whole <kbd>webapp</kbd> folder from the previous example, as is, into this project. Change the page heading to something different so that it is clear while running the application that it is indeed the sample application.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Spring Boot main application class change</h1>
                </header>
            
            <article>
                
<p>Make your application class extend the <kbd>SpringBootServletInitializer</kbd> class. Add a new annotation, as follows, letting your Spring Boot application know that a new controller, <kbd>HomeController</kbd>, is a component that it has to scan:</p>
<pre>@ComponentScan(basePackageClasses=HomeController.class)</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Running the application</h1>
                </header>
            
            <article>
                
<p>Run your application by executing the following default command:</p>
<pre><strong>./mvnw spring-boot:run</strong></pre>
<p>If all is well, you should be able to click on the Google link, and it should navigate you to the Google's login page. After successfully logging in, you will be redirected to the <kbd>home.jsp</kbd> file, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6236594f-359d-4c81-b716-7c6d1351b929.png" style="width:48.50em;height:12.08em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 16: Login using Google as OAuth provider</div>
<p>The support for OAuth doesn't end here, but we have to stop, as the book cannot delve deeply into the many aspects that the framework provides.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we saw authentication mechanisms <span>commonly used</span> in the enterprises, namely SAML, LDAP, and OAuth/OIDC, supported by Spring Security through hands-on coding examples. We used the sample application built as part of <a href="e43a2e26-5b28-4d37-a7f8-d3c992a07bc2.xhtml" target="_blank">Chapter 2</a>, <em>Deep Diving into Spring Security</em>, as a basis for explaining the functionality and implementation of other authentication mechanisms.</p>
<p>However, we <span>intentionally </span><span>didn't reactive programming in our coding examples. This chapter was aimed at making you understand the core concepts of each of the authentication mechanisms, by making use of the familiar Spring Web MVC application framework. We will cover reactive programming in more detail in</span> <a href="df488f9c-24a7-4d0f-ac82-1d126a391fcc.xhtml" target="_blank">Chapter 5</a>, <em>Integrating with Spring WebFlux</em><a href="df488f9c-24a7-4d0f-ac82-1d126a391fcc.xhtml" target="_blank"/>.</p>


            </article>

            
        </section>
    </body></html>