<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Taking Our Game to the Next Level"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Taking Our Game to the Next Level</h1></div></div></div><p>In this chapter, we'll cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a muzzle flash using ParticleEmitter</li><li class="listitem" style="list-style-type: disc">Creating a trigger system</li><li class="listitem" style="list-style-type: disc">Creating a timer trigger</li><li class="listitem" style="list-style-type: disc">Adding an interaction trigger</li><li class="listitem" style="list-style-type: disc">Controlling AI with triggers</li><li class="listitem" style="list-style-type: disc">Creating a dynamic skybox with a moving sun</li><li class="listitem" style="list-style-type: disc">Improving a scene with postprocessing filters</li><li class="listitem" style="list-style-type: disc">Performing complex movements with MotionPaths</li><li class="listitem" style="list-style-type: disc">Cutscenes using cinematics</li><li class="listitem" style="list-style-type: disc">Using a positional audio and environmental effects</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec88"/>Introduction</h1></div></div></div><p>So the core mechanics are in and the game is playable, yet it still feels like the game lacks something. In this chapter, we will explore different methods to enhance games and fuse together some of the recipes from other chapters.</p></div></div>
<div class="section" title="Creating a muzzle flash using ParticleEmitter"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec89"/>Creating a muzzle flash using ParticleEmitter</h1></div></div></div><p>Weapons<a id="id612" class="indexterm"/> of some sort are a common <a id="id613" class="indexterm"/>feature of many games and muzzle flashes greatly enhance the appearance and feeling when you fire. This recipe will show a way to create good-looking muzzle flashes by tweaking a ParticleEmitter's properties. The following screenshot shows a texture with four muzzle flashes:</p><div class="mediaobject"><img src="graphics/6478OS_09_01.jpg" alt="Creating a muzzle flash using ParticleEmitter"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec216"/>Getting ready</h2></div></div></div><p>There <a id="id614" class="indexterm"/>are two things needed before we can <a id="id615" class="indexterm"/>begin work on the ParticleEmitter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First of all we need a texture for the muzzle flash. This can have anything from one to several images of muzzle flashes. The texture should be gray scaled. We'll add color using <code class="literal">ParticleEmitter</code>.</li><li class="listitem" style="list-style-type: disc">Secondly, we need to create a <code class="literal">Material</code> using the texture by performing the following steps:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Right-click on your project's material folder and select <span class="strong"><strong>New.../Empty Material file</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Particle.j3md</strong></span> as <span class="strong"><strong>Material Definition</strong></span>.</li><li class="listitem">Then select the muzzle flash texture as <span class="strong"><strong>Texture</strong></span>.</li></ol></div></li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec217"/>How to do it...</h2></div></div></div><p>Now, we can<a id="id616" class="indexterm"/> begin creating the muzzle flash emitter:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Emitters</strong></span> folder in the project and select <span class="strong"><strong>New.../Empty jme3 Scene</strong></span>. We should now have a fresh scene.</li><li class="listitem">Right-click on the main node in the <span class="strong"><strong>SceneExplorer</strong></span> window and select <span class="strong"><strong>Add Spatial/Particle Emitter</strong></span>.</li><li class="listitem">Select the emitter instance and open the <span class="strong"><strong>Properties</strong></span> window.</li><li class="listitem">Make sure the <span class="strong"><strong>Shadow Mode</strong></span> option is <span class="strong"><strong>Off</strong></span> and <span class="strong"><strong>Queue Bucket</strong></span> is <span class="strong"><strong>Transparent</strong></span>.</li><li class="listitem">Then, select the muzzle flash material we created in the <span class="strong"><strong>Geometry/Material</strong></span> section.</li><li class="listitem">Make <a id="id617" class="indexterm"/>the<a id="id618" class="indexterm"/> <span class="strong"><strong>Emitter</strong></span> shape really small, for example, something like <code class="literal">[Sphere, 0.0, 0.0, 0.0, 0.05]</code>.</li><li class="listitem"><span class="strong"><strong>Num Particles</strong></span> should be <code class="literal">1</code>, and <span class="strong"><strong>Particles Per Sec</strong></span> should be <code class="literal">0.0</code>.</li><li class="listitem">Set <span class="strong"><strong>Start Color</strong></span> to something like <code class="literal">[1.0, 1.0, 0.4, 1.0]</code> and <span class="strong"><strong>End Color</strong></span> to <code class="literal">[1.0, 0.6, 0.2, 0.7]</code>.</li><li class="listitem">Both <span class="strong"><strong>Start Size</strong></span> and <span class="strong"><strong>End Size</strong></span> should be <code class="literal">1.0</code>.</li><li class="listitem"><span class="strong"><strong>High Life</strong></span> and <span class="strong"><strong>Low Life</strong></span> should be <code class="literal">0.15</code>.</li><li class="listitem"><span class="strong"><strong>Gravity</strong></span> and <span class="strong"><strong>Face Normal</strong></span> should be <code class="literal">[0.0, 0.0, 0.0]</code>.</li><li class="listitem">Check the <span class="strong"><strong>Facing Velocity</strong></span> box and set the <span class="strong"><strong>Initial Velocity</strong></span> to<code class="literal">[0.0, 0.0, 1.0]</code>.</li><li class="listitem"><span class="strong"><strong>Images X</strong></span> and <span class="strong"><strong>Images Y</strong></span> should reflect the number of frames in the texture we created.</li><li class="listitem">We can now test the emitter by clicking on the <span class="strong"><strong>Emit!</strong></span> button.</li></ol></div><p>All these values can be seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/6478OS_09_02.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec218"/>How it works...</h2></div></div></div><p>The muzzle <a id="id619" class="indexterm"/>flash works pretty much<a id="id620" class="indexterm"/> like a normal ParticleEmitter with a couple of exceptions. Instead of outputting a constant stream of particles, it will only emit one. This is because <span class="strong"><strong>Num Particles</strong></span> is set to <code class="literal">1</code>, meaning only one particle can be alive at any given time. <span class="strong"><strong>Particles Per Sec</strong></span> is <code class="literal">0.0</code> so it won't continuously emit anything.</p><p>The colors are set to be yellowish, turning a bit orange and fading slightly at the end of the lifetime; the lifetime being very short in this case, only 0.15 seconds.</p><p>A muzzle flash is emitted in one direction only. This is why we set <span class="strong"><strong>Facing Velocity</strong></span> to <code class="literal">true</code> so that the particle will point in the direction of the velocity.</p><p>Getting it to appear in the correct position in relation to the weapon can require a bit of tweaking. Using <span class="strong"><strong>Local Translation</strong></span> can help us in this.</p><p>To use the muzzle flash on a weapon, open the target in <span class="strong"><strong>Scene Composer</strong></span> and then choose <span class="strong"><strong>Link in Scene</strong></span> on the muzzle flash. This way the original file can be modified and the changes will automatically appear in the places its being used.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec219"/>There's more...</h2></div></div></div><p>Now<a id="id621" class="indexterm"/> that we have the muzzle flash and <a id="id622" class="indexterm"/>added it to a weapon, we can create a control in order to use it within the game by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new class called <code class="literal">WeaponControl</code> extending <code class="literal">AbstractControl</code>.</li><li class="listitem">Add a <code class="literal">ParticleEmitter</code> field called <code class="literal">muzzleFlash</code>.</li><li class="listitem">In the <code class="literal">setSpatial</code> method, check whether the supplied spatial has a suitable child, either by type or name (requires that the muzzle flash has a fixed name), and set the <code class="literal">muzzleFlash</code> field:<div class="informalexample"><pre class="programlisting">muzzleFlash = (ParticleEmitter) ((Node)spatial).getChild("MuzzleFlash");</pre></div></li><li class="listitem">Now, we create a publicly available <code class="literal">onFire</code> method and add the following:<div class="informalexample"><pre class="programlisting">if(muzzleFlash != null){
  muzzleFlash.emitAllParticles();
}</pre></div></li></ol></div><p>This control should then be added to the weapon spatial inside the game and <code class="literal">onFire</code> should be called whenever the weapon fires. The class is suitable to play sounds and keeps track of ammunition as well.</p></div></div>
<div class="section" title="Creating a trigger system"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec90"/>Creating a trigger system</h1></div></div></div><p>Almost all <a id="id623" class="indexterm"/>story-driven games require some kind of system to trigger some sort of event for example, dialogs, enemies, or doors opening. Unless the game is very small, you generally don't want to hardcode these. The following recipe will describe a trigger system, which can be used for almost any type of game from FPSs to RTSs and RPGs.</p><p>We'll start out by laying the ground work with an AppState controlling all the script objects and the basic functionality of a <code class="literal">Trigger</code> class. Then, we'll look into how to actually activate the trigger and use it for something.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec220"/>Getting ready</h2></div></div></div><p>Before we start with the actual implementation, we create a small interface that we will use for various scripting scenarios. We call it <code class="literal">ScriptObject</code> and it should have the following three methods:</p><div class="informalexample"><pre class="programlisting">void update(float tpf);
void trigger();
voidonTrigger();</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec221"/>How to do it...</h2></div></div></div><p>Now, we <a id="id624" class="indexterm"/>can implement the <code class="literal">ScriptObject</code> in a class called <code class="literal">Trigger</code>. This will have six steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following fields to the <code class="literal">Trigger</code> class:<div class="informalexample"><pre class="programlisting">private boolean enabled;
private float delay;
private boolean triggered;
private float timer;
private HashMap&lt;String, ScriptObject&gt; targets;</pre></div></li><li class="listitem">The <code class="literal">enabled</code> and <code class="literal">delay</code> fields should have getters and setters and <code class="literal">targets</code> should have a <code class="literal">addTarget</code> and <code class="literal">removeTarget</code> method publically available.</li><li class="listitem">In the <code class="literal">trigger</code> method, we add the following functionality:<div class="informalexample"><pre class="programlisting">If enabled is false it shouldn't do anything.
Otherwise timer should be set to 0 and triggered to true.</pre></div></li><li class="listitem">If the script is enabled in the <code class="literal">update</code> method, we should perform the following steps:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If <code class="literal">triggered</code> is <code class="literal">true</code> and delay is more than 0, the timer should be increased by tpf.</li><li class="listitem">Then if the timer is more than or equal to delay, it should call <code class="literal">onTrigger()</code>.</li></ol></div></li><li class="listitem">If delay is 0 and <code class="literal">triggered</code> is <code class="literal">true</code>, the timer should also call <code class="literal">onTrigger()</code>.</li><li class="listitem">In the <code class="literal">onTrigger</code> method, we should parse through all the values of <code class="literal">targetsMap</code> and call the trigger on them. Then <code class="literal">triggered</code> should be set to <code class="literal">false</code>.</li></ol></div><p>Now, perform the following set of steps to control the <code class="literal">Trigger</code> class.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We define a new class called <code class="literal">ScriptAppState</code>, which extends <code class="literal">AbstractAppState</code>.</li><li class="listitem">It should have a <code class="literal">List&lt;ScriptObject&gt;</code> called <code class="literal">scriptObjects</code>, together with methods to add and remove ScriptObjects from <code class="literal">List</code>.</li><li class="listitem">In the <code class="literal">update</code> method, if <code class="literal">isEnabled()</code> is <code class="literal">true</code>, it should parse <code class="literal">scriptObjects</code> and call an update on all of the ScriptObjects.</li></ol></div><p>Now, we<a id="id625" class="indexterm"/> have a flexible system where one <code class="literal">ScriptObject</code> can trigger another. We're still lacking input and output effects though. One common way to trigger events is when a player enters an area. So let's go ahead and add that functionality by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new class called <code class="literal">EnterableTrigger</code>, which extends <code class="literal">Trigger</code>.</li><li class="listitem">This trigger needs a <code class="literal">Vector3f</code> field called <code class="literal">position</code> to define its place in the physical world along with a getter and setter.</li><li class="listitem">Add a <code class="literal">BoundingVolume</code> field called <code class="literal">volume</code>. In the <code class="literal">setter</code> method for this, we should call <code class="literal">volume.setCenter(position)</code>.</li><li class="listitem">Also, it needs a <code class="literal">List&lt;Spatial&gt;</code> called <code class="literal">actors</code> along with <code class="literal">add</code> and <code class="literal">remove</code> methods.</li><li class="listitem">Now, we should override the <code class="literal">update</code> method and then call the trigger if any item in the <code class="literal">actors</code> list is inside <code class="literal">volume</code>:<div class="informalexample"><pre class="programlisting">if(isEnabled() &amp;&amp; volume != null &amp;&amp; actors != null){
  for(int i = 0; i&lt;actors.size(); i++ ){
    Spatial n = actors.get(i);
    if(volume.contains(n.getWorldTranslation())){
      trigger();
    }
  }
}</pre></div></li><li class="listitem">We've taken care of the triggering now. Let's actually do something with that trigger by creating a new class called <code class="literal">SpawnTarget</code>, implementing <code class="literal">ScriptObject</code>.</li><li class="listitem">Like the <code class="literal">EnterableTrigger</code> class, the <code class="literal">SpawnTarget</code> class needs a <code class="literal">position</code> field and also a <code class="literal">Quaternion</code> field called <code class="literal">rotation</code>.</li><li class="listitem">The <code class="literal">SpawnTarget</code> class also requires a <code class="literal">Spatial</code> field called <code class="literal">target</code> and a Boolean field called <code class="literal">triggered</code> to know whether it's been triggered yet or not.</li><li class="listitem">We should also add a <code class="literal">Node</code> field called <code class="literal">sceneNode</code> to attach the target to.</li><li class="listitem">In the <code class="literal">trigger</code> method, we should check whether it has been triggered already. If not, we should set <code class="literal">triggered</code> to <code class="literal">true</code> and call <code class="literal">onTrigger</code>.</li><li class="listitem">The <code class="literal">onTrigger</code> method should apply the position and rotation to the target and attach it to the <code class="literal">sceneNode</code>. Depending on the implementation, we might want to subtract the <code class="literal">worldTranslation</code> and <code class="literal">worldRotation</code> values from the values we apply:<div class="informalexample"><pre class="programlisting">target.setLocalTranslation(position);
target.setLocalRotation(rotation);
sceneNode.attachChild(target);</pre></div></li></ol></div><p>Let's have a <a id="id626" class="indexterm"/>look at another common game object that can be picked up. In many games, characters can pick up various power-up weapons or other items simply by walking over them. This section will have the following eight steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We create a new class called <code class="literal">Pickup</code> extending <code class="literal">Trigger</code>.</li><li class="listitem">Like <code class="literal">EnterableTrigger</code>, the <code class="literal">Pickup</code> class needs a position and a <code class="literal">List&lt;Spatial&gt;</code> called <code class="literal">actors</code>. We also need to add a <code class="literal">Spatial</code> field called <code class="literal">triggeringActor</code> and a float called <code class="literal">triggeringDistance</code>.</li><li class="listitem">For this class, we also need something to pick up, represented here by an interface called <code class="literal">Pickupable</code>. In addition, we need to keep track of whether it's been picked up by a Boolean called <code class="literal">pickedUp</code>.</li><li class="listitem">The difference between the previous ScriptObjects we've worked with and the current ScriptObjects is that the one in this recipe should be visible in the world, represented by a <code class="literal">Spatial</code> called <code class="literal">model</code>.</li><li class="listitem">In the <code class="literal">update</code> method, we should check whether the <code class="literal">Pickup</code> object is enabled and not <code class="literal">pickedUp</code>.</li><li class="listitem">To make it stand out a bit in the game world, we rotate the model a little bit by applying the <code class="literal">model.rotate(0, 0.05f, 0)</code> value.</li><li class="listitem">Still inside the <code class="literal">if</code> clause, we check that <code class="literal">actors</code> is not null and parse through the list. If any of the actors is inside the radius of the <code class="literal">triggerDistance</code>, we set it to be <code class="literal">triggeringActor</code> and call the <code class="literal">trigger</code> method:<div class="informalexample"><pre class="programlisting">for(int i = 0; i&lt;actors.size(); i++ ){

  Spatial actor = actors.get(i);
  if((actor.getWorldTranslation().distance(position) &lt;triggerDistance)){
    triggeringActor = actor;
    trigger();
  }
}</pre></div></li><li class="listitem">Finally, in the <code class="literal">onTrigger</code> method, we should set <code class="literal">pickedUp</code> to <code class="literal">true</code>, detach <code class="literal">model</code> from scene graph and call <code class="literal">pickupObject.apply(triggeringActor)</code> to have it apply whatever the <code class="literal">Pickupable</code> object is supposed to do.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec222"/>How it works...</h2></div></div></div><p>The <code class="literal">Trigger</code> class has a fairly simple functionality. It will wait for something to call its <code class="literal">trigger</code> method.</p><p>When<a id="id627" class="indexterm"/> this happens, it will either trigger all the connected ScriptObjects immediately or if a delay is set, it will start counting until the time has passed and then execute the trigger. Once this is done, it will be set up so it can be triggered again.</p><p>The <code class="literal">ScriptAppState</code> state is a convenient way to control the scripts. Since the <code class="literal">AppState</code> is either disabled or not attached to the <code class="literal">stateManager</code>, no call to <code class="literal">update</code> in <code class="literal">ScripObjects</code> is made. This way, we can easily disable all the scripting if we want to.</p><p>To create a working example with <code class="literal">Trigger</code>, we extended it into a class called <code class="literal">EnterableTrigger</code>. The idea with the <code class="literal">EnterableTrigger</code> class was that if any of the supplied actor spatials enter its <code class="literal">BoundingVolume</code> instance, then it should trigger whatever is connected to it.</p><p>The basic <code class="literal">Trigger</code> method doesn't have the need for a position as it is a purely logical object. The <code class="literal">EnterableTrigger</code> object, however, has to have a relation to the physical space as it needs to know when one of the actors has entered its <code class="literal">BoundingVolume</code> instance.</p><p>This is true for <code class="literal">SpawnTarget</code> as well, which in addition to a location should have a rotation, to rotate a potential enemy in a certain direction. Spawning characters or items in games is commonly used to control the gameplay flow and save some performance. The <code class="literal">SpawnTarget</code> option <a id="id628" class="indexterm"/>allows this kind of control by adding new spatials only when triggered.</p><p>The strategy for how to perform spawning might differ depending on the implementation but the way described here assumes it involves attaching the target <code class="literal">Spatial</code> to the main node tree, which would generally activate its update method and controls.</p><p>Likewise, the <code class="literal">rootNode</code> of the scene graph is not necessarily the best choice to attach the target to and depends a lot on the game architecture. It could be any <code class="literal">Spatial</code>.</p><p>Lastly, in this recipe, we created a <code class="literal">Pickup</code> object, which is very common in many games. These can be anything from items that increase health instantly or weapons or other equipment that are added to an inventory. In many cases, it's similar to the <code class="literal">EnterableTrigger</code> except it only requires a radius to see whether someone is within the pickup range or not. We keep track of the actor that enters it so that we know who to apply the pickup to. In this recipe, the pickup is represented by an object called <code class="literal">Pickupable</code>.</p><p>Once it's picked<a id="id629" class="indexterm"/> up, we set <code class="literal">pickedUp</code> to <code class="literal">true</code> so that it can't be picked up again and detach the model from the node tree to make it disappear. If it is a recurring power up, a delay can be used here to make it available again after some time.</p><p>Pickups in games usually stand out from other objects in the game world to draw attention to them. How this is done depends on the game style, but here we apply a small rotation to it in each call to the <code class="literal">update</code> method.</p><p>Since <code class="literal">Pickup</code> also extends <code class="literal">Trigger</code>, it's possible to use it to trigger other things as well!</p></div></div>
<div class="section" title="Creating a timer trigger"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec91"/>Creating a timer trigger</h1></div></div></div><p>In the <span class="emphasis"><em>Creating a trigger system</em></span> recipe, we laid the foundation for a <code class="literal">Trigger</code> system as well as created some basic implementations. A timer can be very useful when creating complex scripts that rely on timing or sequenced events. Not only does it do the obvious (trigger the blast of the door and then the soldiers running through) but it can also work as a relay trigger in case many things should be triggered at the same time. In this recipe, we'll create <a id="id630" class="indexterm"/>this <code class="literal">Timer</code> object as well as an actual implementation<a id="id631" class="indexterm"/> of it where it triggers an explosion with several components. To save some time, we'll use the <code class="literal">TestExplosion</code> test from jMonkeyEngine to get <code class="literal">ParticleEmitters</code> set up and the timing for free. We'll also create a new <code class="literal">ScriptObject</code> called <code class="literal">PlayEffect</code>, which controls the particle emitters.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec223"/>How to do it...</h2></div></div></div><p>To be able to control a <code class="literal">ParticleEmitter</code> object from our script system, we need a new class to handle the <code class="literal">ParticleEmitter</code> object:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start by creating a new class called <code class="literal">PlayEffect</code>, which implements <code class="literal">ScriptObject</code>.</li><li class="listitem">The <code class="literal">PlayEffect</code> class needs a Boolean called <code class="literal">emitAllParticles</code>, a <code class="literal">ParticleEmitter</code> field called <code class="literal">effect</code>, and a Boolean to control whether it's enabled or not (default it to <code class="literal">true</code>).</li><li class="listitem">The <code class="literal">trigger</code> method should call <code class="literal">onTrigger</code> if the object is enabled.</li><li class="listitem">The <code class="literal">onTrigger</code> method should enable <code class="literal">effect</code> and if <code class="literal">emitAllParticles</code> is <code class="literal">true</code>, it should call <code class="literal">emitter.emitAllParticles()</code>.</li></ol></div><p>Apart from the setter methods, this is all that's needed for the <code class="literal">PlayEffect</code> class. Now, we can look at the <code class="literal">Timer</code> class by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We create a new class called <code class="literal">Timer</code>, which implements <code class="literal">ScriptObject</code>.</li><li class="listitem">It will use a simple callback interface to keep track of events:<div class="informalexample"><pre class="programlisting">public interface TimerEvent{
  public Object[] call();
}</pre></div></li><li class="listitem">It needs two Boolean fields. One called <code class="literal">enabled</code> and another called <code class="literal">running</code>. It also needs to keep track of time with three floats called <code class="literal">time</code>, <code class="literal">lastTime</code>, and <code class="literal">maxTime</code>.</li><li class="listitem">Finally, we <a id="id632" class="indexterm"/>will store the events in <code class="literal">HashMap&lt;Float, TimerEvent&gt;</code>.</li><li class="listitem">We need <a id="id633" class="indexterm"/>a method to add events to the timer. Call it <code class="literal">addTimerEvent</code> and add inputs for <code class="literal">time</code> in seconds to execute the event, as well as a <code class="literal">TimerEvent</code> object with the code to execute it. After <code class="literal">TimerEvent</code> is placed in the <code class="literal">timerEvents</code> map, we check whether the supplied <code class="literal">time</code> value is higher than the current <code class="literal">maxTime</code> and set <code class="literal">maxTime</code> to <code class="literal">time</code> if true, as shown in the following code:<div class="informalexample"><pre class="programlisting">public void addTimerEvent(float time, TimerEvent callback){
  timerEvents.put(time, callback);
  if(time &gt;maxTime ){
    maxTime = time;
  }
}</pre></div></li><li class="listitem">The <code class="literal">trigger</code> method should call <code class="literal">onTrigger</code>, if it is enabled.</li><li class="listitem">The <code class="literal">onTrigger</code> method should set time to <code class="literal">0</code> and set <code class="literal">running</code> to <code class="literal">true</code>.</li><li class="listitem">The <code class="literal">update</code> method should first check whether the <code class="literal">Timer</code> is <code class="literal">enabled</code> and <code class="literal">running</code>.</li><li class="listitem">If it is, tpf should be added to the time.</li><li class="listitem">Inside the <code class="literal">same</code> statement, we then create an iterator based on <code class="literal">keySet</code> of <code class="literal">timerEvents</code> and parse through it. If the key (a float) is more than <code class="literal">lastTime</code> and less or equal to the current time, we should get the corresponding value from the <code class="literal">timerEvents</code> map and execute it. Otherwise, if the key is less than <code class="literal">lastTime</code>, we should just continue using the following code:<div class="informalexample"><pre class="programlisting">Iterator&lt;Float&gt; it = timerEvents.keySet().iterator();
while(it.hasNext()){
  float t = it.next();
  if(t &gt;lastTime&amp;&amp; t &lt;= time){
    TimerEvent event = timerEvents.get(t);
    if(event != null){
      event.call();
    }
  } else if(t &lt;lastTime){
    continue;
  }
}</pre></div></li><li class="listitem">Outside of the previous loop, we check if <code class="literal">time</code> is more than <code class="literal">maxTime</code>, in which case, we should set <code class="literal">running</code> to <code class="literal">false</code>.</li><li class="listitem">Finally in the <code class="literal">update</code> method, we set <code class="literal">lastTime</code> to be equal to <code class="literal">time</code>.</li></ol></div><p>With the <a id="id634" class="indexterm"/>basic logic done, let's take a look at how we can use the timer for <a id="id635" class="indexterm"/>something real and use it to trigger an explosion by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">TestExplosion</code> class from jMonkeyEngine's test package and strip it from everything except the methods that create <code class="literal">ParticleEmitters</code> and the lines in <code class="literal">simpleInitApp</code>, which uses them and sets up the camera.</li><li class="listitem">Then, create a <code class="literal">PlayEffect</code> instance for each of <code class="literal">ParticleEmitters</code> and set the effect accordingly with <code class="literal">emitAllParticles</code> set to <code class="literal">true</code>.</li><li class="listitem">Create a new <code class="literal">Timer</code> instance called <code class="literal">explosionTimer</code>.</li><li class="listitem">Add a new <code class="literal">TimerEvent</code> at time 0 where it triggers the <code class="literal">flash</code>, <code class="literal">spark</code>, <code class="literal">smoke</code>, <code class="literal">debris</code>, and <code class="literal">shockwave</code> effects, by calling <code class="literal">trigger()</code> on each of the <code class="literal">PlayEffects</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">explosionTimer.addTimerEvent(0, new Timer.TimerEvent() {

  public Object[] call() {
    flashEffect.trigger();
    sparkEffect.trigger();
    ...
    return null;
  }
});</pre></div></li><li class="listitem">Then, add another <code class="literal">TimerEvent</code> at time <code class="literal">0.05f</code>, which triggers the <code class="literal">flame</code> and <code class="literal">roundSpark</code> effects.</li><li class="listitem">The last <code class="literal">TimerEvent</code> should happen at time <code class="literal">5f</code> and should call <code class="literal">stop()</code> on all of the effects.</li><li class="listitem">Finally, we create a <code class="literal">ScriptAppState</code> instance to which we add <code class="literal">explosionTimer</code> and then add it to <code class="literal">stateManager</code> using the following code:<div class="informalexample"><pre class="programlisting">ScriptAppStateappState = new ScriptAppState();
stateManager.attach(appState);
appState.addScriptObject(explosionTimer);</pre></div></li><li class="listitem">Now, we can trigger <code class="literal">explosionTimer</code>. It should perform the explosion in the same way as <code class="literal">TestExplosion</code> does.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec224"/>How it works...</h2></div></div></div><p>Once<a id="id636" class="indexterm"/> triggered, <code class="literal">Timer</code> works by checking the time that has passed <a id="id637" class="indexterm"/>since it was started (<code class="literal">time</code>). It then checks each of the events in the <code class="literal">timerEvents</code> map to see whether their execution time is anywhere between the current time and the last time (<code class="literal">lastTime</code>). The <code class="literal">maxTime</code> option is used by<a id="id638" class="indexterm"/> the <code class="literal">Timer</code> to know when it has executed the last of its events and can switch itself off. If the <code class="literal">Timer</code> was only meant to be used once, the events can simply be removed from the <code class="literal">timerEvent</code> map. This way it can be reused.</p><p>The <code class="literal">PlayEffect</code> instance has a fairly simple functionality to turn it on and off. Since <code class="literal">ParticleEmitters</code> can be used in two ways, fire all their particles at once, or emit a continuous stream of particles, it needs to know which way to fire it.</p><p>In the example application, we create <code class="literal">ScriptAppState</code> since it's needed to update the <code class="literal">Timer</code> with the passed time. We don't need to add the <code class="literal">PlayEffect</code> instances since they don't use the <code class="literal">update</code> method.</p></div></div>
<div class="section" title="Adding an interaction trigger"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec92"/>Adding an interaction trigger</h1></div></div></div><p>Another <a id="id639" class="indexterm"/>common trigger is the one where an action from the player is required. For example, you can use it to open a door, or access an in-game store system or dialog.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec225"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We begin by creating a new class called <code class="literal">InteractionTrigger</code>, which extends <code class="literal">Trigger</code> and also implements <code class="literal">ActionListener</code>.</li><li class="listitem">The <code class="literal">InteractionTrigger</code> class needs a <code class="literal">Vector3f</code> field called position, a <code class="literal">BoundingVolume</code> field called <code class="literal">volume</code>, a <code class="literal">Spatial</code> field called <code class="literal">player</code>, and a <code class="literal">boolean</code> field called <code class="literal">inside</code>.</li><li class="listitem">Furthermore, the <code class="literal">InteractionTrigger</code> class needs access to the application's <code class="literal">guiNode</code>, which we store in a <code class="literal">Node</code> field with the same name and a <code class="literal">BitmapText</code> field called <code class="literal">interactionPrompt</code>. The text will be displayed when interaction is possible.</li><li class="listitem"> We also <a id="id640" class="indexterm"/>have to define a static string called <code class="literal">INTERACTION_KEY =  "Interact"</code> either in this class or the <code class="literal">input manager</code> class</li><li class="listitem">The <code class="literal">update</code> method will <a id="id641" class="indexterm"/>check whether the player is inside <code class="literal">BoundingVolume</code>. If it is and <code class="literal">inside</code> is <code class="literal">false</code>, it will show <code class="literal">interactionPrompt</code>. On the other hand, if <code class="literal">inside</code> is <code class="literal">true</code> and the player is not inside <code class="literal">BoundingVolume</code>, it will remove it, as shown in the following code:<div class="informalexample"><pre class="programlisting">Boolean contains = volume.contains(player.getWorldTranslation());
if(!inside &amp;&amp; contains){
  guiNode.attachChild(interactionPrompt);
} else if (inside &amp;&amp; !contains){guiNode.detachChild(interactionPrompt);
}
inside = contains;</pre></div></li><li class="listitem">In the implemented <code class="literal">onAction</code> method, we check for when the key corresponding to <code class="literal">INTERACTION_KEY</code> is released. Then, we see whether the trigger is enabled and whether <code class="literal">inside</code> is <code class="literal">true</code> or not. If both are <code class="literal">true</code>, we call <code class="literal">trigger()</code>.</li><li class="listitem">Some logic outside the class is required to get the trigger to work. Apart from supplying <code class="literal">guiNode</code> and <code class="literal">BitmapText</code> to the trigger, the <code class="literal">INTERACTION_KEY</code> needs to be bound to <code class="literal">inputManager</code>. This can be done with the following line:<div class="informalexample"><pre class="programlisting">inputManager.addMapping(INTERACTION_KEY, new KeyTrigger(KeyInput.KEY_SPACE));</pre></div></li><li class="listitem">The <code class="literal">InteractionTrigger</code> instance also needs to be added as a listener to <code class="literal">inputManager</code>:<div class="informalexample"><pre class="programlisting">inputManager.addListener(interactionTrigger, mappingNames);</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec226"/>How it works...</h2></div></div></div><p>The <code class="literal">InteractionTrigger</code> instance has several things in common with <code class="literal">EnterableTrigger</code>, which we created in the <span class="emphasis"><em>Creating a trigger system</em></span> recipe, and it also has a new functionality. Rather than firing the trigger as soon as the player enters it, it sets the <code class="literal">inside</code> flag, which defines whether it's possible to interact with it or not. It also displays a text on the GUI for the player.</p><p>Once the <code class="literal">InteractionTrigger</code> receives a call to its <code class="literal">onAction</code> method from <code class="literal">InputManager</code>, it checks whether <code class="literal">inside</code> is <code class="literal">true</code> and calls <code class="literal">trigger</code>. To brush up your knowledge <a id="id642" class="indexterm"/>on how input is handled, check out <a class="link" href="ch02.html" title="Chapter 2. Cameras and Game Controls">Chapter 2</a>, <span class="emphasis"><em>Cameras and Game Control</em></span>.</p></div></div>
<div class="section" title="Controlling AI with triggers"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec93"/>Controlling AI with triggers</h1></div></div></div><p>
<a class="link" href="ch05.html" title="Chapter 5. Artificial Intelligence">Chapter 5</a>, <span class="emphasis"><em>Artificial Intelligence</em></span>, deals with several methods to control AI in games. As we learned<a id="id643" class="indexterm"/> in that chapter, control and predictability are very<a id="id644" class="indexterm"/> important. Even if we have the smartest AI in the world, as programmers, we want to be able to know that the AI will perform a certain action at a certain time. This is where triggers can be extremely useful. In fact, with a good trigger system there might not be need for much AI at all.</p><p>One example of trigger usage might be a warehouse where guards are in a patrolling state. Once the player reaches a certain area (maybe where they should not go), an alarm is triggered. At this point, we also want the guards to switch to a more aggressive state.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec227"/>Getting ready</h2></div></div></div><p>This recipe will link the trigger system we created previously in the chapter with the StateMachine-based <code class="literal">AIControl</code> class from the <span class="emphasis"><em>Decision making – Finite State Machine</em></span> recipe in <a class="link" href="ch05.html" title="Chapter 5. Artificial Intelligence">Chapter 5</a>, <span class="emphasis"><em>Artificial Intelligence</em></span>. Even if you haven't followed the recipes in <a class="link" href="ch05.html" title="Chapter 5. Artificial Intelligence">Chapter 5</a>, <span class="emphasis"><em>Artificial Intelligence</em></span>, but have a different class controlling AI, it should be quite easy to adapt this recipe to accommodate that class.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec228"/>How to do it...</h2></div></div></div><p>As with the previous examples, we begin by creating a new class that extends the <code class="literal">ScriptObject</code> interface. We can call it <code class="literal">AIScriptControl</code>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">It needs to have an <code class="literal">AIControl</code> field called <code class="literal">aiControl</code> and a <code class="literal">Class&lt;AIState&gt;</code> field called <code class="literal">targetState</code>.</li><li class="listitem">It might also have a <code class="literal">Spatial</code> called <code class="literal">target</code>.</li><li class="listitem">Finally, we add a Boolean called <code class="literal">enabled</code>.</li><li class="listitem">In its <code class="literal">trigger</code> method, we should call <code class="literal">onTrigger</code> if <code class="literal">enabled</code> is <code class="literal">true</code>.</li><li class="listitem">In the <code class="literal">onTrigger</code> method, we apply <code class="literal">targetState</code> to <code class="literal">aiControl</code>:<div class="informalexample"><pre class="programlisting">aiControl.setState(targetState);</pre></div></li><li class="listitem">If <code class="literal">target</code> is not null, we call <code class="literal">aiControl.setTarget(target)</code>.</li><li class="listitem">The <code class="literal">StateMachine</code> for the <code class="literal">AIControl</code> we created was a closed system and it didn't need any external input to change the states. Now, we need to be able to trigger it externally so let's add a setter method in the <code class="literal">AIControl</code>. Create a new method called <code class="literal">setState</code>, which takes a <code class="literal">Class&lt;AIState&gt;</code> called <code class="literal">state</code> as an input parameter.</li><li class="listitem">Inside, we check whether <code class="literal">spatial</code> has the supplied state, and enable it if possible:<div class="informalexample"><pre class="programlisting">if(spatial.getControl(state) != null){
spatial.getControl(state).setEnabled(true);
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec229"/>How it works...</h2></div></div></div><p>This<a id="id645" class="indexterm"/> recipe follows the pattern we established in the <span class="emphasis"><em>Creating a trigger system</em></span> recipe. In the <code class="literal">onTrigger</code> method, we apply <code class="literal">targetState</code>, which will <a id="id646" class="indexterm"/>change the behavior and actions of the AI. For example, it can change from <code class="literal">PatrolState</code> to <code class="literal">AttackState</code>. We only supply the class type and not a whole instance of the class since the AI should already have the state and it might be configured already. In this way, we tell the AI to simply change the state if it is available. We also have a <code class="literal">target</code> field, in case the new state requires that.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec230"/>There's more...</h2></div></div></div><p>It doesn't have to end with that. We can, for example, with some modification trigger the AI to start walking a path, turn in a certain direction, or take cover and other things. This functionality can either be built into this class or be made as separate classes.</p><p>To explore an example in detail, let's have a look at what will be needed to have the AI move to a specific location once <code class="literal">AIScriptControl</code> is triggered.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will need an <code class="literal">AIState</code>, which handles moving to a set location. <a class="link" href="ch05.html" title="Chapter 5. Artificial Intelligence">Chapter 5</a>, <span class="emphasis"><em>Artificial Intellegence</em></span>, explains this. The <code class="literal">SeekCoverState</code> can easily be modified to only have a <code class="literal">target</code> field rather than a list to choose from.</li><li class="listitem">We will need something to function as a waypoint or target. Again, the <code class="literal">CoverPoint</code> control from the same recipe can function as a waypoint too. It can also be extended so that using cover at <code class="literal">WayPoint</code> is an option within the class.</li><li class="listitem">Finally, we will need to pass <code class="literal">WayPoint</code> to the state. Since we're not supplying a whole class, we can't set it in <code class="literal">AIState</code> itself. One way would be to pass it through the <code class="literal">setTarget</code> method of <code class="literal">AIControl</code>.</li></ol></div></div></div>
<div class="section" title="Creating a dynamic skybox with a moving sun"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec94"/>Creating a dynamic skybox with a moving sun</h1></div></div></div><p>We <a id="id647" class="indexterm"/>covered how to create static skyboxes in <a class="link" href="ch01.html" title="Chapter 1. SDK Game Development Hub">Chapter 1</a>, <span class="emphasis"><em>SDK Game Development Hub</em></span>. While they are fine for many implementations, some games require day and night cycles.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec231"/>Getting ready</h2></div></div></div><p>This recipe will show us how to create a moving sun, which can be superimposed on a regular skybox. In this case, a neutral skybox without any protruding features such as mountains will work best. We'll also learn how to make a sky that changes color during the day. In this case, no skybox is required.</p><p>We will also need a texture that should have a transparent background with a filled, white circle in it, as shown in the following figure:</p><div class="mediaobject"><img src="graphics/6478OS_09_03.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec232"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We begin by creating a new application class extending <code class="literal">SimpleApplication</code>.</li><li class="listitem">In the <code class="literal">simpleInitApp</code> method, we first need to create <code class="literal">Geometry</code> for the sun:<div class="informalexample"><pre class="programlisting">Geometry sun = new Geometry("Sun", new Quad(1.5f, 1.5f));</pre></div></li><li class="listitem">We need to set some rendering hints on it, as shown in the following code:<div class="informalexample"><pre class="programlisting">sun.setQueueBucket(RenderQueue.Bucket.Sky);
sun.setCullHint(Spatial.CullHint.Never);
sun.setShadowMode(RenderQueue.ShadowMode.Off);</pre></div></li><li class="listitem">Now, we <a id="id648" class="indexterm"/>can load a <code class="literal">Material</code> instance based on the unshaded material definition.</li><li class="listitem">For <code class="literal">ColorMap</code>, we load the texture with the white circle in it and apply the texture. Then, for <code class="literal">Color</code> we can set an almost white color with a tint of yellow in it. We also have to enable alpha in the material:<div class="informalexample"><pre class="programlisting">sunMat.getAdditionalRenderState().setBlendMode(RenderState.BlendMode.Alpha);
sunMat.setTexture("ColorMap", assetManager.loadTexture("Textures/sun.png"));
sunMat.setColor("Color", new ColorRGBA(1f, 1f, 0.9f, 1f));</pre></div></li></ol></div><p>So, the basic <code class="literal">Geometry</code> is set up and we can create a <code class="literal">Control</code> class to move the sun across the sky by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a class called <code class="literal">SunControl</code>, which extends <code class="literal">AbstractControl</code>.</li><li class="listitem">It should have a <code class="literal">float</code> field called <code class="literal">time</code>, a reference to the application camera called <code class="literal">cam</code>, a <code class="literal">Vector3f</code> field called <code class="literal">position</code>, and a <code class="literal">DirectionalLight</code> field called <code class="literal">directionalLight</code>.</li><li class="listitem">In the <code class="literal">controlUpdate</code> method, we start by finding the <code class="literal">x</code> and <code class="literal">z</code> positions based on the time and multiply the result to move it some distance away. We can also make the sun move up and down by doing the same for the <code class="literal">y</code> value:<div class="informalexample"><pre class="programlisting">float x = FastMath.cos(time) * 10f;
float z = FastMath.sin(time) * 10f;
float y = FastMath.sin(time ) * 5f;
position.set(x, y, z);</pre></div></li><li class="listitem">Then, we should set <code class="literal">localTranslation</code> of the sun. Since we want it to appear to be very far away, we add the camera's location. This way it will always appear to be the same distance from the camera:<div class="informalexample"><pre class="programlisting">spatial.setLocalTranslation((cam.getLocation().add(position)));</pre></div></li><li class="listitem">We also want the sun to always face the camera. This is easily done by calling the following code:<div class="informalexample"><pre class="programlisting">spatial.lookAt(cam.getLocation(), Vector3f.UNIT_Y);</pre></div></li><li class="listitem">If the <code class="literal">directionalLight</code> field is set, we should also set its direction. We get the direction by inverting <code class="literal">position</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">directionalLight.setDirection(position.negate());</pre></div></li><li class="listitem">Finally, we increase the <code class="literal">time</code> value by a factor of <code class="literal">tpf</code> (depending on how fast we want the sun to move). Since two PI in radians make up a circle, we start over once <code class="literal">time</code> exceeds that value, using the following code:<div class="informalexample"><pre class="programlisting">time += tpf * timeFactor;
time = time % FastMath.TWO_PI;</pre></div></li><li class="listitem">Going<a id="id649" class="indexterm"/> back to the <code class="literal">application</code> class, we add the control to the <code class="literal">Geometry</code> sun and <code class="literal">Geometry</code> to the scene graph:<div class="informalexample"><pre class="programlisting">sun.addControl(sunControl);
rootNode.attachChild(sun);</pre></div></li></ol></div><p>The previous implementation can be enough for many games but it can be taken much further. Let's explore how to make the sun color dynamic based on its height above the horizon and how to also have a dynamic sky color by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of all, let's introduce two static <code class="literal">ColorRGBA</code> fields in the <code class="literal">SunControl</code> class called <code class="literal">dayColor</code> and <code class="literal">eveningColor</code>. We also add another <code class="literal">ColorRGBA</code> field called <code class="literal">sunColor</code>.</li><li class="listitem">In the <code class="literal">controlUpdate</code> method, we take the <code class="literal">y</code> value of the sun and divide it so that we get a value between <code class="literal">-1</code> and <code class="literal">1</code>, and store this as the height.</li><li class="listitem"><code class="literal">ColorRGBA</code> has a method to interpolate two colors that we can use to get a smooth transition during the day:<div class="informalexample"><pre class="programlisting">sunColor.interpolate(eveningColor, dayColor, FastMath.sqr(height));</pre></div></li><li class="listitem">After this, we set the color of <code class="literal">directionalLight</code> to the same as <code class="literal">sunColor</code> and also set the material's <code class="literal">Color</code> parameter to the same:<div class="informalexample"><pre class="programlisting">directionalLight.setColor(sunColor);
((Geometry)spatial).getMaterial().setColor("Color", sunColor);</pre></div></li></ol></div><p>Handling the sky color will take a bit more work. To do this, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We begin by creating a new class called <code class="literal">SkyControl</code> extending <code class="literal">AbstractControl</code>.</li><li class="listitem">Like <code class="literal">SunControl</code>, the <code class="literal">SkyControl</code> class needs a <code class="literal">Camera</code> field called <code class="literal">cam</code>. It also needs a <code class="literal">ColorRGBA</code> field called <code class="literal">color</code> and three static <code class="literal">ColorRGBA</code> fields for different times in the day:<div class="informalexample"><pre class="programlisting">private static final ColorRGBA dayColor = new ColorRGBA(0.5f, 0.5f, 1f, 1f);
private static final ColorRGBA eveningColor = new ColorRGBA(1f, 0.7f, 0.5f, 1f);
private static final ColorRGBA nightColor = new ColorRGBA(0.1f, 0.1f, 0.2f, 1f);</pre></div></li><li class="listitem">The <code class="literal">SkyControl</code> class needs<a id="id650" class="indexterm"/> to know about the sun's location so we add a <code class="literal">SunControl</code> field called <code class="literal">sun</code>.</li><li class="listitem">In the <code class="literal">controlUpdate</code> method, we set the <code class="literal">localTranslation</code> of the spatial to the location of the <code class="literal">cam</code>.</li><li class="listitem">Next, we get the sun's height and if it is higher than 0, we interpolate the color between <code class="literal">eveningColor</code> and <code class="literal">dayColor</code>. Otherwise, we interpolate between the <code class="literal">eveningColor</code> and <code class="literal">nightColor</code> instead. Then, we set the resulting color in the sky's material's <code class="literal">Color</code> parameter, as shown in the following code:<div class="informalexample"><pre class="programlisting">if(sunHeight&gt; 0){
  color.interpolate(eveningColor, dayColor, FastMath.pow(sunHeight, 4));
} else {
  color.interpolate(eveningColor, nightColor, FastMath.pow(sunHeight, 4));
}
((Geometry)spatial).getMaterial().setColor("Color", color);</pre></div></li><li class="listitem">Going back to the <code class="literal">application</code> class, we create a box shaped <code class="literal">Geometry</code> called <code class="literal">sky</code></li><li class="listitem">for the control with <code class="literal">10f</code> sides.</li><li class="listitem">Like the sun geometry, sky should have the Sky <code class="literal">QueueBucket</code>, <code class="literal">ShadowMode.Offand CullHint.Never</code> settings applied to it.</li><li class="listitem">In addition, we should call <code class="literal">getAdditionalRenderState</code> and set <code class="literal">FaceCullMode</code> to <code class="literal">FaceCullMode.Off</code>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec233"/>How it works...</h2></div></div></div><p>Always causing the geometries of this recipe follow the camera around is one of the parts that make this recipe work. The other trick is using the Sky <code class="literal">QueueBucket</code>. The Sky <code class="literal">QueueBucket</code> can be thought of as lists of items to be rendered. Everything in the Sky bucket is rendered first. Because it's rendered first, other things will be rendered on top of it. This is why it appears to be far away even though it's really close to the camera.</p><p>We also use the direction of the sun from the camera for <code class="literal">DirectionalLight</code> in the scene, making it follow the sun as it moves across the sky.</p><p>When updating the control, we handle the movement of the sun using the <code class="literal">time</code> value, which increases with each update. Using <code class="literal">FastMath.sin</code> and <code class="literal">FastMath.cos</code> for the <code class="literal">x</code> and <code class="literal">z</code> values, we get it to move in a circle around the camera. Using <code class="literal">FastMath.sin</code> again for the <code class="literal">y</code> value will move it in an arc above (and below) the horizon. By multiplying the <code class="literal">y</code> value, we can get it to rise higher in the sky.</p><p>The resulting position was added to the camera's location to always make the sun centered around the camera. Since the sun is a simple quad, we also had to rotate it to face the camera with every update.</p><p>We went on to change the color of the sun based on the height above the horizon. We used the interpolate method of <code class="literal">ColorRGBA</code> to do this. Interpolation requires a value between <code class="literal">0.0</code> and <code class="literal">1.0</code>. That's why we needed to divide the <code class="literal">y</code> value by the max <code class="literal">y</code> value (or amplitude) in the case where we've multiplied it earlier to get a higher arc in the sky.</p><p>The <a id="id651" class="indexterm"/>movement of the box simulating the sky is similar. We just keep it centered around the camera so that even if it's a small box, it appears to cover the whole sky. Normally, we wouldn't see the sides of the box when we're inside it so we set <code class="literal">FaceCullMode</code> to <code class="literal">Off</code> to always make it render the sides.</p><p>
<code class="literal">SkyControl</code> was fitted with three instances of <code class="literal">ColorRGBA: dayColor</code> with a bluish tint, <code class="literal">eveningColor</code> with orange, and <code class="literal">nightColor</code> almost black. The <code class="literal">SunControl</code> was supplied to the control and used to interpolate between the colors based on the height of the sun. Anything above <code class="literal">0.0f</code> is considered day.</p><p>In this implementation, the whole sky changes color with the sun. Any further development of <code class="literal">SkyControl</code> could include a more complex shape, such as a cylinder or sphere where only the vertices on the same side as the sun change color. Clouds can be implemented and they also use a quad that moves in the xz-plane.</p><p>Another improvement would be to have a night-time, star-filled skybox outside of the box we made and fade the alpha value of <code class="literal">nightColor</code> to let it gradually shine through the night time.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec234"/>There's more...</h2></div></div></div><p>If we try the recipe with the unshaded material definition for the sky, it will work well in most cases. However, when it comes to the postprocessor water filter, it will not pick up the sky color properly. To achieve this, we will have to make some modifications to its material. We don't need to actually change any of the <code class="literal">.vert</code> or <code class="literal">.frag</code> files, but can create a new <code class="literal">Material Definition (.j3md)</code> file.</p><p>To make things as easy as possible, we can copy the <code class="literal">Unshaded.j3md</code> file. Refer to the following code within the <code class="literal">Unshaded.j3md</code> file:</p><div class="informalexample"><pre class="programlisting">VertexShader GLSL100:   Common/MatDefs/Misc/Unshaded.vert</pre></div><p>Replace the previous line with the following line:</p><div class="informalexample"><pre class="programlisting">VertexShader GLSL100:   Common/MatDefs/Misc/Sky.vert</pre></div><p>This <a id="id652" class="indexterm"/>means we'll be using the vertex shader normally used by the Sky material to handle the positions of the vertices for the renderer.</p><p>We also need to change the <code class="literal">WorldParameters</code> segment to contain the following:</p><div class="informalexample"><pre class="programlisting">ViewMatrix
ProjectionMatrix
WorldMatrix</pre></div></div></div>
<div class="section" title="Improving a scene with postprocessing filters"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec95"/>Improving a scene with postprocessing filters</h1></div></div></div><p>In the <span class="emphasis"><em>Creating dynamic skybox with moving sun</em></span> recipe, we created a dynamic skybox that has <a id="id653" class="indexterm"/>many applications. It's possible to<a id="id654" class="indexterm"/> improve the appearance of this (and any other) scene significantly with postprocessing filters. They are called postprocessing filters because they are applied after the scene has already been rendered. This also makes them affect everything in the scene.</p><p>We also covered how to create an advanced postfilter in <a class="link" href="ch01.html" title="Chapter 1. SDK Game Development Hub">Chapter 1</a>, <span class="emphasis"><em>SDK Game Development Hub</em></span>.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec235"/>How to do it...</h2></div></div></div><p>The sun we have is now moving across the sky. It has very sharp edges and we can use a bloom filter to smooth it out a bit. Perform the following steps to improve a scene with the help of postprocessing filters:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of all, we need to create a new <code class="literal">FilterPostProcessor</code> instance called <code class="literal">processor</code>.</li><li class="listitem">Add this to the main view port, by calling <code class="literal">viewPort.addProcessor(processor)</code> from within the application.</li><li class="listitem">Then, we create a new bloom filter called <code class="literal">bloomFilter</code>. The default settings will produce a decent result, but it might be worth playing around a bit with the settings.</li><li class="listitem">Add the <code class="literal">bloomFilter</code> to <code class="literal">processor.addFilter(bloomFilter)</code> and try it again.</li><li class="listitem">Then, we create a new <code class="literal">LightScatteringFilter</code> instance called <code class="literal">lightScatteringFilter</code> and add it again to <code class="literal">processor.addFilter(lightScatteringFilter)</code>.</li><li class="listitem">This is dependent on a position for the light to scatter, so we need to make it aware of the sun's location. We can achieve this by adding a new field for the filter in the <code class="literal">SunControl</code> class from the last recipe along with a setter.</li><li class="listitem">Then in the <code class="literal">controlUpdate</code> method, once we have updated <code class="literal">position</code>, we add the following code:<div class="informalexample"><pre class="programlisting">lightScatteringFilter.setLightPosition(position.mult(1000));</pre></div></li><li class="listitem">We still<a id="id655" class="indexterm"/> have some tweaking<a id="id656" class="indexterm"/> to do as it will now also apply the effect when the sun is below the ground. To mitigate this, we can disable the filter during nighttime:<div class="informalexample"><pre class="programlisting">if(y &gt; -2f){
  if(!lightScatteringFilter.isEnabled()){
    lightScatteringFilter.setEnabled(true);
  }
  lightScatteringFilter.setLightDensity(1.4f);
} else if(lightScatteringFilter.isEnabled()){
  lightScatteringFilter.setEnabled(false);
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec236"/>How it works...</h2></div></div></div><p>The <code class="literal">FilterPostProcessor</code> acts as a container for the filters and applies them to the rendered result. Several filters can be added to the same processor and the order matters. If we add <code class="literal">LightScatteringFilter</code> before <code class="literal">bloomFilter</code>, we will get bloom applied to the light scattering and vice versa.</p><p>The <code class="literal">bloomFilter</code> works by blurring the image slightly and intensifying colors, making the result <a id="id657" class="indexterm"/>appear a bit softer. Bloom filters work best with tweaking and shouldn't just be slapped on to the scene. It's easy to be impressed by the initial effect and leave it at that but it should always be adapted to the art style of the game. A fantasy game in an enchanted forest might get away with more bloom than a hard-boiled cyberpunk shooter.</p><p>The <code class="literal">LightScatteringFilter</code> instance does two things. Firstly, it creates a halo of rays emanating <a id="id658" class="indexterm"/>from the direction of the light source. Secondly, if the camera is pointing towards the light source, it will whiteout the image increasingly, simulating glare.</p><p>In a normal skybox, the sun would be static but in this example the sun keeps moving. By supplying the filter to <code class="literal">SunControl</code>, we could keep the logic to update the position within that class. We will also get some weird effects as <a id="id659" class="indexterm"/>the glare will still show. The easy<a id="id660" class="indexterm"/> way out is to simply turn off the effect as the sun gets below the horizon.</p></div></div>
<div class="section" title="Performing complex movements with MotionPaths"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec96"/>Performing complex movements with MotionPaths</h1></div></div></div><p>Players<a id="id661" class="indexterm"/> in games have been obliged to<a id="id662" class="indexterm"/> jump on moving platforms since the dawn of gaming. Even with the incredibly advanced games of today, it's not uncommon to encounter this most primitive game mechanic albeit with better graphics. There's also a popular retro genre that calls for the same, not the least for mobile games.</p><p>How do we do that in jMonkeyEngine? One way is, of course, to simply use move or <code class="literal">setLocalTranslation</code> on geometries. This can quickly get complex if we want to make sequenced paths. A better option is to use MotionPaths and MotionEvents.</p><p>A <code class="literal">MotionPath</code> object is basically a set of waypoints through which an object will move in an interpolated <a id="id663" class="indexterm"/>way meaning the movement will be smooth. The <code class="literal">MotionEvent</code> is the control class defining when and how the object should move along the <code class="literal">MotionPath</code> object. It can define how an object should be rotated along the path and if and how the path should be cycled through.</p><p>In this recipe, we'll check out how to use them for a game, which could be a side-scrolling 2D game, but the same principles can be used to create advanced cinematic cutscenes.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec237"/>How to do it...</h2></div></div></div><p>Let's begin by creating a platform object to move, by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We define a new <code class="literal">Geometry</code> called <code class="literal">platform</code> and apply the <code class="literal">Unshaded</code> material to it, as shown in the following code:<div class="informalexample"><pre class="programlisting">platform = new Geometry("Platform", new Box(1f, 0.1f, 1f));
platform.setMaterial(new Material(assetManager, "MatDefs/Misc/Unshaded.j3md"));</pre></div></li><li class="listitem">Then, we attach the <code class="literal">platform</code> object to <code class="literal">rootNode</code>.</li><li class="listitem">Next, we define a new <code class="literal">MotionPath</code> object called <code class="literal">path</code>.</li><li class="listitem">We add 8 waypoints in a circular pattern, using the following code:<div class="informalexample"><pre class="programlisting">for(inti = 0 ; i&lt; 8; i++){
  path.addWayPoint(new Vector3f(0, FastMath.sin(FastMath.QUARTER_PI * i) * 10f, FastMath.cos(FastMath.QUARTER_PI * i) * 10f));
}</pre></div></li><li class="listitem">Then, we<a id="id664" class="indexterm"/> call <code class="literal">path.setCycle(true)</code> to make it connect the first and last waypoints.</li><li class="listitem">Now, we <a id="id665" class="indexterm"/>can define a new <code class="literal">MotionEvent</code> called <code class="literal">event</code> and supply <code class="literal">platform</code> and <code class="literal">path</code> in the constructor.</li><li class="listitem">We call <code class="literal">event.setInitialDuration(10f)</code> and <code class="literal">setSpeed(1f)</code>.</li><li class="listitem">Finally, we call <code class="literal">event.setLoopMode(LoopMode.Loop)</code>.<div class="mediaobject"><img src="graphics/6478OS_09_04.jpg" alt="How to do it..."/><div class="caption"><p>Debug MotionPath with red waypoints</p></div></div></li><li class="listitem">Optionally, we can visualize the path by calling the following method:<div class="informalexample"><pre class="programlisting">path.enableDebugShape(assetManager, rootNode);</pre></div></li><li class="listitem">Now, all we need to do is call <code class="literal">event.play()</code> to start the event!</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec238"/>How it works...</h2></div></div></div><p>The <code class="literal">for</code> loop creates eight waypoints along a circle at 45 degrees distance from each other. However, to make a complete circle the first and last waypoints need to be connected or the path will stop at the final one. This is why <code class="literal">setCycle(true)</code> must be set. This is treated as the ninth waypoint at the same position as the first.</p><p>MotionEvent's <code class="literal">initialDuration</code> is the time it should take to complete the path. The speed defines the factor at which the <code class="literal">initialDuration</code> should be completed. So, setting the speed to 2f will halve the actual time it takes for the object to complete its movement. The <code class="literal">loopMode</code>, not surprisingly, defines whether the object should stop once it has completed the path, or continue. There's also an option to make it go back the same path again with <code class="literal">LoopMode.Cycle</code>. This is not related to MotionPath's <code class="literal">setCycle</code> method.</p><p>While <a id="id666" class="indexterm"/>this recipe doesn't explore <a id="id667" class="indexterm"/>the option, it's possible to have the spatial in <code class="literal">MotionPath</code> perform various types of rotation. By default, no rotation will be applied. By calling <code class="literal">setDirectionType</code> it is possible to, for example, let the object follow the path's rotation (face the direction of the path) or rotate by a fixed amount or always face a certain point. Some of the direction types require a rotation to be supplied with the <code class="literal">setRotation</code> method.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec239"/>There's more...</h2></div></div></div><p>Now, the object is moving along its given path and we can add several platforms moving in different patterns. Let's say we want something to happen once a platform reaches the end of its path. Maybe it should start the next one or trigger one of our ScriptObjects from the previous recipes.</p><p>In that case, we can use <code class="literal">MotionPathListener</code>. This is an interface with a callback method called <code class="literal">onWayPointReached</code>, which will be called every time the path passes a waypoint. It will supply both the <code class="literal">MotionEvent</code> and the <code class="literal">index</code> of the waypoint. If we want to trigger something at the end of the path, it might look like the following code snippet:</p><div class="informalexample"><pre class="programlisting">path.addListener(new MotionPathListener() {
  public void onWayPointReach(MotionEvent control, intwayPointIndex) {
    if (path.getNbWayPoints() == wayPointIndex + 1) {
      nextMotionEvent.play();
    }
  }
});</pre></div></div></div>
<div class="section" title="Cutscenes using cinematics"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec97"/>Cutscenes using cinematics</h1></div></div></div><p>The previous <a id="id668" class="indexterm"/>recipe explored the possibilities <a id="id669" class="indexterm"/>of using <code class="literal">MotionPaths</code> to move objects around. One step up from that and a way to organize many events in a sequence is cinematics. It can be used both to create in-game scripted events and advanced cutscenes. The power of a well-scripted in-game event should not be underestimated but neither should the time it takes to get one right.</p><p>In this recipe, we'll explore the possibilities of the <code class="literal">Cinematics</code> system by creating a cutscene using content that we have created before.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec240"/>Getting ready</h2></div></div></div><p>Some basic knowledge of <code class="literal">MotionPaths</code> and <code class="literal">MotionEvents</code> is required. Checking out the <span class="emphasis"><em>Performing complex movements with MotionPath</em></span> recipe should provide enough information to get started. A new class that is introduced is the <code class="literal">Cinematic</code> class. This works as a sequencer or manager of many events firing them at set times. The events don't just have to be <code class="literal">MotionEvents</code> but could be <code class="literal">AnimationEvents</code> dealing with skeleton-based animations, <code class="literal">SoundEvents</code>, and even <code class="literal">GuiEvents</code>. It can also manage several cameras and switch between them.</p><p>Before starting the actual implementation of a cinematic scene, it's good to have some kind of script describing what is going to happen. This will help organize the cinematic event and will save time in the end.</p><p>This recipe will use the <code class="literal">TestScene</code> from <a class="link" href="ch01.html" title="Chapter 1. SDK Game Development Hub">Chapter 1</a>, <span class="emphasis"><em>SDK Game Development Hub</em></span>. We can also use the animated sky box from earlier in this chapter. It will display Jaime walking from his initial position to stand by the edge of the water looking into the horizon. While he's walking, several switches between panning cameras will occur.</p><div class="mediaobject"><img src="graphics/6478OS_09_05.jpg" alt="Getting ready"/><div class="caption"><p>Using an empty node as a waypoint</p></div></div><p>Finding out good waypoints for characters and cameras can be difficult enough and it's not any easier if you have to do it all in code. A trick is to use the SceneComposer to create markers much like real movie makers use tape to designate where actors should move. Right-clicking on the scene node and selecting <span class="strong"><strong>Add Spatial.../New Node</strong></span> will give us an invisible marker. Give this a recognizable name and drag it into place by using<a id="id670" class="indexterm"/> the <code class="literal">Move</code> function.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec241"/>How to do it...</h2></div></div></div><p>So now<a id="id671" class="indexterm"/> that we have a scene prepared with some waypoints we can get to work with implementing the cutscene itself by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We start by loading a scene where the <code class="literal">Cinematic</code> will be played out. The scene reference will be used in several places, so it is a good idea to store it in a field.</li><li class="listitem">We'll also create a <code class="literal">Spatial</code> field called Jaime, the main actor and either load or extract him from the scene (depending on the setup).</li><li class="listitem">Now, we can create a <code class="literal">MotionPath</code> instance called <code class="literal">jaimePath</code> for Jaime. Since we created <code class="literal">Nodes</code> for each waypoint in <code class="literal">SceneComposer</code>, we can get their location from the scene by using:<div class="informalexample"><pre class="programlisting">jaimePath.addWayPoint(scene.getChild("WayPoint1").getWorldTranslation());</pre></div></li><li class="listitem">We go on and create a <code class="literal">MotionEvent</code> called <code class="literal">jaimeMotionEvent</code> using <code class="literal">jaimePath</code> and <code class="literal">initialDuration</code> of 25 seconds:<div class="informalexample"><pre class="programlisting">jaimeMotionEvent = new MotionEvent(jaime, jaimePath, 25f);</pre></div></li><li class="listitem">It's also preferable if Jaime faces in the direction of the path he travels along, so we also set <code class="literal">directionType</code> to <code class="literal">MotionEvent.Direction.Path</code>.</li></ol></div><p>Before we get too far, we want to check out that the path Jaime follows is alright. Therefore, we should go ahead and create a <code class="literal">Cinematic</code> instance at this point. To do this, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Doing this is as simple as supplying it with a scene, which will affect <code class="literal">rootNode</code> together with the total duration of the cinematic:<div class="informalexample"><pre class="programlisting">cinematic = new Cinematic(scene, 60f);</pre></div></li><li class="listitem">After that, we add <code class="literal">MotionEvent</code> with the following line; 0 being the time it should start at:<div class="informalexample"><pre class="programlisting">cinematic.addCinematicEvent(0, jaimeMotionEvent);</pre></div></li><li class="listitem">We also need to add cinematic to the <code class="literal">stateManager</code> of the application with <code class="literal">stateManager.attach(cinematic)</code>.</li><li class="listitem">Calling <code class="literal">cinematic.play()</code> at this point should display Jaime sliding along the path.</li></ol></div><p>Once we're happy with it, we can go on and do the camera work as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">Cinematic</code> instance will create a <code class="literal">CameraNode</code> for us if we call <code class="literal">cinematic.bindCamera("cam1", cam)</code>, so let's do that for our first camera. The string is the reference that <code class="literal">Cinematic</code> will know the camera by.</li><li class="listitem">It will be a camera that pans so we create a <code class="literal">MotionPath</code> instance and a <code class="literal">MotionEvent</code> instance for it. Again, we can get the waypoints of the camera path from the scene. Since the <code class="literal">Node</code> we added in <code class="literal">SceneComposer</code> by default snaps to the ground, we need to add between 1.5f and 2.0f to the y axis to get it to a suitable height.</li><li class="listitem">The <a id="id672" class="indexterm"/>camera should look at a fixed point<a id="id673" class="indexterm"/> as it pans, so we set <code class="literal">directionType</code> of camera's <code class="literal">MotionEvent</code> to <code class="literal">LookAt</code> and then also set the direction it should look at with <code class="literal">cam1Event.setLookAt</code> where the first <code class="literal">Vector3f</code> is the location to look at and the second is <code class="literal">Vector3f</code>, which is up in the world:<div class="informalexample"><pre class="programlisting">cam1Event = new MotionEvent(camNode, camPath1, 5f);     cam1Event.setDirectionType(MotionEvent.Direction.LookAt);
cam1Event.setLookAt(Vector3f.UNIT_X.mult(100), Vector3f.UNIT_Y);</pre></div></li><li class="listitem">With that done, we can test the first camera pan. We do that by calling the following code:<div class="informalexample"><pre class="programlisting">cinematic.activateCamera(0, "cam1");</pre></div></li><li class="listitem">The next camera will get its own <code class="literal">MotionPath</code> and <code class="literal">MotionEvent</code> instances and can similarly get its own <code class="literal">CameraNode</code>. It's perfectly fine to use the same physical camera for both of the CameraNodes.</li></ol></div><p>Now, we can start doing something about the lack of animation in the scene.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first thing Jaime does in the scene is walk towards the beach. We can create a new <code class="literal">AnimationEvent</code> instance that uses the <code class="literal">Walk</code> animation:<div class="informalexample"><pre class="programlisting">AnimationEventwalkEvent = new AnimationEvent(jaime, "Walk", LoopMode.Loop);</pre></div></li><li class="listitem">We then add it to <code class="literal">cinematic</code> at 0 seconds:<div class="informalexample"><pre class="programlisting">cinematic.addCinematicEvent(0, walkEvent);</pre></div></li><li class="listitem">Jaime should stop when he reaches the last waypoint, which is also when the <code class="literal">jaimeMotionEvent</code> ends. So we create another <code class="literal">AnimationEvent</code> with the idle animation and add it at the end of the duration of the <code class="literal">jaimeMotionEvent</code>.</li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>At the time of writing this, it seems the cinematic doesn't end the animation when it starts a new one, so we have to do something to stop it ourselves. Using a MotionPathListener, we can check when the final waypoint is reached and manually stop the walking animation:</p><div class="informalexample"><pre class="programlisting">jaimePath.addListener(new MotionPathListener() {
  public void onWayPointReach(MotionEventmotionControl, intwayPointIndex) {
    if(wayPointIndex == 2){
      walkEvent.stop();
    }
  }
});</pre></div></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec242"/>How it works...</h2></div></div></div><p>The <code class="literal">Cinematic</code> acts as a sequencer for all the different events and apart from firing events at the defined intervals, we can instead use <code class="literal">cinematic.enqueueCinematicEvent</code>. Doing so will start the supplied event just after the <a id="id674" class="indexterm"/>previous one is done. This can be useful if we <a id="id675" class="indexterm"/>want to trigger a series of animations right after each other. Cinematics can also be set to loop or cycle just like <code class="literal">MotionEvents</code> and you don't need to start them at time 0.</p><p>In conclusion, using cinematics is not particularly technical. It's just difficult to get all the positions, angles, and timings right, especially since there's no intelligence or collision involved in the script. Once you get it right, however, the result will be extremely rewarding.</p></div></div>
<div class="section" title="Using a positional audio and environmental effects"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec98"/>Using a positional audio and environmental effects</h1></div></div></div><p>Audio is an incredibly powerful mood setter and should not be overlooked in a game. In this <a id="id676" class="indexterm"/>recipe, we'll go through how to make the most of your sound assets<a id="id677" class="indexterm"/> using runtime effects and settings. If you're simply looking for omnipresent sounds or the basics on how to play them, check out <a class="link" href="ch01.html" title="Chapter 1. SDK Game Development Hub">Chapter 1</a>, <span class="emphasis"><em>SDK Game Development Hub</em></span>.</p><p>This recipe will do well in an FPS, where you have a number of footstep sounds that are played when the player moves around. However, the principle is true for any short sound that is played often enough to sound repetitive.</p><p>We'll approach this recipe in two steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we will learn how to vary a basic, repetitive sound. We can achieve this by varying the sound's pitch and using <code class="literal">LowPassFilter</code>.</li><li class="listitem">In the second step, we'll use reverb to vary it further, depending on the scene.</li></ol></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec243"/>How to do it...</h2></div></div></div><p>First of all, we need some basics set up.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We create a new application extending <code class="literal">SimpleApplication</code>, and add an <code class="literal">AudioNode</code> field called <code class="literal">audioNode</code>.</li><li class="listitem">In addition to this, we need to keep track of passed time with a <code class="literal">float</code> field called <code class="literal">time</code> and another <code class="literal">float</code> field called <code class="literal">pauseTime</code>, which we set to <code class="literal">0.7f</code>.</li><li class="listitem">In the <code class="literal">simpleInitApp</code> method, we create a new <code class="literal">audioNode</code> instance:<div class="informalexample"><pre class="programlisting">new AudioNode(assetManager, "Sound/Effects/Foot steps.ogg");</pre></div></li><li class="listitem">We override the <code class="literal">simpleUpdate</code> method and begin by checking whether <code class="literal">time</code> is more than <code class="literal">pauseTime</code>.</li><li class="listitem">If it is, we should set a new float called <code class="literal">pitch</code>. This should have a value of <code class="literal">1f +- 10%</code>, which can be achieved with the following code:<div class="informalexample"><pre class="programlisting">FastMath.nextRandomFloat() * 0.2f + 0.9f.</pre></div></li><li class="listitem">Then, we call <code class="literal">audioNode.setPitch(pitch)</code> to set it.</li><li class="listitem">Since this particular sound file plays four footsteps in sequence, we tell the node to not start from the beginning and only play the last of the footsteps by skipping forward in time, using the following code:<div class="informalexample"><pre class="programlisting">audioNode.setTimeOffset(2.0f);
audioNode.playInstance();</pre></div></li><li class="listitem">Before exiting the <code class="literal">if</code> statement, we set <code class="literal">time</code> to <code class="literal">0</code>.</li><li class="listitem">Finally, we shouldn't forget to increase <code class="literal">time</code> by tpf.</li><li class="listitem">Try running the application now. We should hear the same sound over and over again but with a slight variation.</li><li class="listitem">We can use <code class="literal">LowPassFilter</code> to further vary the sound. We instantiate it by supplying a float for the general volume, and another for the high frequency volume. To get the most variation, we can supply two random values between 0f and 1f:<div class="informalexample"><pre class="programlisting">LowPassFilter filter = new LowPassFilter(FastMath.nextRandomFloat(), FastMath.nextRandomFloat());</pre></div></li><li class="listitem">Then, we call <code class="literal">audioNode.setDryFilter(filter)</code> before <code class="literal">audioNode.playInstance()</code>.</li><li class="listitem">When <a id="id678" class="indexterm"/>we play it again, we should hear a slightly more varied sound that from time to time gets more muffled.</li></ol></div><p>Reverb is <a id="id679" class="indexterm"/>another parameter we can use for our sounds. But unlike the previous examples, this should not be randomized each time we play it (or randomized at all!). We can add reverb using the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new instance of <code class="literal">Environment</code> in the <code class="literal">simpleInitApp</code> method using one of the premade static ones in the <code class="literal">Environment</code> class and telling the application's <code class="literal">audioRenderer</code> to use it:<div class="informalexample"><pre class="programlisting">Environment env = Environment.Cavern;
audioRenderer.setEnvironment(env);</pre></div></li><li class="listitem">Running the application again with this environment should give each footstep a huge echo.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec244"/>How it works...</h2></div></div></div><p>In the first part of the recipe, we varied a single sound by changing its pitch slightly every time it was played. This will still sound repetitive and it is recommended to have several premade variants of a sound and use it in combination with this technique to get more out of them.</p><p>At the time of writing this, filters are not developed past <code class="literal">LowPassFilter</code> and have a limited use. It can still be used to cut the dryness of the sound and make it more muffled, as if heard through a wall, for example.</p><p>Having a sound file with a sequence of footsteps, like the one in the test-data library is fine for some types of games. They work best when you know how far a character will move each time, such as in an RTS or turn-based game. In an FPS, however, where we don't know how fast or far a player decides to move, it's better to have footstep sounds split up and played individually based on movement speed.</p><p>Using an <code class="literal">Environment</code> class is a great way to add immersion to sounds without having to bake the effect into the sound file. Controlling the effect unless it's level-wide can be a bit trickier. For example, you may want more reverb outside than in a furnished room. One way could be to use the trigger system from earlier in the chapter and big bounding volumes triggering a change in environment as the player enters their area.</p><p>In this example, we used the <code class="literal">setDryFilter</code> method of the <code class="literal">audioNode</code>. This will not modify any reverb coming from the environment. To do that, we have to use <code class="literal">setReverbFilter</code>.</p></div><div class="section" title="There's more"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec245"/>There's more</h2></div></div></div><p>The recipe<a id="id680" class="indexterm"/> has covered playing audio originating from the player. It is almost<a id="id681" class="indexterm"/> as easy doing this for other entities in the scene. Since <code class="literal">AudioNode</code> extends <code class="literal">Node</code>, it has a position in the scene graph. Attaching an <code class="literal">AudioNode</code> instance to the scene graph will play the sound using its <code class="literal">worldTranslation</code> field, just like how a model will be shown at that location.</p><p>Apart from setting <code class="literal">localTranslation</code>, we also need to make sure that the positional Boolean in <code class="literal">AudioNode</code> is <code class="literal">true</code> (which it is by default). We're also only allowed to use mono channel sounds when using positional audio.</p></div></div></body></html>