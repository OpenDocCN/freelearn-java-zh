<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Hardening the WildFly Communication"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Hardening the WildFly Communication</h1></div></div></div><p>In this chapter, you will learn the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Securing WildFly using HTTPS</li><li class="listitem" style="list-style-type: disc">Securing a specific application using HTTPS</li><li class="listitem" style="list-style-type: disc">Securing the WildFly console using HTTPS</li><li class="listitem" style="list-style-type: disc">Securing domain and host controllers' communication using HTTPS</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec89"/>Introduction</h1></div></div></div><p>In this chapter, you will learn how to secure your WildFly systems from a communication channel point of view, which is the HTTPS protocol. If system security is a concern, you will need to provide such a capability. By the way, when securing your system at any layer, keep an eye on performance, because it may cause some overhead.</p><p>We will learn how to provide security in a WildFly system at different stages, that is,:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Securing your application communication access protocol</li><li class="listitem" style="list-style-type: disc">Securing the WildFly management console</li><li class="listitem" style="list-style-type: disc">Securing the communication between the domain controller and all the host controllers</li></ul></div><p>While the last two points do not impact performance that much as they are administrative tools,  the first one may impact your performance. By the way, in an enterprise environment, often times, your WildFly middleware platform is behind a reverse proxy (that is, Apache HTTPD), and into a <span class="strong"><strong>Demilitarized Zone</strong></span> (<span class="strong"><strong>DMZ</strong></span>). For this reason, you should eventually <a id="id720" class="indexterm"/>secure the reverse proxy and not the traffic between Apache and WildFly, which will just cause CPU overhead. Avoid HTTPS between Apache and WildFly when your network infrastructure already provides security within a DMZ.</p><p>Okay, now that I'm in peace with my conscience, let's start!</p></div></div>
<div class="section" title="Securing WildFly using HTTPS"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec90"/>Securing WildFly using HTTPS</h1></div></div></div><p>In this <a id="id721" class="indexterm"/>recipe, we will learn how to use a secure channel <a id="id722" class="indexterm"/>to provide your applications with services, which is by using the HTTPS protocol. If privacy is a concern for you, this recipe will show how you can protect your data traffic. By the way, securing your applications needs different considerations and aspects, which should be addressed and resolved by developers and operations team.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec247"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">ad-hoc</code> folder to run our WildFly. In a terminal window execute the following:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone sec-std-node-1</pre></div><p>Now it's time to create our keystore which is used to encrypt the data traffic. We will be using one password to open the keystore file itself, and one password to load the alias.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a new terminal window and give the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cd sec-std-node-1/configuration
$ keytool -v -genkey -alias wildfly.ssl -keypass alias.2015 -keyalg RSA -keysize 2048 -sigalg SHA1withRSA -keystore wildfly.ssl.keystore -storepass keystore.2015

What is your first and last name?
  [Unknown]:  WildFly Cookbook
What is the name of your organizational unit?
  [Unknown]:  Packt Publishing
What is the name of your organization?
  [Unknown]:  packtpub.com
What is the name of your City or Locality?
  [Unknown]:  Birmingham
What is the name of your State or Province?
  [Unknown]:  GB
What is the two-letter country code for this unit?
  [Unknown]:  UK
Is CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK correct?
  [no]:  yes

Generating 2,048 bit RSA key pair and self-signed certificate (SHA1withRSA) with a validity of 90 days
  for: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK

[Storing wildfly.ssl.keystore]</pre></div></li><li class="listitem">Okay, now <a id="id723" class="indexterm"/>we have created the keystore to encrypt HTTP messages. Let's check its integrity by executing the following command:<div class="informalexample"><pre class="programlisting">$ keytool -list -v -keystore wildfly.ssl.keystore
Enter keystore password:

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: wildfly.ssl
Creation date: Nov 21, 2014
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 5514d1d1
Valid from: Fri Nov 21 10:36:31 CET 2014 until: Thu Feb 19 10:36:31 CET 2015
Certificate fingerprints:
   MD5:  D3:FA:9D:20:6D:79:DF:83:C3:50:B1:AC:23:B2:7D:9F
   SHA1: 89:AB:67:27:23:A4:89:85:06:10:FF:70:C6:6B:05:3D:14:DA:2D:AD
   SHA256: 7C:DD:A7:E3:44:B4:C5:9F:05:EE:87:2D:75:35:C2:3C:90:00:1B:DF:67:89:9B:13:33:F7:58:55:74:89:F7:7C
   Signature algorithm name: SHA1withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 1A F5 F7 EC D8 88 D9 80   DE 34 E7 A9 00 75 6A 74  .........4...ujt
0010: E8 60 56 D4                                        .`V.
]
]



*******************************************
*******************************************</pre></div></li></ol></div><p>Okay, everything is fine!!!</p><p>We are now ready to configure WildFly to expose itself and our applications via HTTPS.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec248"/>How to do it…</h2></div></div></div><p>We are now going <a id="id724" class="indexterm"/>to make a few changes to the WildFly configuration files in order to achieve our goal. We will see both the operational modes: standalone and domain.</p><div class="section" title="Standalone"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec60"/>Standalone</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of <a id="id725" class="indexterm"/>all, start a WildFly instance as usual:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=sec-std-node-1</pre></div></li><li class="listitem">Within a different terminal window, connect to the WildFly CLI and run the following code:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh --connect
[standalone@localhost:9990 /] /core-service=management/security-realm=SSLRealm:add()
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] /core-service=management/security-realm=SSLRealm/server-identity=ssl:add(keystore-path=wildfly.ssl.keystore, keystore-relative-to=jboss.server.config.dir,keystore-password=keystore.2015, alias=wildfly.ssl, key-password=alias.2015)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}
[standalone@localhost:9990 /] :reload()
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined
}
[standalone@localhost:9990 /] /subsystem=undertow/server=default-server/https-listener=https:add(socket-binding=https, security-realm=SSLRealm)
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /]</pre></div><p>Okay, we are done with the configuration.</p></li><li class="listitem">Let's test <a id="id726" class="indexterm"/>everything by opening a browser and pointing it to <code class="literal">https://localhost:8443/</code>:<div class="mediaobject"><img src="graphics/3744_10_01.jpg" alt="Standalone"/><div class="caption"><p>Browser warning the user about a self-signed certificate, thus untrusted</p></div></div></li><li class="listitem">First the browser will warn you about a security issue; just hit the <span class="strong"><strong>Add exception</strong></span> button, and <a id="id727" class="indexterm"/>then, in the next pop-up, hit the <span class="strong"><strong>Confirm security exception</strong></span> button. Once you confirm, the browser displays our WildFy instance running on HTTPS, as follows:<div class="mediaobject"><img src="graphics/3744_10_02.jpg" alt="Standalone"/><div class="caption"><p>Browser showing WildFly via HTTPS</p></div></div></li></ol></div></div><div class="section" title="Domain"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec61"/>Domain</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of <a id="id728" class="indexterm"/>all, create an <code class="literal">ad-hoc</code> folder to operate in the domain mode:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a domain sec-dmn-1</pre></div></li><li class="listitem">From the <span class="emphasis"><em>Getting ready</em></span> section of this recipe, see how you can create a keystore, or copy it from the <code class="literal">sec-std-node-1</code> folder (if you followed the <span class="emphasis"><em>Standalone</em></span> section steps), as follows:<div class="informalexample"><pre class="programlisting">$ cp sec-std-node-1/configuration/wildfly.ssl.keystore sec-dmn-1/configuration</pre></div></li><li class="listitem">Now start WildFly in the domain mode as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-1</pre></div></li><li class="listitem">Next, within a <a id="id729" class="indexterm"/>different terminal window, connect to the WildFly CLI and execute the following:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh --connect
[domain@localhost:9990 /] /host=master/core-service=management/security-realm=SSLRealm:add()
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}
[domain@localhost:9990 /] /host=master/core-service=management/security-realm=SSLRealm/server-identity=ssl:add(keystore-path=wildfly.ssl.keystore, keystore-relative-to=jboss.domain.config.dir,keystore-password=keystore.2015, alias=wildfly.ssl, key-password=alias.2015)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    },
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}
[domain@localhost:9990 /] :reload-servers
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined,
    "response-headers" =&gt; {"process-state" =&gt; "reload-required"}
}
[domain@localhost:9990 /]</pre></div></li><li class="listitem">As we know that the WildFly default domain configuration provides two server-groups, one bound to the <code class="literal">full</code> profile and one bound to the <code class="literal">full-ha</code> profile (this one without <a id="id730" class="indexterm"/>an active server), we can enable the HTTPS protocol for the <code class="literal">full</code> profile. Within the same CLI console, run the following code:<div class="informalexample"><pre class="programlisting">[domain@localhost:9990 /] /profile=full/subsystem=undertow/server=default-server/https-listener=https:add(socket-binding=https, security-realm=SSLRealm)
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; {"main-server-group" =&gt; {"host" =&gt; {"master" =&gt; {
        "server-one" =&gt; {"response" =&gt; {"outcome" =&gt; "success"}},
        "server-two" =&gt; {"response" =&gt; {"outcome" =&gt; "success"}}
    }}}},
    "response-headers" =&gt; {"process-state" =&gt; "reload-required"}
}
[domain@localhost:9990 /]</pre></div><p>Keep in mind that acting on the profile, once the configuration has been reloaded, will spread the changes to all servers belonging to the server-group referencing the <code class="literal">full</code> profile.</p><p>Okay, we are done with the configuration.</p></li><li class="listitem">Let's test everything by opening a browser and pointing it to <code class="literal">https://localhost:8443/</code>:<div class="mediaobject"><img src="graphics/3744_10_01.jpg" alt="Domain"/><div class="caption"><p>Browser warning the user about a self-signed certificate, thus untrusted</p></div></div></li><li class="listitem">First the browser will <a id="id731" class="indexterm"/>warn you about a security issue; just hit the <span class="strong"><strong>Add exception</strong></span> button, and then, in the next pop-up, hit the <span class="strong"><strong>Confirm security exception</strong></span> button. Once you confirm, the browser displays our WildFy instance running on HTTPS, as follows:<div class="mediaobject"><img src="graphics/3744_10_02.jpg" alt="Domain"/><div class="caption"><p>Browser showing WildFly via HTTPS</p></div></div></li></ol></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec249"/>How it works…</h2></div></div></div><p>On the WildFly side, we declared a new realm in the <code class="literal">management</code> section, calling it <code class="literal">SSLRealm</code>.</p><p>Within the new realm, we declared the keystore, which contains the certificates to be used by the HTTPS protocol to encrypt the data.</p><p>Lastly, for both the <a id="id732" class="indexterm"/>operational modes, we added the <code class="literal">https-listener</code> to the <code class="literal">Undertow</code> subsystem, referencing the newly created realm and the <code class="literal">https</code> socket-binding.</p><p>That is all that is needed by WildFly to serve your application via a secure channel, that is, via HTTPS.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec250"/>There's more…</h2></div></div></div><p>As you have noticed from the configuration files <code class="literal">standalone.xml</code> and <code class="literal">domain.xml</code>, we left the <code class="literal">http-listener</code>. As a matter of fact, our applications are also available via HTTP, which is clear, so both the following URLs would provide our WildFly welcome page and our applications, if any:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">http://localhost:8080</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">https://localhost:8443</code></li></ul></div><p>If you are seeing a page like <a id="id733" class="indexterm"/>the following, it is because you entered the hostname and the port correctly (that is, <code class="literal">localhost</code> and <code class="literal">8443</code>), but you used the HTTP schema, instead of the HTTPS schema:</p><div class="mediaobject"><img src="graphics/3744_10_03.jpg" alt="There's more…"/><div class="caption"><p>Browser trying to show the encrypted data within US-ASCII encoding</p></div></div><p>Nevertheless, if you want to provide just the secure channel, remove the <code class="literal">http-listener</code> declaration from the configuration, and you will be secured.</p><p>Bear in mind that disabling the <code class="literal">http-listener</code> needs a little attention, because it is referenced by other subsystems such as <code class="literal">ejb3</code> and <code class="literal">webservices</code> (both related to the <code class="literal">http-remoting-connector</code>, which is bound to the <code class="literal">http-listener</code>).</p><p>Doing so, your application will not be reachable via HTTP, as seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/3744_10_04.jpg" alt="There's more…"/><div class="caption"><p>Browser cannot reach the application via HTTP</p></div></div></div><div class="section" title="See also…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec251"/>See also…</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a deeper <a id="id734" class="indexterm"/>understanding of the keytool command, please refer to the Oracle official documentation at <a class="ulink" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html</a>.</li></ul></div></div></div>
<div class="section" title="Securing a specific application using HTTPS"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec91"/>Securing a specific application using HTTPS</h1></div></div></div><p>In this <a id="id735" class="indexterm"/>recipe, we will learn how to use a secure <a id="id736" class="indexterm"/>channel for a specific application. This is related to how your application is reached, and not to how to secure your data model, functionality, and all the features that an application comes with. Securing applications needs different considerations and aspects, which should be addressed and resolved mostly on the dev-side.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec252"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">ad-hoc</code> folder to run our WildFly. In a terminal window execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone sec-std-node-2</pre></div><p>Now it's time <a id="id737" class="indexterm"/>to create our keystore, which is used to <a id="id738" class="indexterm"/>encrypt data traffic for our specific application:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a new terminal window and run the following codes:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cd sec-std-node-2/configuration
$ keytool -v -genkey -alias wildfly.ssl.app -keyalg RSA -keysize 2048 -sigalg SHA1withRSA -keystore wildfly.ssl.app.keystore -storepass keystore.2015 -keypass alias.2015

What is your first and last name?
  [Unknown]:  WildFly Cookbook
What is the name of your organizational unit?
  [Unknown]:  Packt Publishing
What is the name of your organization?
  [Unknown]:  packtpub.com
What is the name of your City or Locality?
  [Unknown]:  Birmingham
What is the name of your State or Province?
  [Unknown]:  GB
What is the two-letter country code for this unit?
  [Unknown]:  UK
Is CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK correct?
  [no]:  yes

Generating 2,048 bit RSA key pair and self-signed certificate (SHA1withRSA) with a validity of 90 days
  for: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK

[Storing wildfly.ssl.app.keystore]</pre></div></li><li class="listitem">Okay, now <a id="id739" class="indexterm"/>we have created <a id="id740" class="indexterm"/>the keystore to encrypt HTTP messages. Let's check its integrity by executing the following command:<div class="informalexample"><pre class="programlisting">$ keytool -list -v -keystore wildfly.ssl.app.keystore
Enter keystore password:

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: wildfly.ssl.app
Creation date: Nov 21, 2014
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 17c96347
Valid from: Fri Nov 21 16:04:21 CET 2014 until: Thu Feb 19 16:04:21 CET 2015
Certificate fingerprints:
   MD5:  17:F1:E5:1D:93:4D:FE:AD:43:5A:7A:D6:79:9E:3A:6A
   SHA1: 90:7B:26:B0:07:6D:B2:E3:AD:A1:81:D2:F1:AA:47:C0:8D:0B:6D:43
   SHA256: C9:F3:AC:23:B7:54:45:AC:84:D7:D6:D7:A7:5D:B9:7C:ED:99:95:EC:9C:B9:9C:E0:47:68:30:C0:48:9D:D8:BD
   Signature algorithm name: SHA1withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 8C 21 34 9C F6 30 39 BD   21 43 CF 34 C4 31 A1 B7  .!4..09.!C.4.1..
0010: 81 7E E6 D1                                        ....
]
]



*******************************************
*******************************************</pre></div><p>Okay, everything is fine!</p><p>We are now ready to configure WildFly to expose our specific application via HTTPS.</p></li><li class="listitem">To test the <a id="id741" class="indexterm"/>HTTPS configuration, we will need two applications named <code class="literal">ssl-example</code> and <code class="literal">no-ssl-example</code>, which you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all source <a id="id742" class="indexterm"/>code and projects that you will need.</li><li class="listitem">To build the application, execute the following:<div class="informalexample"><pre class="programlisting">$ cd ~/WFC/github/wildfly-cookbook
$ mvn -e clean package -f ssl-example/pom.xml
$ mvn -e clean package -f no-ssl-example/pom.xml</pre></div></li><li class="listitem">Once done, copy the artifacts <code class="literal">no-ssl-example.war</code> and <code class="literal">ssl-example.war</code> (under their relative <code class="literal">target</code> folder) into your local <code class="literal">$WILDFLY_HOME</code> folder.</li></ol></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec253"/>How to do it…</h2></div></div></div><p>We are now going to make a few changes to the WildFly configuration files in order to achieve our goal. We will see both the operational modes: standalone and domain.</p><div class="section" title="Standalone"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec62"/>Standalone</h3></div></div></div><p>First of all, start <a id="id743" class="indexterm"/>a WildFly instance as follows:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=sec-std-node-2</pre></div><p>Within a different terminal window, connect to the WildFly CLI and execute the following:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/jboss-cli.sh --connect
[standalone@localhost:9990 /] /core-service=management/security-realm=AppSSLRealm:add()
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] /core-service=management/security-realm=AppSSLRealm/server-identity=ssl:add(keystore-path=wildfly.ssl.app.keystore, keystore-relative-to=jboss.server.config.dir,keystore-password=keystore.2015, alias=wildfly.ssl.app, key-password=alias.2015)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}
[standalone@localhost:9990 /] :reload()
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined
}
[standalone@localhost:9990 /] /subsystem=undertow/server=secure-server:add()
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}
[standalone@localhost:9990 /] :reload
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined
}
[standalone@localhost:9990 /] /subsystem=undertow/server=secure-server/https-listener=https:add(socket-binding=https, security-realm=AppSSLRealm)
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] /subsystem=undertow/server=secure-server/host=secure-host:add()
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] /subsystem=undertow/server=secure-server:write-attribute(name=default-host,value=secure-host)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}
[standalone@localhost:9990 /] :reload
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined
}
[standalone@localhost:9990 /]</pre></div><p>Okay, we are <a id="id744" class="indexterm"/>done with the configuration.</p><div class="section" title="Testing"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl4sec04"/>Testing</h4></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We now <a id="id745" class="indexterm"/>need to deploy our applications using the CLI, as follows:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] deploy no-ssl-example.war
[standalone@localhost:9990 /] deploy ssl-example.war
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">To test the configuration, open your browser and point it to <code class="literal">http://localhost:8080/no-ssl-example</code>.</li><li class="listitem">You should get a page similar to the following:<div class="mediaobject"><img src="graphics/3744_10_05.jpg" alt="Testing"/></div></li><li class="listitem">Now, point <a id="id746" class="indexterm"/>the browser to <code class="literal">https://localhost:8443/ssl-example</code>.</li><li class="listitem">After the security warning, you should get a page similar to the following:<div class="mediaobject"><img src="graphics/3744_10_06.jpg" alt="Testing"/></div></li></ol></div><p>Now if you try to mix the schema and port along with the context application, you will see that the <code class="literal">ssl-example</code> application is only reachable via HTTPS, and that the <code class="literal">no-ssl-example</code> is <a id="id747" class="indexterm"/>only reachable via HTTP.</p></div></div><div class="section" title="Domain"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec63"/>Domain</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of all, create <a id="id748" class="indexterm"/>an <code class="literal">ad-hoc</code> folder to operate in the domain mode:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a domain sec-dmn-2</pre></div></li><li class="listitem">From the <span class="emphasis"><em>Getting ready</em></span> section of this recipe, see how you can create a keystore, or copy it from the <code class="literal">sec-std-node-2</code> folder (if you followed the <span class="emphasis"><em>Standalone</em></span> section steps), as follows:<div class="informalexample"><pre class="programlisting">$ cp sec-std-node-2/configuration/wildfly.ssl.app.keystore sec-dmn-2/configuration</pre></div></li><li class="listitem">Now start WildFly in the domain mode, as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-2</pre></div></li><li class="listitem">Next, within a different terminal window, connect to the WildFly CLI and execute the following command:<div class="informalexample"><pre class="programlisting">[domain@localhost:9990 /] /host=master/core-service=management/security-realm=AppSSLRealm:add()
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}
[domain@localhost:9990 /] /host=master/core-service=management/security-realm=AppSSLRealm/server-identity=ssl:add(keystore-path=wildfly.ssl.app.keystore,keystore-relative-to=jboss.domain.config.dir,keystore-password=keystore.2015,alias=wildfly.ssl.app,key-password=alias.2015)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    },
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}
[domain@localhost:9990 /] reload --host=master
[domain@localhost:9990 /]</pre></div><p>As we <a id="id749" class="indexterm"/>know that the WildFly default domain configuration provides two server-groups, one bound to the <code class="literal">full</code> profile and one bound to the <code class="literal">full-ha</code> profile (this one without an active server), we can enable the HTTPS protocol for the <code class="literal">full</code> profile.</p></li><li class="listitem">Within the same CLI console, execute the following command:<div class="informalexample"><pre class="programlisting">[domain@localhost:9990 /] /profile=full/subsystem=undertow/server=secure-server:add()
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; {"main-server-group" =&gt; {"host" =&gt; {"master" =&gt; {
        "server-one" =&gt; {"response" =&gt; {
            "outcome" =&gt; "success",
            "response-headers" =&gt; {
                "operation-requires-reload" =&gt; true,
                "process-state" =&gt; "reload-required"
            }
        }},
        "server-two" =&gt; {"response" =&gt; {
            "outcome" =&gt; "success",
            "response-headers" =&gt; {
                "operation-requires-reload" =&gt; true,
                "process-state" =&gt; "reload-required"
            }
        }}
    }}}}
}
[domain@localhost:9990 /] reload --host=master
[domain@localhost:9990 /] /profile=full/subsystem=undertow/server=secure-server/https-listener=https:add(socket-binding=https,security-realm=AppSSLRealm)
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; {"main-server-group" =&gt; {"host" =&gt; {"master" =&gt; {
        "server-one" =&gt; {"response" =&gt; {"outcome" =&gt; "success"}},
        "server-two" =&gt; {"response" =&gt; {"outcome" =&gt; "success"}}
    }}}}
}
[domain@localhost:9990 /] /profile=full/subsystem=undertow/server=secure-server/host=secure-host:add()
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; {"main-server-group" =&gt; {"host" =&gt; {"master" =&gt; {
        "server-one" =&gt; {"response" =&gt; {"outcome" =&gt; "success"}},
        "server-two" =&gt; {"response" =&gt; {"outcome" =&gt; "success"}}
    }}}}
}
[domain@localhost:9990 /] /profile=full/subsystem=undertow/server=secure-server:write-attribute(name=default-host,value=secure-host)
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; {"main-server-group" =&gt; {"host" =&gt; {"master" =&gt; {
        "server-one" =&gt; {"response" =&gt; {
            "outcome" =&gt; "success",
            "response-headers" =&gt; {
                "operation-requires-reload" =&gt; true,
                "process-state" =&gt; "reload-required"
            }
        }},
        "server-two" =&gt; {"response" =&gt; {
            "outcome" =&gt; "success",
            "response-headers" =&gt; {
                "operation-requires-reload" =&gt; true,
                "process-state" =&gt; "reload-required"
            }
        }}
    }}}}
}
[domain@localhost:9990 /] reload --host=master
[domain@localhost:9990 /]</pre></div></li></ol></div><p>Keep in mind that acting on the profile, once the configuration has been reloaded, will spread the changes to all servers belonging to the server-group referencing the <code class="literal">full</code> profile.</p><p>Okay, we are done <a id="id750" class="indexterm"/>with the configuration.</p><div class="section" title="Testing"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl4sec05"/>Testing</h4></div></div></div><p>We now need to <a id="id751" class="indexterm"/>deploy our applications using the CLI, as follows:</p><div class="informalexample"><pre class="programlisting">[domain@localhost:9990 /] deploy no-ssl-example.war --server-groups=main-server-group
[domain@localhost:9990 /] deploy ssl-example.war --server-groups=main-server-group
[domain@localhost:9990 /]</pre></div><p>To test the configuration, open your browser and point it to the following URL:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">http://localhost:8080/no-ssl-example</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">https://localhost:8443/ssl-example</code></li></ul></div><p>You should follow the same steps as described for the standalone mode, along with the same final pages.</p></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec254"/>How it works…</h2></div></div></div><p>On the WildFly side, using the CLI, we created a new realm in the <code class="literal">management</code> section, calling it <code class="literal">AppSSLRealm</code>. Within the new realm, we declared the keystore, which contains the certificates to be used by the HTTPS protocol to encrypt the data.</p><p>Working on the <code class="literal">Undertow</code> subsystem, we added a server named <code class="literal">secure-server</code>. We then added  <code class="literal">https-listener</code> to it, binding the listener to the <code class="literal">https</code> socket binding configuration and to the <code class="literal">AppSSLRealm</code> security realm.</p><p>Lastly, we defined a host named <code class="literal">secure-host</code>, and made it the default host for our <code class="literal">secure-server</code>.</p><p>Wait a minute! How did we match the <code class="literal">ssl-example.war</code> application to the <code class="literal">secure-host</code> configuration declared in the <code class="literal">Undertow</code> subsystem?</p><p>Matching happens at the application level. Within the <code class="literal">jboss-web.xml</code> in the <code class="literal">WEB-INF</code> folder of our application, you need to declare the following:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jboss-web&gt;
    &lt;server-instance&gt;secure-server&lt;/server-instance&gt;
    &lt;virtual-host&gt;secure-host&lt;/virtual-host&gt;
&lt;/jboss-web&gt;</pre></div><p>The preceding XML code <a id="id752" class="indexterm"/>instructs WildFly that the application needs to be bound to the server named <code class="literal">secure-server</code>, along with the host named <code class="literal">secure-host</code>.</p><p>This way WildFly (actually Undertow) will serve your application using that specific host.</p><p>Let's view both the configurations together to better understand the matches:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>WildFly – Undertow</p>
</th><th style="text-align: left" valign="bottom">
<p>Application</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">&lt;server name="secure-server" default-host="secure-host "&gt;
    &lt;https-listener name="https" socket-binding="https" security-realm="SSLRealm"/&gt;
    &lt;host name="secure-host"&gt;
        &lt;filter-ref name="server-header"/&gt;
        &lt;filter-ref name="x-powered-by-header"/&gt;
    &lt;/host&gt;
&lt;/server&gt;</pre></div>
</td><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jboss-web&gt;
    &lt;server-instance&gt;secure-server&lt;/server-instance&gt;
    &lt;virtual-host&gt;secure-host&lt;/virtual-host&gt;
&lt;/jboss-web&gt;</pre></div>
</td></tr></tbody></table></div><p>In the <code class="literal">server</code> declaration, there is also an attribute named <code class="literal">default-host</code> set to <code class="literal">secure-host</code>, but it is just <a id="id753" class="indexterm"/>used to indicate which host to use if there is more than one.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec255"/>There's more…</h2></div></div></div><p>If you try to mix our configuration via the browser, you will notice that the <code class="literal">ssl-example</code> application will not be found using the <code class="literal">http-listener</code> configuration. The same holds true for the <code class="literal">example</code> application using the <code class="literal">https-listener</code> configuration.</p><p>If you try to open your browser and point it to <code class="literal">http://localhost:8080/ssl-example,</code> you should land on a <span class="strong"><strong>404 – Not Found</strong></span> page as seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/3744_10_07.jpg" alt="There's more…"/></div><p>The same applies if you visit <code class="literal">https://localhost:8443/no-ssl-example</code>.</p></div><div class="section" title="See also…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec256"/>See also…</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a deeper <a id="id754" class="indexterm"/>understanding of the <code class="literal">keytool</code> command, please refer to the Oracle official documentation at <a class="ulink" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html</a>.</li></ul></div></div></div>
<div class="section" title="Securing the WildFly console using HTTPS"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec92"/>Securing the WildFly console using HTTPS</h1></div></div></div><p>In this <a id="id755" class="indexterm"/>recipe, we will learn how to secure <a id="id756" class="indexterm"/>your WildFly management console at the communication protocol level. To achieve such a configuration, we will need to create a certificate which will be used to encrypt all the traffic.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec257"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">ad-hoc</code> folder to run our WildFly. In a terminal window run the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone sec-std-node-mgmt</pre></div><p>Now it's time to create our keystore which is used to encrypt data traffic.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a new terminal window and execute the following:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cd sec-std-node-mgmt/configuration
$ keytool -v -genkey -alias wildfly.management -keyalg RSA -keysize 2048 -sigalg SHA1withRSA -keystore wildfly.management.keystore -storepass keystore.2015 -keypass alias.2015

What is your first and last name?
  [Unknown]:  WildFly Cookbook
What is the name of your organizational unit?
  [Unknown]:  Packt Publishing
What is the name of your organization?
  [Unknown]:  packtpub.com
What is the name of your City or Locality?
  [Unknown]:  Birmingham
What is the name of your State or Province?
  [Unknown]:  GB
What is the two-letter country code for this unit?
  [Unknown]:  UK
Is CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK correct?
  [no]:  yes

Generating 2,048 bit RSA key pair and self-signed certificate (SHA1withRSA) with a validity of 90 days
  for: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK

[Storing wildfly.management.keystore]</pre></div></li><li class="listitem">Okay, now <a id="id757" class="indexterm"/>we have created the keystore <a id="id758" class="indexterm"/>to encrypt HTTP messages. Let's check its integrity by executing the following command:<div class="informalexample"><pre class="programlisting">$ keytool -list -v -keystore wildfly.management.keystore
Enter keystore password:

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: wildfly.management
Creation date: Nov 19, 2014
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=WildFly Cookbook, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 3bdf9d9
Valid from: Wed Nov 19 15:26:50 CET 2014 until: Tue Feb 17 15:26:50 CET 2015
Certificate fingerprints:
   MD5:  C6:D1:87:5D:93:FC:C4:55:9D:7E:77:A4:9F:94:C1:68
   SHA1: DF:B4:E6:96:D4:08:2C:58:A9:62:F1:B7:6F:F8:5E:3E:47:43:06:6F
   SHA256: E2:B9:47:D4:22:32:D7:D3:6A:A9:38:FF:E2:1F:FC:4E:A3:1A:5D:53:77:95:1E:5C:8E:A7:26:5E:89:6D:BE:44
   Signature algorithm name: SHA1withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 42 20 64 A6 07 50 7D 05   16 0F 21 25 78 1A 66 06  B d..P....!%x.f.
0010: 97 8C B3 F2                                        ....
]
]



*******************************************
*******************************************</pre></div></li></ol></div><p>Okay, everything is fine!</p><p>We are now ready to configure WildFly to expose its management console via HTTPS.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec258"/>How to do it…</h2></div></div></div><p>We are now <a id="id759" class="indexterm"/>going to make a few changes to the <a id="id760" class="indexterm"/>WildFly configuration files in order to achieve our goal. We will see both the operational modes: standalone and domain.</p><div class="section" title="Standalone"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec64"/>Standalone</h3></div></div></div><p>First of all, as we will <a id="id761" class="indexterm"/>create and use a new management realm (named <code class="literal">SecureManagementRealm</code>), we need to add a new management user (named <code class="literal">securewildfly</code>) to it.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a new terminal window and execute the following:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ java -cp modules/system/layers/base/org/jboss/sasl/main/jboss-sasl-1.0.5.Final.jar org.jboss.sasl.util.UsernamePasswordHashUtil securewildfly SecureManagementRealm cookbook.2015 &gt;&gt; sec-std-node-mgmt/configuration/secure-mgmt-users.properties</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>Be sure to clear the OS history commands after running the preceding command, because the password will be displayed as well. To clear the history, invoke a <code class="literal">history -c</code>  command in the same terminal.</p></div></div></li><li class="listitem">Now we can proceed with the effective configuration. Start WildFly as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=sec-std-node-mgmt</pre></div></li><li class="listitem">Now, within a <a id="id762" class="indexterm"/>different terminal window, connect to the WildFly CLI and run the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/jboss-cli.sh --connect
[standalone@localhost:9990 /] batch
[standalone@localhost:9990 / #] /core-service=management/security-realm=SecureManagementRealm:add()
[standalone@localhost:9990 / #] /core-service=management/security-realm=SecureManagementRealm/authentication=local:add(skip-group-loading=true, default-user="$local")
[standalone@localhost:9990 / #] /core-service=management/security-realm=SecureManagementRealm/authentication=properties:add(path=secure-mgmt-users.properties, relative-to=jboss.server.config.dir)
[standalone@localhost:9990 / #] /core-service=management/security-realm=SecureManagementRealm/authorization=properties:add(path=mgmt-groups.properties, relative-to=jboss.server.config.dir)
[standalone@localhost:9990 / #] /core-service=management/security-realm=SecureManagementRealm:write-attribute(name=map-groups-to-roles,value=false)
[standalone@localhost:9990 / #] /core-service=management/security-realm=SecureManagementRealm/server-identity=ssl:add(keystore-path=wildfly.management.keystore,keystore-relative-to=jboss.server.config.dir,keystore-password=keystore.2015,alias=wildfly.management, key-password=alias.2015)
[standalone@localhost:9990 / #] /core-service=management/management-interface=http-interface:write-attribute(name=security-realm,value=SecureManagementRealm)
[standalone@localhost:9990 / #] /core-service=management/management-interface=http-interface:write-attribute(name=secure-socket-binding,value=management-https)
[standalone@localhost:9990 / #] :reload()
[standalone@localhost:9990 / #] run-batch
The batch executed successfully
[standalone@localhost:9990 /]</pre></div></li></ol></div><p>Okay, we are done with the configuration.</p><div class="section" title="Testing"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl4sec06"/>Testing</h4></div></div></div><p>Open your browser <a id="id763" class="indexterm"/>and point it at <code class="literal">https://localhost:9993</code>:</p><div class="mediaobject"><img src="graphics/3744_10_08.jpg" alt="Testing"/><div class="caption"><p>Browser warning the user about an untrusted certificate</p></div></div><p>First, the browser will warn you about a security issue; just hit the <span class="strong"><strong>Add exception</strong></span> button, and then, in the next pop-up, hit the <span class="strong"><strong>Confirm security exception</strong></span> button.</p><p>The browser will then prompt you to enter the credentials to access the WildFly management console for the <code class="literal">SecureManagementRealm</code>; just input <code class="literal">securewildfly</code> as the username and <code class="literal">cookbook.2015</code> as the password.</p><p>You should now be <a id="id764" class="indexterm"/>inside the Web Console, as depicted in the following image:</p><div class="mediaobject"><img src="graphics/3744_10_09.jpg" alt="Testing"/><div class="caption"><p>WildFly's management console via HTTPS</p></div></div><p>Great, we are done!</p><p>By the way, securing the console via HTTPS might be okay by itself, but still, people with credentials can log into it, and mess around with it. To better secure your management console, you should concentrate on a <span class="strong"><strong>Role Based Access Control</strong></span> (<span class="strong"><strong>RBAC</strong></span>) feature, available in <a id="id765" class="indexterm"/>WildFly and discussed <a id="id766" class="indexterm"/>later in this book, which gives you finer  control over who can do what.</p></div></div><div class="section" title="Domain"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec65"/>Domain</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of <a id="id767" class="indexterm"/>all, create an <code class="literal">ad-hoc</code> folder to operate in the domain mode:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a domain sec-dmn-mgmt</pre></div></li><li class="listitem">From the <span class="emphasis"><em>Getting ready</em></span> section of this recipe, see how you can create a keystore, or copy it from the <code class="literal">sec-std-node-mgmt</code> folder (if you followed the <span class="emphasis"><em>Standalone</em></span> section steps), as follows:<div class="informalexample"><pre class="programlisting">$ cp sec-std-node-mgmt/configuration/wildfly.management.keystore sec-dmn-mgmt/configuration/</pre></div><p>Next, as we will create and use a new management realm (named <code class="literal">SecureManagementRealm</code>), we need to add a new management user (named <code class="literal">securewildfly</code>) to it.</p></li><li class="listitem">Open a new terminal window and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ java -cp modules/system/layers/base/org/jboss/sasl/main/jboss-sasl-1.0.5.Final.jar org.jboss.sasl.util.UsernamePasswordHashUtil securewildfly SecureManagementRealm cookbook.2015 &gt;&gt; sec-dmn-mgmt/configuration/secure-mgmt-users.properties</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>Be sure to clear the OS history commands after running the preceding command, because the password will be displayed as well. To clear the history, invoke a <code class="literal">history -c</code>  command in the same terminal.</p></div></div></li><li class="listitem">Now start WildFly in the domain mode as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-mgmt</pre></div></li><li class="listitem">Next, within a different terminal window, connect to the WildFly CLI and run the following:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh --connect
[domain@localhost:9990 /] batch
[domain@localhost:9990 / #] /host=master/core-service=management/security-realm=SecureManagementRealm:add()
[domain@localhost:9990 / #] /host=master/core-service=management/security-realm=SecureManagementRealm/authentication=local:add(skip-group-loading=true, default-user="$local")
[domain@localhost:9990 / #] /host=master/core-service=management/security-realm=SecureManagementRealm/authentication=properties:add(path=secure-mgmt-users.properties, relative-to=jboss.domain.config.dir)
[domain@localhost:9990 / #] /host=master/core-service=management/security-realm=SecureManagementRealm/authorization=properties:add(path=mgmt-groups.properties, relative-to=jboss.domain.config.dir)
[domain@localhost:9990 / #] /host=master/core-service=management/security-realm=SecureManagementRealm:write-attribute(name=map-groups-to-roles,value=false)
[domain@localhost:9990 / #] /host=master/core-service=management/security-realm=SecureManagementRealm/server-identity=ssl:add(keystore-path=wildfly.management.keystore,keystore-relative-to=jboss.domain.config.dir,keystore-password=keystore.2015,alias=wildfly.management, key-password=alias.2015)
[domain@localhost:9990 / #] /host=master/core-service=management/management-interface=http-interface:write-attribute(name=security-realm,value=SecureManagementRealm)
[domain@localhost:9990 / #] /host=master/core-service=management/management-interface=http-interface:write-attribute(name=secure-port,value="${jboss.management.https.port:9993}")
[domain@localhost:9990 / #] run-batch
The batch executed successfully
process-state: reload-required
[domain@localhost:9990 /] reload --host=master
Failed to establish connection in 6058ms: WFLYPRT0053: Could not connect to http-remoting://localhost:9990. The connection failed: XNIO000816: Redirect encountered establishing connection
[disconnected /]</pre></div></li></ol></div><p>We are kicked out <a id="id768" class="indexterm"/>from the console because it is not reachable on port <code class="literal">9990</code> any more, but on port <code class="literal">9993</code> (by default) instead.</p><div class="section" title="Testing"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl4sec07"/>Testing</h4></div></div></div><p>On opening a browser <a id="id769" class="indexterm"/>and pointing it to the <code class="literal">https://localhost:9993</code> URL, you will see the same as is described in the standalone mode: a security warning complaining about a self-signed certificate, the login pop up and finally the WildFly Admin Console.</p></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec259"/>How it works…</h2></div></div></div><p>First, we defined the security realm via CLI and added it to the host, in this case,  <code class="literal">master</code>. Within the new realm, we declared the keystore to be used by the HTTPS protocol to encrypt the data.</p><p>Next, we referenced the newly created <code class="literal">SecureManagementRealm</code> into the <code class="literal">http-interface</code> section of the <code class="literal">management-interface</code>. For this, we also had to specify the <code class="literal">secure-port</code>, otherwise we would have bound the whole management interface to the default port <code class="literal">9990</code>, which would have led us to a <code class="literal">ssl_error_rx_record_too_long</code> browser error.</p><p>That is all that is needed by WildFly to provide its management console via HTTPS.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec260"/>There's more…</h2></div></div></div><p>Within this recipe, we have created and used a new realm to secure the management console. Nonetheless, we could have used the default <code class="literal">ManagementRealm</code>, which was fine.</p><p>Using a different realm would free us to switch realms as needed. But more importantly, when you create a user using the <code class="literal">add-user.sh</code> script, the password being generated contains the string's username, the realm name, and the password, all of which are then hashed using MD5 and then decoded in hexadecimal value.</p><p>So, within the <code class="literal">*-user.properties</code> files of your configuration, when you see <code class="literal">username=SOMETHING</code>, you should read it as follows:</p><div class="informalexample"><pre class="programlisting">username=HEX(MD5('username':'realm':'password'))</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec261"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a deeper <a id="id770" class="indexterm"/>understanding of the <code class="literal">keytool</code> command, please refer to the Oracle official documentation at <a class="ulink" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html</a>.</li></ul></div></div></div>
<div class="section" title="Securing domain and host controller communication using HTTPS"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec93"/>Securing domain and host controller communication using HTTPS</h1></div></div></div><p>In this <a id="id771" class="indexterm"/>recipe, we will learn how to secure the <a id="id772" class="indexterm"/>communication between the domain <a id="id773" class="indexterm"/>controller and the host controller. To <a id="id774" class="indexterm"/>achieve this, we need to create a keystore and certificate, one for each controller, including the domain.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec262"/>Getting ready</h2></div></div></div><p>To get started, let's first create the <code class="literal">ad-hoc</code> folders to run our WildFly instances: one master and two hosts. In a terminal window execute the following:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a domain sec-dmn-master
$ cp -a domain sec-dmn-node-1
$ cp -a domain sec-dmn-node-2</pre></div><p>We also better prepare our configuration folders to have the proper configuration files, using the preinstalled ones as templates and executing the following:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ mv sec-dmn-master/configuration/host-master.xml sec-dmn-master/configuration/host.xml
$ mv sec-dmn-node-1/configuration/domain.xml sec-dmn-node-1/configuration/domain.xml.unused
$ mv sec-dmn-node-1/configuration/host-slave.xml sec-dmn-node-1/configuration/host.xml
$ mv sec-dmn-node-2/configuration/domain.xml sec-dmn-node-2/configuration/domain.xml.unused
$ mv sec-dmn-node-2/configuration/host-slave.xml sec-dmn-node-2/configuration/host.xml</pre></div><p>Now we can proceed towards creating the certificates.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec263"/>How to do it…</h2></div></div></div><p>We will first create the keystores for each server; we will then extract the certificates out of them, and lastly, we will import the host's certificates into the domain controller keystore and the domain certificate into the host's keystores. It will become clear soon.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a new terminal window and run the following:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ keytool -genkeypair -alias sec-dmn-master -keyalg RSA -keysize 1024 -validity 365 -keystore sec-dmn-master.jks -dname "CN=sec-dmn-master,OU=Packt Publishing,O=packtpub.com,L=Birmingham,ST=GB,C=UK" -keypass "cookbook.2015" -storepass "cookbook.2015"
$ keytool -genkeypair -alias sec-dmn-node-1 -keyalg RSA -keysize 1024 -validity 365 -keystore sec-dmn-node-1.jks -dname "CN=sec-dmn-node-1,OU=Packt Publishing,O=packtpub.com,L=Birmingham,ST=GB,C=UK" -keypass "cookbook.2015" -storepass "cookbook.2015"
$ keytool -genkeypair -alias sec-dmn-node-2 -keyalg RSA -keysize 1024 -validity 365 -keystore sec-dmn-node-2.jks -dname "CN=sec-dmn-node-2,OU=Packt Publishing,O=packtpub.com,L=Birmingham,ST=GB,C=UK" -keypass "cookbook.2015" -storepass "cookbook.2015"</pre></div></li><li class="listitem">Now <a id="id775" class="indexterm"/>we need to export the certificate <a id="id776" class="indexterm"/>out of each keystore, and store it in a file. Within the same terminal of the previous <code class="literal">keytool</code> <a id="id777" class="indexterm"/>commands, execute the following commands:<div class="informalexample"><pre class="programlisting">$ keytool -exportcert  -keystore sec-dmn-master.jks -alias sec-dmn-master -keypass "cookbook.2015" -storepass "cookbook.2015" -file sec-dmn-master.cer
$ keytool -exportcert  -keystore sec-dmn-node-1.jks -alias sec-dmn-node-1 -keypass "cookbook.2015" -storepass "cookbook.2015" -file sec-dmn-node-1.cer
$ keytool -exportcert  -keystore sec-dmn-node-2.jks -alias sec-dmn-node-2 -keypass "cookbook.2015" -storepass "cookbook.2015" -file sec-dmn-node-2.cer</pre></div></li><li class="listitem">Now if you <a id="id778" class="indexterm"/>look inside the <code class="literal">$WILDFLY_HOME</code> folder, you should see the following files:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">sec-dmn-master.cer</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">sec-dmn-master.jks</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">sec-dmn-node-1.cer</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">sec-dmn-node-1.jks</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">sec-dmn-node-2.cer</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">sec-dmn-node-2.jks</code></li></ul></div></li><li class="listitem">Now we need to import the host's certificates into the <code class="literal">domain</code> keystore, as follows:<div class="informalexample"><pre class="programlisting">$ keytool -importcert -keystore sec-dmn-master.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-node-1 -file sec-dmn-node-1.cer
Owner: CN=sec-dmn-node-1, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=sec-dmn-node-1, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 47cc055
Valid from: Mon Nov 24 15:48:33 CET 2014 until: Tue Nov 24 15:48:33 CET 2015
Certificate fingerprints:
   MD5:  BB:31:D0:6F:20:78:FB:07:70:B7:E4:68:DB:EC:2C:83
   SHA1: 83:DE:B0:D5:01:F4:8F:8C:5D:06:5E:6F:78:D1:28:A9:BF:C4:AE:18
   SHA256: B4:4C:BC:D0:C6:EC:5E:11:D0:0E:BB:5F:84:74:D4:8B:9C:EA:13:17:A6:E2:6E:1B:C2:65:DC:16:9B:F0:0D:D4
   Signature algorithm name: SHA256withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: F2 12 C7 78 60 40 26 A3   7D 43 E3 14 0F 76 46 B0  ...x`@&amp;..C...vF.
0010: 62 A8 52 40                                        b.R@
]
]

Trust this certificate? [no]:  yes
Certificate was added to keystore</pre></div></li><li class="listitem">Once <a id="id779" class="indexterm"/>done, let's do the same <a id="id780" class="indexterm"/>for the other host:<div class="informalexample"><pre class="programlisting">$ keytool -importcert -keystore sec-dmn-master.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-node-2 -file sec-dmn-node-2.cer
Owner: CN=sec-dmn-node-2, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=sec-dmn-node-2, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 4cc64451
Valid from: Mon Nov 24 15:48:34 CET 2014 until: Tue Nov 24 15:48:34 CET 2015
Certificate fingerprints:
   MD5:  29:CD:32:78:13:CD:63:7E:16:CE:AE:FC:4A:00:48:7D
   SHA1: 7D:19:1B:C9:B8:61:72:10:C1:9A:80:98:36:6F:8F:D6:B9:87:F9:83
   SHA256: 0A:5E:12:4D:EF:41:BC:AB:4C:7F:56:23:7B:80:E0:00:6C:D0:AC:7C:37:B8:FA:51:ED:2A:70:98:39:67:F7:4B
   Signature algorithm name: SHA256withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 6E 82 DC 55 F3 91 29 55   25 E7 B5 88 96 F5 1F 42  n..U..)U%......B
0010: 0A 52 7F 64                                        .R.d
]
]

Trust this certificate? [no]:  yes
Certificate was added to keystore</pre></div></li><li class="listitem">Now it's <a id="id781" class="indexterm"/>time for the hosts to <a id="id782" class="indexterm"/>import the <code class="literal">domain</code> certificate, as <a id="id783" class="indexterm"/>follows:<div class="informalexample"><pre class="programlisting">$ keytool -importcert -keystore sec-dmn-node-1.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-master -file sec-dmn-master.cer
Owner: CN=sec-dmn-master, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=sec-dmn-master, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 337c6e75
Valid from: Mon Nov 24 15:48:33 CET 2014 until: Tue Nov 24 15:48:33 CET 2015
Certificate fingerprints:
   MD5:  20:B4:7F:FB:E6:E5:6C:A8:29:82:19:2B:F7:56:90:B8
   SHA1: 1F:1D:64:49:F5:B5:A4:CC:B7:CA:4C:15:3C:E6:75:C4:E6:03:09:F7
  SHA256: C0:66:C8:FF:E3:B8:CD:5B:6D:99:61:1D:6B:05:19:
  F0:05:B1:28:D0:4D:96:CB:AC:B4:89:FB:2B:73:01:7D:04
   Signature algorithm name: SHA256withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 3B 84 5D 1C 5D C1 F6 EF   8C 2B AF C6 80 D7 03 89  ;.].]....+......
0010: F9 0A 6D CE                                        ..m.
]
]

Trust this certificate? [no]:  yes
Certificate was added to keystore</pre></div></li><li class="listitem">Once <a id="id784" class="indexterm"/>done, let's do the same <a id="id785" class="indexterm"/>for the other host:<div class="informalexample"><pre class="programlisting">$ keytool -importcert -keystore sec-dmn-node-2.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-master -file sec-dmn-master.cer
Owner: CN=sec-dmn-master, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Issuer: CN=sec-dmn-master, OU=Packt Publishing, O=packtpub.com, L=Birmingham, ST=GB, C=UK
Serial number: 337c6e75
Valid from: Mon Nov 24 15:48:33 CET 2014 until: Tue Nov 24 15:48:33 CET 2015
Certificate fingerprints:
   MD5:  20:B4:7F:FB:E6:E5:6C:A8:29:82:19:2B:F7:56:90:B8
   SHA1: 1F:1D:64:49:F5:B5:A4:CC:B7:CA:4C:15:3C:E6:75:C4:E6:03:09:F7
   SHA256: C0:66:C8:FF:E3:B8:CD:5B:6D:99:61:1D:6B:05:19:F0:05:B1:28:D0:4D:96:CB:AC:B4:89:FB:2B:73:01:7D:04
   Signature algorithm name: SHA256withRSA
   Version: 3

Extensions:

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 3B 84 5D 1C 5D C1 F6 EF   8C 2B AF C6 80 D7 03 89  ;.].]....+......
0010: F9 0A 6D CE                                        ..m.
]
]

Trust this certificate? [no]:  yes
Certificate was added to keystore</pre></div></li><li class="listitem">Okay, we <a id="id786" class="indexterm"/>are done. Let's copy each <a id="id787" class="indexterm"/>keystore to its <code class="literal">ad-hoc</code> configuration folder, as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp sec-dmn-master.jks sec-dmn-master/configuration/
$ cp sec-dmn-node-1.jks sec-dmn-node-1/configuration/
$ cp sec-dmn-node-2.jks sec-dmn-node-2/configuration/</pre></div></li><li class="listitem">Now we <a id="id788" class="indexterm"/>need to make some <a id="id789" class="indexterm"/>adjustments to the default domain configuration. Open the <code class="literal">sec-dmn-master/configuration/domain.xml</code> file and set the <code class="literal">default</code> profile to all <code class="literal">server-groups</code> declared in the file. Also set the <code class="literal">socket-binding-group</code> reference to <code class="literal">standard-sockets</code>, again to all the declared server-groups—we are doing this just to avoid complex configuration due to the <code class="literal">full</code> and <code class="literal">full-ha</code> profiles, which involve messaging and clustering.</li><li class="listitem">Next, open <code class="literal">sec-dmn-node-1/configuration/host.xml</code> and change the host name as follows:<div class="informalexample"><pre class="programlisting">&lt;host name="sec-dmn-node-1" &gt;</pre></div></li><li class="listitem">Also make sure to properly set the port-offset attribute for each configured server (default configuration provides two servers named <code class="literal">server-one</code> and <code class="literal">server-two</code>), as per the following example:<div class="informalexample"><pre class="programlisting">server-one - &lt;socket-bindings port-offset="100"/&gt;
server-two - &lt;socket-bindings port-offset="150"/&gt;</pre></div></li><li class="listitem">Let's do the same for the other host. Open <code class="literal">sec-dmn-node-2/configuration/host.xml</code> and change the host name as follows:<div class="informalexample"><pre class="programlisting">&lt;host name="sec-dmn-node-2" &gt;</pre></div></li><li class="listitem">Here too, make sure to properly set the port-offset attribute for each configured server, as follows:<div class="informalexample"><pre class="programlisting">server-one – &lt;socket-bindings port-offset="200"/&gt;
server-two - &lt;socket-bindings port-offset="250"/&gt;</pre></div><p>We are not done yet. We need to configure our keystores, and we will use the CLI, so all our servers must be up and running.</p></li><li class="listitem">Let's <a id="id790" class="indexterm"/>start them up by executing <a id="id791" class="indexterm"/>each of the following <a id="id792" class="indexterm"/>commands in a separate <a id="id793" class="indexterm"/>terminal window:<div class="informalexample"><pre class="programlisting">$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-master
$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-node-1 -Djboss.management.native.port=19999 -Djboss.domain.master.address=127.0.0.1
$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-node-2 -Djboss.management.native.port=29999 -Djboss.domain.master.address=127.0.0.1</pre></div></li><li class="listitem">At this point, we need to declare our keystore into the WildFly configuration files. Again, in a separate terminal window, connect to the CLI as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/jboss-cli.sh -c
batch
/host=master/core-service=management/security-realm=DCHCSecureRealm:add()
/host=master/core-service=management/security-realm=DCHCSecureRealm/server-identity=ssl:add(alias=sec-dmn-master,keystore-relative-to=jboss.domain.config.dir,keystore-path=sec-dmn-master.jks,keystore-password=cookbook.2015)
/host=master/core-service=management/security-realm=DCHCSecureRealm/authentication=truststore:add(keystore-relative-to=jboss.domain.config.dir,keystore-path=sec-dmn-master.jks,keystore-password=cookbook.2015)
/host=master/core-service=management/security-realm=DCHCSecureRealm/authentication=local:add(default-user=\$local)
/host=master/core-service=management/security-realm=DCHCSecureRealm/authentication=properties:add(relative-to=jboss.domain.config.dir,path=mgmt-users.properties)
/host=master/core-service=management/management-interface=native-interface:write-attribute(name=security-realm,value=DCHCSecureRealm)
/host=sec-dmn-node-1/core-service=management/security-realm=DCHCSecureRealm:add()
/host=sec-dmn-node-1/core-service=management/security-realm=DCHCSecureRealm/server-identity=ssl:add(alias=sec-dmn-node-1,keystore-relative-to=jboss.domain.config.dir,keystore-path=sec-dmn-node-1.jks,keystore-password=cookbook.2015)
/host=sec-dmn-node-1/core-service=management/security-realm=DCHCSecureRealm/authentication=truststore:add(keystore-relative-to=jboss.domain.config.dir,keystore-path=sec-dmn-node-1.jks,keystore-password=cookbook.2015)
/host=sec-dmn-node-1/core-service=management/security-realm=DCHCSecureRealm/authentication=local:add(default-user="\$local")
/host=sec-dmn-node-1/core-service=management/security-realm=DCHCSecureRealm/authentication=properties:add(relative-to=jboss.domain.config.dir,path=mgmt-users.properties)
/host=sec-dmn-node-1/core-service=management/management-interface=native-interface:write-attribute(name=security-realm,value=DCHCSecureRealm)
/host=sec-dmn-node-1:write-remote-domain-controller(security-realm=DCHCSecureRealm)
/host=sec-dmn-node-2/core-service=management/security-realm=DCHCSecureRealm:add()
/host=sec-dmn-node-2/core-service=management/security-realm=DCHCSecureRealm/server-identity=ssl:add(alias=sec-dmn-node-2,keystore-relative-to=jboss.domain.config.dir,keystore-path=sec-dmn-node-2.jks,keystore-password=cookbook.2015)
/host=sec-dmn-node-2/core-service=management/security-realm=DCHCSecureRealm/authentication=truststore:add(keystore-relative-to=jboss.domain.config.dir,keystore-path=sec-dmn-node-2.jks,keystore-password=cookbook.2015)
/host=sec-dmn-node-2/core-service=management/security-realm=DCHCSecureRealm/authentication=local:add(default-user="\$local")
/host=sec-dmn-node-2/core-service=management/security-realm=DCHCSecureRealm/authentication=properties:add(relative-to=jboss.domain.config.dir,path=mgmt-users.properties)
/host=sec-dmn-node-2/core-service=management/management-interface=native-interface:write-attribute(name=security-realm,value=DCHCSecureRealm)
/host=sec-dmn-node-2:write-remote-domain-controller(security-realm=DCHCSecureRealm)
run-batch
reload --host=master</pre></div><p>For the moment, just don't mind about the errors; we need one more step.</p></li><li class="listitem">Stop the <a id="id794" class="indexterm"/>domain controller along with <a id="id795" class="indexterm"/>the host controllers and start <a id="id796" class="indexterm"/>them as follows:<div class="informalexample"><pre class="programlisting">$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-master -Djavax.net.ssl.trustStore=$WILDFLY_HOME/sec-dmn-master/configuration/sec-dmn-master.jks
$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-node-1 -Djboss.management.native.port=19999 -Djboss.domain.master.address=127.0.0.1 -Djavax.net.ssl.trustStore=$WILDFLY_HOME/sec-dmn-node-1/configuration/sec-dmn-node-1.jks
$ ./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-node-2 -Djboss.management.native.port=29999 -Djboss.domain.master.address=127.0.0.1 -Djavax.net.ssl.trustStore=$WILDFLY_HOME/sec-dmn-node-2/configuration/sec-dmn-node-2.jks</pre></div></li></ol></div><p>Now the domain <a id="id797" class="indexterm"/>controller is communicating with the host controllers using HTTPS.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec264"/>How it works…</h2></div></div></div><p>Let's try to explain in words what we needed and we what have done so far.</p><p>We needed to encrypt the traffic between the domain controller and the host controllers. To achieve this, we need a certificate. Thus, because communication between the domain and host controllers requires authentication, we also needed to create a kind of trusted communication between them. All this mechanism can be achieved using Java keystores.</p><p>We first create the keystore for the domain and the host controllers:</p><div class="informalexample"><pre class="programlisting">$ keytool -genkeypair -alias sec-dmn-master -keyalg RSA -keysize 1024 -validity 365 -keystore sec-dmn-master.jks -dname "CN=sec-dmn-master,OU=Packt Publishing,O=packtpub.com,L=Birmingham,ST=GB,C=UK" -keypass "cookbook.2015" -storepass "cookbook.2015"
$ keytool -genkeypair -alias sec-dmn-node-1 -keyalg RSA -keysize 1024 -validity 365 -keystore sec-dmn-node-1.jks -dname "CN=sec-dmn-node-1,OU=Packt Publishing,O=packtpub.com,L=Birmingham,ST=GB,C=UK" -keypass "cookbook.2015" -storepass "cookbook.2015"
$ keytool -genkeypair -alias sec-dmn-node-2 -keyalg RSA -keysize 1024 -validity 365 -keystore sec-dmn-node-2.jks -dname "CN=sec-dmn-node-2,OU=Packt Publishing,O=packtpub.com,L=Birmingham,ST=GB,C=UK" -keypass "cookbook.2015" -storepass "cookbook.2015"</pre></div><p>We then extract a certificate out of each keystore, and store it in a <code class="literal">cer</code> file:</p><div class="informalexample"><pre class="programlisting">$ keytool -exportcert  -keystore sec-dmn-master.jks -alias sec-dmn-master -keypass "cookbook.2015" -storepass "cookbook.2015" -file sec-dmn-master.cer
$ keytool -exportcert  -keystore sec-dmn-node-1.jks -alias sec-dmn-node-1 -keypass "cookbook.2015" -storepass "cookbook.2015" -file sec-dmn-node-1.cer
$ keytool -exportcert  -keystore sec-dmn-node-2.jks -alias sec-dmn-node-2 -keypass "cookbook.2015" -storepass "cookbook.2015" -file sec-dmn-node-2.cer</pre></div><p>As we <a id="id798" class="indexterm"/>need the domain controller to remotely <a id="id799" class="indexterm"/>connect to the host controllers <a id="id800" class="indexterm"/>and vice versa, we needed to create a link within the keystore, thus importing the host controllers' certificates into the domain controller keystore:</p><div class="informalexample"><pre class="programlisting">$ keytool -importcert -keystore sec-dmn-master.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-node-1 -file sec-dmn-node-1.cer
$ keytool -importcert -keystore sec-dmn-master.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-node-2 -file sec-dmn-node-2.cer</pre></div><p>This way, the <code class="literal">sec-dmn-master.jks</code> keystore file would work as a truststore too, having the host controllers' certificates in it. As a matter of fact, on checking the <code class="literal">sec-dmn-master.jks</code> keystore, we should find three entries in it:</p><div class="informalexample"><pre class="programlisting">$ keytool -list -v -keystore sec-dmn-master.jks
Enter keystore password:

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 3 entries

Alias name: sec-dmn-node-2

...

Alias name: sec-dmn-node-1

...

Alias name: sec-dmn-master
...</pre></div><p>The same mechanism applies to the host controllers, having them only import the domain controller's certificate:</p><div class="informalexample"><pre class="programlisting">$ keytool -importcert -keystore sec-dmn-node-1.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-master -file sec-dmn-master.cer
$ keytool -importcert -keystore sec-dmn-node-2.jks -storepass "cookbook.2015" -trustcacerts -alias sec-dmn-master -file sec-dmn-master.cer</pre></div><p>For brevity, I will not show you the check list for those two keystores; by the way you can issue the commands as follows:</p><div class="informalexample"><pre class="programlisting">keytool -list -v -keystore sec-dmn-node-1.jks
keytool -list -v -keystore sec-dmn-node-2.jks</pre></div><p>They should both contain two entries.</p><p>After all this <a id="id801" class="indexterm"/>preparation, we had to start all servers <a id="id802" class="indexterm"/>in order to update our configuration. This is because in the domain mode we can only see the running hosts, not the declared ones. We then ran the CLI and executed a bunch of commands in the batch mode.</p><p>After the <code class="literal">run-batch</code> command, which essentially runs each command and commits, we run the <code class="literal">reload</code> command against the <code class="literal">host=master</code>, that is the domain controller.</p><p>When the domain controller starts, it pushes its configuration to all the connected host controllers, but in this case, our host controllers got disconnected because of the following errors showing up in the <code class="literal">server.log</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The following error is for <code class="literal">sec-dmn-master</code>:<div class="informalexample"><pre class="programlisting">[Host Controller] ERROR [org.jboss.remoting.remote.connection] JBREM000200: Remote connection failed: javax.net.ssl.SSLException: Received fatal alert: certificate_unknown</pre></div></li><li class="listitem" style="list-style-type: disc">The <a id="id803" class="indexterm"/>following error is for <code class="literal">sec-dmn-node-1</code>:<div class="informalexample"><pre class="programlisting">[Host Controller] WARN  [org.jboss.as.host.controller] JBAS010914: Connection to remote host-controller closed.
[Host Controller] INFO  [org.jboss.as.host.controller] JBAS016584: Trying to reconnect to master host controller.
[Host Controller] WARN  [org.jboss.as.host.controller] JBAS010900: Could not connect to remote domain controller at remote://127.0.0.1:9999 -- java.net.ConnectException: JBAS012174: Could not connect to remote://127.0.0.1:9999. The connection failed
[Host Controller] WARN  [org.jboss.as.host.controller] JBAS016581: No domain controller discovery options remain.
[Host Controller] INFO  [org.jboss.as.host.controller] JBAS016584: Trying to reconnect to master host controller.
[Host Controller] WARN  [org.jboss.as.host.controller] JBAS010900: Could not connect to remote domain controller at remote://127.0.0.1:9999 -- java.lang.IllegalStateException: JBAS016509: Unable to connect due to SSL failure.</pre></div></li><li class="listitem" style="list-style-type: disc">The following <a id="id804" class="indexterm"/>error is for <code class="literal">sec-dmn-node-2</code>:<div class="informalexample"><pre class="programlisting">[Host Controller] WARN  [org.jboss.as.host.controller] JBAS010914: Connection to remote host-controller closed.
[Host Controller] INFO  [org.jboss.as.host.controller] JBAS016584: Trying to reconnect to master host controller.
[Host Controller] WARN  [org.jboss.as.host.controller] JBAS010900: Could not connect to remote domain controller at remote://127.0.0.1:9999 -- java.net.ConnectException: JBAS012174: Could not connect to remote://127.0.0.1:9999. The connection failed
[Host Controller] WARN  [org.jboss.as.host.controller] JBAS016581: No domain controller discovery options remain.
[Host Controller] INFO  [org.jboss.as.host.controller] JBAS016584: Trying to reconnect to master host controller.
[Host Controller] WARN  [org.jboss.as.host.controller] JBAS010900: Could not connect to remote domain controller at remote://127.0.0.1:9999 -- java.lang.IllegalStateException: JBAS016509: Unable to connect due to SSL failure.</pre></div></li></ul></div><p> The domain controller enabled the SSL communication, and the host controllers are not passing their own certificate because the default JVM <code class="literal">cacert</code> truststore file is passed instead. That's why we had to stop everything.</p><p>When restarting the domain and host controllers, we had to add the <code class="literal">-Djavax.net.ssl.trustStore</code> property (specifying the proper keystore for the starting controller) so that the SSL Handshake phase would succeed, because at this time each controller would have passed its relative keystore.</p><p>Follow the <a id="id805" class="indexterm"/>commands to start the domain <a id="id806" class="indexterm"/>and host controllers:</p><div class="informalexample"><pre class="programlisting">./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-master -Djavax.net.ssl.trustStore=$WILDFLY_HOME/sec-dmn-master/configuration/sec-dmn-master.jks
./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-node-1 -Djboss.management.native.port=19999 -Djboss.domain.master.address=127.0.0.1 -Djavax.net.ssl.trustStore=$WILDFLY_HOME/sec-dmn-node-1/configuration/sec-dmn-node-1.jks
./bin/domain.sh -Djboss.domain.base.dir=sec-dmn-node-2 -Djboss.management.native.port=29999 -Djboss.domain.master.address=127.0.0.1 -Djavax.net.ssl.trustStore=$WILDFLY_HOME/sec-dmn-node-2/configuration/sec-dmn-node-2.jks</pre></div></div><div class="section" title="See also…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec265"/>See also…</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a <a id="id807" class="indexterm"/>deeper understanding of the <code class="literal">keytool</code> command, please refer to the Oracle official documentation at <a class="ulink" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html</a>.</li><li class="listitem" style="list-style-type: disc">For more details <a id="id808" class="indexterm"/>on the <code class="literal">SSL</code> protocol, start looking at <a class="ulink" href="http://en.wikipedia.org/wiki/Transport_Layer_Security">http://en.wikipedia.org/wiki/Transport_Layer_Security</a>.</li></ul></div></div></div></body></html>