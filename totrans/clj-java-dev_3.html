<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;3.&#xA0;Interacting with Java" id="OPEK1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03" class="calibre1"/>Chapter 3. Interacting with Java</h1></div></div></div><p class="calibre7">We know a bit about how to organize our code and how that relates to packages in Java. Now, you surely need to use your old Java code and all the libraries you already know; Clojure encourages a new way to think about programming and it also allows you to use all the dependencies and code that you've already generated.</p><p class="calibre7">Clojure is a <span class="strong"><strong class="calibre8">Java Virtual Machine</strong></span> (<span class="strong"><strong class="calibre8">JVM</strong></span>) language <a id="id78" class="calibre1"/>and as such it is compatible with most Java dependencies and libraries out there; you should be able to use all the tools out there. You should also be able to use your Clojure programs with Java-only programs, this requires a bit of custom coding but in the end you can use Clojure in the right places of your project.</p><p class="calibre7">To be able to do this, we'll have to learn:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Using Maven dependencies</li><li class="listitem">Using plain old Java classes from your Clojure code base</li><li class="listitem">A bit more about the Clojure language, in particular the <code class="email">let</code> statements and destructuring</li><li class="listitem">Creating a Java interface for your Clojure code</li><li class="listitem">Using the Java interface from other Java projects</li></ul></div></div>

<div class="book" title="Chapter&#xA0;3.&#xA0;Interacting with Java" id="OPEK1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Using Maven dependencies"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch03lvl1sec20" class="calibre1"/>Using Maven dependencies</h1></div></div></div><p class="calibre7">Let's say<a id="id79" class="calibre1"/> that we want to write an image manipulation program; it is a very simple program that should be able to create thumbnails. Most of our codebase is in Clojure, so we want to write this in Clojure too.</p><p class="calibre7">There are a bunch of Java libraries meant to manipulate images, we decide to use imgscalr, which is very simple to use and it looks like it is available in<a id="id80" class="calibre1"/> Maven Central (<a class="calibre1" href="http://search.maven.org/">http://search.maven.org/</a>).</p><p class="calibre7">Let's create a new Leiningen project, as shown:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre8">lein new thumbnails</strong></span>
</pre></div><p class="calibre7">Now, we need to edit the <code class="email">project.clj</code> file in the thumbnails project:</p><div class="informalexample"><pre class="programlisting">(defproject thumbnails "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.6.0"]])</pre></div><p class="calibre7">You can add the <code class="email">imgscalr</code> dependency similar to the following code:</p><div class="informalexample"><pre class="programlisting">(defproject thumbnails "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.6.0"]
                 [org.imgscalr/imgscalr-lib "4.2"]])</pre></div><p class="calibre7">As you can <a id="id81" class="calibre1"/>see, you just need to add a dependency to the <code class="email">:dependencies</code> vector, the dependencies are automatically resolved from:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Maven Local</li><li class="listitem">Maven Central</li><li class="listitem">Clojars</li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note11" class="calibre1"/>Note</h3><p class="calibre7">The Maven Local points to your local maven repository that is in the <code class="email">~/.m2</code> folder. If you wish, you can change it with Leiningen's <code class="email">:local-repo</code> key.</p></div><p class="calibre7">You can add your own repositories, let's say you need to add <a id="id82" class="calibre1"/>
<span class="strong"><strong class="calibre8">jcenter</strong></span> (Bintray's Java repository) you can do so, as shown:</p><div class="informalexample"><pre class="programlisting">(defproject thumbnails "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.6.0"]
                 [org.imgscalr/imgscalr-lib "4.2"]]
  :repositories [["jcenter" "http://jcenter.bintray.com/"]])</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note12" class="calibre1"/>Note</h3><p class="calibre7">Leiningen supports a wide array of options to configure your project, for more information you can check the sample at Leiningen's official repository: <a class="calibre1" href="https://github.com/technomancy/leiningen/blob/master/sample.project.clj">https://github.com/technomancy/leiningen/blob/master/sample.project.clj</a>.</p></div><p class="calibre7">In order to download the dependencies, you have to execute the following code:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre8">lein deps</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip06" class="calibre1"/>Tip</h3><p class="calibre7">You don't need to execute <code class="email">lein deps</code> every time you want to download dependencies, you can do it to force a download but Leiningen will automatically download them when it needs to.</p></div><p class="calibre7">You can <a id="id83" class="calibre1"/>check the current dependencies by running:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre8">lein deps :tree</strong></span>
</pre></div><p class="calibre7">You will get something similar to this:</p><div class="informalexample"><pre class="programlisting"> [clojure-complete "0.2.3" :scope "test" :exclusions [[org.clojure/clojure]]]
 [org.clojure/clojure "1.6.0"]
 [org.clojure/tools.nrepl "0.2.6" :scope "test" :exclusions [[org.clojure/clojure]]]
 [org.imgscalr/imgscalr-lib "4.2"]</pre></div><p class="calibre7">This lists your current dependency tree.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Clojure interop syntax" id="PNV61-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec21" class="calibre1"/>Clojure interop syntax</h1></div></div></div><p class="calibre7">Clojure was designed to <a id="id84" class="calibre1"/>be a Hosted Language, which means that it can run in different environments or runtimes. One important philosophy aspect is that Clojure does not attempt to get in the way of your original host; this allows you to use your knowledge of the underlying platform to your advantage.</p><p class="calibre7">In this case, we are using the Java platform. Let's look at the basic interrupt syntax that we need to know.</p></div>

<div class="book" title="Clojure interop syntax" id="PNV61-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Creating an object"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec23" class="calibre1"/>Creating an object</h2></div></div></div><p class="calibre7">There <a id="id85" class="calibre1"/>are two ways to create an object in Clojure; for example, let's have a look at how to create an instance of <code class="email">java.util.ArrayList</code>.</p><div class="informalexample"><pre class="programlisting">(def a (new java.util.ArrayList 20))</pre></div><p class="calibre7">Here, we are using the <code class="email">new</code> special form, as you can see it receives a symbol (the name of the class <code class="email">java.util.ArrayList</code>) and in this case it is an integer.</p><p class="calibre7">The symbol <code class="email">java.util.ArrayList</code> represents the <code class="email">classname</code> and any Java class name will do here.</p><p class="calibre7">Next, you<a id="id86" class="calibre1"/> can actually pass any number of parameters (including <code class="email">0</code> parameters). The next parameters are the parameters of the constructor.</p><p class="calibre7">Lets have a look at the other special syntax that is available to create objects:</p><div class="informalexample"><pre class="programlisting">(def a (ArrayList.))</pre></div><p class="calibre7">The difference here is that we have a trailing dot; we prefer to see this syntax since it is shorter.</p></div></div>

<div class="book" title="Clojure interop syntax" id="PNV61-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Calling an instance method"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec24" class="calibre1"/>Calling an instance method</h2></div></div></div><p class="calibre7">Once we <a id="id87" class="calibre1"/>have created our object we can call instance methods. This is done similar to how we call Clojure functions, using the special dot form.</p><p class="calibre7">If we want to add an element to our newly created list, we will have to do it, as shown:</p><div class="informalexample"><pre class="programlisting">(. add a 5)</pre></div><p class="calibre7">This syntax might look a little strange; here is how this syntax is formed:</p><div class="informalexample"><pre class="programlisting">(. instance method-name args*)</pre></div><p class="calibre7">Similar to the two different options that we had when creating an object, we have another way to do this:</p><div class="informalexample"><pre class="programlisting">(.method-name instance args*)</pre></div><p class="calibre7">You might think that this is more familiar, since the method name starting with a dot resembles how we write the Java method calls.</p></div></div>

<div class="book" title="Clojure interop syntax" id="PNV61-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Calling a static method or function"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch03lvl2sec25" class="calibre1"/>Calling a static method or function</h2></div></div></div><p class="calibre7">Being<a id="id88" class="calibre1"/> able to call methods and create objects gives us a great deal of power, with this simple construct we have gained a lot of power; we can now use most of the Java standard libraries and also the custom ones.</p><p class="calibre7">However, we <a id="id89" class="calibre1"/>still need a few more things; one of the most important ones is calling static methods. The static methods have a feel similar to Clojure functions, there is no <code class="email">this</code> instance, you can simply call them as normal Clojure functions.</p><p class="calibre7">For instance, if we want an <code class="email">emptyMap</code> from the <code class="email">Collections</code> class, we can do it as shown:</p><div class="informalexample"><pre class="programlisting">(java.util.Collections/emptyMap)</pre></div><p class="calibre7">You can think of static methods as functions and the class as a namespace. It is not exactly right but the mental model will help you understand it easily.</p></div></div>

<div class="book" title="Clojure interop syntax" id="PNV61-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Accessing inner classes"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch03lvl2sec26" class="calibre1"/>Accessing inner classes</h2></div></div></div><p class="calibre7">Another <a id="id90" class="calibre1"/>common doubt when using Java – Clojure interop is how to access inner classes.</p><p class="calibre7">Imagine you want to represent a single entry from a map with the <code class="email">java.util.AbstractMap.SimpleEntry</code> class.</p><p class="calibre7">You might think that we have to do something similar to this:</p><div class="informalexample"><pre class="programlisting">(java.util.AbstractMap.SimpleEntry. "key" "value")</pre></div><p class="calibre7">That's what you will normally do when writing Java, but in Clojure you might need to do something such as this:</p><div class="informalexample"><pre class="programlisting">(java.util.AbstractMap$SimpleEntry. "key" "value")</pre></div><p class="calibre7">What we are seeing here is actually an exposed implementation detail; if you look at the classes in the JAR files or in your classpath, you will see the precise file name <code class="email">AbstractMap$SimpleEntry</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00008.jpeg" alt="Accessing inner classes" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">This is what you need to keep in mind, always prefix the inner classes with the parent (or more correctly containing) class (in this case <code class="email">java.util.AbstractMap</code>) and the dollar sign.</p></div></div>
<div class="book" title="Writing a simple image namespace" id="QMFO1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec22" class="calibre1"/>Writing a simple image namespace</h1></div></div></div><p class="calibre7">Let's <a id="id91" class="calibre1"/>now write some Clojure code and create a file in <code class="email">src/thumbnails/image.clj</code>.</p><p class="calibre7">Let's try to do this the Clojure way. First of all, write the namespace declaration and evaluate it:</p><div class="informalexample"><pre class="programlisting">(ns thumbnails.image
  (:require [clojure.java.io :as io])
  (:import [javax.imageio ImageIO]
           [java.awt.image BufferedImageOp]
           [org.imgscalr Scalr Scalr$Mode]))</pre></div><p class="calibre7">Now open up a REPL and write the following code:</p><div class="informalexample"><pre class="programlisting">(def image-stream (io/input-stream "http://imgs.xkcd.com/comics/angular_momentum.jpg"))(def image (ImageIO/read image-stream))
image
(.getWidth image)</pre></div><p class="calibre7">We now have <a id="id92" class="calibre1"/>an image instance and you can call all of the Java methods in the REPL. This is one of Clojure's core concepts, you can play with the REPL and check your code before really writing it and you can do it in an interactive way, as shown:</p><div class="mediaobject"><img src="../images/00009.jpeg" alt="Writing a simple image namespace" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">In the end, we want to stick<code class="email"> </code>with the following contents:</p><div class="informalexample"><pre class="programlisting">(ns thumbnails.image
  (:require [clojure.java.io :as io])
  (:import [javax.imageio ImageIO]
           [java.awt.image BufferedImageOp]
           [org.imgscalr Scalr Scalr$Mode]))


(defn load-image [image-stream]
  (ImageIO/read image-stream))

(defn save-image [image path]
  (ImageIO/write image "PNG" (io/output-stream path)))

(defn image-size [image]
  [(.getWidth image) (.getHeight image)])

(defn generate-thumbnail [image size]
  (Scalr/resize image Scalr$Mode/FIT_TO_WIDTH size (into-array BufferedImageOp [])))

(defn get-image-width [image-path]
  (let [image (load-image image-path)
        [w _] (image-size image)]
    w))</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip07" class="calibre1"/>Tip</h3><p class="calibre7">You can see that in this code we use the inner class syntax, with <code class="email">Scalr$Mode</code>. Mode is not actually a class but an <code class="email">enum</code>, you can use the same syntax for all other inner types.</p></div><p class="calibre7">The code is <a id="id93" class="calibre1"/>pretty simple, it is very similar to what you've already seen; we'll go through the differences either way.</p><p class="calibre7">You can import the following classes:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">javax.imageio.ImageIO</code></li><li class="listitem"><code class="email">java.awt.image.BufferedImageOp</code></li><li class="listitem"><code class="email">org.imgscalr.Scalr</code></li><li class="listitem"><code class="email">org.imgscalr.Scalr.Mode</code></li></ul></div><p class="calibre7">You have to be careful with the <code class="email">Mode</code> class, since it is an inner class (it is inside another class) Clojure uses the special name <code class="email">Scalr$Mode</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip08" class="calibre1"/>Tip</h3><p class="calibre7">When importing inner classes, you have to be careful with the naming process, in Java you will use the name: <code class="email">org.imgscalr.Scalr.Mode</code>; in Clojure you use the name: <code class="email">org.imgscalr.Scalr$Mode</code>. The <code class="email">load-image</code>, <code class="email">save-image</code>, and <code class="email">image-size</code> functions are self explanatory and the <code class="email">generate-thumbnail</code> function is pretty simple as well; however, it has a special detail, it calls the following as the last argument:</p><div class="informalexample"><pre class="programlisting">(into-array BufferedImageOp [])</pre></div></div><p class="calibre7">If you look at the <a id="id94" class="calibre1"/>ImageScalr javadoc, (<a class="calibre1" href="http://javadox.com/org.imgscalr/imgscalr-lib/4.2/org/imgscalr/Scalr.Mode.html">http://javadox.com/org.imgscalr/imgscalr-lib/4.2/org/imgscalr/Scalr.Mode.html</a>) you can see that the <code class="email">resize</code> method has several overloaded implementations; most of them have a <code class="email">varargs</code> argument as their last argument. In Clojure, you have to declare these <code class="email">varargs</code> arguments as an array.</p></div>

<div id="page" style="height:0pt"/><div class="book" title="Writing the tests" id="RL0A1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec23" class="calibre1"/>Writing the tests</h1></div></div></div><p class="calibre7">Now that you <a id="id95" class="calibre1"/>have written your image processing code, it is a good time to write the tests.</p><p class="calibre7">Let's just check if we can generate a thumbnail. Create a new <code class="email">thumbnails.thumbnail-test</code> namespace, in the tests.</p><p class="calibre7">Remember, if you create the file, it must be named <code class="email">test/thumbnails/thumbnail_test.clj</code>.</p><p class="calibre7">Add the <a id="id96" class="calibre1"/>following contents to it:</p><div class="informalexample"><pre class="programlisting">(ns thumbnails.thumbnail-test
  (:require [clojure.test :refer :all]
            [clojure.java.io :as io]
            [thumbnails.image :refer :all]))

(deftest test-image-width
  (testing "We should be able to get the image with"
    (let [image-stream (io/input-stream "http://imgs.xkcd.com/comics/angular_momentum.jpg")
          image (load-image image-stream)]
      (save-image image "xkcd-width.png")
      (is (= 600 (get-image-width (io/input-stream "xkcd-width.png")))))))

(deftest test-load-image
  (testing "We should be able to generate thumbnails"
    (let [image-stream (io/input-stream "http://imgs.xkcd.com/comics/angular_momentum.jpg")
          image (load-image image-stream)
          thumbnail-image (generate-thumbnail image 50)]
      (save-image thumbnail-image "xkcd.png")
      (is (= 50 (get-image-width (io/input-stream "xkcd.png")))))))</pre></div><p class="calibre7">Here we are using some unknown features, such as the <code class="email">let</code> form and destructuring. We will see this in more detail in the next section.</p></div>

<div class="book" title="Writing the tests" id="RL0A1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="The let statement"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec27" class="calibre1"/>The let statement</h2></div></div></div><p class="calibre7">Clojure <a id="id97" class="calibre1"/>gives us a <code class="email">let</code> statement to name things; it allows us to do something very similar to variable declaration in other languages.</p><p class="calibre7">Keep in mind that we are not actually creating a variable in the same sense, as in Java. In Java, whenever we declare a variable. We state that we want to reserve a certain amount of memory to store something in the later stages; it can be a value for primitives or a memory location for objects. What we do here is simply name a value. This is a local scope that is useful to write cleaner and easier to understand code. Lets have a look at how it works:</p><div class="informalexample"><pre class="programlisting">(let [x 42] x)</pre></div><p class="calibre7">This is the simplest <code class="email">let</code> statement that we could write and it is exactly the same as just writing <code class="email">42</code>. However, we can write something a little more complex, such as this:</p><div class="informalexample"><pre class="programlisting">(let [x 42
      y (* x x)]
  (println "x is " x " and y " y))</pre></div><p class="calibre7">It looks <a id="id98" class="calibre1"/>self explanatory; to value <code class="email">42</code> and <code class="email">y,</code> we are assigning the value of multiplying <code class="email">42</code> by <code class="email">42</code>. In the end, we print <code class="email">x is 42 and y 1764</code>. It is important to note two things here:</p><div class="book"><ul class="itemizedlist"><li class="listitem">We can use a previously defined value in the <code class="email">let</code> statement; for example, we use <code class="email">x</code> when defining <code class="email">y</code>.</li><li class="listitem">The <code class="email">let</code> statement creates a scope, we can't use <code class="email">x</code> or <code class="email">y</code> outside of our <code class="email">let </code>statement.</li></ul></div><p class="calibre7">The <code class="email">let</code> statement can even be nested, we could do something similar to the following example:</p><div class="informalexample"><pre class="programlisting">(let [x 42]
  (let [y (* x x)]
    (println "x is " x " and y " y)))</pre></div><p class="calibre7">It is a bit more complicated, since we are opening an unneeded set of parentheses and also writing more code; however, it allows us to see how lexical scope works.</p><p class="calibre7">Lets have a look at another interesting example:</p><div class="informalexample"><pre class="programlisting">(let [x 42]
  (let [y (* x x)]
    (let [x 41]
      (println "x is " x " and y " y))))</pre></div><p class="calibre7">In here, we are masking the value of <code class="email">x</code> with <code class="email">41</code> and again these are not variables. We are not changing a memory region, we are merely creating a new scope with a new <span class="strong"><em class="calibre9">X</em></span> value.</p><p class="calibre7">Going back to our test, the <code class="email">let</code> statement begins with the following code:</p><div class="informalexample"><pre class="programlisting">image (load-image image-path)</pre></div><p class="calibre7">It is pretty clear to understand, but the next line might prove a bit more difficult:</p><div class="informalexample"><pre class="programlisting">[w _] (image-size image)</pre></div><p class="calibre7">It looks pretty strange; we are assigning the value of (<code class="email">image-size image</code>) to <code class="email">[w _]</code> but <code class="email">[w _]</code> is not a symbol name!</p><p class="calibre7">What is happening here is that we are using a mechanism called destructuring to take the result of (<code class="email">image-size image</code>) apart and just use the piece of information that we are interested in, which in this case is the width of the image.</p><p class="calibre7">Destructuring is one of the key features of Clojure, it can be used almost everywhere where symbol binding happens, such as:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Let expressions</li><li class="listitem">Function parameter lists</li></ul></div><p class="calibre7">Destructuring <a id="id99" class="calibre1"/>helps write more concise code but it might strike you as strange when you are not used to it. Let's talk about it in depth in the next section.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Destructuring in Clojure" id="SJGS1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec24" class="calibre1"/>Destructuring in Clojure</h1></div></div></div><p class="calibre7">Destructuring <a id="id100" class="calibre1"/>is a feature in Clojure that is not common in other lisps; the <a id="id101" class="calibre1"/>idea is to allow you to write more concise code in scenarios where code doesn't really add value (for example, getting the first element from a list or the second parameter from a function) and concentrating only on what is important to you.</p><p class="calibre7">In order to understand this better, let's see an example of why destructuring can help you:</p><div class="informalexample"><pre class="programlisting">(let [v [1 2 3]] [(first v) (nth v 2)]) ;; [1 3]</pre></div><p class="calibre7">What's wrong with the previous code? Nothing really, but you need to start thinking about what is <code class="email">v</code>, what the first value of <code class="email">v</code> is, what the nth function does, and at what index <code class="email">v</code> starts.</p><p class="calibre7">Instead we can do this:</p><div class="informalexample"><pre class="programlisting">(let [[f s t] [1 2 3]] [f t]) ;; [1 3]</pre></div><p class="calibre7">Once you are used to destructuring, you will see that you don't need to think about how to get the elements you need. In this case, we directly access the first, second, and third elements from our vector and use the first and third out of the three elements. With good naming it can become even easier.</p><p class="calibre7">Lets now take a deep dive into what destructuring is.</p><p class="calibre7">There are two types of destructuring:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Sequential destructuring</strong></span>: It <a id="id102" class="calibre1"/>allows us to take sequential data structures apart and bind the values that you are interested in directly to symbols</li><li class="listitem"><span class="strong"><strong class="calibre8">Associative destructuring</strong></span>: It <a id="id103" class="calibre1"/>allows us to take maps apart and bind only the key reference values that you are interested in directly to symbols</li></ul></div></div>

<div class="book" title="Destructuring in Clojure" id="SJGS1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Sequential destructuring"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec28" class="calibre1"/>Sequential destructuring</h2></div></div></div><p class="calibre7">Sequential destructuring <a id="id104" class="calibre1"/>should be easy to understand with some examples; lets have a look:</p><div class="informalexample"><pre class="programlisting">(let [[f s] [1 2]] f) ;; 1
(let [[f s t] [1 2 3]] [f t]) ;; [1 3]
(let [[f] [1 2]] f);; 1
(let [[f s t] [1 2]] t);; nil
(let [[f &amp; t [1 2]] t);; (2)
(let [[f &amp; t [1 2 3]] t);; (2 3)
(let [[f &amp; t [1 2 3]] t);; (2 3)
(let [[f &amp; [_ t]] [1 2 3]] [f t])</pre></div><p class="calibre7">In these examples, as convention, we use <code class="email">f</code> for first, <code class="email">s</code> for second, <code class="email">t</code> for third, and <code class="email">a</code> for all the others.</p><p class="calibre7">The same destructuring idea and syntax can be used with function parameters, as shown in the next example:</p><div class="informalexample"><pre class="programlisting">(defn func [[f _ t]]
  (+ f t))
(func [1 2 3]) ;; 4</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note13" class="calibre1"/>Note</h3><p class="calibre7">Here we use the symbol <code class="email">_</code>, there is a convention in Clojure to use the <code class="email">_</code> symbol whenever you are not interested in some value and you don't need to use it in the future. In the previous example, we aren't interested in the second parameter of the <code class="email">func</code> function.</p></div><p class="calibre7">As you can see, it lets us write a much more concise code and focus only on what's important, which is the algorithm or business.</p></div></div>

<div class="book" title="Destructuring in Clojure" id="SJGS1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Associative destructuring"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec29" class="calibre1"/>Associative destructuring</h2></div></div></div><p class="calibre7">We've <a id="id105" class="calibre1"/>already seen sequential destructuring that allows getting certain elements of a sequence by index. In Clojure, there is also associative destructuring, which allows you to take just the keys of the map in which you are interested.</p><p class="calibre7">Again, an example is worth more than a thousand words:</p><div class="informalexample"><pre class="programlisting">(let [{a-value a} {: a-value  5}] a-value) ;; 5
(let [{a-value :a c-value :c} {:a 5 :b 6 :c 7}] c-value) ;; 7
(let [{:keys [a c]} {:a 5 :b 6 :c 7}] c) ;; 7
(let [{:syms [a c]} {'a 5 :b 6 'c 7}] c) ;; 7
(let [{:strs [a c]} {:a 5 :b 6 :c 7 "a" 9}] [a c]) ;; [9 nil]
(let [{:strs [a c] :or {c 42}} {:a 5 :b 6 :c 7 "a" 9}] [a c]) ;; [9 42]</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip09" class="calibre1"/>Tip</h3><p class="calibre7">Thinking of symbols as keys to a map can feel strange, nonetheless it is important to remember this feature; it could come in handy at some point.</p></div><p class="calibre7">As you can see, it's pretty simple too, but we have a few more options:</p><div class="book"><ul class="itemizedlist"><li class="listitem">We can reference some keys and assigning them a name, as shown in the first and second example</li><li class="listitem">We can reference keyword keys, as in the third example</li><li class="listitem">We can reference string keys, as in the fourth example</li><li class="listitem">We can define default values with the <code class="email">:or</code> keyword!</li></ul></div><p class="calibre7">Destructuring <a id="id106" class="calibre1"/>is one of the most used features of Clojure and it allows you to write very concise code.</p><p class="calibre7">Going back to our test code, it should now be pretty easy to understand the get-<code class="email">image-width</code> function:</p><div class="informalexample"><pre class="programlisting">(defn get-image-width [image-path]
  (let [image (load-image image-path)
        [w _] (image-size image)]
    w))</pre></div><p class="calibre7">As you can see, it sets the image value as the loaded image and then it calculates the width, gets the width only and returns that value.</p><p class="calibre7">We can now understand the <code class="email">test-load-image</code> test:</p><div class="informalexample"><pre class="programlisting"> (deftest test-load-image
  (testing "We should be able to generate thumbnails"
    (let [image-stream    (io/input-stream "http://imgs.xkcd.com/comics/angular_momentum.jpg")
          image           (load-image image-stream)
          thumbnail-image (generate-thumbnail image 50)]
      (save-image thumbnail-image "xkcd.png")
      (is (= 50 (get-image-width (io/input-stream "xkcd.png")))))))</pre></div><p class="calibre7">It just initializes an <code class="email">image-stream</code> value, it then loads an image from that stream and generates a thumbnail. It finally loads the generated thumbnail and checks that the image width is 50px.</p><p class="calibre7">Now that we've written our tests and we are sure that everything works, we can use our little library from the Clojure projects, but what happens if we want to use it from a pure Java (or groovy, or scala) project?</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Exposing your code to Java" id="TI1E1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec25" class="calibre1"/>Exposing your code to Java</h1></div></div></div><p class="calibre7">If you want to be <a id="id107" class="calibre1"/>able to use Clojure code from other JVM languages, in Clojure, there are a couple of ways in which you can do it:</p><div class="book"><ul class="itemizedlist"><li class="listitem">You can generate new Java classes and use them as you normally would; it can implement some interface or extend from some other class</li><li class="listitem">You can generate a proxy on the fly, this way you can implement a contract (in the form of a class or an interface) that some framework requires with little code and effort</li><li class="listitem">You can use the <code class="email">clojure.java.api</code> package to call Clojure functions directly from Java</li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note14" class="calibre1"/>Note</h3><p class="calibre7">You can find more information on how this works at the following location: <a class="calibre1" href="http://www.falkoriemenschneider.de/a__2014-03-22__Add-Awesomeness-to-your-Legacy-Java.html">http://www.falkoriemenschneider.de/a__2014-03-22__Add-Awesomeness-to-your-Legacy-Java.html</a>.</p></div><p class="calibre7">Let's have a look at how we can define a Java class.</p><p class="calibre7">Create a new namespace called <code class="email">thumbnails.image-java</code> and write the following code:</p><div class="informalexample"><pre class="programlisting">(ns thumbnails.image-java
  (:require [thumbnails.image :as img])
  (:gen-class
    :methods [[loadImage [java.io.InputStream] java.awt.image.BufferedImage]
              [saveImage [java.awt.image.BufferedImage String] void]
              [generateThumbnail [java.awt.image.BufferedImage int] java.awt.image.BufferedImage]]
    :main false
    :name thumbnails.ImageProcessor))

(defn -loadImage [this image-stream]
  (img/load-image image-stream))

(defn -saveImage [this image path]
  (img/save-image image path))

(defn -generateThumbnail [this image size]
  (img/generate-thumbnail image size))</pre></div><p class="calibre7">This code is very similar to the Clojure code that we have already seen, except for the <code class="email">gen-class</code> directive and the function names starting with a dash.</p><p class="calibre7">Let's review the <code class="email">gem-class</code> in better detail:</p><div class="informalexample"><pre class="programlisting">(:gen-class
    :methods [[loadImage [java.io.InputStream] java.awt.image.BufferedImage]
              [saveImage [java.awt.image.BufferedImage String] void]
              [generateThumbnail [java.awt.image.BufferedImage int] java.awt.image.BufferedImage]]
    :main false
    :name thumbnails.ImageProcessor)</pre></div><p class="calibre7">When the <a id="id108" class="calibre1"/>Clojure compiler sees this, it generates the byte code of a class but it needs a little help from the keywords to know how to generate the class.</p><div class="book"><ul class="itemizedlist"><li class="listitem">The name key defines the name of the class, it is a symbol</li><li class="listitem">The main key defines whether this class should have a main method or not</li><li class="listitem">The method key defines all the methods and their signatures, it is a vector with three parts: <code class="email">[methodName [parameterTypes] returnType]</code></li></ul></div><p class="calibre7">The methods are then implemented as functions starting with the (<code class="email">-</code>) character, the prefix can be changed with the prefix key.</p><p class="calibre7">You also need to tell Clojure to compile this class in advance, in Leiningen it can be achieved with <code class="email">:aot</code>, go to your <code class="email">project.clj</code> file and add an <code class="email">:aot</code> key with the namespace or namespaces to be compiled in a vector; if you want everything to be compiled in advance, you could use the special <code class="email">:all</code> value.</p><p class="calibre7">In the end, you should have something similar to this:</p><div class="mediaobject"><img src="../images/00010.jpeg" alt="Exposing your code to Java" class="calibre10"/></div><p class="calibre11"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip10" class="calibre1"/>Tip</h3><p class="calibre7">If you want all of your code to be compiled in advance, you can use <code class="email">:aot :all </code>in your <code class="email">project.clj</code>.</p></div><p class="calibre7">Now, we can install our library to our Maven local repository. Go to the command line and run:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre8">$ lein install</strong></span>
</pre></div><p class="calibre7">You'll get <a id="id109" class="calibre1"/>an output similar to the following screenshot:</p><div class="mediaobject"><img src="../images/00011.jpeg" alt="Exposing your code to Java" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Now, you are good to go; you should have a <code class="email">thumbnails:thumbnails:0.1.0-SNAPSHOT</code> dependency in your Maven local repository.</p></div>

<div class="book" title="Exposing your code to Java" id="TI1E1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Testing from Groovy"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec30" class="calibre1"/>Testing from Groovy</h2></div></div></div><p class="calibre7">In order<a id="id110" class="calibre1"/> to see how this works with several JVM languages, we will use Groovy and Gradle to test. We can use Java and Maven just as easily. Remember that you can get the source from the code bundle so that you don't need to know everything that's happening here.</p><p class="calibre7">There are two files here; in the <code class="email">build.gradle</code> file, we specify that we want to use our local Maven repository and we specify our dependency, as:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'java'
apply plugin: 'groovy'

repositories {
  jcenter()
  mavenLocal()
}

dependencies {
  compile "thumbnails:thumbnails:0.1.0-SNAPSHOT"
  testCompile "org.spockframework:spock-core:0.7-groovy-2.0"
}</pre></div><p class="calibre7">Then we can write our test, as the following code:</p><div class="informalexample"><pre class="programlisting">package imaging.java

import thumbnails.ImageProcessor
import spock.lang.*

class ImageSpec extends Specification {
  def "Test we can use imaging tools"() {
    setup:
      def processor = new ImageProcessor()
      def imageStream = getClass().getResourceAsStream("/test.png")

    when:
      def image = processor.loadImage(imageStream)
      def thumbnail = processor.generateThumbnail(image, 100)

    then:
      thumbnail.getWidth() == 100
  }
}</pre></div><p class="calibre7">You can then run the tests:</p><div class="informalexample"><pre class="programlisting">gradle test</pre></div><p class="calibre7">As you can<a id="id111" class="calibre1"/> see, it is very easy to run your code from Java, Groovy, or even Scala. There are other ways to use Clojure with Java, particularly, if you want to implement an interface or generate a class dynamically.</p></div></div>
<div class="book" title="Proxy and reify" id="UGI01-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec26" class="calibre1"/>Proxy and reify</h1></div></div></div><p class="calibre7">There are <a id="id112" class="calibre1"/>situations when you are interacting with Java libraries, where you must send an instance of a specific Java class to some method; writing a class isn't the best option, you should rather create an instance that conforms to a contract expected by some framework on the fly. We have two options to do this:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Proxy</strong></span>: It allows you to implement a Java interface or extend from some super class. In reality, it creates a new object that calls your Clojure functions when needed</li><li class="listitem"><span class="strong"><strong class="calibre8">Reify</strong></span>: Reify <a id="id113" class="calibre1"/>allows you to implement interfaces and Clojure protocols (we will see them later). It is not capable of extending classes. It is a better performant than the proxy and should be used whenever possible.</li></ul></div><p class="calibre7">Let's look at a minimal example:</p><div class="informalexample"><pre class="programlisting">(import '(javax.swing JFrame JLabel JTextField JButton)
        '(java.awt.event ActionListener)
        '(java.awt GridLayout))
(defn sample []
  (let [frame (JFrame. "Simple Java Integration")
        sample-button (JButton. "Hello")]
    (.addActionListener
     sample-button
     (reify ActionListener
            (actionPerformed
             [_ evt]
             (println "Hello world"))))
    (doto frame
      (.add sample-button)
      (.setSize 100 40)
      (.setVisible true))))
(sample)</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip11" class="calibre1"/>Tip</h3><p class="calibre7">
<code class="email">doto</code> is a macro that allows us to call several methods on an instance; you can think of it as a way to call all of the methods separately. It works great with Java Beans!</p></div><p class="calibre7">Open up an REPL and write the code; it should show a window with a button that prints <code class="email">Hello world</code> (in the terminal) when clicked:</p><div class="mediaobject"><img src="../images/00012.jpeg" alt="Proxy and reify" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">If you are familiar <a id="id114" class="calibre1"/>with swing, then you know that the <code class="email">addActionListener</code> of <code class="email">JButton</code> needs a callback which is an instance of <code class="email">ActionListener</code> and we are creating said instance with the <code class="email">reify</code> function.</p><p class="calibre7">In Java code, you might normally do something similar to the following code:</p><div class="informalexample"><pre class="programlisting">button.addActionListener(new ActionListener() {
  public void actionPerformed(ActionEvent e) {
    System.out.println("Hello world")'
  }
})</pre></div><p class="calibre7">We call this an anonymous class and it is essentially the same as a closure in functional languages. In the previous example, the code was replaced by a reify:</p><div class="informalexample"><pre class="programlisting">  (reify ActionListener
            (actionPerformed
             [_ evt]
             (println "Hello world")))</pre></div><p class="calibre7">The <code class="email">reify</code> statement <a id="id115" class="calibre1"/>receives the interface that you are implementing and all the methods that you are implementing as you list. In this case, we just implement <code class="email">actionPerformed</code> to receive the action event.</p><p class="calibre7">This is the structure:</p><div class="informalexample"><pre class="programlisting">(reify InterfaceOrProtocol
  (method [self parameter-list]
    method-body)
  (method2 [self parameter-list]
    method-body))</pre></div><p class="calibre7">This creates an instance of <code class="email">ActionListener</code>, you can do the same with servlets, threads, collections, lists, or any other Java interface defined by anyone.</p><p class="calibre7">One particular thing that you need to remember here is that you need to always add <code class="email">self</code> as the first parameter to your method implementations; it takes the place of the <code class="email">this</code> keyword that works in Java.</p></div>
<div class="book" title="Summary" id="VF2I1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec27" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">In this chapter, you have gained a lot of power from Clojure with a few new primitives.</p><p class="calibre7">As you can see, there are plenty of ways to interact with your current codebase; specifically, you can now:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Use Java code from Clojure</li><li class="listitem">Use Clojure code from Java</li><li class="listitem">Reuse Java frameworks by creating objects that adhere to their contracts</li></ul></div><p class="calibre7">With all of our new tools in mind, we are ready to tackle more concepts and a little bit more complexity with collections and data structures.</p></div></body></html>