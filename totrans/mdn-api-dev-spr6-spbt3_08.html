<html><head></head><body>
<div id="_idContainer035">
<h1 class="chapter-number" id="_idParaDest-202"><a id="_idTextAnchor201"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-203"><a id="_idTextAnchor202"/><span class="koboSpan" id="kobo.2.1">Testing APIs</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Proper automated testing helps you to reduce regression bugs and keeps your application stable. </span><span class="koboSpan" id="kobo.3.2">It makes sure that every change you make will fail during the build or testing phase if the change has any side effects on existing code. </span><span class="koboSpan" id="kobo.3.3">Investing in a test automation suite can give you peace of mind and will prevent any surprises </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">in production.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">This chapter will help you learn about test automation by showing you how to implement unit and integration test automation. </span><span class="koboSpan" id="kobo.5.2">You will learn how to test APIs manually and automatically. </span><span class="koboSpan" id="kobo.5.3">First, you will learn about automating unit and integration tests. </span><span class="koboSpan" id="kobo.5.4">After learning about these forms of automation, you will be able to make both types of testing an integral part of any build. </span><span class="koboSpan" id="kobo.5.5">You will also learn how to set up the </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">Java Code Coverage</span></strong><span class="koboSpan" id="kobo.7.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.8.1">JaCoCo</span></strong><span class="koboSpan" id="kobo.9.1">) tool</span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.10.1"> to calculate different code </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">coverage metrics.</span></span></p>
<p><span class="koboSpan" id="kobo.12.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.14.1">Testing APIs and </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">code manually</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.16.1">Testing automation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.17.1">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">get started!</span></span></p>
<h1 id="_idParaDest-204"><a id="_idTextAnchor203"/><span class="koboSpan" id="kobo.19.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.20.1">The code for this chapter is available </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08"><span class="No-Break"><span class="koboSpan" id="kobo.22.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.23.1">.</span></span></p>
<h1 id="_idParaDest-205"><a id="_idTextAnchor204"/><span class="koboSpan" id="kobo.24.1">Testing APIs and code manually</span></h1>
<p><span class="koboSpan" id="kobo.25.1">Testing</span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.26.1"> is a continuous process in software development and maintenance cycles. </span><span class="koboSpan" id="kobo.26.2">You need to do full testing that covers all possible use cases and the respective code for each change. </span><span class="koboSpan" id="kobo.26.3">Different types of testing can be performed for APIs, including </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.28.1">Unit testing</span></strong><span class="koboSpan" id="kobo.29.1">: Unit testing</span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.30.1"> is performed by developers to test the smallest </span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.31.1">unit (such as a class method) </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">of code.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.33.1">Integration testing</span></strong><span class="koboSpan" id="kobo.34.1">: Integration testing</span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.35.1"> is performed by developers to test the </span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.36.1">integration of different layers </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">of components.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.38.1">Contract testing</span></strong><span class="koboSpan" id="kobo.39.1">: Contract testing</span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.40.1"> is performed by developers to </span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.41.1">make sure any changes that are made to the API won’t break the consumer code. </span><span class="koboSpan" id="kobo.41.2">The consumer code should always comply with the producer’s contract (API). </span><span class="koboSpan" id="kobo.41.3">It is primarily required in </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">microservices-based development.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.43.1">End-to-end</span></strong><span class="koboSpan" id="kobo.44.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.45.1">E2E</span></strong><span class="koboSpan" id="kobo.46.1">) </span><strong class="bold"><span class="koboSpan" id="kobo.47.1">testing</span></strong><span class="koboSpan" id="kobo.48.1">: E2E testing</span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.49.1"> is performed by the </span><strong class="bold"><span class="koboSpan" id="kobo.50.1">quality assurance</span></strong><span class="koboSpan" id="kobo.51.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.52.1">QA</span></strong><span class="koboSpan" id="kobo.53.1">) team</span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.54.1"> to test end-to-end scenarios, such</span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.55.1"> as from the UI (consumer) to </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">the backend.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.57.1">User acceptance testing</span></strong><span class="koboSpan" id="kobo.58.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.59.1">UAT</span></strong><span class="koboSpan" id="kobo.60.1">): UAT is</span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.61.1"> performed by business users from a</span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.62.1"> business perspective and may overlap with </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">E2E testing.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.64.1">You performed</span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.65.1"> manual API testing by using the cURL and Postman tools earlier in this book. </span><span class="koboSpan" id="kobo.65.2">Every change requires the APIs to be completely tested – not only the impacted APIs. </span><span class="koboSpan" id="kobo.65.3">There is a reason for this. </span><span class="koboSpan" id="kobo.65.4">You may assume that it only impacts certain APIs, but what if your underlying assumptions are wrong? </span><span class="koboSpan" id="kobo.65.5">It may impact the other APIs that you skipped, which would lead to production issues. </span><span class="koboSpan" id="kobo.65.6">This can create panic and may require a release to be rolled over or a patch to be released with </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">a fix.</span></span></p>
<p><span class="koboSpan" id="kobo.67.1">You don’t want to be in such situations, so products have a separate QA team that ensures releases are delivered with the best possible quality. </span><span class="koboSpan" id="kobo.67.2">QA teams do the separate E2E and acceptance testing (along with business/domain users), apart from the testing that’s done by the </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">development team.</span></span></p>
<p><span class="koboSpan" id="kobo.69.1">This extra assurance for high-quality deliverables needs more time and effort. </span><span class="koboSpan" id="kobo.69.2">The time taken now is much shorter because of automated testing. </span><span class="koboSpan" id="kobo.69.3">It was longer previously because we performed manual testing; therefore, software development cycles used to be huge in comparison to today. </span><strong class="bold"><span class="koboSpan" id="kobo.70.1">Time to market</span></strong><span class="koboSpan" id="kobo.71.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.72.1">TTM</span></strong><span class="koboSpan" id="kobo.73.1">) is a huge factor in today’s competitive software industry. </span><span class="koboSpan" id="kobo.73.2">Today, you need </span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.74.1">faster release cycles. </span><span class="koboSpan" id="kobo.74.2">Moreover, quality checks, also known as testing, are an important and major part of </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">release cycles.</span></span></p>
<p><span class="koboSpan" id="kobo.76.1">You can reduce the testing time by automating the testing process and making it an integral part of the CI/CD pipeline. </span><strong class="bold"><span class="koboSpan" id="kobo.77.1">CI</span></strong><span class="koboSpan" id="kobo.78.1"> stands</span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.79.1"> for </span><strong class="bold"><span class="koboSpan" id="kobo.80.1">continuous integration</span></strong><span class="koboSpan" id="kobo.81.1">, which means </span><em class="italic"><span class="koboSpan" id="kobo.82.1">build &gt; test &gt; merge</span></em><span class="koboSpan" id="kobo.83.1"> in a code repository. </span><strong class="bold"><span class="koboSpan" id="kobo.84.1">CD</span></strong><span class="koboSpan" id="kobo.85.1"> stands for </span><strong class="bold"><span class="koboSpan" id="kobo.86.1">continuous delivery</span></strong><span class="koboSpan" id="kobo.87.1"> and/or </span><strong class="bold"><span class="koboSpan" id="kobo.88.1">continuous deployment</span></strong><span class="koboSpan" id="kobo.89.1">, both of which may be used interchangeably. </span><span class="koboSpan" id="kobo.89.2">Continuous delivery</span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.90.1"> is a process where code is automatically tested and released (read and uploaded) to an artifact repository or container registry. </span><span class="koboSpan" id="kobo.90.2">Then, it can be picked and deployed to a production environment after manual approval. </span><span class="koboSpan" id="kobo.90.3">Continuous deployment</span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.91.1"> is one step ahead of continuous delivery and automates all the steps. </span><span class="koboSpan" id="kobo.91.2">Continuous deployment also performs the automatic deployment to production once all tests are passed. </span><span class="koboSpan" id="kobo.91.3">Products that don’t</span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.92.1"> release their code for public access use this approach, such as Facebook and Twitter. </span><span class="koboSpan" id="kobo.92.2">On the other hand, products/services that are available publicly, such as the Spring Framework and Java, use continuous </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">delivery pipelines.</span></span></p>
<p><span class="koboSpan" id="kobo.94.1">We’ll automate the manual testing we have done so far in the </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">next section.</span></span></p>
<h1 id="_idParaDest-206"><a id="_idTextAnchor205"/><span class="koboSpan" id="kobo.96.1">Testing automation</span></h1>
<p><span class="koboSpan" id="kobo.97.1">Whatever</span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.98.1"> testing you are doing manually can be automated and made part of the build. </span><span class="koboSpan" id="kobo.98.2">This means that any change or code commit will run the test suite as a part of the build. </span><span class="koboSpan" id="kobo.98.3">A build will only be successful if all the tests </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">are passed.</span></span></p>
<p><span class="koboSpan" id="kobo.100.1">You can add automated integration tests for all the APIs. </span><span class="koboSpan" id="kobo.100.2">So, instead of firing each API manually using cURL or Insomnia, the build will fire them, and the test result will be available at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">the build.</span></span></p>
<p><span class="koboSpan" id="kobo.102.1">In this section, you are going to write an integration test that will replicate the REST client call and test all the application layers, starting from the controller, all the way down to the persistence layer, including the </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">database (H2).</span></span></p>
<p><span class="koboSpan" id="kobo.104.1">But before that, you will add the necessary unit tests. </span><span class="koboSpan" id="kobo.104.2">Ideally, these unit tests should have been added alongside the </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.105.1">development process, or before the development process in the case of </span><strong class="bold"><span class="koboSpan" id="kobo.106.1">test-driven </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.107.1">development</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.108.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.109.1">TDD</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.111.1">Unit tests</span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.112.1"> are tests that validate the expected results of small units of code, such as a class’s methods. </span><span class="koboSpan" id="kobo.112.2">You can avoid most bugs if you have proper tests in place with good code (90% or above) and branch coverage (80% and above). </span><span class="koboSpan" id="kobo.112.3">Code coverage refers to metrics such as the number of lines and branches (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">if-else</span></strong><span class="koboSpan" id="kobo.114.1">), which are validated when the tests </span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">are executed.</span></span></p>
<p><span class="koboSpan" id="kobo.116.1">Some classes or </span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.117.1">methods have dependencies on other classes or infrastructure services. </span><span class="koboSpan" id="kobo.117.2">For example, controller classes have dependencies on service and assembler classes, while repository classes have dependencies on Hibernate APIs. </span><span class="koboSpan" id="kobo.117.3">You can create mocks to replicate dependency behaviors and assume these are working as expected or behave as per the defined tests. </span><span class="koboSpan" id="kobo.117.4">This approach will allow you to test the actual code unit (such as a method) and validate </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">its behavior.</span></span></p>
<p><span class="koboSpan" id="kobo.119.1">In the next section, we’ll explore how to add unit tests before writing the </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">integration tests.</span></span></p>
<h2 id="_idParaDest-207"><a id="_idTextAnchor206"/><span class="koboSpan" id="kobo.121.1">Unit testing</span></h2>
<p><span class="koboSpan" id="kobo.122.1">I advise you to go back to </span><a href="B19349_06.xhtml#_idTextAnchor148"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.123.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.124.1"> as a base</span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.125.1"> for this chapter’s code. </span><span class="koboSpan" id="kobo.125.2">You don’t have to add any additional dependencies for unit tests. </span><span class="koboSpan" id="kobo.125.3">You already have the following dependency in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">build.gradle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.127.1"> (</span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/build.gradle"><span class="No-Break"><span class="koboSpan" id="kobo.128.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/build.gradle</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.129.1">):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.130.1">
testImplementation('org.springframework.boot:spring-boot-starter-test')</span></pre> <p><span class="koboSpan" id="kobo.131.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">spring-boot-starter-test</span></strong><span class="koboSpan" id="kobo.133.1"> adds all the required test dependencies, not only for the unit tests but also for the integration tests. </span><span class="koboSpan" id="kobo.133.2">You are going to primarily use the following libraries </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">for testing:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.135.1">JUnit 5</span></strong><span class="koboSpan" id="kobo.136.1">: JUnit 5</span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.137.1"> is a bundle of modules, including the JUnit Platform, JUnit Jupiter, and </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">JUnit Vintage:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.139.1">The JUnit Platform</span></strong><span class="koboSpan" id="kobo.140.1"> allows </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.141.1">you to launch tests on JVM and its engine provides APIs for writing testing frameworks that run on the platform. </span><span class="koboSpan" id="kobo.141.2">The JUnit Platform consists </span><span class="No-Break"><span class="koboSpan" id="kobo.142.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">junit-platform-commons</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.144.1">.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.145.1">JUnit Jupiter</span></strong><span class="koboSpan" id="kobo.146.1"> provides </span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.147.1">the programming and extension models for writing tests and extensions. </span><span class="koboSpan" id="kobo.147.2">It has a separate library called </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">junit-jupiter-engine</span></strong><span class="koboSpan" id="kobo.149.1"> that allows you to run Jupiter-based tests on the JUnit Platform. </span><span class="koboSpan" id="kobo.149.2">It also provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">junit-jupiter</span></strong><span class="koboSpan" id="kobo.151.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">junit-jupiter-api</span></strong><span class="koboSpan" id="kobo.153.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">junit-jupiter-params</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.155.1"> libraries.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.156.1">JUnit Vintage</span></strong><span class="koboSpan" id="kobo.157.1"> supports</span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.158.1"> older versions of JUnit, such as versions 3 and 4. </span><span class="koboSpan" id="kobo.158.2">You are going to use the latest version in this book, which is 5, so you don’t need </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">this bundle.</span></span></li></ul></li>
</ul>
<p><span class="koboSpan" id="kobo.160.1">You can find out more about JUnit</span><a id="_idIndexMarker752"/> <span class="No-Break"><span class="koboSpan" id="kobo.161.1">at </span></span><a href="https://junit.org/"><span class="No-Break"><span class="koboSpan" id="kobo.162.1">https://junit.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.163.1">.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.164.1">AssertJ</span></strong><span class="koboSpan" id="kobo.165.1">: AssertJ is </span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.166.1">a test assertion library that simplifies assertion writing by providing fluent APIs. </span><span class="koboSpan" id="kobo.166.2">It is also extendable. </span><span class="koboSpan" id="kobo.166.3">You can write custom assertions for your domain objects. </span><span class="koboSpan" id="kobo.166.4">You can </span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.167.1">find more about it </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">at </span></span><a href="https://assertj.github.io/doc/"><span class="No-Break"><span class="koboSpan" id="kobo.169.1">https://assertj.github.io/doc/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.170.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.171.1">Hamcrest</span></strong><span class="koboSpan" id="kobo.172.1">: Hamcrest</span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.173.1"> is another assertion library that provides assertions based on matchers. </span><span class="koboSpan" id="kobo.173.2">It also allows you to write custom matchers. </span><span class="koboSpan" id="kobo.173.3">You’ll find an example of both in this chapter, though AssertJ is preferable because it has fluent APIs. </span><span class="koboSpan" id="kobo.173.4">Chained methods help IDEs to suggest appropriate assertions based on a given object. </span><span class="koboSpan" id="kobo.173.5">You can choose one of the assertion libraries or both</span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.174.1"> based on your use cases and liking. </span><span class="koboSpan" id="kobo.174.2">You can find out more about it </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">at </span></span><a href="http://hamcrest.org/"><span class="No-Break"><span class="koboSpan" id="kobo.176.1">http://hamcrest.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.177.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.178.1">Mockito</span></strong><span class="koboSpan" id="kobo.179.1">: Mockito</span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.180.1"> is a mocking </span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.181.1">framework that allows you to mock objects (read dependencies) and to stub method calls. </span><span class="koboSpan" id="kobo.181.2">You can find out more about it </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">at </span></span><a href="https://site.mockito.org/"><span class="No-Break"><span class="koboSpan" id="kobo.183.1">https://site.mockito.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.184.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.185.1">You already know that unit tests test the smallest testable code unit. </span><span class="koboSpan" id="kobo.185.2">But how can we write a unit test for controller methods? </span><span class="koboSpan" id="kobo.185.3">The controller runs on web servers and has the Spring web application context. </span><span class="koboSpan" id="kobo.185.4">If you write a test that uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">WebApplicationContext</span></strong><span class="koboSpan" id="kobo.187.1"> and is running on top of a web server, then you can call it an integration test rather than a </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">unit test.</span></span></p>
<p><span class="koboSpan" id="kobo.189.1">Unit tests</span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.190.1"> should be lightweight and must be executed quickly. </span><span class="koboSpan" id="kobo.190.2">Therefore, you must use </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">MockMvc</span></strong><span class="koboSpan" id="kobo.192.1">, a special class provided by the Spring test library, to test the controllers. </span><span class="koboSpan" id="kobo.192.2">You can use the standalone setup for </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">MockMvc</span></strong><span class="koboSpan" id="kobo.194.1"> for unit testing. </span><span class="koboSpan" id="kobo.194.2">You can also use </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">MockitoExtension</span></strong><span class="koboSpan" id="kobo.196.1"> to run the unit test on the JUnit Platform (JUnit 5 provides an extension for runners), which supports object mocking and method stubbing. </span><span class="koboSpan" id="kobo.196.2">You will also use the Mockito library to mock the required dependencies. </span><span class="koboSpan" id="kobo.196.3">These tests are fast and help developers </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">build faster.</span></span></p>
<p><span class="koboSpan" id="kobo.198.1">Let’s write our test using </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">AssertJ assertions.</span></span></p>
<h3><span class="koboSpan" id="kobo.200.1">Testing using AssertJ assertions</span></h3>
<p><span class="koboSpan" id="kobo.201.1">Let’s write our first </span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.202.1">unit test for </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">ShipmentController</span></strong><span class="koboSpan" id="kobo.204.1">. </span><span class="koboSpan" id="kobo.204.2">The </span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.205.1">following code can be found in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">src/test/java/com/packt/modern/api/controller/ ShipmentControllerTest.java</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.208.1">@ExtendWith(MockitoExtension.class)</span></strong><span class="koboSpan" id="kobo.209.1">public class ShipmentControllerTest {
  private static final String id =
      "a1b9b31d-e73c-4112-af7c-b68530f38222";
  private </span><strong class="bold"><span class="koboSpan" id="kobo.210.1">MockMvc mockMvc</span></strong><span class="koboSpan" id="kobo.211.1">;
  </span><strong class="bold"><span class="koboSpan" id="kobo.212.1">@Mock</span></strong><span class="koboSpan" id="kobo.213.1">
  private ShipmentService service;
  @Mock
  private ShipmentRepresentationModelAssembler assembler;
  @Mock
  private MessageSource msgSource;
  @InjectMocks
  private ShipmentController controller;
  private ShipmentEntity entity;
  private Shipment model = new Shipment();
  private </span><strong class="bold"><span class="koboSpan" id="kobo.214.1">JacksonTester&lt;List&lt;Shipment&gt;&gt; shipmentTester</span></strong><span class="koboSpan" id="kobo.215.1">;
  // continue …</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/test/java/com/packt/modern/api/controller/ShipmentControllerTest.java"><span class="No-Break"><span class="koboSpan" id="kobo.216.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/test/java/com/packt/modern/api/controller/ShipmentControllerTest.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.217.1">Here, our test is using a Jupiter-based annotation (</span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1">ExtendWith</span></strong><span class="koboSpan" id="kobo.219.1">) that registers the extension (</span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">MockitoExtension</span></strong><span class="koboSpan" id="kobo.221.1">) for running tests and supporting Mockito-based mocks </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">and stubbing.</span></span></p>
<p><span class="koboSpan" id="kobo.223.1">The Spring test library provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">MockMvc</span></strong><span class="koboSpan" id="kobo.225.1"> class, which allows you to mock the Spring MVC. </span><span class="koboSpan" id="kobo.225.2">As a result, you can execute the controller methods by calling the associated API endpoints’ URI. </span><span class="koboSpan" id="kobo.225.3">The dependencies of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">ShipmentController</span></strong><span class="koboSpan" id="kobo.227.1"> controller class, such as the service and assembler, are marked with </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">@Mock</span></strong><span class="koboSpan" id="kobo.229.1"> annotations to create the mock instances of its dependencies. </span><span class="koboSpan" id="kobo.229.2">You can also use </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">Mockito.mock(classOrInterface)</span></strong><span class="koboSpan" id="kobo.231.1"> to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">mock objects.</span></span></p>
<p><span class="koboSpan" id="kobo.233.1">Another noticeable annotation is </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">@InjectMocks</span></strong><span class="koboSpan" id="kobo.235.1"> on the controller declaration. </span><span class="koboSpan" id="kobo.235.2">It finds out all the declared mocks that are required for a testing class and injects them automatically. </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">ShipmentController</span></strong><span class="koboSpan" id="kobo.237.1"> uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">ShipmentService</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.239.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">ShipmentRepresentation</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1"> ModelAssembler</span></strong><span class="koboSpan" id="kobo.242.1"> instances, which are injected using its constructor. </span><span class="koboSpan" id="kobo.242.2">The Mockito-based </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">InjectMocks</span></strong><span class="koboSpan" id="kobo.244.1"> annotation finds the dependencies in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">ShipmentController</span></strong><span class="koboSpan" id="kobo.246.1"> class (service and assembler). </span><span class="koboSpan" id="kobo.246.2">Then, it looks for mocks of the service and </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.247.1">assembler in the test class. </span><span class="koboSpan" id="kobo.247.2">Once it finds them, it injects these </span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.248.1">mock objects into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">ShipmentController</span></strong><span class="koboSpan" id="kobo.250.1"> class. </span><span class="koboSpan" id="kobo.250.2">If required, you can also create an instance of the testing class using a constructor instead of using </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">@InjectsMocks</span></strong><span class="koboSpan" id="kobo.252.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.254.1">
controller = new ShipmentController(service, assembler);</span></pre> <p><span class="koboSpan" id="kobo.255.1">A mock of </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">MessageSource</span></strong><span class="koboSpan" id="kobo.257.1"> is created for </span><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">RestApiHandler</span></strong><span class="koboSpan" id="kobo.259.1">, which is being used in the setup method. </span><span class="koboSpan" id="kobo.259.2">You’ll explore it further in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.260.1">code block.</span></span></p>
<p><span class="koboSpan" id="kobo.261.1">The last part of the declaration is </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">JacksonTester</span></strong><span class="koboSpan" id="kobo.263.1">, which is part of the Spring testing library. </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">JacksonTester</span></strong><span class="koboSpan" id="kobo.265.1"> is a custom JSON assertion class that’s created using the AssertJ and </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">Jackson libraries.</span></span></p>
<p><span class="koboSpan" id="kobo.267.1">The JUnit Jupiter API provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">@BeforeAll</span></strong><span class="koboSpan" id="kobo.269.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.271.1"> method annotations, which can be used to set up the prerequisites. </span><span class="koboSpan" id="kobo.271.2">As their names suggest, </span><strong class="source-inline"><span class="koboSpan" id="kobo.272.1">@BeforeAll</span></strong><span class="koboSpan" id="kobo.273.1"> is run once per test class, while </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.275.1"> gets executed before each test execution. </span><strong class="source-inline"><span class="koboSpan" id="kobo.276.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.277.1"> can be placed on public non-static methods, whereas </span><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">@BeforeAll</span></strong><span class="koboSpan" id="kobo.279.1"> should be used to annotate public </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">static methods.</span></span></p>
<p><span class="koboSpan" id="kobo.281.1">Similarly, JUnit provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">@AfterAll</span></strong><span class="koboSpan" id="kobo.283.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">@AfterEach</span></strong><span class="koboSpan" id="kobo.285.1"> annotations, which execute the associated methods after each test is executed and after each test is </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">executed, respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.287.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.289.1"> annotation</span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.290.1"> to set up the prerequisites </span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.291.1">for </span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">the </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">ShipmentControll</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1"> erTest</span></strong><span class="koboSpan" id="kobo.295.1"> class, as </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.297.1">
// continue ShipmentControllerTest.java</span><strong class="bold"><span class="koboSpan" id="kobo.298.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.299.1">
public void setup() {
  ObjectMapper mapper = new AppConfig().objectMapper();
  </span><strong class="bold"><span class="koboSpan" id="kobo.300.1">JacksonTester.initFields(this, mapper);</span></strong><span class="koboSpan" id="kobo.301.1">
  MappingJackson2HttpMessageConverter mappingConverter =
    new MappingJackson2HttpMessageConverter();
  mappingConverter.setObjectMapper(mapper);
  </span><strong class="bold"><span class="koboSpan" id="kobo.302.1">mockMvc = MockMvcBuilders.standaloneSetup(controller)</span></strong><span class="koboSpan" id="kobo.303.1">
      </span><strong class="bold"><span class="koboSpan" id="kobo.304.1">.setControllerAdvice(new RestApiErrorHandler</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.305.1">        (msgSource))</span></strong><span class="koboSpan" id="kobo.306.1">
      </span><strong class="bold"><span class="koboSpan" id="kobo.307.1">.setMessageConverters(mappingConverter).build();</span></strong><span class="koboSpan" id="kobo.308.1">
  final Instant now = Instant.now();
  entity = // entity initialization code
  BeanUtils.copyProperties(entity, model);
  // extra model property initialization
}</span></pre>
<p><span class="koboSpan" id="kobo.309.1">First, we</span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.310.1"> initialize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">JacksonTester</span></strong><span class="koboSpan" id="kobo.312.1"> fields with the object </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.313.1">mapper instance received from </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">AppConfig</span></strong><span class="koboSpan" id="kobo.315.1">. </span><span class="koboSpan" id="kobo.315.2">This creates a custom message converter </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">MappingJackson2HttpMes</span></strong></span><strong class="source-inline"> </strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">sageConverter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.320.1">Next, you can create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">mockMvc</span></strong><span class="koboSpan" id="kobo.322.1"> instance using the standalone setup and initialize the controller advice using its setter method. </span><span class="koboSpan" id="kobo.322.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">RestApiErrorHandler</span></strong><span class="koboSpan" id="kobo.324.1"> instance uses the mock object of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">MessageResource</span></strong><span class="koboSpan" id="kobo.326.1"> class. </span><span class="koboSpan" id="kobo.326.2">You can also set the message converter to </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">mockMvc</span></strong><span class="koboSpan" id="kobo.328.1"> before </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">building it.</span></span></p>
<p><span class="koboSpan" id="kobo.330.1">Finally, you initialize the instances of </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">ShipmentEntity</span></strong><span class="koboSpan" id="kobo.332.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">Shipment</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.334.1"> (model).</span></span></p>
<p><span class="koboSpan" id="kobo.335.1">Next, you are going to write the test for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">GET /api/v1/shipping/{id}</span></strong><span class="koboSpan" id="kobo.337.1"> call, which uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">getShipmentByOrderI</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">d()</span></strong><span class="koboSpan" id="kobo.340.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">ShipmentController</span></strong><span class="koboSpan" id="kobo.342.1"> class. </span><span class="koboSpan" id="kobo.342.2">Tests are marked with </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">@Test</span></strong><span class="koboSpan" id="kobo.344.1">. </span><span class="koboSpan" id="kobo.344.2">You can also use </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">@DisplayName</span></strong><span class="koboSpan" id="kobo.346.1"> to customize a test’s name in the </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">test reports:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.348.1">@Test</span></strong><strong class="bold"><span class="koboSpan" id="kobo.349.1">@DisplayName("returns shipments by given order ID")</span></strong><span class="koboSpan" id="kobo.350.1">
public void testGetShipmentByOrderId() throws Exception {
  // given
  given(service.getShipmentByOrderId(id))
      .willReturn(List.of(entity));
  given(assembler.toListModel(List.of(entity)))
      .willReturn(List.of(model));
  // when
  </span><strong class="bold"><span class="koboSpan" id="kobo.351.1">MockHttpServletResponse response = mockMvc.perform</span></strong><span class="koboSpan" id="kobo.352.1">(
      get("/api/v1/shipping/" + id)
          .contentType(MediaType.APPLICATION_JSON)
          .accept(MediaType.APPLICATION_JSON))
      .andDo(print())
      </span><strong class="bold"><span class="koboSpan" id="kobo.353.1">.andReturn().getResponse();</span></strong><span class="koboSpan" id="kobo.354.1">
  // then
  </span><strong class="bold"><span class="koboSpan" id="kobo.355.1">assertThat</span></strong><span class="koboSpan" id="kobo.356.1">(response.getStatus())
       .</span><strong class="bold"><span class="koboSpan" id="kobo.357.1">isEqualTo</span></strong><span class="koboSpan" id="kobo.358.1">(HttpStatus.OK.value());
  assertThat(response.getContentAsString())
      .isEqualTo(</span><strong class="bold"><span class="koboSpan" id="kobo.359.1">shipmentTester</span></strong><span class="koboSpan" id="kobo.360.1">.write(
          List.of(model)).getJson());
}</span></pre>
<p><span class="koboSpan" id="kobo.361.1">Here, you </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.362.1">are using the </span><strong class="bold"><span class="koboSpan" id="kobo.363.1">behavior-driven development</span></strong><span class="koboSpan" id="kobo.364.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.365.1">BDD</span></strong><span class="koboSpan" id="kobo.366.1">) test</span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.367.1"> style. </span><span class="koboSpan" id="kobo.367.2">You can</span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.368.1"> find out more</span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.369.1"> about BDD at </span><a href="https://cucumber.io/docs/bdd/"><span class="koboSpan" id="kobo.370.1">https://cucumber.io/docs/bdd/</span></a><span class="koboSpan" id="kobo.371.1">. </span><span class="koboSpan" id="kobo.371.2">BDD tests are written using the Gherkin </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">Given &gt; When &gt; Then</span></strong><span class="koboSpan" id="kobo.373.1"> language (</span><a href="https://cucumber.io/docs/gherkin/"><span class="koboSpan" id="kobo.374.1">https://cucumber.io/docs/gherkin/</span></a><span class="koboSpan" id="kobo.375.1">), which can be defined </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">Given</span></strong><span class="koboSpan" id="kobo.378.1">: Context of </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">the test</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">When</span></strong><span class="koboSpan" id="kobo.381.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">Test action</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">Then</span></strong><span class="koboSpan" id="kobo.384.1">: Test result, followed </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">by validation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.386.1">Let’s read this test from a </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">BDD perspective:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">Given</span></strong><span class="koboSpan" id="kobo.389.1">: The service is available and returns the list of shipments based on the given order ID and an assembler, which converts the list of entities into a list of models. </span><span class="koboSpan" id="kobo.389.2">It also adds </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">HATEOAS links.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">When</span></strong><span class="koboSpan" id="kobo.392.1">: The user calls the API via </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">GET /</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">api/shipping/a1b9b31d-e73c- 4112-af7c-b68530f38222</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">Then</span></strong><span class="koboSpan" id="kobo.397.1">: The test validates the received shipments associated with the given </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">order ID.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.399.1">Mockito’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">MockitoBDD</span></strong><span class="koboSpan" id="kobo.401.1"> class provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">given()</span></strong><span class="koboSpan" id="kobo.403.1"> fluent API to stub the mock objects methods. </span><span class="koboSpan" id="kobo.403.2">When </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">mockMvc.perform()</span></strong><span class="koboSpan" id="kobo.405.1"> is called, internally, it calls the respective service and assembler mocks, which, in turn, call the stubbed methods and return the values defined in the stub (</span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.407.1">given()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.409.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">andDo(MockMvcResultHandlers.print())</span></strong><span class="koboSpan" id="kobo.411.1"> method logs the request and response trace, including the payload and response body. </span><span class="koboSpan" id="kobo.411.2">If you want to trace all the </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">mockMvc</span></strong><span class="koboSpan" id="kobo.413.1"> logs inside a test class, then you can configure them directly while initializing </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">mockMvc</span></strong><span class="koboSpan" id="kobo.415.1"> instead of defining them individually in </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">mockMvc.perform()</span></strong><span class="koboSpan" id="kobo.417.1"> calls, as shown here (the </span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">highlighted code):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.419.1">
mockMvc = MockMvcBuilders.standaloneSetup(controller)    .setControllerAdvice(new RestApiErrorHandler
      (msgSource))
    .setMessageConverters(mappingJackson2HttpMessageConverter)
    </span><strong class="bold"><span class="koboSpan" id="kobo.420.1">.alwaysDo(print())</span></strong><span class="koboSpan" id="kobo.421.1">
    .build();</span></pre>
<p><span class="koboSpan" id="kobo.422.1">At the end, you perform </span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.423.1">assertions (whether the status is </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">200 OK</span></strong><span class="koboSpan" id="kobo.425.1"> or not and whether the returned JSON object matches the expected object or not) using AssertJ </span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.426.1">fluent APIs. </span><span class="koboSpan" id="kobo.426.2">First, you use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">Asserts.assertThat()</span></strong><span class="koboSpan" id="kobo.428.1"> function, which takes the actual object and compares it with the expected object using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">isEqualTo()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.430.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.431.1">So far, you have used AssertJ assertions. </span><span class="koboSpan" id="kobo.431.2">Similarly, you can also use Spring and </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">Hamcrest assertions.</span></span></p>
<h3><span class="koboSpan" id="kobo.433.1">Testing using Spring and Hamcrest assertions</span></h3>
<p><span class="koboSpan" id="kobo.434.1">At this point, you know </span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.435.1">how to write JUnit 5 tests using </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">MockitoExtension</span></strong><span class="koboSpan" id="kobo.437.1">. </span><span class="koboSpan" id="kobo.437.2">You’ll use </span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.438.1">the same approach to </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.439.1">write a unit test, except with assertions. </span><span class="koboSpan" id="kobo.439.2">This time, you will write an assertion using Hamcrest assertions, as </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.441.1">
@Test@DisplayName("returns address by given existing ID")
public void getAddressByOrderIdWhenExists() throws Exception {
  </span><strong class="bold"><span class="koboSpan" id="kobo.442.1">given</span></strong><span class="koboSpan" id="kobo.443.1">(service.getAddressesById(id))
     .willReturn(Optional.of(entity));
  // when
  </span><strong class="bold"><span class="koboSpan" id="kobo.444.1">ResultActions result</span></strong><span class="koboSpan" id="kobo.445.1"> = mockMvc.perform(
      get("/api/v1/addresses/a1b9b31d-e73c-4112-af7c-
            b68530f38222")
          .contentType(MediaType.APPLICATION_JSON)
          .accept(MediaType.APPLICATION_JSON));
  // then
  result.andExpect(status().isOk());
  verifyJson(result);
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/test/java/com/packt/modern/api/controller/AddressControllerTest.java"><span class="No-Break"><span class="koboSpan" id="kobo.446.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/test/java/com/packt/modern/api/controller/AddressControllerTest.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.447.1">You have captured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">MockHttpResponse</span></strong><span class="koboSpan" id="kobo.449.1"> instance from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">mockMvc.perform()</span></strong><span class="koboSpan" id="kobo.451.1"> call in the previous test example – that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">testGetShipmentByOrderId()</span></strong><span class="koboSpan" id="kobo.453.1">. </span><span class="koboSpan" id="kobo.453.2">This time, you will directly use the returned value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">mockMvc.perform()</span></strong><span class="koboSpan" id="kobo.455.1"> call rather than calling an extra </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">andReturn().getResponse()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.457.1">on it.</span></span></p>
<p><span class="koboSpan" id="kobo.458.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">ResultAction</span></strong><span class="koboSpan" id="kobo.460.1"> class provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">andExpect()</span></strong><span class="koboSpan" id="kobo.462.1"> assertion method, which takes </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">ResultMatcher</span></strong><span class="koboSpan" id="kobo.464.1"> as an</span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.465.1"> argument. </span><span class="koboSpan" id="kobo.465.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.466.1">StatusResultMatchers.status(). </span><span class="koboSpan" id="kobo.466.2">isOk()</span></strong><span class="koboSpan" id="kobo.467.1"> result matcher</span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.468.1"> evaluates the HTTP status</span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.469.1"> returned by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">perform()</span></strong><span class="koboSpan" id="kobo.471.1"> call. </span><span class="koboSpan" id="kobo.471.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1">VerifyJson()</span></strong><span class="koboSpan" id="kobo.473.1"> method evaluates the JSON response object, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.475.1">
// AddressControllerTest.javaprivate void verifyJson(final ResultActions result)
    throws Exception {
  final String BASE_PATH = "http://localhost";
  result
      .andExpect(jsonPath("id",
          is(entity.getId().toString())))
      .andExpect(jsonPath("number", is
          (entity.getNumber())))
      .andExpect(jsonPath("residency",
          is(entity.getResidency())))
      .andExpect(jsonPath("street", is
          (entity.getStreet())))
      .andExpect(jsonPath("city", is(entity.getCity())))
      .andExpect(jsonPath("state", is(entity.getState())))
      .andExpect(jsonPath("country", is
          (entity.getCountry())))
      .andExpect(jsonPath("pincode", is
           (entity.getPincode())))
      .andExpect(jsonPath("links[0].rel", is("self")))
      .andExpect(jsonPath("links[0].href",
          is(BASE_PATH + "/" + entity.getId())))
      .andExpect(jsonPath("links[1].rel", is("self")))
      .andExpect(jsonPath("links[1].href",
          is(BASE_PATH + URI + "/" + entity.getId())));
}</span></pre>
<p><span class="koboSpan" id="kobo.476.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">MockMvcResultMatchers.jsonPath()</span></strong><span class="koboSpan" id="kobo.478.1"> result matcher takes two arguments – a JSON path expression and a matcher. </span><span class="koboSpan" id="kobo.478.2">Therefore, first, you must pass the JSON field name and then the </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.479.1">Hamcrest matcher known as </span><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">Is.is()</span></strong><span class="koboSpan" id="kobo.481.1">, which </span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.482.1">is a </span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.483.1">shortcut </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">Is.is(equalsTo(entity.getCity()))</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.487.1">Writing the unit test for a service is much easier compared to writing one for the controller because you don’t have to deal </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">MockMvc</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.491.1">You will learn how to test private methods in the </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">next subsection.</span></span></p>
<h3><span class="koboSpan" id="kobo.493.1">Testing private methods</span></h3>
<p><span class="koboSpan" id="kobo.494.1">Unit testing a private method </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.495.1">is a challenge. </span><span class="koboSpan" id="kobo.495.2">The Spring test library</span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.496.1"> provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">ReflectionTestUtils</span></strong><span class="koboSpan" id="kobo.498.1"> class, which provides a method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">invokeMethod</span></strong><span class="koboSpan" id="kobo.500.1">. </span><span class="koboSpan" id="kobo.500.2">This method allows to you invoke private methods. </span><span class="koboSpan" id="kobo.500.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">invokeMethod</span></strong><span class="koboSpan" id="kobo.502.1"> method takes three arguments – the target class, the method’s name, and the method’s arguments (using variable arguments). </span><span class="koboSpan" id="kobo.502.2">Let’s use it to test the </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">AddressServiceImpl.toEntity()</span></strong><span class="koboSpan" id="kobo.504.1"> private method, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.506.1">
@Test@DisplayName("returns an AddressEntity when private method
    toEntity() is called with Address model")
public void convertModelToEntity() {
 // given
 AddressServiceImpl srvc = new AddressServiceImpl
    (repository);
 // when
 AddressEntity e = </span><strong class="bold"><span class="koboSpan" id="kobo.507.1">ReflectionTestUtils.invokeMethod(</span></strong><span class="koboSpan" id="kobo.508.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.509.1">srvc, "toEntity", addAddressReq)</span></strong><span class="koboSpan" id="kobo.510.1">;
 // then
 </span><strong class="bold"><span class="koboSpan" id="kobo.511.1">then</span></strong><span class="koboSpan" id="kobo.512.1">(e).</span><strong class="bold"><span class="koboSpan" id="kobo.513.1">as</span></strong><span class="koboSpan" id="kobo.514.1">("Check address entity is returned &amp; not null")
     .</span><strong class="bold"><span class="koboSpan" id="kobo.515.1">isNotNull</span></strong><span class="koboSpan" id="kobo.516.1">();
 then(e.getNumber()).as("Check house/flat number is set")
     .isEqualTo(entity.getNumber());
 then(e.getResidency()).as("Check residency is set")
     .isEqualTo(entity.getResidency());
 then(e.getStreet()).as("Check street is set")
     .isEqualTo(entity.getStreet());
 then(e.getCity()).as("Check city is set")
     .isEqualTo(entity.getCity());
 then(e.getState()).as("Check state is set")
     .isEqualTo(entity.getState());
 then(e.getCountry()).as("Check country is set")
     .isEqualTo(entity.getCountry());
 then(e.getPincode()).as("Check pincode is set")
     .isEqualTo(entity.getPincode());
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/test/java/com/packt/modern/api/service/AddressServiceTest.java"><span class="No-Break"><span class="koboSpan" id="kobo.517.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/test/java/com/packt/modern/api/service/AddressServiceTest.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.518.1">In the</span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.519.1"> preceding code, you </span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.520.1">can see that when you call </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">ReflectionTestUtils.invokeMethod()</span></strong><span class="koboSpan" id="kobo.522.1"> with the given arguments, it returns the </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">AddressEntity</span></strong><span class="koboSpan" id="kobo.524.1"> instance, which has been converted using the given argument’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">AddAddressReq</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.526.1">model instance.</span></span></p>
<p><span class="koboSpan" id="kobo.527.1">Here, you are using</span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.528.1"> a third kind of assertion using AssertJ’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">BDDAssertions</span></strong><span class="koboSpan" id="kobo.530.1"> class. </span><span class="koboSpan" id="kobo.530.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">BDDAssertions</span></strong><span class="koboSpan" id="kobo.532.1"> class provides methods that resonate with the </span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.533.1">BDD style. </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">BDDAssertions.then()</span></strong><span class="koboSpan" id="kobo.535.1"> takes the actual value that you want to verify. </span><span class="koboSpan" id="kobo.535.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">as()</span></strong><span class="koboSpan" id="kobo.537.1"> method describes the assertion and should be added before you perform the assertion. </span><span class="koboSpan" id="kobo.537.2">Finally, you perform verification using AssertJ’s assertion methods, such </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">isEqualTo()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.541.1">You will learn how to test void methods in the </span><span class="No-Break"><span class="koboSpan" id="kobo.542.1">next subsection.</span></span></p>
<h3><span class="koboSpan" id="kobo.543.1">Testing void methods</span></h3>
<p><span class="koboSpan" id="kobo.544.1">A method that returns a </span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.545.1">value can easily be stubbed, but how can we stub a </span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.546.1">method that returns nothing? </span><span class="koboSpan" id="kobo.546.2">Mockito provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">doNothing()</span></strong><span class="koboSpan" id="kobo.548.1"> method for this. </span><span class="koboSpan" id="kobo.548.2">It has a wrapper </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">willDoNothing()</span></strong><span class="koboSpan" id="kobo.550.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.551.1">BDDMockito</span></strong><span class="koboSpan" id="kobo.552.1"> class that internally </span><span class="No-Break"><span class="koboSpan" id="kobo.553.1">uses </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">doNothing()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.556.1">This is very handy, especially when you want such methods to do nothing while you’re spying, as </span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.558.1">
List linkedList = new LinkedList();List spyLinkedList = spy(linkedList);
doNothing().when(spyLinkedList).clear();</span></pre>
<p><span class="koboSpan" id="kobo.559.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">linkedList</span></strong><span class="koboSpan" id="kobo.561.1"> is a real object and not a mock. </span><span class="koboSpan" id="kobo.561.2">However, if you want to stub a specific method, then you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">spy()</span></strong><span class="koboSpan" id="kobo.563.1">. </span><span class="koboSpan" id="kobo.563.2">Here, when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">clear()</span></strong><span class="koboSpan" id="kobo.565.1"> method is called on </span><strong class="source-inline"><span class="koboSpan" id="kobo.566.1">spyLinkedList</span></strong><span class="koboSpan" id="kobo.567.1">, it will </span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">do nothing.</span></span></p>
<p><span class="koboSpan" id="kobo.569.1">Let’s use </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">willDoNothing</span></strong><span class="koboSpan" id="kobo.571.1"> to stub the void method and see how it helps test </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">void methods:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.573.1">
// AddressServiceTest.java@Test
@DisplayName("delete address by given existing id")
public void deleteAddressesByIdWhenExists() {
  given(repository.findById(UUID.fromString(nonExistId)))
     .willReturn(Optional.of(entity));
  </span><strong class="bold"><span class="koboSpan" id="kobo.574.1">willDoNothing()</span></strong><span class="koboSpan" id="kobo.575.1">.given(repository)
     .deleteById(UUID.fromString(nonExistId));
  // when
  service.deleteAddressesById(nonExistId);
  // then
  </span><strong class="bold"><span class="koboSpan" id="kobo.576.1">verify</span></strong><span class="koboSpan" id="kobo.577.1">(repository, </span><strong class="bold"><span class="koboSpan" id="kobo.578.1">times(1)</span></strong><span class="koboSpan" id="kobo.579.1">)
     .findById(UUID.fromString(nonExistId));
  verify(repository, times(1))
     .deleteById(UUID.fromString(nonExistId));
}</span></pre>
<p><span class="koboSpan" id="kobo.580.1">In the preceding code, </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">AddressRepository.deleteById()</span></strong><span class="koboSpan" id="kobo.582.1"> is being stubbed using Mockito’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">willDoNothing()</span></strong><span class="koboSpan" id="kobo.584.1"> method. </span><span class="koboSpan" id="kobo.584.2">Now, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">verify()</span></strong><span class="koboSpan" id="kobo.586.1"> method of Mockito, which takes two </span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.587.1">arguments – the mock object and its verification mode. </span><span class="koboSpan" id="kobo.587.2">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">times()</span></strong><span class="koboSpan" id="kobo.589.1"> verification mode is used, which determines how many times a method </span><span class="No-Break"><span class="koboSpan" id="kobo.590.1">is </span></span><span class="No-Break"><a id="_idIndexMarker792"/></span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">invoked.</span></span></p>
<p><span class="koboSpan" id="kobo.592.1">We’ll learn how to unit-test exceptional scenarios in the </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">next subsection.</span></span></p>
<h2 id="_idParaDest-208"><a id="_idTextAnchor207"/><span class="koboSpan" id="kobo.594.1">Testing exceptions</span></h2>
<p><span class="koboSpan" id="kobo.595.1">Mockito provides </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">thenThrow()</span></strong><span class="koboSpan" id="kobo.597.1"> for</span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.598.1"> stubbing methods with exceptions. </span><span class="koboSpan" id="kobo.598.2">BDDMockito’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">willThrow()</span></strong><span class="koboSpan" id="kobo.600.1"> is a wrapper that uses it internally. </span><span class="koboSpan" id="kobo.600.2">You can pass the </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">Throwable</span></strong><span class="koboSpan" id="kobo.602.1"> argument and test it </span><span class="No-Break"><span class="koboSpan" id="kobo.603.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.604.1">
// AddressServiceTest.java@Test
@DisplayName("delete address by given non-existing id,
    should throw ResourceNotFoundException")
public void deleteAddressesByNonExistId() throws Exception {
  given(repository.findById(UUID.fromString(nonExistId)))
      .willReturn(Optional.empty())
      .</span><strong class="bold"><span class="koboSpan" id="kobo.605.1">willThrow</span></strong><span class="koboSpan" id="kobo.606.1">(new ResourceNotFoundException(String.format(
  "No Address found with id %s.", nonExistId)));
  // when
  </span><strong class="bold"><span class="koboSpan" id="kobo.607.1">try</span></strong><span class="koboSpan" id="kobo.608.1"> { service.deleteAddressesById(nonExistId);
  </span><strong class="bold"><span class="koboSpan" id="kobo.609.1">} catch (Exception ex) {</span></strong><span class="koboSpan" id="kobo.610.1">
  // then
    assertThat(ex)
      .isInstanceOf(ResourceNotFoundException.class);
    assertThat(ex.getMessage())
      .contains("No Address found with id " + nonExistId);
  }
  // then
  verify(repository, times(1))
      .findById(UUID.fromString(nonExistId));
  verify(repository, times(0))
      .deleteById(UUID.fromString(nonExistId));
}</span></pre>
<p><span class="koboSpan" id="kobo.611.1">Here, you </span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.612.1">basically catch the exception and perform assertions </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">on it.</span></span></p>
<p><span class="koboSpan" id="kobo.614.1">With that, you have explored the unit tests that you can perform for both controllers and services. </span><span class="koboSpan" id="kobo.614.2">You can make use of these examples and write unit tests for the rest of </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">the classes.</span></span></p>
<h2 id="_idParaDest-209"><a id="_idTextAnchor208"/><span class="koboSpan" id="kobo.616.1">Executing unit tests</span></h2>
<p><span class="koboSpan" id="kobo.617.1">You can run the </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.618.1">following command to execute </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">unit tests:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.620.1">
$ ./gradlew clean test</span></pre> <p><span class="koboSpan" id="kobo.621.1">This will generate the unit test reports </span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">Chapter08/build/reports/tests/test/index.html</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.624.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.625.1">A generated test report will look </span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer032">
<span class="koboSpan" id="kobo.627.1"><img alt="Figure 8.1 – Unit test report" src="image/Figure_08.1_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.628.1">Figure 8.1 – Unit test report</span></p>
<p><span class="koboSpan" id="kobo.629.1">You can click on the links to drill down further. </span><span class="koboSpan" id="kobo.629.2">If the test fails, it also shows the cause of </span><span class="No-Break"><span class="koboSpan" id="kobo.630.1">the error.</span></span></p>
<p><span class="koboSpan" id="kobo.631.1">Let’s move on to the next section to learn how to configure code coverage for </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">unit tests.</span></span></p>
<h2 id="_idParaDest-210"><a id="_idTextAnchor209"/><span class="koboSpan" id="kobo.633.1">Code coverage</span></h2>
<p><span class="koboSpan" id="kobo.634.1">Code coverage provides important </span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.635.1">metrics, including line and branch coverage. </span><span class="koboSpan" id="kobo.635.2">You are going to use</span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.636.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.637.1">JaCoCo</span></strong><span class="koboSpan" id="kobo.638.1"> tool to perform and report your </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">code coverage.</span></span></p>
<p><span class="koboSpan" id="kobo.640.1">First, you need to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">jacoco</span></strong><span class="koboSpan" id="kobo.642.1"> Gradle plugin to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">build.gradle</span></strong><span class="koboSpan" id="kobo.644.1"> file, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.645.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.646.1">
plugins {    id 'org.springframework.boot' version '3.0.4'
    id 'io.spring.dependency-management' version '1.1.0'
    id 'java'
    id 'org.hidetake.swagger.generator' version '2.19.2'
    </span><strong class="bold"><span class="koboSpan" id="kobo.647.1">id 'jacoco'</span></strong><span class="koboSpan" id="kobo.648.1">
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/build.gradle"><span class="No-Break"><span class="koboSpan" id="kobo.649.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/build.gradle</span></span></a></p>
<p><span class="koboSpan" id="kobo.650.1">Next, configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.651.1">jacoco</span></strong><span class="koboSpan" id="kobo.652.1"> plugin</span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.653.1"> by providing its version and </span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">reports </span></span><span class="No-Break"><a id="_idIndexMarker799"/></span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">directory:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.656.1">
// build.gradle</span><strong class="bold"><span class="koboSpan" id="kobo.657.1">jacoco</span></strong><span class="koboSpan" id="kobo.658.1"> {
    toolVersion = "0.8.8"
    reportsDirectory = layout.buildDirectory.dir(
        "$buildDir/jacoco")
}</span></pre>
<p><span class="koboSpan" id="kobo.659.1">Next, create a new task called </span><strong class="source-inline"><span class="koboSpan" id="kobo.660.1">jacocoTestReport</span></strong><span class="koboSpan" id="kobo.661.1"> that depends on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1">test</span></strong><span class="koboSpan" id="kobo.663.1"> task because code coverage can only be evaluated after test execution. </span><span class="koboSpan" id="kobo.663.2">You don’t want to calculate coverage for auto-generated code, so add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">exclude</span></strong><span class="koboSpan" id="kobo.665.1"> block. </span><span class="koboSpan" id="kobo.665.2">Exclusion can be added by configuring </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">afterEvaluate</span></strong><span class="koboSpan" id="kobo.667.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.669.1">
// build.gradle</span><strong class="bold"><span class="koboSpan" id="kobo.670.1">jacocoTestReport</span></strong><span class="koboSpan" id="kobo.671.1"> {
    </span><strong class="bold"><span class="koboSpan" id="kobo.672.1">dependsOn test</span></strong><span class="koboSpan" id="kobo.673.1">
    afterEvaluate {
        classDirectories.setFrom(
          files(classDirectories.files.collect {
            fileTree(
                dir: it,
                </span><strong class="bold"><span class="koboSpan" id="kobo.674.1">exclude</span></strong><span class="koboSpan" id="kobo.675.1">: [
                    'com/packt/modern/api/model/*',
                    'com/packt/modern/api/*Api.*',
                    'com/packt/modern/api/security
                        /UNUSED/*',
                ])
        }))
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.676.1">Next, you need to configure </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">jacocoTestCoverageVerification</span></strong><span class="koboSpan" id="kobo.678.1">, which defines the violation rules. </span><span class="koboSpan" id="kobo.678.2">We have added instructions to cover the ratio rule in the following code block. </span><span class="koboSpan" id="kobo.678.3">This will set the expected ratio </span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.679.1">to a minimum of 90%. </span><span class="koboSpan" id="kobo.679.2">If the ratio is </span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.680.1">below 0.9, then it will fail the build. </span><span class="koboSpan" id="kobo.680.2">You can find out more about such rules </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">at </span></span><span class="No-Break"><span class="koboSpan" id="kobo.682.1">https://docs.gradle.org/current/userguide/jacoco_plugin.html#sec:jacoco_report_violation_rules</span></span><span class="No-Break"><span class="koboSpan" id="kobo.683.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.684.1">
// build.gradle</span><strong class="bold"><span class="koboSpan" id="kobo.685.1">jacocoTestCoverageVerification</span></strong><span class="koboSpan" id="kobo.686.1"> {
    violationRules {
        rule {
            limit { minimum = 0.9 }
        }
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.687.1">Next, add </span><strong class="source-inline"><span class="koboSpan" id="kobo.688.1">finalizedBy(jacocoTestReport)</span></strong><span class="koboSpan" id="kobo.689.1"> to the test task, which ensures that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">jacocoTestReport</span></strong><span class="koboSpan" id="kobo.691.1"> task will execute after performing </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">the tests:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.693.1">
test {    useJUnitPlatform()
    </span><strong class="bold"><span class="koboSpan" id="kobo.694.1">finalizedBy(jacocoTestReport)</span></strong><span class="koboSpan" id="kobo.695.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.696.1">Let’s run the following command to generate the code </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">coverage report:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.698.1">
$ ./gradlew clean build</span></pre> <p><span class="koboSpan" id="kobo.699.1">The previous command will not only run the test but also generate the code coverage report, along with the test reports. </span><span class="koboSpan" id="kobo.699.2">The code coverage report is available at </span><strong class="source-inline"><span class="koboSpan" id="kobo.700.1">Chapter08/build/jacoco/test/html/index.html</span></strong><span class="koboSpan" id="kobo.701.1"> and looks </span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer033">
<span class="koboSpan" id="kobo.703.1"><img alt="Figure 8.2 – Code coverage report" src="image/Figure_08.2_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.704.1">Figure 8.2 – Code coverage report</span></p>
<p><span class="koboSpan" id="kobo.705.1">Here, you can see that our </span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.706.1">instruction coverage is only at 29%, while our branch </span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.707.1">coverage is only at 3%. </span><span class="koboSpan" id="kobo.707.2">You can add more tests and increase </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">these percentages.</span></span></p>
<p><span class="koboSpan" id="kobo.709.1">You will learn about integration testing in the </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">next section.</span></span></p>
<h2 id="_idParaDest-211"><a id="_idTextAnchor210"/><span class="koboSpan" id="kobo.711.1">Integration testing</span></h2>
<p><span class="koboSpan" id="kobo.712.1">Once you have the automated</span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.713.1"> integration tests in place, you can ensure that any changes you make won’t produce bugs, provided you cover all the testing scenarios. </span><span class="koboSpan" id="kobo.713.2">You don’t have to add any additional plugins or libraries to support integration testing in this chapter. </span><span class="koboSpan" id="kobo.713.3">The Spring test library provides all the libraries required to write and perform </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">integration testing.</span></span></p>
<p><span class="koboSpan" id="kobo.715.1">Let’s add the configuration for integration testing in the </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">next subsection.</span></span></p>
<h3><span class="koboSpan" id="kobo.717.1">Configuring the Integration testing</span></h3>
<p><span class="koboSpan" id="kobo.718.1">First, you need a </span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.719.1">separate location for your integration tests. </span><span class="koboSpan" id="kobo.719.2">This can be configured in </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">build.gradle</span></strong><span class="koboSpan" id="kobo.721.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.723.1">
sourceSets {    integrationTest {
        java {
            compileClasspath += main.output + test.output
            runtimeClasspath += main.output + test.output
            srcDir file('src/integration/java')
        }
        resources.srcDir file('src/integration/resources')
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.724.1">Here, you </span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.725.1">add the integration tests and their resources to source sets. </span><span class="koboSpan" id="kobo.725.2">Gradle then picks the tests when a relevant Gradle command (</span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">integrationTest</span></strong><span class="koboSpan" id="kobo.727.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">build</span></strong><span class="koboSpan" id="kobo.729.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.730.1">gets executed.</span></span></p>
<p><span class="koboSpan" id="kobo.731.1">Next, you can configure the integration test’s implementation and runtime so that it’s extended from the test’s implementation and runtime, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.732.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.733.1">
configurations {    integrationTestImplementation.extendsFrom
         testImplementation
    integrationTestRuntime.extendsFrom testRuntime
}</span></pre>
<p><span class="koboSpan" id="kobo.734.1">Finally, create a task called </span><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">integrationTest</span></strong><span class="koboSpan" id="kobo.736.1"> that will not only use the JUnit Platform but also use our </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">classpath</span></strong><span class="koboSpan" id="kobo.738.1"> and test </span><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">classpath</span></strong><span class="koboSpan" id="kobo.740.1"> from </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">sourceSets.</span></strong></span><span class="No-Break"> </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">integrationTest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.743.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.744.1">Finally, configure the check task so that it depends on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">integrationTest</span></strong><span class="koboSpan" id="kobo.746.1"> task and run </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">integrationTest</span></strong><span class="koboSpan" id="kobo.748.1"> after the test task. </span><span class="koboSpan" id="kobo.748.2">You can remove the last line in the following code block if you want to run </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">integrationTest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.750.1"> separately:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.751.1">
tasks.register('integrationTest', Test) {    useJUnitPlatform()
    description = 'Runs the integration tests.'
</span><span class="koboSpan" id="kobo.751.2">    group = 'verification'
    testClassesDirs = sourceSets.integrationTest
         .output.classesDirs
    classpath = </span><strong class="bold"><span class="koboSpan" id="kobo.752.1">sourceSets.integrationTest</span></strong><span class="koboSpan" id="kobo.753.1">.runtimeClasspath
}
</span><strong class="bold"><span class="koboSpan" id="kobo.754.1">check.dependsOn integrationTest</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.755.1">integrationTest.mustRunAfter test</span></strong></pre>
<p><span class="koboSpan" id="kobo.756.1">Now, we can</span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.757.1"> start writing the integration tests. </span><span class="koboSpan" id="kobo.757.2">Before writing integration tests, first, let’s write the supporting Java classes in the next subsection. </span><span class="koboSpan" id="kobo.757.3">First, let’s create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">TestUtils</span></strong><span class="koboSpan" id="kobo.759.1"> class. </span><span class="koboSpan" id="kobo.759.2">This will contain a method that returns an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">ObjectMapper</span></strong><span class="koboSpan" id="kobo.761.1">. </span><span class="koboSpan" id="kobo.761.2">It will contain a method to check whether the JWT </span><span class="No-Break"><span class="koboSpan" id="kobo.762.1">has expired.</span></span></p>
<h3><span class="koboSpan" id="kobo.763.1">Writing supporting classes for integration tests</span></h3>
<p><span class="koboSpan" id="kobo.764.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.765.1">ObjectMapper</span></strong><span class="koboSpan" id="kobo.766.1"> instance </span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.767.1">was retrieved from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">AppConfig</span></strong><span class="koboSpan" id="kobo.769.1"> class and added an extra configuration so that we can accept a single value as an array. </span><span class="koboSpan" id="kobo.769.2">For example, a JSON string field value might be </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">{[{…}, {…}]}</span></strong><span class="koboSpan" id="kobo.771.1">. </span><span class="koboSpan" id="kobo.771.2">If you take a closer look at it, you will see that it is an array wrapped as a single value. </span><span class="koboSpan" id="kobo.771.3">When you convert this value into an object, </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">ObjectMapper</span></strong><span class="koboSpan" id="kobo.773.1"> treats it as an array. </span><span class="koboSpan" id="kobo.773.2">The complete code for this class is </span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.775.1">
public class TestUtils {  private static ObjectMapper objectMapper;
  public static boolean isTokenExpired(String jwt)
      throws JsonProcessingException {
    var encodedPayload = jwt.split("\\.")[1];
    var payload = new String(Base64.getDecoder()
        .decode(encodedPayload));
    JsonNode parent = new ObjectMapper().readTree(payload);
    String expiration = parent.path("exp").asText();
    Instant expTime = Instant.ofEpochMilli(
        Long.valueOf(expiration) * 1000);
    return Instant.now().compareTo(expTime) &lt; 0;
  }
  public static ObjectMapper objectMapper() {
    if (Objects.isNull(objectMapper)) {
      objectMapper = new AppConfig().objectMapper();
      objectMapper.configure(</span><strong class="bold"><span class="koboSpan" id="kobo.776.1">DeserializationFeatur</span></strong><span class="koboSpan" id="kobo.777.1">e
          </span><strong class="bold"><span class="koboSpan" id="kobo.778.1">.ACCEPT_SINGLE_VALUE_AS_ARRAY, true</span></strong><span class="koboSpan" id="kobo.779.1">);
    }
    return objectMapper;
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/integration/java/com/packt/modern/api/TestUtils.java"><span class="No-Break"><span class="koboSpan" id="kobo.780.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/integration/java/com/packt/modern/api/TestUtils.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.781.1">Next, you need a client that </span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.782.1">lets you log in so that you can retrieve the JWT. </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">RestTemplate</span></strong><span class="koboSpan" id="kobo.784.1"> is an HTTP client in Spring that provides support for making HTTP calls. </span><span class="koboSpan" id="kobo.784.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">AuthClient</span></strong><span class="koboSpan" id="kobo.786.1"> class makes use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">TestRestTemplate</span></strong><span class="koboSpan" id="kobo.788.1">, which is a replica of </span><strong class="source-inline"><span class="koboSpan" id="kobo.789.1">RestTemplate</span></strong><span class="koboSpan" id="kobo.790.1"> from a </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1">testing perspective.</span></span></p>
<p><span class="koboSpan" id="kobo.792.1">Let’s write this </span><strong class="source-inline"><span class="koboSpan" id="kobo.793.1">AuthClient</span></strong><span class="koboSpan" id="kobo.794.1"> class, </span><span class="No-Break"><span class="koboSpan" id="kobo.795.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.796.1">
public class AuthClient { private final </span><strong class="bold"><span class="koboSpan" id="kobo.797.1">TestRestTemplate restTemplate</span></strong><span class="koboSpan" id="kobo.798.1">;
 private final ObjectMapper objectMapper;
 public AuthClient(TestRestTemplate restTemplate,
     ObjectMapper objectMapper) {
   this.restTemplate = restTemplate;
   this.objectMapper = objectMapper;
 }
 public </span><strong class="bold"><span class="koboSpan" id="kobo.799.1">SignedInUser login</span></strong><span class="koboSpan" id="kobo.800.1">(String username,
     String password) {
   SignInReq signInReq = new SignInReq()
                     .username(username).password(password);
   return restTemplate
      .</span><strong class="bold"><span class="koboSpan" id="kobo.801.1">execute("/api/v1/auth/token",HttpMethod.POST</span></strong><span class="koboSpan" id="kobo.802.1">,
        req -&gt; {
          objectMapper.writeValue(req.getBody(),
              signInReq);
          </span><strong class="bold"><span class="koboSpan" id="kobo.803.1">req.getHeaders().add</span></strong><span class="koboSpan" id="kobo.804.1">(HttpHeaders.CONTENT_TYPE,
                 MediaType.APPLICATION_JSON_VALUE);
          req.getHeaders().add(HttpHeaders.ACCEPT,
                 MediaType.APPLICATION_JSON_VALUE);
        },
        res -&gt; objectMapper.readValue(res.getBody(),
            SignedInUser.class)
      );
   }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/integration/java/com/packt/modern/api/AuthClient.java"><span class="No-Break"><span class="koboSpan" id="kobo.805.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter08/src/integration/java/com/packt/modern/api/AuthClient.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.806.1">The Spring test library </span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.807.1">provides </span><strong class="source-inline"><span class="koboSpan" id="kobo.808.1">MockMvc</span></strong><span class="koboSpan" id="kobo.809.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">WebTestClient</span></strong><span class="koboSpan" id="kobo.811.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">TestRestTemplate</span></strong><span class="koboSpan" id="kobo.813.1"> for performing integration testing. </span><span class="koboSpan" id="kobo.813.2">You have already used </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">MockMvc</span></strong><span class="koboSpan" id="kobo.815.1"> in unit testing. </span><span class="koboSpan" id="kobo.815.2">The same approach can be used for integration testing as well. </span><span class="koboSpan" id="kobo.815.3">However, instead of using mocks, you can use the actual objects by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">@SpringBootTest</span></strong><span class="koboSpan" id="kobo.817.1"> annotation to the test class. </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">@SpringBootTest</span></strong><span class="koboSpan" id="kobo.819.1">, along with </span><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">SpringExtension</span></strong><span class="koboSpan" id="kobo.821.1">, provides all the necessary Spring context, such as the </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1">actual application.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">@TestPropertySource</span></strong><span class="koboSpan" id="kobo.824.1"> provides the location of the test </span><span class="No-Break"><span class="koboSpan" id="kobo.825.1">properties file.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.826.1">WebTestClient</span></strong><span class="koboSpan" id="kobo.827.1"> is used to test the reactive applications. </span><span class="koboSpan" id="kobo.827.2">However, to test REST services, you must use </span><strong class="source-inline"><span class="koboSpan" id="kobo.828.1">TestRestTemplate</span></strong><span class="koboSpan" id="kobo.829.1">, which is a replica </span><span class="No-Break"><span class="koboSpan" id="kobo.830.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.831.1">RestTemplate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.832.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.833.1">The integration test you are going to write is a fully fleshed-out test that doesn’t contain any mocks. </span><span class="koboSpan" id="kobo.833.2">It will use Flyway scripts, like the actual application, which we added to </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">src/integration/resources/db/migration</span></strong><span class="koboSpan" id="kobo.835.1">. </span><span class="koboSpan" id="kobo.835.2">The integration test will also have its own </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">application.properties</span></strong><span class="koboSpan" id="kobo.837.1"> located </span><span class="No-Break"><span class="koboSpan" id="kobo.838.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">src/integration/resources</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.841.1">Therefore, the integration test will be as good as if you are hitting the REST endpoints from REST clients such as cURL or Postman. </span><span class="koboSpan" id="kobo.841.2">These Flyway scripts create the tables and data required in the H2 memory database. </span><span class="koboSpan" id="kobo.841.3">This data will then be used by the RESTful web service. </span><span class="koboSpan" id="kobo.841.4">You can also use other databases, such as Postgres or MySQL, using their </span><span class="No-Break"><span class="koboSpan" id="kobo.842.1">test containers.</span></span></p>
<p><span class="koboSpan" id="kobo.843.1">Let’s create a new </span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.844.1">integration test called </span><strong class="source-inline"><span class="koboSpan" id="kobo.845.1">AddressControllerIT</span></strong><span class="koboSpan" id="kobo.846.1"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">src/ integration/java</span></strong><span class="koboSpan" id="kobo.848.1"> in an appropriate package and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">following code:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.850.1">@ExtendWith(SpringExtension.class)</span></strong><strong class="bold"><span class="koboSpan" id="kobo.851.1">@SpringBootTest( webEnvironment = WebEnvironment.RANDOM_PORT,</span></strong><span class="koboSpan" id="kobo.852.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.853.1">properties = "spring.flyway.clean-disabled=false")</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.854.1">@TestPropertySource(locations =</span></strong><span class="koboSpan" id="kobo.855.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.856.1">"classpath:application-it.properties")</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.857.1">@TestMethodOrder(OrderAnnotation.class)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.858.1">@TestInstance(TestInstance.Lifecycle.PER_CLASS</span></strong><span class="koboSpan" id="kobo.859.1">)
public class AddressControllerIT {
  private static ObjectMapper objectMapper;
  private static AuthClient authClient;
  private static SignedInUser signedInUser;
  private static Address address;
  private static String idOfAddressToBeRemoved;
  @Autowired
  private AddressRepository repository;
  @Autowired
  private TestRestTemplate restTemplate;
  </span><strong class="bold"><span class="koboSpan" id="kobo.860.1">@BeforeAll</span></strong><span class="koboSpan" id="kobo.861.1">
  public static void init(@Autowired Flyway flyway) {
    objectMapper = </span><strong class="bold"><span class="koboSpan" id="kobo.862.1">TestUtils.objectMapper();</span></strong><span class="koboSpan" id="kobo.863.1">
    address = new Address().id(
     "a731fda1-aaad-42ea-bdbc-a27eeebe2cc0").
</span><span class="koboSpan" id="kobo.863.2">       number("9I-999")
     .residency("Fraser Suites Le Claridge")
     .street("Champs-Elysees").city("Paris").state(
       "Île-de-France").country("France").pincode("75008");
    </span><strong class="bold"><span class="koboSpan" id="kobo.864.1">flyway.clean</span></strong><span class="koboSpan" id="kobo.865.1">();
    </span><strong class="bold"><span class="koboSpan" id="kobo.866.1">flyway.migrate</span></strong><span class="koboSpan" id="kobo.867.1">();
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.868.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.869.1">
  public void setup(TestInfo info)
      throws JsonProcessingException {
    if (Objects.isNull(signedInUser) ||
        Strings.isNullOrEmpty(signedInUser.getAccessToken())
        || isTokenExpired(signedInUser.getAccessToken())) {
      authClient = new AuthClient
        (restTemplate, objectMapper);
      if (</span><strong class="bold"><span class="koboSpan" id="kobo.870.1">if (info.getTags().contains("NonAdminUser")</span></strong><span class="koboSpan" id="kobo.871.1">) {
        signedInUser = </span><strong class="bold"><span class="koboSpan" id="kobo.872.1">authClient.login("scott", "tiger");</span></strong><span class="koboSpan" id="kobo.873.1">
      } else {
        signedInUser = </span><strong class="bold"><span class="koboSpan" id="kobo.874.1">authClient.login("scott2", "tiger");</span></strong><span class="koboSpan" id="kobo.875.1">
      }
    }
  }</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter08/src/integration/java/com/packt/modern/api/controller/AddressControllerIT.java"><span class="No-Break"><span class="koboSpan" id="kobo.876.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter08/src/integration/java/com/packt/modern/api/controller/AddressControllerIT.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.877.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">SpringExtension</span></strong><span class="koboSpan" id="kobo.879.1"> is now</span><a id="_idIndexMarker812"/><span class="koboSpan" id="kobo.880.1"> being used to run the unit test on the JUnit Platform. </span><span class="koboSpan" id="kobo.880.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.881.1">SpringBootTest</span></strong><span class="koboSpan" id="kobo.882.1"> annotation provides all the dependencies and context for the test class. </span><span class="koboSpan" id="kobo.882.2">A random port is being used to run the test server. </span><span class="koboSpan" id="kobo.882.3">You are also using </span><strong class="source-inline"><span class="koboSpan" id="kobo.883.1">@TestMethodOrder</span></strong><span class="koboSpan" id="kobo.884.1">, along with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.885.1">@Order</span></strong><span class="koboSpan" id="kobo.886.1"> annotation, to run the test in a particular order. </span><span class="koboSpan" id="kobo.886.2">You are going to execute the test in a particular order so that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.887.1">POST</span></strong><span class="koboSpan" id="kobo.888.1"> HTTP method on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.889.1">addresses</span></strong><span class="koboSpan" id="kobo.890.1"> resource is only called before the </span><strong class="source-inline"><span class="koboSpan" id="kobo.891.1">DELETE</span></strong><span class="koboSpan" id="kobo.892.1"> HTTP method on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.893.1">addresses</span></strong><span class="koboSpan" id="kobo.894.1"> resource. </span><span class="koboSpan" id="kobo.894.2">This is because you are passing the newly created address ID in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">DELETE</span></strong><span class="koboSpan" id="kobo.896.1"> call. </span><span class="koboSpan" id="kobo.896.2">Normally, tests run in a random order. </span><span class="koboSpan" id="kobo.896.3">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">DELETE</span></strong><span class="koboSpan" id="kobo.898.1"> call is made before the </span><strong class="source-inline"><span class="koboSpan" id="kobo.899.1">POST</span></strong><span class="koboSpan" id="kobo.900.1"> call, then the build will fail, without testing the </span><span class="No-Break"><span class="koboSpan" id="kobo.901.1">proper scenarios.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">@TestInstance</span></strong><span class="koboSpan" id="kobo.903.1"> sets the life cycle of the test instance to per class (</span><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">TestInstance.Lifecycle.PER_CLASS</span></strong><span class="koboSpan" id="kobo.905.1">) because we want to clean and migrate the database before integration </span><span class="No-Break"><span class="koboSpan" id="kobo.906.1">test execution.</span></span></p>
<p><span class="koboSpan" id="kobo.907.1">The static </span><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">init()</span></strong><span class="koboSpan" id="kobo.909.1"> method is annotated with </span><strong class="source-inline"><span class="koboSpan" id="kobo.910.1">@BeforeAll</span></strong><span class="koboSpan" id="kobo.911.1"> and will be run before all the tests. </span><span class="koboSpan" id="kobo.911.2">You are setting up </span><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">objectMapper</span></strong><span class="koboSpan" id="kobo.913.1"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.914.1">address</span></strong><span class="koboSpan" id="kobo.915.1"> model in this method. </span><span class="koboSpan" id="kobo.915.2">You are also making use of the Flyway instance for cleaning the database schema and recreating the schema using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.916.1">migrate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.917.1"> command.</span></span></p>
<p><span class="koboSpan" id="kobo.918.1">The method’s setup will be run before each test is executed because it is marked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.919.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.920.1"> annotation. </span><span class="koboSpan" id="kobo.920.2">Here, you are making sure that the login call will only be made if </span><strong class="source-inline"><span class="koboSpan" id="kobo.921.1">signedInUser</span></strong><span class="koboSpan" id="kobo.922.1"> is null or the token has expired. </span><span class="koboSpan" id="kobo.922.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.923.1">TestInfo</span></strong><span class="koboSpan" id="kobo.924.1"> instance helps us to assign different users – </span><strong class="source-inline"><span class="koboSpan" id="kobo.925.1">scott2</span></strong><span class="koboSpan" id="kobo.926.1"> (admin) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.927.1">scott</span></strong><span class="koboSpan" id="kobo.928.1"> (non-admin) – for </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">different tests.</span></span></p>
<p><span class="koboSpan" id="kobo.930.1">Let’s add an integration test that will verify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">GET /api/v1/addresses</span></strong><span class="koboSpan" id="kobo.932.1"> REST endpoint, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.934.1">
@Test@DisplayName("returns all addresses")
@Order(6)
public void getAllAddress() throws IOException {
  // given
  MultiValueMap&lt;String, String&gt; headers =
       new LinkedMultiValueMap&lt;&gt;();
  headers.add(HttpHeaders.CONTENT_TYPE,
                           MediaType.APPLICATION_JSON_VALUE);
  headers.add(HttpHeaders.ACCEPT,
                           MediaType.APPLICATION_JSON_VALUE);
  headers.add("Authorization", "Bearer " +
      signedInUser.getAccessToken());
  // when
  ResponseEntity&lt;JsonNode&gt; addressResponseEntity =
    restTemplate.exchange("</span><strong class="bold"><span class="koboSpan" id="kobo.935.1">/api/v1/addresses</span></strong><span class="koboSpan" id="kobo.936.1">",
       </span><strong class="bold"><span class="koboSpan" id="kobo.937.1">HttpMethod.GET</span></strong><span class="koboSpan" id="kobo.938.1">,
          new HttpEntity&lt;&gt;(headers), JsonNode.class);
  // then
  assertThat(addressResponseEntity.getStatusCode())
    .isEqualTo(HttpStatus.OK);
  JsonNode n = addressResponseEntity.getBody();
  List&lt;Address&gt; addressFromResponse = objectMapper
   .convertValue(n,new TypeReference
      &lt;ArrayList&lt;Address&gt;&gt;(){});
  assertThat(addressFromResponse).hasSizeGreaterThan(0);
  assertThat(addressFromResponse.get(0))
    .hasFieldOrProperty("links");
  assertThat(addressFromResponse.get(0))
    .isInstanceOf(Address.class);
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter08/src/integration/java/com/packt/modern/api/controller/AddressControllerIT.java"><span class="No-Break"><span class="koboSpan" id="kobo.939.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter08/src/integration/java/com/packt/modern/api/controller/AddressControllerIT.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.940.1">First, you must set the headers </span><a id="_idIndexMarker813"/><span class="koboSpan" id="kobo.941.1">in the given section. </span><span class="koboSpan" id="kobo.941.2">Here, you are using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.942.1">signedInUser</span></strong><span class="koboSpan" id="kobo.943.1"> instance to set the bearer token. </span><span class="koboSpan" id="kobo.943.2">Next, you must call the exchange method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.944.1">TestRestTemplate</span></strong><span class="koboSpan" id="kobo.945.1">, which takes four arguments – the URI, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.946.1">HTTP</span></strong><span class="koboSpan" id="kobo.947.1"> method, </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">HttpEntity</span></strong><span class="koboSpan" id="kobo.949.1"> (which contains the headers and payload if required), and the type of the returned value. </span><span class="koboSpan" id="kobo.949.2">You can also use optional fifth argument if the template is being used to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">urlVariables</span></strong><span class="koboSpan" id="kobo.951.1">, which expands </span><span class="No-Break"><span class="koboSpan" id="kobo.952.1">the template.</span></span></p>
<p><span class="koboSpan" id="kobo.953.1">Then, you must use the assertions to perform the verification process. </span><span class="koboSpan" id="kobo.953.2">Here, you can see that it replicates the </span><span class="No-Break"><span class="koboSpan" id="kobo.954.1">actual calls.</span></span></p>
<p><span class="koboSpan" id="kobo.955.1">Run the tests using the </span><span class="No-Break"><span class="koboSpan" id="kobo.956.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.957.1">
 $ gradlew clean integrationTest # or
 $ gradlew clean build</span></pre>
<p><span class="koboSpan" id="kobo.958.1">After this, you can find the test report in </span><strong class="source-inline"><span class="koboSpan" id="kobo.959.1">Chapter08/build/ reports/tests/integrationTest</span></strong><span class="koboSpan" id="kobo.960.1">. </span><span class="koboSpan" id="kobo.960.2">The test report should look </span><span class="No-Break"><span class="koboSpan" id="kobo.961.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer034">
<span class="koboSpan" id="kobo.962.1"><img alt="Figure 8.3 – Integration test report" src="image/Figure_08.3_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.963.1">Figure 8.3 – Integration test report</span></p>
<p><span class="koboSpan" id="kobo.964.1">You can find all the</span><a id="_idIndexMarker814"/><span class="koboSpan" id="kobo.965.1"> test address resources in </span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">AddressControllerIT.java</span></strong><span class="koboSpan" id="kobo.967.1">, which contains tests for success, errors, authentication, and authorization. </span><span class="koboSpan" id="kobo.967.2">It has tests for all types of operations, including </span><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">create</span></strong><span class="koboSpan" id="kobo.969.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.970.1">read</span></strong><span class="koboSpan" id="kobo.971.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">delete</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.973.1"> operations.</span></span></p>
<p><span class="koboSpan" id="kobo.974.1">You have now learned how to write integration tests. </span><span class="koboSpan" id="kobo.974.2">You can make use of this skill to write integration tests for other </span><span class="No-Break"><span class="koboSpan" id="kobo.975.1">REST resources.</span></span></p>
<h1 id="_idParaDest-212"><a id="_idTextAnchor211"/><span class="koboSpan" id="kobo.976.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.977.1">In this chapter, you explored both manual and automated testing. </span><span class="koboSpan" id="kobo.977.2">You learned how to write unit and integration tests using JUnit, the Spring test libraries, AssertJ, and Hamcrest. </span><span class="koboSpan" id="kobo.977.3">You also learned how to use the Gherkin </span><strong class="source-inline"><span class="koboSpan" id="kobo.978.1">Given &gt; When &gt; Then</span></strong><span class="koboSpan" id="kobo.979.1"> language to make tests more readable. </span><span class="koboSpan" id="kobo.979.2">You then learned how to separate unit and </span><span class="No-Break"><span class="koboSpan" id="kobo.980.1">integration tests.</span></span></p>
<p><span class="koboSpan" id="kobo.981.1">Finally, you learned about various test automation skills by automating unit and integration tests. </span><span class="koboSpan" id="kobo.981.2">This will help you to automate your tests and catch bugs and gaps before you deliver the code to quality analysts </span><span class="No-Break"><span class="koboSpan" id="kobo.982.1">or customers.</span></span></p>
<p><span class="koboSpan" id="kobo.983.1">In the next chapter, you will learn how to containerize an application and deploy it </span><span class="No-Break"><span class="koboSpan" id="kobo.984.1">in Kubernetes.</span></span></p>
<h1 id="_idParaDest-213"><a id="_idTextAnchor212"/><span class="koboSpan" id="kobo.985.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.986.1">What is the difference between unit testing and </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">integration testing?</span></span></li>
<li><span class="koboSpan" id="kobo.988.1">What is the advantage of having separate unit and </span><span class="No-Break"><span class="koboSpan" id="kobo.989.1">integration tests?</span></span></li>
<li><span class="koboSpan" id="kobo.990.1">What is the difference between mocking and spying on </span><span class="No-Break"><span class="koboSpan" id="kobo.991.1">an object?</span></span></li>
</ol>
<h1 id="_idParaDest-214"><a id="_idTextAnchor213"/><span class="koboSpan" id="kobo.992.1">Answers</span></h1>
<ol>
<li value="1"><span class="koboSpan" id="kobo.993.1">Unit testing is done to test the smallest code unit, such as a method, whereas integration testing is performed where either different layers or multiple modules are involved. </span><span class="koboSpan" id="kobo.993.2">In this chapter, integration testing has been performed for the entire application, which involves all the layers of the application, including the database, whereas unit testing has been performed class-wise for each of the methods. </span><span class="koboSpan" id="kobo.993.3">In the context of this chapter, unit testing is white-box testing, whereas API integration testing is a kind of black-box testing because you verify the API’s </span><span class="No-Break"><span class="koboSpan" id="kobo.994.1">functional requirement.</span></span></li>
<li><span class="koboSpan" id="kobo.995.1">Having separate unit and integration tests (and including their source location) allows you to manage tests easily. </span><span class="koboSpan" id="kobo.995.2">You can also have a configurable build setup that will perform unit testing during development or on demand because unit tests are faster. </span><span class="koboSpan" id="kobo.995.3">You can run only unit tests by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">gradlew clean build –x integrationTest</span></strong><span class="koboSpan" id="kobo.997.1"> command, whereas on merge request builds, you can execute the integration tests to verify the merge request. </span><span class="koboSpan" id="kobo.997.2">The default build (</span><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">gradlew clean build</span></strong><span class="koboSpan" id="kobo.999.1">) will execute both unit and </span><span class="No-Break"><span class="koboSpan" id="kobo.1000.1">integration tests.</span></span></li>
<li><span class="koboSpan" id="kobo.1001.1">When you use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1002.1">Mockito.mock()</span></strong><span class="koboSpan" id="kobo.1003.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1004.1">@Mock</span></strong><span class="koboSpan" id="kobo.1005.1">, it creates a complete fake object of the given class, and then you can stub its method based on the test requirement, whereas </span><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">Mockito.spy()</span></strong><span class="koboSpan" id="kobo.1007.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1008.1">@Spy</span></strong><span class="koboSpan" id="kobo.1009.1"> creates the real object, on which you can stub the required methods. </span><span class="koboSpan" id="kobo.1009.2">If stubbing is not done on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1010.1">spy</span></strong><span class="koboSpan" id="kobo.1011.1"> object, then its real methods will be called during </span><span class="No-Break"><span class="koboSpan" id="kobo.1012.1">the test.</span></span></li>
</ol>
<h1 id="_idParaDest-215"><a id="_idTextAnchor214"/><span class="koboSpan" id="kobo.1013.1">Further reading</span></h1>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1014.1">JUnit: </span></span><a href="https://junit.org/"><span class="No-Break"><span class="koboSpan" id="kobo.1015.1">https://junit.org/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">AssertJ: </span></span><a href="https://assertj.github.io/doc/"><span class="No-Break"><span class="koboSpan" id="kobo.1017.1">https://assertj.github.io/doc/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1018.1">Hamcrest: </span></span><a href="http://hamcrest.org/"><span class="No-Break"><span class="koboSpan" id="kobo.1019.1">http://hamcrest.org/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1020.1">Mockito: </span></span><a href="https://site.mockito.org/"><span class="No-Break"><span class="koboSpan" id="kobo.1021.1">https://site.mockito.org/</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1022.1">Test Automation Engineering </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1023.1">Handbook</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1024.1">: </span></span><a href="https://www.packtpub.com/product/test-automation-engineering-handbook/9781804615492"><span class="No-Break"><span class="koboSpan" id="kobo.1025.1">https://www.packtpub.com/product/test-automation-engineering-handbook/9781804615492</span></span></a></li>
</ul>
</div>
</body></html>