<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Apache Karaf for System Builders"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Apache Karaf for System Builders</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuring production-ready logging in Apache Karaf</li><li class="listitem" style="list-style-type: disc">Creating our own custom Karaf command using a Maven archetype</li><li class="listitem" style="list-style-type: disc">Branding the Apache Karaf console</li><li class="listitem" style="list-style-type: disc">Deploying applications as a feature</li><li class="listitem" style="list-style-type: disc">Using JMX to monitor and administer Apache Karaf</li><li class="listitem" style="list-style-type: disc">Reconfiguring SSH access to Apache Karaf</li><li class="listitem" style="list-style-type: disc">Installing Apache Karaf as a service</li><li class="listitem" style="list-style-type: disc">Setting up Apache Karaf for high availability</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Introduction</h1></div></div></div><p>Experienced users of Apache Karaf will tell you that out of the box, Karaf provides you with the features and tools you'll need to deploy your application. However, to build a production-ready environment, you'll want to tweak things.</p><p>The recipes in this chapter are devoted to systems builders, the people who need to make their Apache Karaf instance production-ready and applications within it manageable.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>
<span class="strong"><strong>New to Apache Karaf and OSGi?</strong></span>
</p><p>Readers interested in obtaining a deeper understanding of Apache Karaf and its underlying technologies should consult Packt Publishing's <span class="emphasis"><em>Instant OSGi Starter</em></span>, <span class="emphasis"><em>Jamie Goodyear and Johan Edstrom</em></span>, and <span class="emphasis"><em>Learning Apache Karaf</em></span>, <span class="emphasis"><em>Jamie Goodyear, Johan Edstrom, and Heath Kesler</em></span>.</p></div></div></div></div>
<div class="section" title="Configuring production-ready logging in Apache Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Configuring production-ready logging in Apache Karaf</h1></div></div></div><p>One <a id="id0" class="indexterm"/>of the first tasks administrators<a id="id1" class="indexterm"/> of Apache Karaf undertake is changing the default logging configuration to more production-ready settings.</p><p>To improve the default logging configuration, we'll perform the following tasks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Update the logfile location to be outside the data folder. This helps administrators avoid accidentally wiping out logfiles when deleting runtime data.</li><li class="listitem" style="list-style-type: disc">Increase the logfile size. The default size of 1 MB is too small for most production deployments. Generally, we set this to 50 or 100 MB, depending on the available disk space.</li><li class="listitem" style="list-style-type: disc">Increase the number of logfiles we retain. There is no correct number of logfiles to retain. However, when disk space is cheap and available, keeping a large number of files is a preferred configuration.</li></ul></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>How to do it…</h2></div></div></div><p>Configuring Karaf's logging mechanism requires you to edit the <code class="literal">etc/org.ops4j.pax.logging.cfg</code> file. Open the file with your preferred editor and alter the following highlighted code entries:</p><div class="informalexample"><pre class="programlisting"># Root logger
log4j.rootLogger=INFO, out, osgi:*
log4j.throwableRenderer=org.apache.log4j.OsgiThrowableRenderer

# File appender
log4j.appender.out=org.apache.log4j.RollingFileAppender
log4j.appender.out.layout=org.apache.log4j.PatternLayout
log4j.appender.out.layout.ConversionPattern=%d{ISO8601} | %-5.5p | %-16.16t | %-32.32c{1} | %X{bundle.id} - %X{bundle.name} - %X{bundle.version} | %m%n
<span class="strong"><strong>log4j.appender.out.file=${karaf.base}/log/karaf.log</strong></span>
log4j.appender.out.append=true
<span class="strong"><strong>log4j.appender.out.maxFileSize=10MB</strong></span>
log4j.appender.out.maxBackupIndex=100</pre></div><p>In the preceding configuration, we instruct Karaf to write logs to a log folder in the base installation directory, increase the logfile size to 10 MB, and increase the number of retained logfiles to 100.</p><p>When finished editing the file, save the changes. They will take effect shortly.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>We can change the verbosity of logging by altering the <code class="literal">log4j.rootLogger</code> entry from <code class="literal">INFO</code> to <code class="literal">DEBUG</code>, <code class="literal">WARN</code>, <code class="literal">ERROR</code>, or <code class="literal">TRACE</code>.</p></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>How it works…</h2></div></div></div><p>The logging system for Karaf is based on <span class="strong"><strong>OPS4J Pax Logging</strong></span> with the <code class="literal">log4j</code> library acting as its backend. The configuration file, <code class="literal">etc/org.ops4j.pax.logging.cfg</code>, is used to<a id="id2" class="indexterm"/> define appenders, log levels, and so on. Let's take a look at the following default appender configuration and how <a id="id3" class="indexterm"/>we'll tweak it to become more <a id="id4" class="indexterm"/>production-ready:</p><div class="informalexample"><pre class="programlisting"># Root logger
log4j.rootLogger=INFO, out, osgi:*
log4j.throwableRenderer=org.apache.log4j.OsgiThrowableRenderer

# File appender
#log4j.appender.out=org.apache.log4j.RollingFileAppender
#log4j.appender.out.layout=org.apache.log4j.PatternLayout
#log4j.appender.out.layout.ConversionPattern=%d{ISO8601} | %-5.5p | %-16.16t | %-32.32c{1} | %X{bundle.id} - %X{bundle.name} - %X{bundle.version} | %m%n
#log4j.appender.out.file=${karaf.data}/log/karaf.log
#log4j.appender.out.append=true
#log4j.appender.out.maxFileSize=1MB
#log4j.appender.out.maxBackupIndex=10</pre></div><p>In the previous code, the <code class="literal">File appender</code> configuration sets up the default Karaf logging behavior. The initial configuration sets <code class="literal">RollingFileAppender</code> and constructs a log entry pattern. The remaining options dictate the location of the logfile, its size, and the number of logfiles to retain.</p><p>Karaf monitors the configuration file in the <code class="literal">KARAF_HOME/etc</code> folder. When the updates to the configuration file are read, the logging service is updated with the new value(s). The mechanism that <a id="id5" class="indexterm"/>allows this behavior is provided by File Install (available at <a class="ulink" href="http://felix.apache.org/site/apache-felix-file-install.html">http://felix.apache.org/site/apache-felix-file-install.html</a>) and the OSGi Configuration Admin service. Have a look at the following figure:</p><div class="mediaobject"><img src="graphics/5081OS_01_02.jpg" alt="How it works…"/></div><p>As illustrated in the preceding figure, when a file in the <code class="literal">KARAF_HOME/etc</code> directory is created, deleted, or modified, the file scanner will pick up on the event. Given a configuration file change (a change in the file format of the Java properties file), a configuration<a id="id6" class="indexterm"/> processor will process<a id="id7" class="indexterm"/> the entries and update the OSGi Configuration Admin service.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>There's more…</h2></div></div></div><p>To further improve logging, you can provide the <code class="literal">log4j</code> library with an external logging location, separating the I/O requirements of logging from the base system at the expense of increased network traffic. This architecture is shown in the following figure:</p><div class="mediaobject"><img src="graphics/5081OS_01_01.jpg" alt="There's more…"/></div><p>To <a id="id8" class="indexterm"/>achieve this logging architecture, you'll<a id="id9" class="indexterm"/> need to mount the external volume on the server on which Karaf is running.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating our own custom Karaf command using a Maven archetype</em></span> recipe.</li></ul></div></div></div>
<div class="section" title="Creating our own custom Karaf command using a Maven archetype"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Creating our own custom Karaf command using a Maven archetype</h1></div></div></div><p>The Karaf <a id="id10" class="indexterm"/>console provides<a id="id11" class="indexterm"/> a multitude of useful commands to interact with the OSGi runtime and manage deployed applications. As a systems builder, you may want to develop custom commands that integrate directly into Karaf so that you can automate tasks or interact directly with your applications.</p><p>Custom Karaf commands will appear in your container as a fully integrated component of the console, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_01_03.jpg" alt="Creating our own custom Karaf command using a Maven archetype"/></div><p>The previous screenshot illustrates our sample cookbook command accepting an option flag and an argument. Let's dive into building your own command.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor. The sample code for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe2">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe2</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <a id="id12" class="indexterm"/>first step<a id="id13" class="indexterm"/> is generating a template command project. To encourage building custom commands, the community has provided the following Maven archetype invocation to generate Karaf command projects:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mvn archetype:generate \</strong></span>
<span class="strong"><strong>  -DarchetypeGroupId=org.apache.karaf.archetypes \</strong></span>
<span class="strong"><strong>  -DarchetypeArtifactId=karaf-command-archetype \</strong></span>
<span class="strong"><strong>  -DarchetypeVersion=3.0.0 \</strong></span>
<span class="strong"><strong>  -DgroupId=com.packt.chapter1 \</strong></span>
<span class="strong"><strong>  -DartifactId=command \</strong></span>
<span class="strong"><strong>-Dversion=1.0.0-SNAPSHOT \</strong></span>
<span class="strong"><strong>-Dpackage=com.packt</strong></span>
</pre></div><p>In the preceding archetype invocation, we supply the Maven project group and artifact names. The process will request you to supply a command name. Maven then generates a project template for your command.</p></li><li class="listitem">The next step is implementing your custom code. The custom command template project will supply you with a Maven POM file, Blueprint wiring (in the <code class="literal">src/main/resources/OSGI-INF/blueprint</code> directory), and custom command stub implementation (in the <code class="literal">src/main/java/</code> directory). Edit these files as required to add your custom actions.</li><li class="listitem">The last step is building and deploying the custom command in Karaf. We build our command via the Maven invocation <code class="literal">mvn install</code>. Deploying it in Karaf only requires issuing a well-formed install command; to do this, invoke <code class="literal">install –s mvn:groupId/artifactId</code> in the Karaf console. Consider the following invocation:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; install –s mvn:com.packt.chapter1/command</strong></span>
<span class="strong"><strong> Bundle ID: 88</strong></span>
<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div><p>The preceding invocation has the <code class="literal">groupId</code> value as <code class="literal">com.packt.chapter1</code> and the <code class="literal">artifactId</code> value as <code class="literal">command</code>.</p></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>How it works…</h2></div></div></div><p>The Maven archetype generates the POM build file, Java code, and Blueprint file for your custom command. Let's take a look at these key components.</p><p>The generated POM file contains all of the essential dependencies a Karaf command requires and sets up a basic Maven Bundle Plugin configuration. Edit this file to bring in additional libraries your command requires. Make sure that you update your bundle's build parameters accordingly. When this project is built, a bundle will be produced that can be installed directly into Karaf.</p><p>Our<a id="id14" class="indexterm"/> custom command logic<a id="id15" class="indexterm"/> resides in the generated Java source file, which will be named after the command name you supplied. The generated <a id="id16" class="indexterm"/>command extends Karaf's <code class="literal">OSGICommandSupport</code> class, which provides us with access to the underlying command session and OSGi environment. A <code class="literal">Command</code> annotation adorns our code. This provides the runtime <a id="id17" class="indexterm"/>with the scope, name, and description. Karaf provides the <code class="literal">Argument</code> and <code class="literal">Option</code> annotations to simplify adding a command-line argument and option processing.</p><p>The Blueprint container wires together our command implementation to the commands available in Karaf's console.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>For <a id="id18" class="indexterm"/>more information on extending Karaf's console, see <a class="ulink" href="http://karaf.apache.org/manual/latest/developers-guide/extending.html">http://karaf.apache.org/manual/latest/developers-guide/extending.html</a>.</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>There's more…</h2></div></div></div><p>Thanks to Apache Karaf's SSHD service and remote client, your custom commands can be leveraged to provide external command and control of your applications. Just pass your command and its parameters to the remote client and monitor the returned results.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Branding the Apache Karaf console</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Branding the Apache Karaf console"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Branding the Apache Karaf console</h1></div></div></div><p>Apache<a id="id19" class="indexterm"/> Karaf is used as the runtime environment for production application platforms. In such deployments, it is common to have Karaf sporting a custom branding.</p><p>The Karaf community has made rebranding the runtime a simple task. Let's make our own for this book.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor. The sample code for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe3">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe3</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is generating a Maven-based project structure. For this recipe, we need to only create the bare of Maven POM files, set its packaging to <code class="literal">bundle</code>, and include a <code class="literal">build</code> section.</li><li class="listitem">The next step is adding a resource directive to our POM file's build section. In our POM file, we add a resource directive to our build section, as shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;resource&gt;
  &lt;directory&gt;
    ${project.basedir}/src/main/resources
  &lt;/directory&gt;
  &lt;filtering&gt;true&lt;/filtering&gt;
  &lt;includes&gt;
    &lt;include&gt;**/*&lt;/include&gt;
  &lt;/includes&gt;
&lt;/resource&gt;</pre></div><p>We add a resource directive to our build section to instruct Maven to process the contents of our <code class="literal">resources</code> folder, filter any wildcards, and include the result in the generated bundle.</p></li><li class="listitem">Next, we configure the Maven Bundle Plugin as shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;configuration&gt;
  &lt;instructions&gt;
    &lt;Bundle-SymbolicName&gt;
      ${project.artifactId}
    &lt;/Bundle-SymbolicName&gt;
    &lt;Import-Package&gt;*&lt;/Import-Package&gt;
    &lt;Private-Package&gt;!*&lt;/Private-Package&gt;
    &lt;Export-Package&gt;
      org.apache.karaf.branding
    &lt;/Export-Package&gt;
    &lt;Spring-Context&gt;
      *;publish-context:=false
    &lt;/Spring-Context&gt;
  &lt;/instructions&gt;
&lt;/configuration&gt;</pre></div><p>We configured the Maven Bundle Plugin to export <code class="literal">Bundle-SymbolicName</code> as the <code class="literal">artifactId</code> and set the <code class="literal">Export-Package</code> option to <code class="literal">org.apache.karaf.branding</code>. The symbolic name as the project's <code class="literal">artifactId</code> variable is a common convention among Karaf bundle developers. We export the Karaf branding package so that the Karaf runtime will identify the bundle as containing the custom branding.</p></li><li class="listitem">The <a id="id20" class="indexterm"/>next step is creating our custom branding resource file. Returning to our project, we'll create a <code class="literal">branding.properties</code> file in the <code class="literal">src/main/resource/org/apache/karaf/branding</code> directory. This <code class="literal">.properties</code> file will contain ASCII and Jansi text characters, organized to produce your custom look. Using Maven resource filtering, you can use variable substitutions in the <code class="literal">${variable}</code> format, as shown in the following code:<div class="informalexample"><pre class="programlisting">##
welcome = \
\u001B[33m\u001B[0m\n\
\u001B[33m      _       ___  ____    ______  \u001B[0m\n\
\u001B[33m     / \\    |_  ||_  _|  .' ___  | \u001B[0m\n\
\u001B[33m    / _ \\     | |_/ /   / .'   \\_| \u001B[0m\n\
\u001B[33m   / ___ \\    |  __'.   | |        \u001B[0m\n\
\u001B[33m _/ /   \\ \\_ _| |  \\  \\_ \\ '.___.'\\ \u001B[0m\n\
\u001B[33m|____| |____||____||____| '.____ .' \u001B[0m\n\
\u001B[33m                                   \u001B[0m\n\
\u001B[33m       Apache Karaf Cookbook       \u001B[0m\n\
\u001B[33m Packt Publishing - http://www.packtpub.com\u001B[0m\n\
\u001B[33m       (version ${project.version})\u001B[0m\n\
\u001B[33m\u001B[0m\n\
\u001B[33mHit '\u001B[1m&lt;tab&gt;\u001B[0m' for a list of available commands\u001B[0m\n\
\u001B[33mand '\u001B[1m[cmd] --help\u001B[0m' for help on a specific command.\u001B[0m\n\
\u001B[33mHit '\u001B[1m&lt;ctrl-d&gt;\u001B[0m' or '\u001B[1mosgi:shutdown\u001B[0m' to shutdown\u001B[0m\n\
\u001B[33m\u001B[0m\n\</pre></div><p>In<a id="id21" class="indexterm"/> the preceding code, we use a combination of ASCII characters and Jansi text markup in the <code class="literal">branding.properties</code> file to produce simple text effects in Karaf, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_01_04.jpg" alt="How to do it…"/></div></li><li class="listitem">The final step is building and deploying our custom branding. We build our branding via the Maven invocation <code class="literal">mvn install</code>. After we build our branding bundle, we place a copy inside Karaf's <code class="literal">KARAF_HOME/lib</code> folder and then start the container. Upon the first boot, you will see our custom branding displayed.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>How it works…</h2></div></div></div><p>At the first boot, Apache Karaf will check for any bundle in its <code class="literal">lib</code> folder and will export the <code class="literal">org.apache.karaf.branding</code> package. Upon detection of this resource, it will access<a id="id22" class="indexterm"/> the <code class="literal">branding.properties</code> file content and display it as part of the runtime startup routine.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>There's more…</h2></div></div></div><p>The Apache<a id="id23" class="indexterm"/> Karaf community maintains a web console that may also be branded to reflect your organization's branding. See <a class="ulink" href="https://karaf.apache.org/index/subprojects/webconsole.html">https://karaf.apache.org/index/subprojects/webconsole.html</a> for more details.</p></div></div>
<div class="section" title="Deploying applications as a feature"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Deploying applications as a feature</h1></div></div></div><p>Managing<a id="id24" class="indexterm"/> the assembly and deployment of repository<a id="id25" class="indexterm"/> locations, bundles, configuration, and other artifacts quickly becomes a major headache for system builders. To combat this, the Karaf community has developed the concept of <span class="emphasis"><em>features</em></span>. The following figure describes the concept of features:</p><div class="mediaobject"><img src="graphics/5081OS_01_05.jpg" alt="Deploying applications as a feature"/></div><p>A feature<a id="id26" class="indexterm"/> descriptor is an XML-based file that describes<a id="id27" class="indexterm"/> a collection of artifacts to be installed together into the Karaf container. In this recipe, we'll learn how to make a feature, add it to Karaf, and then use it to install bundles.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor. The sample code for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe4">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe4</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is generating a Maven-based project. For this recipe, we need to create a Maven POM file, set its packaging to <code class="literal">bundle</code>, and include a <code class="literal">build</code> section.</li><li class="listitem">The<a id="id28" class="indexterm"/> next <a id="id29" class="indexterm"/>step is editing the POM file's <code class="literal">build</code> directives. We add a <code class="literal">resources</code> directive to our POM file's <code class="literal">build</code> section and <code class="literal">maven-resources-plugin</code> and <code class="literal">build-helper-maven-plugin</code> to its plugin list. Consider the following code:<div class="informalexample"><pre class="programlisting">&lt;resources&gt;
    &lt;resource&gt;
        &lt;directory&gt;src/main/resources&lt;/directory&gt;
        &lt;filtering&gt;true&lt;/filtering&gt;
    &lt;/resource&gt;
&lt;/resources&gt;</pre></div><p>In the preceding code, the <code class="literal">resources</code> directive indicates the location of the features file we'll create for processing. Now, consider the following code:</p><div class="informalexample"><pre class="programlisting">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;filter&lt;/id&gt;
            &lt;phase&gt;generate-resources&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;resources&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</pre></div><p>In the preceding code, <code class="literal">maven-resources-plugin</code> is configured to process our resources. Now, consider the following code:</p><div class="informalexample"><pre class="programlisting">&lt;plugin&gt;
    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
    &lt;artifactId&gt;build-helper-maven-plugin&lt;/artifactId&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;attach-artifacts&lt;/id&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;attach-artifact&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;artifacts&gt;
                    &lt;artifact&gt;
                        &lt;file&gt;${project.build.directory}/classes/${features.file}&lt;/file&gt;
                        &lt;type&gt;xml&lt;/type&gt;
                        &lt;classifier&gt;features&lt;/classifier&gt;
                    &lt;/artifact&gt;
                &lt;/artifacts&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</pre></div><p>Finally, <code class="literal">build-helper-maven-plugin</code> completes the build of our <code class="literal">features.xml</code> file as described in the preceding code.</p></li><li class="listitem">The <a id="id30" class="indexterm"/>third step is creating a <code class="literal">features.xml</code> resource. In the <code class="literal">src/main/resources</code> folder, add a file named <code class="literal">features.xml</code> with the details of your bundles, as shown in the following <a id="id31" class="indexterm"/>code:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;features&gt;

  &lt;feature name='moduleA' version='${project.version}'&gt;
    &lt;bundle&gt;
      mvn:com.packt/moduleA/${project.version}
    &lt;/bundle&gt;
  &lt;/feature&gt;

  &lt;feature name='moduleB' version='${project.version}'&gt;
    &lt;bundle&gt;
      mvn:com.packt/moduleB/${project.version}
    &lt;/bundle&gt;
  &lt;/feature&gt;

  &lt;feature name='recipe4-all-modules' version='${project.version}'&gt;
    &lt;feature version='${project.version}'&gt;moduleA&lt;/feature&gt;
    &lt;feature version='${project.version}'&gt;moduleB&lt;/feature&gt;
  &lt;/feature&gt;

&lt;/features&gt;</pre></div><p>We provide each feature with a name that Karaf will use as a reference to install each element specified in the named feature's configuration. Features may reference other features, thus providing fine-grained control over installation. In the preceding features file, we can see three named features: <code class="literal">moduleA</code>, <code class="literal">moduleB</code>, and <code class="literal">recipe4-all-modules</code>. The <code class="literal">recipe4-all-modules</code> feature includes the content of the other two features.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>If you need to include a JAR file that is not offered as a bundle, try using the <code class="literal">wrap</code> protocol to automatically provide the file with the OSGi manifest headers. For more information, see <a class="ulink" href="https://ops4j1.jira.com/wiki/display/paxurl/Wrap+Protocol">https://ops4j1.jira.com/wiki/display/paxurl/Wrap+Protocol</a>.</p></div></div></li><li class="listitem">The<a id="id32" class="indexterm"/> final step is building and deploying<a id="id33" class="indexterm"/> our feature. Using our sample recipe project, we will build our feature by executing <code class="literal">mvn install</code>. This performs all of the feature file variable substitutions and installs a processed copy in your local <code class="literal">m2</code> repository.<p>To make our feature available to Karaf, we'll add the feature file's Maven coordinates as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt;feature:repo-add mvn:com.packt/features-file/1.0.0-  SNAPSHOT/xml/features</strong></span>
</pre></div><p>Now, we can use Karaf's <code class="literal">feature</code> commands to install <code class="literal">moduleA</code> and <code class="literal">moduleB</code>, as shown in the following command-line snippet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt;feature:install recipe4-all-modules</strong></span>
<span class="strong"><strong>Apache Karaf starting moduleA bundle</strong></span>
<span class="strong"><strong>Apache Karaf starting moduleB bundle</strong></span>
<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div><p>Using <code class="literal">feature:install</code> in<a id="id34" class="indexterm"/> this fashion helps to promote repeatable deployments and avoid missing component installations that are not caught by the OSGi environment (if no bundle dependencies are missing, then as far as the container is concerned, all is well). We can verify whether our feature is installed by invoking the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt;feature:list | grep –i "recipe"</strong></span>
</pre></div><p>We can then observe whether our feature is listed or not.</p></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec22"/>How it works…</h2></div></div></div><p>When<a id="id35" class="indexterm"/> Karaf processes a feature descriptor as a bundle, hot <a id="id36" class="indexterm"/>deployment, or via a system start-up property, the same processing and assembly functions occur, as shown in the following figure:</p><div class="mediaobject"><img src="graphics/5081OS_01_06.jpg" alt="How it works…"/></div><p>The feature descriptor invocation is transformed into a list of artifacts to be installed in the OSGi container. At the lowest level, individual elements in a feature have a handler to obtain the described artifact (such as a bundle, JAR file, or configuration file). Our sample feature uses Maven coordinates to obtain bundles, and the Maven handler will be called to process these resources. If an HTTP URL was specified, then the HTTP handler is called. Each artifact in the specified feature will be installed until the entire list is processed.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec23"/>There's more…</h2></div></div></div><p>The <span class="emphasis"><em>How to do it…</em></span> section of this recipe outlines a general methodology to produce a feature<a id="id37" class="indexterm"/> file for your projects and automate the filtering <a id="id38" class="indexterm"/>of resource versions. From Apache Karaf's point of view, it just processes a well-formatted features file so that you can handwrite the file and deploy it directly into Karaf.</p><p>Feature files have additional attributes that can be used to set bundle start levels, flag bundles as being dependencies, and set configuration properties. For more information, visit <a class="ulink" href="http://karaf.apache.org/manual/latest/users-guide/provisioning.html">http://karaf.apache.org/manual/latest/users-guide/provisioning.html</a>.</p><p>An advanced <a id="id39" class="indexterm"/>use case of Karaf feature files is to build a <span class="strong"><strong>KAraf aRchive</strong></span> (<span class="strong"><strong>KAR</strong></span>). A KAR file is the processed form of a feature file, collecting all the required artifacts into a single deployable form. This archive is ideal for deployment when your Karaf instance will not have access to remote repositories, as all required resources are packaged in the KAR file.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec24"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We'll be using the features concept of Apache Karaf in several chapters of this book to simplify the installation of Apache Camel, ActiveMQ, and CXF among other projects.</li></ul></div></div></div>
<div class="section" title="Using JMX to monitor and administer Apache Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Using JMX to monitor and administer Apache Karaf</h1></div></div></div><p>By <a id="id40" class="indexterm"/>default, Apache Karaf can be administered<a id="id41" class="indexterm"/> via <a id="id42" class="indexterm"/>Java Management Extensions (JMX). However, systems<a id="id43" class="indexterm"/> builders often need to tweak the default configurations to get their deployment integrated into their network. In this recipe, we'll show you how to make these changes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec25"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, and a<a id="id44" class="indexterm"/> source code editor. The sample configuration <a id="id45" class="indexterm"/>for <a id="id46" class="indexterm"/>this recipe is<a id="id47" class="indexterm"/> available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe5">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe5</a>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p>Administrators should take care when exposing JMX access to their Karaf instance. Enabling of SSL and use of strong passwords is recommended.</p></div></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec26"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is editing the management configuration. Apache Karaf ships with a default management configuration. To make our modifications, we update the <code class="literal">etc/org.apache.karaf.management.cfg</code> file. Consider the following code:<div class="informalexample"><pre class="programlisting">#
# Port number for RMI registry connection
#
rmiRegistryPort = 11099

#
# Port number for RMI server connection
#
rmiServerPort = 44445</pre></div><p>The default ports, 1099 and 44444, are usually fine for general deployment. Change these ports only if you are experiencing port conflicts on your deployment. Now, consider the following snippet:</p><div class="informalexample"><pre class="programlisting">#
# Role name used for JMX access authorization
# If not set, this defaults to the ${karaf.admin.role} configured in etc/system.properties
#
jmxRole=admin</pre></div><p>Towards the bottom of the configuration file, there will be a commented-out entry for <code class="literal">jmxRole</code>; enable this by removing the hash character.</p></li><li class="listitem">The next step is updating the user's file. We must now update the <code class="literal">etc/users.properties</code> file with the following code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf = karaf,_g_:admingroup</strong></span>
<span class="strong"><strong>_g_\:admingroup = group,admin,manager,viewer,jmxRole</strong></span>
</pre></div><p>The <code class="literal">users.properties</code> file is used to configure users, groups, and roles <a id="id48" class="indexterm"/>in Karaf. We append <code class="literal">jmxRole</code> to the admin group. The syntax for this file follows the <code class="literal">Username = password, groups</code> format.</p></li><li class="listitem">The<a id="id49" class="indexterm"/> last step is testing our configuration. After making the previous configuration changes, we'll need to restart <a id="id50" class="indexterm"/>our Karaf instance. Now, we <a id="id51" class="indexterm"/>can test our <a id="id52" class="indexterm"/>JMX setup. Have a look at the following screenshot:<div class="mediaobject"><img src="graphics/5081OS_01_07.jpg" alt="How to do it…"/></div><p>After restarting Karaf, use a JMX-based admin tool of your choice (the previous screenshot shows JConsole) to connect to the container. Due<a id="id53" class="indexterm"/> to<a id="id54" class="indexterm"/> image <a id="id55" class="indexterm"/>size<a id="id56" class="indexterm"/> restrictions, the full URL couldn't be displayed. The full URL is <code class="literal">service:jmx:rmi://127.0.0.1:44445/jndi/rmi://127.0.0.1:11099/karaf-root</code>. The syntax of the URL is <code class="literal">service:jmx:rmi://host:${rmiServerPort}/jndi/rmi://host:${rmiRegistryPort}/${karaf-instance-name}</code>.</p></li></ol></div></div></div>
<div class="section" title="Reconfiguring SSH access to Apache Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Reconfiguring SSH access to Apache Karaf</h1></div></div></div><p>Using <a id="id57" class="indexterm"/>Apache Karaf via its local console <a id="id58" class="indexterm"/>provides the user with superb command and control capabilities over their OSGi container. Apache Karaf's remote console extends this experience to remote consoles, and as such, presents systems builders with an opportunity to further harden their systems. In this recipe, we'll change Karaf's default remote connection parameters.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec27"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, and a source code editor. The sample configuration for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe6">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe6</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec28"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is editing the shell configuration. Apache Karaf ships with a default shell configuration file. It's a good practice to edit entries in the <code class="literal">etc/org.apache.karaf.shell.cfg</code> file to point to the non-default ports as a security precaution. Consider the following code:<div class="informalexample"><pre class="programlisting">#
# Via sshPort and sshHost you define the address you can login into Karaf.
#
sshPort = 8102
sshHost = 192.168.1.110</pre></div><p>In the preceding sample configuration, we defined the port for SSH access to <code class="literal">8102</code> and set <code class="literal">sshHost</code> to an IP address of the host machine (the default value, 0.0.0.0, means the SSHD service is bound to all network interfaces). Restricting access to particular network interfaces can help reduce unwanted access.</p></li><li class="listitem">The<a id="id59" class="indexterm"/> next step is restarting <a id="id60" class="indexterm"/>Karaf. After editing the configuration, we must restart Karaf. Once restarted, you'll be able to connect to Karaf using an SSH client command as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ssh –p 8102 karaf@127.0.0.1</strong></span>
</pre></div><p>Upon connection, you'll be prompted for your password.</p></li></ol></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec29"/>There's more…</h2></div></div></div><p>Changing the default remote access configuration is a good start. However, system builders should also consider changing the default <code class="literal">karafuser/password</code> combination found in the <code class="literal">users.properties</code> file.</p><p>You might also<a id="id61" class="indexterm"/> decide to generate a server SSH key file to simplify remote access. Information regarding this configuration can be found at <a class="ulink" href="http://karaf.apache.org/manual/latest/users-guide/remote.html">http://karaf.apache.org/manual/latest/users-guide/remote.html</a>.</p></div></div>
<div class="section" title="Installing Apache Karaf as a service"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Installing Apache Karaf as a service</h1></div></div></div><p>When<a id="id62" class="indexterm"/> we install Apache Karaf, we'll want it to operate<a id="id63" class="indexterm"/> as a system service on our host platform (just like Windows or Linux). In this recipe, we'll set up Karaf to start when your system boots up.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec30"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, and a source code editor. The sample wrapper configuration for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe7">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe7</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec31"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is installing the service wrapper feature. Apache Karaf utilizes a service wrapper feature to handle gathering and deploying of the required resources for your host operating environment. We begin its installation by invoking the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt;feature:install service-wrapper</strong></span>
</pre></div><p>The service wrapper feature URL is included in Karaf by default; so, no additional step is required to make it available.</p></li><li class="listitem">The next <a id="id64" class="indexterm"/>step is installing the wrapper <a id="id65" class="indexterm"/>service. Now, we must instruct the wrapper to configure and install the appropriate service scripts and resources for us. Consider the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt;wrapper:install –s AUTO_START –n Karaf3 –D "Apache Karaf Cookbook"</strong></span>
</pre></div><p>The<a id="id66" class="indexterm"/> preceding <code class="literal">wrapper:install</code> command invocation includes three flags: <code class="literal">-s</code> for the start type, <code class="literal">-n</code> for the service name, and <code class="literal">–D</code> for the service description. The start type can be one of two options: <code class="literal">AUTO_START</code>, to automatically start the service on boot, and <code class="literal">DEMAND_START</code>, to start only when manually invoked. The service name is used as an identifier in the host's service registry. The description provides system administrators with a brief description of your Karaf installation. After executing the <code class="literal">install</code> command, the Karaf console will display the libraries, scripts, and configuration files that the wrapper generates. You'll now need to exit Karaf to continue the service installation.</p></li><li class="listitem">The final step is integrating it in to the host operating system. This step will require administrator level permissions to execute the generated Karaf service wrapper installation scripts.<p>The following command installs the service natively into Windows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>C:&gt; C:\Path\To\apache-karaf-3.0.0\bin\Karaf3-service.bat install</strong></span>
</pre></div><p>The following <code class="literal">net</code> commands allow an administrator to start or stop the Karaf service:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>C:&gt; net start "Karaf3"</strong></span>
<span class="strong"><strong>C:&gt; net stop "Karaf3"</strong></span>
</pre></div><p>Linux integration will vary based on distribution. The following commands will work on Debian- or Ubuntu-based systems:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>jgoodyear@ubuntu1204:~$ ln –s /Path/To/apache-karaf-3.0.0/bin/Karaf3-service /etc/init.d</strong></span>
<span class="strong"><strong>jgoodyear@ubuntu1204:~$ update-rc.d Karaf3-service defaults</strong></span>
<span class="strong"><strong>jgoodyear@ubuntu1204:~$ /etc/init.d/Karaf3-service start</strong></span>
<span class="strong"><strong>jgoodyear@ubuntu1204:~$ /etc/init.d/Karaf3-service stop</strong></span>
</pre></div><p>The first command creates a symbolic link from the service script in Karaf's <code class="literal">bin</code> folder to the <code class="literal">init.d</code> directory and then updates the startup scripts to include the Karaf service to automatically start during boot. The remaining two commands can be used to manually start or stop the Karaf service.</p></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec32"/>How it works…</h2></div></div></div><p>The <a id="id67" class="indexterm"/>wrapper service feature integrates Karaf into the<a id="id68" class="indexterm"/> host operating system's service mechanism. This means that on a Windows- or Linux-based system, Karaf will avail of the available fault, crash, processing freeze, out of memory, or similar event detections and automatically attempt to restart Karaf.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec33"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Setting up Apache Karaf for high availability</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Setting up Apache Karaf for high availability"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec16"/>Setting up Apache Karaf for high availability</h1></div></div></div><p>To help <a id="id69" class="indexterm"/>provide higher service availability, Karaf provides the option to set up a secondary instance of Apache Karaf to failover<a id="id70" class="indexterm"/> upon in case of an operating<a id="id71" class="indexterm"/> environment error. In this recipe, we'll configure a <span class="strong"><strong>Master/Slave</strong></span> failover deployment and briefly discuss how you can expand the recipe to multiple hosts.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec34"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, and a source code editor. The sample configuration for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe8">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter1/chapter1-recipe8</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec35"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is editing the system properties file. To enable a Master/Slave failover, we edit the <code class="literal">etc/system.properties</code> file of two or more Karaf instances to include the following Karaf locking configuration:<div class="informalexample"><pre class="programlisting">##
## Sample lock configuration
##
karaf.lock=true
karaf.lock.class=org.apache.karaf.main.lock.SimpleFileLock
# specify path to lock directory
karaf.lock.dir=[PathToLockFileDirectory]
karaf.lock.delay=10</pre></div><p>The previous configuration sample contains the essential entries for a file-based locking mechanism, that is, two or more Karaf instances attempt to gain exclusive ownership of a file over a shared filesystem.</p></li><li class="listitem">The<a id="id72" class="indexterm"/> next step is providing<a id="id73" class="indexterm"/> locking resources. If using a shared locking file approach is suitable to your deployment, then all you must do at this time is mount the filesystem on each machine that'll host Karaf instances in the Master/Slave deployment.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>If you plan to use the shared file lock, consider using an NFSv4 filesystem, as it implements flock correctly.</p></div></div><p>Each Karaf instance will include the same lock directory location on a shared filesystem common to each Karaf installation. If a shared filesystem is not practical between systems, then a JDBC locking mechanism can be used. This is described in the following code:</p><div class="informalexample"><pre class="programlisting">karaf.lock=true
karaf.lock.class=org.apache.karaf.main.DefaultJDBCLock
karaf.lock.delay=10
karaf.lock.jdbc.url=jdbc:derby://dbserver:1527/sample
karaf.lock.jdbc.driver=org.apache.derby.jdbc.ClientDriver
karaf.lock.jdbc.user=user
karaf.lock.jdbc.password=password
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30</pre></div><p>The JDBC configuration is similar to the SimpleFileLock configuration. However, it is expanded to contain the JDBC <code class="literal">url</code>, <code class="literal">driver</code>, <code class="literal">timeout</code>, <code class="literal">user</code>, and <code class="literal">password</code> options. Two additional JDBC options are included to allow for multiple Master/Slave Karaf deployments to use a single database. These are the JDBC <code class="literal">table</code> and <code class="literal">clustername</code> options. The JDBC <code class="literal">table</code> property sets the database table to use for the lock, and the JDBC <code class="literal">clustername</code> property specifies which pairing group a Karaf instance belongs to (for example, hosts A and B belong to a cluster prod group, and hosts C and D belong to a cluster dev group).</p><p>When using the JDBC locking mechanism, you'll have to provide the relevant JDBC driver JAR file to Karaf's <code class="literal">lib/ext</code> folder. For specific database configurations, consult Karaf's user manual (<a class="ulink" href="http://karaf.apache.org/manual/latest/index.html">http://karaf.apache.org/manual/latest/index.html</a>).</p></li><li class="listitem">The final <a id="id74" class="indexterm"/>step is verifying the lock behavior. Once you have configured each Karaf instance to be <a id="id75" class="indexterm"/>a participant of the Master/Slave deployment and ensured that any locking resources have been made available (mounted filesystems or database drivers/connectivity), you must now validate that it is all working as desired. The general test to perform is to start one instance of Karaf, allow it to gain the lock (you'll see this recorded in the logfile), and then start all additional instances. Only the first instance should be fully booted; the others should be trying to gain the lock. Stopping this first instance should result in another instance becoming the Master. This verification step is vital. Most Master/Slave deployment failures occur due to misconfigurations or shared resource permissions.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec36"/>How it works…</h2></div></div></div><p>Each instance of Apache Karaf contains a copy of the locking configuration in its <code class="literal">etc/system.properties</code> file. This is described in the following figure:</p><div class="mediaobject"><img src="graphics/5081OS_01_08.jpg" alt="How it works…"/></div><p>In the<a id="id76" class="indexterm"/> case of a SimpleFileLock configuration, Karaf attempts to utilize an exclusive lock upon a file to manage which Karaf instance<a id="id77" class="indexterm"/> will operate as a live (Master) container. The other instances in the set will try gaining lock file access for <code class="literal">karaf.lock.delay</code> seconds each. This can be easily simulated on a single host machine with two Karaf installations both configured to use the same locking file. If the lock file is located on a shared NFSv4 filesystem, then multiple servers may be able to use this configuration. However, a JDBC-based lock is the most often used in multihost architectures.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec37"/>There's more…</h2></div></div></div><p>Karaf failover describes an active/passive approach to high availability. There is also a similar concept that provides active/active architecture via Apache Karaf Cellar.</p></div></div></body></html>