<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Clustering WildFly"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Clustering WildFly</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a cluster in standalone mode</li><li class="listitem" style="list-style-type: disc">Creating separate clusters in standalone mode</li><li class="listitem" style="list-style-type: disc">Creating a cluster in domain mode</li><li class="listitem" style="list-style-type: disc">Creating separate clusters in domain mode</li><li class="listitem" style="list-style-type: disc">Creating a cluster via TCP</li><li class="listitem" style="list-style-type: disc">Testing the UDP protocol with the JGroups tool</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec56"/>Introduction</h1></div></div></div><p>In this chapter, you will learn <a id="id420" class="indexterm"/>how to create a cluster for a web application spread across two or more WildFly nodes. Clustering is the capability to continue serving a client, even in case of failures (that is, a server crash), and is also known as failover.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>Clustering is meant to be at the application level and not at the OS level.</p></div></div><p>For example, suppose you are filling in a long form, in a large number of steps (where steps are meant to be pages). Now suppose that in the last step, the server or the WildFly node crashes, you would have to refill all the information again. Surely, you will not use that site anymore, if you can choose to do so. By the way, how would you address such a problem? Clustering is the answer.</p><p>In clustering, you get the user's session replicated to your cluster nodes. So in case of a  failure, in the next HTTP request, you will land on a different server/node, which will continue serving you just as though nothing happened—obviously, the end user will not see that his/her request has been served by a different server/node.</p><p>In WildFly, we have two components (from a configuration file point of view, they are subsystems) that accomplish this job; they are <span class="emphasis"><em>infinispan</em></span> (for caching the data session) and <span class="emphasis"><em>JGroups</em></span> (to spread HTTP sessions across cluster nodes). Infinispan is the component that stores the data, whilst JGroups is the component that orchestrates the communication between the nodes forming the application cluster.</p><p>We will see how clustering <a id="id421" class="indexterm"/>can be achieved using different protocols: UDP (multicast and also the default one) and TCP (unicast). This can be configured in the <code class="literal">jgroups</code> subsystem. The default one is UDP.</p><p>For the sake of completeness, we will try our configuration in both the operational modes: standalone and domain.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>Remember that clustering is a service provided by WildFly, as such, it is activated on demand. Thus, you will need to provide a <code class="literal">cluster-aware</code> application in order to activate clustering. That means having the <code class="literal">&lt;distributable/&gt;</code> XML tag inside your <code class="literal">web.xml</code> file.</p></div></div><p>Within this chapter, you will need a standard WildFly installation and a settled management user. If you are starting from here, take a look at <a class="link" href="ch01.html" title="Chapter 1. Welcome to WildFly!">Chapter 1</a>, <span class="emphasis"><em>Welcome to WildFly!</em></span>
</p></div></div>
<div class="section" title="Creating a cluster in standalone mode"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec57"/>Creating a cluster in standalone mode</h1></div></div></div><p>In this recipe, you <a id="id422" class="indexterm"/>will learn how to cluster two WildFly <a id="id423" class="indexterm"/>nodes locally, that is, on your PC. We will try this using the standalone mode and the <code class="literal">ha</code> profile.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec140"/>Getting ready</h2></div></div></div><p>For this recipe, we will need the <code class="literal">cluster-aware</code> application named <code class="literal">cluster-test</code>, that you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</p><p>To build the application, give the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd ~/WFC/github/wildfly-cookbook
$ cd cluster-test
$ mvn -e clean package</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec141"/>How to do it...</h2></div></div></div><p>From the WildFly installation directory <code class="literal">$WILDFLY_HOME</code>, let's create two folders, each one representing a server node:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone cl-std-node-1
$ cp -a standalone cl-std-node-2</pre></div></li><li class="listitem">Now, let's copy the <code class="literal">cluster-test.war</code> application into the <code class="literal">deployments</code> folder of each node that we have just created. Execute the following commands:<div class="informalexample"><pre class="programlisting">$ cp ~/WFC/github/wildfly-cookbook/cluster-test/target/cluster-test.war cl-std-node-1/deployments/
$ cp ~/WFC/github/wildfly-cookbook/cluster-test/target/cluster-test.war cl-std-node-2/deployments/</pre></div></li><li class="listitem">We are <a id="id424" class="indexterm"/>almost ready to test our cluster. We <a id="id425" class="indexterm"/>need some configuration, but without editing much,  we will just pass a command-line parameter to the <code class="literal">standalone.sh</code> script. Let's do it:<div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-node-1 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=100 -Djboss.node.name=node-1
...
<span class="strong"><strong>02:26:22,755 INFO  [org.jboss.as.server.deployment] (MSC service thread 1-14) WFLYSRV0027: Starting deployment of "cluster-test.war" (runtime-name: "cluster-test.war")</strong></span>
02:26:22,910 INFO  [org.jboss.ws.common.management] (MSC service thread 1-2) JBWS022052: Starting JBoss Web Services - Stack CXF Server 5.0.0.Beta3
02:26:23,843 INFO  [stdout] (MSC service thread 1-6)
<span class="strong"><strong>02:26:23,843 INFO  [stdout] (MSC service thread 1-6) -------------------------------------------------------------------</strong></span>
<span class="strong"><strong>02:26:23,843 INFO  [stdout] (MSC service thread 1-6) GMS: address=node-1, cluster=ee, physical address=127.0.0.1:55300</strong></span>
<span class="strong"><strong>02:26:23,843 INFO  [stdout] (MSC service thread 1-6) -------------------------------------------------------------------</strong></span>
02:26:27,145 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 64) ISPN000078: Starting JGroups channel web
<span class="strong"><strong>02:26:27,154 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 64) ISPN000094: Received new cluster view for channel web: [node-1|0] (1) [node-1]</strong></span>
<span class="strong"><strong>02:26:27,155 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 64) ISPN000079: Channel web local address is node-1, physical addresses are [127.0.0.1:55300]</strong></span>
02:26:27,163 INFO  [org.infinispan.factories.GlobalComponentRegistry] (ServerService Thread Pool -- 64) ISPN000128: Infinispan version: Infinispan 'Hoptimus Prime' 7.1.1.Final
<span class="strong"><strong>02:26:27,706 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 64) WFLYCLINF0002: Started dist cache from web container</strong></span>
02:26:27,706 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 62) WFLYCLINF0002: Started cluster-test.war cache from web container
02:26:27,970 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-16) WFLYUT0021: Registered web context: /cluster-test
02:26:28,006 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 36) WFLYSRV0010: Deployed "cluster-test.war" (runtime-name : "cluster-test.war")
02:26:28,182 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:10090/management
02:26:28,183 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:10090
02:26:28,183 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 9.0.0.Beta2 (WildFly Core 1.0.0.Beta2) started in 8645ms - Started 334 of 516 services (285 services are lazy, passive or on-demand)</pre></div><p>In the preceding command, I've emphasized only the relevant outputs; this is to give you a clear view of the clustering service.</p></li><li class="listitem">Let's open <a id="id426" class="indexterm"/>a browser and point it to the URL <a id="id427" class="indexterm"/><code class="literal">http://127.0.0.1:8180/cluster-test</code>. Now refresh the page a few times. You should see something like the following screenshot:<div class="mediaobject"><img src="graphics/3744_06_01.jpg" alt="How to do it..."/><div class="caption"><p>"cluster-test" application running on "node-1"</p></div></div><p>In the log, you <a id="id428" class="indexterm"/>should find the <a id="id429" class="indexterm"/>following statements:</p><div class="informalexample"><pre class="programlisting">15:20:25,118 INFO  [stdout] (default task-3) ********************************+
15:20:25,119 INFO  [stdout] (default task-3) Visitor(s): 0
15:20:25,119 INFO  [stdout] (default task-3) ********************************+
15:20:25,228 INFO  [stdout] (default task-4) ********************************+
15:20:25,229 INFO  [stdout] (default task-4) Visitor(s): 1
15:20:25,229 INFO  [stdout] (default task-4) ********************************+
15:20:25,291 INFO  [stdout] (default task-5) ********************************+
15:20:25,291 INFO  [stdout] (default task-5) Visitor(s): 2
15:20:25,291 INFO  [stdout] (default task-5) ********************************+
15:20:25,315 INFO  [stdout] (default task-6) ********************************+
15:20:25,315 INFO  [stdout] (default task-6) Visitor(s): 3
15:20:25,316 INFO  [stdout] (default task-6) ********************************+
15:20:25,608 INFO  [stdout] (default task-7) ********************************+
15:20:25,609 INFO  [stdout] (default task-7) Visitor(s): 4
15:20:25,609 INFO  [stdout] (default task-7) ********************************+</pre></div><p>Now that everything has gone well, let's start the second node and see what happens.</p></li><li class="listitem">In a new <a id="id430" class="indexterm"/>terminal, execute the following <a id="id431" class="indexterm"/>commands:<div class="informalexample"><pre class="programlisting">$ cd $JBOSS_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-node-2 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=200 -Djboss.node.name=node-2
…
03:13:44,381 INFO  [org.jboss.as.server.deployment] (MSC service thread 1-14) WFLYSRV0027: Starting deployment of "cluster-test.war" (runtime-name: "cluster-test.war")
03:13:44,548 INFO  [org.jboss.ws.common.management] (MSC service thread 1-15) JBWS022052: Starting JBoss Web Services - Stack CXF Server 5.0.0.Beta3
03:13:45,075 INFO  [stdout] (MSC service thread 1-6)
<span class="strong"><strong>03:13:45,075 INFO  [stdout] (MSC service thread 1-6) -------------------------------------------------------------------</strong></span>
<span class="strong"><strong>03:13:45,075 INFO  [stdout] (MSC service thread 1-6) GMS: address=node-2, cluster=ee, physical address=127.0.0.1:55400</strong></span>
<span class="strong"><strong>03:13:45,077 INFO  [stdout] (MSC service thread 1-6) -------------------------------------------------------------------</strong></span>
<span class="strong"><strong>03:13:45,153 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-2,ee,node-1) ISPN000094: Received new cluster view for channel web: [node-1|1] (2) [node-1, node-2]</strong></span>
<span class="strong"><strong>03:13:45,675 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000078: Starting JGroups channel web</strong></span>
<span class="strong"><strong>03:13:45,679 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000094: Received new cluster view for channel web: [node-1|1] (2) [node-1, node-2]</strong></span>
<span class="strong"><strong>03:13:45,680 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000079: Channel web local address is node-2, physical addresses are [127.0.0.1:55400]</strong></span>
03:13:45,747 INFO  [org.infinispan.factories.GlobalComponentRegistry] (ServerService Thread Pool -- 62) ISPN000128: Infinispan version: Infinispan 'Hoptimus Prime' 7.1.1.Final
<span class="strong"><strong>03:13:46,187 INFO  [org.infinispan.CLUSTER] (remote-thread--p3-t1) ISPN000310: Starting cluster-wide rebalance for cache cluster-test.war, topology CacheTopology{id=1, rebalanceId=1, currentCH=DefaultConsistentHash{ns = 80, owners = (1)[node-1: 80+0]}, pendingCH=DefaultConsistentHash{ns = 80, owners = (2)[node-1: 40+40, node-2: 40+40]}, unionCH=null, actualMembers=[node-1, node-2]}</strong></span>
<span class="strong"><strong>03:13:46,187 INFO  [org.infinispan.CLUSTER] (remote-thread--p3-t2) ISPN000310: Starting cluster-wide rebalance for cache dist, topology CacheTopology{id=1, rebalanceId=1, currentCH=DefaultConsistentHash{ns = 80, owners = (1)[node-1: 80+0]}, pendingCH=DefaultConsistentHash{ns = 80, owners = (2)[node-1: 40+40, node-2: 40+40]}, unionCH=null, actualMembers=[node-1, node-2]}</strong></span>
<span class="strong"><strong>03:13:46,204 INFO  [org.infinispan.CLUSTER] (transport-thread--p2-t10) ISPN000328: Finished local rebalance for cache cluster-test.war on node node-1, topology id = 1</strong></span>
<span class="strong"><strong>03:13:46,209 INFO  [org.infinispan.CLUSTER] (transport-thread--p2-t11) ISPN000328: Finished local rebalance for cache dist on node node-1, topology id = 1</strong></span>
<span class="strong"><strong>03:13:46,416 INFO  [org.infinispan.CLUSTER] (remote-thread--p3-t1) ISPN000328: Finished local rebalance for cache dist on node node-2, topology id = 1</strong></span>
<span class="strong"><strong>03:13:46,431 INFO  [org.infinispan.CLUSTER] (remote-thread--p3-t2) ISPN000328: Finished local rebalance for cache cluster-test.war on node node-2, topology id = 1</strong></span>
<span class="strong"><strong>03:13:46,461 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 62) WFLYCLINF0002: Started dist cache from web container</strong></span>
<span class="strong"><strong>03:13:46,461 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 64) WFLYCLINF0002: Started cluster-test.war cache from web container</strong></span>
03:13:46,662 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-3) WFLYUT0021: Registered web context: /cluster-test
03:13:46,700 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 36) WFLYSRV0010: Deployed "cluster-test.war" (runtime-name : "cluster-test.war")
03:13:46,863 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:10190/management
03:13:46,864 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:10190
03:13:46,864 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 9.0.0.Beta2 (WildFly Core 1.0.0.Beta2) started in 5424ms - Started 334 of 516 services (285 services are lazy, passive or on-demand)</pre></div><p>In the preceding command-line output, I've emphasized only the relevant outputs; this is to give you a clear view of the clustering service. Unlike <code class="literal">node-1</code>, we can see that now the cluster is composed of two members: <code class="literal">node-1</code> and <code class="literal">node-2</code>.</p></li><li class="listitem">Now, let's try <a id="id432" class="indexterm"/>pointing the same browser <a id="id433" class="indexterm"/>window to the URL <code class="literal">http://127.0.0.1:8280/cluster-test</code>. You should see something like this:<div class="mediaobject"><img src="graphics/3744_06_02.jpg" alt="How to do it..."/><div class="caption"><p>"cluster-test" application running on "node-2"</p></div></div><p>As you can see, the second node continued counting exactly from where we stopped in <code class="literal">node-1</code>. Great, our cluster is working!!</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec142"/>How it works...</h2></div></div></div><p>Let's analyze what we have done and why it is working without much configuration. Along with <code class="literal">standalone.sh</code> script for <code class="literal">node-1</code>, we specified a few parameters such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">jboss.server.base.dir=cl-std-node-1</code>: Needed to specify our base directory as a starting folder to retrieve all the configuration files.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--server-config=standalone-ha.xml</code>: Needed to specify the server configuration file with <code class="literal">ha</code> profile.</li><li class="listitem" style="list-style-type: disc"><code class="literal">jboss.socket.binding.port-offset=100</code>: Needed to specify the port offset (<code class="literal">200</code> for <code class="literal">node-2</code>). We could have skipped this for the first node, but I like seeing the series: <code class="literal">1</code>,<code class="literal">2</code>,<code class="literal">3</code>,<code class="literal">4</code>..<code class="literal">n</code>, which in this case would have been <code class="literal">8180</code>, <code class="literal">8280</code>, <code class="literal">8380,</code> and so on.</li><li class="listitem" style="list-style-type: disc"><code class="literal">jboss.node.name=node-1</code>: Needed to uniquely identify the node within the cluster (obviously, <code class="literal">node-2</code> for the second node).</li></ul></div><p>That's all we need to do <a id="id434" class="indexterm"/>to make our cluster. This is because <a id="id435" class="indexterm"/>of the default WildFly's configuration, especially the configuration of the subsystem, <code class="literal">jgroups</code>. Let's see its defaults:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;channels default="ee"&gt;
        &lt;channel name="ee"/&gt;
    &lt;/channels&gt;
    &lt;stacks default="udp"&gt;
        &lt;stack name="udp"&gt;
            &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
            &lt;protocol type="PING"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK" socket-binding="jgroups-udp-fd"/&gt;
            &lt;protocol type="FD_ALL"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="UFC"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG2"/&gt;
            &lt;protocol type="RSVP"/&gt;
        &lt;/stack&gt;
        &lt;stack name="tcp"&gt;
            &lt;transport type="TCP" socket-binding="jgroups-tcp"/&gt;
            &lt;protocol type="MPING" socket-binding="jgroups-mping"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK" socket-binding="jgroups-tcp-fd"/&gt;
            &lt;protocol type="FD"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG2"/&gt;
            &lt;protocol type="RSVP"/&gt;
        &lt;/stack&gt;
    &lt;/stacks&gt;
&lt;/subsystem&gt;</pre></div><p>So, the default protocol used for cluster transportation is the UDP (see the emphasized code). This UDP setting <a id="id436" class="indexterm"/>has additional configuration <a id="id437" class="indexterm"/>within the <code class="literal">socket-binding-group</code> specified in the <code class="literal">standalone-ha.xml</code> file, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="${jboss.socket.binding.port-offset:0}"&gt;
    &lt;socket-binding name="management-http" interface="management" port="${jboss.management.http.port:9990}"/&gt;
    &lt;socket-binding name="management-https" interface="management" port="${jboss.management.https.port:9993}"/&gt;
    &lt;socket-binding name="ajp" port="${jboss.ajp.port:8009}"/&gt;
    &lt;socket-binding name="http" port="${jboss.http.port:8080}"/&gt;
    &lt;socket-binding name="https" port="${jboss.https.port:8443}"/&gt;
    &lt;socket-binding name="jgroups-mping" port="0" multicast-address="${jboss.default.multicast.address:230.0.0.4}" multicast-port="45700"/&gt;
    &lt;socket-binding name="jgroups-tcp" port="7600"/&gt;
    &lt;socket-binding name="jgroups-tcp-fd" port="57600"/&gt;
    &lt;socket-binding name="jgroups-udp" port="55200" multicast-address="${jboss.default.multicast.address:230.0.0.4}" multicast-port="45688"/&gt;
    &lt;socket-binding name="jgroups-udp-fd" port="54200"/&gt;
    &lt;socket-binding name="modcluster" port="0" multicast-address="224.0.1.105" multicast-port="23364"/&gt;
    &lt;socket-binding name="txn-recovery-environment" port="4712"/&gt;
    &lt;socket-binding name="txn-status-manager" port="4713"/&gt;
    &lt;outbound-socket-binding name="mail-smtp"&gt;
        &lt;remote-destination host="localhost" port="25"/&gt;
    &lt;/outbound-socket-binding&gt;
&lt;/socket-binding-group&gt;</pre></div><p>So, by default, every member of the cluster advertises itself at the <code class="literal">230.0.0.4</code> address. Also, every port specified in the configuration is altered along with the <code class="literal">jboss.socket.binding.port-offset</code> parameter specified by the command-line script.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec143"/>There's more...</h2></div></div></div><p>We could have made our cluster without the <code class="literal">port-offset</code> directive, and by using different IPs for each node instead, but this wouldn't have worked properly. This is because of the HTTP session reference stored in a cookie. Generally speaking, a cookie consists of a name (typically <code class="literal">JSESSIONID</code>), a value (which is an ID used to reference the HTTP session on the server), a domain, and a context path.</p><p>All these properties <a id="id438" class="indexterm"/>must be the same in order to send requests to the same HTTP session on the server, which will not be the case with nodes bound to <a id="id439" class="indexterm"/>different IPs. The IP is the domain of the cookie, thus it will not work—unless you balance all the properties—but that's the subject of the next chapter.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec144"/>See also</h2></div></div></div><p>If you have any problem with this configuration, you might have network problems, which you can troubleshoot with the last recipe of this chapter.</p></div></div>
<div class="section" title="Creating separate clusters in standalone mode"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec58"/>Creating separate clusters in standalone mode</h1></div></div></div><p>In this <a id="id440" class="indexterm"/>recipe, you will learn how <a id="id441" class="indexterm"/>to configure different and isolated clusters, running locally. We will try this using the standalone mode and the <code class="literal">ha</code> profile.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec145"/>Getting ready</h2></div></div></div><p>For this recipe, we will need the <code class="literal">cluster-aware</code> application named <code class="literal">cluster-test</code>, that you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe of <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</p><p>To build the application, execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd ~/WFC/github/wildfly-cookbook
$ cd cluster-test
$ mvn -e clean package</pre></div><p>From the WildFly installation directory <code class="literal">$WILDFLY_HOME</code>, let's create four folders, each one representing a server node.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone cl-std-node-A1
$ cp -a standalone cl-std-node-A2
$ cp -a standalone cl-std-node-B1
$ cp -a standalone cl-std-node-B2</pre></div></li><li class="listitem">Now, let's copy the <code class="literal">cluster-test.war</code> application into the <code class="literal">deployments</code> folder of each node that we have just created. Give the following commands:<div class="informalexample"><pre class="programlisting">$ cp ~/WFC/github/wildfly-cookbook/cluster-test/target/cluster-test.war cl-std-node-A1/deployments/
$ cp ~/WFC/github/wildfly-cookbook/cluster-test/target/cluster-test.war cl-std-node-A2/deployments/
$ cp ~/WFC/github/wildfly-cookbook/cluster-test/target/cluster-test.war cl-std-node-B1/deployments/
$ cp ~/WFC/github/wildfly-cookbook/cluster-test/target/cluster-test.war cl-std-node-B2/deployments/</pre></div></li></ol></div><p>We are <a id="id442" class="indexterm"/>almost ready to test our cluster. We <a id="id443" class="indexterm"/>just need some configuration to pass to the <code class="literal">standalone.sh</code> script, through the command line.</p><div class="section" title="Node-A1"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec07"/>Node-A1</h3></div></div></div><p>In the following <a id="id444" class="indexterm"/>log output, you can see that a cluster was formed and a member named <code class="literal">node-A1</code> joined it:</p><div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-node-A1 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=100 -Djboss.node.name=node-A1
...
03:41:27,703 INFO  [stdout] (MSC service thread 1-13)
03:41:27,703 INFO  [stdout] (MSC service thread 1-13) -------------------------------------------------------------------
03:41:27,703 INFO  [stdout] (MSC service thread 1-13) GMS: address=node-A1, cluster=ee, physical address=127.0.0.1:55300
03:41:27,704 INFO  [stdout] (MSC service thread 1-13) -------------------------------------------------------------------
03:41:31,065 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000078: Starting JGroups channel web
03:41:31,073 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000094: Received new cluster view for channel web: [node-A1|0] (1) [node-A1]
03:41:31,075 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000079: Channel web local address is node-A1, physical addresses are [127.0.0.1:55300]
...</pre></div></div><div class="section" title="Node-A2"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec08"/>Node-A2</h3></div></div></div><p>In the following log <a id="id445" class="indexterm"/>output, you can see that a member named <code class="literal">node-A2</code> joined a cluster along with the other member named <code class="literal">node-A1</code>:</p><div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-node-A2 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=200 -Djboss.node.name=node-A2
...
03:43:27,309 INFO  [stdout] (MSC service thread 1-5)
03:43:27,309 INFO  [stdout] (MSC service thread 1-5) -------------------------------------------------------------------
03:43:27,310 INFO  [stdout] (MSC service thread 1-5) GMS: address=node-A2, cluster=ee, physical address=127.0.0.1:55400
03:43:27,310 INFO  [stdout] (MSC service thread 1-5) -------------------------------------------------------------------
03:43:27,672 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000078: Starting JGroups channel web
03:43:27,681 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000094: Received new cluster view for channel web: [node-A1|1] (2) [node-A1, node-A2]
03:43:27,683 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000079: Channel web local address is node-A2, physical addresses are [127.0.0.1:55400]
...</pre></div></div><div class="section" title="Node-B1"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec09"/>Node-B1</h3></div></div></div><p>In the following log <a id="id446" class="indexterm"/>output, you can see that a cluster was formed and a member named <code class="literal">node-B1</code> joined it. We do not see any <code class="literal">node-Ax</code> members, so we have formed a different cluster:</p><div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-node-B1 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=300 -Djboss.node.name=node-B1 -Djboss.default.multicast.address=230.0.0.5
...
03:44:59,778 INFO  [stdout] (MSC service thread 1-3)
03:44:59,778 INFO  [stdout] (MSC service thread 1-3) -------------------------------------------------------------------
03:44:59,779 INFO  [stdout] (MSC service thread 1-3) GMS: address=node-B1, cluster=ee, physical address=127.0.0.1:55500
03:44:59,779 INFO  [stdout] (MSC service thread 1-3) -------------------------------------------------------------------
03:45:03,810 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000078: Starting JGroups channel web
03:45:03,818 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000094: Received new cluster view for channel web: [node-B1|0] (1) [node-B1]
03:45:03,819 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000079: Channel web local address is node-B1, physical addresses are [127.0.0.1:55500]
...</pre></div></div><div class="section" title="Node-B2"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec10"/>Node-B2</h3></div></div></div><p>In the following log <a id="id447" class="indexterm"/>output, you can see that a member named <code class="literal">node-B2</code> joined a cluster along with the other member named <code class="literal">node-B1</code>:</p><div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-node-B2 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=400 -Djboss.node.name=node-B2 -Djboss.default.multicast.address=230.0.0.5
...
03:46:32,480 INFO  [stdout] (MSC service thread 1-14)
03:46:32,481 INFO  [stdout] (MSC service thread 1-14) -------------------------------------------------------------------
03:46:32,481 INFO  [stdout] (MSC service thread 1-14) GMS: address=node-B2, cluster=ee, physical address=127.0.0.1:55600
03:46:32,481 INFO  [stdout] (MSC service thread 1-14) -------------------------------------------------------------------
03:46:35,068 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000078: Starting JGroups channel web
03:46:35,081 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000094: Received new cluster view for channel web: [node-B1|1] (2) [node-B1, node-B2]
03:46:35,082 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 62) ISPN000079: Channel web local address is node-B2, physical addresses are [127.0.0.1:55600]
...</pre></div></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec146"/>How to do it…</h2></div></div></div><p>Now that we have <a id="id448" class="indexterm"/>launched all the WildFly nodes and formed two different clusters, let's test them with our great <code class="literal">cluster-test</code> application:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <a id="id449" class="indexterm"/>your browser and point it to the following location: <code class="literal">http://127.0.0.1:8180/cluster-test</code>.</li><li class="listitem">Refresh the page a few times. In the browser window, you should see something similar to the following screenshot:<div class="mediaobject"><img src="graphics/3744_06_01.jpg" alt="How to do it…"/><div class="caption"><p>"cluster-test" application running on "node-A1"</p></div></div><p>In the <code class="literal">node-A1</code> log, you should find the following statements:</p><div class="informalexample"><pre class="programlisting">17:07:15,429 INFO  [stdout] (default task-1) ********************************+
17:07:15,429 INFO  [stdout] (default task-1) Visitor(s): 0
17:07:15,430 INFO  [stdout] (default task-1) ********************************+
17:07:16,853 INFO  [stdout] (default task-2) ********************************+
17:07:16,854 INFO  [stdout] (default task-2) Visitor(s): 1
17:07:16,854 INFO  [stdout] (default task-2) ********************************+
17:07:17,271 INFO  [stdout] (default task-3) ********************************+
17:07:17,273 INFO  [stdout] (default task-3) Visitor(s): 2
17:07:17,273 INFO  [stdout] (default task-3) ********************************+
17:07:17,693 INFO  [stdout] (default task-4) ********************************+
17:07:17,694 INFO  [stdout] (default task-4) Visitor(s): 3
17:07:17,695 INFO  [stdout] (default task-4) ********************************+
17:07:18,208 INFO  [stdout] (default task-5) ********************************+
17:07:18,209 INFO  [stdout] (default task-5) Visitor(s): 4
17:07:18,209 INFO  [stdout] (default task-5) ********************************+</pre></div></li><li class="listitem">Now, let's <a id="id450" class="indexterm"/>try pointing <a id="id451" class="indexterm"/>the same browser window to the URL <code class="literal">http://127.0.0.1:8280/cluster-test</code>. You should see something like the following screenshot:<div class="mediaobject"><img src="graphics/3744_06_02.jpg" alt="How to do it…"/><div class="caption"><p>"cluster-test" application running on "node-A2"</p></div></div><p>As you can see, the second node continued counting exactly from where we stopped in <code class="literal">node-A1</code>. In the <code class="literal">node-A2</code> log, you should find the following statements:</p><div class="informalexample"><pre class="programlisting">17:10:29,776 INFO  [stdout] (default task-1) ********************************+
17:10:29,777 INFO  [stdout] (default task-1) Visitor(s): 5
17:10:29,777 INFO  [stdout] (default task-1) ********************************+</pre></div><p>OK, cluster <code class="literal">A</code> is working.</p></li></ol></div><p>Now let's try the <a id="id452" class="indexterm"/>other URLs <a id="id453" class="indexterm"/>for nodes <code class="literal">B</code>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Within the same browser window, point to the address <code class="literal">http://127.0.0.1:8380/cluster-test</code>. In the browser window, you should see something similar to the following image:<div class="mediaobject"><img src="graphics/3744_06_03.jpg" alt="How to do it…"/><div class="caption"><p> "cluster-test" application running on "node-B1"</p></div></div><p>As you can see, the application started counting from <code class="literal">0</code> (zero). The <code class="literal">node-B1</code> log should have the following statements:</p><div class="informalexample"><pre class="programlisting">17:12:59,978 INFO  [stdout] (default task-1) ********************************+
17:12:59,979 INFO  [stdout] (default task-1) Visitor(s): 0
17:12:59,980 INFO  [stdout] (default task-1) ********************************+</pre></div></li><li class="listitem">Now, let's try <a id="id454" class="indexterm"/>pointing <a id="id455" class="indexterm"/>the same browser window to the following URL: <code class="literal">http://127.0.0.1:8480/cluster-test</code>. You should see the following screenshot:<div class="mediaobject"><img src="graphics/3744_06_04.jpg" alt="How to do it…"/><div class="caption"><p>"cluster-test" application running on "node-B2"</p></div></div><p>In the <code class="literal">node-B2</code> log, you should find the following statements:</p><div class="informalexample"><pre class="programlisting">17:13:52,841 INFO  [stdout] (default task-1) ********************************+
17:13:52,841 INFO  [stdout] (default task-1) Visitor(s): 1
17:13:52,842 INFO  [stdout] (default task-1) ********************************+</pre></div><p>Great, cluster <code class="literal">B</code> is working too! Now, try switching from one URL to another and see if the cluster responds correctly.</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec147"/>How it works...</h2></div></div></div><p>Let's analyze what we have done and why it is working without much configuration. Along with the <a id="id456" class="indexterm"/><code class="literal">standalone.sh</code> <a id="id457" class="indexterm"/>script for <code class="literal">node-A1</code> and <code class="literal">node-A2</code>, we specified a few parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">jboss.server.base.dir=cl-std-node-A1</code>: Needed to specify our base directory as a starting folder to retrieve all the configuration files (<code class="literal">cl-std-node-A2</code> for <code class="literal">node-A2</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">--server-config=standalone-ha.xml</code>: Needed to specify the server configuration file with <code class="literal">ha</code> profile</li><li class="listitem" style="list-style-type: disc">jboss.socket.binding.port-offset=100: Needed to specify the port offset (200 for "node-2")</li><li class="listitem" style="list-style-type: disc"><code class="literal">jboss.node.name=node-A1</code>: Needed to uniquely identify the node within the cluster (obviously <code class="literal">node-A2</code> for the second <code class="literal">A</code> node)</li></ul></div><p>That's all we need to do to make the cluster for nodes <code class="literal">A</code>.</p><p>To create the nodes <code class="literal">B</code> cluster, we needed to specify pretty much the same parameters, plus the <code class="literal">jboss.default.multicast.address</code> one, valued to <code class="literal">230.0.0.5</code>. The default multicast address value is <code class="literal">230.0.0.4</code>, which is then used by the <code class="literal">A</code> nodes. This enabled us to create two different <a id="id458" class="indexterm"/>clusters: members of cluster <code class="literal">A</code> will communicate through the <code class="literal">230.0.0.4</code> address, while members of cluster <code class="literal">B</code> will communicate through the<span class="emphasis"><em> 230.0.0.5</em></span> address.</p></div></div>
<div class="section" title="Creating a cluster in domain mode"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec59"/>Creating a cluster in domain mode</h1></div></div></div><p>In this recipe, you <a id="id459" class="indexterm"/>will learn how to cluster two WildFly nodes locally, that is, on your PC. We will try this using the domain mode and the <code class="literal">ha</code> profile.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec148"/>Getting ready</h2></div></div></div><p>For this recipe, we <a id="id460" class="indexterm"/>will need the <code class="literal">cluster-aware</code> application named <code class="literal">cluster-test</code>, that you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</p><p>To build the application, run the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd ~/WFC/github/wildfly-cookbook
$ cd cluster-test
$ mvn -e clean package</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec149"/>How to do it...</h2></div></div></div><p>From the WildFly <a id="id461" class="indexterm"/>installation directory <code class="literal">$WILDFLY_HOME</code>, let's create two folders; one representing the <code class="literal">domain-controller</code> and the other one representing the hosts (we will have two instances running within the same host).</p><p>Open a terminal and <a id="id462" class="indexterm"/>execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a domain cl-dmn-master
$ cp -a domain cl-dmn-host-1</pre></div><div class="section" title="Master"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec11"/>Master</h3></div></div></div><p>Now, let's configure our <a id="id463" class="indexterm"/>domain controller using the <code class="literal">domain.xml</code> and <code class="literal">host.xml</code> files placed in the <code class="literal">cl-dmn-master</code> folder.</p><p>Edit the <code class="literal">domain.xml</code> file and replace the <code class="literal">&lt;server-groups&gt;...&lt;/server-groups&gt;</code> tag definition with the following:</p><div class="informalexample"><pre class="programlisting">&lt;server-groups&gt;
    &lt;server-group name="cluster-REST-app" profile="ha"&gt;
        &lt;jvm name="default"&gt;
            &lt;heap size="512m" max-size="512m"/&gt;
        &lt;/jvm&gt;
        &lt;socket-binding-group ref="ha-sockets"/&gt;
    &lt;/server-group&gt;
&lt;/server-groups&gt;</pre></div><p>Again, to use cluster, we need to use the <code class="literal">ha</code> profile, which I referenced within the <code class="literal">profile</code> attribute of <code class="literal">server-group</code>. Also, we need to reference the appropriate <code class="literal">socket-binding-group</code> by the <code class="literal">ref</code> attribute, in this case valued to <code class="literal">ha-sockets</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>Follow this rule: always name server groups properly; do not name them "server-A", "<span class="emphasis"><em>server-1</em></span>", or similar or you will get confused as soon as you start managing more and more servers.</p></div></div><p>Now let's edit the <code class="literal">host.xml</code> file in order to just have <code class="literal">domain-controller</code> without any running hosts.</p><p>Following are the steps that are to be taken:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Name the host as <code class="literal">master</code>:<div class="informalexample"><pre class="programlisting">&lt;host name="master" &gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;domain-controller&gt;...&lt;/domain-controller&gt;</code> tag definition with the following:<div class="informalexample"><pre class="programlisting">&lt;domain-controller&gt;
  &lt;local/&gt;
&lt;/domain-controller&gt;</pre></div></li><li class="listitem">Remove the <code class="literal">&lt;servers&gt;</code> tag definition.<p>OK, we are done with <code class="literal">domain-controller</code>. Let's have a run.</p></li><li class="listitem">Open a terminal <a id="id464" class="indexterm"/>and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-master</pre></div></li></ol></div><p>Now we can configure our hosts that will form a part of the cluster.</p></div><div class="section" title="Host-1"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec12"/>Host-1</h3></div></div></div><p>First of all, let's <a id="id465" class="indexterm"/>disable <code class="literal">domain.xml</code>, present in the <code class="literal">cl-dmn-host-1</code> folder.</p><p>Open a terminal and execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cd cl-dmn-host-1
$ mv configuration/domain.xml configuration/domain.xml.unused</pre></div><p>By doing so, the file will not be read at startup. Now, let's configure our host controller using the <code class="literal">host.xml</code>  file placed in the <code class="literal">cl-dmn-host-1</code> folder.</p><p>Edit the <code class="literal">host.xml</code> file and follow the steps listed next:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Name the host as <code class="literal">host-1</code>:<div class="informalexample"><pre class="programlisting">&lt;host name="host-1" &gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;management-interfaces&gt;...&lt;/management-interfaces&gt;</code> tag definition, inside the <code class="literal">&lt;management&gt;</code> tag, with the following:<div class="informalexample"><pre class="programlisting">&lt;management-interfaces&gt;
  &lt;native-interface security-realm="ManagementRealm"&gt;
    &lt;socket interface="management" port="${jboss.management.native.port:19999}"/&gt;
  &lt;/native-interface&gt;
  &lt;http-interface security-realm="ManagementRealm" http-upgrade-enabled="true"&gt;
    &lt;socket interface="management" port="${jboss.management.http.port:19990}"/&gt;
  &lt;/http-interface&gt;
&lt;/management-interfaces&gt;</pre></div></li><li class="listitem">Replace the <a id="id466" class="indexterm"/><code class="literal">&lt;domain-controller&gt;...&lt;/domain-controller&gt;</code> tag definition with the following:<div class="informalexample"><pre class="programlisting">&lt;domain-controller&gt;
  &lt;remote security-realm="ManagementRealm"&gt;
    &lt;discovery-options&gt;
      &lt;static-discovery name="primary" protocol="${jboss.domain.master.protocol:remote}" host="${jboss.domain.master.address}" port="${jboss.domain.master.port:9999}"/&gt;
    &lt;/discovery-options&gt;
  &lt;/remote&gt;
&lt;/domain-controller&gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;servers&gt;...&lt;/servers&gt;</code> tag definition with the following:<div class="informalexample"><pre class="programlisting">&lt;servers&gt;
  &lt;server name="REST-server-1" group="cluster-REST-app"&gt;
    &lt;jvm name="default"&gt;
       &lt;heap size="384m" max-size="384m"/&gt;
    &lt;/jvm&gt;
      &lt;socket-bindings port-offset="100"/&gt;
  &lt;/server&gt;
  &lt;server name="REST-server-2" group="cluster-REST-app"&gt;
    &lt;jvm name="default"&gt;
      &lt;heap size="384m" max-size="384m"/&gt;
    &lt;/jvm&gt;
      &lt;socket-bindings port-offset="200"/&gt;
  &lt;/server&gt;
&lt;/servers&gt;</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>In this case, naming the servers with an indexed prefix helps because it gives you more information. For example, if you have five servers, each one running two instances, and you catch an error statement within your log files about <code class="literal">REST-server-7</code>, then you know you have to look into the machine number <code class="literal">4</code>, right?</p></div></div><p>Open a terminal and execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-host-1 -Djboss.domain.master.address=127.0.0.1</pre></div><p>Now, if you looked at the <code class="literal">host-1</code> log output, you should have noticed that there is nothing about our cluster. Why? (You should know; anyway, the answer will be explained in a little while.)</p><p>Now that everything is <a id="id467" class="indexterm"/>up and running, let's deploy our application (did you get the answer?).</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/jboss-cli.sh
You are disconnected at the moment. Type 'connect' to connect to the server or 'help' for the list of supported commands.
[disconnected /] connect
[domain@localhost:9990 /] deploy cluster-test.war --server-groups=cluster-REST-app</pre></div></li><li class="listitem">Let's first check the logs. In <code class="literal">domain-controller</code>, you should see a statement asserting that the content has been uploaded, as follows:<div class="informalexample"><pre class="programlisting">[Host Controller] 20:52:54,502 INFO  [org.jboss.as.repository] (management-handler-thread - 7) WFLYDR0001: Content added at location /Users/foogaro/wildfly-9.0.0.Beta2/cl-dmn-master/data/content/ee/f4c936445881ec81ccb497cd2e7a500b95a92c/content</pre></div><p>In <span class="strong"><strong>host-1</strong></span> you should see the following statements:</p><div class="informalexample"><pre class="programlisting">[Server:REST-server-2] 21:09:41,157 INFO  [stdout] (MSC service thread 1-11)
[Server:REST-server-2] 21:09:41,157 INFO  [stdout] (MSC service thread 1-11) -------------------------------------------------------------------
[Server:REST-server-2] 21:09:41,157 INFO  [stdout] (MSC service thread 1-11) GMS: address=REST-server-2, cluster=ee, physical address=127.0.0.1:55400
[Server:REST-server-2] 21:09:41,157 INFO  [stdout] (MSC service thread 1-11) -------------------------------------------------------------------
[Server:REST-server-1] 21:09:41,167 INFO  [stdout] (MSC service thread 1-14)
[Server:REST-server-1] 21:09:41,167 INFO  [stdout] (MSC service thread 1-14) -------------------------------------------------------------------
[Server:REST-server-1] 21:09:41,168 INFO  [stdout] (MSC service thread 1-14) GMS: address=REST-server-1, cluster=ee, physical address=127.0.0.1:55300
[Server:REST-server-1] 21:09:41,168 INFO  [stdout] (MSC service thread 1-14) -------------------------------------------------------------------
[Server:REST-server-2] 21:09:44,576 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 21) ISPN000078: Starting JGroups channel web
[Server:REST-server-1] 21:09:44,576 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 21) ISPN000078: Starting JGroups channel web
[Server:REST-server-1] 21:09:44,580 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 21) ISPN000094: Received new cluster view for channel web: [REST-server-1|0] (1) [REST-server-1]
[Server:REST-server-1] 21:09:44,581 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 21) ISPN000079: Channel web local address is REST-server-1, physical addresses are [127.0.0.1:55300]
[Server:REST-server-2] 21:09:44,581 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 21) ISPN000094: Received new cluster view for channel web: [REST-server-2|0] (1) [REST-server-2]
[Server:REST-server-2] 21:09:44,582 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (ServerService Thread Pool -- 21) ISPN000079: Channel web local address is REST-server-2, physical addresses are [127.0.0.1:55400]
[Server:REST-server-1] 21:09:44,588 INFO  [org.infinispan.factories.GlobalComponentRegistry] (ServerService Thread Pool -- 21) ISPN000128: Infinispan version: Infinispan 'Hoptimus Prime' 7.1.1.Final
[Server:REST-server-2] 21:09:44,589 INFO  [org.infinispan.factories.GlobalComponentRegistry] (ServerService Thread Pool -- 21) ISPN000128: Infinispan version: Infinispan 'Hoptimus Prime' 7.1.1.Final
[Server:REST-server-1] 21:09:44,793 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 31) WFLYCLINF0002: Started cluster-test.war cache from web container
[Server:REST-server-1] 21:09:44,793 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 21) WFLYCLINF0002: Started dist cache from web container
[Server:REST-server-2] 21:09:44,798 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 29) WFLYCLINF0002: Started cluster-test.war cache from web container
[Server:REST-server-2] 21:09:44,798 INFO  [org.jboss.as.clustering.infinispan] (ServerService Thread Pool -- 21) WFLYCLINF0002: Started dist cache from web container
[Server:REST-server-1] 21:09:45,050 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-7) WFLYUT0021: Registered web context: /cluster-test
[Server:REST-server-2] 21:09:45,052 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-12) WFLYUT0021: Registered web context: /cluster-test
[Server:REST-server-1] 21:09:45,119 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 60) WFLYSRV0010: Deployed "cluster-test.war" (runtime-name : "cluster-test.war")
[Server:REST-server-2] 21:09:45,119 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 24) WFLYSRV0010: Deployed "cluster-test.war" (runtime-name : "cluster-test.war")</pre></div><p>See, now that we've got a statements log about the cluster, we know the the answer: the cluster will be activated once an application requires it.</p><p>Time to test our cluster using our application!</p></li><li class="listitem">Open you browser <a id="id468" class="indexterm"/>and point it to the following location: <code class="literal">http://127.0.0.1:8180/cluster-test</code>. Refresh the page a few times. In the browser window, you should see something similar to the following screenshot:<div class="mediaobject"><img src="graphics/3744_06_13.jpg" alt="Host-1"/><div class="caption"><p>"cluster-test" application running on "host-1" with "REST-server-1"</p></div></div><p>In the <code class="literal">host-1</code> log, you <a id="id469" class="indexterm"/>should find the following statements:</p><div class="informalexample"><pre class="programlisting">[Server:REST-server-1] 16:05:47,393 INFO  [stdout] (default task-1) ********************************+
[Server:REST-server-1] 16:05:47,394 INFO  [stdout] (default task-1) Visitor(s): 0
[Server:REST-server-1] 16:05:47,394 INFO  [stdout] (default task-1) ********************************+
[Server:REST-server-1] 16:05:50,266 INFO  [stdout] (default task-3) ********************************+
[Server:REST-server-1] 16:05:50,267 INFO  [stdout] (default task-3) Visitor(s): 1
[Server:REST-server-1] 16:05:50,267 INFO  [stdout] (default task-3) ********************************+
[Server:REST-server-1] 16:05:50,529 INFO  [stdout] (default task-4) ********************************+
[Server:REST-server-1] 16:05:50,530 INFO  [stdout] (default task-4) Visitor(s): 2
[Server:REST-server-1] 16:05:50,531 INFO  [stdout] (default task-4) ********************************+
[Server:REST-server-1] 16:05:50,800 INFO  [stdout] (default task-5) ********************************+
[Server:REST-server-1] 16:05:50,800 INFO  [stdout] (default task-5) Visitor(s): 3
[Server:REST-server-1] 16:05:50,801 INFO  [stdout] (default task-5) ********************************+
[Server:REST-server-1] 16:05:51,405 INFO  [stdout] (default task-6) ********************************+
[Server:REST-server-1] 16:05:51,406 INFO  [stdout] (default task-6) Visitor(s): 4
[Server:REST-server-1] 16:05:51,407 INFO  [stdout] (default task-6) ********************************+</pre></div><p>Notice the suffix of the log statements indicating the server name.</p></li><li class="listitem">Now, let's try pointing <a id="id470" class="indexterm"/>the same browser window to the URL <code class="literal">http://127.0.0.1:8280/cluster-test</code>. You should see something like the following screenshot:<div class="mediaobject"><img src="graphics/3744_06_14.jpg" alt="Host-1"/><div class="caption"><p>"cluster-test" application running on "host-1" with "REST-server-2"</p></div></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>As you can see, the second node continued counting exactly from where we stopped in <code class="literal">REST-server-1</code>. In the <code class="literal">host-1</code> log, you should find the following statements:</p><div class="informalexample"><pre class="programlisting">[Server:REST-server-2] 16:11:27,734 INFO  [stdout] (default task-1) ********************************+
[Server:REST-server-2] 16:11:27,734 INFO  [stdout] (default task-1) Visitor(s): 5
[Server:REST-server-2] 16:11:27,734 INFO  [stdout] (default task-1) ********************************+</pre></div><p>The suffix of the log changed to <code class="literal">REST-server-2</code>. OK, our cluster is working properly.</p></div></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec150"/>How it works...</h2></div></div></div><p>Skipping the details of domain mode configuration (see <a class="link" href="ch03.html" title="Chapter 3. Running WildFly in Domain Mode">Chapter 3</a>, <span class="emphasis"><em>Running WildFly in Domain Mode</em></span>), let's analyze what we have done and why it is working without much configuration. Along with the <code class="literal">domain.sh</code> script for the <code class="literal">master</code> node, we specified the <code class="literal">-Djboss.domain.base.dir=cl-dmn-master</code> parameter, indicating our base directory as a starting folder to retrieve the entire configuration file.</p><p>Furthermore, within <code class="literal">domain.xml</code> we specified a reference to the <code class="literal">ha</code> profile and <code class="literal">ha-sockets</code>, in the definition of <code class="literal">server-groups</code>. These configurations enabled clustering capabilities. Remember, only the <code class="literal">ha</code> and <code class="literal">full-ha</code> profiles enable  the clustering feature.</p><p>Looking at the <code class="literal">host-1</code> side, along with <code class="literal">domain.sh</code> script, we specified the <code class="literal">-Djboss.domain.base.dir=cl-dmn-host-1</code> and <code class="literal">-Djboss.domain.master.address=127.0.0.1</code> properties, setting our base directory as a starting folder to retrieve <a id="id471" class="indexterm"/>the entire configuration file, and the address of <code class="literal">domain-controller</code>, relatively.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>Remember, the domain-controller pushes out the configuration to the hosts, through the host-controller. That's why we don't have a configuration counterpart in <code class="literal">host-1</code>.</p></div></div><p>That's all we needed to do to make our cluster. This is because of the default WildFly configuration, especially the configuration of the subsystem, <code class="literal">jgroups</code>. Let's see its defaults:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;channels default="ee"&gt;
        &lt;channel name="ee"/&gt;
    &lt;/channels&gt;
    &lt;stacks default="udp"&gt;
        &lt;stack name="udp"&gt;
            &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
            &lt;protocol type="PING"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK" socket-binding="jgroups-udp-fd"/&gt;
            &lt;protocol type="FD_ALL"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="UFC"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG2"/&gt;
            &lt;protocol type="RSVP"/&gt;
        &lt;/stack&gt;
        &lt;stack name="tcp"&gt;
            &lt;transport type="TCP" socket-binding="jgroups-tcp"/&gt;
            &lt;protocol type="MPING" socket-binding="jgroups-mping"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK" socket-binding="jgroups-tcp-fd"/&gt;
            &lt;protocol type="FD"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG2"/&gt;
            &lt;protocol type="RSVP"/&gt;
        &lt;/stack&gt;
    &lt;/stacks&gt;
&lt;/subsystem&gt;</pre></div><p>So, the default protocol used for cluster transportation is the UDP (see the emphasized code). This UDP setting has <a id="id472" class="indexterm"/>additional configuration, within <code class="literal">socket-binding-group</code> named <code class="literal">ha-sockets</code>, specified in the <code class="literal">domain.xml</code> file as follows:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding-group name="ha-sockets" default-interface="public"&gt;
    &lt;socket-binding name="ajp" port="${jboss.ajp.port:8009}"/&gt;
    &lt;socket-binding name="http" port="${jboss.http.port:8080}"/&gt;
    &lt;socket-binding name="https" port="${jboss.https.port:8443}"/&gt;
    &lt;socket-binding name="jgroups-mping" port="0" multicast-address="${jboss.default.multicast.address:230.0.0.4}" multicast-port="45700"/&gt;
    &lt;socket-binding name="jgroups-tcp" port="7600"/&gt;
    &lt;socket-binding name="jgroups-tcp-fd" port="57600"/&gt;
    &lt;socket-binding name="jgroups-udp" port="55200" multicast-address="${jboss.default.multicast.address:230.0.0.4}" multicast-port="45688"/&gt;
    &lt;socket-binding name="jgroups-udp-fd" port="54200"/&gt;
    &lt;socket-binding name="modcluster" port="0" multicast-
    address="224.0.1.105" multicast-port="23364"/&gt;
    &lt;socket-binding name="txn-recovery-environment" port="4712"/&gt;
    &lt;socket-binding name="txn-status-manager" port="4713"/&gt;
    &lt;outbound-socket-binding name="mail-smtp"&gt;
        &lt;remote-destination host="localhost" port="25"/&gt;
    &lt;/outbound-socket-binding&gt;
&lt;/socket-binding-group&gt;</pre></div><p>So, by default, every member of the cluster advertises itself at the <code class="literal">230.0.0.4</code> address. Also, every port specified in the configuration is altered along with the <code class="literal">&lt;socket-bindings port-offset="XXX"/&gt;</code> settings specified in the <code class="literal">host.xml</code> file in the <code class="literal">host-1</code> server.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec151"/>There's more…</h2></div></div></div><p>We could have made our cluster without the <code class="literal">port-offset</code> directive, and by using different IPs for each node instead, but this wouldn't have worked properly. This is because of the HTTP-session reference stored in a cookie. Generally speaking, a cookie consists of a name (typically <code class="literal">JSESSIONID</code>), a value (which is an ID used to reference the HTTP session on the server), a domain, and a context path.</p><p>All these properties must be <a id="id473" class="indexterm"/>the same in order to make a request to the same HTTP session on the server, which will not be the case with nodes bound to different IPs. The IP is the domain of the cookie, thus it will not work—unless you balance— but that's covered in the next chapter.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec152"/>See also</h2></div></div></div><p>If you have any problem with this configuration, you might have network problems, which you can troubleshoot with the <span class="emphasis"><em>Testing the UDP protocol with the JGroups tool</em></span> recipe of this chapter.</p></div></div>
<div class="section" title="Creating separate clusters in domain mode"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec60"/>Creating separate clusters in domain mode</h1></div></div></div><p>In the previous <a id="id474" class="indexterm"/>recipe, we learned <a id="id475" class="indexterm"/>how to create a cluster. What if we need to manage more applications, each one having its own cluster? This is exactly what you will learn in this recipe. We will learn to manage more applications using the <code class="literal">ha</code> profile.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec153"/>Getting ready</h2></div></div></div><p>For this recipe, we will need the <code class="literal">cluster-aware</code> application named <code class="literal">example</code>, that you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</p><p>To build the application, execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd ~/WFC/github/wildfly-cookbook
$ cd example
$ mvn -e clean package</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec154"/>How to do it…</h2></div></div></div><p>From the WildFly installation directory <code class="literal">$WILDFLY_HOME</code>, let's create three folders, one for the domain-controller (always run the domain-controller per se, without any other hosts), and two folders representing two different hosts with their own <code class="literal">host-controller</code>.</p><p>Open a terminal and execute the following commands (if you followed the steps in the previous recipe, you can skip the first two <code class="literal">cp</code> commands):</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a domain cl-dmn-master
$ cp -a domain cl-dmn-host-1
$ cp -a domain cl-dmn-host-2</pre></div><div class="section" title="Master"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec13"/>Master</h3></div></div></div><p>Now, let's configure <a id="id476" class="indexterm"/>our domain controller using the <code class="literal">domain.xml</code> and <code class="literal">host.xml</code> files placed in the <code class="literal">cl-dmn-master</code> folder. This will be exactly the same as the previous recipe, just in case.</p><p>Edit the <code class="literal">domain.xml</code> file and replace the <code class="literal">&lt;server-groups&gt;...&lt;/server-groups&gt;</code> tag definition with the following:</p><div class="informalexample"><pre class="programlisting">&lt;server-groups&gt;
    &lt;server-group name="cluster-REST-app" profile="ha"&gt;
        &lt;jvm name="default"&gt;
            &lt;heap size="512m" max-size="512m"/&gt;
        &lt;/jvm&gt;
        &lt;socket-binding-group ref="ha-sockets"/&gt;
    &lt;/server-group&gt;
    &lt;server-group name="cluster-SOAP-app" profile="ha"&gt;
        &lt;jvm name="default"&gt;
            &lt;heap size="512m" max-size="512m"/&gt;
        &lt;/jvm&gt;
        &lt;socket-binding-group ref="ha-sockets"/&gt;
    &lt;/server-group&gt;
&lt;/server-groups&gt;</pre></div><p>Again, to use cluster, we need to use the <code class="literal">ha</code> profile, which I referenced within the <code class="literal">profile</code> attribute of the <code class="literal">server-group</code> element. Also, we need to reference the appropriate <code class="literal">socket-binding-group</code> by the <code class="literal">ref</code> attribute, in this case valued to <code class="literal">ha-sockets</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>Follow this rule: always name server-groups properly, do not name them as "server-A", "<code class="literal">server-1</code>", or similar.</p></div></div><p>Now let's edit the <a id="id477" class="indexterm"/><code class="literal">host.xml</code> file in order to just <a id="id478" class="indexterm"/>have <code class="literal">domain-controller</code> without any running hosts.</p><p>Here are the steps that are to be followed:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Name the host as <code class="literal">master</code>:<div class="informalexample"><pre class="programlisting">&lt;host name="master" &gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;domain-controller&gt;...&lt;/domain-controller&gt;</code> tag definition with the following:<div class="informalexample"><pre class="programlisting">&lt;domain-controller&gt;
  &lt;local/&gt;
&lt;/domain-controller&gt;</pre></div></li><li class="listitem">Remove the <code class="literal">&lt;servers&gt;</code> tag definition.<p>Okay, we are done with the domain-controller. Let's have a run.</p></li><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-master</pre></div></li></ol></div><p>Now we can configure our hosts that will be a part of the cluster.</p></div><div class="section" title="Host-1"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec14"/>Host-1</h3></div></div></div><p>First of all, let's disable the <code class="literal">domain.xml</code> file present in the <code class="literal">cl-dmn-host-1</code> folder.</p><p>Open a terminal and <a id="id479" class="indexterm"/>execute the following <a id="id480" class="indexterm"/>commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cd cl-dmn-host-1
$ mv configuration/domain.xml configuration/domain.xml.unused</pre></div><p>By doing so, the file will not be read at startup. Now, let's configure our host controller using <code class="literal">host.xml</code> placed in the <code class="literal">cl-dmn-host-1</code> folder.</p><p>Edit the <code class="literal">host.xml</code> file and follow the steps listed next:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Name the host as <code class="literal">host-1</code>:<div class="informalexample"><pre class="programlisting">&lt;host name="host-1" &gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;management-interfaces&gt;...&lt;/management-interfaces&gt;</code> tag definition inside the <code class="literal">&lt;management&gt;</code> tag, with the following:<div class="informalexample"><pre class="programlisting">&lt;management-interfaces&gt;
  &lt;native-interface security-realm="ManagementRealm"&gt;
    &lt;socket interface="management" port="${jboss.management.native.port:19999}"/&gt;
    &lt;/native-interface&gt;
    &lt;http-interface security-realm="ManagementRealm" http-upgrade-enabled="true"&gt;
        &lt;socket interface="management" port="${jboss.management.http.port:19990}"/&gt;
    &lt;/http-interface&gt;
&lt;/management-interfaces&gt;</pre></div><p>This is only needed when more management interfaces are running on the same server.</p></li><li class="listitem">Replace the <code class="literal">&lt;domain-controller&gt;...&lt;/domain-controller&gt;</code> tag definition with the following:<div class="informalexample"><pre class="programlisting">&lt;domain-controller&gt;
  &lt;remote security-realm="ManagementRealm"&gt;
    &lt;discovery-options&gt;
      &lt;static-discovery name="primary" protocol="${jboss.domain.master.protocol:remote}" host="${jboss.domain.master.address}" port="${jboss.domain.master.port:9999}"/&gt;
    &lt;/discovery-options&gt;
  &lt;/remote&gt;
&lt;/domain-controller&gt;</pre></div><p>As you can see, there is no default for the <code class="literal">jboss.domain.master.address</code> property, so we need to pass it somehow.</p></li><li class="listitem">Replace the <code class="literal">&lt;servers&gt;...&lt;/servers&gt;</code> tag definition with the following:<div class="informalexample"><pre class="programlisting">&lt;servers&gt;
  &lt;server name="REST-server-1" group="cluster-REST-app"&gt;
    &lt;socket-bindings port-offset="100"/&gt;
  &lt;/server&gt;
  &lt;server name="SOAP-server-1" group="cluster-SOAP-app"&gt;
    &lt;socket-bindings port-offset="200"/&gt;
  &lt;/server&gt;
&lt;/servers&gt;</pre></div></li><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-host-1 -Djboss.domain.master.address=127.0.0.1</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>Remember that a <a id="id481" class="indexterm"/>cluster is activated <a id="id482" class="indexterm"/>on demand, that is, after we installed a <code class="literal">cluster-aware</code> application.</p></div></div></div><div class="section" title="Host-2"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec15"/>Host-2</h3></div></div></div><p>Let's do exactly the <a id="id483" class="indexterm"/>same thing for <code class="literal">host-2</code> with just a few adjustments.</p><p>Open a terminal and execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cd cl-dmn-host-2
$ mv configuration/domain.xml configuration/domain.xml.unused</pre></div><p>Edit the <code class="literal">host.xml </code>file and follow the steps listed below:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Name the host as <code class="literal">host-2</code>:<div class="informalexample"><pre class="programlisting">&lt;host name="host-2" &gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;management-interfaces&gt;...&lt;/management-interfaces&gt;</code> tag definition inside the <code class="literal">&lt;management&gt;</code> tag, with the following:<div class="informalexample"><pre class="programlisting">&lt;management-interfaces&gt;
    &lt;native-interface security-realm="ManagementRealm"&gt;
        &lt;socket interface="management" port="${jboss.management.native.port:29999}"/&gt;
    &lt;/native-interface&gt;
    &lt;http-interface security-realm="ManagementRealm" http-upgrade-enabled="true"&gt;
        &lt;socket interface="management" port="${jboss.management.http.port:29990}"/&gt;
    &lt;/http-interface&gt;
&lt;/management-interfaces&gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;domain-controller&gt;...&lt;/domain-controller&gt;</code> tag definition <a id="id484" class="indexterm"/>with the following:<div class="informalexample"><pre class="programlisting">&lt;domain-controller&gt;
    &lt;remote security-realm="ManagementRealm"&gt;
        &lt;discovery-options&gt;
            &lt;static-discovery name="primary" protocol="${jboss.domain.master.protocol:remote}" host="${jboss.domain.master.address}" port="${jboss.domain.master.port:9999}"/&gt;
        &lt;/discovery-options&gt;
    &lt;/remote&gt;
&lt;/domain-controller&gt;</pre></div></li><li class="listitem">Replace the <code class="literal">&lt;servers&gt;...&lt;/servers&gt;</code> tag definition with the following:<div class="informalexample"><pre class="programlisting">&lt;servers&gt;
    &lt;server name="REST-server-2" group="cluster-REST-app"&gt;
        &lt;socket-bindings port-offset="300"/&gt;
    &lt;/server&gt;
    &lt;server name="SOAP-server-2" group="cluster-SOAP-app"&gt;
        &lt;socket-bindings port-offset="400"/&gt;
    &lt;/server&gt;
&lt;/servers&gt;</pre></div></li><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-host-2 -Djboss.domain.master.address=127.0.0.1</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>Remember that cluster is activated on demand, that is, after we installed a <code class="literal">cluster-aware</code> application.</p></div></div></li><li class="listitem">Let's deploy the application as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/jboss-cli.sh
You are disconnected at the moment. Type 'connect' to connect to the server or 'help' for the list of supported commands.
[disconnected /] connect
[domain@localhost:9990 /] deploy cluster-test.war --all-server-groups</pre></div></li></ol></div></div><div class="section" title="Testing the clusters"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec16"/>Testing the clusters</h3></div></div></div><p>Now that all the hosts <a id="id485" class="indexterm"/>are up and running, let's test our two clusters!</p><p>Open a browser and point <a id="id486" class="indexterm"/>to the following URLs, using different windows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8180/cluster-test</code> will depict the following output:<div class="mediaobject"><img src="graphics/3744_06_05.jpg" alt="Testing the clusters"/></div></li><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8280/cluster-test</code> will depict the following output:<div class="mediaobject"><img src="graphics/3744_06_06.jpg" alt="Testing the clusters"/></div></li><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8380/cluster-test</code> will depict the following <a id="id487" class="indexterm"/>output:<div class="mediaobject"><img src="graphics/3744_06_07.jpg" alt="Testing the clusters"/></div></li><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8480/cluster-test</code> will depict the following <a id="id488" class="indexterm"/>output:<div class="mediaobject"><img src="graphics/3744_06_08.jpg" alt="Testing the clusters"/></div></li></ul></div><p>Oops! We were not expecting this, were we? What did we miss?</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Okay, we got the same application, but still, the cluster should have worked. I mean two separate clusters. We got different ports for all the hosts. So what's wrong?</li><li class="listitem" style="list-style-type: disc">A server group does not define a cluster. A cluster is defined at the network level. To have a second cluster, thus a separate cluster, we need to specify a different multicast address for the servers we want to form a second cluster with. Both server-groups are sharing the same socket-binding-group <code class="literal">ha-sockets</code>, so all the information, cache, and cluster pings go onto the same network.</li></ul></div><p>How do we do that? Passing the multicast address as a parameter along with the <code class="literal">domain.sh</code> script for the <code class="literal">host-2</code>? Nope! That way, we set a different multicast address for the <code class="literal">REST-server-2</code> server, which should be present in the first cluster, <code class="literal">cluster-REST-app</code>.</p><p>We need to define a multicast address for the first cluster and another one for the second cluster. Our clusters are logically represented by the <code class="literal">cluster-REST-app</code> server group and the <code class="literal">cluster-SOAP-app</code> server group, we can just define those multicast addresses at the server group <a id="id489" class="indexterm"/>level, hence in <code class="literal">domain.xml</code>.</p><p>Now, stop <a id="id490" class="indexterm"/>everything!</p><div class="section" title="Master"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec01"/>Master</h4></div></div></div><p>Edit the <code class="literal">domain.xml</code> <a id="id491" class="indexterm"/>file and replace the <code class="literal">&lt;server-groups&gt;...&lt;/server-groups&gt;</code> tag definition with the following:</p><div class="informalexample"><pre class="programlisting">&lt;server-groups&gt;
    &lt;server-group name="cluster-REST-app" profile="ha"&gt;
        &lt;jvm name="default"&gt;
            &lt;heap size="512m" max-size="512m"/&gt;
        &lt;/jvm&gt;
        &lt;socket-binding-group ref="ha-sockets"/&gt;
        &lt;system-properties&gt;
         &lt;property name="jboss.default.multicast.address" value="${rest.multicast.address}" /&gt;
        &lt;/system-properties&gt;
        &lt;deployments&gt;
            &lt;deployment name="cluster-test.war" runtime-name="cluster-test.war"/&gt;
        &lt;/deployments&gt;
    &lt;/server-group&gt;
    &lt;server-group name="cluster-SOAP-app" profile="ha"&gt;
        &lt;jvm name="default"&gt;
            &lt;heap size="512m" max-size="512m"/&gt;
        &lt;/jvm&gt;
        &lt;socket-binding-group ref="ha-sockets"/&gt;
        &lt;system-properties&gt;
         &lt;property name="jboss.default.multicast.address" value="${soap.multicast.address}" /&gt;
        &lt;/system-properties&gt;
        &lt;deployments&gt;
            &lt;deployment name="cluster-test.war" runtime-name="cluster-test.war"/&gt;
        &lt;/deployments&gt;
    &lt;/server-group&gt;
&lt;/server-groups&gt;</pre></div><p>Open a terminal and <a id="id492" class="indexterm"/>execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-master</pre></div></div><div class="section" title="Host-1"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec02"/>Host-1</h4></div></div></div><p>Open a terminal <a id="id493" class="indexterm"/>and execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-host-1 -Djboss.domain.master.address=127.0.0.1 -<span class="strong"><strong>Drest.multicast.address=230.0.0.4 -Dsoap.multicast.address=230.0.0.5</strong></span>
</pre></div></div><div class="section" title="Host-2"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec03"/>Host-2</h4></div></div></div><p>Open a terminal and <a id="id494" class="indexterm"/>execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/domain.sh -Djboss.domain.base.dir=cl-dmn-host-2 -Djboss.domain.master.address=127.0.0.1 -<span class="strong"><strong>Drest.multicast.address=230.0.0.4 -Dsoap.multicast.address=230.0.0.5</strong></span>
</pre></div></div></div><div class="section" title="Re-testing the clusters"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec17"/>Re-testing the clusters</h3></div></div></div><p>Let's open two <a id="id495" class="indexterm"/>windows of the same browser and point them to the following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8180/cluster-test</code> will depict the following output:<div class="mediaobject"><img src="graphics/3744_06_05.jpg" alt="Re-testing the clusters"/></div></li><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8380/cluster-test</code> will depict the following output:<div class="mediaobject"><img src="graphics/3744_06_10.jpg" alt="Re-testing the clusters"/></div></li></ul></div><p>Now open two other <a id="id496" class="indexterm"/>windows of a different browser and point them to the following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8280/cluster-test</code> will depict the following output:<div class="mediaobject"><img src="graphics/3744_06_11.jpg" alt="Re-testing the clusters"/></div></li><li class="listitem" style="list-style-type: disc">The URL <code class="literal">http://127.0.0.1:8480/cluster-test</code> will depict the following output:<div class="mediaobject"><img src="graphics/3744_06_12.jpg" alt="Re-testing the clusters"/></div></li></ul></div><p>There we go!</p></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec155"/>How it works…</h2></div></div></div><p>We explained what was wrong in the first test, along the way. The second test, though, is a bit different; it seems that having different browsers does the magic. Well, kind of.</p><p>First of all, we effectively split the cluster in two, each one with its own network, which is right by design and implementation.</p><p>The different browser is <a id="id497" class="indexterm"/>needed for just one reason— because we are testing on the same IP (but different ports), and because the hostname (that is, the IP) matches the domain of the session cookie on the browser, having all four windows sharing the same cookie would end up in a totally wrong behavior—from our point of view.</p><p>Let's describe the "same-four-windows-browser" scenario and see if it fits our thinking:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Client makes a request on server 8180</strong></span>: This responds with a <code class="literal">set-cookie</code> header with <a id="id498" class="indexterm"/>name <code class="literal">JSESSIONID</code>, domain <code class="literal">127.0.0.1</code>, path <code class="literal">/cluster-test</code> and a value <code class="literal">0o0hPhIZ73unAtIMDCb0zR2h.host-1:REST-server-1</code>. Visitor number <code class="literal">0</code>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Client makes a request on server 8380</strong></span>: This responds without a <code class="literal">set-cookie</code> header, because the browser finds the cookie on itself and sends it to the server, along with the request. As the server <code class="literal">8180</code> and <code class="literal">8380</code> are in the same cluster, and the HTTP session is replicated across them, the server finds the session and increments our visitors number. Visitor number <code class="literal">1</code>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Client makes a request on the server 8280</strong></span>: This we configured to be on a separate cluster. The browser sends the cookie along with the request itself. The server can't find the session, thus it responds with a <code class="literal">set-cookie</code> header with newly created values: name <code class="literal">JSESSIONID</code>, domain <code class="literal">127.0.0.1</code>, path <code class="literal">/cluster-test</code> and a value <code class="literal">8X1gLkCbr5RsmELxwTlI0izj.host-1:SOAP-server-1</code>. Visitor number <code class="literal">0</code>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Client makes a request on the server 8480</strong></span>: The browser sends the cookie along with the request itself. The server can't find the session, thus it responds with a <code class="literal">set-cookie</code> header with newly created values.</li></ul></div><p>As you can see, using the <a id="id499" class="indexterm"/>same browser— at least the same session's browser— could <a id="id500" class="indexterm"/>not work.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec156"/>See also</h2></div></div></div><p>If you have any problem with this configuration, you might have network problems, which you can troubleshoot with the last recipe of this chapter.</p></div></div>
<div class="section" title="Creating a cluster via TCP"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec61"/>Creating a cluster via TCP</h1></div></div></div><p>Often <a id="id501" class="indexterm"/>times, especially in enterprise and cloud environments where there are several restrictions among networks, you are not able to use multicast <a id="id502" class="indexterm"/>addresses, even in the same network. Fortunately, the <code class="literal">jgroups</code> subsystem helps you out with this by providing an easy way to switch between UDP and TCP clustering, and this is exactly what you will learn in this recipe. We will work using the standalone mode with the <code class="literal">ha</code> profile.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec157"/>Getting ready</h2></div></div></div><p>For this recipe, we will need the "cluster-aware" application named "example", that you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</p><p>To build the application, do as follows:</p><div class="informalexample"><pre class="programlisting">$ cd ~/WFC/github/wildfly-cookbook
$ cd example
$ mvn -e clean package</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec158"/>How to do it...</h2></div></div></div><p>From the WildFly installation directory <code class="literal">$WILDFLY_HOME</code>, let's create two folders, each one representing a server node.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone cl-std-tcp-node-1
$ cp -a standalone cl-std-tcp-node-2</pre></div></li><li class="listitem">Now, let's copy the <code class="literal">cluster-test.war</code> application into the <code class="literal">deployments</code> folder of each node that we have just created. Run the following commands:<div class="informalexample"><pre class="programlisting">$ cp cluster-test.war cl-std-tcp-node-1/deployments/
$ cp cluster-test.war cl-std-tcp-node-2/deployments/</pre></div></li></ol></div><p>We are almost ready <a id="id503" class="indexterm"/>to test our cluster. We just need some <a id="id504" class="indexterm"/>configuration.</p><div class="section" title="Node-1"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec18"/>Node-1</h3></div></div></div><p>Edit the <a id="id505" class="indexterm"/><code class="literal">standalone-ha.xml</code>  file and replace the <code class="literal">jgroups</code> subsystem with the following definition:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;channels default="ee"&gt;
        &lt;channel name="ee"/&gt;
    &lt;/channels&gt;
    &lt;stacks default="tcp"&gt;
        &lt;stack name="udp"&gt;
            &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
            &lt;protocol type="PING"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK" socket-binding="jgroups-udp-fd"/&gt;
            &lt;protocol type="FD_ALL"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="UFC"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG2"/&gt;
            &lt;protocol type="RSVP"/&gt;
        &lt;/stack&gt;
        &lt;stack name="tcp"&gt;
            &lt;transport type="TCP" socket-binding="jgroups-tcp"/&gt;
              &lt;protocol type="TCPPING"&gt;
                &lt;property name="initial_hosts"&gt;
                  127.0.0.1[7700],127.0.0.1[7800]
                &lt;/property&gt;
                &lt;property name="num_initial_members"&gt;
                  2
                &lt;/property&gt;
                &lt;property name="port_range"&gt;
                  0
                &lt;/property&gt;
                &lt;property name="timeout"&gt;
                  2000
                &lt;/property&gt;
              &lt;/protocol&gt;
            &lt;protocol type="MPING" socket-binding="jgroups-mping"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK" socket-binding="jgroups-tcp-fd"/&gt;
            &lt;protocol type="FD"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG2"/&gt;
            &lt;protocol type="RSVP"/&gt;
        &lt;/stack&gt;
    &lt;/stacks&gt;
&lt;/subsystem&gt;</pre></div><p>Open a terminal <a id="id506" class="indexterm"/>and execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-tcp-node-1 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=100 -Djboss.node.name=node-1</pre></div></div><div class="section" title="Node-2"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec19"/>Node-2</h3></div></div></div><p>Edit the <a id="id507" class="indexterm"/><code class="literal">standalone-ha.xml</code>  file and replace the <code class="literal">jgroups</code> subsystem as we have done for <code class="literal">node-1</code>.</p><p>Open a terminal and execute the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-tcp-node-2 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=200 -Djboss.node.name=node-2</pre></div></div><div class="section" title="Testing the TCP cluster"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec20"/>Testing the TCP cluster</h3></div></div></div><p>Now that all the <a id="id508" class="indexterm"/>nodes are up and running, let's test our TCP cluster!</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a browser and point to <code class="literal">http://127.0.0.1:8180/cluster-test</code>. Refresh the page a few times and you should see something like the following image:<div class="mediaobject"><img src="graphics/3744_06_13.jpg" alt="Testing the TCP cluster"/><div class="caption"><p>"cluster-test" application running on "node-1" in the TCP cluster—standalone mode with "ha" profile</p></div></div><p>In the <code class="literal">node-1</code> logs, you should catch the following statements:</p><div class="informalexample"><pre class="programlisting">15:04:57,966 INFO  [stdout] (default task-1) ********************************+
15:04:57,967 INFO  [stdout] (default task-1) Visitor(s): 0
15:04:57,967 INFO  [stdout] (default task-1) ********************************+
15:04:59,762 INFO  [stdout] (default task-3) ********************************+
15:04:59,763 INFO  [stdout] (default task-3) Visitor(s): 1
15:04:59,763 INFO  [stdout] (default task-3) ********************************+
15:05:00,105 INFO  [stdout] (default task-4) ********************************+
15:05:00,105 INFO  [stdout] (default task-4) Visitor(s): 2
15:05:00,105 INFO  [stdout] (default task-4) ********************************+
15:05:00,462 INFO  [stdout] (default task-5) ********************************+
15:05:00,462 INFO  [stdout] (default task-5) Visitor(s): 3
15:05:00,463 INFO  [stdout] (default task-5) ********************************+
15:05:01,080 INFO  [stdout] (default task-6) ********************************+
15:05:01,080 INFO  [stdout] (default task-6) Visitor(s): 4
15:05:01,080 INFO  [stdout] (default task-6) ********************************+</pre></div></li><li class="listitem">Now, try <a id="id509" class="indexterm"/>pointing the browser to <code class="literal">http://127.0.0.1:8280/cluster-test</code>. You should see something like the following image:<div class="mediaobject"><img src="graphics/3744_06_14.jpg" alt="Testing the TCP cluster"/><div class="caption"><p>"cluster-test" application running on "node-2" in the TCP cluster—standalone mode with "ha" profile</p></div></div><p>And in the <code class="literal">node-2</code> logs, you should catch the following statements:</p><div class="informalexample"><pre class="programlisting">15:05:28,122 INFO  [stdout] (default task-1) ********************************+
15:05:28,123 INFO  [stdout] (default task-1) Visitor(s): 5
15:05:28,123 INFO  [stdout] (default task-1) ********************************+</pre></div></li></ol></div><p>Our TCP cluster is <a id="id510" class="indexterm"/>working! Let's also try and see if it scales well:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone cl-std-tcp-node-3</pre></div></li><li class="listitem">Now, let's copy the <code class="literal">cluster-test.war</code> application into the <code class="literal">deployments</code> folder of <code class="literal">node-3</code>, as follows:<div class="informalexample"><pre class="programlisting">$ cp cluster-test.war cl-std-tcp-node-3/deployments/</pre></div></li><li class="listitem">Edit the <code class="literal">standalone-ha.xml</code>  file and replace the <code class="literal">jgroups</code> subsystem as we have done for <code class="literal">node-1</code> and <code class="literal">node-2</code>.</li><li class="listitem">Open a terminal and execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $JBOSS_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=cl-std-tcp-node-3 --server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=300 -Djboss.node.name=node-3</pre></div></li></ol></div><p>In the logs of the first two nodes, you should see the following entries:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">23:14:24,466 INFO [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-8,ee,node-1) ISPN000094: Received new cluster view for channel web: [node-1|2] (3) [node-1, node-2, node-3]</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">23:14:24,468 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-9,ee,node-2) ISPN000094: Received new cluster view for channel web: [node-1|2] (3) [node-1, node-2, node-3]</code></li></ul></div><p>Let's test it in the <a id="id511" class="indexterm"/>browser by pointing it to <code class="literal">http://127.0.0.1:8380/cluster-test</code>. You should see something like the following screenshot:</p><div class="mediaobject"><img src="graphics/3744_06_15.jpg" alt="Testing the TCP cluster"/><div class="caption"><p>Scaling "cluster-test" application running on "node-3" in the TCP cluster—standalone mode with "ha" profile</p></div></div><p>Okay, everything worked as expected!</p></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec159"/>How it works…</h2></div></div></div><p>Let's analyze what we have done.</p><p>The main configuration, despite few parameters for the <code class="literal">standalone.sh</code> script, consists of properly setting the <code class="literal">default</code> attribute of the <code class="literal">stack</code> element for the JGroups subsystem, to TCP. Furthermore, we had to set how cluster members ping each other. Default is the <code class="literal">MPING</code> <a id="id512" class="indexterm"/>protocol (the <code class="literal">M</code> stands for multicast). Hence, we defined the ping protocol, named <code class="literal">TCPPING</code>, and defined the well-known hosts (the <code class="literal">initial_hosts</code> property).</p><p>The concept is that every host which wants to join the cluster will ask the well-known hosts for membership information. If those are not running, the new node cannot join the cluster. By the way, if all cluster members are up and the well-known hosts go down, nothing happens to the cluster; they are just seen as two members who left the cluster.</p><p>As a matter of fact, while testing the TCP cluster scaling by adding <code class="literal">node-3</code> and stopping the first two nodes, we would have just seen those entries in the <code class="literal">node-3</code> logs:</p><div class="informalexample"><pre class="programlisting">23:21:54,480 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-8,ee,node-3) ISPN000094: Received new cluster view for channel web: [node-3|5] (2) [node-3, node-2]
23:21:57,473 INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-10,ee,node-3) ISPN000094: Received new cluster view for channel web: [node-3|6] (1) [node-3]</pre></div><p>The properties we defined with regard to the <code class="literal">&lt;protocol type="TCPPING"&gt;...&lt;/protocol&gt;</code> are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">num_initial_members</code>: The number of nodes before the cluster is considered as complete.</li><li class="listitem" style="list-style-type: disc"> <code class="literal">port_range</code>: The port range to try in case a well-known host is not responding. For example, with a <code class="literal">port_range</code> of <code class="literal">50</code> and a well-known host <code class="literal">10.0.0.1[7600]</code>, a new member would try with port <code class="literal">7600</code>, <code class="literal">7601</code>, 7602 to port <code class="literal">7650</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">timeout</code>: The timeout <a id="id513" class="indexterm"/>which a member will wait before joining the cluster.</li></ul></div></div></div>
<div class="section" title="Testing the UDP protocol with the JGroups tool"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec62"/>Testing the UDP protocol with the JGroups tool</h1></div></div></div><p>Often <a id="id514" class="indexterm"/>times, you need to validate and/or certify a configuration, and in case of issues regarding UDP clustering, the first thing to <a id="id515" class="indexterm"/>check is if the UDP is working properly.</p><p>In this recipe, you will learn how to check if the UDP is working, testing it with a graphical tool and using java applications (thus without UI—which is the case of enterprise environment).</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec160"/>How to do it...</h2></div></div></div><p>First of all, let's check if we have the JGroups library in our WildFly installation folder.</p><p>Open your command-line tool and execute the following command:</p><div class="informalexample"><pre class="programlisting">$ find . -name "jgroups*.jar"
./modules/system/layers/base/org/jgroups/main/jgroups-3.6.2.Final.jar</pre></div><p>Great! Now we can test it.</p><div class="section" title="Graphical test"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec21"/>Graphical test</h3></div></div></div><p>Open your <a id="id516" class="indexterm"/>command-line tool.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Now <a id="id517" class="indexterm"/>execute the following command:<div class="informalexample"><pre class="programlisting">$ java -cp modules/system/layers/base/org/jgroups/main/jgroups-3.6.2.Final.jar org.jgroups.demos.Draw
...
-------------------------------------------------------------------
GMS: address=0-44172, cluster=draw-cluster, physical address=fe80:0:0:0:f2de:f1ff:fe99:b294%2:35420
-------------------------------------------------------------------
** View=[0-44172|0] (1) [0-44172]</pre></div><p>You <a id="id518" class="indexterm"/>should see an application like the following image:</p><div class="mediaobject"><img src="graphics/3744_06_16.jpg" alt="Graphical test"/><div class="caption"><p>First JGroups draw application</p></div></div></li><li class="listitem">If you get a network problem because of the IPv6, try forcing IPv4 by adding the following parameter:<div class="informalexample"><pre class="programlisting">-Djava.net.preferIPv4Stack=true</pre></div></li><li class="listitem">Now in a different terminal, execute the same command as mentioned previously:<div class="informalexample"><pre class="programlisting">$ java -cp $WILDFLY_HOME/modules/system/layers/base/org/jgroups/main/jgroups-3.6.2.Final.jar org.jgroups.demos.Draw
...
-------------------------------------------------------------------
GMS: address=0-3647, cluster=draw-cluster, physical address=fe80:0:0:0:f2de:f1ff:fe99:b294%2:40803
-------------------------------------------------------------------
<span class="strong"><strong>** View=[0-44172|1] (2) [0-44172, 0-3647]</strong></span>
</pre></div><p>From this second command, I emphasized the cluster view which is counting two members, and you now see the same application running (the <a id="id519" class="indexterm"/>number within parenthesis <a id="id520" class="indexterm"/>also indicates cluster members):</p><div class="mediaobject"><img src="graphics/3744_06_17.jpg" alt="Graphical test"/><div class="caption"><p>Second JGroups draw application</p></div></div></li><li class="listitem">Draw something on it, and if your UDP works, your sketch should come up on the other canvas, just like mine:<div class="mediaobject"><img src="graphics/3744_06_18.jpg" alt="Graphical test"/><div class="caption"><p>JGroups draw application reflecting changes</p></div></div></li></ol></div><p>If you have problems with the <a id="id521" class="indexterm"/>graphical test, try to test the UDP via <a id="id522" class="indexterm"/>command line, as explained in the next section.</p></div><div class="section" title="Shell test"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec22"/>Shell test</h3></div></div></div><p>Open your <a id="id523" class="indexterm"/>command-line tool:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Now execute <a id="id524" class="indexterm"/>the following command:<div class="informalexample"><pre class="programlisting">$ java -cp $WILDFLY_HOME/modules/system/layers/base/org/jgroups/main/jgroups-3.6.2.Final.jar org.jgroups.tests.McastReceiverTest
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/172.17.42.1
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/10.0.1.6
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/10.0.1.5
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/10.0.1.4
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/10.0.1.3
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/fe80:0:0:0:f2de:f1ff:fe99:b294%em1
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/10.0.254.33
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/0:0:0:0:0:0:0:1%lo
Socket=0.0.0.0/0.0.0.0:5555, bind interface=/127.0.0.1</pre></div><p>This will start a JGroups application as a receiver, so it will be listening for incoming messages.</p></li><li class="listitem">Again, if you get a network problem because of the IPv6, try forcing IPv4 by adding the following parameter:<div class="informalexample"><pre class="programlisting">-Djava.net.preferIPv4Stack=true</pre></div></li><li class="listitem">Now, in a different <a id="id525" class="indexterm"/>terminal, let's call it <code class="literal">sender</code>, execute <a id="id526" class="indexterm"/>the following commands:<div class="informalexample"><pre class="programlisting">$ java -cp $WILDFLY_HOME/modules/system/layers/base/org/jgroups/main/jgroups-3.6.2.Final.jar org.jgroups.tests.McastSenderTest
Socket #1=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/172.17.42.1
Socket #2=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/10.0.1.6
Socket #3=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/10.0.1.5
Socket #4=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/10.0.1.4
Socket #5=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/10.0.1.3
Socket #6=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/fe80:0:0:0:f2de:f1ff:fe99:b294%em1
Socket #7=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/10.0.254.33
Socket #8=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/0:0:0:0:0:0:0:1%lo
Socket #9=0.0.0.0/0.0.0.0:5555, ttl=32, bind interface=/127.0.0.1
&gt;</pre></div></li><li class="listitem">This second terminal will wait for standard input. As I didn't specify any interface or multicast address, it will bind to any available interface, which in my case is more than a couple. By the way, let's try typing something and hitting <span class="emphasis"><em>Enter</em></span>, as follows:<div class="informalexample"><pre class="programlisting">&gt; Ciao!
&gt;</pre></div></li><li class="listitem">Now look at the first terminal, the one where we launched the <code class="literal">receiver</code> application:<div class="informalexample"><pre class="programlisting">Ciao! [sender=172.17.42.1:5555]
Ciao! [sender=10.0.1.6:5555]
Ciao! [sender=10.0.1.5:5555]
Ciao! [sender=10.0.1.4:5555]
Ciao! [sender=10.0.1.3:5555]
Ciao! [sender=10.0.254.33:5555]
Ciao! [sender=10.0.254.33:5555]
Ciao! [sender=127.0.0.1:5555]
Ciao! [sender=127.0.0.1:5555]</pre></div></li></ol></div><p>Yeah! We received <a id="id527" class="indexterm"/>everything, from all available and configured <a id="id528" class="indexterm"/>interfaces.</p></div></div></div></body></html>