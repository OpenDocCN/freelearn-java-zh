<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;BPMN Constructs"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. BPMN Constructs</h1></div></div></div><p>To classify the level of support that a BPMN software tool provides, the BPMN standard defines the "conformance classes" as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Process Modeling Conformance</strong></span>: This class includes the BPMN core elements, process, collaboration, and conversation diagrams. It defines subclasses that contain a<a id="id440" class="indexterm"/> limited set of visual elements (descriptive), an extended set of modeling elements (analytical), and modeling elements that are required to model executable processes (common executable).</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Process Execution Conformance</strong></span>: It requires<a id="id441" class="indexterm"/> a software tool to support the operational semantics of BPMN.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Choreography Modeling Conformance</strong></span>: The choreography modeling conformance class<a id="id442" class="indexterm"/> includes the BPMN core elements and the collaboration and choreography diagrams.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>jBPM supports a great part of the Common Executable class, with additional extensions. Please check <a class="link" href="ch06.html" title="Chapter 6. Core Architecture">Chapter 6</a>, <span class="emphasis"><em>Core Architecture</em></span>, of the jBPM 6.2 user guide for insights into the topic.</p></div></div><p>jBPM introduced the<a id="id443" class="indexterm"/> implementation of the BPMN 2.0 specification with the jBPM 5 release, for both the graphical notation (element visual representation) and the XML serialization, easing the task of exchanging process definitions between developers and the business team (in terms of Eclipse-based BPMN editor and process Web-based designer interoperability).</p><p>Other jBPM BPMN <a id="id444" class="indexterm"/>notable features are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Compliance with the BPMN process execution semantics ("Common Executable" subclass specification)</li><li class="listitem" style="list-style-type: disc">The BPMN <span class="strong"><strong>DI</strong></span> (which stands for <span class="strong"><strong>Diagram Interchangeability</strong></span>) specification for storing diagram information</li><li class="listitem" style="list-style-type: disc">The BPMN I/O specification for input/output mapping</li></ul></div><p>In <a class="link" href="ch01.html" title="Chapter 1. Business Process Modeling – Bridging Business and Technology">Chapter 1</a>, <span class="emphasis"><em>Business Process Modeling – Bridging Business and Technology</em></span>, we already had an overview of the main BPMN concepts, constructs, and modeling patterns. We selected the topics for this chapter not to provide you with a BPMN modeling or reference guide, but as hands-on, example-driven explanation of all BPMN constructs supported by jBPM, without completely hiding away the underlying technical details.</p><p>In this chapter, we will discuss the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The concept behind the BPMN construct</li><li class="listitem" style="list-style-type: disc">How to use it in a business process (with examples)</li><li class="listitem" style="list-style-type: disc">Best practices for when and where to use BPMN constructs</li></ul></div><div class="section" title="Parameters, variables, and data"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec30"/>Parameters, variables, and data</h1></div></div></div><p>Most of the time, business processes are data-driven processes: tasks handle variables, and rules handle facts; you will not be asked to draw a BPMN diagram without handling variables, parameters, objects, and states coming from external systems, user input, and other sources. A majority of the jBPM constructs are useless without data. Let us clarify the basics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Parameters</strong></span>: These are the data<a id="id445" class="indexterm"/> input coming from the user through the API. The user can pass parameters during process creation, at a<a id="id446" class="indexterm"/> human task completion, or into a service task for a Web service call.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Variables</strong></span>: Variables <a id="id447" class="indexterm"/>are objects living in the scope of a single <a id="id448" class="indexterm"/>process instance. Variables can be created directly inside a process instance construct (for example, Script Activity and Data Object) or can be mapped from/to other variables (Data Input/Output Mapping) defined in another scope, for example, from the main process to a subprocess, from the process to <a id="id449" class="indexterm"/>a human task, and so on.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Globals</strong></span>: Static variables<a id="id450" class="indexterm"/> shared across different process instances for a single<a id="id451" class="indexterm"/> Kie working session.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Facts</strong></span>: Data that can <a id="id452" class="indexterm"/>be added to the Kie session and then updated or removed (retracted). This information is inserted, technically speaking, into the session through channels named <a id="id453" class="indexterm"/><span class="strong"><strong>entry points,</strong></span> and evaluated according<a id="id454" class="indexterm"/> to the Drools business rules, for activation. Drools Agenda manages the rule activation and firing mechanism.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>Please refer to Drools reference documentation for additional details on facts, rules, entry points, Agenda, and the Drools rule engine in general: <a class="ulink" href="https://docs.jboss.org/drools/release/6.2.0.Final/drools-docs/html">https://docs.jboss.org/drools/release/6.2.0.Final/drools-docs/html</a>. Drools and jBPM are complementary projects that integrate together very<a id="id455" class="indexterm"/> nicely.</p></div></div><p>Variables and globals are accessed through context-type implicit references made available to the jBPM constructs at runtime:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ProcessContext</code> (<code class="literal">kcontext</code>): This gives you access to variables</li><li class="listitem" style="list-style-type: disc"><code class="literal">KieRuntime</code> (<code class="literal">kcontext.getKieRuntime()</code>): This gives you access to globals and facts</li></ul></div><p>There are no implementation constraints on parameters, variables, and global class types apart from implementing the <code class="literal">java.io.Serialization</code> interface. Remember in fact that jBPM uses the standard in-memory serialization mechanism (<code class="literal">readObject</code>/<code class="literal">writeObject</code>). When we enable persistence, it features an additional custom object marshalling mechanism to and from the store for session and process instances (see <span class="emphasis"><em>Marshalling</em></span> in <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span>). Furthermore, when there are persisting process variables for auditing and logging (<code class="literal">VARIABLEINSTANCELOG</code> table), jBPM stores the values by calling the process variable <code class="literal">toString()</code> method.</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>jBPM does not provide out-of-the-box process variable persistence in any of its schema tables. We need to implement our ad-hoc variable serialization strategy (we will cover variables persistence with <span class="emphasis"><em>Marshalling</em></span> in <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span>.).</p></div></div></div></div>
<div class="section" title="Sequence flow"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec31"/>Sequence flow</h1></div></div></div><p>The sequence flow is<a id="id456" class="indexterm"/> the connector between two elements of the process. It represents a flow of execution. A sequence flow may optionally have a condition defined (conditional sequence flow). The engine always evaluates a task node's outgoing sequence flows: If the condition evaluates to true then the engine selects and follows that sequence flow; a sequence flow with no condition defined is always followed by the engine. A <a id="id457" class="indexterm"/>
<span class="strong"><strong>diamond shaped</strong></span> connector (see <a class="link" href="apb.html" title="Appendix B. jBPM BPMN Constructs Reference">Appendix B</a>, <span class="emphasis"><em>jBPM BPMN Constructs Reference, Gateways</em></span> section for some pictorial examples) indicates a conditional sequence flow. Multiple sequence flows represent branching and merging without the usage of a gateway. Gateways, depending on their nature, handle conditional sequence flows in specific ways as we are about to see.</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>jBPM allows you to enable multiple outgoing conditional sequence flows from a task by setting the <code class="literal">jbpm.enable.multi.con</code> system property to <code class="literal">true</code> (default is <code class="literal">false</code>).</p></div></div><p>The following example process (see the figure) shows how the <code class="literal">jbpm.enable.multi.con</code> property affects the sequence flow behavior.</p><div class="mediaobject"><img src="graphics/9578OS_05_01.jpg" alt="Sequence flow"/></div><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.SequenceTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">sequenceflows.bpmn</pre></div><p>Description: The test creates the process instance with an <code class="literal">Order</code> variable with different cost values. The<a id="id458" class="indexterm"/> process, thanks to the <code class="literal">jbpm.enable.multi.con</code> system property set to <code class="literal">TRUE</code>, allows the execution of multiple (here, we have two) conditional sequence flows that diverge from a single Script Activity. The first sequence flow is taken if the Order costs more than 10, while the second one is taken when the Order cost is ≤10.</p></div>
<div class="section" title="Gateways"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Gateways</h1></div></div></div><p>Gateways are elements that allow you to create branches in your process. These branches can be, conceptually, diverging or converging. You can model the behavior of the different types of business process sequence flows: conditional branching (inclusive and exclusive), forking, merging, and joining.</p><p>Let us first review the key<a id="id459" class="indexterm"/> gateway concepts and the practical examples in the upcoming sections:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Fork (split) indicates a<a id="id460" class="indexterm"/> flow dividing into two or more paths that should execute in a logically parallel (concurrent) way: jBPM, for implementation reasons, never executes parallel flows concurrently (at the thread level) but always sequentially, one step at a time</li><li class="listitem" style="list-style-type: disc">Join (or synchronization) refers to the combining of two or more parallel paths into one path</li><li class="listitem" style="list-style-type: disc">Branch (or decision) is a point where the control flow can take one or more alternative paths</li><li class="listitem" style="list-style-type: disc">Merge refers to a process point where two or more alternative sequence flow paths<a id="id461" class="indexterm"/> are combined into a single sequence flow path</li></ul></div><p>Hence, the gateway <span class="strong"><strong>direction</strong></span> <a id="id462" class="indexterm"/>property is defined as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unspecified</strong></span>: May have <a id="id463" class="indexterm"/>both multiple incoming and outgoing connections</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Mixed</strong></span>: Multiple incoming <a id="id464" class="indexterm"/>and outgoing connections</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Converging</strong></span>: Multiple<a id="id465" class="indexterm"/> incoming connections and only one outgoing connection</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Diverging</strong></span>: Only<a id="id466" class="indexterm"/> one incoming connection and multiple outgoing sequence flows</li></ul></div><p>Unspecified and mixed directions are not implemented</p><p>Let us now see how these BPM concepts translate into jBPM modeling elements.</p><div class="section" title="Parallel (AND) gateway"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec75"/>Parallel (AND) gateway</h2></div></div></div><p>This gateway allows us to fork into multiple paths of execution or to join multiple incoming paths of <a id="id467" class="indexterm"/>execution. When used to fork a sequence flow (diverging or AND-split), all outgoing branches are activated simultaneously. When joining <a id="id468" class="indexterm"/>parallel branches (converging or AND-join), it waits for all incoming branches to complete before moving to the outgoing sequence flow. This gateway must be used when many activities have to be carried out at the same time in any particular order.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.gateway.GatewayParallelTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">gateway_parallel.bpmn</pre></div><p>Description: The plan route script task<a id="id469" class="indexterm"/> calculates the order delivery route, while the<a id="id470" class="indexterm"/> <span class="strong"><strong>Prepare Ingredients</strong></span> human task adds some mozzarella to the order bill of materials. The closing <span class="strong"><strong>Done</strong></span> Script task displays<a id="id471" class="indexterm"/> the result after all outgoing<a id="id472" class="indexterm"/> flows are complete.</p><div class="mediaobject"><img src="graphics/9578OS_05_22.jpg" alt="Parallel (AND) gateway"/></div></div><div class="section" title="Conditional branching"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec76"/>Conditional branching</h2></div></div></div><p>These gateways introduce the <span class="emphasis"><em>condition expression</em></span>. The condition expressions linked to each of the <a id="id473" class="indexterm"/>outgoing/incoming sequence flows are evaluated during process execution using process data (data-based gateways). Optionally, one of the gateway outgoing paths can be flagged as<a id="id474" class="indexterm"/> the <span class="strong"><strong>default flow</strong></span> (its condition is ignored): this path is taken only if none of the other path flows<a id="id475" class="indexterm"/> can be selected. The default (sequence) flow is visually marked with a slash mark as shown in the following image:</p><div class="mediaobject"><img src="graphics/9578OS_05_02.jpg" alt="Conditional branching"/></div><p>The "default flow" property is supported in the Exclusive and Inclusive Gateway elements.</p><div class="section" title="Drools"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec41"/>Drools</h3></div></div></div><p>We briefly introduced Drools facts and rules in the first section. Conditional branching based on Drools expressions works with facts but not with process variables. If we want to leverage the <a id="id476" class="indexterm"/>Drools expression features in the gateway constructs, we have to insert the process variable as a Drools fact, for example, given the process variable <code class="literal">order</code>:</p><div class="informalexample"><pre class="programlisting">Order order = new Order();
order.setNote("urgent");
order.setCost(110);</pre></div><p>From inside the process definition (by a Script task, a Task <span class="strong"><strong>on exit</strong></span> Script, and so on), we insert the following fact:</p><div class="informalexample"><pre class="programlisting">kcontext.getKnowledgeRuntime().insert(order);</pre></div><p>Alternatively, we can do so by using the API as follows:</p><div class="informalexample"><pre class="programlisting">  ksession.insert(order);
  ksession.fireAllRules();</pre></div></div></div><div class="section" title="Exclusive (XOR) gateway"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec77"/>Exclusive (XOR) gateway</h2></div></div></div><p>It is used to model a decision<a id="id477" class="indexterm"/> in the process. More than one path cannot be taken; the paths are mutually exclusive, hence, the name. In case multiple sequence flows have a condition that<a id="id478" class="indexterm"/> evaluates to true, the first one defined in the XML is selected for continuing the process. In an exclusive gateway, all outgoing sequence flows should have conditions defined on them. The default sequence flow is an <a id="id479" class="indexterm"/>exception to this rule.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.gateway.GatewayExclusiveTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">gateway_exclusive.bpmn</pre></div><p>Description: Different paths are taken for successful Pizza deliveries; the default path is chosen when other conditions are not met.</p><div class="mediaobject"><img src="graphics/9578OS_05_03.jpg" alt="Exclusive (XOR) gateway"/></div></div><div class="section" title="Inclusive (OR) gateway"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec78"/>Inclusive (OR) gateway</h2></div></div></div><p>An inclusive gateway<a id="id480" class="indexterm"/> is a branching point of the business process. Unlike the exclusive gateway, an inclusive gateway may trigger more than one outgoing flow and execute them in parallel (such as the parallel gateway). So, with diverging behavior, the gateway will always evaluate all outgoing sequence flow conditions, regardless of whether it already has a satisfied outgoing flow or not (unlike the exclusive gateway). In the case of converging behavior, the gateway will wait until all the incoming active sequence flows have reached it (merging). We can usually use this construct in a pair of splitting/merging gateways (see the following example) when we need to fork executions depending on certain conditions and then rejoin them.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.gateway.GatewayInclusiveTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">gateway_inclusive.bpmn</pre></div><div class="mediaobject"><img src="graphics/9578OS_05_23.jpg" alt="Inclusive (OR) gateway"/></div><p>Description: Multiple different paths are taken for evaluation of the order delivery status; the <code class="literal">testIssues</code> test is<a id="id481" class="indexterm"/> set up so as to make the process take both the <span class="strong"><strong>delivery not on time</strong></span> (<code class="literal">deliveryDate</code> &gt; <code class="literal">dueDate</code>) and the <span class="strong"><strong>retries &gt; 1</strong></span> path. The default path is chosen when <a id="id482" class="indexterm"/>other conditions are not met (see the <code class="literal">testNoIssues</code> test).</p></div><div class="section" title="Event-based gateways"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec79"/>Event-based gateways</h2></div></div></div><p>Event-based gateways are similar to exclusive gateways, but the gateway trigger is based on event<a id="id483" class="indexterm"/> occurrence instead of condition evaluation. When our process arrives at an event-based gateway, we will have to wait until something happens. A specific event, usually the receipt of a message, determines the path that will be taken. Basically, the decision is made by another actor on the basis of data that is<a id="id484" class="indexterm"/> not visible to a process. This gateway is always a diverging gateway and must have at least one event attached.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.gateway.GatewayEventAndTaskTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">gateway_event_and_task.bpmn</pre></div><div class="mediaobject"><img src="graphics/9578OS_05_24.jpg" alt="Event-based gateways"/></div><p>Description: The<a id="id485" class="indexterm"/> event gateway has a timer attached; when the timer expires, the<a id="id486" class="indexterm"/> <span class="strong"><strong>send alert</strong></span> script is executed, bringing the process to<a id="id487" class="indexterm"/> termination.</p><div class="section" title="Instantiating gateway"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec42"/>Instantiating gateway</h3></div></div></div><p>The instantiating gateway is a<a id="id488" class="indexterm"/> specialized event-based gateway, which triggers the process instantiation as soon as an attached event is received. The "instantiate" option (as of jBPM 6.2 the option is available in the jBPM Eclipse plug-in only) configures the gateway as a diverging gateway with no incoming connections: this gives you a way to instantiate a process by using an event, such as timer expiration or a catching signal event (see the following sections for timers and signals). jBPM does not support a pure instantiating gateway with no incoming connection: you always have to link it to a Start "None" event (see the following figure) or the process compilation will fail (complaining with a "missing incoming connection" error)</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.gateway.GatewayEventTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">gateway_event.bpmn</pre></div><p>Description: Depending on events sent from an external (API call), different paths are taken (the <code class="literal">testCustomerPhoneCallEvent</code> and <code class="literal">testDeliveredEvent</code> methods); the timer triggers after 15 s if no event is caught (the <code class="literal">testTimerExpired</code> method). Note that both catching events pass the signal data (a randomly generated <code class="literal">orderid</code> string) to the process<a id="id489" class="indexterm"/> parameter <code class="literal">orderid</code>, which is later printed from the script tasks.</p><div class="mediaobject"><img src="graphics/9578OS_05_04.jpg" alt="Instantiating gateway"/></div></div></div><div class="section" title="Complex gateway"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec80"/>Complex gateway</h2></div></div></div><p>This gateway<a id="id490" class="indexterm"/> can be used to model complex synchronization behavior. The construct options are available at the designer level, but jBPM<a id="id491" class="indexterm"/> has no implementation for this construct.</p></div></div>
<div class="section" title="Events"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Events</h1></div></div></div><p>Events are elements <a id="id492" class="indexterm"/>used to model something that happens during the process lifetime. BPMN 2.0 defines two main event categories: <span class="strong"><strong>catching</strong></span> and <span class="strong"><strong>throwing</strong></span> events.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Catching</strong></span>: This event represents a<a id="id493" class="indexterm"/> pausing point in the process execution: Once the process flow reaches the catching event node, it stops in the wait state, waiting for a specific trigger to happen.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Throwing</strong></span>: This event<a id="id494" class="indexterm"/> represents an action generating an event. When process execution reaches the event construct, an action is performed and a trigger is fired. For this throwing event, depending on the event type, there could be a matching catching event or not, that is, a send signal (throwing)/catch signal or send error (throwing)/catch error. On the other hand, the compensate throw event does not have<a id="id495" class="indexterm"/> a catch companion, while the timer event is always a catching event.</li></ul></div><p>Events are also categorized according to other criteria:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An event can <a id="id496" class="indexterm"/>appear at the beginning of a process (Start event), within a process (Intermediate event), or at the end of a process (End event)</li><li class="listitem" style="list-style-type: disc">An event can be generic or one of the different predefined types: time-based, message-based, signal-based, rule-based, exception-based, and so on</li><li class="listitem" style="list-style-type: disc">An event can be positioned within a sequence flow or attached at the boundary of an activity (Boundary event)</li><li class="listitem" style="list-style-type: disc">An event can exit the current process execution or not</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>A note before we start:</p><p>To facilitate reading, we'll go through the events by grouping them by event type (Start, Boundary, End) and then illustrating the supported variations (catching/throwing and start/intermediate/boundary/end) for each type of event (Signal, Message, Timer…).</p><p>For additional information and a complete jBPM constructs reference (ordered the same way as you will find in both the Eclipse BPMN modeling tool palette and the KIE console palette), please refer to <a class="link" href="apb.html" title="Appendix B. jBPM BPMN Constructs Reference">Appendix B</a>, <span class="emphasis"><em>jBPM BPMN Constructs Reference</em></span>.</p></div></div><div class="section" title="Start events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec81"/>Start events</h2></div></div></div><p>The start event defines<a id="id497" class="indexterm"/> where (and how) the process is started; Start events <a id="id498" class="indexterm"/>are catching-only events. When a specific start event trigger fires (timer, messages, signal, and so on) the process is started. We will now see the None Start event; the other start event types are discussed in their respective sections.</p><p>Supported <a id="id499" class="indexterm"/>start events are: None, Message, Timer, Escalation, Conditional, Error, Compensation, Signal</p><div class="section" title="None Start event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec43"/>None Start event</h3></div></div></div><p>The simplest form of a Start event is the None Start event. It technically means that the trigger for starting the<a id="id500" class="indexterm"/> process instance is not specified; in other words, the engine does not know when the process instance is to be started. The only way to start the process is by invoking the <code class="literal">startProcess</code> method on a Kie session reference.</p><div class="informalexample"><pre class="programlisting">ProcessInstancestartProcess(String processId, Map&lt;String, Object&gt; parameters);</pre></div></div></div><div class="section" title="End events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec82"/>End events</h2></div></div></div><p>The End events are meant to express the end of a process or subprocess, and they are always throwing<a id="id501" class="indexterm"/> events. When the process execution arrives in the End event node, the<a id="id502" class="indexterm"/> associated event type is thrown. A process definition can have one or more End events defined. In this section, we will see the None and the Terminate End event; the other End event types are discussed in their respective sections.</p><p>Supported end events are: None, Message, Escalation, Error, Cancel, Compensation, Signal, Terminate</p><div class="section" title="(None) End event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec44"/>(None) End event</h3></div></div></div><p>The None End event throws<a id="id503" class="indexterm"/> no events, and the engine just ends the current process instance sequence flow execution. If there are no more active sequence flows or nothing else to be performed (activities), the process instance is completed.</p></div><div class="section" title="Terminate End event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec45"/>Terminate End event</h3></div></div></div><p>The Terminate<a id="id504" class="indexterm"/> End event brings the process instance to the Completed state; all pending tasks, active sequence flows, and subprocesses are aborted.</p></div></div><div class="section" title="Boundary events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec83"/>Boundary events</h2></div></div></div><p>Boundary events are<a id="id505" class="indexterm"/> events (always catching) that are graphically attached to an activity (subprocesses included) boundary (see the following figure). The event is registered for a certain type of trigger (see the following supported boundary events) and reacts only within the scope of the execution of the attached activity, with slight variations depending on the event type. In case the event triggers, it can optionally cancel the<a id="id506" class="indexterm"/> activity that it is attached to (by its <code class="literal">cancelActivity</code> property), and the event's outgoing sequence flow is executed. The boundary events are activated when the attached activity is started; in other words, they are bound to the activity instance life cycle. When the engine process execution path leaves the activity, all its attached boundary events are deactivated and their triggering is cancelled.</p><p>Supported boundary events are: Conditional, Error, Escalation, Message, Signal, Timer</p><p>See the <span class="emphasis"><em>Boundary Message event</em></span> section for a working example.</p><div class="mediaobject"><img src="graphics/9578OS_05_05.jpg" alt="Boundary events"/></div></div><div class="section" title="Signal events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec84"/>Signal events</h2></div></div></div><p>A signal is a<a id="id507" class="indexterm"/> generic, simple form of communication, such as messages (see below). We can use signals to<a id="id508" class="indexterm"/> synchronize and exchange information. A catching signal may not have a corresponding throwing signal construct. It can also be sent programmatically from an external source (API). In contrast to other events (error event), if a signal is caught, it is not consumed. If there are two active intermediate catching events firing on the same signal event name, both events are triggered, even if they are part of different process instances and definitions. If the signal is <a id="id509" class="indexterm"/>sent and there are no catching signals registered for this event, the event is lost.</p><div class="section" title="Scope"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec46"/>Scope</h3></div></div></div><p>Signals can have visibility between different parts of the same process or broadcast processes (scope across all process instances), or targeted to a specific process instance. You can throw a signal event in a<a id="id510" class="indexterm"/> process instance, and other process instances with a different process definition can react to the event. Please keep in mind that this behavior (broader or narrower signal scope) can be affected by the <span class="emphasis"><em>runtime strategy</em></span> chosen to create your Kie session (the subject is discussed in <a class="link" href="ch06.html" title="Chapter 6. Core Architecture">Chapter 6</a>, <span class="emphasis"><em>Core Architecture</em></span>).</p></div><div class="section" title="Signal ID and signal name tips"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec47"/>Signal ID and signal name tips</h3></div></div></div><p>You may notice some issues with signals when creating/modifying process signals in BPMN processes shared between the KIE jBPM console editor and the Eclipse BPMN modeler. The generated<a id="id511" class="indexterm"/> BPMN differs, and this may lead to bugs and unexpected behavior.</p><p>When creating the<a id="id512" class="indexterm"/> process definition from the Eclipse BPMN editor, the signal is assigned an internal ID of the form: <code class="literal">Signal_{number}</code>. Therefore, the actual signal ID to use is the same signal ID that you see in the <code class="literal">Signal</code> property editor and not the user-assigned signal name in the process definition panel (signal list table). Keep in mind this additional signal name referencing when coding against the <code class="literal">org.kie.api.runtime.KieSession.sendSignal</code> method.</p><div class="informalexample"><pre class="programlisting">&lt;bpmn2:signal id="Signal_1" name="customerPhoneCall"/&gt;
&lt;bpmn2:signalEventDefinition id="SignalEventDefinition_1" signalRef="Signal_1"/&gt;</pre></div><p>Therefore, with an Eclipse-generated process, the <code class="literal">Signal_1</code> ID must be used with the API.</p><div class="informalexample"><pre class="programlisting">&lt;bpmn2:signal id="customerPhoneCall" name="customerPhoneCall"/&gt;
&lt;bpmn2:signalEventDefinition id="_05nSUW_YEeSWR_CUOywjGQ" signalRef="customerPhoneCall"/&gt;</pre></div><p>With a process generated from a jBPM Web console editor, the signal ID is equal to the name attribute; <code class="literal">customerPhoneCall</code> must be used with the API.</p></div><div class="section" title="Signal data mapping"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec48"/>Signal data mapping</h3></div></div></div><p>Signals can carry optional object data; for each triggered catching signal, you can get this signal data and map it to a process variable. When operating with the jBPM Web designer, in order to<a id="id513" class="indexterm"/> successfully map the signal data to a process variable, you have to configure the <span class="strong"><strong>DataOutput</strong></span> signal and assign it the name <span class="strong"><strong>event</strong></span> as you can see in the following screenshot. The picture shows the event's data mapping for the <code class="literal">start_signal.bpmn</code> process signal events (see the <span class="emphasis"><em>Start</em></span> <span class="emphasis"><em>Signal event</em></span> section example for a detailed event data mapping example).</p><div class="mediaobject"><img src="graphics/9578OS_05_06.jpg" alt="Signal data mapping"/></div><p>This is a very flexible mechanism. By delivering data with your signals, you can update process variables, convey extra information, or change the process flow very easily.</p></div><div class="section" title="Start Signal event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec49"/>Start Signal event</h3></div></div></div><p>With a named<a id="id514" class="indexterm"/> Start Signal, we can programmatically start a process instance. The signal can be fired from within an existing process instance by using the intermediary signal throw event or through the API (the <code class="literal">sendSignal</code> method). In both cases, all process definitions that have a Signal Start event with the same name will be started. You can have multiple Start Signal events in a single process definition.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.StartTest (method testSignalStart)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">start_signal.bpmn</pre></div><div class="mediaobject"><img src="graphics/9578OS_05_25.jpg" alt="Start Signal event"/></div><p>Description: Different Start Signal events are sent so as to create different process instances. The signal data is mapped to the process variable (see the previous section for an explanation<a id="id515" class="indexterm"/> of event data mapping).</p></div><div class="section" title="Intermediate Signal event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec50"/>Intermediate Signal event</h3></div></div></div><p>An<a id="id516" class="indexterm"/> Intermediate catching Signal event catches signals sent from a throwing intermediate signal or through the API call (<code class="literal">KieSession</code> or <code class="literal">ProcessInstance.sendSignal</code>) and continues the process instance flow. The catching signal has no incoming connections.</p></div><div class="section" title="Boundary Signal event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec51"/>Boundary Signal event</h3></div></div></div><p>See the <span class="emphasis"><em>Boundary events</em></span> <a id="id517" class="indexterm"/>section.</p></div><div class="section" title="End Signal event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec52"/>End Signal event</h3></div></div></div><p>This kind of <a id="id518" class="indexterm"/>signal event is sent at the completion of the process. It can be a handy way to track process instance completions across the system.</p></div></div><div class="section" title="Message events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec85"/>Message events</h2></div></div></div><p>Message events<a id="id519" class="indexterm"/> reference a name and can optionally have a payload. Unlike a signal, a message event is always targeted at a single catching message. The name<a id="id520" class="indexterm"/> of the catch and throw messages must be exactly the same in order to make the message flow work properly. Let us point out some differences between messages and signals:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Inside the BPMN diagram, the message flow is drawn linking the sender to the receiver, while signals are never directly connected on the diagram. The throwing and the catching signal are implicitly connected only by their name.</li><li class="listitem" style="list-style-type: disc">Messages should only be thrown/caught in the same process instance; there is no<a id="id521" class="indexterm"/> such limitation for signals. Messages work at the process instance scope only and are point-to-point links. A signal can travel from one process instance<a id="id522" class="indexterm"/> to many process instances (broadcast scope).</li></ul></div><div class="section" title="Message data mapping"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec53"/>Message data mapping</h3></div></div></div><p>See the <span class="emphasis"><em>Signal data mapping</em></span> section.</p></div><div class="section" title="Start Message event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec54"/>Start Message event</h3></div></div></div><p>A Start Message event is used to start a process instance as a direct consequence of catching a message; a process <a id="id523" class="indexterm"/>can have multiple Message Start events. This allows us to choose the process creation method simply by changing the Message event name to send (see the following image). Make sure that the message event name is unique across all loaded process definitions to avoid unwanted process creations.</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>When sending the message from the API (<code class="literal">sendSignal</code>), we have to prefix the message name with the <code class="literal">Message-</code> string.</p></div></div><p>Message Start events are supported only with top-level processes and not with embedded subprocesses.</p><div class="mediaobject"><img src="graphics/9578OS_05_07.jpg" alt="Start Message event"/></div></div><div class="section" title="Intermediate Message event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec55"/>Intermediate Message event</h3></div></div></div><p>If a process is waiting for the message, it will either be paused until the message arrives or change the flow for <a id="id524" class="indexterm"/>exception handling. For using a throw message, there has to be a catch message event that catches the message. It can be a message intermediate event or a message start event.</p></div><div class="section" title="Boundary Message event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec56"/>Boundary Message event</h3></div></div></div><p>The following example shows task <a id="id525" class="indexterm"/>cancellation and message data passing by using two boundary events (a timer and a message) attached to a human task. The timer has the <code class="literal">cancel activity</code> property set to <code class="literal">FALSE</code>, while the message has it set to <code class="literal">TRUE</code>. The boundary message event maps the event data to a process variable in order to log the cancellation reason passed by the throwing (external) message sent by the test class.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.BoundaryTest (method testBoundaryWithCancel)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">boundary.bpmn</pre></div><p>Description: A process with a human task is created. The timer event's duty is to cycle and expire every 15 s calling the script task "time out warning" (its timer expression is <code class="literal">15s###15s</code>, and it is not flagged as "cancel activity"; therefore, the task will not be cancelled as the timer triggers). When the user continues with the test (the test class asks the user to press a key to proceed), a message is sent (<code class="literal">sendSignal</code>), the process message boundary event is triggered, and the activity is cancelled (since the boundary message event has the "cancel activity" flag enabled). Note that the message is sent by our test class <a id="id526" class="indexterm"/>with some data that serves as the task cancellation reason (<code class="literal">"cancelled by ADMIN"</code>):</p><div class="informalexample"><pre class="programlisting">sendSignal("Message-messageCancelService", "cancelled by ADMIN");</pre></div><p>The boundary message (<code class="literal">id=messageCancelService</code>) catches the sent message, and the message event data, which is bound to the process variable <span class="strong"><strong>reason</strong></span>, is printed in standard output by the <span class="strong"><strong>cancel log</strong></span> script task.</p><div class="mediaobject"><img src="graphics/9578OS_05_08.jpg" alt="Boundary Message event"/></div></div><div class="section" title="End Message event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec57"/>End Message event</h3></div></div></div><p>A message is sent to<a id="id527" class="indexterm"/> a specific process at the conclusion of a process.</p></div><div class="section" title="jBPM throwing message implementation"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec58"/>jBPM throwing message implementation</h3></div></div></div><p>The jBPM throwing<a id="id528" class="indexterm"/> message default implementation is just a placeholder. You must provide your own WorkItemHandler definition and register it with the name <code class="literal">Send Task</code> to the jBPM Runtime, providing a hook to the working Kie session (identified by <code class="literal">ksession</code> in the following code fragment):</p><div class="informalexample"><pre class="programlisting">SendMessageTaskHandler messagehandler = new SendMessageTaskHandler();
messagehandler.setKnowledgeRuntime(ksession);
ksession.getWorkItemManager().registerWorkItemHandler("Send Task",messagehandler);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>Throughout this chapter, you will find several references to "workItem" and "workItem handler and manager." These are the jBPM component part of a feature that lets you define a custom Java class and bind it with a specific process activity type in the engine runtime. Every time the engine activates this activity type, your handler will be invoked and passed the control. Please refer to <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span> for detailed explanation and examples.</p></div></div><p>From the<a id="id529" class="indexterm"/> custom workItemHandler, you can then send signals:</p><div class="informalexample"><pre class="programlisting">public void executeWorkItem(WorkItemworkItem, WorkItemManager manager) {
ksession.signalEvent("Message-startmessage", "processdata");</pre></div><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.StartTest (method testMessageStartFromMessageThrow)</pre></div><p>Example processes:</p><div class="informalexample"><pre class="programlisting">start_message_catch.bpmn, start_message_throw.bpmn</pre></div><p>Description: The process created sends a message by a custom WorkItemHandler starting a new instance of the <code class="literal">start_message_catch</code> process (by a start message event).</p></div></div><div class="section" title="Timer events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec86"/>Timer events</h2></div></div></div><p>Timer events are events that are triggered when a timer construct expression is met; the timer properties<a id="id530" class="indexterm"/> are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Time Duration</strong></span>: Single trigger<a id="id531" class="indexterm"/> delay value (for example: 10 m, 25 s).</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Timer Cycle</strong></span>: The time <a id="id532" class="indexterm"/>expression that shall be evaluated. It can be a string (interval-based 20 s or 5 m###35 s, where the first value is the initial delay and the second value is the delay between repeated fires), a string <code class="literal">cron</code> expression, or a process variable. In the case of JBPM 6.x, it can also be a ISO-8601 formatted date.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Timer Cycle Language</strong></span>: Can <a id="id533" class="indexterm"/>be a default interval (empty value and time duration set) or <code class="literal">cron</code>.</li></ul></div><div class="section" title="Start Timer event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec59"/>Start Timer event</h3></div></div></div><p>A Start Timer event is used to<a id="id534" class="indexterm"/> create a process instance at a given time. It can be used for processes that should start only once and for processes that should start at specific time intervals. Note the following points:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A subprocess cannot have a start timer event.</li><li class="listitem" style="list-style-type: disc">A Start Timer event is registered as soon as the process is deployed. There is no need to call the <code class="literal">startProcessInstance</code> API.</li><li class="listitem" style="list-style-type: disc">When a new version of a process with a Start Timer event is deployed, the job corresponding to the old timer will be removed.</li></ul></div></div><div class="section" title="Intermediate Timer event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec60"/>Intermediate Timer event</h3></div></div></div><p>This event is a catching <a id="id535" class="indexterm"/>event only. The timer value triggers the execution of the outgoing sequence flow. You can use the timer to insert a generic delay or a timed-out sequence flow execution; for example, you could add a timer to manage a due date for a human task completion (see the <span class="emphasis"><em>Event-based gateway</em></span> section example for a timer that acts this way).</p></div><div class="section" title="Boundary Timer event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec61"/>Boundary Timer event</h3></div></div></div><p>See the <span class="emphasis"><em>Boundary Message event</em></span> section for an<a id="id536" class="indexterm"/> example.</p></div></div><div class="section" title="Error events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec87"/>Error events</h2></div></div></div><p>Error events are used to model business exceptions. They are triggered by an exception that might be<a id="id537" class="indexterm"/> generated during the execution of an activity. Intermediary throw/catch error<a id="id538" class="indexterm"/> events do not apply.</p><div class="section" title="Boundary Error event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec62"/>Boundary Error event</h3></div></div></div><p>This boundary error event must be<a id="id539" class="indexterm"/> attached to an activity. As the error event triggers, the activity is always canceled and the error event's outgoing sequence flow is taken.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.ErrorTest (method testBoundaryErrors)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">errorboundary.bpmn</pre></div><p>Description: Two different boundary error events are attached to the same user task registered on different <code class="literal">errorCode</code> properties (<code class="literal">FileNotFoundException</code> or <code class="literal">RuntimeException</code>); the error handler logs the exception message. Depending on the process parameter (<code class="literal">triggerexceptionflag</code>) value passed, the user task throws a different exception upon completion (the <code class="literal">onExit</code> script), which triggers the appropriate boundary error event.</p><div class="mediaobject"><img src="graphics/9578OS_05_09.jpg" alt="Boundary Error event"/></div><p>The process is started with a variable whose value affects the type of exception to be thrown:</p><div class="informalexample"><pre class="programlisting">Map&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();
// "1" for a runtime exception; "2" for a FileNotFoundException
String trigger = "1";
params.put("triggerexceptionflag", trigger);
ProcessInstance processInstance = ksession.startProcess("errorboundary", params);</pre></div><p>The user task's <code class="literal">onExit</code> script evaluates the process variable and throws the exception accordingly:</p><div class="informalexample"><pre class="programlisting">String trigger=(String)context.getVariable ("triggerexceptionflag");
if (trigger.equals ("1"))
{
throw new RuntimeException("a runtime exception");
}
else
{
throw new FileNotFoundException("a filenotfoundexception exception");
}</pre></div><p>The engine triggers<a id="id540" class="indexterm"/> the appropriate boundary error event depending on the exception thrown; the event, in fact, must be configured with the <code class="literal">errorCode</code> property set to the exception classname: <code class="literal">java.lang.RuntimeException</code> (see the following screenshot).</p><div class="mediaobject"><img src="graphics/9578OS_05_28.jpg" alt="Boundary Error event"/></div><p>Note that the<a id="id541" class="indexterm"/> boundary error can bind the exception to a process variable. In the example, this variable (<code class="literal">exceptionvar</code>) is logged to the console by the script task:</p><div class="informalexample"><pre class="programlisting">Throwable exc=(Throwable )context.getVariable ("exceptionvar");
System.out.println("log error message:"+exc.getMessage());</pre></div></div><div class="section" title="Error Start event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec63"/>Error Start event</h3></div></div></div><p>The Error Start event can only be used to trigger an Event Subprocess and cannot be used to start a<a id="id542" class="indexterm"/> process instance. This is a feature you could consider using when activating alternative subprocesses on error exceptions.</p></div><div class="section" title="Error End event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec64"/>Error End event</h3></div></div></div><p>When the process <a id="id543" class="indexterm"/>execution reaches an Error End event, the current path of execution is ended and an error event is thrown. This error is caught by a matching intermediate boundary Error event or a subprocess Start Error event. If no Error event is found, an exception is thrown.</p><p>The following example uses the Error End event to trigger a subprocess by its Error Start event.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.ErrorEndTest (method testSubprocessStartError)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">errorsubprocess.bpmn</pre></div><p>Description: The main<a id="id544" class="indexterm"/> process features a human task and an Error End event, which triggers an embedded subprocess Script task by an Error Start event.</p><div class="mediaobject"><img src="graphics/9578OS_05_10.jpg" alt="Error End event"/></div></div></div><div class="section" title="Compensation"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec88"/>Compensation</h2></div></div></div><p>Complex business<a id="id545" class="indexterm"/> processes may involve a number of heterogeneous parties and systems such as modern transactional systems, legacy systems (not transactional), and Web services. In order to <a id="id546" class="indexterm"/>preserve business consistency, when something fails and no transactional protocols are available, these systems may require you to perform programmatic corrective actions by invoking some dedicated API or by any other means. The compensation is the action of post-processing trying to remedy (not properly undoing or rolling-back) the effects produced by an action.</p><p>We want to stress the fact that jBPM compensations are not a transactional feature or a <code class="literal">try</code>/<code class="literal">catch</code> error mechanism. The compensation is a BPM business feature, which models an activity as the compensating counterpart for an already completed activity.</p><p>Here you have the common steps, which take place during a compensation event (see the following process example figure for a<a id="id547" class="indexterm"/> visual reference of the sequence).</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An activity (A1) whose boundary is attached to a compensation event (E1) is completed</li><li class="listitem" style="list-style-type: disc">A compensate event (E2) is thrown somewhere in the process</li><li class="listitem" style="list-style-type: disc">The compensate event (E1) catches E2</li><li class="listitem" style="list-style-type: disc">jBPM activates the compensation handler (A2), which is connected to E1</li></ul></div><p>The engine is ignorant of what the compensating activity will do since it is up to the developer to define the compensating business logic.</p><div class="section" title="Intermediate Compensation event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec65"/>Intermediate Compensation event</h3></div></div></div><p>The throwing Compensation event (E2) and the boundary Compensation event (E1) are implicitly connected by the same event name (we have already seen this with signals and messages). What we<a id="id548" class="indexterm"/> have explained for boundary events still applies here: when the Compensation event (E2) is triggered, the boundary Compensation event (E1) reacts by invoking the linked compensating activity (A2), which is marked with the typical compensation <span class="strong"><strong>FastBackward</strong></span>-like symbol.</p></div><div class="section" title="Boundary Compensation event"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec66"/>Boundary Compensation event</h3></div></div></div><p>The Compensation boundary event (E1) must reference one Compensation handler (A2) only through the direct <a id="id549" class="indexterm"/>association line. The Compensation boundary event is activated only when the activity (A1) has been completed (unlike the default boundary event behavior where the event is activated depending on the Activity start state). The Compensation catch event (E1) is removed after either the parent process instance completes or the Compensation event itself is triggered. If a Compensation boundary event is attached to a multiple-instance subprocess, a compensation event listener will be created for each instance. jBPM does not seem to support this last feature.</p></div><div class="section" title="Compensating activity"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec67"/>Compensating activity</h3></div></div></div><p>This activity (also called a compensation handler) is directly connected to the triggering boundary compensation <a id="id550" class="indexterm"/>event and must have no outgoing sequence flows.</p><p> Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.CompensationTest (method testCompensationEvent)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">compensateorder.bpmn</pre></div><p>Description: We used this example process to explain the typical compensation "workflow," so you should already be familiar with it. Let us just add that the Compensate event is thrown when the human task (<span class="strong"><strong>H1</strong></span>) is completed and the <code class="literal">cancelOrder</code> variable evaluates to "y." This activates the exclusive gateway sequence flow, which triggers the event (<span class="strong"><strong>E2</strong></span>). This activates the boundary Compensate event (<span class="strong"><strong>E1</strong></span>), which in turn calls the <span class="strong"><strong>cancel order</strong></span> script task (A2). The <span class="strong"><strong>cancel order</strong></span> task acts as a "compensating" activity.</p><div class="mediaobject"><img src="graphics/9578OS_05_11.jpg" alt="Compensating activity"/></div></div><div class="section" title="Triggering compensations with signals"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec68"/>Triggering compensations with signals</h3></div></div></div><p>jBPM offers additional ways to<a id="id551" class="indexterm"/> trigger compensations inside a process instance by using signals: general (implicit) and specific compensation handling. An <span class="strong"><strong>implicit</strong></span> compensation triggers all of the compensation handlers for the process instance:</p><div class="informalexample"><pre class="programlisting">ksession.signalEvent("Compensation",
  CompensationScope.IMPLICIT_COMPENSATION_PREFIX
    + "compensateorder", pi.getId());</pre></div><p>You must use the compensation signal type and pass the signal data a string that results from concatenating the <code class="literal">CompensationScope</code> class constant and the process definition ID resulting in the following:</p><div class="informalexample"><pre class="programlisting">"implicit:compensateorder"</pre></div><p>The <span class="strong"><strong>specific</strong></span> compensation triggers a specific compensation handler inside a process instance. You must pass the activity node ID attached to the boundary compensation event, along with the process instance ID:</p><div class="informalexample"><pre class="programlisting">ksession.signalEvent("Compensation", "_2", pi.getId());</pre></div><p>Our example<a id="id552" class="indexterm"/> process script task XML element follows:</p><div class="informalexample"><pre class="programlisting">&lt;bpmn2:scriptTask id="_2" name="prepare order" scriptFormat="http://www.java.com/java"&gt;</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip15"/>Tip</h3><p>No new signal event needs to be defined at the process definition level.</p></div></div><p>For working examples, please refer to the following:</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.CompensationTest (methods testGlobalCompensationWithSignal and testSpecificCompensationWithSignal respectively).</pre></div></div></div><div class="section" title="End Compensation event"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec89"/>End Compensation event</h2></div></div></div><p>The end compensation <a id="id553" class="indexterm"/>event works the same way as the intermediate<a id="id554" class="indexterm"/> one (please see the example process figure). A compensation end event is thrown (<span class="strong"><strong>E1</strong></span>), and the compensation<a id="id555" class="indexterm"/> handler triggered (<span class="strong"><strong>A1</strong></span>). This kind of event is useful when there is a need to perform housekeeping or remediation business logic at the end <a id="id556" class="indexterm"/>of a process, but only when your bounded activity (<span class="strong"><strong>S1</strong></span>) is in the COMPLETE state. Note in fact, as we already stressed, that the compensation handler kicks in only when the <span class="strong"><strong>subprocess</strong></span> (<span class="strong"><strong>S1</strong></span>) is already in the completed state.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.CompensationTest (method testSubprocessCompensationEndEvent)</pre></div><p>Example processes:</p><div class="informalexample"><pre class="programlisting">compensateendsubprocess.bpmn</pre></div><p>Description: The process has a <span class="strong"><strong>subprocess</strong></span> (<span class="strong"><strong>S1</strong></span>) with an attached boundary Compensate event (<span class="strong"><strong>E2</strong></span>). The subprocess triggers the throwing<a id="id557" class="indexterm"/> compensate end event (<span class="strong"><strong>E1</strong></span>). The Compensate<a id="id558" class="indexterm"/> boundary catch event (<span class="strong"><strong>E2</strong></span>) invokes the <a id="id559" class="indexterm"/>compensation handler (<span class="strong"><strong>A1</strong></span>), which rolls back the process variable to the initial value.</p><div class="mediaobject"><img src="graphics/9578OS_05_12.jpg" alt="End Compensation event"/></div><div class="section" title="Multi-instance compensation"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec69"/>Multi-instance compensation</h3></div></div></div><p>Compensation catching events <a id="id560" class="indexterm"/>attached to a multi-instance subprocess are not implemented. See the <span class="emphasis"><em>Subprocess</em></span> section for details<a id="id561" class="indexterm"/> about multi-instance activities.</p></div></div><div class="section" title="Escalation"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec90"/>Escalation</h2></div></div></div><p>Escalation, according to the<a id="id562" class="indexterm"/> common policies of an institution, organization, or corporate, refers to the existing relationships between the working personnel and their duties. The presence of an escalation event indicates that there is a condition that requires the business process flow to<a id="id563" class="indexterm"/> be diverted to a different user group. For instance, if an <a id="id564" class="indexterm"/>order above a certain price threshold is received, the approval task must be performed by a user in a higher role (for example, a manager); otherwise, it can also be approved by a clerk user.</p><p>In the case of jBPM 6.2.0, escalation events seem to be partially implemented and it is not clear what part of the BPMN specification is supported at this stage. You can partially overcome the lack of an escalation event with Deadlines and Notifications (see the <span class="emphasis"><em>User Task</em></span> section).</p></div><div class="section" title="Conditional events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec91"/>Conditional events</h2></div></div></div><p>Conditional events are a jBPM feature extension. They are triggered by an evaluation of user-provided expressions <a id="id565" class="indexterm"/>of Drools rules and facts properties. Conditional Start and Boundary events are supported.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.event.ConditionalTest (method testSubprocessStartError)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">conditional.bpmn</pre></div><p>Description: The main process is started when the Fact order note property matches "urgent"; the following script task <span class="strong"><strong>ordercost</strong></span> is cancelled if Order cost &gt; 100.</p><div class="mediaobject"><img src="graphics/9578OS_05_13.jpg" alt="Conditional events"/></div></div></div>
<div class="section" title="Activities"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Activities</h1></div></div></div><p>An activity is a <a id="id566" class="indexterm"/>unit of work that is executed within a business process; it can be atomic or non-atomic (Compound activity, Call activity, or Subprocess). Activities can be of the Task, Call activity, or Subprocess type.</p><div class="section" title="Task"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec92"/>Task</h2></div></div></div><p>A task is the smallest atomic<a id="id567" class="indexterm"/> activity unit that can be included within a process. Usually, the performer<a id="id568" class="indexterm"/> of the task can be an end user (called human) using a UI-based application, a participating external service, or a generic set of business statements. Tasks have their local scope and can accept input parameters from their container and return output parameters.</p><div class="section" title="User Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec70"/>User Task</h3></div></div></div><p>A user task is used to model work that needs to be done by a human actor. When the process execution <a id="id569" class="indexterm"/>arrives at the user task node, a new task instance is created in the work list of the actor(s) or group(s) defined for this task (the Actors and Groups properties). Human tasks can transition to several different states and involve human<a id="id570" class="indexterm"/> stakeholders depending on the action taken on the task itself and the defined human roles.</p><div class="section" title="Human roles"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec11"/>Human roles</h4></div></div></div><p>Human roles define what a person or a group of actors can do with tasks. Let us review the roles defined for the human<a id="id571" class="indexterm"/> task activities:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Task initiator</strong></span>: The person who creates the task instance. Depending on how the task has been created, the<a id="id572" class="indexterm"/> task initiator may not be defined.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Actual owner</strong></span>: The person <a id="id573" class="indexterm"/>who owns the task and is performing it. A task always has one actual owner.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Potential owners</strong></span>: Persons who<a id="id574" class="indexterm"/> are given a task so that they can claim and complete it. A potential owner can become the actual owner of a task by claiming it.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Excluded owners</strong></span>: Actors may not transition to be an actual or potential owner, and they may not reserve<a id="id575" class="indexterm"/> or start a task.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Business administrators</strong></span>: Business <a id="id576" class="indexterm"/>administrators are able to perform the same operations as task users since they are always potential owners of every task. jBPM provides a default business administrator user (Administrator) and group (Administrators).</li></ul></div></div><div class="section" title="State transitions"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec12"/>State transitions</h4></div></div></div><p>The task remains in the <span class="strong"><strong>Created</strong></span> state until it is activated. When the task has a single potential owner, it transitions<a id="id577" class="indexterm"/> into the <span class="strong"><strong>Reserved</strong></span> state (it is assigned to a single actual actor); otherwise, it transitions into the <span class="strong"><strong>Ready</strong></span> state; this state indicates that the task can be claimed by one of its potential owners. After being claimed, the task transitions into the <span class="strong"><strong>Reserved</strong></span> state, elevating the potential owner to the actual owner actor. At this point, the actor can start the task that is in either the <span class="strong"><strong>Ready</strong></span> or the <span class="strong"><strong>Reserved</strong></span> state and make it transition to the <span class="strong"><strong>InProgress</strong></span> state. The <span class="strong"><strong>InProgress</strong></span> state means that the task is being worked on. If the actor completes the work, the task transitions<a id="id578" class="indexterm"/> into the <span class="strong"><strong>Completed</strong></span> state. If the completion of the work goes wrong (exception), the task is put into the <span class="strong"><strong>Failed</strong></span> state. Alternatively, the user can release the task, bringing it back to the <span class="strong"><strong>Ready</strong></span> state. No transition is allowed from the <span class="strong"><strong>Complete</strong></span> state and the <span class="strong"><strong>Failed</strong></span> state.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note33"/>Note</h3><p>For detailed information on<a id="id579" class="indexterm"/> task state transitions, please refer to the Web Services – Human Task (WS-HumanTask) Specification by Oasis at <a class="ulink" href="http://docs.oasis-open.org">http://docs.oasis-open.org</a>.</p></div></div><div class="mediaobject"><img src="graphics/9578OS_05_21.jpg" alt="State transitions"/><div class="caption"><p>State transitions</p></div></div></div><div class="section" title="Deadlines and escalations"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec13"/>Deadlines and escalations</h4></div></div></div><p>The jBPM concept of a task deadline is bound to the task start-complete time interval duration; deadlines are associated with task escalations: the task escalation may exist in either a task reassignment or a task notification action. The task deadline is calculated on the task expiry date: it is reset when the task is started, and it expires when the task is completed over<a id="id580" class="indexterm"/> the allowed time boundary. Deadlines are physically stored in the <code class="literal">DEADLINE</code> table while notifications are stored in the <code class="literal">NOTIFICATION</code> set of tables.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note34"/>Note</h3><p>The Reassignment and Notifications property editor is available in the KIE Web process editor only.</p></div></div></div><div class="section" title="Task reassignment"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec14"/>Task reassignment</h4></div></div></div><p>Task reassignment is a jBPM mechanism that lets you change a task ownership by setting specific rules, which are based on the task state transition and a deadline time expression, for<a id="id581" class="indexterm"/> example: "if Luigi (a named task actor) does not start the task in 60 seconds then reassign the task instance to Mario." The nominated user is replaced by the new user as the potential owner for the task. The resulting reassignment rule syntax is as follows:</p><div class="informalexample"><pre class="programlisting">[users:mario|groups:]@[60s]@not-started</pre></div><p>You can define multiple reassignment rules on a single task instance.</p><p>Task event type conditions can be <code class="literal">not-started</code> and <code class="literal">not-completed</code>.</p><p>The BPMN XML task parameters are <code class="literal">NotStartedReassign</code> and <code class="literal">NotCompletedReassign</code>. The reassignment information is persisted by the engine into the <code class="literal">REASSIGNMENT</code> and <code class="literal">REASSIGNMENT_POTENTIALOWNERS</code> tables.</p><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.activity.TaskTest (testReassign method)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">reassign.bpmn</pre></div><p>Description: The main process is started, and the task is assigned to Luigi. The reassign rule states that "if Luigi (named task actor) does not start his task in 60 seconds then the task should be assigned to Mario."</p></div><div class="section" title="Notifications"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec15"/>Notifications</h4></div></div></div><p>A notification is the action of alerting someone (actor, group) when a task deadline expires. The default jBPM notification is e-mail based, and the default e-mail configuration is<a id="id582" class="indexterm"/> read from the <code class="literal">userinfo.properties</code> and <code class="literal">email.properties</code> files. The <code class="literal">userinfo.properties</code> file lists the user/group information in the following form:</p><div class="informalexample"><pre class="programlisting">entityId=email:locale:displayname:[member,member]</pre></div><p>e.g., for an entity of type actor, we have:</p><div class="informalexample"><pre class="programlisting">nino=nino@domain.com:en-UK:nino</pre></div><p>Member data is optional and is used for listing members belonging to a group organizational entity.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>Please refer to the official jBPM 6.2 documentation for the configuration details.</p></div></div><p>The BPMN XML task parameters are <code class="literal">NotStartedNotify</code> and <code class="literal">NotCompletedNotify.</code>
</p><p>An example <code class="literal">NotStartedNotify</code> parameter value follows:</p><div class="informalexample"><pre class="programlisting">from:mario|tousers:simo|togroups:|replyTo:|subject:warning|body:the task has not been started in 10s !@10s@not-started</pre></div></div><div class="section" title="Delegation"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec16"/>Delegation</h4></div></div></div><p>Delegation is the process of setting a task's potential owners. The actual owners, potential owners, or business administrators can delegate a task to another user, adding this user to the potential owners (if he/she isn't already) and making the user the task owner. A task can be<a id="id583" class="indexterm"/> delegated when it is in an active state (Ready, Reserved, or InProgress) and transitioned into the Reserved state, and its <code class="literal">skippable</code> property can be flagged to <code class="literal">true</code> (the target actor/owner can skip the task). The task's state and parameters will not change after delegation.</p></div><div class="section" title="Forward"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec17"/>Forward</h4></div></div></div><p>Task forwarding is the<a id="id584" class="indexterm"/> process performed by a potential owner on an active task who replaces himself in the potential owner list, passing the task to another person. The potential owner can only forward tasks when in the Ready state. If the task is in the Reserved or InProgress state, the task is transitioned to the Ready<a id="id585" class="indexterm"/> state again.</p></div><div class="section" title="Suspend/resume"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec18"/>Suspend/resume</h4></div></div></div><p>A task can be suspended in any of its active states (Ready, Reserved, or InProgress), transitioning it into the Suspended state. The Suspended state has sub-states to indicate the original state<a id="id586" class="indexterm"/> of the task. When resumed, the task transitions back to the original state from which it had been suspended.</p></div><div class="section" title="Skip"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec19"/>Skip</h4></div></div></div><p>A stakeholder <a id="id587" class="indexterm"/>working on a human task or a business administrator may decide that a task is no longer needed and hence, skip this task. This makes the task transition into the Obsolete state. The task can only be skipped if this capability is specified during the task configuration (the <code class="literal">skippable</code> property).</p><p>For delegate, forward and skip, and suspend/resume examples have a look at a test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.TaskTest (methods testDelegateReadyStateAndSkip, testForwardAndSkip, testSuspendAndResume)</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">delegate_forward.bpmn</pre></div><p>Description: The <a id="id588" class="indexterm"/>main process is started, and a human task is reserved to Luigi. The test methods check for task delegation, forwarding, and suspend/resume.</p></div><div class="section" title="Release"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec20"/>Release</h4></div></div></div><p>A task may be released by the current owner as a human task, making it available for other potential owners. From active states that have an actual owner (Reserved or InProgress), a task can<a id="id589" class="indexterm"/> be released and transitioned into the Ready state. Task data associated with the task is kept unchanged.</p><p>If a task is currently InProgress, it can be stopped by the actual owner, transitioning it into the Reserved state. Business data associated with the task as well as its actual owner is kept unchanged.</p></div></div><div class="section" title="Script Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec71"/>Script Task</h3></div></div></div><p>A Script task is an automatic activity. When a process execution arrives at the Script task, the corresponding script is <a id="id590" class="indexterm"/>executed. All process variables that are accessible through the execution context (the <code class="literal">kcontext</code> variable) can be referenced within the script. It has the following properties:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It is executed by the<a id="id591" class="indexterm"/> business process engine</li><li class="listitem" style="list-style-type: disc">The script is defined in a language supported by the engine (Java or MVEL)</li><li class="listitem" style="list-style-type: disc">The script task execution is always immediate</li><li class="listitem" style="list-style-type: disc">The script<a id="id592" class="indexterm"/> task transitions to the complete state after the script execution</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>For a complete<a id="id593" class="indexterm"/> MVEL reference, please visit <a class="ulink" href="http://mvel.codehaus.org/">http://mvel.codehaus.org/</a>.</p></div></div><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.activity.ScriptTaskTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">script.bpmn</pre></div><p>Description: The process script activity updates the process variable <code class="literal">order</code> description property:</p><div class="informalexample"><pre class="programlisting">Order order=(Order)kcontext.getVariable ("order");
order.setNote ("order modified");</pre></div></div><div class="section" title="Service Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec72"/>Service Task</h3></div></div></div><p>The service task indicates the work that is to be automatically performed by a service provider. Usually, all work that<a id="id594" class="indexterm"/> has to be executed outside the engine should be designed as a service task. jBPM supports two types of service task implementations: plain Java class<a id="id595" class="indexterm"/> and Web service. The service task is backed by a WorkItemHandler implementation (<code class="literal">org.jbpm.process.workitem.bpmn2.ServiceTaskHandler</code>) registered with the name <span class="strong"><strong>Service Task</strong></span>.</p><p>The parameters are<a id="id596" class="indexterm"/> as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Interface</code>: Java class name or WSDL WebService service interface</li><li class="listitem" style="list-style-type: disc"><code class="literal">Operation</code>: Java method name or WSDL WebService operation</li><li class="listitem" style="list-style-type: disc"><code class="literal">Parameter</code>: Method name (to invoke)</li><li class="listitem" style="list-style-type: disc"><code class="literal">ParameterType</code>: Method (to invoke) parameter<a id="id597" class="indexterm"/> type (only 1 parameter supported)</li><li class="listitem" style="list-style-type: disc"><code class="literal">Mode</code> (WS only): <code class="literal">SYNC</code> (default), <code class="literal">ASYNC</code>, or <code class="literal">ONEWAY</code></li></ul></div><p>In case of a <a id="id598" class="indexterm"/>service task of type Java, jBPM uses Java reflection to load the Java class type (by using an <code class="literal">Interface</code> parameter), instantiate it, and invoke the specified method (searched by <code class="literal">Operation</code> and <code class="literal">ParameterType</code>) with the value provided by <code class="literal">Parameter</code>. Only method signatures with a single parameter are supported, and the result of the invoked method is mapped in the activity <code class="literal">Results</code> output parameter.</p><p>The <code class="literal">Mode</code> parameter applies to <a id="id599" class="indexterm"/>a Web service only and describes the way a request has to be performed:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Synchronous (SYNC)</strong></span>: Sends<a id="id600" class="indexterm"/> a request and waits for a response before continuing</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Asynchronous (ASYNC)</strong></span>: Sends<a id="id601" class="indexterm"/> a request and uses callback to get a response</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Oneway</strong></span>: Sends request<a id="id602" class="indexterm"/> without blocking (ignore response)</li></ul></div><p>The Web service runtime leverages the "dynamic clients" features of the Apache CXF framework in order to generate Java classes at runtime.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>Please visit <a class="ulink" href="http://cxf.apache.org/docs/dynamic-clients.html">http://cxf.apache.org/docs/dynamic-clients.html</a> for the<a id="id603" class="indexterm"/> official reference documentation.</p></div></div><p>A Service task can be really useful for rapid prototyping, but when it comes to complex external service integration, it falls short in meeting common development needs: multiple parameter passing, additional Web service configuration, and so on.</p><p>The following example demonstrates how to override the standard jBPM service task component by adding a custom workItem handler. Note, however, that the input/output parameters of the custom service task handler cannot be changed from the process designer because the task interface is defined in the configuration files of the jBPM workItem handlers.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>WorkItem handlers are thoroughly explained in <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span>.</p></div></div><p>Example test class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.test.ServiceTaskTest</pre></div><p>Example process:</p><div class="informalexample"><pre class="programlisting">servicetask.bpmn</pre></div><p>Description: The first test (<code class="literal">testJavaServiceTask</code>) launches the process with a standard Java Service task (Interface: <code class="literal">ServiceJavaTask</code>, Operation: <code class="literal">processOrder</code>, Parameter: <code class="literal">order</code>, ParameterType: <code class="literal">Order</code>). The Service task changes the note field of the order and returns it to the main process whose script activity traces the change to the console. The <a id="id604" class="indexterm"/>second test (<code class="literal">testJavaCustomServiceTask</code>) features a custom<a id="id605" class="indexterm"/> Service task handler (<code class="literal">PacktServiceTaskHandler</code>) that overrides the default handler and processes the order parameter, setting its <code class="literal">note</code> property with a specific value.</p></div><div class="section" title="Rule Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec73"/>Rule Task</h3></div></div></div><p>The (Business) Rule tasks let us execute rules and get output from the embedded rule engine (Drools). Remember that <a id="id606" class="indexterm"/>process variables can be shared with the Rule tasks by using global variables or Drools session facts.</p><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.RuleTaskTest</pre></div><p>Example knowledge artifacts:</p><div class="informalexample"><pre class="programlisting">rule.bpmn, rule.drl</pre></div><p>Description: The main process is started, and the rule task triggers when the order cost is &gt;100, and as a result, it changes the order's <code class="literal">note</code> property to <code class="literal">URGENT</code>. Look at the <code class="literal">rule.drl</code> file:</p><div class="informalexample"><pre class="programlisting">global StringBuffer newnote;
global com.packt.masterjbpm6.pizza.model.Order orderglobal;

rule "checkorder" ruleflow-group "masterRuleGroup"
    when
        $o: com.packt.masterjbpm6.pizza.model.Order (cost&gt;100)
    then
    {
      System.out.println ("checkorder triggered");
      String desc="big order ! (cost="+$o.getCost()+")";
      orderglobal.setNote("URGENT");
      newnote.append (desc);
    }
End</pre></div><p>The <code class="literal">order</code> variable (with <code class="literal">cost &gt; 100</code>) is inserted into the knowledge session to activate the<a id="id607" class="indexterm"/> rule that triggers when <code class="literal">Order (cost &gt; 100)</code>; see the <code class="literal">RuleTaskTest.testRule()</code> method:</p><div class="informalexample"><pre class="programlisting">ksession.insert(order);</pre></div><p>While the shared <code class="literal">orderglobal</code> variable is used to get the result back:</p><div class="informalexample"><pre class="programlisting">ksession.setGlobal("orderglobal", order);</pre></div></div><div class="section" title="Send/Receive Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec74"/>Send/Receive Task</h3></div></div></div><p>Send/Receive tasks are<a id="id608" class="indexterm"/> general-purpose messaging tasks since they do not provide a default implementation. They are handled as workItem and it is up to the implementer to back them with a working implementation through the <code class="literal">WorkItemHandler</code> interface, registering it with the jBPM <code class="literal">WorkItemManager</code>.</p><p>The workItem name of the receive task must be <span class="strong"><strong>Receive Task</strong></span>. <span class="strong"><strong>Receive Task</strong></span> refers to the message ID through the <code class="literal">messageRef</code> attribute; the handler receives the message ID value with the <code class="literal">MessageId</code> parameter.</p><p>The workItem name of the send task must be<a id="id609" class="indexterm"/> <span class="strong"><strong>Send Task</strong></span>. <span class="strong"><strong>Send Task</strong></span> refers to the message ID through the <code class="literal">messageRef</code> attribute; for additional reference, check the Intermediate Message event.</p><div class="mediaobject"><img src="graphics/9578OS_05_17.jpg" alt="Send/Receive Task"/></div><p>Example class</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.TaskTest (method testSendReceive)</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">send_receive.bpmn</pre></div><p>Description: The subprocess send task passes data to the receive task of the parent process. The test<a id="id610" class="indexterm"/> registers two custom workItem handlers, and the Send task and the Receive task share a message by using a global process variable.</p></div><div class="section" title="Manual Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec75"/>Manual Task</h3></div></div></div><p>A manual task defines a task that is to be performed externally to the engine. It is used to model work that is<a id="id611" class="indexterm"/> done by a stakeholder without interacting with the system; the engine does not know anything about the task, and it does not need to. There is no UI interface or system available for the manual task completion. For the engine, a manual task is managed as a passthrough activity. It continues the process from the moment process execution arrives into it.</p></div><div class="section" title="Ad hoc (Custom or None) Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec76"/>Ad hoc (Custom or None) Task</h3></div></div></div><p>The custom task is <a id="id612" class="indexterm"/>an empty, generic, unspecialized unit of work. The implementer is requested to provide a <a id="id613" class="indexterm"/>WorkItemHandler implementation for the task and register it with WorkItemManager</p><div class="informalexample"><pre class="programlisting">Void registerWorkItemHandler(String workItemName, WorkItemHandler handler);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note39"/>Note</h3><p>See <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span> for detailed sections on the WorkItemHandler architecture.</p></div></div><p>The handler is registered for all workItems of the given workItemName and is called every time the process activates a node with that name. Further, workItemName must match the <code class="literal">taskname</code> attribute of the task element. WorkItemHandler is responsible for completing or<a id="id614" class="indexterm"/> aborting the<a id="id615" class="indexterm"/> task instance.</p><p>See the <span class="emphasis"><em>Conditional</em></span> events section for a working example.</p><div class="section" title="Async tasks"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec21"/>Async tasks</h4></div></div></div><p>We are now going to take a closer look at some peculiar usage of the custom task. In <a class="link" href="ch04.html" title="Chapter 4. Operation Management">Chapter 4</a>, <span class="emphasis"><em>Operation Management</em></span> we introduced the new jBPM executor service and the job scheduling features of the KIE console. The custom task can be conveniently configured to instruct the executor to call service-oriented components in an asynchronous fashion<a id="id616" class="indexterm"/> by scheduling an execution job in the background. The jBPM handler responsible for the job submission is <code class="literal">org.jbpm.executor.impl.wih.AsyncWorkItemHandler</code> (more on this in <a class="link" href="ch07.html" title="Chapter 7. Customizing and Extending jBPM">Chapter 7</a>, <span class="emphasis"><em>Customizing and Extending jBPM</em></span>).</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip16"/>Tip</h3><p>The jBPM process designer gives you the ability to toggle a <code class="literal">wait-for-completion</code> flag on the workitem handler node. This flag does not reflect the sync/async nature of the handler invocation. It does tell the engine to evaluate (by an event listener) the handler results and map them back to the process context variables, using the task output mapping. If the flag is set to false, the custom task results will be ignored.</p></div></div><p>We can configure an async task by doing the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Specifying <code class="literal">async</code> as the task <code class="literal">taskName</code> property</li><li class="listitem" style="list-style-type: disc">Adding a data input parameter called <code class="literal">CommandClass</code>, and assigning a fully qualified Java class name to the schedule</li><li class="listitem" style="list-style-type: disc">(Optional) adding a data<a id="id617" class="indexterm"/> input parameter called <code class="literal">Retries</code>, which tells the executor how many times the execution should be retried (default = 3)</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note40"/>Note</h3><p>
<a class="link" href="ch04.html" title="Chapter 4. Operation Management">Chapter 4</a>, <span class="emphasis"><em>Managing Jobs and Asynchronous Command Execution</em></span> explains in detail how to write <code class="literal">Command</code> classes.</p></div></div><p>The example that we discuss sets our <code class="literal">AsyncTaskCommand</code> as <code class="literal">CommandClass</code>, starts the executor <a id="id618" class="indexterm"/>service, and registers AyncWorkItemHandler.</p><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.AsyncTaskTest</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">asynctaskprocess.bpmn</pre></div></div></div></div><div class="section" title="Call Activity Task"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec93"/>Call Activity Task</h2></div></div></div><p>The call activity<a id="id619" class="indexterm"/> task is a general-purpose means to reuse existing, externally defined business constructs (process) simply by specifying their ID (the <code class="literal">calledElement</code> attribute of <code class="literal">bpmn2:callActivity</code>) or <code class="literal">Name</code> (<code class="literal">calledElementByName</code>). The execution of the called element can be synchronous/asynchronous (<code class="literal">waitForCompletion=true</code>) or independent (<code class="literal">independent=true</code>). You can set <code class="literal">independent</code> to false only if <code class="literal">waitForCompletion</code> is <code class="literal">true</code>.</p><p>All these properties are easily set, as usual, through both the jBPM Eclipse plugin or the KIE process editor; we extract from the process definition, for reference purposes, the relevant XML for the <code class="literal">callActivity</code> construct:</p><div class="informalexample"><pre class="programlisting">&lt;bpmn2:callActivity drools:waitForCompletion="true" drools:independent="true" name="CallActivity" calledElement="callactivitySubprocess"&gt;</pre></div><p>The following figure shows the main process on the left and the callactivitySub1 process "zoomed out" from the CallActivity node:</p><div class="mediaobject"><img src="graphics/9578OS_05_26.jpg" alt="Call Activity Task"/></div><p>The callee construct supports, like other activity nodes (tasks), data input and output mappings from/to the caller process, as we are going to see in the following example.</p><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.CallactivityTaskTest (testIndependentSubprocess method)</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">callactivity.bpmn (parent process), callactivitySub1.bpmn (subprocess called by the <span class="strong"><strong>callActivity</strong></span> construct)</pre></div><p>Description: The main process is started and <code class="literal">callActivity</code> is executed; the main process passes the process order variable to <code class="literal">callActivity</code>. The <code class="literal">callActivity</code> subprocess modifies the<a id="id620" class="indexterm"/> order variable and returns it to the calling process definition.</p><p>As a side note, if we examine the <code class="literal">PROCESSINSTANCELOG</code> table, we can see the two instances of the processes (the main and the called process) logged; their parentship relation is saved through the <span class="strong"><strong>PARENTPROCESSINSTACEID</strong></span> column; it shows that <span class="strong"><strong>callactivitySubprocess</strong></span> is a child process of the <span class="strong"><strong>callactivityprocess</strong></span>. This is the output when callActivity has the <code class="literal">independent=true</code> and <code class="literal">waitforcompletion=true</code> properties set.</p><div class="mediaobject"><img src="graphics/9578OS_05_14.jpg" alt="Call Activity Task"/></div><p>Let us look at another example and see how the independent property affects the called subprocess.</p><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.CallactivityTaskTest (method testAbortProcess)</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">callactivityabort.bpmn (parent process), callactivitysubprocessabort.bpmn (subprocess called by the call activity construct)</pre></div><p>Description: The <code class="literal">callactivityabort</code> process is started, and callActivity (with <code class="literal">independent=false</code>) is executed. The subprocess referenced by callActivity (<code class="literal">callactivitysubprocessabort</code>) has a human task, so it stops for user interaction. This gives us the time to issue (see the test class code) <code class="literal">abortProcessInstance</code> on the parent process. The<a id="id621" class="indexterm"/> <code class="literal">independent</code> flag set to <code class="literal">FALSE</code> forces callActivity (that is, the waiting subprocess) to abort contextually to the main process instance; when the flag is set to <code class="literal">TRUE</code>, the callActivity is not affected (see previous example).</p><p>This is the output when aborting the parent process instance, which has callActivity with the <code class="literal">independent=false</code> property set. Note also that <code class="literal">status = 3</code> (ABORTED) for both process instances.</p><div class="mediaobject"><img src="graphics/9578OS_05_16.jpg" alt="Call Activity Task"/></div></div><div class="section" title="Subprocess"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec94"/>Subprocess</h2></div></div></div><p>A subprocess, as the name suggests, is a process that is included within another process. It can contain activities, events, gateways, and so on, which form a <span class="strong"><strong>boxed</strong></span> process that is part of the enclosing<a id="id622" class="indexterm"/> process. The subprocess can be completely defined inside a parent process (an embedded subprocess) or can be linked through a CallActivity element by its ID or Name property. You can link a subprocess (by callActivity) across different multiple process definitions, reusing common groups of process elements (activities, gateways, and so on). The embedded subprocess construct can have multi-instance<a id="id623" class="indexterm"/> capabilities (see the MultiInstance section). However, using a<a id="id624" class="indexterm"/> subprocess does impose the following constraints:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Sequence flow cannot cross subprocess boundaries</li><li class="listitem" style="list-style-type: disc">Process variables must be mapped for input and/or output</li></ul></div><p>At the designer level, a subprocess can be expanded or collapsed so as to hide or show its details.</p><div class="section" title="Ad hoc subprocess"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec77"/>Ad hoc subprocess</h3></div></div></div><p>Ad hoc subprocesses are<a id="id625" class="indexterm"/> commonly used when a number of tasks can be selected and performed in any order (because unspecified or unknown), and there is no execution dependency between them. Tasks might have unknown dependencies, most often because they are dynamic and managed by a human user on a case-by-case basis. The subprocess can complete even if some of the tasks are not executed at all. An ad hoc subprocess is represented as a subprocess with a tilde (˜) marker at the base.</p><div class="mediaobject"><img src="graphics/9578OS_05_15.jpg" alt="Ad hoc subprocess"/></div><p>The jBPM ad hoc subprocess implementation seems to be fairly incomplete. There seem to be some issues when exiting from the subprocess instance. The user is able to start the ad <a id="id626" class="indexterm"/>hoc subprocess activities by using the <code class="literal">signal</code> method by referencing the activity name:</p><div class="informalexample"><pre class="programlisting">ksession.signalEvent("report1", null, processInstance.getId());</pre></div><p>Because of their nature, ad hoc subprocesses are hard to design and of little use in real structured business processes; nevertheless, here, we provide you with an example that you can tweak and experiment with:</p><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.AdHocSubprocessTest</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">adhocsubprocess.bpmn</pre></div><p>Description: The ad hoc subprocess has 2 script activities and 1 human task. The script tasks are signaled, and the human task is completed.</p></div></div><div class="section" title="Multiple instances"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec95"/>Multiple instances</h2></div></div></div><p>This construct can be used to create multiple instances of a reusable subprocess definition as well as <a id="id627" class="indexterm"/>an embedded subprocess. Passing an input parameter collection works as the instantiation loop. jBPM will create one instance of the looping process for each element in the collection. The following figure shows the process with the embedded multi-instance subprocess (<span class="strong"><strong>Log pizzas</strong></span>, the parallel symbol denotes that it is a multi-instance process) and the subprocess attributes. The loop input is the process variable <code class="literal">list</code> and the loop instance parameter (the collection item) is <code class="literal">item</code> of type <code class="literal">Pizza</code>. The <code class="literal">item</code> variable is visible in the instantiated subprocess scope.</p><div class="mediaobject"><img src="graphics/9578OS_05_27.jpg" alt="Multiple instances"/></div><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.MultiInstanceTest</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">multiinstance.bpmn</pre></div><p>Description: The process is created by passing a variable <code class="literal">list</code> of pizzas:</p><div class="informalexample"><pre class="programlisting">List&lt;Pizza&gt; myList = new ArrayList&lt;Pizza&gt;();
myList.add(new Pizza(PizzaType.getType(Types.MARGHERITA), "margherita"));
myList.add(new Pizza(PizzaType.getType(Types.NAPOLI), "assorreta!"));
params.put("list", myList);
ProcessInstance processInstance = ksession.startProcess("multiinstance", params);</pre></div><p>Subsequently, two subprocess instances are created, and each is passed the loop <code class="literal">item</code> variable (a <code class="literal">Pizza</code> instance). The subprocess script activity simply prints the pizza description, and the subprocess exits.</p><div class="informalexample"><pre class="programlisting">System.out.println("pizza desc " + item.getDesc());</pre></div></div><div class="section" title="Lanes"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec96"/>Lanes</h2></div></div></div><p>A lane is a partitioning box-shaped element used to group activities within the process definition. Lanes can be used to visually point out different group task assignments. For example, you can<a id="id628" class="indexterm"/> think of a lane as a company department (IT, business administration, and so on) where all employees have (more or less) the same duties. jBPM will try to assign (making a task reserved for the user) all tasks within the same lane to the<a id="id629" class="indexterm"/> same user. For example, if there are several tasks on a lane, the user who claimed and completed the first task will be assigned to the other tasks on the lane. Usually, it is convenient to assign the same group ID to all the tasks in the same lane.</p><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.LaneTest</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">lane.bpmn</pre></div><p>Description: The <span class="strong"><strong>task1</strong></span> and <span class="strong"><strong>task2</strong></span> (on <span class="strong"><strong>lane</strong></span>) activities are assigned to the <code class="literal">pizzerianapoli</code> group, while <span class="strong"><strong>Mario's Task</strong></span> is assigned to the actor Mario. <span class="strong"><strong>taskNotInLane</strong></span> is also assigned to <code class="literal">pizzerianapoli</code> but it's not on <span class="strong"><strong>lane</strong></span>.</p><div class="mediaobject"><img src="graphics/9578OS_05_18.jpg" alt="Lanes"/></div><p>After the process is started, the actor Luigi (belonging to the <code class="literal">pizzerianapoli</code> group; see the <code class="literal">LaneUserCallBack</code> class) has 2 tasks on the list (<span class="strong"><strong>task1</strong></span> and <span class="strong"><strong>taskNotInLane</strong></span>). After he completes task1, he is automatically given the task2 activity (status = <span class="strong"><strong>Reserved</strong></span>), while the <span class="strong"><strong>taskNotInLane</strong></span> status remains unchanged (<span class="strong"><strong>Ready</strong></span>).</p><div class="mediaobject"><img src="graphics/9578OS_05_19.jpg" alt="Lanes"/></div></div><div class="section" title="Data objects"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec97"/>Data objects</h2></div></div></div><p>Data objects are BPMN constructs that represent how data is required or produced by an activity. Data objects<a id="id630" class="indexterm"/> can have a direct association to one or more activity<a id="id631" class="indexterm"/> providing the input or the target output for that activity.</p><div class="mediaobject"><img src="graphics/9578OS_05_20.jpg" alt="Data objects"/></div><p>Example class:</p><div class="informalexample"><pre class="programlisting">com.packt.masterjbpm6.task.DataObjectTest</pre></div><p>Example process artifacts:</p><div class="informalexample"><pre class="programlisting">data-object.bpmn</pre></div><p>Description: The task1 and task2 activities share the same data object (pizza class type); the first task produces the pizza, which then serves as the input of the second task.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Summary</h1></div></div></div><p>In this chapter, we examined the jBPM BPMN constructs, providing hands-on working examples, tips, and, whenever possible, some details regarding the jBPM internal mechanisms. The chapter is not meant to be a BPMN tutorial or a BPMN best practices modeling guide for which we suggest picking more suitable books and a lot of real-world practice. In the next chapter, we will cover the jBPM subsystems API with several practical examples: the new Kie API, the runtime engine, the human task service, and the persistence engine.</p></div></body></html>