<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Networking</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Making an HTTP GET request</li>
<li>Making an HTTP POST request</li>
<li>Making an HTTP request for a protected resource</li>
<li>Making an asynchronous HTTP request</li>
<li>Making an HTTP request using Apache HttpClient</li>
<li>Making an HTTP request using the Unirest HTTP client library</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>Java's support for interacting with HTTP-specific features has been very primitive. The <kbd>HttpURLConnection</kbd> class, available since JDK 1.1, provides APIs for interacting with URLs with HTTP-specific features. <span>Since this API has been there even before HTTP/1.1, it lacked advanced features and was a pain to use. This is why developers mostly resorted to using third-party libraries,</span> such as <strong>Apache HttpClient</strong>, Spring frameworks, HTTP APIs, and so on. </p>
<p class="mce-root">In JDK 9, a new HTTP client API is being introduced under JEP 110 (<a href="http://openjdk.java.net/jeps/110">http://openjdk.java.net/jeps/110</a>). Unfortunately, this API is being introduced as an incubator module (<a href="http://openjdk.java.net/jeps/11">http://openjdk.java.net/jeps/11</a>). An incubator module contains non-final APIs, which are significantly larger and not mature completely to be included in Java SE. This is a form of beta release of the API so that the developers get to use the APIs much earlier. But the catch here is that there is no backward compatibility support for these APIs in the newer versions of JDK. This means that code that is dependent on the incubator modules might break with the newer versions of JDK. This might be due to the incubator module being promoted to Java SE or being silently dropped from the incubator modules.</p>
<p>In any case, it will be good to know about the HTTP client APIs, which might come into future JDK releases. In addition to this, it is good to know about the alternatives we have for now. So, in this chapter, we will cover a few recipes showing how to use the HTTP client APIs in the JDK 9 incubator modules, and then a few other APIs, which make use of the Apache HttpClient (<a href="http://hc.apache.org/httpcomponents-client-ga/">http://hc.apache.org/httpcomponents-client-ga/</a>) API and the Unirest Java HTTP library (<a href="http://unirest.io/java.html">http://unirest.io/java.html</a>).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making an HTTP GET request</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will look at using the JDK 9 HTTP Client API to make a <kbd>GET</kbd> request to the URL, <a href="http://httpbin.org/get">http://httpbin.org/get</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Create an instance of <kbd>jdk.incubator.http.HttpClient</kbd> using its builder, <kbd><span>jdk.incubator.http.HttpClient.Builder</span></kbd><span>:</span></li>
</ol>
<pre>        HttpClient<span> client </span><span>=</span><span> </span><span>HttpClient</span>.newBuilder().build();</pre>
<ol start="2">
<li>Create an instance of <span><kbd>jdk.incubator.http.HttpRequest</kbd> using its builder, <kbd>jdk.incubator.http.HttpRequest.Builder</kbd>. The requested URL should be provided as an instance of <kbd>java.net.URI</kbd>:</span></li>
</ol>
<pre>        HttpRequest<span> request </span><span>=</span><span> </span><span>HttpRequest<br/></span>                    .newBuilder(<span>new</span><span> </span><span>URI</span><span>(</span><span>"http://httpbin.org/get"</span><span>))<br/></span><span>                    .</span><span>GET()<br/></span>                    .version(<span>HttpClient</span><span>.</span><span>Version</span><span>.</span><span>HTTP_1_1)<br/></span>                    .build();</pre>
<ol start="3">
<li>Send the HTTP request using the <span><kbd>send</kbd> API of </span><span><kbd>jdk.incubator.http.HttpClient</kbd>. This API takes an instance of <kbd>jdk.incubator.http.HttpRequest</kbd> and an implementation of <kbd>jdk.incubator.http.HttpResponse.BodyHandler</kbd>:</span></li>
</ol>
<pre>        HttpResponse&lt;String&gt;<span> response </span><span>=</span><span> client</span><span>.</span><span>send(request,<br/></span>                             HttpResponse<span>.</span><span>BodyHandler</span><span>.</span><span>asString());</span></pre>
<ol start="4">
<li>Print the <kbd>jdk.incubator.http.HttpResponse</kbd> status code and the response body:</li>
</ol>
<pre>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Status code: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>statusCode());<br/></span>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Response Body: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>body());</span></pre>
<p>The complete code for this can be found at the location <kbd>chp11/1_making_http_get</kbd>. You can make use of the run scripts, <kbd>run.bat</kbd> or <kbd>run.sh</kbd>, to compile and run the code:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img height="181" width="361" class="image-border" src="assets/c91cf236-8baf-4f9d-8dbd-904553558ef6.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>There are two main steps in making an HTTP call to a URL:</p>
<ol>
<li>Creating an HTTP client to initiate the call.</li>
<li>Setting up the destination URL, required HTTP headers, and the HTTP method type, that is, <kbd>GET</kbd>, <kbd>POST</kbd>, or <kbd>PUT</kbd>.</li>
</ol>
<p>The Java HTTP Client API provides a builder class, <kbd>jdk.incubator.http.HttpClient.Builder</kbd>, which can be used to build an instance of <kbd>jdk.incubator.http.HttpClient</kbd> at the same time, making use of the builder APIs to set up <kbd><span>jdk.incubator.http.HttpClient</span></kbd>. The following code snippet shows how to get an instance of <kbd>jdk.incubator.http.HttpClient</kbd> with the default configuration:</p>
<pre>HttpClient client = HttpClient.newHttpClient();</pre>
<p>The following code snippet uses the builder to configure and then create an instance of <kbd>jdk.incubator.http.HttpClient</kbd>:</p>
<pre>HttpClient client = HttpClient<br/>                    .newBuilder()<br/>                    //redirect policy for the client. Default is NEVER<br/>                    .followRedirects(HttpClient.Redirect.ALWAYS) <br/>                    //HTTP client version. Defabult is HTTP_2<br/>                    .version(HttpClient.Version.HTTP_1_1)<br/>                    //few more APIs for more configuration<br/>                    .build();</pre>
<p>There are more APIs in the builder, such as setting authentication, proxy, and providing SSL context, which we will look at in different recipes.</p>
<p>Setting up the destination URL is nothing but creating an instance of <kbd>jdk.incbator.http.HttpRequest</kbd> using its builder and its APIs to configure the same<span>. The following code snippet shows how to create an instance of <kbd>jdk.incbator.http.HttpRequest</kbd>:</span></p>
<pre>HttpRequest request = HttpRequest<br/>                .newBuilder()<br/>                .uri(new URI("http://httpbin.org/get")<br/>                .headers("Header 1", "Value 1", "Header 2", "Value 2")<br/>                .timeout(Duration.ofMinutes(5))<br/>                .version(HttpClient.Version.HTTP_1_1)<br/>                .GET()<br/>                .build();</pre>
<p>The <kbd>jdk.incubator.http.HttpClient</kbd> object provides two APIs to make an HTTP call:</p>
<ul>
<li>Send synchronously using the <kbd>HttpClient#send()</kbd> method</li>
<li>Send asynchronously using the <kbd>HttpClient#sendAsync()</kbd> method</li>
</ul>
<p>The <kbd>send()</kbd> method takes in two parameters: the HTTP request and the handler for the HTTP response. The handler for the response is represented by the implementation of the <kbd>jdk.incubator.http.HttpResponse.BodyHandler</kbd> interface. There are a few implementations available, such as <kbd>asString()</kbd>, which reads the response body as <kbd>String</kbd>, <kbd>asByteArray()</kbd>, which reads the response body as a byte array, and so on. We will use the <kbd>asString()</kbd> method, which returns the response <kbd>Body</kbd> as a string:</p>
<pre>HttpResponse&lt;String&gt; response = client.send(request,<br/>                                HttpResponse.BodyHandler.asString());</pre>
<p>The instance of  <kbd>jdk.incubator.http.HttpResponse</kbd> represents the response from the HTTP server. It provides APIs for the following:</p>
<ul>
<li>Getting the response body (<kbd>body()</kbd>)</li>
<li>HTTP headers (<kbd>headers()</kbd>)</li>
<li>The initial HTTP request (<kbd>request()</kbd>)</li>
<li>The response status code (<kbd>statusCode()</kbd>)</li>
<li>The URL used for the request (<kbd>uri()</kbd>)</li>
</ul>
<p>The <kbd>HttpResponse.BodyHandler</kbd> implementation passed to the <kbd>send()</kbd> method helps in converting the HTTP response into a compatible format, such as <kbd>String</kbd><span><span>, a </span></span><kbd>byte</kbd> array, and so on.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making an HTTP POST request</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will look at posting some data to an HTTP service via the request body. We will post the data to a URL: <kbd>http://httpbin.org/post</kbd>.</p>
<div class="packt_infobox">We will skip the package prefix for the classes, as it is assumed to be <kbd>jdk.incubator.http</kbd>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Create an instance of <kbd>HttpClient</kbd> using its <kbd>HttpClient.Builder</kbd> builder:</li>
</ol>
<pre>        HttpClient<span> client </span><span>=</span><span> </span><span>HttpClient</span>.newBuilder().build();</pre>
<ol start="2">
<li>Create the required data to be passed into the request body:</li>
</ol>
<pre>        Map&lt;String, String&gt;<span> requestBody </span><span>=</span><span> <br/></span><span>                    Map</span><span>.</span><span>of(</span><span>"key1"</span><span>, </span><span>"value1"</span><span>, </span><span>"key2"</span><span>, </span><span>"value2"</span><span>);</span></pre>
<ol start="3">
<li>Create a <kbd>HttpRequest</kbd> object with the request method as POST and by providing the request body data as <kbd>String</kbd>. We make use of Jackson's <kbd>ObjectMapper</kbd> to convert the request body, <kbd>Map&lt;String, String&gt;</kbd>, into a plain JSON <kbd>String</kbd> and then make use of <kbd>HttpRequest.BodyProcessor</kbd> to process the <kbd>String</kbd> request body:</li>
</ol>
<pre>        ObjectMapper<span> mapper </span><span>=</span><span> </span><span>new</span><span> </span><span>ObjectMapper</span><span>();<br/></span>        HttpRequest<span> request </span><span>=</span><span> </span><span>HttpRequest<br/></span>                   .newBuilder(<span>new</span><span> </span><span>URI</span><span>(</span><span>"http://httpbin.org/post"</span><span>))<br/></span>                   .<span>POST(<br/></span><span>          HttpRequest</span><span>.</span><span>BodyProcessor</span><span>.</span><span>fromString(<br/>            mapper</span><span>.</span><span>writeValueAsString(requestBody)<br/>          )<br/>        )<br/></span>        .version(<span>HttpClient</span><span>.</span><span>Version</span><span>.</span><span>HTTP_1_1)<br/></span>        .build();</pre>
<ol start="4">
<li>The request is sent and the response is obtained by using the <kbd>send(HttpRequest,  HttpRequest.BodyHandler)</kbd> method:</li>
</ol>
<pre>        HttpResponse&lt;String&gt;<span> response </span><span>=</span><span> client</span><span>.</span><span>send(request, <br/></span>                             HttpResponse<span>.</span><span>BodyHandler</span><span>.</span><span>asString());</span></pre>
<ol start="5">
<li>We then print the response status code and the response body sent by the server:</li>
</ol>
<pre>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Status code: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>statusCode());<br/></span>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Response Body: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>body());</span></pre>
<p>The complete code for this can be found at <kbd>chp11/2_making_http_post</kbd>. Make sure that there are the following Jackson JARs in the location, <span><kbd>chp11/2_making_http_post/mods</kbd>:</span></p>
<div>
<ul>
<li><kbd><span>jackson</span><span>.</span><span>databind.jar</span></kbd></li>
<li><kbd><span>jackson</span><span>.</span><span>core.jar</span></kbd></li>
<li><kbd><span>jackson</span><span>.</span><span>annotations.jar</span></kbd></li>
</ul>
<p>Also, take note of the module definition, <kbd>module-info.java</kbd>, available at the location, <kbd>chp11/2_making_http_post/src/http.client.demo</kbd>.</p>
</div>
<div class="packt_tip">To understand how Jackson JARs are used in this modular code, please refer to the recipes <em>Bottom-up migration</em> and <em>Top-down migration</em> in <a href="488da544-ff73-4ef7-9d57-00b67479defd.xhtml">Chapter 3</a>, <em>Modular Programming</em>.</div>
<p>Run scripts, <kbd>run.bat</kbd> and <kbd>run.sh</kbd>, are provided to facilitate the compilation and execution of the code:</p>
<div class="CDPAlignCenter CDPAlign"><img height="281" width="370" class="image-border" src="assets/4838990a-d81a-40b9-940f-12f2dad25792.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making an HTTP request for a protected resource</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will look at invoking an HTTP resource that has been protected by user credentials. The URL, <a href="http://httpbin.org/basic-auth/user/passwd">http://httpbin.org/basic-auth/user/passwd</a>, has been protected by HTTP basic authentication. Basic authentication requires a username and a password to be provided in plain text, which is then used by the HTTP resources to decide whether the user authentication is successful or not. </p>
<p>If you open the link, <a href="http://httpbin.org/basic-auth/user/passwd">http://httpbin.org/basic-auth/user/passwd</a>, in the browser, it will prompt for the username and password, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img height="194" width="264" class="image-border" src="assets/26b9a1a7-c65a-4ae3-9c8d-f0003553f30a.png"/></div>
<p>Use the username as <kbd>user</kbd> and password as <kbd>passwd</kbd>, and you will be authenticated to be shown a JSON response, as follows:</p>
<pre><span class="b">{<br/></span><span class="blockInner"><span class="kvov objProp">  "<span class="k">authenticated</span>": <span class="bl">true</span>,<br/></span><span class="kvov objProp">  "<span class="k">user</span>": <span class="s">"<span>user</span>"<br/></span></span></span><span class="b">}</span></pre>
<p>Let's achieve the same using the <kbd>HttpClient</kbd> API.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>We need to extend <kbd>java.net.Authenticator</kbd> and override its <kbd>getPasswordAuthentication()</kbd> method. This method should return an instance of <kbd>java.net.PasswordAuthentication</kbd>. Let's create a class, <kbd>UsernamePasswordAuthenticator</kbd>, which extends <kbd>java.net.Authenticator</kbd>:</li>
</ol>
<pre>        public<span> </span><span>class</span><span> </span><span>UsernamePasswordAuthenticator</span><span> <br/></span><span>          extends</span><span> </span><span>Authenticator</span><span>{<br/></span>        }</pre>
<ol start="2">
<li>We will create two instance variables in the <span><kbd>UsernamePasswordAuthenticator</kbd> class  to store the username and password, and we'll provide a constructor to initialize the same:</span></li>
</ol>
<pre>        private<span> </span><span>String</span><span> username;<br/></span>        private<span> </span><span>String</span><span> password;<br/></span><br/>        public<span> </span><span>UsernamePasswordAuthenticator</span><span>(){}<br/></span>        public<span> </span><span>UsernamePasswordAuthenticator</span><span> ( </span><span>String</span><span> </span><span>username</span><span>, <br/></span><span>                                               String</span><span> </span><span>password</span><span>){<br/></span>          this<span>.</span><span>username </span><span>=</span><span> username;<br/></span>          this<span>.</span><span>password </span><span>=</span><span> password;<br/></span>        }</pre>
<ol start="3">
<li>We then override the <span><kbd>getPasswordAuthentication()</kbd> method to return an instance of <kbd>java.net.PasswordAuthentication</kbd>, initialized with the username and password:</span></li>
</ol>
<pre>        @Override<br/>        protected<span> </span><span>PasswordAuthentication</span><span> </span><span>getPasswordAuthentication</span><span>(){<br/></span>          return<span> </span><span>new</span><span> </span><span>PasswordAuthentication</span><span>(username, <br/>                                            password</span><span>.</span><span>toCharArray());<br/></span>        }</pre>
<ol start="4">
<li>We then create an instance of <span><kbd>UsernamePasswordAuthenticator</kbd>:</span></li>
</ol>
<pre>        String<span> username </span><span>=</span><span> </span><span>"user"</span><span>;<br/></span>        String<span> password </span><span>=</span><span> </span><span>"passwd"</span><span>;</span> <br/><span>        UsernamePasswordAuthenticator</span><span> authenticator </span><span>=</span><span> <br/></span>                new<span> </span><span>UsernamePasswordAuthenticator</span><span>(username, password);</span></pre>
<ol start="5">
<li>We provide the instance of <span><kbd>UsernamePasswordAuthenticator</kbd> while initializing the <kbd>HttpClient</kbd>:</span></li>
</ol>
<pre>        HttpClient<span> client </span><span>=</span><span> </span><span>HttpClient</span>.newBuilder()<br/>                                      .authenticator(authenticator)<br/>                                      .build();</pre>
<ol start="6">
<li>A corresponding <kbd>HttpRequest</kbd> object is created to call the protected HTTP resource, <a href="http://httpbin.org/basic-auth/user/passwd">http://httpbin.org/basic-auth/user/passwd</a>:</li>
</ol>
<pre>        HttpRequest<span> request </span><span>=</span><span> </span><span>HttpRequest</span>.newBuilder(<span>new</span><span> </span><span>URI</span><span>(<br/></span><span>          "http://httpbin.org/basic-auth/user/passwd"<br/></span><span>        ))<br/></span>        .<span>GET()<br/></span>        .version(<span>HttpClient</span><span>.</span><span>Version</span><span>.</span><span>HTTP_1_1)<br/></span>        .build();</pre>
<ol start="7">
<li>We obtain <kbd>HttpResponse</kbd> by executing the request and print the status code and the request body:</li>
</ol>
<pre>        HttpResponse&lt;String&gt;<span> response </span><span>=</span><span> client</span><span>.</span><span>send(request,<br/></span>        HttpResponse<span>.</span><span>BodyHandler</span><span>.</span><span>asString());<br/></span>  <br/>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Status code: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>statusCode());<br/></span>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Response Body: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>body());</span></pre>
<p>The complete code for this is available at the location, <kbd>chp11/3_making_http_request_protected_res</kbd>. You can run the code by using the run scripts, <kbd>run.bat</kbd> or <kbd>run.sh</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img height="136" width="419" class="image-border" src="assets/1963997d-11a8-4412-90e8-1829be0554fb.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The <kbd>Authenticator</kbd> object is used by the network calls to obtain the authentication information. Developers generally extend the <kbd>java.net.Authenticator</kbd> class and override its <kbd>getPasswordAuthentication()</kbd> <span>method. The username and password are read either from the user input or from the configuration and are used by the extended class to create an instance of <kbd>java.net.PasswordAuthentication</kbd>. </span></p>
<p>In the recipe, we created an extension of <kbd>java.net.Authenticator</kbd>, as follows:</p>
<pre><span>public</span><span> </span><span>class</span><span> </span><span>UsernamePasswordAuthenticator</span><span> <br/></span><span>  extends</span><span> </span><span>Authenticator</span><span>{<br/></span><span>    private</span><span> </span><span>String</span><span> username;<br/></span><span>    private</span><span> </span><span>String</span><span> password;<br/></span><span>    <br/>    public</span><span> </span><span>UsernamePasswordAuthenticator</span><span>(){}<br/></span><span>    <br/>    public</span><span> </span><span>UsernamePasswordAuthenticator</span><span> ( </span><span>String</span><span> </span><span>username</span><span>, <br/></span><span>                                           String</span><span> </span><span>password</span><span>){<br/></span><span>        this</span><span>.</span><span>username </span><span>=</span><span> username;<br/></span><span>        this</span><span>.</span><span>password </span><span>=</span><span> password;<br/></span><span>    }<br/></span><span>    <br/>    @Override<br/></span><span>    protected</span><span> </span><span>PasswordAuthentication</span><span> </span><span>getPasswordAuthentication</span><span>(){<br/></span><span>      return</span><span> </span><span>new</span><span> </span><span>PasswordAuthentication</span><span>(username, <br/>                         password</span><span>.</span><span>toCharArray());<br/></span><span>    }<br/></span><span>}</span></pre>
<p>The instance of <span><kbd>UsernamePasswordAuthenticator</kbd> is then provided to the <kbd>HttpClient.Builder</kbd> API. The HttpClient instance makes use of this authenticator to get the username and password while invoking the protected HTTP request.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making an asynchronous HTTP request</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will look at how to make an asynchronous GET request. In an asynchronous request, we don't wait for the response; instead, we handle the response whenever it is received by the client. In jQuery, we will make an asynchronous request and provide a callback that takes care of processing the response, while in the case of Java, we get an instance of <kbd>java.util.concurrent.CompletableFuture</kbd>, and then we invoke the <kbd>thenApply</kbd> method to process the response. Let's see this in action.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Create an instance of <kbd>HttpClient</kbd> using its builder, <kbd>HttpClient.Builder</kbd>:</li>
</ol>
<pre>        HttpClient<span> client </span><span>=</span><span> </span><span>HttpClient</span>.newBuilder().build();</pre>
<ol start="2">
<li>Create an instance of <kbd>HttpRequest</kbd> using its <kbd>HttpRequest.Builder</kbd> builder, representing the URL and the corresponding HTTP method to be used:</li>
</ol>
<pre>        HttpRequest<span> request </span><span>=</span><span> </span><span>HttpRequest<br/></span>                        .newBuilder(<span>new</span><span> </span><span>URI</span><span>(</span><span>"http://httpbin.org/get"</span><span>))<br/></span>                        .<span>GET()<br/></span>                        .version(<span>HttpClient</span><span>.</span><span>Version</span><span>.</span><span>HTTP_1_1)<br/></span>                        .build();</pre>
<ol start="3">
<li>Use the <kbd>sendAsync</kbd> method to make an asynchronous HTTP request and keep a reference to the <kbd>CompletableFuture&lt;HttpResponse&lt;String&gt;&gt;</kbd> object thus obtained. We will use this to process the response:</li>
</ol>
<pre>        CompletableFuture&lt;HttpResponse&lt;String&gt;&gt;<span> responseFuture </span><span>= <br/></span>                  client<span>.</span><span>sendAsync(request, <br/></span><span>                         HttpResponse</span><span>.</span><span>BodyHandler</span><span>.</span><span>asString());</span></pre>
<ol start="4">
<li>We provide <kbd>CompletionStage</kbd> so as to process the response once the previous stage completes. For this, we make use of the <kbd>thenAccept</kbd> method, which takes a lambda expression:</li>
</ol>
<pre>        CompletableFuture&lt;Void&gt;<span> processedFuture </span><span>=</span> <br/>                   responseFuture<span>.</span><span>thenAccept(response </span><span>-&gt;</span><span> {<br/></span>          System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Status code: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>statusCode());<br/></span>          System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Response Body: "</span><span> </span><span>+</span><span> response</span><span>.</span><span>body());<br/></span>        });</pre>
<ol start="5">
<li>Finally, we wait for the future to complete:</li>
</ol>
<pre>        CompletableFuture<span>.</span><span>allOf(processedFuture)</span><span>.</span><span>join();</span></pre>
<p>The complete code for this recipe can be found at the location, <kbd>chp11/4_async_http_request</kbd>. We have provided the <kbd>run.bat</kbd> and <kbd>run.sh</kbd> scripts to compile and run the recipe:</p>
<div class="CDPAlignCenter CDPAlign"><img height="150" width="330" class="alignnone size-full wp-image-1558 image-border" src="assets/54c70aef-5967-4397-9599-3f076c2fb9b7.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making an HTTP request using Apache HttpClient</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will make use of the Apache HttpClient (<a href="https://hc.apache.org/httpcomponents-client-4.5.x/index.html">https://hc.apache.org/httpcomponents-client-4.5.x/index.html</a>) library to make a simple HTTP GET request. As we are using Java 9, we would want to make use of the module path and not the classpath. Hence, we need to modularize the Apache HttpClient library. One way to achieve this is to use the concept of automatic modules. Let's see how to set up the dependencies for the recipe in the <em>Getting ready</em> section. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>All the required JARs are already present in the location, <kbd>chp11\5_apache_http_demo\mods</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img height="101" width="143" class="image-border" src="assets/ead9fd23-94ac-49d6-930d-cbcfcad0f677.png"/></div>
<p>Once these JARs are on the module path, we can declare a dependency on these JARs in <kbd>module-info.java</kbd>, which is present at the location, <kbd>chp11\5_apache_http_demo\src\http.client.demo</kbd>, as shown in the following code snippet:</p>
<div>
<pre><span>module http</span><span>.</span><span>client</span><span>.</span><span>demo{<br/></span><span>  requires httpclient;<br/></span><span>  requires httpcore;<br/></span><span>  requires commons</span><span>.</span><span>logging;<br/></span><span>  requires commons</span><span>.</span><span>codec;<br/></span><span>}</span></pre></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Create a default instance of <kbd>org.http.client.HttpClient</kbd> using its <span><kbd>org.apache.http.impl.client.HttpClients</kbd> factory:</span></li>
</ol>
<pre>        CloseableHttpClient<span> client </span><span>=</span><span> </span><span>HttpClients</span><span>.</span><span>createDefault();</span></pre>
<ol start="2">
<li>Create an instance of <kbd>org.apache.http.client.methods.HttpGet</kbd> along with the required URL. This represents both the HTTP method type and the requested URL:</li>
</ol>
<pre>        HttpGet<span> request </span><span>=</span><span> </span><span>new</span><span> </span><span>HttpGet</span><span>(</span><span>"http://httpbin.org/get"</span><span>);</span></pre>
<ol start="3">
<li>Execute the HTTP request using the <kbd>HttpClient</kbd> instance to obtain an instance of <kbd>CloseableHttpResponse</kbd>:</li>
</ol>
<pre>        CloseableHttpResponse<span> response </span><span>=</span><span> client</span><span>.</span><span>execute(request);</span></pre>
<p style="padding-left: 60px">The <kbd>CloseableHttpResponse</kbd> instance returned after executing the HTTP request can be used to obtain details such as the response status code and other contents of the response embedded within the <span>instance of </span>an implementation of <kbd>HttpEntity</kbd>.</p>
<ol start="4">
<li>We make use of <kbd>EntityUtils.toString()</kbd> to obtain the response body embedded within the instance of an implementation of <kbd>HttpEntity</kbd> and print both the status code and response body:</li>
</ol>
<pre>        int<span> statusCode </span><span>=</span><span> response</span><span>.</span><span>getStatusLine()</span><span>.</span><span>getStatusCode();<br/></span>        String<span> responseBody </span><span>=</span><span> </span><span>EntityUtils</span><span>.</span><span>toString(response</span><span>.</span><span>getEntity());<br/></span>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Status code: "</span><span> </span><span>+</span><span> statusCode);<br/></span>        System<span>.</span><span>out</span><span>.</span><span>println(</span><span>"Response Body: "</span><span> </span><span>+</span><span> responseBody);</span></pre>
<p>The complete code for this recipe can be found at the location, <kbd>chp11\5_apache_http_demo</kbd>. We have provided <kbd>run.bat</kbd> and <kbd>run.sh</kbd> to compile and execute the recipe code:</p>
<div class="CDPAlignCenter CDPAlign"><img height="143" width="280" class="alignnone size-full wp-image-1560 image-border" src="assets/178edff0-5480-4b9f-9825-a4ed4d9e62e7.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There is more...</h1>
                </header>
            
            <article>
                
<p>We can provide a custom response handler while invoking the <kbd>HttpClient.execute</kbd> method, as follows:</p>
<div>
<pre><span>String</span><span> responseBody </span><span>=</span><span> client</span><span>.</span><span>execute(request, response </span><span>-&gt;</span><span> {<br/></span><span>  int</span><span> status </span><span>=</span><span> response</span><span>.</span><span>getStatusLine()</span><span>.</span><span>getStatusCode();<br/></span><span>  HttpEntity</span><span> entity </span><span>=</span><span> response</span><span>.</span><span>getEntity();<br/></span><span>  return</span><span> entity </span><span>!=</span><span> </span><span>null</span><span> </span><span>?</span><span> </span><span>EntityUtils</span><span>.</span><span>toString(entity) </span><span>:</span><span> </span><span>null</span><span>;<br/></span><span>});</span></pre></div>
<p class="mce-root">In this case, the response is processed by the response handler and returns us the response body string. The complete code for this can be found at the location, <kbd>chp11\5_1_apache_http_demo_response_handler</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making an HTTP request using the Unirest HTTP client library</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will make use of the Unirest HTTP (<a href="http://unirest.io/java.html">http://unirest.io/java.html</a>) Java library to access HTTP services. Unirest Java is a library based on Apache's HTTP client library and provides a fluent API for making HTTP requests.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>As the Java library is not modular, we will make use of the concept of automatic modules as explained in <a href="488da544-ff73-4ef7-9d57-00b67479defd.xhtml">Chapter 3</a>, <em>Modular Programming</em>. The JARs belonging to the library are placed on the module path of the application, and the application then declares a dependency on the JARs by using the name of the JAR as its module name. This way, a JAR file automatically becomes a module and is hence called an automatic module.</p>
<p><span>The Maven dependency for the Java library is:</span></p>
<pre>&lt;<span class="pl-ent">dependency</span>&gt;
  &lt;<span class="pl-ent">groupId</span>&gt;com.mashape.unirest&lt;/<span class="pl-ent">groupId</span>&gt;
  &lt;<span class="pl-ent">artifactId</span>&gt;unirest-java&lt;/<span class="pl-ent">artifactId</span>&gt;
  &lt;<span class="pl-ent">version</span>&gt;1.4.9&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre>
<p>As we are not using Maven in our samples, we have downloaded the JARs into the folder, <kbd>chp11/6_unirest_http_demo/mods</kbd>. </p>
<p><span>The module definition is as follows:</span></p>
<pre>module http.client.demo{<br/>  requires httpasyncclient;<br/>  requires httpclient;<br/>  requires httpmime;<br/>  requires json;<br/>  requires unirest.java;<br/>  requires httpcore;<br/>  requires httpcore.nio;<br/>  requires commons.logging;<br/>  requires commons.codec;<br/>}</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>Unirest provides a very fluid API for making HTTP requests. We can make a <kbd>GET</kbd> request as follows:</p>
<pre>HttpResponse&lt;JsonNode&gt; jsonResponse = <br/>  Unirest.get("http://httpbin.org/get")<br/>         .asJson();</pre>
<p>The response status and response body can be obtained from the <kbd>jsonResponse</kbd> object, as follows:</p>
<pre>int statusCode = jsonResponse.getStatus();<br/>JsonNode jsonBody = jsonResponse.getBody();</pre>
<p>We can make a <kbd>POST</kbd> request and pass some data, as follows:</p>
<pre>jsonResponse = Unirest.post("http://httpbin.org/post")<br/>                      .field("key1", "val1")<br/>                      .field("key2", "val2")<br/>                      .asJson();</pre>
<p>We can make a call to a protected HTTP resource, as follows:</p>
<pre>jsonResponse = Unirest.get("http://httpbin.org/basic-auth/user/passwd")<br/>                      .basicAuth("user", "passwd")<br/>                      .asJson();</pre>
<p>The code for this can be found at the location, <kbd>chp11\6_unirest_http_demo</kbd>.</p>
<p>We have provided the <kbd>run.bat</kbd> and <kbd>run.sh</kbd> scripts to execute the code.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>The Unirest Java library provides much more advanced functionality, such as making async requests, file uploads, and using proxy, among other features. It's advisable that you try out these different features of the library.</p>


            </article>

            
        </section>
    </body></html>