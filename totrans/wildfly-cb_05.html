<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Managing the Datasource Subsystems with the CLI"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Managing the Datasource Subsystems with the CLI</h1></div></div></div><p>In this chapter, you will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Preparing a non JDBC-4 compliant driver</li><li class="listitem" style="list-style-type: disc">Creating and removing a datasource</li><li class="listitem" style="list-style-type: disc">Checking the datasource connection</li><li class="listitem" style="list-style-type: disc">Reading the datasource's statistics</li><li class="listitem" style="list-style-type: disc">Setting a connection pool</li><li class="listitem" style="list-style-type: disc">Creating and removing XA-Datasource</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Introduction</h1></div></div></div><p>In this chapter, you will learn how to manage WildFly datasource subsystems with the CLI. This is independent of the WildFly operation mode. For this reason and to facilitate the configuration, we will be running WildFly in the standalone mode.</p><p> A datasource is the component used by applications to connect to the database. The datasource, in turn, uses a driver to communicate with the underlying database properly. Hence, for WildFly to provide database integration, it needs a driver and a datasource.</p><p>WildFly comes with a default configuration, which is the <code class="literal">ExampleDS</code> datasource, bound to the "H2" driver. H2 is a Java SQL database, used mainly as an in-memory DB for testing purpose with SQL support.</p><p>WildFly automatically recognizes any JDBC 4 compliant driver. For this reason, a driver can be installed as a module (that is, static deployment) or it can be deployed as any normal application.</p><p>In the first method, you will have to replicate the driver module installation in all the hosts where the applications and configuration require such a driver. On the other hand, by using dynamic deployment in the domain mode, the driver can be spread to all server groups, and thus to all available hosts, with just one command or a click.</p><p>A datasource can also be deployed in the old fashioned way by using a <code class="literal">-ds.xml</code> file. Even though this alternative is very helpful when migrating from JBoss 5 and JBoss 6, it is not the best choice when configuring a production environment. That's because the datasource cannot be altered via a management interface, such as CLI and Web Admin Console. Also, the datasource cannot be configured to take advantage of the security concerns, such as security domains and password vaults (we will discuss these topics later in the book).</p></div></div>
<div class="section" title="Preparing a non JDBC-4 compliant driver"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec50"/>Preparing a non JDBC-4 compliant driver</h1></div></div></div><p>In this recipe, we <a id="id395" class="indexterm"/>will learn how to make a JDBC driver compliant to version 4. This is needed to install the driver and to make it available for your datasources, and hence to your applications.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec121"/>Getting ready</h2></div></div></div><p>If you already have a JDBC 4 compliant driver, you can skip this recipe; otherwise, I assume that you do not have a JDBC driver and I'll refer to it as <code class="literal">non-jdbc-4-driver.jar</code>, throughout the recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec122"/>How to do it…</h2></div></div></div><p>To make your driver JDBC 4 compliant, you just need to add a file into it, as described in the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a temporary folder and navigate into it.</li><li class="listitem">Place your <code class="literal">non-jdbc-4-driver.jar</code> driver file into it.</li><li class="listitem">Create a <code class="literal">META-INF/services</code> directory.</li><li class="listitem">Create a file named <code class="literal">java.sql.Driver</code> and place it into the folder specified in step 3.</li><li class="listitem">Edit the file <code class="literal">java.sqlDriver</code> and enter one line containing the fully qualified name of the class implementing the driver.</li><li class="listitem">Starting from the empty folder as per step <code class="literal">1</code>, update the file <code class="literal">non-jdbc-4-driver.jar</code> using the JAR tool as follows:<div class="informalexample"><pre class="programlisting">jar -uf non-jdbc-4-driver.jar META-INF/services/java.sql.Driver</pre></div></li></ol></div><p>You are now ready to install or deploy your new JDBC 4 compliant driver.</p></div></div>
<div class="section" title="Creating and removing a datasource"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec51"/>Creating and removing a datasource</h1></div></div></div><p>One of the <a id="id396" class="indexterm"/>most used features that an application comes with is the possibility to <a id="id397" class="indexterm"/>persist states (such as user information, orders, and so on) into a database. In this recipe, we will learn how to configure datasources and a JDBC 4 compliant driver.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec123"/>Getting ready</h2></div></div></div><p>Before we begin, we need to have a running database installed on our computer, or on a remote server. In this recipe, we will use a MySQL database running locally and listening on port <code class="literal">3306</code>—the installation and configuration of the MySQL database server is beyond the scope of this book.</p><p>Declaring a new datasource consists of two separate steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Installing the JDBC driver.</li><li class="listitem">Configuring the datasource itself.</li></ol></div><p>The first step can be done in two different ways. You can install a JDBC driver by deploying it as a normal artifact, or you can install it as a WildFly module.</p><p>First, download the latest version (which, as per this writing, is "5.1.35") of the MySQL JDBC connector <a id="id398" class="indexterm"/>from <a class="ulink" href="http://dev.mysql.com/downloads/connector/j/">http://dev.mysql.com/downloads/connector/j/</a>, and place it into your WildFly Cookbook directory <code class="literal">WFC</code>, under your <code class="literal">home</code> folder.</p><p>To install a JDBC <a id="id399" class="indexterm"/>driver as a WildFly module, we need to perform the following actions:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go into the modules folder <code class="literal">$WILDFLY_HOME/modules/system/layers/base</code> and create a subfolder structure that matches your module name as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/modules/system/layers/base
$ mkdir -p jdbc/mysql/main</pre></div></li><li class="listitem">Place the <code class="literal">~/WFC/mysql-connector-java-5.1.35-bin.jar</code> file, that you downloaded previously, into the <code class="literal">main</code> folder .</li><li class="listitem">Within the <code class="literal">main</code>  folder, create a file named <code class="literal">module.xml</code> with the following content:<div class="informalexample"><pre class="programlisting">&lt;module  name="jdbc.mysql"&gt;
  &lt;resources&gt;
    &lt;resource-root path="mysql-connector-java-5.1.35-bin.jar"/&gt;
  &lt;/resources&gt;
  &lt;dependencies&gt;
    &lt;module name="javax.api"/&gt;
    &lt;module name="javax.transaction.api"/&gt;
  &lt;/dependencies&gt;
&lt;/module&gt;</pre></div><p>As you can see, I've emphasized the name of the module which matched the subfolders structure—except for the main folder which just corresponds to the <code class="literal">version</code>.</p><p>Great! Now we are ready to add the driver to the datasource subsystem.</p></li><li class="listitem">Start WildFly <a id="id400" class="indexterm"/>and do the following:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh --connect
[standalone@localhost:9990 /] /subsystem=datasources/jdbc-driver=mysql:add(driver-module-name=jdbc.mysql, driver-name=mysql)
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Before we can <a id="id401" class="indexterm"/>continue, please create a database on your running MySQL server instance named <code class="literal">wildflycookbook</code>, as follows:<div class="informalexample"><pre class="programlisting">CREATE DATABASE IF NOT EXISTS wildflycookbook</pre></div></li></ol></div><p>Now that we have the JDBC driver installed, we are ready to configure our datasource.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec124"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">With a running WildFly server, open your command-line tool and connect to the CLI:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh
You are disconnected at the moment. Type 'connect' to connect to the server or 'help' for the list of supported commands.
[disconnected /] connect
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Now execute the following commands:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS:add(jndi-name="java:jboss/datasources/WildFlyCookbookDS", connection-url="jdbc:mysql://localhost:3306/wildflycookbook", <span class="strong"><strong>driver-name="mysql"</strong></span>, user-name="wildflymysql", <span class="strong"><strong>password="wildfly-mysql-password"</strong></span>, prepared-statements-cache-size=128, share-prepared-statements=true, blocking-timeout-wait-millis=60000, idle-timeout-minutes=20)
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Now, on listing the available datasources, you should find our newly created one:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] ls /subsystem=datasources/data-source                  
ExampleDS          WildFlyCookbookDS  
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">If you need to remove <a id="id402" class="indexterm"/>a datasource, invoke <code class="literal">remove</code> next to it, as follows:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS:remove()
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] ls /subsystem=datasources/data-source
ExampleDS  
[standalone@localhost:9990 /]</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec125"/>How it works…</h2></div></div></div><p>As you can see, configuring a datasource is not that tough, but what it needs to get there is a lot of work. The <a id="id403" class="indexterm"/>datasource itself is just a reference to the database, which involves a connector, that is, the driver. In fact, in the DS configuration, I emphasized the <code class="literal">driver-name</code> attribute that matches the driver that we defined in the <span class="emphasis"><em>Getting ready</em></span> section. Furthermore, I emphasized the <code class="literal">password</code> attribute that you should change with regard to your database configuration.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec126"/>There's more…</h2></div></div></div><p>Datasource configuration comes with more parameters such as defining and sizing a connection pool, but we will see that later in this chapter with a dedicated recipe. You will also learn that you can have an XA-Datasource, which actually enables distributed transaction across different transactional systems.</p></div></div>
<div class="section" title="Checking the datasource connection"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Checking the datasource connection</h1></div></div></div><p>Sometimes, you <a id="id404" class="indexterm"/>might see errors in your log's application because of something going wrong with your persistence storage. The first thing to do in that case, is to check if the database is up and running by testing its connection; you may even realize that you are pointing to a wrong one or you misspelled the connection URL.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec127"/>Getting ready</h2></div></div></div><p>This recipe is based on the previous one, where we have configured a datasource which connects to a local MySQL database, so we will test our database connection with the WildFlyCookBookDS datasource. You can test the connection with a datasource of your choice as long as you provide the correct configuration as well.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec128"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">With a running <a id="id405" class="indexterm"/>WildFly server, open your command-line tool and connect to the CLI:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh --connect
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Now execute the following commands:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS:test-connection-in-pool()
{
    "outcome" =&gt; "success",
    "result" =&gt; [true]
}
[standalone@localhost:9990 /]</pre></div></li></ol></div><p>That's it! Wasn't it easy?</p></div></div>
<div class="section" title="Reading the datasource's statistics"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec53"/>Reading the datasource's statistics</h1></div></div></div><p>In this recipe, you will <a id="id406" class="indexterm"/>learn how to enable the statistics of the datasource to check whether we are getting the most out of it, or if we need to tune something with the datasource, or at worst, scale with the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec129"/>Getting ready</h2></div></div></div><p>To get an idea of what is going on with our datasource, let's generate some traffic towards the database. In this case, we will use the application named <code class="literal">datasource-traffic-generator</code>. To obtain the artifact to deploy, please refer to the <span class="emphasis"><em>Software prerequisites</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Welcome to WildFly!">Chapter 1</a>, <span class="emphasis"><em>Welcome to WildFly!</em></span>. Furthermore, in the source code of the application, you can find an Apache JMeter (also JMeter) project, available at the following path: <code class="literal">datasource-traffic-generator/src/main/resources/HTTP Request Defaults.jmx</code>.</p><p>Briefly, Apache JMeter is a testing tool used to make a stress test; as a matter of fact, we will stress the <code class="literal">datasource-traffic-generator</code> application, which inserts some data into the DB.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>You can download the <a id="id407" class="indexterm"/>Apache JMeter binary, from <a class="ulink" href="http://jmeter.apache.org/download_jmeter.cgi">http://jmeter.apache.org/download_jmeter.cgi</a>.</p></div></div><p>The installation is quite easy:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Just unzip the <a id="id408" class="indexterm"/>downloaded package <code class="literal">apache-jmeter-2.13.zip</code>, into the <code class="literal">~/WFC</code> folder.</li><li class="listitem">To run it, from the command line, navigate to the JMeter folder and issue the following command:<div class="informalexample"><pre class="programlisting">$ ./bin/jmeter.sh</pre></div><p>If everything goes well, you should see the JMeter tool as depicted in the following image:</p><div class="mediaobject"><img src="graphics/3744_05_01.jpg" alt="Getting ready"/><div class="caption"><p>Apache JMeter</p></div></div></li><li class="listitem">Furthermore, the database that we are going to use is MySQL. In that, create a database named <code class="literal">wildflycookbook</code>.</li><li class="listitem">Lastly, create a table named <code class="literal">USER</code>, as follows:<div class="informalexample"><pre class="programlisting">CREATE DATABASE IF NOT EXISTS wildflycookbook
CREATE TABLE
  wildflycookbook.user
  (
    id BIGINT NOT NULL AUTO_INCREMENT,
    firstname VARCHAR(100) NOT NULL,
    lastname VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    phone VARCHAR(50),
    nickname VARCHAR(50),
    PRIMARY KEY (id),
    CONSTRAINT user_email UNIQUE (email)
  )
  ENGINE=InnoDB DEFAULT CHARSET=latin1</pre></div></li></ol></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec130"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">With a running <a id="id409" class="indexterm"/>WildFly server, open your command-line tool and connect to the CLI:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh --connect
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Now, deploy the <code class="literal">datasource-traffic-generator.war</code> bundle as usual.</li><li class="listitem">Enable JDBC and Pool statistics with the following commands on the CLI:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS/statistics=jdbc:write-attribute(name=statistics-enabled,value=true)
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS/statistics=pool:write-attribute(name=statistics-enabled,value=true)
{"outcome" =&gt; "success"}</pre></div></li><li class="listitem">Open the <code class="literal">datasource-traffic-generator/src/main/resources/HTTP Request Defaults.jmx</code> JMeter project and hit the start button.</li><li class="listitem">As soon as you hit the play button in JMeter, in the WIldFLy CLI, execute the following commands:<div class="informalexample"><pre class="programlisting">/subsystem=datasources/data-source=WildFlyCookbookDS/statistics=jdbc:read-resource(include-runtime=true)
/subsystem=datasources/data-source=WildFlyCookbookDS/statistics=pool:read-resource(include-runtime=true)</pre></div><p>The result is depicted in the following image:</p><div class="mediaobject"><img src="graphics/3744_05_02.jpg" alt="How to do it…"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec131"/>How it works…</h2></div></div></div><p>As you can see, we executed two commands, one to retrieve information at the <code class="literal">jdbc</code> level, and one to retrieve information about the <code class="literal">pool</code> configured within the datasource.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec132"/>There's more...</h2></div></div></div><p>Instead of executing two <a id="id410" class="indexterm"/>commands within the CLI, you can use just one command to retrieve a lot more information. This can be helpful in parsing the data outside the CLI; also keep in mind that the output is very similar to the JSON format.</p><p>As a matter of fact, you can execute a CLI command outside the CLI using a bash-script, python, or Java and then parse the result to retrieve just the information you need.</p><p>To execute a CLI command using the bash-shell, type the following command:</p><div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh -c --command="/subsystem=datasources/data-source=WildFlyCookbookDS:read-resource(include-runtime=true,recursive=true)"</pre></div></div></div>
<div class="section" title="Setting a connection pool"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec54"/>Setting a connection pool</h1></div></div></div><p>As in the previous <a id="id411" class="indexterm"/>recipe, sometimes we need to extract some information regarding the behavior of database integration. Many times, when your application's concurrent users are in the order of hundreds or thousands, you have to serve multiple DB connections at a time. This is exactly what we will learn in this recipe, using the CLI.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec133"/>Getting ready</h2></div></div></div><p>Think of a connection pool like a bucket pre-filled with a minimum number of ready-to-use connections for your application. There is also an upper bound limit that defines the maximum number of connections that the pool can hold. The default values for the minimum and maximum size of the pool are <code class="literal">0</code> and <code class="literal">20</code> respectively, with the <code class="literal">prefill</code> attribute set to <code class="literal">false</code> by default. This means that when a datasource is started up, its connection pool is created with <code class="literal">0</code> active and valid connections, and that it can hold up to 20 connections.</p><p>Why would you use a connection pool? Because creating a connection involves a lot of things under the hood, so having it ready helps you with the performance.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec134"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">With a running WildFly server, open your command line tool and connect to the CLI:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh
You are disconnected at the moment. Type 'connect' to connect to the server or 'help' for the list of supported commands.
[disconnected /] connect
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Now execute the <a id="id412" class="indexterm"/>following commands:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS:write-attribute(name="min-pool-size", value="10")
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS:write-attribute(name="max-pool-size", value="20")
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /]</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec135"/>How it works…</h2></div></div></div><p>The previously mentioned commands created a pool for our connections, so that we can count to a series of available connections that goes from 10 to 20.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec136"/>There's more…</h2></div></div></div><p>One more option that we can use to boost our database connection is to have our connection pool pre-filled with connections.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To achieve this, we need set the <code class="literal">pool-prefill</code> attribute to <code class="literal">true</code>, as follows:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=datasources/data-source=WildFlyCookbookDS:write-attribute(name="pool-prefill", value="true")
{
  "outcome" =&gt; "success",
  "response-headers" =&gt; {
    "operation-requires-reload" =&gt; true,
    "process-state" =&gt; "reload-required"
  }
}
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">As you can see, not all changes are made at runtime; we often need to reload the WildFly configuration, like in this case. To reload the server (we had a recipe for that, both standalone and domain mode), execute the following command:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] :reload
{
  "outcome" =&gt; "success",
  "result" =&gt; undefined
}
[standalone@localhost:9990 /]</pre></div><p>The following <a id="id413" class="indexterm"/>image shows the <code class="literal">WildFlyCookbookDS</code> datasource with its new Pool configuration:</p><div class="mediaobject"><img src="graphics/3744_05_03.jpg" alt="There's more…"/></div></li></ol></div><p>There is also one more important aspect, which is worth mentioning about the datasource connection pool.</p><p>What happens if you pre-fill your pool with valid connections and then the database crashes or it gets restarted? Well, your connections might look valid in the pool, but the reference to the underlying database has changed, thus they will not be able to query your data. Fortunately, there are a few parameters that can help you solve this problem.</p><p>First of all, you need to choose a mechanism to validate your connection. You can opt for a time based approach, or decide to check your connection every time it is used.</p><p>The first approach <a id="id414" class="indexterm"/>consists of setting the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">background-validation=true</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">background-validation-millis=30000</code>—default is <code class="literal">0</code></li></ul></div><p>On the other hand, the second approach consists of setting the following attribute:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">validate-on-match=true</code></li></ul></div><p>Whichever approach you use, always set the other one to <code class="literal">false</code>.</p><p>Once you have chosen the validation mechanism, you need to specify how to check if the connection is valid. You can achieve this by using one of the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">check-valid-connection-sql</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">valid-connection-checker-class</code></li></ul></div><p>Both the attributes are database specific. The first one must contain a valid SQL code (for example <code class="literal">SELECT 1</code> or <code class="literal">SELECT 1 FROM DUAL</code>). The second one delegates its check algorithm to a class. WildFly provides checker classes for the most used databases, which are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>
<span class="strong"><strong>Checker class</strong></span>
</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.db2.DB2ValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.mssql.MSSQLValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLReplicationValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.GoodForSecondsValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.JDBC4ValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.NullValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.SQLExceptionValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.oracle.OracleValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLValidConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.sybase.SybaseValidConnectionChecker</code>
</p>
</td></tr></tbody></table></div><p>Last, but not the least, you can count on two other attributes that help you clean up connections: <code class="literal">stale-connection-checker-class-name</code> and <code class="literal">exception-sorter-class-name</code>.</p><p>The first one provides you <a id="id415" class="indexterm"/>with an easy way to clean up stale connections; you can rely on a generic class, and DB2 and Oracle specific classes, as the following:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>
<span class="strong"><strong>Generic/specific class</strong></span>
</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.AlwaysStaleConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.NullStaleConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.db2.DB2StaleConnectionChecker</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.oracle.OracleStaleConnectionChecker</code>
</p>
</td></tr></tbody></table></div><p>The second attribute provides you with an easy way to clean up connections that threw a <code class="literal">FATAL</code> exception, and relative to your database, you can rely on the following classes:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>
<span class="strong"><strong>Class</strong></span>
</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.db2.DB2ExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.informix.InformixExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.mssql.MSSQLExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.AlwaysExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.novendor.NullExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.oracle.OracleExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLExceptionSorter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">org.jboss.jca.adapters.jdbc.extensions.sybase.SybaseExceptionSorter</code>
</p>
</td></tr></tbody></table></div></div></div>
<div class="section" title="Creating and removing XA-Datasource"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec55"/>Creating and removing XA-Datasource</h1></div></div></div><p>XA-Datasources <a id="id416" class="indexterm"/>are just like normal datasources, except that they <a id="id417" class="indexterm"/>need a different <code class="literal">driver-class-name</code> and they support distributed transaction across heterogeneous transactional systems.</p><p>Imagine the classical example of an online store: a user buys an item, the item is removed from the stock database and an amount of money is subtracted from the user's bank account, which is an external system. Both the operations must succeed in order to proceed with payment and shipment.</p><p>This was just an example to give you the idea; we will not go any further.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec137"/>Getting ready</h2></div></div></div><p>The prerequisite of this recipe is the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Creating and removing a datasource</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec138"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">With a running WildFly server, open your command-line tool and connect to the CLI:<div class="informalexample"><pre class="programlisting">$ ./bin/jboss-cli.sh --connect
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Now execute the following commands:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] batch
[standalone@localhost:9990 / #] /subsystem=datasources/xa-data-source=XAWildFlyCookBookDS:add(driver-name=mysql,jndi-name=java:jboss/datasources/XAWildFlyCookBookDS,use-java-context=true,new-connection-sql="select 1 from dual",no-tx-separate-pool=true,valid-connection-checker-class-name="org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLValidConnectionChecker",stale-connection-checker-class-name="org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLStaleConnectionChecker",min-pool-size=10,max-pool-size=25,track-statements=true,prepared-statements-cache-size=25, <span class="strong"><strong>xa-datasource-class="com.mysql.jdbc.jdbc2.optional.MysqlXADataSource"</strong></span>)
[standalone@localhost:9990 / #] /subsystem=datasources/xa-data-source=XAWildFlyCookBookDS/xa-datasource-properties=URL:add(value="jdbc:mysql://localhost:3306/wildflycookbook")
[standalone@localhost:9990 / #] /subsystem=datasources/xa-data-source=XAWildFlyCookBookDS/xa-datasource-properties=User:add(value="root")
[standalone@localhost:9990 / #] /subsystem=datasources/xa-data-source=XAWildFlyCookBookDS/xa-datasource-properties=Password:add(value="password-root")
[standalone@localhost:9990 / #] run-batch
The batch executed successfully
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">Now, on listing the <a id="id418" class="indexterm"/>available datasources you should find <a id="id419" class="indexterm"/>our newly created one:<div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] ls /subsystem=datasources/xa-data-source                  
XAWildFlyCookBookDS  
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">If you need to remove a datasource, invoke <code class="literal">remove</code> next to it, as depicted in the following image:<div class="mediaobject"><img src="graphics/3744_05_04.jpg" alt="How to do it…"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec139"/>How it works…</h2></div></div></div><p>We first created an XA-DataSource with just the required information and then added the other ones, all in batch mode. By doing this, we are able to split the configuration process and eventually see where we are going wrong.</p><p>Additionally, we specified the <code class="literal">xa-datasource-class</code> class, because XA-DataSource needs a special class that implements and supports distributed transactions. The driver is the same, just specify a different driver class implementation.</p></div></div></body></html>