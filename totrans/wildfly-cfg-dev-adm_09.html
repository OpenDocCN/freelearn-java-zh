<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Load-balancing Web Applications"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Load-balancing Web Applications</h1></div></div></div><p>In the previous chapter, we illustrated the basic concepts of how to cluster web applications. However, this is only part of the story. To further improve availability, we need to look at how to load-balance your WildFly servers.</p><p>Load balancing<a id="id1060" class="indexterm"/> is the distribution of incoming traffic between servers that host the same application content. Load balancing improves application availability by ensuring that any single server does not take too much load, and that the application remains available should a single server fail.</p><p>Historically, the JBoss AS has inherited the load-balancing libraries from Tomcat, which was part of the application server's web module. The web module used <code class="literal">mod_jk</code> (an Apache module) to connect Tomcat to a web server, such as Apache. For those of you who are unfamiliar with Tomcat and Apache, Tomcat (also known as Apache Tomcat) is an open source servlet container, while Apache (also known as Apache2 or Apache HTTPD) is an HTTP web server.</p><p>While you can still use <code class="literal">mod_jk</code> to connect Undertow to a web server, you should consider using the <code class="literal">mod_cluster</code> API. The <code class="literal">mod_cluster</code> API is an HTTPD-based load balancer that has several advantages over <code class="literal">mod_jk</code>, such as improved performance and reliability. We will cover the installation of both <code class="literal">mod_jk</code> and <code class="literal">mod_cluster</code> in this chapter.</p><p>Having made this short introduction, next we will introduce the advantages of using a web server in front of your web applications. We will then continue by covering the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Connecting WildFly to Apache using <code class="literal">mod_jk</code> and <code class="literal">mod_proxy</code></li><li class="listitem" style="list-style-type: disc">Connecting WildFly to Apache using the <code class="literal">mod_cluster</code> API</li></ul></div><div class="section" title="Benefits of using the Apache web server with WildFly"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec49"/>Benefits of using the Apache web server with WildFly</h1></div></div></div><p>In most real-world situations, it's common to find the Apache web server as an entry point to your application <a id="id1061" class="indexterm"/>server. Some advantages of this are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Speed</strong></span>: Apache<a id="id1062" class="indexterm"/> is generally faster at serving static content.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Security</strong></span>: By<a id="id1063" class="indexterm"/> placing WildFly behind Apache, you only need to worry about connections from a single point of entry. WildFly can be configured to accept connections from a single IP (the server hosting Apache) and will not be accessible directly from the Internet. Essentially, Apache becomes a smart proxy server.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Load balancing and clustering</strong></span>: Using Apache as a frontend, you can distribute<a id="id1064" class="indexterm"/> traffic to multiple <a id="id1065" class="indexterm"/>WildFly server instances. If one of your servers fails, the communication transparently continues to another node in the cluster.</li></ul></div><p>As stated previously, connecting Apache and WildFly can be done in one of two ways: by either using Tomcat's <code class="literal">mod_jk</code> library or Apache's <code class="literal">mod_proxy</code> libraries. As the installation of both <code class="literal">mod_jk</code> and <code class="literal">mod_proxy</code> does not differ from earlier AS releases, we will just include a quick setup guide for your reference.</p><p>If, however, you are planning to set up a high-performance, dynamic cluster of web servers, you should consider migrating to the newer <code class="literal">mod_cluster</code> API, which is discussed in the following sections of this chapter.</p><div class="section" title="Using the mod_jk library"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec102"/>Using the mod_jk library</h2></div></div></div><p>The <code class="literal">mod_jk</code> library is a common solution to front WildFly with the Apache web server. All requests <a id="id1066" class="indexterm"/>first arrive at the Apache web server. Apache<a id="id1067" class="indexterm"/> then accepts and processes any static resource requests, such as requests for HTML pages or graphical images. Then, with the help of <code class="literal">mod_jk</code>, Apache requests dynamic resources, such as JSPs or Servlets, to Undertow. The communication between Apache and Undertow is sent over the network using the AJP protocol, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_01.jpg" alt="Using the mod_jk library"/></div><div class="section" title="Installing Apache"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec74"/>Installing Apache</h3></div></div></div><p>The <a id="id1068" class="indexterm"/>most common operating system for live <a id="id1069" class="indexterm"/>environments is Linux. For this reason, we will demonstrate <a id="id1070" class="indexterm"/>how to install <code class="literal">mod_jk</code> in Ubuntu. Bear in mind that the configuration may differ slightly depending on the flavor of Linux you use. These instructions work for Ubuntu Server.</p><p>You need to install Apache before attempting to install <code class="literal">mod_jk</code>. You can install Apache by issuing the following commands in the terminal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get update</strong></span>
<span class="strong"><strong>sudo apt-get install -y apache2</strong></span>
</pre></div><p>Make sure that you can view the Apache welcome page after completing the installation. Simply enter the IP of the server as the URL of your browser. Take a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_02.jpg" alt="Installing Apache"/></div></div><div class="section" title="Installing mod_jk"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec75"/>Installing mod_jk</h3></div></div></div><p>Next, we<a id="id1071" class="indexterm"/> need to install <code class="literal">mod_jk</code>. The following <a id="id1072" class="indexterm"/>command will install the module, enable it, and<a id="id1073" class="indexterm"/> restart Apache:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install libapache2-mod-jk</strong></span>
</pre></div><p>You can then confirm that the module has been enabled by typing the following command. This will list all currently enabled modules:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apache2ctl -M</strong></span>
</pre></div><p>Then, you need to modify the virtual host within for the default configuration file, <code class="literal">default</code>, which can be found in the <code class="literal">/etc/apache2/sites-enabled</code> directory. The configuration shows the updated default configuration of the file. The line you need to add is highlighted in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;VirtualHost *:80&gt;
    ServerAdmin webmaster@localhost

<span class="strong"><strong>    JkMount /* loadbalancer</strong></span>
    &lt;Directory /&gt;
        Options FollowSymLinks
        AllowOverride None
    &lt;/Directory&gt;

     ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;</pre></div><p>The <code class="literal">JkMount</code> directive tells Apache which URLs it should forward to the <code class="literal">mod_jk</code> module, which in turn forwards them to the Undertow web container. In the preceding example, all requests with the URL path <code class="literal">/*</code> are sent to the <code class="literal">mod_jk</code> connector. This means that all<a id="id1074" class="indexterm"/> requests are sent. You can also forward <a id="id1075" class="indexterm"/>specific URLs to <code class="literal">mod_jk</code>, for example, <code class="literal">/website*</code>.</p><p>If you <a id="id1076" class="indexterm"/>forward all URLs, you may want to unmount one or two URLs so that static data can be served from Apache. This can be achieved using the <code class="literal">JkUmount</code> directive. For example, if you want Apache to serve static media files in the <code class="literal">images</code> directory, you will have a configuration like this:</p><div class="informalexample"><pre class="programlisting">&lt;VirtualHost *:80&gt;
        ServerAdmin webmaster@localhost

        JkMount /* loadbalancer
<span class="strong"><strong>        JkUmount /images/* loadbalancer</strong></span>

        &lt;Directory /&gt;
                Options FollowSymLinks
                AllowOverride None
         &lt;/Directory&gt;

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;</pre></div><p>Next, you need to configure the <code class="literal">mod_jk</code> workers file, <code class="literal">workers.properties</code>, which is found in the <code class="literal">/etc/libapache2-mod-jk</code> folder. This file specifies the IP addresses of the Undertow web servers, between which the load is balanced. Optionally, you can add a configuration that specifies how calls should be load-balanced across each of the servers. For a two-node setup, the file will look like this:</p><div class="informalexample"><pre class="programlisting"># Define worker list
worker.list=loadbalancer,jkstatus
# Set properties for worker1 (ajp13)
worker.worker1.type=ajp13
worker.worker1.host=192.168.0.1
worker.worker1.port=8009  

# Set properties for worker2 (ajp13)
worker.worker2.type=ajp13
worker.worker1worker12.host=192.168.0.2
worker.worker1worker12.port=8009
worker.worker1.lbfactor=1
worker.loadbalancer.type=lb
worker.loadbalancer.balance_workers=worker1,worker2</pre></div><p>In the <code class="literal">workers.properties</code> file, each node is defined using the <code class="literal">worker.[n]</code> naming convention, where <code class="literal">n</code> represents an arbitrary name you choose for each web server container. For each worker, you must specify the hostname (or IP address) and the port number <a id="id1077" class="indexterm"/>of the AJP13 connector running<a id="id1078" class="indexterm"/> in the web server.</p><p>The<a id="id1079" class="indexterm"/> load balancer type <code class="literal">lb</code> means that workers perform weighted round-robin load balancing with sticky sessions.</p><p>You will need to restart Apache after modifying the <code class="literal">worker.properties</code> file. Take a look at the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo /etc/init.d/apache2 restart</strong></span>
</pre></div><p>In WildFly, the default configuration in the <code class="literal">ha</code> profiles already defines the AJP connector. If you are not using one of the <code class="literal">ha</code> profiles, for example, you are using <code class="literal">standalone.xml</code>, you need to add the following highlighted line:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;buffer-cache name="default"/&gt;
    &lt;server name="default-server"&gt;
<span class="strong"><strong>        &lt;ajp-listener name="ajp" socket-binding="ajp"/&gt;</strong></span>
        &lt;http-listener name="default" socket-binding="http"/&gt;
        ....
    &lt;/server&gt;
&lt;/subsystem&gt;</pre></div><p>The AJP connector is also already defined in the <code class="literal">socket-binding-group</code> element in the ha profiles. Again, for the non-ha profiles, you will need the AJP configuration. In the following code snippet, you can see that the AJP connector is listening on port number 8009. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="0"&gt;
    &lt;socket-binding name="management-http" interface="management" port="9990"/&gt;
    &lt;socket-binding name="management-https" interface="management" port="9993"/&gt;
<span class="strong"><strong>    &lt;socket-binding name="ajp" port="8009"/&gt;</strong></span>
    ...
&lt;/socket-binding-group&gt;</pre></div><p>Once you set up this configuration, you should refresh the page showing you the Apache welcome page. It will now show the WildFly welcome page. This proves that Apache is directing the requests to WildFly. Stop one of the WildFly servers and refresh the page once more. You will continue to see the WildFly welcome page, as all requests are now being directed to the other WildFly server.</p></div></div><div class="section" title="Configuring mod_proxy"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec103"/>Configuring mod_proxy</h2></div></div></div><p>In WildFly, there is support for an optional module named <code class="literal">mod_proxy</code>. When installed, it can be <a id="id1080" class="indexterm"/>configured so that Apache acts as a<a id="id1081" class="indexterm"/> proxy server. This can be used to forward requests to<a id="id1082" class="indexterm"/> a particular web application server, such as WildFly, without having to configure a web connector, such as <code class="literal">mod_jk</code>.</p><p>To install and enable <code class="literal">mod_proxy</code>, you need to run the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install libapache2-mod-proxy-html</strong></span>
<span class="strong"><strong>sudo a2enmod proxy-http</strong></span>
</pre></div><p>Then, you need to include these two directives in your default site file. You need to do this for each web application that you wish to forward to WildFly for example, to forward an application with a context path of <code class="literal">/app</code>. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">ProxyPass         /app  http://localhost:8080/app
ProxyPassReverse  /app  http://localhost:8080/app</pre></div><p>This tells Apache to forward URLs matching <code class="literal">http://localhost/app/*</code> to the WildFly HTTP connector listening on port number 8080.</p><div class="mediaobject"><img src="graphics/6232OS_09_03.jpg" alt="Configuring mod_proxy"/></div><p>As shown in the preceding diagram, Apache's <code class="literal">mod_proxy</code> is TCP-based and uses HTTP, so you don't need to add anything else within your WildFly configuration. On top of this, there is also support for another module, <code class="literal">mod_proxy_ajp</code>. This module can be used in much the same way as <code class="literal">mod_proxy</code> except that it uses the AJP protocol to proxy Apache requests to WildFly. Before you can use it, you will need to enable it as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo a2enmod proxy-ajp</strong></span>
</pre></div><p>Then, add the highlighted lines to your virtual host in the default site file:</p><div class="informalexample"><pre class="programlisting">&lt;VirtualHost *:80&gt;
        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

<span class="strong"><strong>        ProxyPass / ajp://localhost:8009/</strong></span>
<span class="strong"><strong>        ProxyPassReverse / ajp://localhost:8009/</strong></span>

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;</pre></div><p>Here, we <a id="id1083" class="indexterm"/>simply redirect all traffic (<code class="literal">/</code>) to the <a id="id1084" class="indexterm"/>web server listening on localhost at port number 8009. Take<a id="id1085" class="indexterm"/> a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_04.jpg" alt="Configuring mod_proxy"/></div><p>Again, if you use a non-ha profile, you need to add the AJP listener to your Undertow configuration, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;buffer-cache name="default"/&gt;
    &lt;server name="default-server"&gt;
<span class="strong"><strong>        &lt;ajp-listener name="ajp" socket-binding="ajp"/&gt;</strong></span>
        &lt;http-listener name="default" socket-binding="http"/&gt;
        ....
    &lt;/server&gt;
&lt;/subsystem&gt;</pre></div><p>Then, you need to add the AJP port as a socket-binding element, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="0"&gt;
     &lt;socket-binding name="management-http" interface="management" port="9990"/&gt;
     &lt;socket-binding name="management-https" interface="management" port="9993"/&gt;
<span class="strong"><strong>    &lt;socket-binding name="ajp" port="8009"/&gt;</strong></span>
    ....
&lt;/socket-binding-group&gt;</pre></div></div></div></div>
<div class="section" title="Load-balancing with mod_cluster"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec50"/>Load-balancing with mod_cluster</h1></div></div></div><p>The <code class="literal">mod_cluster</code> is an HTTP-based load balancer, which, like <code class="literal">mod_jk</code>, can be used to forward<a id="id1086" class="indexterm"/> requests to a set of application server instances. There <a id="id1087" class="indexterm"/>are several advantages of using <code class="literal">mod_cluster</code> over <code class="literal">mod_jk</code> or <code class="literal">mod_proxy</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Dynamic <a id="id1088" class="indexterm"/>clustering configuration</li><li class="listitem" style="list-style-type: disc">Better load balancing due to the ability to use server-side load metrics</li><li class="listitem" style="list-style-type: disc">Better integration with the application life cycle</li><li class="listitem" style="list-style-type: disc">AJP is optional</li></ul></div><p>When using a standard load balancer, such as <code class="literal">mod_jk</code>, you have to provide a static list of nodes that are used to spread load. This process is inconvenient, especially if you want to dynamically add or remove nodes depending on the amount of traffic around your application. In addition to this, using a flat cluster configuration can be tedious and prone to error, especially if you have a high number of nodes in your cluster.</p><p>When using <code class="literal">mod_cluster</code>, nodes are dynamically added to, or removed from, your cluster. To achieve this, each WildFly server communicates its life cycle state to Apache.</p><p>Apache sends UDP messages, the so-called advertisements, on a multicast group. Each of the WildFly servers in the cluster subscribes to this group. It is via this group that WildFly is informed about HTTP proxies (Apache in this case). Then, each WildFly instance notifies the HTTP proxies about their availability, and then the proxy adds them to a list of nodes. Should a WildFly server be removed, the other WildFly servers in the group will be notified.</p><p>The following diagram helps illustrate this concept:</p><div class="mediaobject"><img src="graphics/6232OS_09_05.jpg" alt="Load-balancing with mod_cluster"/></div><p>Another<a id="id1089" class="indexterm"/> key feature of <code class="literal">mod_cluster</code> resides in the load <a id="id1090" class="indexterm"/>metrics. Load metrics are determined on the server side and are then sent to the Apache side as circumstances change. As a consequence, <code class="literal">mod_cluster</code> provides a far more robust architecture than traditional HTTPD-based load balancers, where metrics are statically held on the proxy.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip32"/>Tip</h3><p>For more information on how server-side load metrics are calculated, refer to the <code class="literal">mod_cluster</code> documentation<a id="id1091" class="indexterm"/> at <a class="ulink" href="http://docs.jboss.org/mod_cluster/1.2.0/html/java.load.html">http://docs.jboss.org/mod_cluster/1.2.0/html/java.load.html</a>.</p></div></div><p>Another advantage of using <code class="literal">mod_cluster</code> is the ability to intercept life cycle events, such as undeployment and redeployment. As mentioned previously in this section, these are synchronized between Apache and the nodes in the cluster.</p></div>
<div class="section" title="Installing mod_cluster libraries"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec51"/>Installing mod_cluster libraries</h1></div></div></div><p>There are<a id="id1092" class="indexterm"/> two things to consider when installing and configuring <code class="literal">mod_cluster</code>. The first involves the WildFly configuration, and the second involves downloading and installing the <code class="literal">mod_cluster</code> libraries to Apache. We will look at WildFly first, as it is preconfigured, and then move on to the installation of <code class="literal">mod_cluster</code>.</p><p>Bundled in your WildFly installation, you will find the mod_cluster 1.3.0 module. This subsystem is included as part of the clustering configuration in both the <code class="literal">standalone-ha.xml</code> and <code class="literal">domain.xml</code> configuration files, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;mod-cluster-config advertise-socket="modcluster" connector="ajp"&gt;
        &lt;dynamic-load-provider&gt;
            &lt;load-metric type="cpu"/&gt;
        &lt;/dynamic-load-provider&gt;
    &lt;/mod-cluster-config&gt;
&lt;/subsystem&gt;</pre></div><p>The<a id="id1093" class="indexterm"/> preceding default configuration references its <code class="literal">socket-binding</code> through the <code class="literal">advertise-socket</code> element:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding name="modcluster" port="0" multicast-address="224.0.1.105" multicast-port="23364"/&gt;</pre></div><p>Also, note<a id="id1094" class="indexterm"/> that the default configuration uses the AJP protocol. The <code class="literal">connector</code> property references the name of the Undertow listener that the <code class="literal">mod_cluster</code> reverse proxy will connect to. The following is the Undertow configuration with the <code class="literal">ajp-listener</code> highlighted:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;buffer-cache name="default"/&gt;
    &lt;server name="default-server"&gt;
<span class="strong"><strong>        &lt;ajp-listener name="ajp" socket-binding="ajp"/&gt;</strong></span>
        &lt;http-listener name="default" socket-binding="http"/&gt;
        ....
    &lt;/server&gt;
&lt;/subsystem&gt;</pre></div><p>You will also need to ensure that your interfaces are correctly configured to the IP of the server your WildFly server(s) is/are running on. Update your <code class="literal">hosts.xml</code> or <code class="literal">standalone-ha.xml</code> file, replacing the IP with the your server's IP:</p><div class="informalexample"><pre class="programlisting">&lt;interfaces&gt;
    &lt;interface name="management"&gt;
        &lt;inet-address value="178.62.50.168"/&gt;
    &lt;/interface&gt;
    &lt;interface name="public"&gt;
        &lt;inet-address value="178.62.50.168"/&gt;
    &lt;/interface&gt;
&lt;/interfaces&gt;</pre></div><p>Let's now move on to the second part—the installation and configuration of <code class="literal">mod_cluster</code> within Apache.</p><p>If you do not have Apache installed, you should follow the instructions from earlier in this chapter (see the <span class="emphasis"><em>Installing Apache</em></span> section). We first need to install the required Apache modules. These modules are used to interact with <code class="literal">mod_cluster</code> on WildFly.</p><p>In this <a id="id1095" class="indexterm"/>example, we are using Apache 2.2, which requires Version 1.2.x of <code class="literal">mod_cluster</code>. If you are using Apache 2.4, then you can use a later version <a id="id1096" class="indexterm"/>of <code class="literal">mod_cluster</code>, namely Version 1.3.x. You can also use Version 1.2.x, but it will need to be compiled for Apache 2.4. To see your version of Apache, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>apache2ctl -V</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip33"/>Tip</h3><p>At the time<a id="id1097" class="indexterm"/> of writing, 1.3.x binaries were not available from the download site, so you might need to compile them from the source (<a class="ulink" href="https://github.com/modcluster/mod_cluster/tree/master">https://github.com/modcluster/mod_cluster/tree/master</a>)..</p><p>Please check the download site before deciding to go down the route of compiling the source. If you wish to compile the module, you should check <a class="ulink" href="http://www.openlogic.com/blog/bid/247607/JBoss-AS7-Clustering-Using-mod_cluster-and-http-2-4-Part-1">http://www.openlogic.com/blog/bid/247607/JBoss-AS7-Clustering-Using-mod_cluster-and-http-2-4-Part-1</a>.</p></div></div><p>Go <a id="id1098" class="indexterm"/>to the download site (<a class="ulink" href="http://mod-cluster.jboss.org/downloads">http://mod-cluster.jboss.org/downloads</a>), and select the binaries for your platform. Select <span class="strong"><strong>mod_cluster modules for httpd</strong></span>:</p><div class="mediaobject"><img src="graphics/6232OS_09_06.jpg" alt="Installing mod_cluster libraries"/></div><p>Once the binaries have been downloaded, you need to extract the archive to the <code class="literal">module</code> directory in Apache. When you extract the downloaded archive, you should see the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">mod_advertise.so</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mod_manager.so</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mod_proxy_cluster.so</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mod_slotmem.so</code></li></ul></div><p>You can <a id="id1099" class="indexterm"/>run the following commands to achieve this. The first one<a id="id1100" class="indexterm"/> downloads the file from the <code class="literal">mod_cluster</code> website using the URL from the download page. The second one extracts the TAR file, and the final command copies the libraries to the <code class="literal">modules</code> directory.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wget -c http://downloads.jboss.org/mod_cluster/1.2.6.Final/linux-x86_64/mod_cluster-1.2.6.Final-linux2-x64-so.tar.gz</strong></span>
<span class="strong"><strong>tar -xzvf mod_cluster-1.2.6.Final-linux2-x64-so.tar.gz</strong></span>
<span class="strong"><strong>cp ./*.so /usr/lib/apache2/modules</strong></span>
</pre></div><div class="section" title="The mod_cluster configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec104"/>The mod_cluster configuration</h2></div></div></div><p>Next, we<a id="id1101" class="indexterm"/> need to create two files within the <code class="literal">/etc/apache2/mods-available</code> directory. The first one is called <code class="literal">mod_cluster.load</code> and contains the list of libraries this module depends on. The following is the complete content of the file:</p><div class="informalexample"><pre class="programlisting">LoadModule proxy_module /usr/lib/apache2/modules/mod_proxy.so
LoadModule proxy_http_module /usr/lib/apache2/modules/mod_proxy_http.so
LoadModule proxy_ajp_module /usr/lib/apache2/modules/mod_proxy_ajp.so
LoadModule slotmem_module /usr/lib/apache2/modules/mod_slotmen.so

LoadModule manager_module /usr/lib/apache2/modules/mod_manager.so
LoadModule proxy_cluster_module /usr/lib/apache2/modules/mod_proxy_cluster.so
LoadModule advertise_module /usr/lib/apache2/modules/mod_advertise.so</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note69"/>Note</h3><p>The <code class="literal">slotmen</code> module name has changed from <code class="literal">mod_slotmen.so</code> to <code class="literal">mod_cluster_slotmen.so</code> in Version 1.3.x.</p></div></div><p>This list contains the four libraries we just copied to the <code class="literal">module</code> folder, and the pre-existing <code class="literal">mod_proxy</code> libraries.</p><p>Each of these modules performs a specific role within the load-balancing functionality. The core <a id="id1102" class="indexterm"/>modules are <code class="literal">mod_proxy</code>, <code class="literal">mod_proxy_ajp</code>, and <code class="literal">mod_proxy_http</code>. They forward requests to cluster nodes using either the HTTP/HTTPS protocol or the AJP protocol.</p><p>Next, <code class="literal">mod_manager</code> is a module that reads information from WildFly and updates the shared memory information in conjunction with <code class="literal">mod_slotmem</code>. The <code class="literal">mod_proxy_cluster</code> is the module that contains the balancer for <code class="literal">mod_proxy</code>. Finally, <code class="literal">mod_advertise</code> is an additional module that allows HTTPD to advertise via multicast packets, the IP, and port number where the <code class="literal">mod_cluster</code> is listening.</p><p>The next file we need to create is called <code class="literal">mod_cluster.conf</code>. This file is placed alongside <code class="literal">mod_cluster.load</code> within the <code class="literal">/etc/apache2/mods-available</code> directory, as follows:</p><div class="informalexample"><pre class="programlisting">CreateBalancers 1

&lt;IfModule manager_module&gt;
    Listen 127.0.1.1:6666
    ManagerBalancerName mycluster

    &lt;VirtualHost 127.0.1.1:6666&gt; 
        KeepAliveTimeout 300
        MaxKeepAliveRequests 0
        AdvertiseFrequency 5
        ServerAdvertise On
        EnableMCPMReceive

        &lt;Location /&gt;
            Order deny,allow
            Allow from 127.0.1
        &lt;/Location&gt;

    &lt;/VirtualHost&gt;
&lt;/IfModule&gt;</pre></div><p>You have to replace the <code class="literal">127.0.1.1</code> IP address with the IP address that WildFly uses to connect to Apache. If your Apache and WildFly are on different servers, then it will be the IP of your Apache server. You also need to update the port value of 6666 with the one you want to use for communicating with WildFly.</p><p>As the configuration currently stands, the Apache virtual host allows incoming requests from:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">IP addresses with prefix <code class="literal">127.0.1</code></li><li class="listitem" style="list-style-type: disc">The sub-network <code class="literal">127.0.1.0/24</code></li></ul></div><p>The <code class="literal">CreateBalancers</code> directive configures how the HTTP balancers are created in virtual hosts. The possible values of <code class="literal">CreateBalancers</code> are <code class="literal">0</code>, <code class="literal">1</code>, and <code class="literal">2</code>, outlined as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">0</code>: Creates balancers in all virtual hosts</li><li class="listitem" style="list-style-type: disc"><code class="literal">1</code>: Does not create any balancers</li><li class="listitem" style="list-style-type: disc"><code class="literal">2</code>: Creates a balancer for the main server only</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note70"/>Note</h3><p>Setting <code class="literal">CreateBalancers</code> to <code class="literal">1</code> means that you must configure a balancer in the <code class="literal">ProxyPass</code> directive (shown further in the chapter). For more information, please see this link: <a class="ulink" href="http://docs.jboss.org/mod_cluster/1.2.0/html/native.config.html#d0e485">http://docs.jboss.org/mod_cluster/1.2.0/html/native.config.html#d0e485</a>
</p></div></div><p>The <code class="literal">KeepAliveTimeout</code> directive allows the same connection to be reused within 300 seconds. The<a id="id1103" class="indexterm"/> number of requests per connection is unlimited since we are setting <code class="literal">MaxKeepAliveRequests</code> to <code class="literal">0</code>. The <code class="literal">ManagerBalancerName</code> directive provides the balancer name for your cluster (defaults to <code class="literal">mycluster</code>).</p><p>What is most important for us is the <code class="literal">ServerAdvertise</code> directive. It uses the advertise mechanism to tell WildFly to whom it should send the cluster information.</p><p>You can also refine the time elapsed between multicasting advertising messages with the <code class="literal">AdvertiseFrequency</code> directive, which defaults to 10 seconds.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip34"/>Tip</h3><p>
<span class="strong"><strong>Overview of the advertising</strong></span> <span class="strong"><strong>mechanism</strong></span>
</p><p>The default multicast IP address and port used for advertising is <code class="literal">224.0.1.105:23364</code>. These values match the WildFly bindings defined in the following socket-binding named <code class="literal">modcluster</code>:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding name="modcluster" port="0" multicast-address="224.0.1.105" multicast-port="23364"/&gt;</pre></div><p>If you ever change these values in WildFly, you will also have to match it on the HTTPD side with the <code class="literal">AdvertiseGroup</code> directive:</p><div class="informalexample"><pre class="programlisting">AdvertiseGroup 224.0.1.105:23364</pre></div></div></div><p>The very last thing you need to configure is the virtual host in your site configuration file. Create a file called <code class="literal">wildfly</code> within the <code class="literal">/etc/apache2/sites-enabled</code> directory. Add the following highlighted code lines:</p><div class="informalexample"><pre class="programlisting">&lt;VirtualHost *:80&gt;
    ServerAdmin webmaster@localhost

<span class="strong"><strong>    ProxyPass / balancer://mycluster stickysession=JSESSIONID|jsessionid nofailover=On</strong></span>
<span class="strong"><strong>    ProxyPassReverse / balancer://mycluster</strong></span>

    &lt;Location /&gt;
        Order deny,allow
        Allow from All
    &lt;/Location&gt;

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;</pre></div><p>As<a id="id1104" class="indexterm"/> a final note, if you have not already enabled <code class="literal">proxy_ajp</code> and <code class="literal">proxy_http</code>, you will need to do so in order for <code class="literal">mod_cluster</code> to work, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>a2enmod proxy proxy_ajp proxy_http</strong></span>
</pre></div><p>You can now enable the WildFly site:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo a2ensite wildfly</strong></span>
</pre></div><p>Now, enable the <code class="literal">mod_cluster</code> module and restart Apache:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo a2enmod mod_cluster</strong></span>
<span class="strong"><strong>sudo /etc/init.d/apache2 restart</strong></span>
</pre></div></div><div class="section" title="Testing mod_cluster"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec105"/>Testing mod_cluster</h2></div></div></div><p>To<a id="id1105" class="indexterm"/> verify that everything works correctly, start your WildFly domain ensuring that your server group is using an <code class="literal">ha</code> profile. Deploy the application we used in <a class="link" href="ch04.html" title="Chapter 4. The Undertow Web Server">Chapter 4</a>, <span class="emphasis"><em>The Undertow Web Server</em></span>, to that same server group. If all is configured correctly, you should see the application when you navigate to the context root <code class="literal">chapter4</code> at <code class="literal">http://178.62.50.168/chapter4</code>.</p><div class="mediaobject"><img src="graphics/6232OS_09_07.jpg" alt="Testing mod_cluster"/></div></div></div>
<div class="section" title="Managing mod_cluster via the CLI"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec52"/>Managing mod_cluster via the CLI</h1></div></div></div><p>There<a id="id1106" class="indexterm"/> are a couple of tools that can be used to manage <a id="id1107" class="indexterm"/>and retrieve runtime information from your cluster. Your first option is the command-line management interface, which allows you to investigate the <code class="literal">mod_cluster</code> subsystem.</p><p>The first command you need to learn is <code class="literal">list-proxies</code>, which returns merely the hostnames (and port) of the connected proxies:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[domain@localhost:9990 /] /host=master/server=server-one/subsystem=modcluster:list-proxies</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "outcome" =&gt; "success",</strong></span>
<span class="strong"><strong>    "result" =&gt; ["apache-wildfly:6666"]</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>While this can be useful for a quick inspection of your cluster members, you can get more detailed information with the <code class="literal">read-proxies-info</code> command that actually sends an information message to the HTTPD server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[domain@localhost:9990 /] /host=master/server=server-one/subsystem=modcluster:read-proxies-info</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "outcome" =&gt; "success",</strong></span>
<span class="strong"><strong>    "result" =&gt; [</strong></span>
<span class="strong"><strong>        "apache-wildfly:6666",</strong></span>
<span class="strong"><strong>        "Node: [1],Name: master:server-two,Balancer: mycluster,LBGroup: ,Host: 178.62.50.168,Port: 8159,Type: ajp,Flushpackets: Off,Flushwait: 10,Ping: 10,Smax: 26,Ttl: 60,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: 97</strong></span>
<span class="strong"><strong>Node: [2],Name: master:server-one,Balancer: mycluster,LBGroup: ,Host: 178.62.50.168,Port: 8009,Type: ajp,Flushpackets: Off,Flushwait: 10,Ping: 10,Smax: 26,Ttl: 60,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: 98</strong></span>
<span class="strong"><strong>Vhost: [1:1:1], Alias: localhost</strong></span>
<span class="strong"><strong>Vhost: [1:1:2], Alias: default-host</strong></span>
<span class="strong"><strong>Vhost: [2:1:3], Alias: localhost</strong></span>
<span class="strong"><strong>Vhost: [2:1:4], Alias: default-host</strong></span>
<span class="strong"><strong>Context: [1:1:1], Context: /chapter4, Status: ENABLED</strong></span>
<span class="strong"><strong>Context: [2:1:2], Context: /chapter4, Status: ENABLED</strong></span>
<span class="strong"><strong>"</strong></span>
<span class="strong"><strong>    ]</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>The <code class="literal">mod_cluster</code> subsystem also allows us to use the <code class="literal">read-proxies-configuration</code> command, which provides more verbose information about your cluster. For the sake of brevity, we will omit printing its output.</p><p>The<a id="id1108" class="indexterm"/> list of proxies that are part of your cluster can <a id="id1109" class="indexterm"/>also be modified with the CLI. For example, you can use<a id="id1110" class="indexterm"/> the <code class="literal">add-proxy</code> command to add a proxy that has not been captured by the mod_cluster's <code class="literal">httpd</code> configuration. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[domain@localhost:9990 /] /host=master/server=server-one/subsystem=modcluster:add-proxy(host=192.168.0.11, port=9999)</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "outcome" =&gt; "success"</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>You can also remove proxies from the list using the corresponding <code class="literal">remove-proxy</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[domain@localhost:9990 /] /host=master/server=server-one/subsystem=modcluster:remove-proxy(host=192.168.0.11, port=9999)</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "outcome" =&gt; "success"</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></div>
<div class="section" title="Managing your web contexts with the CLI"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec53"/>Managing your web contexts with the CLI</h1></div></div></div><p>You <a id="id1111" class="indexterm"/>can use the CLI to manage your web contexts. For <a id="id1112" class="indexterm"/>example, the <code class="literal">enable-context</code> command can be used to tell Apache that a particular web context is able to receive requests, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[standalone@localhost:9990 subsystem=modcluster] :enable-context(context=/app, virtualhost=default-host)</strong></span>
<span class="strong"><strong>{"outcome" =&gt; "success"}</strong></span>
</pre></div><p>The <a id="id1113" class="indexterm"/>corresponding <code class="literal">disable-context</code> command <a id="id1114" class="indexterm"/>can be used to prevent Apache from sending <span class="emphasis"><em>new</em></span> requests:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[standalone@localhost:9990 subsystem=modcluster] :disable-context(context=/app, virtualhost=default-host)</strong></span>
<span class="strong"><strong>{"outcome" =&gt; "success"}</strong></span>
</pre></div><p>To stop Apache from sending requests from a web context, you can use the <code class="literal">stop-context</code> command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[standalone@localhost:9990 subsystem=modcluster] :stop-context(context=/app, virtualhost=default-host, waittime=50)</strong></span>
<span class="strong"><strong>{"outcome" =&gt; "success"}</strong></span>
</pre></div></div>
<div class="section" title="Adding native management capabilities"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec54"/>Adding native management capabilities</h1></div></div></div><p>If you <a id="id1115" class="indexterm"/>are not able (or simply don't want) to use the CLI, then you can also configure the Apache web server to provide a basic management interface through the browser.</p><p>In order to do that, all you need to add is the <code class="literal">mod_cluster_manager</code> application context, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;Location /mod_cluster_manager&gt;
       SetHandler mod_cluster-manager
       Order deny,allow
       Deny from all
       Allow from 192.168.10
&lt;/Location&gt;</pre></div><p>You can test your <code class="literal">mod_cluster</code> manager application by navigating to <code class="literal">http://192.168.10.1/http://192.168.10.1/mod_cluster_manager</code>.</p><p>In our example, the <code class="literal">mod_cluster</code> manager displays information about all the WildFly nodes that have been discovered through multicast announcements. Take a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_08.jpg" alt="Adding native management capabilities"/></div><p>In the <code class="literal">mod_cluster</code> manager page, you have lots of useful information, such as the number<a id="id1116" class="indexterm"/> of hosts that are currently active (in our example, two nodes) and the web contexts that are available. By default, all web contexts are mounted automatically (not requiring an explicit mount as for <code class="literal">mod_jk</code>), but you can exclude or include them by clicking on the <span class="strong"><strong>Disable</strong></span>/<span class="strong"><strong>Enable</strong></span> link, which is placed next to the web context.</p></div>
<div class="section" title="Managing web contexts using the configuration file"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec55"/>Managing web contexts using the configuration file</h1></div></div></div><p>For the <a id="id1117" class="indexterm"/>sake of completeness, we will <a id="id1118" class="indexterm"/>add one more option that can be used to manage your web context using your application server configuration file. By default, all web contexts are enabled; however, you can exclude web contexts from the main configuration file using the <code class="literal">excluded-contexts</code> directive. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;mod-cluster-config excluded-contexts="ROOT, webapp1"/&gt;
&lt;/subsystem&gt;</pre></div></div>
<div class="section" title="Troubleshooting mod_cluster"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec56"/>Troubleshooting mod_cluster</h1></div></div></div><p>Installing<a id="id1119" class="indexterm"/> and enabling <code class="literal">mod_cluster</code> on Apache requires just a few steps to get working. However, should you have problems, you can allow a verbose output, which will cause an overview of your configuration to be displayed. Add the <code class="literal">AllowDisplay</code> directive to your <code class="literal">mod_cluster_manager</code> application context as highlighted as follows:</p><div class="informalexample"><pre class="programlisting">&lt;Location /mod_cluster_manager&gt; 
    SetHandler mod_cluster-manager 
    Order deny,allow 
    Deny from all 
    Allow from 192.168.10 
&lt;/Location&gt; 

<span class="strong"><strong>AllowDisplay On</strong></span>
</pre></div><p>When adding this directive, you will get further information about the modules loaded into HTTPD. This output may help you narrow down any issues, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_09.jpg" alt="Troubleshooting mod_cluster"/></div><p>One more possible cause of errors is a firewall preventing the broadcast of advertising messages. Remember that advertisement messages use the UDP port number 23364 and the multicast address 224.0.1.105. In order to verify if advertising is an issue, you can try to turn it off by setting the following in the HTTPD side:</p><div class="informalexample"><pre class="programlisting">ServerAdvertise Off</pre></div><p>This directive should be matched on the application server side by the <code class="literal">proxy-list</code> element. This element defines the list of HTTPD servers with which the WildFly server will initially communicate:</p><div class="informalexample"><pre class="programlisting">&lt;mod-cluster-config proxy-list="192.168.10.1:6666"&gt;
  ...
&lt;/mod-cluster-config&gt;</pre></div><p>If there is more than one proxy, then the <code class="literal">proxy-list</code> will contain a comma-separated list.</p><p>You can also check that <code class="literal">mod_cluster</code> is correctly advertising messages by running a test class <code class="literal">Advertise</code>, which <a id="id1120" class="indexterm"/>can be found at <a class="ulink" href="https://github.com/modcluster/mod_cluster/blob/master/test/java/Advertize.java">https://github.com/modcluster/mod_cluster/blob/master/test/java/Advertize.java</a>. You will need to compile the class and then run it as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>java Advertise 224.0.1.105 23364</strong></span>
</pre></div><p>If the module, that is, advertizing, is correctly configured, you will see something like the following command lines displayed:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>received from /192.168.0.10:23364</strong></span>
<span class="strong"><strong>received: HTTP/1.0 200 OK</strong></span>
<span class="strong"><strong>Date: Sat, 26 Jul 2014 20:03:12 GMT</strong></span>
<span class="strong"><strong>Sequence: 121</strong></span>
<span class="strong"><strong>Digest: 4dedd3761d451227f36534b63ca2a8a1</strong></span>
<span class="strong"><strong>Server: b23584e2-314f-404d-8fde-05069bfe5dc7</strong></span>
<span class="strong"><strong>X-Manager-Address: 127.0.1.1:6666</strong></span>
<span class="strong"><strong>X-Manager-Url: /b23584e2-314f-404d-8fde-05069bfe5dc7</strong></span>
<span class="strong"><strong>X-Manager-Protocol: http</strong></span>
<span class="strong"><strong>X-Manager-Host: 127.0.1.1</strong></span>
</pre></div><p>Finally, don't <a id="id1121" class="indexterm"/>forget to check the error log in the Apache <code class="literal">logs</code> directory for any errors.</p><p>Also, make sure that you have enabled the <code class="literal">mod_proxy_http</code> module, as <code class="literal">mod_cluster</code> will fail to work without it.</p></div>
<div class="section" title="Load-balancing between nodes"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec57"/>Load-balancing between nodes</h1></div></div></div><p>We will run <a id="id1122" class="indexterm"/>a couple of tests in order to investigate how <code class="literal">mod_cluster</code> distributes the load between several different clients.</p><p>For these tests, we will use a very basic web application. The application source can be found with the source code for this book; the project is called <code class="literal">chapter9-balancer</code>. It contains a simple <code class="literal">index.jsp</code> page, which dumps a message on the console:</p><div class="informalexample"><pre class="programlisting">&lt;%
Integer counter = (Integer)session.getAttribute("counter");
if (counter == null) {
  session.setAttribute("counter",new Integer(1));
}
else {
  session.setAttribute("counter",new Integer(counter+1));
}
System.out.println("Counter"+session.getAttribute("counter"));          
%&gt;</pre></div><p>After deploying the application, go to the URL <code class="literal">http://192.168.0.10/balancer/index.jsp</code>. After making several requests, you will see that each subsequent request is sent to the same server. This shows that <code class="literal">mod_cluster</code> follows a sticky-session policy. Have a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_10.jpg" alt="Load-balancing between nodes"/></div><p>For the <a id="id1123" class="indexterm"/>purpose of our tests, we need a software application that can be used to launch several requests to our cluster. We will use JMeter, a Java <a id="id1124" class="indexterm"/>desktop application, which is generally<a id="id1125" class="indexterm"/> used to test load, test functional behavior, and measure performance. JMeter can be downloaded from <a class="ulink" href="http://jmeter.apache.org/download_jmeter.cgi">http://jmeter.apache.org/download_jmeter.cgi</a>.</p><p>In short, a JMeter test plan consists of one or more thread groups, logic controllers, listeners, timers, assertions, and configuration elements.</p><p>For the purpose of our example, we will just create the following elements:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A <span class="strong"><strong>Thread Group</strong></span>, which is configured to run 100 subsequent requests</li><li class="listitem" style="list-style-type: disc">An <span class="strong"><strong>HTTP Request</strong></span> element that contains information about the web application's end point</li></ul></div><p>To do this, open JMeter and navigate to <span class="strong"><strong>Test Plan</strong></span> | <span class="strong"><strong>Add</strong></span> | <span class="strong"><strong>Threads</strong></span> | <span class="strong"><strong>Thread Group</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_11.jpg" alt="Load-balancing between nodes"/></div><p>Set the number of threads (users) to 100. Now right-click on the newly created <span class="strong"><strong>Thread Group </strong></span>| <span class="strong"><strong>Add</strong></span> | <span class="strong"><strong>Sampler</strong></span> | <span class="strong"><strong>HTTP Request</strong></span>. In here, add the server IP and path, as shown to the right-hand side of the following screenshot. The port number can be left blank as it defaults to port number 80. Take a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_12.jpg" alt="Load-balancing between nodes"/></div><p>Additionally, you should add a <span class="strong"><strong>Listener</strong></span> element that collates the test plan result into a table/graph<a id="id1126" class="indexterm"/> in order for you to view the results. To do this, navigate to <span class="strong"><strong>HTTP Request</strong></span> | <span class="strong"><strong>Add</strong></span> | <span class="strong"><strong>Listener</strong></span> | <span class="strong"><strong>View Results in Table</strong></span>. Now, from the top menu, navigate to <span class="strong"><strong>Run</strong></span> | <span class="strong"><strong>Start</strong></span>, and the JMeter test will be executed.</p><p>Running the test shows that the requests are roughly split between the two servers. Have a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_13.jpg" alt="Load-balancing between nodes"/></div><div class="section" title="Using load metrics"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec106"/>Using load metrics</h2></div></div></div><p>Various <a id="id1127" class="indexterm"/>system load metrics are <a id="id1128" class="indexterm"/>collected from each server. These statistics allow a normalized load value to be calculated for each server. When the cluster is under light load, the incoming requests are evenly distributed to each server node. As the load increases, the amount of traffic sent to a given node depends on its current load, that is, more traffic will be directed to the node that has the least load.</p><p>The <a id="id1129" class="indexterm"/>default <code class="literal">mod_cluster</code> configuration<a id="id1130" class="indexterm"/> is configured with a dynamic load provider, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;mod-cluster-config advertise-socket="modcluster" connector="ajp"&gt;
        &lt;dynamic-load-provider&gt;
            &lt;load-metric type="cpu"/&gt;
        &lt;/dynamic-load-provider&gt;
    &lt;/mod-cluster-config&gt;
&lt;/subsystem&gt;</pre></div><p>You can customize load balancing by adding further <code class="literal">load-metric</code> elements. For example:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
  &lt;mod-cluster-config advertise-socket="modcluster" connector="ajp"&gt;
    &lt;dynamic-load-provider history="10" decay="2"&gt;
       &lt;load-metric type="cpu" weight="2" capacity="1"/&gt;
<span class="strong"><strong>                 &lt;load-metric type="sessions" weight="1" capacity="512"/&gt;</strong></span>
    &lt;/dynamic-load-provider&gt;
  &lt;/mod-cluster-config&gt;
&lt;/subsystem&gt;</pre></div><p>The most important factors when computing load balancing are the <code class="literal">weight</code> and <code class="literal">capacity</code> properties. The <code class="literal">weight</code> (the default is <code class="literal">1</code>) indicates the impact of a metric with respect to the other metrics. In the previous example, the CPU metric will have twice the impact compared to the sessions that have a load factor metric of <code class="literal">1</code>.</p><p>The <code class="literal">capacity</code> property, on the other hand, can be used for a fine-grained control over the load metrics. By setting a different capacity to each metric, you can actually favor one node over another while preserving the metric weights.</p><p>The list of supported load metrics is summarized in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Metric</p>
</th><th style="text-align: left" valign="bottom">
<p>Factor used to compose metric</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>cpu</p>
</td><td style="text-align: left" valign="top">
<p>CPU load</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>heap</p>
</td><td style="text-align: left" valign="top">
<p>Heap memory usage as a percentage of max heap size</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>sessions</p>
</td><td style="text-align: left" valign="top">
<p>Number of web sessions</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>requests</p>
</td><td style="text-align: left" valign="top">
<p>Number of requests/sec</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>send-traffic</p>
</td><td style="text-align: left" valign="top">
<p>Number of outgoing requests in traffic</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>receive-traffic</p>
</td><td style="text-align: left" valign="top">
<p>Number of incoming requests post traffic</p>
</td></tr></tbody></table></div><p>The<a id="id1131" class="indexterm"/> preceding metrics can also <a id="id1132" class="indexterm"/>be set using the CLI, for example, supposing that you want to add a metric that is based on the amount of heap used by the proxy. Don't forget to reload the configuration when notified to do so (enter the <code class="literal">reload</code> command). Here's what you need to issue:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[standalone@localhost:9990 /] /subsystem=modcluster/mod-cluster-config=configuration/dynamic-load-provider=configuration/load-metric=heap:add(type=heap)</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "outcome" =&gt; "success",</strong></span>
<span class="strong"><strong>    "response-headers" =&gt; {</strong></span>
<span class="strong"><strong>        "operation-requires-reload" =&gt; true,</strong></span>
<span class="strong"><strong>        "process-state" =&gt; "reload-required"</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>[standalone@localhost:9990 /] /subsystem=modcluster/mod-cluster-config=configuration/dynamic-load-provider=configuration:read-resource()</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "outcome" =&gt; "success",</strong></span>
<span class="strong"><strong>    "result" =&gt; {</strong></span>
<span class="strong"><strong>        "decay" =&gt; 2,</strong></span>
<span class="strong"><strong>        "history" =&gt; 9,</strong></span>
<span class="strong"><strong>        "custom-load-metric" =&gt; undefined,</strong></span>
<span class="strong"><strong>        "load-metric" =&gt; {</strong></span>
<span class="strong"><strong>            "cpu" =&gt; undefined,</strong></span>
<span class="strong"><strong>            "heap" =&gt; undefined</strong></span>
<span class="strong"><strong>        }</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>You can also remove the metric using the <code class="literal">remove</code> command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[standalone@localhost:9990 /] /subsystem=modcluster/mod-cluster-config=configuration/dynamic-load-provider=configuration/load-metric=heap:remove()</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    "outcome" =&gt; "success",</strong></span>
<span class="strong"><strong>    "response-headers" =&gt; {</strong></span>
<span class="strong"><strong>        "operation-requires-reload" =&gt; true,</strong></span>
<span class="strong"><strong>        "process-state" =&gt; "reload-required"</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></div><div class="section" title="An example for setting dynamic metrics on a cluster"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec107"/>An example for setting dynamic metrics on a cluster</h2></div></div></div><p>In the <a id="id1133" class="indexterm"/>following example, we have a very simple cluster comprising two nodes. Each node has the same JVM operating defaults, and each one is running on two identical machines.</p><p>We will, however, simulate memory-intensive operations on the first node so that the amount of heap memory used differs between each server, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_09_14.jpg" alt="An example for setting dynamic metrics on a cluster"/></div><p>This is a common scenario in web applications where different circumstances have a different impact on each server's memory, for example, holding data temporarily in the HTTP session.</p><p>In such a case, using a round-robin approach to distribute a request may lead to an "out-of-memory" scenario on some nodes in your cluster. You can try to mitigate this by simply modifying the configuration of the loading metrics, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
  &lt;mod-cluster-config advertise-socket="mod_cluster"&gt;
    &lt;dynamic-load-provider history="10" decay="2"&gt;
       &lt;load-metric type="heap" weight="2" /&gt; 
       &lt;load-metric type="mem"  weight="1" /&gt;
       &lt;load-metric type="cpu"  weight="1" /&gt;
    &lt;/dynamic-load-provider&gt;
  &lt;/mod-cluster-config&gt;
&lt;/subsystem&gt;</pre></div><p>When using this configuration on both nodes, the heap memory usage has twice the impact of other enlisted metrics (operating system memory and CPU speed).</p><p>The outcome of this is that the second server handles 55 percent of the requests, while the first server handles 45 percent.</p><p>By<a id="id1134" class="indexterm"/> setting the appropriate capacity, you can further achieve a better level of granularity to node-weighting, for example, by setting a higher capacity on the first server, as follows:</p><div class="informalexample"><pre class="programlisting">       &lt;load-metric type="heap" weight="2" capacity="512"/&gt;</pre></div><p> You can set a lower capacity on the second one, as follows:</p><div class="informalexample"><pre class="programlisting">       &lt;load-metric type="heap" weight="2" capacity="1"/&gt;</pre></div><p>Then, the outcome of the test will be different, as the second server now delivers more responses than the first one, counterbalancing the weight metric.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note71"/>Note</h3><p>The capacity of each metric defaults to 512 and should be configured such that <code class="literal">0 &lt;= (load / capacity) &gt;= 1</code>.</p></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec58"/>Summary</h1></div></div></div><p>In this chapter, we showed various ways of distributing application load across a set of nodes. This is referred to as load balancing.</p><p>Load balancing requires a web server, such as Apache, which directs traffic to your various application servers.</p><p>In the first half of this chapter, we illustrated how to use the <code class="literal">mod_jk</code> and <code class="literal">mod_proxy</code> libraries in WildFly. The <code class="literal">mod_jk</code> library requires some configuration on both the HTTPD side and the AS side. The <code class="literal">mod_proxy</code> library is a more immediate solution and a preferred solution when using WildFly as it requires simply configuring the end points on the HTTPD side.</p><p>In the second half of the chapter, we looked at the recommended approach to load-balance calls between applications using <code class="literal">mod_cluster</code>.</p><p>The main advantage of using <code class="literal">mod_cluster</code> versus traditional load balancers is that it does not require a static list of worker nodes, rather, it registers application servers and their applications dynamically using a multicast-based advertising mechanism.</p><p>This is especially useful in a cloud environment, where you cannot rely on a flat list of nodes. It is much more beneficial to add or remove nodes on the fly.</p><p>Finally, another major benefit of <code class="literal">mod_cluster</code> is that you can use a dynamic set of metrics that are calculated on the server side to define the load between server nodes. For example, you can give priority to servers that have better specifications, such as higher RAM or better processing power.</p><p>In the next chapter, we are going to look at one of the most important parts of WildFly administration, that is, security.</p></div></body></html>