<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Configuring the Core WildFly Subsystems"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Configuring the Core WildFly Subsystems</h1></div></div></div><p>The first chapter gave us the basis to get started with WildFly 8. It is time for us to dive right into the configuration of WildFly and see how to manage a standalone instance of the application server. You will see that the entire server is configured within a single file.</p><p>The configuration file is made up of a list of subsystems, including the application server core services and standard Java EE services. It is not possible to discuss all the subsystems within a single chapter, so they have been divided over a couple of chapters. By the end of this chapter, you should understand and be able to configure:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The server configuration file <code class="literal">standalone.xml</code></li><li class="listitem" style="list-style-type: disc">The application server's thread pool</li><li class="listitem" style="list-style-type: disc">The application server's logging subsystem</li></ul></div><div class="section" title="Configuring our application server"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Configuring our application server</h1></div></div></div><p>The default <a id="id130" class="indexterm"/>configuration files are named <code class="literal">standalone.xml</code><a id="id131" class="indexterm"/>, for standalone servers, and <code class="literal">domain.xml</code><a id="id132" class="indexterm"/> for an application server domain. An application server domain can be seen as a specialized server configuration, which also includes the domain and host controller setup. We will discuss the application server domain in <a class="link" href="ch05.html" title="Chapter 5. Configuring a WildFly Domain">Chapter 5</a>, <span class="emphasis"><em>Configuring a WildFly Domain</em></span>. However, as far as the core services configuration is concerned, what we cover here will be suitable for the domain configuration as well. The configuration files (<code class="literal">standalone.xml</code> and <code class="literal">domain.xml</code>) are non-static files, which means that runtime changes are persisted to them, for example, adding a new component, such as a JMS destination, or deploying an application.</p><p>You can define as many configuration files as you need. The WildFly 8.1.0 release provides a few variants of <code class="literal">standalone.xml</code> (web profile), such as <code class="literal">standalone-full.xml</code> (full profile), and the <code class="literal">standalone-ha.xml</code> (web profile with high availability). You can also find some example configuration files in <code class="literal">JBOSS_HOME/docs/examples/configs</code>. If you want to start the server with a different configuration file, you can start the server with the following parameters:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./standalone.sh --server-config standalone-full-ha.xml</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>The <code class="literal">standalone.xml</code> file is located in the <code class="literal">JBOSS_HOME/standalone/configuration</code> folder. This configuration file is in XML format and is validated by a set of <code class="literal">.xsd</code> files found in the <code class="literal">JBOSS_HOME/docs/schema</code> folder.</p></div></div><p>If you want to <a id="id133" class="indexterm"/>check the single <code class="literal">.xsd</code> files, you can find them in the <code class="literal">JBOSS_HOME/docs/schema</code> folder of your server distribution. You can get to know all the available server parameters with a simple inspection of these files or by importing them into your Eclipse environment. Once they are located in your project, right-click on your file, and navigate to <span class="strong"><strong>Generate</strong></span> | <span class="strong"><strong>XML File</strong></span>.</p><p>The application server configuration<a id="id134" class="indexterm"/> follows a tree-like structure that contains, at the root element, the server definition, as shown in the following diagram:</p><div class="mediaobject"><img src="graphics/6232OS_02_01.jpg" alt="Configuring our application server"/></div><p>In the following <a id="id135" class="indexterm"/>sections, we will show in detail the important parts of the server configuration. This <a id="id136" class="indexterm"/>will be helpful to understand the role of each single component in the application server, although you are advised not to manually change the configuration file.</p><p>Manually changing the configuration file can lead to unchecked data modifications. This can corrupt the format of the file, preventing WildFly from starting up. If you do need to update the file manually, you should consider making a backup copy first.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>The best practice for changing the server configuration is to use the <span class="strong"><strong>command-line interface</strong></span> (<span class="strong"><strong>CLI</strong></span>)<a id="id137" class="indexterm"/> or the web admin console, which are described in <a class="link" href="ch07.html" title="Chapter 7. Using the Management Interfaces">Chapter 7</a>, <span class="emphasis"><em>Using the Management Interfaces</em></span>.</p></div></div><div class="section" title="Extensions"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec21"/>Extensions</h2></div></div></div><p>The <a id="id138" class="indexterm"/>application server contains a list of modules <a id="id139" class="indexterm"/>that are used to extend the core of the application server. The core of WildFly is very light, and these extensions provide much of the functionality you expect from an application server. Just like regular static <a id="id140" class="indexterm"/>modules, they are stored in the <code class="literal">JBOSS_HOME/modules</code> folder. Each extension defined in the <code class="literal">standalone.xml</code> or <code class="literal">domain.xml</code> file is picked up by the WildFly class loader when you start the server, before any <a id="id141" class="indexterm"/>applications are deployed. The following code shows an extract from the server configuration:</p><div class="informalexample"><pre class="programlisting">&lt;extensions&gt;
    &lt;extension module="org.jboss.as.clustering.infinispan"/&gt;
    &lt;extension module="org.jboss.as.connector"/&gt;
    &lt;extension module="org.jboss.as.deployment-scanner"/&gt;
    &lt;extension module="org.jboss.as.ee"/&gt;
    &lt;extension module="org.jboss.as.ejb3"/&gt;
  ...
&lt;/extensions&gt;</pre></div></div><div class="section" title="Paths"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec22"/>Paths</h2></div></div></div><p>Logical<a id="id142" class="indexterm"/> names for a filesystem path can be defined <a id="id143" class="indexterm"/>using the <code class="literal">paths</code> element. These paths can then be referenced by their logical name, rather than having to type the full path each time within the configuration file. By default, the <code class="literal">path</code> entry is excluded from the configuration. If you want to include it, you will have to manually add the full configuration. The following example defines a path relative to the WildFly server log with the logical name of <code class="literal">log.dir</code>. For a standalone server, this directory translates into <code class="literal">JBOSS_HOME/standalone/log/mylogdir</code>:</p><div class="informalexample"><pre class="programlisting">&lt;paths&gt;

    &lt;path name="log.dir" path="mylogdir" relative-to="jboss.server.log.dir"/&gt;
&lt;/paths&gt;</pre></div><p>To reference this path in other sections of the configuration file, simply use the logical name as the path. The following example shows the path being used to store the logging, rotating file handler:</p><div class="informalexample"><pre class="programlisting">&lt;periodic-rotating-file-handler name="FILE" autoflush="true"&gt;
  &lt;file relative-to="log.dir" path="myserver.log"/&gt;
&lt;/periodic-rotating-file-handler&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>Please note that the property <code class="literal">relative-to</code> is not mandatory. If you don't include it in your path configuration, the path is assumed to be an absolute path.</p></div></div><p>WildFly provides a set of system paths that are available for you to use without the need to configure them <a id="id144" class="indexterm"/>manually. The pre-configured paths are outlined in the following table. The first five paths <a id="id145" class="indexterm"/>cannot be overridden, but the rest can be overridden using the path element as shown in the preceding code snippet.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Path</p>
</th><th style="text-align: left" valign="bottom">
<p>Meaning</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">jboss.home</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id146" class="indexterm"/> root directory of the WildFly distribution</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user.home</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id147" class="indexterm"/>user's home directory</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user.dir</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id148" class="indexterm"/>user's current working directory</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">java.home</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id149" class="indexterm"/> Java installation directory</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">jboss.server.base.dir</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id150" class="indexterm"/>root directory for an individual server instance</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">jboss.server.data.dir</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id151" class="indexterm"/>directory the server will use for persistent data file storage</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">jboss.server.log.dir</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id152" class="indexterm"/>directory the server will use for logfile storage</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">jboss.server.tmp.dir</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id153" class="indexterm"/>directory the server will use for temporary file storage</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">jboss.domain.servers.dir</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id154" class="indexterm"/> directory under which a host controller will create the working area for individual server instances</p>
</td></tr></tbody></table></div></div><div class="section" title="Management interfaces"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec23"/>Management interfaces</h2></div></div></div><p>The <a id="id155" class="indexterm"/>management interfaces<a id="id156" class="indexterm"/> are configured within the <code class="literal">management</code> element. This configuration is used by the CLI, the administration console, and by JMX. Both the native CLI interface and the web console run on admin port number 9990. The following example is taken from the default server configuration <a id="id157" class="indexterm"/>and highlights the ports used for the management interfaces:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding-group name="standard-sockets" default-interface="public"&gt;
<span class="strong"><strong>    &lt;socket-binding name="management-http" interface="management" port="9990"/&gt;</strong></span>
    &lt;socket-binding name="management-https" interface="management" port="9993"/&gt;
&lt;/socket-binding-group&gt;</pre></div><p>In the following <a id="id158" class="indexterm"/>code snippet, we show the preceding <code class="literal">socket-binding</code> configuration being referenced by the <code class="literal">management-interfaces</code> section of the <code class="literal">standalone.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;management-interfaces&gt;
     &lt;http-interface security-realm="ManagementRealm" http-upgrade-enabled="true"&gt;
<span class="strong"><strong>         &lt;socket-binding http="management-http"/&gt;</strong></span>
    &lt;/http-interface&gt;
&lt;/management-interfaces&gt;</pre></div><p>Management interfaces are discussed in detail in <a class="link" href="ch07.html" title="Chapter 7. Using the Management Interfaces">Chapter 7</a>, <span class="emphasis"><em>Using the Management Interfaces</em></span>, which provides detailed coverage of the application server management tools.</p></div><div class="section" title="Profiles and subsystems"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Profiles and subsystems</h2></div></div></div><p>A<a id="id159" class="indexterm"/> profile can be seen as a collection of subsystems, and <a id="id160" class="indexterm"/>each subsystem in turn <a id="id161" class="indexterm"/>contains a subset of functionalities added to the application server by means of extensions (see the <span class="emphasis"><em>Extensions</em></span> section). For example, the web subsystem contains the definition of a set of connectors used by the container, the messaging subsystem defines the JMS configuration and modules used by the AS's messaging provider, and so on.</p><p>One important <a id="id162" class="indexterm"/>difference between a standalone file and a domain configuration file is the number of profiles contained in it. When using a standalone configuration, there's a single profile that contains the set of subsystem configurations. Domain configuration can, on the other hand, provide multiple profiles.</p></div><div class="section" title="Interfaces"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec25"/>Interfaces</h2></div></div></div><p>Interfaces <a id="id163" class="indexterm"/>define <a id="id164" class="indexterm"/>a logical name for where network interfaces/IP address or host names can be bound.</p><p>By default, the standalone application server defines two available network interfaces, the <code class="literal">management</code> interface and the <code class="literal">public</code> interface:</p><div class="informalexample"><pre class="programlisting">    &lt;interfaces&gt;
        &lt;interface name="management"&gt;
            &lt;inet-address value="${jboss.bind.address.management:127.0.0.1}"/&gt;
        &lt;/interface&gt;
        &lt;interface name="public"&gt;
            &lt;inet-address value="${jboss.bind.address:127.0.0.1}"/&gt;
        &lt;/interface&gt;
    &lt;/interfaces&gt;</pre></div><p>The <code class="literal">public</code> network interface<a id="id165" class="indexterm"/> is intended to be used for the application server core services:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&lt;socket-binding-group name="standard-sockets" default-interface="public"&gt;</strong></span>
  ...
&lt;/socket-binding-group&gt;</pre></div><p>The <code class="literal">management</code> network interface<a id="id166" class="indexterm"/> is referenced by the AS management interfaces, as shown in the <span class="emphasis"><em>Management interfaces</em></span> section.</p><p>By default, both network interfaces resolve to the loop back address <code class="literal">127.0.0.1</code>. This means that the application server public services and the management services are accessible only from the local machine. By changing the <code class="literal">inet-address</code> value, you can bind the network interface to another IP address. The following example shows the server listening on IP <code class="literal">192.168.1.1</code>:</p><div class="informalexample"><pre class="programlisting">&lt;interface name="public"&gt;
<span class="strong"><strong>      &lt;inet-address value="192.168.1.1"/&gt;</strong></span>
&lt;/interface&gt;</pre></div><p>If, on the other hand, you want to bind the network interface to all available sets of IP addresses, you can use the <code class="literal">&lt;any-address /&gt;</code> element, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;interface name="public"&gt;
<span class="strong"><strong>      &lt;any-address /&gt;</strong></span>
&lt;/interface&gt;</pre></div><p>Another useful variation of network interface is the <a id="id167" class="indexterm"/>
<span class="strong"><strong>Network</strong></span> <span class="strong"><strong>Interface</strong></span> <span class="strong"><strong>Card</strong></span> (<span class="strong"><strong>nic</strong></span>) element, which gathers the address information from the network card name:</p><div class="informalexample"><pre class="programlisting">&lt;interface name="public"&gt;
<span class="strong"><strong>      &lt;nic name="eth0" /&gt;</strong></span>
&lt;/interface&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>
<span class="strong"><strong>Binding management interfaces via CLI</strong></span>
</p><p>You can also bind your public interface using the <code class="literal">-b</code> switch, followed by a valid host/IP address. This will cause the server to listen on the host/IP address provided. For example, to bind all public interfaces to all IPv4 addresses, you will use <code class="literal">$JBOSS_HOME/bin/standalone.sh -b=0.0.0.0</code>.</p></div></div></div><div class="section" title="The socket-binding groups"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec26"/>The socket-binding groups</h2></div></div></div><p>A socket-binding group <a id="id168" class="indexterm"/>defines a logical name for a socket. Each socket-binding name can be referenced in other parts of the <a id="id169" class="indexterm"/>configuration file. In this section, you are able to configure the network port that will be listening for incoming connections. Every socket-binding group references a network interface through the <code class="literal">default-interface</code> attribute. Have a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding-group name="standard-sockets" <span class="strong"><strong>default-interface="public"</strong></span>&gt;
        &lt;socket-binding name="management-http" interface="management" port="9990"/&gt;
        &lt;socket-binding name="management-https" interface="management" port="9993"/&gt;
        &lt;socket-binding name="ajp" port="8009"/&gt;
        &lt;socket-binding name="http" port="8080"/&gt;
        &lt;socket-binding name="https" port="8443"/&gt;
&lt;socket-binding name="jacorb" interface="unsecure" port="3528"/&gt;
        &lt;socket-binding name="jacorb-ssl" interface="unsecure" port="3529"/&gt;
        &lt;socket-binding name="txn-recovery-environment" port="4712"/&gt;
        &lt;socket-binding name="txn-status-manager" port="4713"/&gt;
&lt;/socket-binding-group&gt;</pre></div><p>In order to change the port where a service is bound, you can change the <code class="literal">port</code> attribute of its service, but a better approach is to use one of the management interfaces. This will provide an immediate outcome of the affected change. In the following example, we are going to <a id="id170" class="indexterm"/>change the default port for the <code class="literal">http</code> connector using the CLI:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /socket-binding-group=standard-sockets/socket-binding=http:write-attribute(name="port", value="8090")
{
  "outcome" =&gt; "success",
  "response-headers" =&gt; {
    "operation-requires-reload" =&gt; true,
    "process-state" =&gt; "reload-required"
  }
}</pre></div><p>You may have noticed in the response shown above that a reload is required. This can be achieved by <a id="id171" class="indexterm"/>executing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[standalone@localhost:9990 /] :reload</strong></span>
</pre></div></div><div class="section" title="System properties"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec27"/>System properties</h2></div></div></div><p>This <a id="id172" class="indexterm"/>section contains a set of system-wide properties, which <a id="id173" class="indexterm"/>can be added to the application server as part of the booting process. By default, the <code class="literal">system-properties</code> entry is excluded from the configuration. If you want to use this feature, you will need to add the full configuration. The following configuration snippet sets the property named example to <code class="literal">true</code>:</p><div class="informalexample"><pre class="programlisting">&lt;system-properties&gt;
    &lt;property name="myboolean" value="true"/&gt;
&lt;/system-properties&gt;</pre></div><p>The property can be later retrieved on the application server using the following code:</p><div class="informalexample"><pre class="programlisting">String s = System.getProperty("myboolean");</pre></div></div><div class="section" title="Deployments"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec28"/>Deployments</h2></div></div></div><p>The <a id="id174" class="indexterm"/>last section of the configuration<a id="id175" class="indexterm"/> file contains all the deployed applications that have been registered on the application server. Each time a new application is deployed or undeployed, this section is updated to reflect the new application stack.</p></div><div class="section" title="Configuring core subsystems"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec29"/>Configuring core subsystems</h2></div></div></div><p>Now <a id="id176" class="indexterm"/>that you have grasped <a id="id177" class="indexterm"/>the basic concepts of the WildFly configuration file, we will look in more detail at single services.</p><p>In the following diagram, you can find a rough representation of core WildFly 8 subsystems (for the sake of simplicity, we are including just the subsystems that are covered throughout this book):</p><div class="mediaobject"><img src="graphics/6232OS_02_02.jpg" alt="Configuring core subsystems"/></div><p>As a first taste of configuring the application server, we will explore the areas that are highlighted in bold in the preceding diagram. These include the following core application server subsystems:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The thread pool subsystem</li><li class="listitem" style="list-style-type: disc">The JBoss logging subsystem</li></ul></div><p>Let's move straight to the first subsystem, the thread pool.</p></div><div class="section" title="Configuring the thread pool subsystem"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec30"/>Configuring the thread pool subsystem</h2></div></div></div><p>Thread pools <a id="id178" class="indexterm"/>address <a id="id179" class="indexterm"/>two different problems. Firstly, they usually deliver improved performance when executing large numbers of asynchronous tasks due to reduced per-task invocation overhead. Secondly, they provide a means of bounding and managing resources, including threads, consumed when executing a collection of tasks.</p><p>In releases of <a id="id180" class="indexterm"/>JBoss server prior to JBoss AS 7, the thread pool configuration was centralized in a single file or deployment <a id="id181" class="indexterm"/>descriptor. In WildFly, any subsystem that uses thread pools manages its own thread configuration.</p><p>By appropriately configuring the thread pool section, you can tune the specific areas that use that kind of pool to deliver new tasks. The application server thread pool configuration can include the following <a id="id182" class="indexterm"/>elements:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Thread factory configuration</li><li class="listitem" style="list-style-type: disc">Bounded-queue thread configuration</li><li class="listitem" style="list-style-type: disc">Blocking bounded-queue thread configuration</li><li class="listitem" style="list-style-type: disc">Unbounded-queue thread configuration</li><li class="listitem" style="list-style-type: disc">Queueless thread pool configuration</li><li class="listitem" style="list-style-type: disc">Blocking queueless thread pool configuration</li><li class="listitem" style="list-style-type: disc">Scheduled thread configuration</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>It is important to note that the thread subsystem will probably be marked for deprecation in WildFly 9, but in WildFly 8 this configuration is completely valid.</p></div></div><p>Let's look at each single element in detail.</p><div class="section" title="Configuring the thread factory"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec07"/>Configuring the thread factory</h3></div></div></div><p>A <a id="id183" class="indexterm"/>
<span class="strong"><strong>thread</strong></span> <span class="strong"><strong>factory</strong></span> (implementing <code class="literal">java.util.concurrent.ThreadFactory</code>) is an object that creates new threads on demand. Using<a id="id184" class="indexterm"/> thread factories removes the hardwiring of calls to a new thread, enabling applications to use special thread subclasses, priorities, and so on.</p><p>The<a id="id185" class="indexterm"/> thread factory is not included in the server configuration by default, as it relies on default values that you will rarely need to modify. Nevertheless, we will provide a simple configuration example for the experienced user who may require complete control of the thread configuration.</p><p>The following is an example of a custom thread factory configuration:</p><div class="informalexample"><pre class="programlisting">&lt;thread-factory name="MyThreadFactory" thread-name-pattern="My Thread %t" group-name="dummy" /&gt;</pre></div><p>The following <a id="id186" class="indexterm"/>are the possible attributes that you can use when defining a thread factory:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">name</code> attribute<a id="id187" class="indexterm"/> is the name of the created thread factory</li><li class="listitem" style="list-style-type: disc">The optional <code class="literal">priority</code> attribute<a id="id188" class="indexterm"/> may be used to specify the thread priority of created threads</li><li class="listitem" style="list-style-type: disc">The optional <code class="literal">group-name</code> attribute<a id="id189" class="indexterm"/> specifies the name of the thread group to create for this thread factory</li><li class="listitem" style="list-style-type: disc">The <code class="literal">thread-name-pattern</code><a id="id190" class="indexterm"/> is the template used to create names for threads. The following patterns can be used:</li></ul></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Pattern</p>
</th><th style="text-align: left" valign="bottom">
<p>Output</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">%%</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Emits a percentage sign</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">%g</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Emits the per-factory thread sequence number</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">%f</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Emits the global thread sequence number</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">%i</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Emits the thread ID</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">%G</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Emits the thread group name</p>
</td></tr></tbody></table></div></div><div class="section" title="The bounded-queue thread pool"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec08"/>The bounded-queue thread pool</h3></div></div></div><p>A <a id="id191" class="indexterm"/>bounded-queue thread pool <a id="id192" class="indexterm"/>is the most common kind of pool used by the application server. It helps prevent resource exhaustion by defining a constraint on the thread pool's size. It is also the most complex to use. Its inherent complexity derives from the fact that it maintains both a fixed-length queue and two pool sizes: a<a id="id193" class="indexterm"/> <span class="strong"><strong>core</strong></span> <span class="strong"><strong>size</strong></span> and<a id="id194" class="indexterm"/> a <span class="strong"><strong>maximum</strong></span> <span class="strong"><strong>size</strong></span>.</p><p>If, each time a new task is submitted, the number of running threads is less than the core size, a new thread is created. Otherwise, if there is room in the queue, the task is queued.</p><p>If none of these options are viable, the executor needs to evaluate if it can still create a new thread. If the number of running threads is less than the maximum size, a new thread is created. Otherwise, the task is assigned to the designated <code class="literal">hand-off</code> executor, if one is specified. In the absence of a designated <code class="literal">hand-off</code> executor, the task will be discarded.</p><p>The following diagram<a id="id195" class="indexterm"/> summarizes the whole process, showing how all the pieces fit together:</p><div class="mediaobject"><img src="graphics/6232OS_02_03.jpg" alt="The bounded-queue thread pool"/></div><p>The following<a id="id196" class="indexterm"/> is a sample <a id="id197" class="indexterm"/>configuration of a bounded-queue thread pool taken from the configuration file:</p><div class="informalexample"><pre class="programlisting">&lt;bounded-queue-thread-pool name="jca-short-running"&gt;
  &lt;core-threads count="10"/&gt;
  &lt;queue-length count="10"/&gt;
  &lt;max-threads count="10"/&gt;
  &lt;keepalive-time time="10" unit="seconds"/&gt;
&lt;/bounded-queue-thread-pool&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><p>The following table gives a short description of each attribute/element:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Attribute/element</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the bean name of the created executor</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">allow-core-timeout</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies whether core threads time out or not; if <code class="literal">false</code>, only threads above the core size will time out</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">core-threads</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the core thread pool size, which is smaller than the maximum pool size</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-threads</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the maximum thread pool size</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">queue-length</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the executor queue length</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">keepalive-time</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the amount of time that threads beyond the core pool size should be kept running when idle</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">thread-factory</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the bean name of a specific thread factory to use to create worker threads</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">handoff-executor</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies an executor to delegate tasks to in the event that a task cannot be accepted</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>
<span class="strong"><strong>Performance focus</strong></span>
</p><p>
<span class="strong"><strong>Queue size</strong></span> and <span class="strong"><strong>pool size</strong></span> values are a performance tradeoff, and the right balance needs to be found between the two. When using a small pool with a large queue, you minimize CPU usage, OS resources, and context-switching overhead. It can, however, produce an artificially low throughput. If tasks are strongly I/O bound (and thus frequently blocked), a system may be able to schedule time for more threads than you otherwise allow. The use of small queues generally requires larger pool sizes, which keep the CPUs busier but may encounter unacceptable scheduling overhead, which also decreases throughput.</p></div></div></div><div class="section" title="The blocking bounded-queue thread pool"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec09"/>The blocking bounded-queue thread pool</h3></div></div></div><p>The <a id="id198" class="indexterm"/>blocking bounded-queue thread pool has a very similar configuration to the bounded-queue thread pool; it has a slightly different workflow. The difference being, rather than attempting to hand off to the designated hand-off executor, the caller blocks until room becomes available in the queue.</p><p>The flowchart for this thread pool is shown as follows:</p><div class="mediaobject"><img src="graphics/6232OS_02_04.jpg" alt="The blocking bounded-queue thread pool"/></div><p>The following is an example configuration for a blocking bounded-queue thread pool:</p><div class="informalexample"><pre class="programlisting">&lt;blocking-bounded-queue-thread-pool name="jca-short-running"&gt;
    &lt;core-threads count="10"/&gt;
    &lt;queue-length count="10"/&gt;
    &lt;max-threads count="10"/&gt;
    &lt;keepalive-time time="10" unit="seconds"/&gt;
&lt;/bounded-queue-thread-pool&gt;</pre></div><p>Please see the <a id="id199" class="indexterm"/>following table for the bounded-queue thread pool for a description of each attribute/element. The attributes/elements<a id="id200" class="indexterm"/> available for the blocking bounded-queue thread pool are shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Attribute/element</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id201" class="indexterm"/>the bean name of the created executor</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">allow-core-timeout</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id202" class="indexterm"/>whether core threads may time out or not; if <code class="literal">false</code>, only threads above the core size will time out</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">core-threads</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id203" class="indexterm"/>the core thread pool size, which is smaller than the maximum pool size</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-threads</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id204" class="indexterm"/>the maximum thread pool size</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">queue-length</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id205" class="indexterm"/>the executor queue length</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">keepalive-time</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id206" class="indexterm"/>the amount of time that threads beyond the core pool size should be kept running when idle</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">thread-factory</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies<a id="id207" class="indexterm"/> the bean name of a specific thread factory to use to create worker threads</p>
</td></tr></tbody></table></div></div><div class="section" title="The unbounded-queue thread pool"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec10"/>The unbounded-queue thread pool</h3></div></div></div><p>The <a id="id208" class="indexterm"/>unbounded-queue thread pool <a id="id209" class="indexterm"/>executor follows a simpler but more risky approach than the bounded thread pool; that is, it always accepts new tasks.</p><p>In practice, the unbounded thread pool has a core size and a queue with no upper limit. When a task is submitted, if the number of running threads is less than the core size, a new thread is created. Otherwise, the task is placed in a queue. If too many tasks are allowed to be submitted to this type of executor, an out-of-memory condition may occur. Have a look at the<a id="id210" class="indexterm"/> following flowchart:</p><div class="mediaobject"><img src="graphics/6232OS_02_05.jpg" alt="The unbounded-queue thread pool"/></div><p>Due to its inherent risk, unbounded thread pools are not included by default in the server configuration. We will provide a sample here, with only one recommendation: don't try this at home, kids!</p><div class="informalexample"><pre class="programlisting">&lt;unbounded-queue-thread-pool name="unbounded-threads"&gt;
  &lt;max-threads count="10" /&gt;
  &lt;keepalive-time time="10" unit="seconds"/&gt;
&lt;/unbounded-queue-thread-pool&gt;</pre></div><p>If you want to know more about the meaning of each thread pool element/attribute, you can refer to the bounded thread pool table.</p><p>The attributes/elements<a id="id211" class="indexterm"/> available for the unbounded-queue thread pool are shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Attribute/element</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id212" class="indexterm"/>the bean name of the created executor</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-threads</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies<a id="id213" class="indexterm"/> the maximum thread pool size</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">keepalive-time</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id214" class="indexterm"/>the amount of time that threads beyond the core pool size should be kept running when idle</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">thread-factory</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id215" class="indexterm"/>the bean name of a specific thread factory to use to create worker threads</p>
</td></tr></tbody></table></div></div><div class="section" title="The queueless thread pool"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec11"/>The queueless thread pool</h3></div></div></div><p>As its <a id="id216" class="indexterm"/>name implies, the queueless thread pool <a id="id217" class="indexterm"/>is a thread pool executor with no queue. Basically, this executor short-circuits the logic of the bounded thread executor, as it does not attempt to store the task in a queue.</p><p>So, when a task is submitted, if the number of running threads is less than the maximum size, a new thread is created. Otherwise, the task is assigned to the designated <code class="literal">hand-off</code> executor if one is<a id="id218" class="indexterm"/> specified. Without any designated <code class="literal">hand-off</code>, the task will be discarded. Have a look at the following flowchart:</p><div class="mediaobject"><img src="graphics/6232OS_02_06.jpg" alt="The queueless thread pool"/></div><p>Queueless executors are also not included by default in the configuration file. However, we will provide a sample configuration<a id="id219" class="indexterm"/> here:</p><div class="informalexample"><pre class="programlisting">&lt;queueless-thread-pool name="queueless-thread-pool" blocking="true"&gt;
  &lt;max-threads count="10"/&gt;
  &lt;keepalive-time time="10" unit="seconds"/&gt;
&lt;/queueless-thread-pool&gt;</pre></div></div><div class="section" title="The blocking queueless thread pool"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec12"/>The blocking queueless thread pool</h3></div></div></div><p>The <a id="id220" class="indexterm"/>blocking <a id="id221" class="indexterm"/>queueless thread pool has a similar configuration to the queueless thread pool. Similar to the <a id="id222" class="indexterm"/>blocking queue thread pool, the difference is that rather than attempting to hand off to the designated hand-off executor, the caller blocks until room becomes available in the queue.</p><p>Have a look at the following diagram:</p><div class="mediaobject"><img src="graphics/6232OS_02_07.jpg" alt="The blocking queueless thread pool"/></div><p>Although <a id="id223" class="indexterm"/>not included in the default configuration file, here is an example:</p><div class="informalexample"><pre class="programlisting">&lt;blocking-queueless-thread-pool name="queueless-thread-pool"&gt;
    &lt;max-threads count="10" /&gt;
    &lt;keepalive-time time="10" unit="seconds"/&gt;
&lt;/blocking-queueless-thread-pool&gt;</pre></div><p>The attributes/elements available for the unbounded-queue thread pool are <code class="literal">name</code>, <code class="literal">max-threads</code>, <code class="literal">keepalive-time</code>, and <code class="literal">thread-factory</code>.</p></div><div class="section" title="The scheduled thread pool"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec13"/>The scheduled thread pool</h3></div></div></div><p>The<a id="id224" class="indexterm"/> server-scheduled thread pool is <a id="id225" class="indexterm"/>used for activities on the server side that require running periodically or with delays. It maps internally to a <code class="literal">java.util.concurrent.ScheduledThreadPoolExecutor</code> instance. Have a look at the following <a id="id226" class="indexterm"/>diagram:</p><div class="mediaobject"><img src="graphics/6232OS_02_08.jpg" alt="The scheduled thread pool"/></div><p>This type of executor is configured with the <code class="literal">scheduled-thread-pool</code> executor element, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;scheduled-thread-pool name="remoting"&gt;
  &lt;max-threads count="10"/&gt;
  &lt;keepalive-time time="10" unit="seconds"/&gt;
&lt;/scheduled-thread-pool&gt;</pre></div><p>The scheduled thread pool is used by the <code class="literal">remoting</code> framework and by the HornetQ subsystem, which uses both a bounded JCA thread executor and a scheduled pool for delayed delivery.</p></div></div></div></div>
<div class="section" title="Configuring application server logging"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Configuring application server logging</h1></div></div></div><p>Every<a id="id227" class="indexterm"/> application needs to trace logging statements. At the moment, there are <a id="id228" class="indexterm"/>several <a id="id229" class="indexterm"/>implementations of logging libraries for Java applications, the most popular ones are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Log4j</strong></span>: It is <a id="id230" class="indexterm"/>a <a id="id231" class="indexterm"/>flexible open source logging library from Apache. Log4j is widely used in the open source community, and it was the default logging implementation on earlier releases of JBoss AS.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Java SE logging libraries (JUL)</strong></span>: It <a id="id232" class="indexterm"/>provides <a id="id233" class="indexterm"/>the logging classes and interfaces as part of the Java SE platform's standard libraries.</li></ul></div><p>Log4j and JUL have very similar APIs. They differ conceptually only in small details, but do more or less the same thing, with the exception of log4j, which has more features. You may or may not need these features.</p><p>The JBoss logging framework<a id="id234" class="indexterm"/> is based on JUL, which is built around three main concepts: <span class="strong"><strong>loggers</strong></span>, <span class="strong"><strong>handlers</strong></span>, and <a id="id235" class="indexterm"/>
<span class="strong"><strong>formatters</strong></span>. These <a id="id236" class="indexterm"/>concepts allow developers to log <a id="id237" class="indexterm"/>messages according to their type and priority and to control where messages end up and how they look when they get there.</p><p>The following diagram shows the logging cycle using the JUL framework. The application makes logging calls on the logger objects. These logger objects allocate the <code class="literal">LogRecord</code> objects, which are passed to the handler objects for publication. Both logger and handler may use the formatter to arrange the layout of logs and filter to decide whether they are interested in a <a id="id238" class="indexterm"/>particular log record.</p><p>Have a look at the following diagram:</p><div class="mediaobject"><img src="graphics/6232OS_02_09.jpg" alt="Configuring application server logging"/></div><div class="section" title="Choosing your logging implementation"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec31"/>Choosing your logging implementation</h2></div></div></div><p>The <a id="id239" class="indexterm"/>WildFly/JBoss application <a id="id240" class="indexterm"/>server, through its releases, has used different frameworks to handle application server logs. In JBoss AS 5 and earlier, log4j was the default logging API used by the application server.</p><p>Since JBoss AS 6, the logging provider switched to JBoss's own implementation, which is based on the JDK 1.4 logging system. However, it provides several fixes and workarounds for many shortcomings in the default JDK implementation.</p><p>For example, the<a id="id241" class="indexterm"/> default implementation of <code class="literal">java.util.logging</code> provided in the JDK does not have per-web application logging, as the configuration is per-VM.</p><p>As a result, WildFly replaces the default JUL log manager implementation with its own implementation, which addresses these issues. The following diagram illustrates the modules that make up the WildFly 8 logging subsystem:</p><div class="mediaobject"><img src="graphics/6232OS_02_10.jpg" alt="Choosing your logging implementation"/></div><p>At the top of<a id="id242" class="indexterm"/> the hierarchy, there's the <code class="literal">org.jboss.logmanager</code> module, which is the top-level library that manages logs for the JBoss logging subsystem. Under <code class="literal">jboss</code> <code class="literal">logmanager</code>, you can find concrete implementations, such as the <code class="literal">org.jboss.logging</code> and <code class="literal">org.jboss.log4j.logmanager</code> modules. By default, the application server uses the former module (<code class="literal">org.jboss.logging</code>), which is implemented in turn by <code class="literal">org.jboss.as.logging</code> to manage your logs inside the application server. However, if you want to switch to the <code class="literal">log4j</code> implementation, the <code class="literal">org.jboss.log4j.logmanager</code> module is what you need (in the last section of this chapter, we will include an example of how to use <code class="literal">log4j</code> in your application).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>WildFly is not limited to JBoss logging or log4j. You can use any logging library, including slf4j or commons logging.</p></div></div><div class="section" title="Configuring the logging subsystem"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec14"/>Configuring the logging subsystem</h3></div></div></div><p>The <a id="id243" class="indexterm"/>logging subsystem contains a set of log handlers out of the box. A handler object takes log messages <a id="id244" class="indexterm"/>from a logger and exports them. For example, it might write them to a console or a file, send them to a network logging service, or forward them to an OS log. By default, the<a id="id245" class="indexterm"/> following handlers are defined:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">console-handler</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">periodic-rotating-file-handler</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">size-rotating-file-handler</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">async-handler</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">syslog-handler</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">custom-handler</code></li></ul></div></div></div><div class="section" title="The console-handler"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec32"/>The console-handler</h2></div></div></div><p>The <a id="id246" class="indexterm"/>
<code class="literal">console-handler</code> defines a handler that simply writes log messages to the console, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;console-handler name="CONSOLE" autoflush="true"&gt;
  &lt;level name="INFO"/&gt;
  &lt;formatter&gt;
    &lt;pattern-formatter pattern="%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n"/&gt;
  &lt;/formatter&gt;
&lt;/console-handler&gt;</pre></div><p>The optional <code class="literal">autoflush</code> attribute<a id="id247" class="indexterm"/> determines if buffered logs are flushed automatically. The default value for this option is <code class="literal">true</code>.</p><p>The <code class="literal">level</code> element<a id="id248" class="indexterm"/> defines the lowest log level associated with the handler, which means that anything with this log level and a higher value will be logged. The full range of log levels, from lowest to highest, are: <code class="literal">OFF</code>, <code class="literal">FINEST</code>, <code class="literal">FINER</code>, <code class="literal">FINE</code>, <code class="literal">CONFIG</code>, <code class="literal">INFO</code>, <code class="literal">WARNING</code>, <code class="literal">SEVERE</code>, and <code class="literal">ALL</code>.</p><p>The <code class="literal">formatter</code> element<a id="id249" class="indexterm"/> provides support to format <code class="literal">LogRecords</code>. The log formatting inherits the same pattern strings as that of the layout pattern of <code class="literal">log4j</code>, which was in turn inspired by dear old C's <code class="literal">printf</code> function. Check the log4j documentation<a id="id250" class="indexterm"/> at <a class="ulink" href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/PatternLayout.html">http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/PatternLayout.html</a>.</p><p>Here, we will just mention that <code class="literal">%d{HH:mm:ss,SSS}</code> outputs the date of the logging event using the conversion included in brackets.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The string <code class="literal">%-5p</code><a id="id251" class="indexterm"/> outputs the priority of the logging event</li><li class="listitem" style="list-style-type: disc">The string <code class="literal">[%c]</code> is<a id="id252" class="indexterm"/> used to output the category of the logging event</li><li class="listitem" style="list-style-type: disc">The string <code class="literal">(%t)</code><a id="id253" class="indexterm"/> outputs the thread that generated the logging event</li><li class="listitem" style="list-style-type: disc">The string <code class="literal">%s</code> <a id="id254" class="indexterm"/>outputs the log message</li><li class="listitem" style="list-style-type: disc">Finally, the <code class="literal">%n</code><a id="id255" class="indexterm"/> string outputs the platform-dependent line separator character or characters</li></ul></div></div><div class="section" title="The periodic-rotating-file-handler"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec33"/>The periodic-rotating-file-handler</h2></div></div></div><p>The <a id="id256" class="indexterm"/>
<code class="literal">periodic-rotating-file-handler</code> defines<a id="id257" class="indexterm"/> a handler that writes to a file and rotates the log after a time period derived from the given suffix string, which should be in a format understood by <code class="literal">java.text.SimpleDateFormat</code>.</p><p>Here's the definition of it:</p><div class="informalexample"><pre class="programlisting">&lt;periodic-rotating-file-handler name="FILE" autoflush="true"&gt;
  &lt;level name="INFO"/&gt;
  &lt;formatter&gt;
    &lt;pattern-formatter pattern="%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n"/&gt;
  &lt;/formatter&gt;
  &lt;file relative-to="jboss.server.log.dir" path="server.log"/&gt;
  &lt;suffix value=".yyyy-MM-dd"/&gt;
  &lt;append value="true"/&gt;
&lt;/periodic-rotating-file-handler&gt;</pre></div><p>This handler introduces the file element containing the path, which is the actual filename and its <code class="literal">relative-to</code> position. In our case, the relative position corresponds to the <code class="literal">jboss.server.log.dir</code> application server parameter.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>With the default suffix configuration, logs are rolled at 12 PM. By changing the value of <code class="literal">SimpleDateFormat</code>, you can also change the period when logs are rotated, for example, the suffix <code class="literal">yyyy-MM-dd-HH</code> will rotate the logs every hour.</p></div></div></div><div class="section" title="The size-rotating-file-handler"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec34"/>The size-rotating-file-handler</h2></div></div></div><p>The <a id="id258" class="indexterm"/>
<code class="literal">size-rotating-file-handler</code> defines a handler that writes to a file, rotating the log after the size of the file grows beyond a certain point. It also keeps a fixed number of backups.</p><p>There's no <a id="id259" class="indexterm"/>size handler defined in the standard configuration. However, we can find out its basic configuration from the <code class="literal">JBOSS_HOME/docs/schema/jboss-as-logging_2_0.xsd</code> file. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">&lt;size-rotating-file-handler name="FILESIZE" autoflush="true" &gt;
  &lt;rotate-size value="500k" /&gt;
  &lt;level name="INFO"/&gt;
  &lt;formatter&gt;
    &lt;pattern-formatter pattern="%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n"/&gt;
  &lt;/formatter&gt;
  &lt;file relative-to="jboss.server.log.dir" path="server.log"/&gt;
&lt;/size-rotating-file-handler&gt;</pre></div></div><div class="section" title="The async-handler"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec35"/>The async-handler</h2></div></div></div><p>The <a id="id260" class="indexterm"/>
<code class="literal">async-handler</code> is a composite<a id="id261" class="indexterm"/> handler that attaches to other handlers to produce asynchronous logging events. Behind the scenes, this handler uses a bounded queue to store events. Every time a log is emitted, the asynchronous handler appends the log into the queue and returns immediately. Here's an example of asynchronous logging for the <code class="literal">FILE</code> appender:</p><div class="informalexample"><pre class="programlisting">&lt;async-handler name="ASYNC"&gt;
  &lt;level name="INFO" /&gt;
  &lt;queue-length&gt;1024&lt;/queue-length&gt;
  &lt;overflow-action&gt;block&lt;/overflow-action&gt;
  &lt;sub-handlers&gt;
    &lt;handler-ref name="FILE" /&gt;
  &lt;/sub-handlers&gt;
&lt;/async-handler&gt;</pre></div><p>In this handler, we also specify the size of the queue, where events are sent, and the action to take when the <code class="literal">async</code> queue overflows. You can opt between <code class="literal">block</code>, causing the calling thread to be blocked, and <code class="literal">discard</code>, causing the message to be discarded.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>
<span class="strong"><strong>When should I use the asynchronous handler?</strong></span>
</p><p>The asynchronous handler produces a substantial performance benefit to applications that are heavily I/O bound. Conversely, CPU-bound applications may not benefit from asynchronous logging, as it will put additional stress on the CPU.</p></div></div></div><div class="section" title="The syslog-handler"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec36"/>The syslog-handler</h2></div></div></div><p>A <a id="id262" class="indexterm"/>
<code class="literal">syslog-handler</code> can be <a id="id263" class="indexterm"/>used to write logs to a remote logging server. This allows multiple applications to send their log messages to the same server, where they can all be parsed together. Both RFC3164 and RFC5424 formats are supported. Here is an example of a <code class="literal">syslog-handler</code>:</p><div class="informalexample"><pre class="programlisting">&lt;syslog-handler name="SYSLOG" enabled="true"&gt;
    &lt;level name="INFO" /&gt;
    &lt;port value="514" /&gt;
    &lt;server-address value="192.168.0.56" /&gt;
    &lt;formatter&gt;
        &lt;syslog-format syslog-type="RFC5424" /&gt;
    &lt;/formatter&gt;
&lt;/syslog-handler&gt;</pre></div></div><div class="section" title="Custom handlers"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec37"/>Custom handlers</h2></div></div></div><p>So far, we <a id="id264" class="indexterm"/>have seen just a few <a id="id265" class="indexterm"/>basic log handlers, which are usually included in your server configuration. If you need a more advanced approach to managing your logs, you can define a custom logging handler. In order to add a custom handler, you need to define a class that extends the <code class="literal">java.util.logging.Handler</code> interface and then override its abstract methods. For example, the following class, named <a id="id266" class="indexterm"/>
<code class="literal">JdbcLogger</code>, is used <a id="id267" class="indexterm"/>to write the logs to a database (full code is available at <a class="ulink" href="http://community.jboss.org/wiki/CustomLogHandlersOn701">http://community.jboss.org/wiki/CustomLogHandlersOn701</a>).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>Note that, although this article was written for JBoss AS 7, it remains valid for WildFly 8.</p></div></div><p>Have a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">public class JdbcLogger extends Handler{
  @Override
  public void publish(LogRecord record){
    try{
      insertRecord(record);
    }
    catch (SQLException e)  {
      e.printStackTrace();
    }
  }
  @Override
  public void flush() {     . . . .    }
  @Override
  public void close() {     . . . .    }
}</pre></div><p>Once compiled, this<a id="id268" class="indexterm"/> class needs to be packaged in an archive (for example, <code class="literal">logger.jar</code>) and installed as a module in the application server. We will name the module <code class="literal">com.JDBCLogger</code>, which requires the following structure under the <code class="literal">modules</code> folder:</p><div class="mediaobject"><img src="graphics/6232OS_02_11.jpg" alt="Custom handlers"/></div><p>The label <span class="strong"><strong>Path to be created</strong></span><a id="id269" class="indexterm"/> shows the directory structure under which we will place the <code class="literal">logger.jar</code>
<span class="strong"><strong> </strong></span>archive and its configuration file (<code class="literal">module.xml</code>), which follows here:</p><div class="informalexample"><pre class="programlisting">&lt;module  name="com.JDBCLogger"&gt;
    &lt;resources&gt;
        &lt;resource-root path="logger.jar"/&gt;
    &lt;/resources&gt;
    &lt;dependencies&gt;
        &lt;module name="javax.api"/&gt;
        &lt;module name="org.jboss.logging"/&gt;
        &lt;module name="com.mysql"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</pre></div><p>Note that<a id="id270" class="indexterm"/> this module has a dependency on another module, <code class="literal">com.mysql</code>. In the next chapter, we will show how to connect to a database after installing the appropriate module.</p><p>We are almost done. Now, insert the handler in the logging subsystem, which contains within its properties the database connection strings and the statement that will be used to insert logs into the database:</p><div class="informalexample"><pre class="programlisting">&lt;custom-handler name="DB" class="com.sample.JdbcLogger" module="com.JDBCLogger"&gt;
    &lt;level name="INFO"/&gt;
    &lt;formatter&gt;
        &lt;pattern-formatter pattern="%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n"/&gt;
    &lt;/formatter&gt;
    &lt;properties&gt;
        &lt;property name="driverClassName" value="com.mysql.jdbc.Driver"/&gt;
        &lt;property name="jdbcUrl" value="jdbc:mysql://localhost:3306/mydb"/&gt;
        &lt;property name="username" value="root"/&gt;
        &lt;property name="password" value="admin"/&gt;
        &lt;property name="insertStatement" value="INSERT INTO into log_table VALUES (?, $TIMESTAMP, $LEVEL, $MDC[ip], $MDC[user], $MESSAGE, hardcoded)"/&gt;
    &lt;/properties&gt;
&lt;/custom-handler&gt;
&lt;root-logger&gt;
    &lt;level name="INFO"/&gt;
    &lt;handlers&gt;
        &lt;handler name="CONSOLE"/&gt;
        &lt;handler name="FILE"/&gt;
        &lt;handler name="DB"/&gt;
    &lt;/handlers&gt;
&lt;/root-logger&gt;</pre></div><p>The new <code class="literal">handler</code>, named <code class="literal">DB</code>, is enlisted in the <code class="literal">root-logger</code> to collect all logging statements that have a priority of <code class="literal">INFO</code> or higher. Before testing the logger, don't forget to create the required tables on your MySQL database, as follows:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE log_table(
  id INT(11) NOT NULL AUTO_INCREMENT,
  `timestamp` VARCHAR(255) DEFAULT NULL,
  level VARCHAR(255) DEFAULT NULL,
  mdc_ip VARCHAR(255) DEFAULT NULL,
  mdc_user VARCHAR(255) DEFAULT NULL,
  message VARCHAR(1500) DEFAULT NULL,
  hardcoded VARCHAR(255) DEFAULT NULL,
  PRIMARY KEY (id)
)
ENGINE = INNODBAUTO_INCREMENT = 1</pre></div><p>If you have <a id="id271" class="indexterm"/>carefully followed all the required steps, you will notice that <code class="literal">log_table</code> contains the logging events that have been triggered since server startup. Have a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_02_12.jpg" alt="Custom handlers"/></div><div class="section" title="Configuring loggers"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec15"/>Configuring loggers</h3></div></div></div><p>A logger object<a id="id272" class="indexterm"/> is used to log messages for a specific system or application components. Loggers are normally named using a hierarchical dot-separated namespace. Logger names can be arbitrary strings, but they should normally be based on the package name or class name of the logged component. For example, the logger instructs the logging system to emit logging statements for the package <code class="literal">com.sample</code> if they have the log level <code class="literal">WARN</code> or higher:</p><div class="informalexample"><pre class="programlisting">&lt;logger category="com.sample"&gt;
  &lt;level name="WARN"/&gt;
&lt;/logger&gt;</pre></div><p>At the top of the hierarchy, there's the <code class="literal">root-logger</code>. There are two important things to note about <code class="literal">root-logger</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It always exists</li><li class="listitem" style="list-style-type: disc">It cannot be retrieved by name</li></ul></div><p>In the default server configuration, the root-logger defines two handlers that are connected to <a id="id273" class="indexterm"/>
<code class="literal">CONSOLE</code> and to the <code class="literal">FILE</code> handler:</p><div class="informalexample"><pre class="programlisting">&lt;root-logger&gt;
    &lt;level name="INFO"/&gt;
    &lt;handlers&gt;
        &lt;handler name="CONSOLE"/&gt;
        &lt;handler name="FILE"/&gt;
    &lt;/handlers&gt;
&lt;/root-logger&gt;</pre></div></div><div class="section" title="Per-deployment logging"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec16"/>Per-deployment logging</h3></div></div></div><p>WildFly <a id="id274" class="indexterm"/>has the ability to configure per-deployment logging. This is enabled by default. This means that if you add a logging configuration file to your deployment, its configuration will be used to log for that deployment. The valid logging configuration files are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">logging.properties</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">jboss-logging.properties</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">log4j.properties</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">log4j.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">jboss-log4j.xml</code></li></ul></div><p>If you package your application into an EAR, your logging configuration file should go into the <code class="literal">META-INF</code> directory. If you are packaging your application into a JAR or WAR, then it can be placed into either the <code class="literal">META-INF</code> directory or the <code class="literal">WEB-INF</code> directory.</p><p>Should you want to disable per-deployment logging, you will need to set the <code class="literal">use-deployment-logging-config</code> value to <code class="literal">false</code>. Have a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
<span class="strong"><strong>    &lt;use-deployment-logging-config value="false"/&gt;</strong></span>
     &lt;console-handler name="CONSOLE"&gt;
         &lt;level name="INFO"/&gt;
         &lt;formatter&gt;
             &lt;named-formatter name="COLOR-PATTERN"/&gt;
         &lt;/formatter&gt;
    &lt;/console-handler&gt;
    ...
&lt;/subsystem&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>The system property <code class="literal">org.jboss.as.logging.per-deployment</code> has been deprecated in WildFly 8. You should use <code class="literal">use-deployment-logging-config</code> instead.</p></div></div></div><div class="section" title="Bypassing container logging"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec17"/>Bypassing container logging</h3></div></div></div><p>You may, for<a id="id275" class="indexterm"/> some reason, wish to bypass container logging altogether. To do this, add the <code class="literal">add-logging-api-dependencies</code> property to your logging configuration and set its value to <code class="literal">false</code>. This will disable the adding of the implicit server logging dependencies, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
<span class="strong"><strong>    &lt;add-logging-api-dependenciesuse-deployment-logging-config value="false"/&gt;</strong></span>
    &lt;console-handler name="CONSOLE"&gt;
        &lt;level name="INFO"/&gt;
        &lt;formatter&gt;
            &lt;named-formatter name="COLOR-PATTERN"/&gt;
        &lt;/formatter&gt;
    &lt;/console-handler&gt;
    ...
&lt;/subsystem&gt;</pre></div><p>To bypass logging on per-application basis only, you will need to use the <code class="literal">jboss-deployment-structure.xml</code> file to exclude the logging subsystem. We will cover the <code class="literal">jboss-deployment-structure.xml</code> file in detail in <a class="link" href="ch06.html" title="Chapter 6. Application Structure and Deployment">Chapter 6</a>, <span class="emphasis"><em>Application Structure and Deployment</em></span>.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Summary</h1></div></div></div><p>In this chapter, we've gone through the basics of the application server configuration, which is now composed of a single monolithic file that contains the configuration for all the installed services.</p><p>Although this main configuration file will be your main point of reference to get a full understanding of the WildFly infrastructure, we must stress the importance of modifying it via one of the management interfaces.</p><p>We have examined each of the sections within the thread pool configuration in detail. We have also seen that the thread pool relies on the Java Standard Edition Thread Executor API to define a set of pools, and that these pools are used by the application servers' core services.</p><p>Next, we discussed the JBoss logging framework, which is built on top of the Java Util Logging framework and addresses some known shortcomings of JUL. We described how to configure per-application logging in your applications.</p><p>In the next chapter, we will take a look at some core enterprise service configurations, such as the datasource and messaging subsystems. These services are the backbone of many enterprise applications.</p></div></body></html>