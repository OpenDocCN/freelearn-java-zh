<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Distributing a Clustered Container with Apache Karaf Cellar"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Distributing a Clustered Container with Apache Karaf Cellar</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing Apache Karaf Cellar modules in Apache Karaf</li><li class="listitem" style="list-style-type: disc">Using Apache Karaf Cellar commands</li><li class="listitem" style="list-style-type: disc">Building and deploying a distributed architecture with Cellar</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec59"/>Introduction</h1></div></div></div><p>This chapter shows how to install and use Apache Karaf Cellar with Apache Karaf. Apache Karaf Cellar's main aim is to enable a cluster-wide provisioning for Apache Karaf. This provisioning can be controlled with white and black lists for bundles, features, and configurations. Besides these core features, it is also possible to use Cellar to cluster in or with a cloud and send events through the cluster. It is also possible to have distributed OSGi services with Cellar.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip29"/>Tip</h3><p>If you are looking for more insight on how Apache Karaf Cellar works, take a look at <span class="emphasis"><em>Learning Karaf Cellar</em></span>, <span class="emphasis"><em>Jean-Baptiste Onofré</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>.</p></div></div></div></div>
<div class="section" title="Installing Apache Karaf Cellar modules in Apache Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec60"/>Installing Apache Karaf Cellar modules in Apache Karaf</h1></div></div></div><p>First of all, we will need to add the ability to cluster multiple Karaf instances. For this, Cellar needs to be installed on Apache Karaf first. For this, the required feature repository URL needs to be added, which can be done using the following convenient method:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; feature:repo-add cellar</strong></span>
</pre></div><p>After <a id="id454" class="indexterm"/>this, all the possible Cellar features of the <a id="id455" class="indexterm"/>latest version are<a id="id456" class="indexterm"/> available for installation. In our case, this is Cellar 3.0.0. Besides installing Cellar, it is required to have multiple Karaf instances running for verification of the recipes.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec184"/>How to do it…</h2></div></div></div><p>Follow these steps to set up Cellar and create multiple Karaf instances on the same machine:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the required <code class="literal">cellar</code> feature with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; feature:install cellar</strong></span>
</pre></div><p>This will install all the required Cellar bundles so that we have the basic setup to run a Karaf cluster.</p></li><li class="listitem">Next, it's important to have another node for clustering. For this, we will set up a second Karaf instance on the same machine. For this, you'll find the following commands useful. So, create another Karaf instance using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; instance:create second</strong></span>
</pre></div><p>This will create a new Karaf instance that looks like a freshly extracted Apache Karaf ZIP archive.</p></li><li class="listitem">The second instance is created; now, we need to start this second instance. There is a command in Karaf to do so, which is as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; instance:start second</strong></span>
</pre></div></li><li class="listitem">This just started the second instance, which can now be connected to, by either an external SSH client or through Karaf. This can be done using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; instance:connect second</strong></span>
</pre></div></li><li class="listitem">With this, you are connected to the second instance of Karaf. We need to add the <code class="literal">cellar</code> repository to this instance too. This can be done using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@second()&gt; feature:repo-add cellar</strong></span>
</pre></div></li><li class="listitem">After the <code class="literal">cellar</code> feature repository becomes available to the second instance, the <code class="literal">cellar</code> feature is ready to be installed.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@second()&gt; feature:install cellar</strong></span>
</pre></div></li></ol></div><p>This installs<a id="id457" class="indexterm"/> the required bundles; therefore, we <a id="id458" class="indexterm"/>have two nodes ready to <a id="id459" class="indexterm"/>be clustered. As the Cellar cluster works with auto discovery through multicast, both nodes should be able to find each other.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>As Cellar uses Hazelcast<a id="id460" class="indexterm"/> as its underlying cluster technology, the multicast is handled by Hazelcast. More information about Hazelcast<a id="id461" class="indexterm"/> is available at <a class="ulink" href="http://www.hazelcast.org/docs/3.0/manual/html/ch12s02.html">http://www.hazelcast.org/docs/3.0/manual/html/ch12s02.html</a>.</p></div></div><p>These nodes can be checked by listing the available groups using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@second()&gt; cluster:group-list</strong></span>
</pre></div><p>This will list the available groups together with the nodes contained in each group. As there has been no configuration for any group yet, the default group contains both nodes—the root Karaf instance and the second instance. The following screenshot shows the execution of<a id="id462" class="indexterm"/> the <code class="literal">group-list</code> command, which is an alias of the <code class="literal">cluster:group-list</code> command:</p><div class="mediaobject"><img src="graphics/5081OS_06_01.jpg" alt="How to do it…"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec185"/>How it works…</h2></div></div></div><p>After the installation of Cellar on both nodes, Cellar created a default group on both the nodes, and therefore, both these nodes are automatically added to this default group. The basis of Cellar is a Hazelcast-based memory cluster configuration, which replicates itself to all known nodes in the cluster. Hazelcast itself scans the network via multicast for other instances of itself. Hazelcast can be configured to use other means of network connection technologies. Apache Karaf Cellar uses this behavior to synchronize the cluster configuration over the running nodes.</p><p>A Cellar cluster is defined by a group, where each group consists of a list of nodes. For each cluster group, there is a Hazelcast topic, which is the communication backend. With this topic, all nodes within the same group communicate changes in bundles, features, or configuration. Additionally, services and events are also communicated through this topic.</p><p>Due to<a id="id463" class="indexterm"/> this topic, the configuration of all <a id="id464" class="indexterm"/>nodes is combined to a shared<a id="id465" class="indexterm"/> cluster configuration, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_02.jpg" alt="How it works…"/></div></div></div>
<div class="section" title="Using Apache Karaf Cellar commands"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec61"/>Using Apache Karaf Cellar commands</h1></div></div></div><p>As with a lot of other<a id="id466" class="indexterm"/> features of Apache Karaf, Cellar provides a couple of commands to administer an Apache Karaf Cellar cluster.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec186"/>Getting ready</h2></div></div></div><p>Make sure that you follow the basic setup of the <span class="emphasis"><em>Installing Apache Karaf Cellar modules in Apache Karaf</em></span> recipe to run a simple Apache Karaf cluster.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec187"/>How to do it…</h2></div></div></div><p>We have two different kinds of commands to work with the Apache Karaf Cellar cluster: basic commands to manage and configure the cluster and some more enhanced commands for extra management.</p><div class="section" title="Group commands"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec05"/>Group commands</h3></div></div></div><p>After installing <a id="id467" class="indexterm"/>Cellar, there is already a default<a id="id468" class="indexterm"/> group available that contains all the future available nodes per default. Different tasks can be performed using the following commands:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Now, let's <a id="id469" class="indexterm"/>create a new group and add both nodes to it using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:group-create main-cluster</strong></span>
</pre></div><p>The previous command creates a new cluster group called <code class="literal">main-cluster</code>. This group contains no nodes in it. Check using the <code class="literal">group-list</code> command<a id="id470" class="indexterm"/> to see how the cluster looks right now. The result of this command can be seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_03.jpg" alt="Group commands"/></div></li><li class="listitem">The newly created group is still empty. Therefore, we need to add some nodes. Adding nodes to a cluster can be done in different ways. The following command is an example:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:group-pick default main-cluster</strong></span>
</pre></div><p>The following is the complete syntax for the preceding command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cluster:group-pick source-group destination-group number-of-nodes</strong></span>
</pre></div><p>It picks a number of nodes from the given source group and transfers these nodes to the target group. If no number is given, one is picked from the source group. The execution and what it looks like is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_04.jpg" alt="Group commands"/></div></li><li class="listitem">Another<a id="id471" class="indexterm"/> way of adding a node to a cluster group is to use the <code class="literal">join</code> command. With this command, you also have the possibility to add a node to more than one group.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:group-join main-cluster achims-macbook-pro.fritz.box:5702</strong></span>
</pre></div><p>The syntax of the preceding command is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cluster:group-join group-destination node-id</strong></span>
</pre></div><p>The <a id="id472" class="indexterm"/>command, including its output, is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_05.jpg" alt="Group commands"/></div></li><li class="listitem">As you can<a id="id473" class="indexterm"/> tell, the second node is now contained in both cluster groups, though we don't want to have this node in the default group anymore. For this, we need to remove it from this group by using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:group-quit default achims-macbook-pro.fritz.box:5702</strong></span>
</pre></div><p>The syntax for the preceding command is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cluster:group-quit group-id node-id</strong></span>
</pre></div><p>The command returns a list of the current state of the groups, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_06.jpg" alt="Group commands"/></div></li><li class="listitem">This empty group can be deleted using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:group-delete default</strong></span>
</pre></div></li></ol></div><p>When checking <a id="id474" class="indexterm"/>with the <code class="literal">cluster:group-list</code> command, you'll see that the default group can't be deleted. This is because of its default character. So, if you create a new test group and delete it right away, you will see that the test group has been created and deleted with the commands.</p></div><div class="section" title="The node commands"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec06"/>The node commands</h3></div></div></div><p>The following is a brief<a id="id475" class="indexterm"/> introduction of the <a id="id476" class="indexterm"/>node commands.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Similar to the <code class="literal">group-list</code> command, the <code class="literal">node-list</code> command<a id="id477" class="indexterm"/> will list all available nodes:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:node-list</strong></span>
</pre></div><p>The output of the preceding command is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_07.jpg" alt="The node commands"/></div></li><li class="listitem">Similar to a<a id="id478" class="indexterm"/> network ping, it is possible to ping a cluster node to test the network accessibility of this node. This can be done using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:node-ping achims-macbook-pro:5702</strong></span>
</pre></div><p>The output will be as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_08.jpg" alt="The node commands"/></div></li></ol></div></div><div class="section" title="Cluster configuration commands"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec07"/>Cluster configuration commands</h3></div></div></div><p>So far, the previous <a id="id479" class="indexterm"/>commands have been<a id="id480" class="indexterm"/> used for administration of the cluster itself, by either adding or removing cluster groups and configuring the nodes of one cluster group.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The last administrational<a id="id481" class="indexterm"/> command is the <code class="literal">cluster:sync</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:sync</strong></span>
</pre></div><p>This will<a id="id482" class="indexterm"/> force a synchronization of all nodes in the cluster, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_09.jpg" alt="Cluster configuration commands"/></div></li><li class="listitem">Now, the following commands are used to configure the content of the cluster. For example, it is possible to install features and bundles across the cluster. To list the currently available features for one cluster group, just issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:feature-list main-cluster</strong></span>
</pre></div><div class="mediaobject"><img src="graphics/5081OS_06_10.jpg" alt="Cluster configuration commands"/></div></li><li class="listitem">The <a id="id483" class="indexterm"/>preceding <a id="id484" class="indexterm"/>command also works for <a id="id485" class="indexterm"/>listing the bundles installed across the cluster:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-list main-cluster</strong></span>
</pre></div><p>This results in a list of bundles available to the cluster group. The output will be as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-list main-cluster</strong></span>
<span class="strong"><strong>Bundles in cluster group main-cluster</strong></span>
<span class="strong"><strong> ID     State        Name</strong></span>
<span class="strong"><strong>[0   ] [Active     ] OPS4J Base - Lang (1.4.0)</strong></span>
<span class="strong"><strong>[1   ] [Active     ] Apache Karaf :: Cellar :: Hazelcast (3.0.0.SNAPSHOT)</strong></span>
<span class="strong"><strong>[2   ] [Active     ] Apache Karaf :: Cellar :: Features (3.0.0.SNAPSHOT)</strong></span>
<span class="strong"><strong>[3   ] [Active     ] Apache Karaf :: Cellar :: Core (3.0.0.SNAPSHOT)</strong></span>
<span class="strong"><strong>[4   ] [Active     ] JLEdit :: Core (0.2.1)</strong></span>
<span class="strong"><strong>[5   ] [Active     ] Apache Karaf :: JAAS :: Command (3.0.1)</strong></span>
<span class="strong"><strong>[6   ] [Active     ] Apache Mina SSHD :: Core (0.9.0)</strong></span>
<span class="strong"><strong>[7   ] [Active     ] Apache Karaf :: Cellar :: Management (3.0.0.SNAPSHOT)</strong></span>
<span class="strong"><strong>[8   ] [Active     ] jansi (1.11.0)</strong></span>
</pre></div></li><li class="listitem">For<a id="id486" class="indexterm"/> further bundle<a id="id487" class="indexterm"/> interaction in the cluster, use the <a id="id488" class="indexterm"/>following special bundle commands for clusters:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cluster:bundle-* &lt;groupId&gt;</strong></span>
</pre></div><p>These bundle commands are similar to the standard Apache Karaf bundle commands. The scope of these commands is to distribute the command within the cluster.</p></li><li class="listitem">For features, the commands are similar to the<a id="id489" class="indexterm"/> <code class="literal">cluster:bundle</code> commands. Commands that are possible for features are also available to be run in the cluster scope:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cluster:feature-* &lt;groupId&gt;</strong></span>
</pre></div><p>The <code class="literal">cluster:feature</code> commands<a id="id490" class="indexterm"/> will work on the cluster as for a standalone Karaf instance.</p></li><li class="listitem">Similar to the bundle and feature commands, the configuration commands can also alter, set, or unset configurations which are valid throughout the cluster. Consider the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:config-list main-cluster</strong></span>
</pre></div><p>The output of the preceding <a id="id491" class="indexterm"/>command is the same as that of the <code class="literal">config:list</code> command, restricted only to the configurations that are valid for the cluster group, as can be seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_12.jpg" alt="Cluster configuration commands"/></div></li><li class="listitem">In <a id="id492" class="indexterm"/>general, the<a id="id493" class="indexterm"/> cluster configuration <a id="id494" class="indexterm"/>commands have the following pattern:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cluster:config-* &lt;groupId&gt;</strong></span>
</pre></div></li></ol></div><p>The preceding commands give the possibility to edit, delete, or add a configuration, which is then automatically shared throughout the cluster.</p></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec188"/>How it works…</h2></div></div></div><p>As seen, Apache Karaf Cellar provides a couple of specialized cluster commands. This functionality is based on the fact that all of the configurations, installed bundles, and installed features are shared throughout the cluster. To have a dedicated control over this information, it is possible to whitelist or blacklist certain information. This information is defined in two configuration files, <code class="literal">org.apache.karaf.cellar.node.cfg</code> for node configurations and <code class="literal">org.apache.karaf.cellar.groups.cfg</code> containing the group configuration information.</p><p>In general, it is better to work with features instead of bundles when deploying applications throughout the cluster. This makes it easier to filter whitelisted and blacklisted bundles or features for certain cluster nodes.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec189"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Learning Karaf Cellar</em></span>, <span class="emphasis"><em>Jean-Baptiste Onofré</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>, covers the insights of Cellar in greater detail compared to what can be done with this Cookbook.</li></ul></div></div></div>
<div class="section" title="Building and deploying a distributed architecture with Cellar"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec62"/>Building and deploying a distributed architecture with Cellar</h1></div></div></div><p>This recipe describes how to build a clustered application and the transparent usage of services throughout the cluster. We will show you how to create a Cellar-based <span class="strong"><strong>Distributed OSGi</strong></span> (<span class="strong"><strong>DOSGi</strong></span>) application<a id="id495" class="indexterm"/> and how you can profit from Apache Karaf Cellar.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec190"/>Getting ready</h2></div></div></div><p>It is essential that you<a id="id496" class="indexterm"/> finish at least the <span class="emphasis"><em>Installing Apache Karaf Cellar modules in Apache Karaf</em></span> recipe to have a clustered environment for testing. You <a id="id497" class="indexterm"/>should also be familiar with the <a id="id498" class="indexterm"/>cluster commands presented to <a id="id499" class="indexterm"/>you in the <span class="emphasis"><em>Using Apache Karaf Cellar commands</em></span> recipe. The sources used in this recipe can be found at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter6/chapter6-recipe3">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter6/chapter6-recipe3</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec191"/>How to do it…</h2></div></div></div><p>First of all, we will need an additional cluster group with an extra node. For this, we will create an additional instance first, using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; instance:create sender</strong></span>
</pre></div><p>Start this instance and install the <code class="literal">cellar</code> feature in it as described in the <span class="emphasis"><em>Installing Apache Karaf Cellar modules in Apache Karaf</em></span> recipe. This instance will be added to a new group. First, create a new cluster group using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:group-create second-cluster</strong></span>
</pre></div><p>Now, add the new instance to the newly created cluster group using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:group-pick default second-cluster</strong></span>
</pre></div><p>After this setup is done, we need to take care of the distributed OSGi service. For this, you will create three different bundles, where the first will contain the service interface, the second will contain the service implementation that is located on one node, and the third will contain the consuming bundle. </p><p>The following diagram shows this setup:</p><div class="mediaobject"><img src="graphics/5081OS_06_13.jpg" alt="How to do it…"/></div><p>First, we need <a id="id500" class="indexterm"/>to install the required feature. For this, we<a id="id501" class="indexterm"/> will install the<a id="id502" class="indexterm"/> <code class="literal">cellar-dosgi</code> feature <a id="id503" class="indexterm"/>on each node using the following <a id="id504" class="indexterm"/>command. By default, all Cellar features are blacklisted.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; feature:install cellar-dosgi</strong></span>
</pre></div><p>After this feature is installed in the cluster, you will have a new command to use. The <code class="literal">cluster:service-list</code> command will list <a id="id505" class="indexterm"/>all services that are distributed throughout the cluster. The command when called right after installing the feature will give you the following output:</p><div class="mediaobject"><img src="graphics/5081OS_06_14.jpg" alt="How to do it…"/></div><div class="section" title="Producing a service bundle"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec08"/>Producing a service bundle</h3></div></div></div><p>After this setup, we will <a id="id506" class="indexterm"/>need a bundle that provides a service that is available to remote clients. For this, we create a simple service that returns a random message. This can be done as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To register this service, we will use the following <code class="literal">blueprint.xml</code> file:<div class="informalexample"><pre class="programlisting">&lt;!-- Service Implementation --&gt;
&lt;bean id="messageService" class="com.packt.impl.MessageServiceImpl"/&gt;

&lt;!-- Registering the Service --&gt;
&lt;service ref="messageService" interface="com.packt.MessageService"&gt;
  &lt;service-properties&gt;
    &lt;entry key="service.exported.interfaces" value="*"/&gt;
  &lt;/service-properties&gt;
&lt;/service&gt;</pre></div></li><li class="listitem">Install the <code class="literal">chapter6-recipe3-interface</code> bundle from the code bundle on both cluster groups using the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-install master mvn:com.packt/chapter6-recipe3-interface/1.0.0-SNAPSHOT</strong></span>
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-install second-cluster mvn:com.packt/chapter6-recipe3-interface/1.0.0-SNAPSHOT</strong></span>
</pre></div></li><li class="listitem">After this, install the <code class="literal">chapter6-recipe3-producer</code> bundle from the code bundle on the second group, <code class="literal">second-cluster</code>, using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-install second-cluster mvn:com.packt/chapter6-recipe3-producer/1.0.0-SNAPSHOT</strong></span>
</pre></div></li><li class="listitem">The freshly-installed<a id="id507" class="indexterm"/> bundles need to be started. For<a id="id508" class="indexterm"/> easy<a id="id509" class="indexterm"/> finding of these <a id="id510" class="indexterm"/>installed bundles, issue a <code class="literal">bundle-list</code> command with the <code class="literal">grep</code> command, as shown in the following <a id="id511" class="indexterm"/>command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-list main-cluster | grep -i chapter</strong></span>
</pre></div><p>This results in the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-list main-cluster | grep chapter6</strong></span>
<span class="strong"><strong>[36  ] [Installed  ] chapter6-recipe3-interface (1.0.0.SNAPSHOT)</strong></span>
</pre></div></li><li class="listitem">Now that you have found the corresponding bundle ID, just issue a start command for it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-start main-cluster &lt;bundle id&gt;</strong></span>
</pre></div><p>A quick use of the <code class="literal">list</code> command will give you the bundle listing of the node, showing the freshly-installed and running bundle <code class="literal">chapter6-recipe3-interface</code>. This is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_16.jpg" alt="Producing a service bundle"/></div></li></ol></div><p>Now that we have checked the consuming side, we need to make sure the sending side is running. We need to look for the bundle that we just installed. This can be done using the following command: </p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-list second-cluster | grep -i chapter</strong></span>
</pre></div><p>This results in the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-list second-cluster | grep chapter6</strong></span>
<span class="strong"><strong>[38  ] [Installed  ] chapter6-recipe3-interface (1.0.0.SNAPSHOT)</strong></span>
<span class="strong"><strong>[39  ] [Installed  ] chapter6-recipe3-producer (1.0.0.SNAPSHOT)</strong></span>
</pre></div><p>We can start the bundle with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-start main-cluster &lt;bundle id&gt;</strong></span>
</pre></div><a id="id512" class="indexterm"/><p>After this bundle is started, we can check with the <code class="literal">cluster:service-list</code> command, called from the root bundle, for services available to the cluster. The result of this is as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_06_17.jpg" alt="Producing a service bundle"/></div></div><div class="section" title="Service consuming bundle"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec09"/>Service consuming bundle</h3></div></div></div><p>As the service is <a id="id513" class="indexterm"/>now available <a id="id514" class="indexterm"/>throughout<a id="id515" class="indexterm"/> the cluster, the consuming bundle can be installed on the main cluster and will consume this service. Consider the<a id="id516" class="indexterm"/> following <a id="id517" class="indexterm"/>code:</p><div class="informalexample"><pre class="programlisting">&lt;!-- reference service --&gt;
&lt;reference id="messageService" interface="com.packt.MessageService" /&gt;

&lt;!-- Service Implementation --&gt;
&lt;bean class="com.packt.consumer.MessageConsumer" init-method="doRun"&gt;
  &lt;property name="messageService" ref="messageService"/&gt;
&lt;/bean&gt;</pre></div><p>The consuming bundle retrieves the service reference from the registry and uses it. The consuming class is started with the <code class="literal">init-method</code> call.</p><p>The interface bundle is already installed because we have already issued the <code class="literal">cluster:bundle-install</code> command for it. Now, just install the <code class="literal">consumer</code> bundle on the root node, using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt;cluster:bundle-install main-cluster mvn:com.packt/chapter6-recipe3-consumer/1.0.0-SNAPSHOT</strong></span>
</pre></div><p>Now, start the <code class="literal">consumer</code> bundle by issuing the following command; you might be required to change the bundle ID:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-list master | grep -i chapter</strong></span>
<span class="strong"><strong>[36  ] [Active     ] chapter6-recipe3-interface (1.0.0.SNAPSHOT)</strong></span>
<span class="strong"><strong>[52  ] [Installed  ] chapter6-recipe3-consumer (1.0.0.SNAPSHOT)</strong></span>
</pre></div><p>You can start the<a id="id518" class="indexterm"/> bundle using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; cluster:bundle-start &lt;bundle-id&gt;</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>Note that if you started the second node in a separate terminal, you will gain the most from this, as you'll see both nodes receiving the messages from the sender.</p></div></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec192"/>How it works…</h2></div></div></div><p>By default, <a id="id519" class="indexterm"/>Cellar DOSGi doesn't share any service<a id="id520" class="indexterm"/> throughout the cluster. A service<a id="id521" class="indexterm"/> meant to be used in a cluster environment<a id="id522" class="indexterm"/> and to be bound to a dedicated cluster node will require special handling on the service. You might have noticed the extra service property on the <code class="literal">MessageService</code> registration. The property entry, <code class="literal">service.exported.interfaces</code>, marks this service to be exported throughout the cluster. Cellar will create a proxy for the remote service on the nodes not containing the actual service.</p><p>Why did we need the extra node and group? As Apache Karaf Cellar is for provisioning bundles across a cluster group, this will result in spreading all bundles across the same group. While running services across a cluster actually needs the separation of bundles across the cluster, this results in actually separating nodes with explicit groups again.</p><p>Take a look at the following screenshot; it sums up the communication ways within one cluster group. Installation of one bundle throughout the cluster is either achieved through the commands mentioned previously or by just installing this bundle on <span class="strong"><strong>node 1</strong></span>. This <span class="emphasis"><em>state</em></span> of a new bundle will be synchronized throughout the cluster group unless this explicit bundle is blacklisted. Another way of disabling this automatic synchronization throughout the cluster is by using a management node. A management node requires one <span class="emphasis"><em>master</em></span> node within the cluster group that manages the installation of the features across the cluster. This works contrary to the default setup and idea behind the <span class="emphasis"><em>all-knowing</em></span> cluster <span class="emphasis"><em>brain</em></span>. For more details, check out <span class="emphasis"><em>Learning Karaf Cellar</em></span>, <span class="emphasis"><em>Jean-Baptiste Onofré</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>.</p><div class="mediaobject"><img src="graphics/5081OS_06_19.jpg" alt="How it works…"/></div></div></div></body></html>