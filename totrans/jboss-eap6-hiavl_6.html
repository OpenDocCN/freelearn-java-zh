<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Clustering with SSL"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Clustering with SSL</h1></div></div></div><p>In the previous two chapters, we have learnt to use <code class="literal">JK</code> and <code class="literal">mod_cluster</code> as the load balancer to proxy user requests to EAP6 backend servers, and all the communications between load balancer and EAP6 servers are transferred in <span class="emphasis"><em>plaintext</em></span>. In practice, there are situations where we need to secure the transportation layer by enabling <span class="strong"><strong>SSL</strong></span>. In this chapter, we'll learn how to enable SSL in the clustering environment. We'll first learn how to enable SSL when using JBoss EAP6 independently, and then we'll learn how to enable SSL in a clustering environment that has httpd and EAP6 servers running together. For the clustering environment, we'll use <code class="literal">JK</code> as a load balancer in this chapter. Because using <code class="literal">mod_cluster</code> has provided a more fine-grained integration with SSL, we'll talk about this topic in the next chapter.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>You need to have some basic knowledge of public key cryptography and SSL before reading this chapter.</p></div></div><div class="section" title="Using SSL in JBoss EAP6"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec38"/>Using SSL in JBoss EAP6</h1></div></div></div><p>First let us see <a id="id268" class="indexterm"/>how to enable SSL in EAP6 directly. This is useful <a id="id269" class="indexterm"/>when we are using EAP6 as a standalone server and it doesn't have any load balancing in front. JBoss EAP6 provides SSL support out of the box and in this section, let's see how to enable it.</p><div class="section" title="Enabling SSL in EAP6"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec54"/>Enabling SSL in EAP6</h2></div></div></div><p>To enable <a id="id270" class="indexterm"/>SSL in EAP6, we need to create an x.509 certificate for the EAP6 server. First prepare a clean copy of <code class="literal">JBoss EAP 6.1.0.Final</code> to make sure the configurations are default. After the clean copy of EAP6 server is ready for use, please start it in the standalone mode, and then deploy <code class="literal">cluster-demo1</code> to the running server and then stop the server. That's all we need to do for preparation. We'll use it to test the HTTPS connection later.</p><p>Now let's create a directory called <code class="literal">certs</code> in the EAP6 base path. We'll use it to store the server certificate.</p><p>Then we need <a id="id271" class="indexterm"/>to navigate to the <code class="literal">certs</code> directory and use the <code class="literal">keytool</code> command provided by <span class="strong"><strong>Java Runtime Environment</strong></span> (<span class="strong"><strong>JRE</strong></span>)<a id="id272" class="indexterm"/> to generate a certificate for the EAP6 server. Here is the command:</p><div class="informalexample"><pre class="programlisting">$ keytool -genkey -keystore myserver.ks</pre></div><p>The running process is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/2432_06_02.jpg" alt="Enabling SSL in EAP6"/></div><p>The <span class="strong"><strong>keystore password</strong></span> and <span class="strong"><strong>key password</strong></span> is <span class="strong"><strong>packt000</strong></span>
<a id="id273" class="indexterm"/>. Please note that in a production environment, we must set <span class="strong"><strong>CN</strong></span> to the hostname of our website. For this example, my hostname is called <span class="strong"><strong>mini</strong></span>, so I use it as <span class="strong"><strong>CN</strong></span> of the certificate. Now let's check the generated <code class="literal">keystore</code> file and the key that is contained in it:</p><div class="mediaobject"><img src="graphics/2432_06_03.jpg" alt="Enabling SSL in EAP6"/></div><p>As shown in <a id="id274" class="indexterm"/>the preceding screenshot, our generated key and its certificate are stored in <code class="literal">keystore</code>. The default <span class="strong"><strong>Alias name</strong></span> of the key is <span class="strong"><strong>mykey</strong></span>, and its certificate is associated with it. If we look carefully, we can see that the <span class="strong"><strong>Issuer</strong></span> and the <span class="strong"><strong>Owner</strong></span> of this certificate are the same. That means this is a self-signed certificate. In a production environment, we need to find an authority (like <span class="strong"><strong>VeriSign</strong></span>) to sign this certificate. After the authority has signed it, the <span class="strong"><strong>Issuer</strong></span> will be changed to the authority.</p><p>Now we need to configure the EAP6 web subsystem to use the key together with its certificate. Let's open <code class="literal">standalone.xml</code> and find the subsystem <code class="literal">urn:jboss:domain:web:1.4</code>. Then we need to find an HTTP connector and change its scheme to HTTPS. Next we need to add an SSL element to tell EAP6 the position of our <code class="literal">keystore</code> and the alias name of our key. The modifications should be as follows:</p><div class="mediaobject"><img src="graphics/2432_06_04.jpg" alt="Enabling SSL in EAP6"/></div><p>That's all we need to configure in <code class="literal">standalone.xml</code>. In addition, please note the port used by HTTPS in the configuration file is <code class="literal">8443</code>:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding name="https" port="8443"/&gt;</pre></div><p>So we need <a id="id275" class="indexterm"/>to use this port to access the EAP6 web subsystem. Now we can start the EAP6 server and test the HTTPS connection:</p><div class="informalexample"><pre class="programlisting">$ curl -k https://localhost:8443/cluster-demo1/index.jsp
&lt;html&gt;
&lt;body&gt;
&lt;h2&gt;Hello World!&lt;/h2&gt;

Hello! The time is now Tue Nov 19 20:40:52 CST 2013
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>The <code class="literal">-k</code> option of <span class="strong"><strong>cURL</strong></span>
<a id="id276" class="indexterm"/> is to bypass the certificate verification. Since our certificate is not signed by an authority, by default it's not trusted by cURL or any other web browsers.</p><p>In this section, we have learned how to enable SSL in the EAP6 standalone mode. Enabling SSL in the domain mode is similar; we also need to set the web subsystem to use the HTTPS scheme and add the certificate information in the SSL element. I'd like to leave this work to you.</p></div></div></div>
<div class="section" title="Using SSL in the JBoss EAP6 cluster"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec39"/>Using SSL in the JBoss EAP6 cluster</h1></div></div></div><p>In a clustering <a id="id277" class="indexterm"/>environment, <a id="id278" class="indexterm"/>applying SSL does not seem as straightforward as in a single-server environment. We have a load balancer and worker nodes in a cluster, so we need to decide in which place we should enable SSL. Here are the two possible places:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The communication between users and the load balancer</li><li class="listitem" style="list-style-type: disc">The communication between the load balancer and the worker nodes</li></ul></div><p>In practice, we <a id="id279" class="indexterm"/>usually enable SSL between users and the load balancer to secure their communication, and use <span class="emphasis"><em>cleartext</em></span> communication between the load balancer and the worker nodes. Here is the deployment diagram:</p><div class="mediaobject"><img src="graphics/2432_06_06.jpg" alt="Using SSL in the JBoss EAP6 cluster"/></div><p>This is reasonable because the worker nodes are usually protected by a firewall, and the purpose of using SSL is not only for encrypting communication channel, but a certificate signed by an authority can also help the customers' web browsers to verify the identity of the web server.</p><p>Enabling SSL communication between the load balancer and the worker node also creates many overheads in the communication layer, and encrypting/decrypting network data consumes CPU power. </p><p>
<code class="literal">JK</code> doesn't support the SSL communication between the load balancer and the worker node, and this is not a problem in most situations as I explained earlier, <code class="literal">mod_cluster</code> supports the secure connection between the load balancer and the worker node, and we will see how to configure it in the next chapter.</p><div class="section" title="Configuring JK with SSL"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec55"/>Configuring JK with SSL</h2></div></div></div><p>Now let's start to learn how<a id="id280" class="indexterm"/> to enable SSL with <code class="literal">JK</code>. Let's see the deployment diagram first:</p><div class="mediaobject"><img src="graphics/2432_06_08.jpg" alt="Configuring JK with SSL"/></div><p>Actually what we need to do is just enable SSL in Apache httpd. As we know,<code class="literal">mod_jk</code> is a lightweight load balancer and it only supports the AJP connection to worker nodes. That means the communication between <code class="literal">JK</code> and EAP6 servers will be <span class="emphasis"><em>cleartext</em></span> AJP13 protocol.</p><p>To enable SSL in httpd, <a id="id281" class="indexterm"/>we need to do some preparation work. Please restore httpd with <code class="literal">JK</code> installed, we'll configure SSL based on it. If you've forgotten how to configure httpd and <code class="literal">JK</code> properly, please read <a class="link" href="ch04.html" title="Chapter 4. Load Balancing with mod_jk">Chapter 4</a>, <span class="emphasis"><em>Load Balancing with mod_j</em></span>
<span class="emphasis"><em>k</em></span> again.</p><div class="section" title="Generating a certificate for httpd"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec20"/>Generating a certificate for httpd</h3></div></div></div><p>Now let's prepare<a id="id282" class="indexterm"/> the server certificate for httpd to use. First, let's create a <code class="literal">certs</code> directory in httpd:</p><div class="informalexample"><pre class="programlisting">/packt/httpd$ mkdir certs </pre></div><p>Then we need to navigate to the <code class="literal">certs</code> directory and generate a certificate for httpd. For httpd, we'll need to use <span class="strong"><strong>OpenSSL</strong></span>
<a id="id283" class="indexterm"/> to generate a certificate, because httpd doesn't support the <code class="literal">keystore</code> format used by Java applications. Actually, the certificate formats are all the same, but the storing structures generated by <code class="literal">keytool</code> and OpenSSL are different. OpenSSL separates the keys and certificates into standalone files, but <code class="literal">keytool</code> stores them in a single <code class="literal">keystore</code> file.</p><p>Now let's generate a key, and here is the command and its process:</p><div class="informalexample"><pre class="programlisting">$ openssl genrsa -des3 -out lb.key 1024
Generating RSA private key, 1024 bit long modulus
Enter pass phrase for lb.key: packt000
Verifying - Enter pass phrase for lb.key: packt000</pre></div><p>Next we need <a id="id284" class="indexterm"/>to generate a certificate file relative to this key file. Here is the command and its process:</p><div class="informalexample"><pre class="programlisting">$ openssl req -new -key lb.key -out lb.csr
Enter pass phrase for lb.key: packt000
Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Beijing
Locality Name (eg, city) []:Beijing
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Personal
Organizational Unit Name (eg, section) []:Personal
Common Name (e.g. server FQDN or YOUR name) []: lb
Email Address []:
A challenge password []:
An optional company name []:</pre></div><p>Now we get the certificate request file <code class="literal">lb.csr</code> and its related key file <code class="literal">lb.key</code>. Next is to sign the certificate request file. Because this certificate is for testing, we don't need to find an authority to sign it. We can use the key file to sign its own certificate request file. So this is a self-signed certificate. Here is the command and the running process:</p><div class="informalexample"><pre class="programlisting">$ openssl x509 -req -days 365 -in lb.csr -signkey lb.key -out lb.crt
Signature ok
subject=/C=CN/ST=Beijing/L=Beijing/O=Personal/OU=Personal/CN=kb
Getting Private key
Enter pass phrase for lb.key: packt000</pre></div><p>The signed certificate file is generated and the name is <code class="literal">lb.crt</code>. This file is in the standard format, so we can also use <code class="literal">keytool</code> to check its content, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">$ keytool -v -printcert -file lb.crt
Owner: CN=kb, OU=Personal, O=Personal, L=Beijing, ST=Beijing, C=CN
Issuer: CN=kb, OU=Personal, O=Personal, L=Beijing, ST=Beijing, C=CN</pre></div><p>From the previous code snippet, we can see that the <code class="literal">Owner</code> and <code class="literal">Issuer</code> of this certificate are same. That was the process to generate a self-signed certificate with OpenSSL. Actually, we can wrap up the preceding processes into a single command:</p><div class="informalexample"><pre class="programlisting">$ openssl req -new -newkey rsa -days 365 -x509 -subj "/C=CN/ST=Beijing/L=Beijing/O=Personal/OU=Personal/CN=httpd" -keyout lb.key -out lb.crt</pre></div><p>Using the preceding<a id="id285" class="indexterm"/> command, we can generate a key file and its self-signed certificate in one step.</p></div><div class="section" title="Configuring httpd to use certificates"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec21"/>Configuring httpd to use certificates</h3></div></div></div><p>We need to add <a id="id286" class="indexterm"/>several directives into <code class="literal">httpd.conf</code>. The first step is to ask httpd to listen to port <code class="literal">443</code>, this is the standard port of https. I'm reusing the cluster configuration from the previous two chapters, so I'm still running my httpd on the machine <code class="literal">lb</code>, and I'll configure it to listen to the public SSL port:</p><div class="informalexample"><pre class="programlisting">Listen 172.16.123.1:443</pre></div><p>And don't forget to comment out the access to port 80, because we don't want users to connect without HTTPS:</p><div class="informalexample"><pre class="programlisting">#Listen 172.16.123.1:80</pre></div><p>Now we need to configure <code class="literal">JK</code>, and its configuration file is in <code class="literal">conf.d/httpd-jk.conf</code>. Please delete all the contents inside and replace it with the following content:</p><div class="informalexample"><pre class="programlisting">LoadModule jk_module modules/mod_jk.so

&lt;IfModule jk_module&gt;
  JkWorkersFile conf/workers.properties
  JkShmFile logs/mod_jk.shm
  JkWatchdogInterval 60

  &lt;VirtualHost 172.16.123.1:443&gt;
    SSLEngine on
    SSLCertificateFile /packt/httpd/certs/lb.crt
    SSLCertificateKeyFile /packt/httpd/certs/lb.key        

    JkMount /* lb
    JkLogFile logs/mod_jk.log
    JkLogLevel debug
  &lt;/VirtualHost&gt;
&lt;/IfModule&gt;</pre></div><p>As shown in the preceding configuration, we have added a <code class="literal">VirtualHost</code> bound to the port <code class="literal">443</code>. In addition, we have enabled the SSL engine and provided the server certificate and its key files to use. Moreover, we have put the JkMount point inside this virtual host, so the user requests to HTTPS will be proxied by <code class="literal">JK</code> and sent to the EAP6 servers in behind.</p><p>That's all we need to configure in httpd. Because the communication between httpd and the EAP6 servers are still using the plaintext AJP13 protocol, so we don't need to change any configuration in EAP6. Now we can start the EAP6 servers and the httpd server. During the httpd server startup, it needs us to input the pass phrase of our key. The process is shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$ sudo httpd -k start -f /packt/httpd/conf/httpd.conf
Apache/2.2.25 mod_ssl/2.2.25 (Pass Phrase Dialog)</pre></div><p>Some of your private key files are encrypted for security reasons.</p><p>In order to read them you have to provide the pass phrases.</p><div class="informalexample"><pre class="programlisting">Server localhost:443 (RSA)
Enter pass phrase: packt000

OK: Pass Phrase Dialog successful.</pre></div><p>If you have<a id="id287" class="indexterm"/> set <code class="literal">LogLevel</code> to <code class="literal">debug</code> in <code class="literal">httpd.conf</code>, you can see many SSL-related log outputs in <code class="literal">logs/error_log</code>. It's a good source to do analysis if anything goes wrong. Now we can access the load balancer by using HTTPS and see that the requests are forwarded to the EAP6 servers:</p><div class="informalexample"><pre class="programlisting">$ curl -k https://172.16.123.1/cluster-demo1/index.jsp
&lt;html&gt;
&lt;body&gt;
&lt;h2&gt;Hello World!&lt;/h2&gt;

Hello! The time is now Tue Nov 19 22:40:52 CST 2013
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>If we use <span class="strong"><strong>Wireshark</strong></span>
<a id="id288" class="indexterm"/> to monitor the proxy channel between httpd and EAP6, we can see they are still using the <span class="emphasis"><em>plaintext</em></span> AJP13 protocol to communicate:</p><div class="mediaobject"><img src="graphics/2432_06_17.jpg" alt="Configuring httpd to use certificates"/></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Summary</h1></div></div></div><p>In this chapter, we have got an overview on applying SSL to EAP6 and the clustering environment, and we have seen how to configure SSL and <code class="literal">JK</code> together into httpd. In the next chapter, we'll learn how to apply SSL with <code class="literal">mod_cluster</code>.</p></div></body></html>