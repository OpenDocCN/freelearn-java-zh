<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer038">
<h1 class="chapter-number" id="_idParaDest-81"><a id="_idTextAnchor106"/>4</h1>
<h1 id="_idParaDest-82"><a id="_idTextAnchor107"/>JDBC-based Authentication</h1>
<p>In the previous chapter, we saw how we can extend Spring Security to utilize our <strong class="source-inline">CalendarDao</strong> interface and our existing domain model to authenticate users. In this chapter, we will see how we can use Spring Security’s built-in JDBC support. To keep things simple, this chapter’s sample code is based on our Spring Security setup from <a href="B21757_02.xhtml#_idTextAnchor043"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">Getting Started with Spring Security</em>. In this chapter, we will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Using Spring Security’s built-in JDBC-based <span class="No-Break">authentication support</span></li>
<li>Utilizing Spring Security’s group-based authorization to make administering <span class="No-Break">users easier</span></li>
<li>Learning how to use Spring Security’s <span class="No-Break">UserDetailsManager interface</span></li>
<li>Configuring Spring Security to utilize the existing CalendarUser schema to <span class="No-Break">authenticate users</span></li>
<li>Learning how we can secure passwords using Spring Security’s new <span class="No-Break">cryptography module</span></li>
<li>Using Spring Security’s default <span class="No-Break">JDBC authentication</span></li>
</ul>
<p>If your application has not yet implemented security, or if your security infrastructure is using a database, Spring Security provides out-of-the-box support that can simplify the solving of your security needs. Spring Security provides a default schema for users, authorities, and groups. If that does not meet your needs, it allows for the querying and managing of users to be customized. In the next section, we are going to go through the basic steps for setting up JDBC authentication with <span class="No-Break">Spring Security.</span></p>
<p>This chapter's code in action link is <span class="No-Break">here: </span><a href="https://packt.link/of0XA"><span class="No-Break">https://packt.link/of0XA</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-83"><a id="_idTextAnchor108"/>Installing the required dependencies</h1>
<p>Our <a id="_idIndexMarker217"/>application has already defined all the necessary dependencies required for this chapter. However, if you are using Spring Security’s JDBC support, you are likely going to want the following dependencies listed in your <strong class="source-inline">build.gradle</strong> file. It is important to highlight that the JDBC driver that you will use will depend on which database you are using. Consult your database vendor’s documentation for details on which driver is needed for <span class="No-Break">your database.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Remember that all the Spring versions need to match, and all Spring Security versions need to match (this includes transitive dependency versions). If you are having difficulty getting this to work in your own application, you may want to define the dependency management section in <strong class="source-inline">build.gradle</strong> to enforce this, as shown in <a href="B21757_02.xhtml#_idTextAnchor043"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">Getting Started with Spring Security</em>. As previously mentioned, you will not need to worry about this when using the sample code, since we have already set up the necessary dependencies <span class="No-Break">for you.</span></p>
<p>The following snippet defines the required dependencies needed for this chapter, including Spring Security and <span class="No-Break">JDBC dependencies:</span></p>
<pre class="source-code">
//build.gradle
dependencies {
...
    // spring-jdbc
    implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'
    // H2 db
    implementation 'com.h2database:h2'
    // spring-security
    implementation 'org.springframework.boot:spring-boot-starter-security'
...
}</pre> <p>The <a id="_idIndexMarker218"/>main change here of the <strong class="source-inline">build.gradle</strong>, is to add the <strong class="source-inline">spring-boot-starter-data-jdbc</strong> dependency, to enable the Spring <span class="No-Break">JDBC support.</span></p>
<h1 id="_idParaDest-84"><a id="_idTextAnchor109"/>Using the H2 database</h1>
<p>The first<a id="_idIndexMarker219"/> portion of this exercise involves setting up an instance of the Java-based H2 which is an open-source, in-memory and embedded relational database written in Java. It is designed to be fast, lightweight, and easy to use. H2 database will be populated with the Spring Security default schema. We’ll configure H2 to run in memory using Spring’s <strong class="source-inline">EmbeddedDatabase</strong> configuration feature a significantly simpler method of configuration than setting up the database by hand. You can find additional information on the H2 website<a id="_idIndexMarker220"/> <span class="No-Break">at </span><a href="http://www.h2database.com/"><span class="No-Break">http://www.h2database.com/</span></a><span class="No-Break">.</span></p>
<p>Keep in mind that in our sample application, we’ll primarily use H2 due to its ease of setup. Spring Security will work with any database that supports ANSI SQL out of the box. We encourage you to tweak the configuration and use the database of your preference if you’re following along with the examples. As we didn’t want this portion of the book to focus on the complexities of database setup, we chose convenience over realism for the purpose<a id="_idTextAnchor110"/> of <span class="No-Break">the exercises.</span></p>
<p>In the following subsections, we will provide sample SQL scripts for our JBCP Calendar application. The scripts will be configured using H2 <span class="No-Break">embedded database.</span></p>
<p>Finally, we will enable the spring-security support, we will have to add a custom implementation <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">UserDetailsManager</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-85"><a id="_idTextAnchor111"/>Provided JDBC scripts</h2>
<p>We’ve supplied all the SQL files<a id="_idIndexMarker221"/> that are used for creating the schema and data in an H2 database for this chapter in the <strong class="source-inline">src/main/resources/database/h2/</strong> folder. Any files prefixed with <strong class="bold">security</strong> are to support Spring Security’s default JDBC implementation. Any SQL files prefixed with <strong class="source-inline">calendar</strong> are custom SQL files for the JBCP calendar application. Hopefully, this will make running the samples a little easier. If you’re following along with your own database instance, you may have to adjust the schema definition syntax to fit your particular database. Additional database schemas can be found in the Spring Security reference. You can find a link to the Spring Security Reference in the book’s <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional </em><span class="No-Break"><em class="italic">Reference Mater<a id="_idTextAnchor112"/>ial.</em></span></p>
<h2 id="_idParaDest-86"><a id="_idTextAnchor113"/>Configuring the H2 embedded database</h2>
<p>To configure the <a id="_idIndexMarker222"/>H2 embedded database, we need to create a <strong class="source-inline">DataSource</strong> and run SQL to create the Spring Security table structure. We will need to update the SQL that is loaded at startup to include Spring Security’s basic schema definition, Spring Security user definitions, and the authority mappings for users. You can find the <strong class="source-inline">DataSource</strong> definition and the relevant updates in the following <span class="No-Break">code snippet:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/DataSourceConfig. Java
@Bean
public DataSource dataSource() {
    return new EmbeddedDatabaseBuilder()
          .setName("dataSource")
          .setType(EmbeddedDatabaseType.H2)
          .addScript("/database/h2/calendar-schema.sql")
          .addScript("/database/h2/calendar-data.sql")
          <strong class="bold">.addScript("/database/h2/security-schema.sql")</strong>
<strong class="bold">          .addScript("/database/h2/security-users.sql")</strong>
<strong class="bold">          .addScript("/database/h2/security-user-authorities.sql")</strong>
          .build();
}</pre> <p>Remember that the <strong class="source-inline">EmbeddedDatabaseBuilder()</strong> method creates this database only in memory, so you won’t see anything on the disk, and you won’t be able to use standard tools to query it. However, you can use the H2 console that is embedded in the application to interact with the database. See the instructions on the <strong class="bold">Welcome</strong> page of our applicati<a id="_idTextAnchor114"/>on to learn how to <span class="No-Break">use it.</span></p>
<h2 id="_idParaDest-87"><a id="_idTextAnchor115"/>Configuring a JDBC UserDetailsManager implementation</h2>
<p>We’ll modify the <strong class="source-inline">SecurityConfig.java</strong> file to declare<a id="_idIndexMarker223"/> that we’re using a <span class="No-Break">JDBC </span><span class="No-Break"><strong class="source-inline">User</strong></span><strong class="source-inline">
DetailsManager</strong> implementation, instead of the Spring Security <span class="No-Break">in-memory </span><span class="No-Break"><strong class="source-inline">User</strong></span><strong class="source-inline">
DetailsService</strong> implementation that we configured in<em class="italic"> </em><a href="B21757_02.xhtml#_idTextAnchor043"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">Getting Started with Spring Security</em>. This is done with a simple change to the <strong class="source-inline">UserDetailsManager</strong> declaration, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@Bean
public UserDetailsManager userDetailsService(DataSource dataSource) {
    return new JdbcUserDetailsManager(dataSource);
}</pre> <p>We replace the previous <strong class="source-inline">configure(AuthenticationManagerBuilder)</strong> method, along with all of the child elements, with the <strong class="source-inline">userDetailsService()</strong> method, as shown <a id="_idTextAnchor116"/>in the preceding <span class="No-Break">code snippet.</span></p>
<p>In this section, we have been able to configure H2 database with custom <strong class="source-inline">UserDetailsManager</strong> implementation, to enable Spring <span class="No-Break">Security support.</span></p>
<h1 id="_idParaDest-88"><a id="_idTextAnchor117"/>The default user schema of Spring Security</h1>
<p>Let’s take a <a id="_idIndexMarker224"/>look at each of the SQL files used to initialize the database. The first script we added contains the default Spring Security schema definition for users and their authorities. The following script has been adapted from Spring Security’s Reference, which is listed in the <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional Reference Material</em> to have explicitly named constraints, to make <span class="No-Break">troubleshooting easier:</span></p>
<pre class="source-code">
//src/main/resources/database/h2/security-schema.sql
create table users
(
    username varchar(256) not null primary key,
    password varchar(256) not null,
    enabled  boolean      not null
);
create table authorities
(
    username  varchar(256) not null,
    authority varchar(256) not null,
    constraint fk_authorities_users foreign key (username) references users (username)
);
create unique index ix_auth_username on authorities (username, authority);</pre> <h2 id="_idParaDest-89"><a id="_idTextAnchor118"/>Defining users</h2>
<p>The <a id="_idIndexMarker225"/>next script is in charge of defining the users in our application. The included SQL statement creates the same users that we have used throughout the entire book so far. The file also adds an additional user, <strong class="source-inline">disabled1@example.com</strong>, who will not be able to log in since we indicate the user <span class="No-Break">as disabled:</span></p>
<pre class="source-code">
//src/main/resources/database/h2/security-users.sql
insert into users (username, password, enabled)
values ('user1@example.com', '{noop}user1', 1);
insert into users (username, password, enabled)
values ('admin1@example.com', '{noop}admin1', 1);
insert into users (username, password, enabled)
values ('user2@example.com', '{noop}admin1', 1);
insert into users (username, password, enabled)
values ('disabled1@example.com', '{noop}disabled1', 0);
insert into users (username, password, enabled)
values ('admin', '{noop}admin', 1);</pre> <h2 id="_idParaDest-90"><a id="_idTextAnchor119"/>Defining user authorities</h2>
<p>You may have noticed that there<a id="_idIndexMarker226"/> is no indication if a user is an administrator or a regular user. The next file specifies a direct mapping of the user to the corresponding authorities. If a user did not have an authority mapped to it, Spring Security would not allow that user to be <span class="No-Break">logged in:</span></p>
<pre class="source-code">
//src/main/resources/database/h2/security-user-authorities.sql
insert into authorities(username, authority)
values ('user1@example.com', 'ROLE_USER');
insert into authorities(username, authority)
values ('admin1@example.com', 'ROLE_ADMIN');
insert into authorities(username, authority)
values ('admin1@example.com', 'ROLE_USER');
insert into authorities(username, authority)
values ('user2@example.com', 'ROLE_USER');
insert into authorities(username, authority)
values ('disabled1@example.com', 'ROLE_USER');</pre> <p>After the SQL is added to the embedded database configuration, we should be able to start the application and log in. Try logging in with the new user using <strong class="source-inline">disabled1@example.com</strong> as the <strong class="source-inline">username</strong> and <strong class="source-inline">disabled1</strong> as the <strong class="source-inline">password</strong>. Notice that Spring Security does not allow the user to log in and provides the<a id="_idIndexMarker227"/> error message <strong class="source-inline">Reason: User </strong><span class="No-Break"><strong class="source-inline">is disabled</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">calendar04.01-calendar</strong></span><span class="No-Break">.</span></p>
<p>In this section, we have used the default Spring Security user schema and authorities. In the next section, we will explore how we can <a id="_idIndexMarker228"/>define <strong class="bold">Group Based Access </strong><span class="No-Break"><strong class="bold">Control</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">GBAC</strong></span><span class="No-Break">).</span></p>
<h1 id="_idParaDest-91"><a id="_idTextAnchor120"/>Exploring UserDetailsManager interface</h1>
<p>We have already leveraged <a id="_idIndexMarker229"/>the <strong class="source-inline">InMemoryUserDetailsManager</strong> class in Spring Security in <a href="B21757_03.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Custom Authentication</em>, to look up the current <strong class="source-inline">CalendarUser</strong> application in our <strong class="source-inline">SpringSecurityUserContext</strong> implementation of <strong class="source-inline">UserContext</strong>. This allowed us to determine which <strong class="source-inline">CalendarUser</strong> should be used when looking up the events for the <strong class="bold">My Events</strong> page. <a href="B21757_03.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Custom Authentication</em>, also demonstrated how to update the <strong class="source-inline">DefaultCalendarService.java</strong> file to utilize <strong class="source-inline">InMemoryUserDetailsManager</strong>, to ensure that we created a new Spring Security user when we created <strong class="source-inline">CalendarUser</strong>. This chapter reuses exactly the same code. The only difference is that the <strong class="source-inline">UserDetailsManager</strong> implementation is backed by the <strong class="source-inline">JdbcUserDetailsManager</strong> class of Spring Security, which uses a database instead of an <span class="No-Break">in-memory datastore.</span></p>
<p>What other features does <strong class="source-inline">UserDetailsManager</strong> provide out of <span class="No-Break">the box?</span></p>
<p>Although these types of functions are relatively easy to write with additional JDBC statements, Spring Security actually provides out-of-the-box functionality to support many<a id="_idIndexMarker230"/> common <strong class="bold">Create, Read, Update, and Delete </strong>(<strong class="bold">CRUD</strong>) operations on users in JDBC databases. This can be convenient for simple systems, and a good base to build on for any custom requirements that a user <span class="No-Break">may have:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-1">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Method</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">void </strong><span class="No-Break"><strong class="source-inline">createUser(UserDetails user)</strong></span></p>
</td>
<td class="No-Table-Style">
<p>It creates a new user with the given <strong class="source-inline">UserDetails</strong> information, including any declared <span class="No-Break"><strong class="source-inline">GrantedAuthority</strong></span><span class="No-Break"> authorities.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">void updateUser(final </strong><span class="No-Break"><strong class="source-inline">UserDetails user)</strong></span></p>
</td>
<td class="No-Table-Style">
<p>It updates a user with the given <strong class="source-inline">UserDetails</strong> information. It updates <strong class="source-inline">GrantedAuthority</strong> and removes the user from the <span class="No-Break">user cache.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">void </strong><span class="No-Break"><strong class="source-inline">deleteUser(String username)</strong></span></p>
</td>
<td class="No-Table-Style">
<p>It deletes the user with the given username and removes the user from the <span class="No-Break">user cache.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">boolean </strong><span class="No-Break"><strong class="source-inline">userExists(String username)</strong></span></p>
</td>
<td class="No-Table-Style">
<p>It indicates whether or not a user (active or inactive) exists with the <span class="No-Break">given username.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">void changePassword(String oldPassword, </strong><span class="No-Break"><strong class="source-inline">String</strong></span><span class="No-Break"> </span><span class="No-Break"><strong class="source-inline">newPassword)</strong></span></p>
</td>
<td class="No-Table-Style">
<p>It changes the password of the currently logged-in user. The user must then supply the correct password in order for the operation <span class="No-Break">to succeed.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 4.1 – Custom database requirements settings</p>
<p>If <strong class="source-inline">UserDetailsManager</strong> does not<a id="_idIndexMarker231"/> provide all the methods that are necessary for your application, you can extend the interface to provide these custom requirements. For example, if you needed the ability to list all of the possible users in an administrative view, you could write your own interface with this method and provide an implementation that points to the same datastore as the <strong class="source-inline">UserDetailsManager</strong> implementation you are<a id="_idTextAnchor121"/> <span class="No-Break">currently using.</span><a id="_idTextAnchor122"/></p>
<h2 id="_idParaDest-92"><a id="_idTextAnchor123"/>Group-based access control</h2>
<p>The <strong class="source-inline">JdbcUserDetailsManager</strong> class<a id="_idIndexMarker232"/> supports the ability to add a level of indirection between the users and the <strong class="source-inline">GrantedAuthority</strong> declarations by grouping <strong class="source-inline">GrantedAuthority</strong> into logical sets <span class="No-Break">called groups.</span></p>
<p>Users are then assigned one or more groups, and their membership confers a set of <span class="No-Break">the</span><span class="No-Break"><strong class="source-inline"> Granted</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">Authority</strong></span><span class="No-Break"> declarations:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer035">
<img alt="Figure 4.1 – Group-based access control sample" height="639" src="image/B21757_04_1.jpg" width="1440"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.1 – Group-based access control sample</p>
<p>As you can see in the <a id="_idIndexMarker233"/>preceding diagram, this indirection allows the assignment of the same set of roles to multiple users, by simply assigning any new users to existing groups. This is different behavior that we’ve seen so far, where previously we assigned <strong class="source-inline">GrantedAuthority</strong> directly to <span class="No-Break">individual users.</span></p>
<p>This bundling of common sets of authorities can be helpful in the <span class="No-Break">following scenarios:</span></p>
<ul>
<li>You need to segregate users into communities, with some overlapping roles <span class="No-Break">between groups.</span></li>
<li>You want to globally change the authorization for a class of user. For example, if you have a supplier group, you might want to enable or disable their access to particular portions of <span class="No-Break">the application.</span></li>
<li>You have a large number of users, and you don’t need user-level <span class="No-Break">authority configuration.</span></li>
</ul>
<p>Unless your application has a very small user base, there is a very high likelihood that you’ll be using group-based access control. While group-based access control is slightly more complex than other strategies, the flexibility and simplicity of managing a user’s access makes this complexity worthwhile. This indirect technique of aggregating user privileges by group is commonly referred to <span class="No-Break">as GBAC.</span></p>
<p>GBAC is an approach common to almost every secured operating system or software package on the market. <strong class="bold">Microsoft Active Directory</strong> (<strong class="bold">AD</strong>) is <a id="_idIndexMarker234"/>one of the most visible implementations of large-scale GBAC, due to its design of slotting AD users into groups and assigning privileges to those groups. Management of privileges in large AD-based organizations is made exponentially simpler through the use <span class="No-Break">of</span><span class="No-Break"><a id="_idIndexMarker235"/></span><span class="No-Break"> GBAC.</span></p>
<p>Try to think of the security models of the software you use—how are the users, groups, and privileges managed? What are the pros and cons of the way the security model <span class="No-Break">is written?</span></p>
<p>Let’s add a level of abstraction to the JBCP calendar application and apply the concept<a id="_idTextAnchor124"/> of group-based authorization to <span class="No-Break">the site.</span></p>
<h2 id="_idParaDest-93"><a id="_idTextAnchor125"/>Configuring group-based access control</h2>
<p>We’ll add two <a id="_idIndexMarker236"/>groups to the application: regular users, which we’ll call <strong class="source-inline">Users</strong>, and administrative users, which we’ll call <strong class="source-inline">Administrators</strong>. Our existing accounts will be associated with the appropriate groups through an additional <span class="No-Break">SQL scr<a id="_idTextAnchor126"/>ipt.</span></p>
<h3>Configuring JdbcUserDetailsManager to use groups</h3>
<p>By default, Spring <a id="_idIndexMarker237"/>Security does not use GBAC. Therefore, we must instruct Spring Security to enable the use of groups. Modify the <strong class="source-inline">SecurityConfig.java</strong> file to use <strong class="source-inline">GROUP_AUTHORITIES_BY_USERNAME_QUERY</strong>, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.ja va
private static String CUSTOM_GROUP_AUTHORITIES_BY_USERNAME_QUERY = "select g.id, g.group_name, ga.authority " +
       "from groups g, group_members gm, " +
       "group_authorities ga where gm.username = ? " +
       "and g.id = ga.group_id and g.id = gm.group_id";
@Bean
public UserDetailsManager userDetailsService(DataSource dataSource) {
    JdbcUserDetailsManager jdbcUserDetailsManager = new JdbcUserDetailsManager(dataSource);
    jdbcUserDetailsManager.setEnableGroups(true);
    jdbcUserDetailsManager.setGroupAuthoritiesByUsernameQuery(CUSTOM_GROUP_AUTHORITIES_BY_USERNAME_QUERY);
    return jdbcUserDetailsManager;
}</pre> <h3>Utilizing GBAC JDBC scripts</h3>
<p>Next, we need to update the scripts<a id="_idIndexMarker238"/> that are being loaded at startup. We need to remove the <strong class="source-inline">security-user-authorities.sql</strong> mapping so that our users no longer obtain their authorities with direct mapping. We then need to add two additional SQL <strong class="source-inline">scripts</strong>. Update the <strong class="source-inline">DataSource</strong> bean configuration to load the SQL required for GBAC, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/DataSourceConfig. java
@Bean
public DataSource dataSource() {
    return new EmbeddedDatabaseBuilder()
          .setName("dataSource")
          .setType(EmbeddedDatabaseType.H2)
          .addScript("/database/h2/calendar-schema.sql")
          .addScript("/database/h2/calendar-data.sql")
          .addScript("/database/h2/security-schema.sql")
          .addScript("/database/h2/security-users.sql")
          .addScript("/database/h2/security-groups-schema.sql")
          .addScript("/database/h2/security-groups-mappings.sql")
          .build();
}</pre> <h3>The group-based schema</h3>
<p>It may be obvious, but the first SQL <a id="_idIndexMarker239"/>file we added contains updates to the schema to support group-based authorization. You can find the contents of the file in the following <span class="No-Break">code snippet:</span></p>
<pre class="source-code">
//src/main/resources/database/h2/security-groups-schema.sql
create table groups
(
    id         bigint generated by default as identity (start with 0) primary key,
    group_name varchar(256) not null
);
create table group_authorities
(
    group_id  bigint      not null,
    authority varchar(50) not null,
    constraint fk_group_authorities_group foreign key (group_id) references groups (id)
);
create table group_members
(
    id       bigint generated by default as identity (start with 0) primary key,
    username varchar(50) not null,
    group_id bigint      not null,
    constraint fk_group_members_group foreign key (group_id) references groups (id)
);</pre> <h3>Group authority mappings</h3>
<p>Now we need to map our existing <a id="_idIndexMarker240"/>users to groups, and the groups to authorities. This is done in the <strong class="source-inline">security-groups-mappings.sql</strong> file. Mapping based on groups can be convenient because often, organizations already have a logical group of users for various reasons. By utilizing the existing groupings of users, we can drastically simplify our configuration. This is how a layer of indirection helps us. We have included the group definitions, group to authority mappings, and a few users in the following <span class="No-Break">group mapping:</span></p>
<pre class="source-code">
//src/main/resources/database/h2/security-groups-mappings.sql
-----
-- Create the Groups
insert into groups(group_name)
values ('Users');
insert into groups(group_name)
values ('Administrators');
-----
-- Map the Groups to Roles
insert into group_authorities(group_id, authority)
select id, 'ROLE_USER'
from groups
where group_name = 'Users';
-- Administrators are both a ROLE_USER and ROLE_ADMIN
insert into group_authorities(group_id, authority)
select id, 'ROLE_USER'
from groups
where group_name = 'Administrators';
insert into group_authorities(group_id, authority)
select id, 'ROLE_ADMIN'
from groups
where group_name = 'Administrators';
-----
-- Map the users to Groups
insert into group_members(group_id, username)
select id, 'user1@example.com'
from groups
where group_name = 'Users';
insert into group_members(group_id, username)
select id, 'admin1@example.com'
from groups
where group_name = 'Administrators';
insert into group_members(group_id, username)
select id, 'user2@example.com'
from groups
where group_name = 'Users';
insert into group_members(group_id, username)
select id, 'disabled1@example.com'
from groups
where group_name = 'Users';
insert into group_members(group_id, username)
select id, 'admin'
from groups
where group_name = 'Administrators';</pre> <p>Go <a id="_idIndexMarker241"/>ahead and start the application, and it will behave just as before; however, the additional layer of abstraction between the users and roles simplifies the managing of large groups <span class="No-Break">of users.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">calendar04.02-calendar</strong></span><span class="No-Break">.</span></p>
<p>After exploring in this section how we can define GBAC, we will define in the following section a custom database queries to retrieve users <span class="No-Break">and authorities.</span></p>
<h1 id="_idParaDest-94"><a id="_idTextAnchor127"/>Support for a custom schema</h1>
<p>It’s common for new users of Spring<a id="_idIndexMarker242"/> Security to begin their experience by adapting the JDBC user, group, or role mapping to an existing schema. Even though a legacy database doesn’t conform to the expected Spring Security schema, we can still configure <strong class="source-inline">JdbcDaoImpl</strong> to map <span class="No-Break">to it.</span></p>
<p>We will now update Spring Security’s JDBC support to use our existing <strong class="source-inline">CalendarUser </strong>database along with a new <span class="No-Break"><strong class="source-inline">calendar_authorities</strong></span><span class="No-Break"> table.</span></p>
<p>We can easily change the <a id="_idIndexMarker243"/>configuration of <strong class="source-inline">JdbcUserDetailsManager</strong> to utilize this schema and override Spring Security’s expected table definitions and columns, <a id="_idTextAnchor128"/>which we’re using for the JBCP <span class="No-Break">calendar application.</span></p>
<p>In the following subsections, we will update the SQL user and authorities scripts to insert custom roles. At the end, we will configure <strong class="source-inline">JdbcUserDetailsManager</strong> to use this custom <span class="No-Break">S<a id="_idTextAnchor129"/>QL queries.</span></p>
<h2 id="_idParaDest-95"><a id="_idTextAnchor130"/>Determining the correct JDBC SQL queries</h2>
<p>The <strong class="source-inline">JdbcUserDetailsManager</strong> class has three <a id="_idIndexMarker244"/>SQL queries that have a well-defined parameter and a set of returned columns. We must determine the SQL that we’ll assign to each of these queries, based on the intended functionality. Each SQL query used by <strong class="source-inline">JdbcUserDetailsManager</strong> takes the username presented at login as its one and <span class="No-Break">only parameter:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">Namespace query </strong><span class="No-Break"><strong class="bold">attribute name</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Expected </strong><span class="No-Break"><strong class="bold">SQL columns</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">users-by-username-query</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Returns <span class="No-Break">one or</span></p>
<p><span class="No-Break">more users</span></p>
<p><span class="No-Break">matching the</span></p>
<p>username; <span class="No-Break">only the</span></p>
<p>first user <span class="No-Break">is used.</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">Username (string)</strong></span></p>
<p><span class="No-Break"><strong class="source-inline">Password (string)</strong></span></p>
<p><span class="No-Break"><strong class="source-inline">Enabled (Boolean)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">authorities-by-username-query</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Returns one or more granted authorities directly provided to the user. Typically used when GBAC <span class="No-Break">is disabled.</span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">Username (string) </strong><span class="No-Break"><strong class="source-inline">GrantedAuthority (string)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">group-authorities-by-username-query</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Returns granted</span></p>
<p><span class="No-Break">authorities and</span></p>
<p><span class="No-Break">group details</span></p>
<p>provided <span class="No-Break">to the</span></p>
<p>user <span class="No-Break">through group</span></p>
<p><span class="No-Break">membership. Used</span></p>
<p>when GBAC <span class="No-Break">is enabled.</span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">Group </strong><span class="No-Break"><strong class="source-inline">Primary Key</strong></span></p>
<p><strong class="source-inline">(</strong><span class="No-Break"><strong class="source-inline">any)</strong></span></p>
<p><strong class="source-inline">Group </strong><span class="No-Break"><strong class="source-inline">Name (any)</strong></span></p>
<p><span class="No-Break"><strong class="source-inline">GrantedAuthority (string)</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 4.2 – JDBC queries in spring-security</p>
<p>Be aware that in some cases, the <a id="_idIndexMarker245"/>return columns are not used by the default<strong class="source-inline"> JdbcUserDetailsManager</strong> implementation, but they must be <span class="No-Break">returned anyway.</span></p>
<h2 id="_idParaDest-96"><a id="_idTextAnchor131"/>Updating the SQL scripts that are loaded</h2>
<p>We need to<a id="_idIndexMarker246"/> initialize the <strong class="source-inline">DataSource</strong> with our custom schema, rather than with Spring Security’s default schema. Update the <strong class="source-inline">DataSourceConfig.java</strong> file, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/DataSourceConfig. java
@Bean
public DataSource dataSource() {
    return new EmbeddedDatabaseBuilder()
          .setName("dataSource")
          .setType(EmbeddedDatabaseType.H2)
          .addScript("/database/h2/calendar-schema.sql")
          .addScript("/database/h2/calendar-data.sql")
          .addScript("/database/h2/calendar-authorities.sql")
          .build();
}</pre> <p>Notice that we have removed all of the scripts that start with security and replaced them <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">calendar-authorities.sql</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor132"/>The CalendarUser authority SQL</h2>
<p>You can view the <strong class="source-inline">CalendarUser</strong> authority <a id="_idIndexMarker247"/>mappings in the following <span class="No-Break">code snippet:</span></p>
<pre class="source-code">
//src/main/resources/database/h2/calendar-authorities.sql
create table calendar_user_authorities
(
    id IDENTITY NOT NULL PRIMARY KEY,
    calendar_user bigint       not null,
    authority     varchar(256) not null
);
-- user1@example.com
insert into calendar_user_authorities(calendar_user, authority)
select id, 'ROLE_USER'
from calendar_users
where email = 'user1@example.com';
-- admin1@example.com
insert into calendar_user_authorities(calendar_user, authority)
select id, 'ROLE_ADMIN'
from calendar_users
where email = 'admin1@example.com';
insert into calendar_user_authorities(calendar_user, authority)
select id, 'ROLE_USER'
from calendar_users
where email = 'admin1@example.com';
-- user2@example.com
insert into calendar_user_authorities(calendar_user, authority)
select id, 'ROLE_USER'
from calendar_users
where email = 'user2@example.com';</pre> <p class="callout-heading">Important note</p>
<p class="callout">Notice that we use the id as the foreign key, which is better than utilizing the username as a foreign key (as Spring Security does). By using the id as the foreign key, we can allow users to easily change <span class="No-Break">their username.</span></p>
<h2 id="_idParaDest-98"><a id="_idTextAnchor133"/>Inserting custom authorities</h2>
<p>We need to update <strong class="source-inline">DefaultCalendarService</strong> to insert the authorities for the user using our custom <a id="_idIndexMarker248"/>schema when we add a new <strong class="source-inline">CalendarUser</strong> class. This is because while we reused the schema for the user definition, we did not define custom authorities in our existing application. Update <strong class="source-inline">DefaultCalendarService</strong>, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/DefaultCalendarService. java
@Repository
public class DefaultCalendarService implements CalendarService {
    private final EventDao eventDao;
    private final CalendarUserDao userDao;
    private final JdbcOperations jdbcOperations;
...
    public int createUser(CalendarUser user) {
        int userId = userDao.createUser(user);
        jdbcOperations.update("insert into calendar_user_authorities(calendar_user,authority) values (?,?)", userId,
              "ROLE_USER");
        return userId;
    }
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">You may have noticed the <strong class="source-inline">JdbcOperations</strong> interface that is used for inserting our user. This is a convenient template provided by Spring that helps manage boilerplate code, such as connection and transaction handling. For more details, refer to the <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional Refere<a id="_idTextAnchor134"/>nce Material</em> of this book to find the <span class="No-Break">Spring Reference.</span></p>
<h2 id="_idParaDest-99"><a id="_idTextAnchor135"/>Configuring JdbcUserDetailsManager to use custom SQL queries</h2>
<p>In order to use custom<a id="_idIndexMarker249"/> SQL queries for our non-standard schema, we’ll simply update our <strong class="source-inline">userDetailsService()</strong> method to include new queries. This is quite similar to how we enabled support for GBAC, except instead of using the default SQL, we will use our modified SQL. Notice that we remove our old <strong class="source-inline">setGroupAuthoritiesByUsernameQuery()</strong> method call, since we will not be using it in this example, in order to keep <span class="No-Break">things simple:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.ja va
private static String CUSTOM_USERS_BY_USERNAME_QUERY = "select email, password, true " +
       "from calendar_users where email = ?";
private static String CUSTOM_AUTHORITIES_BY_USERNAME_QUERY = "select cua.id, cua.authority " +
       "from calendar_users cu, calendar_user_authorities " +
       "cua where cu.email = ? " +
       "and cu.id = cua.calendar_user";
@Bean
public UserDetailsManager userDetailsService(DataSource dataSource) {
    JdbcUserDetailsManager jdbcUserDetailsManager = new JdbcUserDetailsManager(dataSource);
    jdbcUserDetailsManager.setUsersByUsernameQuery(CUSTOM_USERS_BY_USERNAME_QUERY);
    jdbcUserDetailsManager.setAuthoritiesByUsernameQuery(CUSTOM_AUTHORITIES_BY_USERNAME_QUERY);
    return jdbcUserDetailsManager;
}</pre> <p>This is the only configuration required to use Spring Security to read settings from an existing, non-default schema! Start up the application and ensure that everything is <span class="No-Break">working properly.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">calendar04.03-calendar</strong></span><span class="No-Break">.</span></p>
<p>Keep in mind that the utilization of an existing schema commonly requires an extension of <strong class="source-inline">JdbcUserDetailsManager</strong> to support the changing of passwords, the renaming of user accounts, and other <span class="No-Break">user-management functions.</span></p>
<p>If you are<a id="_idIndexMarker250"/> using <strong class="source-inline">JdbcUserDetailsManager</strong> to perform user-management tasks, then there are over 20 SQL queries utilized by the class that are accessible through the configuration. However, only the three covered are available through the namespace configuration. Please refer to the Javadoc or source code to review the defaults for the queries used <span class="No-Break">by </span><span class="No-Break"><strong class="source-inline">JdbcUserDetailsManager</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-100"><a id="_idTextAnchor136"/>Configuring secure passwords</h1>
<p>You might recall from the <a id="_idIndexMarker251"/>security audit in <a href="B21757_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, <em class="italic">Anatomy of an Unsafe Application</em>, that the security of passwords stored in cleartext was a top priority of the auditors. In fact, in any secured system, password security is a critical aspect of trust and authoritativeness of an authenticated principal. Designers of a fully secured system must ensure that passwords are stored in a way in which malicious users would have an impractically difficult time <span class="No-Break">compromising them.</span></p>
<p>The following general rules should be applied to passwords stored in <span class="No-Break">a database:</span></p>
<ul>
<li>Passwords must not be stored in <span class="No-Break">cleartext (plaintext)</span></li>
<li>Passwords supplied by the user must be compared to the recorded passwords in <span class="No-Break">the database</span></li>
<li>A user’s password should not be supplied to the user upon demand (even if the user <span class="No-Break">forgets it)</span></li>
</ul>
<p>For the purposes of most applications, the best fit for these requirements involves one-way encoding, known as the <strong class="bold">hashing</strong> of <a id="_idIndexMarker252"/>the passwords. Using a cryptographic hash provides properties such as security and uniqueness that are important to properly authenticate users, with the added bonus that once it is hashed, the password cannot be extracted from the value that <span class="No-Break">is stored.</span></p>
<p>In most secure application designs, it is neither required nor desirable to ever retrieve the user’s actual password upon request, as providing the user’s password to them without the proper additional credentials could present a major security risk. Instead, most applications provide the user the ability to reset their password, either by presenting additional credentials (such as their social security number, date of birth, tax ID, or other personal information), or through an <span class="No-Break">email-based system.</span></p>
<p class="callout-heading">Storing other types of sensitive information</p>
<p class="callout">Many of the guidelines listed that apply to passwords apply equally to other types of sensitive information, including social security numbers and credit card information (although, depending on the application, some of these may require the ability to decrypt). Storing this type of information to represent it in multiple ways, for example, a customer’s full 16-digit credit card number, would be stored in a highly encrypted form, but the last four digits might be stored in cleartext. For reference, think of any internet commerce site that displays <strong class="source-inline">XXXX XXXX XXXX 1234</strong> to help you identify your stored <span class="No-Break">credit cards.</span></p>
<p>You may already be thinking ahead and wondering, given our admittedly unrealistic approach of using SQL to populate our H2 database with users, how do we encode the passwords? H2, or most other databases for that matter, don’t offer encryption methods as built-in <span class="No-Break">database functions.</span></p>
<p>Typically, the<a id="_idIndexMarker253"/> bootstrap process (populating a system with initial users and data) is handled through a combination of SQL loads and Java code. Depending on the complexity of your application, this process can get <span class="No-Break">very complicated.</span></p>
<p>For the JBCP calendar application, we’ll retain the <strong class="source-inline">dataSource()</strong> bean declaration and <strong class="source-inline">DataSource</strong> is a name in code in the corresponding SQL, and then add some SQL t<a id="_idTextAnchor137"/>hat will modify the passwords to their <span class="No-Break">hashed values.</span></p>
<p>We have seen in this section the best practices for configuring <span class="No-Break">secure password.</span></p>
<p>In the following section, we will deep dive into the different options to configure secured passwords using the <span class="No-Break"><strong class="source-inline">PasswordEncoder</strong></span><span class="No-Break"> interface.</span></p>
<h1 id="_idParaDest-101"><a id="_idTextAnchor138"/>Exploring the PasswordEncoder interface</h1>
<p>Password hashing in <a id="_idIndexMarker254"/>Spring Security is encapsulated and defined by implementations of the <strong class="source-inline">o.s.s.authentication.encoding.PasswordEncoder</strong> interface. The simple configuration of a password encoder is possible through the <strong class="source-inline">createDelegatingPasswordEncoder()</strong> method within the <strong class="source-inline">PasswordEncoderFactories</strong> element, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@Bean
public PasswordEncoder encoder() {
    return PasswordEncoderFactories.createDelegatingPasswordEncoder();
}</pre> <p>You’ll be happy to learn that Spring Security ships with a number of implementations of<strong class="source-inline"> passwordEncoder</strong>, which are applicable for different needs and <span class="No-Break">security requirements.</span></p>
<p>The following table provides a list of the out-of-the-box implementation classes and <span class="No-Break">their benefits.</span></p>
<p>We can find the <a id="_idIndexMarker255"/>complete list of supported encoders in spring security in <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">Password</strong></span><strong class="source-inline">
EncoderFactories</strong> class. If one of these matches our requirement, we don’t need to <span class="No-Break">rewrite it.</span></p>
<p>Note that all implementations reside in the <span class="No-Break"><strong class="source-inline">o.s.s.crypto</strong></span><span class="No-Break"> package:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table003">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Encoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Algorithm</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Usage</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">Pbkdf2PasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">PBKDF2</span></p>
</td>
<td class="No-Table-Style">
<p>Provides key strengthening with configurable iteration count, suitable for <span class="No-Break">password hashing.</span></p>
<p>Suitable for <span class="No-Break">password storage.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">SCryptPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Scrypt</span></p>
</td>
<td class="No-Table-Style">
<p>Memory-hard key derivation function, making it resistant to <span class="No-Break">brute-force attacks.</span></p>
<p>Suitable for <span class="No-Break">password storage.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">StandardPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">SHA-256</span></p>
</td>
<td class="No-Table-Style">
<p>Uses a standard SHA-256 algorithm. Note that SHA-256 alone is not recommended for password hashing due to <span class="No-Break">its speed.</span></p>
<p>Suitable for legacy systems but not recommended for <span class="No-Break">new applications.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">NoOpPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No operation</span></p>
</td>
<td class="No-Table-Style">
<p>No hashing or encoding; passwords are stored as <span class="No-Break">plain text.</span></p>
<p>Not recommended for production. Useful for testing <span class="No-Break">and development.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">LdapShaPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">SHA-1</span></p>
</td>
<td class="No-Table-Style">
<p>Performs SHA-1 hashing with optional salt. Suitable for compatibility with <span class="No-Break">LDAP directories.</span></p>
<p>Suitable for integration with <span class="No-Break">LDAP-based systems.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">BCryptPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">BCrypt</span></p>
</td>
<td class="No-Table-Style">
<p>One-way hash function with adaptive hashing, suitable for <span class="No-Break">password hashing.</span></p>
<p>Recommended for <span class="No-Break">password storage.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">MessageDigest PasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Configurable</span></p>
<p>(<span class="No-Break">e.g., MD5,</span></p>
<p><span class="No-Break">SHA-256,</span></p>
<p><span class="No-Break">SHA-512)</span></p>
</td>
<td class="No-Table-Style">
<p>Uses various message digest algorithms, but the choice of algorithm is crucial <span class="No-Break">for security.</span></p>
<p>Depends on the selected algorithm. Not recommended for new applications due to weaknesses in <span class="No-Break">some algorithms.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 4.3 – Main PasswordEncoder implementation</p>
<p>As with many other areas of Spring Security, it’s also possible to reference a bean definition by implementing <strong class="source-inline">PasswordEncoder</strong> to provide more precise <span class="No-Break">configuration and</span></p>
<p>allowing <strong class="source-inline">PasswordEncoder</strong> to be wired into other beans through the dependency injection. For the<a id="_idIndexMarker256"/> JBCP calendar application, we’ll need to use this bean reference method in order to hash the passwords of the newly <span class="No-Break">created users.</span></p>
<h2 id="_idParaDest-102"><a id="_idTextAnchor139"/>The DelegatingPasswordEncoder implementation</h2>
<p>Prior to Spring Security 5.0, the<a id="_idIndexMarker257"/> default <strong class="source-inline">PasswordEncoder</strong> was <strong class="source-inline">NoOpPasswordEncoder</strong>, which required plain-text passwords. Based on the Password History section, you might expect that the default <strong class="source-inline">PasswordEncoder</strong> would now be something like <strong class="source-inline">BCryptPasswordEncoder</strong>. However, this ignores three real <span class="No-Break">world problems:</span></p>
<ul>
<li>Many applications use old password encodings that cannot <span class="No-Break">easily migrate.</span></li>
<li>The best practice for password storage will <span class="No-Break">change again.</span></li>
<li>As a framework, Spring Security cannot make breaking <span class="No-Break">changes frequently.</span></li>
</ul>
<p>Instead, Spring Security introduces <strong class="source-inline">DelegatingPasswordEncoder</strong>, which solves all of the <span class="No-Break">problems by:</span></p>
<ul>
<li>Ensuring that passwords are encoded by using the current password <span class="No-Break">storage recommendations.</span></li>
<li>Allowing for validating passwords in modern and <span class="No-Break">legacy formats.</span></li>
<li>Allowing for upgrading the encoding in <span class="No-Break">the future.</span></li>
</ul>
<p>You can easily construct an instance of <strong class="source-inline">DelegatingPasswordEncoder</strong> by <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">Password</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">EncoderFactories</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
PasswordEncoder passwordEncoder =
PasswordEncoderFactories.createDelegatingPasswordEncoder();</pre> <p>Let’s walk through the process of configuring basic password encoding for the JBC<a id="_idTextAnchor140"/>P <span class="No-Break">calendar application.</span></p>
<h2 id="_idParaDest-103"><a id="_idTextAnchor141"/>Configuring password encoding</h2>
<p>Configuring basic password <a id="_idIndexMarker258"/>encoding involves two steps: hashing the passwords we load into the database after the SQL script executes and ensuring that Spring Security is configured to work <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">PasswordEncoder</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-104"><a id="_idTextAnchor142"/>Configuring the PasswordEncoder method</h2>
<p>First, we’ll declare an<a id="_idIndexMarker259"/> instance of <strong class="source-inline">PasswordEncoder</strong> as a normal Spring bean, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.ja va
@Bean
public PasswordEncoder passwordEncoder() {
    String idForEncode = "SHA-256";
    Map&lt;String, PasswordEncoder&gt; encoders = new HashMap&lt;&gt;();
    encoders.put("SHA-256", new org.springframework.security.crypto.password.MessageDigestPasswordEncoder("SHA-256"));
    return new DelegatingPasswordEncoder(idForEncode, encoders);
}</pre> <h2 id="_idParaDest-105"><a id="_idTextAnchor143"/>Making Spring Security aware of the PasswordEncoder method</h2>
<p>We’ll need to configure Spring Security to have a reference to a Bean of type <strong class="source-inline">PasswordEncoder</strong>, so that<a id="_idIndexMarker260"/> it can encode and compare the presented password during <span class="No-Break">user login.</span></p>
<p>If you were to try the application at this point, you’d notice that what were previously valid login credentials would now be rejected. This is because the passwords stored in the database (loaded with the <strong class="source-inline">calendar-users.sql</strong> script) are not stored as a <strong class="source-inline">hash</strong> that matches the password encoder. We’ll need to update the stored passwords to be <span class="No-Break">hashed values.</span></p>
<h3>Hashing the stored passwords</h3>
<p>As illustrated in the following<a id="_idIndexMarker261"/> diagram, when a user submits a password, Spring Security hashes the submitted password and then compares that against the unhashed password in <span class="No-Break">the database:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer036">
<img alt="Figure 4.2 – Hashing the stored passwords workflow" height="689" src="image/B21757_04_2.jpg" width="1159"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.2 – Hashing the stored passwords workflow</p>
<p>This means that users cannot log in to our application. To fix this, we will update the SQL that is loaded at startup time to update the passwords to be the hashed values. Update the <strong class="source-inline">DataSourceConfig.java</strong> file, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/DataSourceConfig. java
@Bean
public DataSource dataSource() {
    return new EmbeddedDatabaseBuilder()
          .setName("dataSource")
          .setType(EmbeddedDatabaseType.H2)
          .addScript("/database/h2/calendar-schema.sql")
          .addScript("/database/h2/calendar-data.sql")
          .addScript("/database/h2/calendar-authorities.sql")
          <strong class="bold">.addScript("/database/h2/calendar-sha256.sql")</strong>
          .build();
}</pre> <p>The <strong class="source-inline">calendar-sha256.sql</strong> file simply updates the existing passwords to their expected hashed values, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
-- original password was: user1
update calendar_users
set password = '{SHA-256}0a041b9462caa4a31bac3567e0b6e6fd9100787db2ab433d96f6d178cabfce90'
where email = 'user1@example.com';</pre> <p>How did we know what value to update the password to? We have provided <strong class="source-inline">o.s.s.authentication.encoding.Sha256PasswordEncoderMain</strong> to demonstrate how to use <a id="_idIndexMarker262"/>the configured <strong class="source-inline">PasswordEncoder</strong> interface to hash the existing passwords. The relevant code is <span class="No-Break">as follows:</span></p>
<pre class="source-code">
ShaPasswordEncoder encoder = new ShaPasswordEncoder(256);
String encodedPassword = encoder.encodePassword(password, null);</pre> <h3>Hashing the passwords of new users</h3>
<p>If we tried<a id="_idIndexMarker263"/> running the application and creating a new user, we would not be able to log in. This is because the newly-created user’s password would not be hashed. We need to update <strong class="source-inline">DefaultCalendarService</strong> to hash the password. Make the following updates to ensure that the newly-created users passwords <span class="No-Break">are hashed:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/DefaultCalendarService. java
public class DefaultCalendarService implements CalendarService {
    private final EventDao eventDao;
    private final CalendarUserDao userDao;
    private final JdbcOperations jdbcOperations;
    private final PasswordEncoder passwordEncoder;
...
    public int createUser(CalendarUser user) {
       String encodedPassword = passwordEncoder.encode(user.getPassword());
       user.setPassword(encodedPassword);
       int userId = userDao.createUser(user);
       jdbcOperations.update("insert into calendar_user_authorities(calendar_user,authority) values (?,?)", userId,
             "ROLE_USER");
       return userId;
    }
}</pre> <h3>Not quite secure</h3>
<p>Go ahead and start the application. Try creating a new user with <strong class="source-inline">user1</strong> as the password. Log out of the application, then use the instructions on the <strong class="bold">Welcome</strong> page to open the <strong class="bold">H2 console</strong> and view all of the users passwords. Did you notice that the hashed values for the newly created user and <strong class="source-inline">user1@example.com</strong> are the same value? The fact that we have now figured out another user’s password is a little disturbing. We will solve this with a technique <a id="_idIndexMarker264"/>known <span class="No-Break">as </span><span class="No-Break"><strong class="bold">salting</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">calendar04.04-calendar</strong></span><span class="No-Break">.</span></p>
<p>Would you like some salt with that password? If the security auditor were to examine the encoded passwords in the database, he’d find something that would still make him concerned about the website’s security. Let’s examine the following stored username and password values for a few of <span class="No-Break">our users:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table004">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Username</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Plaintext password</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Hashed password</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">admin1@example.com</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">admin1</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">{</strong><span class="No-Break"><strong class="source-inline">SHA-256}25f43b1486ad95a1 398e3eeb3d83bc4010015fcc9</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">bedb35b432e00298d5021f7</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">user1@example.com</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">user1</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">{</strong><span class="No-Break"><strong class="source-inline">SHA-256}0a041b9462caa4a3 1bac3567e0b6e6fd9100787db</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">2ab433d96f6d178cabfce90</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 4.4 – Hashed users passwords</p>
<p>This looks very secure—the encrypted passwords obviously bear no resemblance to the original passwords. What could the auditor be concerned about? What if we add a new user who happens to have the same password as our <span class="No-Break"><strong class="source-inline">user1@example.com</strong></span><span class="No-Break"> user?</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table005">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Username</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Plaintext </strong><span class="No-Break"><strong class="bold">password</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Hashed password</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">hacker@example.com</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">user1</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline">{</strong><span class="No-Break"><strong class="source-inline">SHA-256}0a041b9462caa4 a31bac3567e0b6e6fd91007</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">87db2ab433d96f6d178cabfce90</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 4.5 – Hacked hashed user password</p>
<p>Now, note that the encrypted password of the <strong class="source-inline">hacker@example.com</strong> user is exactly the same as the real user! Thus, a hacker who had somehow gained the ability to read the encrypted passwords in the database could compare their known password’s encrypted representation with the unknown one for the user account, and see they are the same! If the hacker had access to an automated tool to perform this analysis, they could likely compromise the user’s account within a matter <span class="No-Break">of hours.</span></p>
<p>While it is difficult to guess a single password, hackers can calculate all the hashes ahead of time and store a mapping of the hash to the original password. Then, figuring out the original password is a matter of looking up the password by its hashed value in constant time. This is a hacking technique known <a id="_idIndexMarker265"/>as <span class="No-Break"><strong class="bold">rainbow tables</strong></span><span class="No-Break">.</span></p>
<p>One common and effective method of adding another layer of security to encrypted passwords is to incorporate a <strong class="bold">salt</strong>. A salt<a id="_idIndexMarker266"/> is a second plaintext component, which is concatenated with the plaintext password prior to performing the hash, in order to ensure that two factors must be used to generate (and thus compare) the hashed password values. Properly selected salts can guarantee that no two passwords will ever have the same hashed value, thus preventing the scenario that concerned our auditor, and avoiding many common types of brute force password <span class="No-Break">cracking techniques.</span></p>
<p>Best practice salts generally fall into one of the following <span class="No-Break">three categories:</span></p>
<ul>
<li>They are algorithmically generated from some pieces of data associated with the user, for example, the timestamp that the <span class="No-Break">user created</span></li>
<li>They are randomly generated and stored in <span class="No-Break">some form</span></li>
<li>They are plaintext or two-way encrypted along with the user’s <span class="No-Break">password record</span></li>
</ul>
<p>Remember that because<a id="_idIndexMarker267"/> the <strong class="bold">salt</strong> is added to the plaintext password, it can’t be one-way encrypted—the application needs to be able to look up or derive the appropriate <strong class="source-inline">salt</strong> value for a given user’s record in order to calculate the <strong class="source-inline">hash</strong> of the password, and to compare it with the stored <strong class="source-inline">hash</strong> of the user when <span class="No-Break">performing authentication.</span></p>
<h1 id="_idParaDest-106"><a id="_idTextAnchor144"/>Using salt in Spring Security</h1>
<p><strong class="bold">Spring Security</strong> provides a <a id="_idIndexMarker268"/>cryptography module that are included in the <strong class="source-inline">spring-security-core</strong> module and are available separately in <strong class="source-inline">spring-security-crypto</strong>. The <strong class="bold">crypto</strong> module<a id="_idIndexMarker269"/> contains its own <strong class="source-inline">o.s.s.crypto.password.PasswordEncoder</strong> interface. In fact, using this interface is the preferred method for encoding passwords, because it will salt passwords using a random <strong class="source-inline">salt</strong>. At the time of this writing, there are the following three implementations <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">o.s.s.crypto.password.PasswordEncoder</strong></span><span class="No-Break">:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table006">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Class</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">o.s.s.crypto.bcrypt.BCryptPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p>This class uses the <strong class="source-inline">bcrypt</strong> hashing function. It supports <strong class="source-inline">salt</strong> and the ability to slow down to perform over time as technology improves. This helps protect against brute- force <span class="No-Break">search attacks.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">o.s.s.crypto.password.NoOpPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p>This class does no encoding (it returns the password in its plaintext form). Provided for legacy and testing purposes only and is not <span class="No-Break">considered secure.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">o.s.s.crypto.password.StandardPasswordEncoder</strong></span></p>
</td>
<td class="No-Table-Style">
<p>This class uses <strong class="source-inline">SHA-256</strong> with multiple iterations and a random <strong class="source-inline">salt</strong> value. Provided for legacy and testing purposes only and is not <span class="No-Break">considered secure.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 4.6 – Common PasswordEncoder implementations</p>
<p class="callout-heading">Important note</p>
<p class="callout">For those who are familiar with <strong class="source-inline">Spring Security</strong>, The Spring Security Crypto module provides support for symmetric encryption, key generation, and password encoding. The classes above are part of the core module and has no dependencies on any other Spring Security (or <span class="No-Break">Spring) code.</span></p>
<h2 id="_idParaDest-107"><a id="_idTextAnchor145"/>Updating the Spring Security configuration</h2>
<p>This can be done by updating the <a id="_idIndexMarker270"/>Spring Security configuration. Remove the old <strong class="source-inline">ShaPasswordEncoder</strong> encoder and add the new <strong class="source-inline">StandardPasswordEncoder</strong> encoder, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.ja va
@Bean
public PasswordEncoder passwordEncoder() {
    return new StandardPasswordEncoder();
}</pre> <h2 id="_idParaDest-108"><a id="_idTextAnchor146"/>Migrating existing passwords</h2>
<p>Let’s take a look at the <a id="_idIndexMarker271"/>following steps and learn about migrating <span class="No-Break">existing passwords:</span></p>
<ol>
<li>We need to update our<a id="_idIndexMarker272"/> existing passwords to use the values produced by the new <strong class="source-inline">PasswordEncoder</strong> class. If you would like to generate your own passwords, you can use the following <span class="No-Break">code snippet:</span></li>
</ol>
<pre class="source-code">
StandardPasswordEncoder encoder = new StandardPasswordEncoder();
String encodedPassword = encoder.encode("password");</pre> <ol>
<li value="2">Remove the previously used <strong class="source-inline">calendar-sha256.sql</strong> file, and add the provided <strong class="source-inline">saltedsha256.sql</strong> file <span class="No-Break">as follows:</span></li>
</ol>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ DataSourceConfig.java
@Bean
public DataSource dataSource() {
    return new EmbeddedDatabaseBuilder()
          .setName("dataSource")
          .setType(EmbeddedDatabaseType.H2)
          .addScript("/database/h2/calendar-schema.sql")
          .addScript("/database/h2/calendar-data.sql")
          .addScript("/database/h2/calendar-authorities.sql")
          <strong class="bold">.addScript("/database/h2/calendar-saltedsha256.sql")</strong>
          .build();
}</pre> <h2 id="_idParaDest-109"><a id="_idTextAnchor147"/>Updating DefaultCalendarUserService</h2>
<p>The <strong class="source-inline">passwordEncoder()</strong> method we<a id="_idIndexMarker273"/> defined previously is smart enough to handle the new password encoder interface. However, <strong class="source-inline">DefaultCalendarUserService</strong> needs to update to the new interface. Make the following <a id="_idIndexMarker274"/>updates to the <span class="No-Break"><strong class="source-inline">DefaultCalendarUserService</strong></span><span class="No-Break"> class:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/service/DefaultCalendarService. java
@Repository
public class DefaultCalendarService implements CalendarService {
    private final EventDao eventDao;
    private final CalendarUserDao userDao;
    private final JdbcOperations jdbcOperations;
    private final PasswordEncoder passwordEncoder;
    public int createUser(CalendarUser user) {
        String encodedPassword = passwordEncoder.encode(user.getPassword());
        user.setPassword(encodedPassword);
        int userId = userDao.createUser(user);
        jdbcOperations.update("insert into calendar_user_authorities(calendar_user,authority) values (?,?)", userId,
              "ROLE_USER");
        return userId;
    }
}</pre> <p>With the<a id="_idIndexMarker275"/> preceding code implementation, we have been able to configure Salt SHA256 in Spring Security. The <strong class="source-inline">DefaultCalendarService</strong> uses this Salt <strong class="source-inline">PasswordEncoder</strong> to insert <span class="No-Break">user’s password.</span></p>
<p>In the next section, we will explore another option to use <strong class="source-inline">Salt</strong> with <span class="No-Break"><strong class="source-inline">Bcrypt</strong></span><span class="No-Break"> algorithm.</span></p>
<h1 id="_idParaDest-110"><a id="_idTextAnchor148"/>Trying out salted passwords</h1>
<p>Start up the application and <a id="_idIndexMarker276"/>try creating another user with the password <strong class="source-inline">user1</strong>. Use the H2 console to compare the new user’s password and observe that they <span class="No-Break">are different.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">calendar04.05-calendar</strong></span><span class="No-Break">.</span></p>
<p>Spring Security now generates a random <strong class="source-inline">salt</strong> and combines this with the password before hashing our password. It then adds the random <strong class="source-inline">salt</strong> to the beginning of the password in plaintext, so that passwords can be checked. The stored password can be summarized <span class="No-Break">as follows:</span></p>
<pre class="source-code">
salt = randomsalt()
hash = hash(salt+originalPassword)
storedPassword = salt + hash</pre> <p>This is the pseudocode for hashing a newly <span class="No-Break">created password.</span></p>
<p>To authenticate a user, <strong class="source-inline">salt</strong> and <strong class="source-inline">hash</strong> can be extracted from the stored password, since both <strong class="source-inline">salt</strong> and <strong class="source-inline">hash</strong> are fixed lengths. Then, the extracted <strong class="source-inline">hash</strong> can be compared against a new <strong class="source-inline">hash</strong>, computed with extracted <strong class="source-inline">salt</strong> and the <span class="No-Break">inputted password:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer037">
<img alt="Figure 4.3 – Salting the stored passwords workflow" height="942" src="image/B21757_04_3.jpg" width="1571"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.3 – Salting the stored passwords workflow</p>
<p>The<a id="_idIndexMarker277"/> following is the pseudocode for validating a <span class="No-Break">salted password:</span></p>
<pre class="source-code">
storedPassword = datasource.lookupPassword(username) salt, expectedHash = extractSaltAndHash(storedPassword) actualHash = hash(salt+inputedPassword)
authenticated = (expectedHash == actualHash)Trying out salted passwords with StandardPasswordEncoder</pre> <p><strong class="source-inline">BCryptPasswordEncoder</strong> is another salt implementation uses the widely supported <strong class="source-inline">bcrypt</strong> algorithm to hash the passwords. <strong class="source-inline">Bcrypt</strong> uses a random <strong class="source-inline">16-byte salt</strong> value and is a deliberately slow algorithm, to hinder password crackers. You can tune the amount of work it does by using the strength parameter, which takes a value from <em class="italic">4</em> to <em class="italic">31</em>. The higher the value, the more work has to be done to calculate the hash. The default value is <strong class="source-inline">10</strong>. You can change this value in your deployed system without affecting existing passwords, as the value is also stored in the encoded hash. The following example uses the <strong class="source-inline">BCryptPasswordEncoder</strong> with strength parameter value equal <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">4</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder(4);
}</pre> <p>In addition, we had to use add the provided <strong class="source-inline">calendar-bcrypt.sql</strong> file <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ DataSourceConfig.java
@Bean
public DataSource dataSource() {
    return new EmbeddedDatabaseBuilder()
          .setName("dataSource")
          .setType(EmbeddedDatabaseType.H2)
          .addScript("/database/h2/calendar-schema.sql")
          .addScript("/database/h2/calendar-data.sql")
          .addScript("/database/h2/calendar-authorities.sql")
          <strong class="bold">.addScript("/database/h2/calendar-bcrypt.sql")</strong>
          .build();
}</pre> <p>Start up<a id="_idIndexMarker278"/> the application and try logging to the application with username <strong class="source-inline">user1@example.com</strong> and <span class="No-Break">password </span><span class="No-Break"><strong class="source-inline">user1</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">calendar04.06-calendar</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-111"><a id="_idTextAnchor149"/>Summary</h1>
<p>In this chapter, we learned how to use Spring Security’s built-in <em class="italic">JDBC support</em>. Specifically, we have learned that Spring Security provides a default schema for new applications. We also explored how to implement <em class="italic">GBAC</em> and how it can make managing <span class="No-Break">users easier.</span></p>
<p>We also learned how to integrate Spring Security’s JDBC support with an existing database and also how to secure our passwords by hashing them and using a randomly <span class="No-Break">generated </span><span class="No-Break"><em class="italic">salt</em></span><span class="No-Break">.</span></p>
<p>In the next chapter, we will explore the <em class="italic">Spring Data</em> project and how to configure Spring Security to use <strong class="bold">object-relational mapping</strong> (<strong class="bold">ORM</strong>) to connect to an RDBMS, as well as a <span class="No-Break">document database.</span></p>
</div>
</div></body></html>