<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Connecting to Facebook and Twitter"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Connecting to Facebook and Twitter</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a Facebook app</li><li class="listitem" style="list-style-type: disc">Creating a test Facebook app and test users</li><li class="listitem" style="list-style-type: disc">Connecting to Facebook</li><li class="listitem" style="list-style-type: disc">Retrieving a Facebook user's profile</li><li class="listitem" style="list-style-type: disc">Retrieving the list of friends of a Facebook user</li><li class="listitem" style="list-style-type: disc">Posting a Facebook status update</li><li class="listitem" style="list-style-type: disc">Posting a link to Facebook</li><li class="listitem" style="list-style-type: disc">Posting a custom object to Facebook</li><li class="listitem" style="list-style-type: disc">Creating a Twitter application</li><li class="listitem" style="list-style-type: disc">Connecting to Twitter</li><li class="listitem" style="list-style-type: disc">Retrieving a user's Twitter profile</li><li class="listitem" style="list-style-type: disc">Retrieving the tweets of a Twitter user</li><li class="listitem" style="list-style-type: disc">Posting a tweet to Twitter</li><li class="listitem" style="list-style-type: disc">Sending a private message to another Twitter user</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec98"/>Introduction</h1></div></div></div><p>In this chapter, we will make a Spring web application access Facebook and Twitter accounts in order to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Retrieve user data, such as name, e-mail, tweets, posts, and so on</li><li class="listitem" style="list-style-type: disc">Create user data, such as a tweet, Facebook post, and so on</li></ul></div><p>For that, we will use Spring Social, which simplifies interacting with social networks from a Spring web application; it helps with the OAuth workflows and executes the proper REST requests behind the scenes for us.</p></div></div>
<div class="section" title="Creating a Facebook app"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec99"/>Creating a Facebook app</h1></div></div></div><p>A web application can access a Facebook account only through a Facebook app. In this recipe, we <a id="id444" class="indexterm"/>will open a Facebook developer account and create a Facebook app. We will obtain an <span class="strong"><strong>App ID</strong></span> and <span class="strong"><strong>App secret</strong></span>, which are the two strings that <a id="id445" class="indexterm"/>our <a id="id446" class="indexterm"/>web application will use to connect to Facebook in the following recipes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec231"/>Getting ready</h2></div></div></div><p>Log in to your Facebook account.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec232"/>How to do it…</h2></div></div></div><p>Here are the steps to open a <a id="id447" class="indexterm"/>Facebook developer account and create a Facebook app:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="https://developers.facebook.com/">https://developers.facebook.com/</a>.</li><li class="listitem">In the top navigation, in <span class="strong"><strong>My Apps</strong></span>, select <span class="strong"><strong>Register as a Developer</strong></span>.</li><li class="listitem">Once you're registered, in the top menu, under <span class="strong"><strong>Apps</strong></span>, select <span class="strong"><strong>Add a New App</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Website</strong></span>.<div class="mediaobject"><img src="graphics/5807OS_10_01.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on <span class="strong"><strong>Skip and Create App ID</strong></span> in the top-right corner of the window:<div class="mediaobject"><img src="graphics/5807OS_10_02.jpg" alt="How to do it…"/></div></li><li class="listitem">Fill in the <a id="id448" class="indexterm"/>form and click on <span class="strong"><strong>Create App ID</strong></span>.</li><li class="listitem">Find the <span class="strong"><strong>App ID</strong></span> and <span class="strong"><strong>App Secret</strong></span> displayed on the app page.<div class="mediaobject"><img src="graphics/5807OS_10_03.jpg" alt="How to do it…"/></div></li></ol></div></div></div>
<div class="section" title="Creating a test Facebook app and test users"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec100"/>Creating a test Facebook app and test users</h1></div></div></div><p>To work with<a id="id449" class="indexterm"/> actual Facebook users, a Facebook app needs to go through<a id="id450" class="indexterm"/> an approval process; you have to submit some screenshots, a logo, description, and privacy policy. To just test your web application, skip the approval process by using a <span class="strong"><strong>Test App</strong></span> with <span class="strong"><strong>Test Users</strong></span>. Facebook provides a convenient interface to create them.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec233"/>Getting ready</h2></div></div></div><p>You need an existing Facebook app. Refer to the previous <span class="emphasis"><em>Creating a Facebook app</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec234"/>How to do it…</h2></div></div></div><p>Here are the <a id="id451" class="indexterm"/>steps to create a test app and test users:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="https://developers.facebook.com/apps">https://developers.facebook.com/apps</a>.</li><li class="listitem">Select <a id="id452" class="indexterm"/>your <a id="id453" class="indexterm"/>existing app.</li><li class="listitem">In the left side of the navigation menu, select <span class="strong"><strong>Test Apps</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Create a Test App</strong></span> green button.</li><li class="listitem">Enter a name for your test app and create the app.</li><li class="listitem">The test app's <span class="strong"><strong>App ID</strong></span> and <span class="strong"><strong>App Secret</strong></span> are displayed. They are different from the original app. Use them in your Spring web application to use the test app.</li><li class="listitem">In the left side of the navigation menu, select <span class="strong"><strong>Roles</strong></span>. Choose the <span class="strong"><strong>Test Users</strong></span> tab and click on the <span class="strong"><strong>Add</strong></span> button.</li><li class="listitem">Select <span class="strong"><strong>4 users</strong></span>. Leave the other options to their default value and click on <span class="strong"><strong>Create Test Users</strong></span>.</li><li class="listitem">Choose one of the created users, click on the <span class="strong"><strong>Edit</strong></span> button, and choose <span class="strong"><strong>Change the name or password for this user</strong></span>.</li><li class="listitem">Choose a password for the user and click on <span class="strong"><strong>Save</strong></span>.</li><li class="listitem">Click again on the <span class="strong"><strong>Edit</strong></span> button of the same test user and select <span class="strong"><strong>Manage this test user's friends</strong></span>.</li><li class="listitem">Type the names of a few other test users and click on <span class="strong"><strong>Save</strong></span>.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec235"/>How it works…</h2></div></div></div><p>We defined a password for one user, so we'll be able to log in as this user and authorize our web application in the following recipes.</p><p>We also added friends to that user, so we'll be able to test the <span class="emphasis"><em>Retrieving the list of friends of a Facebook user</em></span> recipe.</p></div></div>
<div class="section" title="Connecting to Facebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec101"/>Connecting to Facebook</h1></div></div></div><p>Facebook allows access to a user account through<a id="id454" class="indexterm"/> an <span class="strong"><strong>OAuth workflow</strong></span>; from <a id="id455" class="indexterm"/>our web application, the user is redirected to a Facebook page to authorize our Facebook app to access his/her account. The user is then redirected back to our web application. In this recipe, we'll implement this OAuth workflow.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec236"/>Getting ready</h2></div></div></div><p>You need an <a id="id456" class="indexterm"/>existing Facebook app. Refer to the <span class="emphasis"><em>Creating a Facebook app </em></span>and <span class="emphasis"><em>Creating a test Facebook app and test users</em></span> recipes.</p><p>We will use a JSP so make sure that the Maven dependency for JSTL is declared in your <code class="literal">pom.xml</code> file and the corresponding <code class="literal">ViewResolver</code> bean is declared in your Spring configuration class. For more details, refer to the <span class="emphasis"><em>Using a JSP view</em></span> recipe in the <a class="link" href="ch03.html" title="Chapter 3. Using Controllers and Views">Chapter 3</a>, <span class="emphasis"><em>Using Controllers and Views</em></span>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec237"/>How to do it…</h2></div></div></div><p>Here are the steps to implement the Facebook OAuth workflow:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependencies for Spring Social and Spring Social Facebook in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="strong"><strong>spring-social-core</strong></span>&lt;/artifactId&gt;
    &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="strong"><strong>spring-social-web</strong></span>&lt;/artifactId&gt;
    &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
    &lt;artifactId&gt;<span class="strong"><strong>spring-social-config</strong></span>&lt;/artifactId&gt;
    &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
  &lt;artifactId&gt;<span class="strong"><strong>spring-social-facebook</strong></span>&lt;/artifactId&gt;
  &lt;version&gt;1.1.1.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
  &lt;artifactId&gt;<span class="strong"><strong>spring-social-facebook-web</strong></span>&lt;/artifactId&gt;
  &lt;version&gt;1.1.1.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">Create a controller class:<div class="informalexample"><pre class="programlisting">@Controller
public class FacebookController {
...</pre></div></li><li class="listitem">Create a<a id="id457" class="indexterm"/> Facebook login method containing the <span class="strong"><strong>App ID</strong></span> and <span class="strong"><strong>App Secret</strong></span>, which will redirect the user to a Facebook authorization page:<div class="informalexample"><pre class="programlisting">@RequestMapping("/fb/login")
public void login(HttpServletResponse response) throws IOException {
  FacebookConnectionFactory connectionFactory = new FacebookConnectionFactory("<span class="strong"><strong>759801647423672</strong></span>", "<span class="strong"><strong>1b13515e931b0e2b4b9c620f72761e62</strong></span>");

  OAuth2Parameters params = new OAuth2Parameters();
  params.setRedirectUri ("http://localhost:8080/spring_webapp/fb/callback");
  params.setScope("public_profile");

  OAuth2Operations oauthOperations = connectionFactory.getOAuthOperations();
  String authorizeUrl = oauthOperations.buildAuthorizeUrl(params);
  
  response.<span class="strong"><strong>sendRedirect</strong></span>(authorizeUrl);
}</pre></div></li><li class="listitem">Create the <code class="literal">callback</code> method for the callback URL, where the user will be redirected after logging in to Facebook. Using the authorization code parameter received from Facebook, get an access token and save it in the session:<div class="informalexample"><pre class="programlisting">@RequestMapping("/fb/callback")
public String callback(@RequestParam("code") String authorizationCode, HttpServletRequest request) {
  FacebookConnectionFactory connectionFactory = new FacebookConnectionFactory("759801647423672", "1b13515e931b0e2b4b9c620f72761e62");
  
  OAuth2Operations oauthOperations = connectionFactory.getOAuthOperations();
  AccessGrant accessGrant = oauthOperations.exchangeForAccess(authorizationCode, "http://localhost:8080/spring_webapp/fb/callback", null);

  String token = accessGrant.getAccessToken();
  request.getSession().setAttribute("facebookToken", token);
  
  return "redirect:/fb";
}</pre></div></li><li class="listitem">Create a <a id="id458" class="indexterm"/>method to display a JSP if the connection to Facebook using the access token in the session is successful. Otherwise, it will redirect the user to the login URL:<div class="informalexample"><pre class="programlisting">@RequestMapping("/fb")
public String fb(HttpServletRequest request) {
  String accessToken = (String) request.getSession().getAttribute("facebookToken");
  
  Facebook facebook = new FacebookTemplate(accessToken);          
  if(facebook.isAuthorized()) {
    return "fb";
  }
  else {
    return "redirect:/fb/login";      
  }  
}</pre></div></li><li class="listitem">Create a JSP for the previous method:<div class="informalexample"><pre class="programlisting">&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt; 
&lt;%@ page isELIgnored="false" %&gt;

&lt;html&gt;
&lt;body&gt;
    &lt;p&gt;Connected to Facebook&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">To test whether it's working, log out of your Facebook account and go to <code class="literal">/fb</code>. You will be redirected to Facebook. Log in, authorize the app, and you will be redirected back to the web application. Remember to use the login credentials of a test user if you are using a test app. </li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec238"/>How it works…</h2></div></div></div><p>The <code class="literal">login()</code> method builds a Facebook authorization URL with the <span class="strong"><strong>App ID</strong></span> (<code class="literal">https://www.facebook.com/login.php?api_key=759801647423672&amp;redirect_uri=...</code>) and redirects the user to it.</p><p>Once the user<a id="id459" class="indexterm"/> has authorized the app, he/she is redirected back to our web application to a callback URL, <code class="literal">/fb/callback</code>, which we provided in the <code class="literal">login()</code> method:</p><div class="informalexample"><pre class="programlisting">params.setRedirectUri ("http://localhost:8080/spring_webapp/fb/callback");</pre></div><p>The callback URL contains a <code class="literal">code</code> parameter provided by Facebook.</p><p>In the <code class="literal">callback()</code> method, we will use that authorization code to get an OAuth access token that we will store in the session. This is part of the standard OAuth workflow; the access token is not provided directly in the callback URL, so it's never shown to the user. On our server, the <span class="strong"><strong>App Secret</strong></span> (also never shown to the user) is required to obtain the token from the authorization code.</p><p>We then redirect the user to <code class="literal">/fb</code>. In the <code class="literal">fb()</code> method, we retrieve the token from the session and use it to connect to the Facebook user's account.</p></div></div>
<div class="section" title="Retrieving a Facebook user's profile"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec102"/>Retrieving a Facebook user's profile</h1></div></div></div><p>In this<a id="id460" class="indexterm"/> recipe, you'll learn how to retrieve a Facebook user's profile data, which automatically becomes available to the app once the user has authorized it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec239"/>Getting ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Facebook</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec240"/>How to do it…</h2></div></div></div><p>Here are the steps to retrieve the profile of a Facebook user:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">FacebookController</code> class, add a Model argument to the <code class="literal">fb()</code> method:<div class="informalexample"><pre class="programlisting">@RequestMapping("/fb")
public String fb(HttpServletRequest request, Model model) {
...</pre></div></li><li class="listitem">In the <code class="literal">if(facebook.isAuthorized())</code> block, use the Facebook object to retrieve the user's profile:<div class="informalexample"><pre class="programlisting">FacebookProfile profile = facebook.userOperations().getUserProfile(); </pre></div></li><li class="listitem">Pass the user profile to the JSP view:<div class="informalexample"><pre class="programlisting">model.addAttribute("profile", profile); </pre></div></li><li class="listitem">In the JSP, display data from the user's profile:<div class="informalexample"><pre class="programlisting">id: ${profile.id}&lt;br /&gt;
username: ${profile.username}&lt;br /&gt;
name: ${profile.name}&lt;br /&gt;
gender: ${profile.gender}&lt;br /&gt;
email: ${profile.email}&lt;br /&gt;
birthday: ${profile.birthday}&lt;br /&gt;
hometown: ${profile.hometown}&lt;br /&gt;</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec241"/>How it works…</h2></div></div></div><p>Behind the <a id="id461" class="indexterm"/>scenes, Spring Social sends a REST HTTP request to <a class="ulink" href="http://www.facebook.com">www.facebook.com</a> and builds a <code class="literal">FacebookProfile</code> object from the response.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec242"/>There's more…</h2></div></div></div><p>For the full list of available fields, look directly in the <code class="literal">FacebookProfile</code> class.</p><p>Some fields of the user profile require additional permissions to be accessible: for example, the e-mail, which requires the <code class="literal">email</code> permission. Refer to the next recipe where we will extend the scope parameter of the authorization request. The full list of the available <a id="id462" class="indexterm"/>permissions can be found at <a class="ulink" href="https://developers.facebook.com/docs/facebook-login/permissions/v2.2">https://developers.facebook.com/docs/facebook-login/permissions/v2.2</a>.</p></div></div>
<div class="section" title="Retrieving the list of friends of a Facebook user"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec103"/>Retrieving the list of friends of a Facebook user</h1></div></div></div><p>In this <a id="id463" class="indexterm"/>recipe, you'll learn how to retrieve the friends list of a Facebook user from a Spring web application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec243"/>Getting ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Facebook</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec244"/>How to do it…</h2></div></div></div><p>Here are the steps to retrieve the list of friends of a Facebook user:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">FacebookController</code> class, in the <code class="literal">login()</code> method, add <code class="literal">user_friends</code> to the <code class="literal">scope</code> parameter:<div class="informalexample"><pre class="programlisting">  params.setScope("public_profile, user_friends");</pre></div></li><li class="listitem">Add a <code class="literal">Model</code> argument to the <code class="literal">fb()</code> method:<div class="informalexample"><pre class="programlisting">@RequestMapping("/fb")
public String fb(HttpServletRequest request, Model model) {
...</pre></div></li><li class="listitem">In the <code class="literal">if(facebook.isAuthorized())</code> block, use the Facebook object to get the <a id="id464" class="indexterm"/>list of friends:<div class="informalexample"><pre class="programlisting">List&lt;Reference&gt; friendList = facebook.friendOperations().getFriends();</pre></div></li><li class="listitem">Retrieve the profile of each friend:<div class="informalexample"><pre class="programlisting">List&lt;FacebookProfile&gt; friendProfileList = new LinkedList&lt;FacebookProfile&gt;();
for (Reference friend : friendList) {
  FacebookProfile friendProfile = facebook.userOperations().getUserProfile(friend.getId());  
  friendProfileList.add(friendProfile);
}</pre></div></li><li class="listitem">Pass the list of profiles to the JSP view:<div class="informalexample"><pre class="programlisting">model.addAttribute("friendProfileList", friendProfileList); </pre></div></li><li class="listitem">In the JSP, display the profiles of the friends:<div class="informalexample"><pre class="programlisting">&lt;c:forEach items="${friendProfileList}" var="profile"&gt;
  &lt;h2&gt;${profile.name}&lt;/h2&gt;
  &lt;p&gt;
    id: ${profile.id}&lt;br /&gt;
    name: ${profile.name}&lt;br /&gt;
    gender: ${profile.gender}&lt;br /&gt;
  &lt;/p&gt;
&lt;/c:forEach&gt;</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec245"/>How it works…</h2></div></div></div><p>We retrieved the user's friends using <code class="literal">getFriends()</code>. This gave us only their names, so we used <code class="literal">getUserProfile()</code> to fetch their public profile.</p><p>We added <code class="literal">user_friends</code> to the <code class="literal">scope</code> parameter, but the user can choose to prevent our Facebook app from <a id="id465" class="indexterm"/>accessing his/her friends list. For more information about permissions, go to <a class="ulink" href="https://developers.facebook.com/docs/facebook-login/permissions/v2.3">https://developers.facebook.com/docs/facebook-login/permissions/v2.3</a>.</p></div></div>
<div class="section" title="Posting a Facebook status update"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec104"/>Posting a Facebook status update</h1></div></div></div><p>In this recipe, you'll learn how to post a status update on a Facebook user's Timeline from a Spring web<a id="id466" class="indexterm"/> application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec246"/>Getting ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Facebook</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec247"/>How to do it…</h2></div></div></div><p>Here are the steps to post a status update on a Facebook Timeline:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">FacebookController</code> class, in the <code class="literal">login()</code> method, add <code class="literal">publish_actions</code> to the <code class="literal">scope</code> parameter:<div class="informalexample"><pre class="programlisting">  params.setScope("public_profile, <span class="strong"><strong>publish_actions</strong></span>");</pre></div></li><li class="listitem">In the <code class="literal">fb()</code> method, in the <code class="literal">if(facebook.isAuthorized())</code> block, use the Facebook object to post the status update:<div class="informalexample"><pre class="programlisting">facebook.feedOperations().updateStatus("This was posted from a Spring web application.");</pre></div></li></ol></div></div></div>
<div class="section" title="Posting a link to Facebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec105"/>Posting a link to Facebook</h1></div></div></div><p>In this recipe, you'll learn how to post a link on a Facebook user's Timeline from a Spring web <a id="id467" class="indexterm"/>application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec248"/>Getting ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Facebook</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec249"/>How to do it…</h2></div></div></div><p>Here are the steps to post a link on a Facebook user's Timeline:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">FacebookController</code> class, in the <code class="literal">login()</code> method, add <code class="literal">publish_actions</code> to the <code class="literal">scope</code> parameter:<div class="informalexample"><pre class="programlisting">  params.setScope("public_profile, <span class="strong"><strong>publish_actions</strong></span>");</pre></div></li><li class="listitem">In the <code class="literal">fb()</code> method, in the <code class="literal">if(facebook.isAuthorized())</code> block, create a <code class="literal">FacebookLink</code> object with the link URL, title, caption, and description:<div class="informalexample"><pre class="programlisting">FacebookLink link = new FacebookLink("http://jeromejaglale.com/",
    "Spring is easy with Spring Cookbook",
    "Spring Cookbook",
    "The recipes are understandable and actually work.");</pre></div></li><li class="listitem">Use the Facebook object to post the link:<div class="informalexample"><pre class="programlisting">facebook.feedOperations().postLink("This link was posted from a Spring web application.", link);</pre></div></li><li class="listitem">In<a id="id468" class="indexterm"/> your browser, go to <code class="literal">/fb</code>. Then, go to the user's Facebook account and verify that the link has been posted.<div class="mediaobject"><img src="graphics/5807OS_10_04.jpg" alt="How to do it…"/></div></li></ol></div></div></div>
<div class="section" title="Posting a custom object to Facebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec106"/>Posting a custom object to Facebook</h1></div></div></div><p>In this recipe, you'll learn how to post a custom object to a Facebook user's Timeline from a <a id="id469" class="indexterm"/>Spring web application. A custom object is a link with more customizable options: picture, privacy, and location. In this recipe, we will add a picture to a link.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec250"/>Getting ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Facebook</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec251"/>How to do it…</h2></div></div></div><p>Here are the steps to post a custom object:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">FacebookController</code> class, in the <code class="literal">login()</code> method, add <code class="literal">publish_actions</code> to the <code class="literal">scope</code> parameter:<div class="informalexample"><pre class="programlisting">  params.setScope("public_profile, <span class="strong"><strong>publish_actions</strong></span>");</pre></div></li><li class="listitem">In the <code class="literal">fb()</code> method, in the <code class="literal">if(facebook.isAuthorized()</code><span class="strong"><strong>)</strong></span> block, create a <code class="literal">PostData</code> object using the Facebook object:<div class="informalexample"><pre class="programlisting">PostData postData = new PostData(facebook.userOperations().getUserProfile().getId());</pre></div></li><li class="listitem">Initialize<a id="id470" class="indexterm"/> the different fields of the custom object:<div class="informalexample"><pre class="programlisting">postData.message("Vegetables are good for you.");
postData.link("http://jeromejaglale.com");
postData.caption("Pasta and vegetables");
postData.description("Carbs are fine. Just don't forget your vegetables.");
postData.picture("http://jeromejaglale.com/images/ photo/vancouver_summer_2007/aa_02_appetissant.JPG");</pre></div></li><li class="listitem">Use the Facebook object to post the custom object:<div class="informalexample"><pre class="programlisting">facebook.feedOperations().post(postData);</pre></div></li><li class="listitem">In your browser, go to <code class="literal">/fb</code>. Then, go to the user's Facebook account and verify that the custom object has been posted.<div class="mediaobject"><img src="graphics/5807OS_10_05.jpg" alt="How to do it…"/></div></li></ol></div></div></div>
<div class="section" title="Creating a Twitter application"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec107"/>Creating a Twitter application</h1></div></div></div><p>A web <a id="id471" class="indexterm"/>application can access a Twitter account only through a Twitter application. In this recipe, we will create a Twitter application. We will obtain an <span class="strong"><strong>API key</strong></span> and an <span class="strong"><strong>API secret</strong></span>, which are two strings that our web application will use to <a id="id472" class="indexterm"/>connect to <a id="id473" class="indexterm"/>Twitter in the following recipes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec252"/>Getting ready</h2></div></div></div><p>Log in to your Twitter account.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec253"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go <a id="id474" class="indexterm"/>to <a class="ulink" href="https://apps.twitter.com/">https://apps.twitter.com/</a>.</li><li class="listitem">Click on <span class="strong"><strong>Create New App</strong></span>.</li><li class="listitem">Fill in the form and create your application. Note that <code class="literal">localhost</code> is not a valid domain name for the <span class="strong"><strong>Callback URL</strong></span> field, but an IP address works.</li><li class="listitem">On your application page, under <span class="strong"><strong>Settings</strong></span>, check <span class="strong"><strong>Allow this application to be used to Sign in with Twitter</strong></span>.</li><li class="listitem">Under <span class="strong"><strong>Keys and Access Tokens</strong></span>, copy the <span class="strong"><strong>API key</strong></span> and <span class="strong"><strong>API secret</strong></span> values. You will use them in your web application to identify your Twitter application.</li></ol></div></div></div>
<div class="section" title="Connecting to Twitter"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec108"/>Connecting to Twitter</h1></div></div></div><p>Twitter allows access to a user account through an OAuth workflow; from our web application, the<a id="id475" class="indexterm"/> user is redirected to a Twitter page to authorize the Twitter application in order to access his/her account. The user is then redirected back to our web application. In this recipe, we'll implement this OAuth workflow.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec254"/>Getting ready</h2></div></div></div><p>You need an existing Twitter application. Refer to the <span class="emphasis"><em>Creating a Twitter application recipe</em></span>.</p><p>We will use a JSP, so make sure that the Maven dependency for JSTL is declared in your <code class="literal">pom.xml</code> file and the corresponding <code class="literal">ViewResolver</code> bean is declared in your Spring configuration class. For more details, refer to the <span class="emphasis"><em>Using a JSP view</em></span> recipe in <a class="link" href="ch03.html" title="Chapter 3. Using Controllers and Views">Chapter 3</a>, <span class="emphasis"><em>Using Controllers and Views</em></span>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec255"/>How to do it…</h2></div></div></div><p>Here are the<a id="id476" class="indexterm"/> steps to implement the Twitter OAuth workflow:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependencies for Spring Social and Spring Social Twitter in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
    &lt;artifactId&gt;spring-social-core&lt;/artifactId&gt;
    &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
    &lt;artifactId&gt;spring-social-web&lt;/artifactId&gt;
    &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
    &lt;artifactId&gt;spring-social-config&lt;/artifactId&gt;
    &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;
  &lt;artifactId&gt;spring-social-twitter&lt;/artifactId&gt;
  &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;    </pre></div></li><li class="listitem">Create a controller class:<div class="informalexample"><pre class="programlisting">@Controller
public class TwitterController {
...</pre></div></li><li class="listitem">Create a Twitter login method containing your API key and API secret, which will redirect to Twitter's authorization page:<div class="informalexample"><pre class="programlisting">@RequestMapping("/tw/login")
public void login(HttpServletRequest request, HttpServletResponse response) throws IOException {
  TwitterConnectionFactory connectionFactory = new TwitterConnectionFactory("<span class="strong"><strong>YtAG8npnZkUFDghkF2V3ykm0P</strong></span>", "<span class="strong"><strong>RQ6hGGALfEaWGh6Vu03xcFtM1ibicW8IwSUBKaLG4drvVXXaay</strong></span>");
    OAuth1Operations oauthOperations = connectionFactory.getOAuthOperations();
    
    OAuthToken requestToken = oauthOperations.fetchRequestToken("http:// jeromejaglale.com:8080/spring_webapp/tw/callback", null);      
    request.getSession().setAttribute("requestToken", requestToken);
    String authorizeUrl = oauthOperations.buildAuthenticateUrl(requestToken.getValue(), OAuth1Parameters.NONE);
    
    response.<span class="strong"><strong>sendRedirect</strong></span>(authorizeUrl);
}</pre></div></li><li class="listitem">Create the <a id="id477" class="indexterm"/><code class="literal">callback</code> method, where the user will be redirected after logging in to Twitter. Use the <code class="literal">oauth_verifier</code> parameter received from Twitter as well as the request token from <code class="literal">login()</code> to get an access token and save it in the session:<div class="informalexample"><pre class="programlisting">@RequestMapping("/tw/callback")
public String callback(String oauth_token, String oauth_verifier, HttpServletRequest request) {
  TwitterConnectionFactory connectionFactory = new TwitterConnectionFactory("YtAG8npnZkUFDghkF2V3ykm0P", "RQ6hGGALfEaWGh6Vu03xcFtM1ibicW8IwSUBKaLG4drvVXXaay");

  OAuthToken requestToken = (OAuthToken) request.getSession().getAttribute("requestToken");    
  OAuth1Operations oAuthOperations = connectionFactory.getOAuthOperations();
  OAuthToken token = oAuthOperations.exchangeForAccessToken(new AuthorizedRequestToken(requestToken, oauth_verifier), null);
  
  request.getSession().setAttribute("twitterToken", token);
  
  return "redirect:/tw";
}</pre></div></li><li class="listitem">Create a method that will display a JSP if it manages to connect to Twitter. Otherwise, it will redirect to the login URL:<div class="informalexample"><pre class="programlisting">@RequestMapping("/tw")
public String tw(HttpServletRequest request) {
  OAuthToken token = (OAuthToken) request.getSession().getAttribute("twitterToken");
  if(token == null) {
    return "redirect:/tw/login";      
  }

  TwitterConnectionFactory connectionFactory = new TwitterConnectionFactory("YtAG8npnZkUFDghkF2V3ykm0P", "RQ6hGGALfEaWGh6Vu03xcFtM1ibicW8IwSUBKaLG4drvVXXaay");
  Connection&lt;Twitter&gt; connection = connectionFactory.createConnection(token);
  Twitter twitter = connection.getApi();
  if( ! twitter.isAuthorized()) {
    return "redirect:/tw/login";      
  }

  return "tw";
}</pre></div></li><li class="listitem">Create a<a id="id478" class="indexterm"/> JSP for the previous method:<div class="informalexample"><pre class="programlisting">&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt; 
&lt;%@ page isELIgnored="false" %&gt;
&lt;html&gt;
&lt;body&gt;
    &lt;p&gt;Connected to Twitter&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec256"/>How it works…</h2></div></div></div><p>The <code class="literal">login()</code> method builds a Twitter authorization URL using the API key and redirects the user to it.</p><div class="mediaobject"><img src="graphics/5807OS_10_06.jpg" alt="How it works…"/></div><p>Once the<a id="id479" class="indexterm"/> user has authorized our Twitter application, he/she is redirected back to our web application to a <span class="emphasis"><em>callback URL</em></span>, <code class="literal">/tw/callback</code>, that we provided with this line:</p><div class="informalexample"><pre class="programlisting">OAuthToken requestToken = oauthOperations.fetchRequestToken("http://jeromejaglale.com:8080/ spring_webapp/tw/callback", null);</pre></div><p>The callback URL contains a <code class="literal">oauth_verifier</code> parameter provided by Twitter.</p><p>In the <code class="literal">callback()</code> method, we use this authorization code to get an OAuth access token that we store in the session. This is part of the standard OAuth workflow; the token is not provided directly, so it's not shown to the user. On our server, the application secret (also never shown to the user) is required to obtain the token from the authorization code.</p><p>We then<a id="id480" class="indexterm"/> redirect the user to <code class="literal">/tw</code>. In the <code class="literal">tw()</code> method, we retrieve the token from the session and use it to connect to the user's Twitter account.</p></div></div>
<div class="section" title="Retrieving a user's Twitter profile"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec109"/>Retrieving a user's Twitter profile</h1></div></div></div><p>In this recipe, you'll learn how to retrieve a user's Twitter profile data, which automatically <a id="id481" class="indexterm"/>becomes available to the Twitter application once the user has authorized the Twitter application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec257"/>Getting ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Twitter</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec258"/>How to do it…</h2></div></div></div><p>Here are the steps to retrieve data from the profile of a Twitter user:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">TwitterController</code> class, add a <code class="literal">Model</code> argument to the <code class="literal">tw()</code> method:<div class="informalexample"><pre class="programlisting">@RequestMapping("/fw")
public String fb(HttpServletRequest request, Model model) {
...</pre></div></li><li class="listitem">In that method, use the Twitter object to retrieve the user profile:<div class="informalexample"><pre class="programlisting">TwitterProfile profile = twitter.userOperations().getUserProfile();</pre></div></li><li class="listitem">Pass the user profile to the JSP view:<div class="informalexample"><pre class="programlisting">model.addAttribute("profile", profile);</pre></div></li><li class="listitem">In the JSP, display data from the user profile:<div class="informalexample"><pre class="programlisting">name: ${profile.name}&lt;br /&gt;
screenName: ${profile.screenName}&lt;br /&gt;
url: ${profile.url}&lt;br /&gt;
profileImageUrl: ${profile.profileImageUrl}&lt;br /&gt;
description: ${profile.description}&lt;br /&gt;
location: ${profile.location}&lt;br /&gt;
createdDate: ${profile.createdDate}&lt;br /&gt;
language: ${profile.language}&lt;br /&gt;
statusesCount: ${profile.statusesCount}&lt;br /&gt;
followersCount: ${profile.followersCount}&lt;br /&gt;</pre></div></li></ol></div></div></div>
<div class="section" title="Retrieving the tweets of a Twitter user"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec110"/>Retrieving the tweets of a Twitter user</h1></div></div></div><p>In this recipe, you'll <a id="id482" class="indexterm"/>learn how to retrieve the last tweets of a Twitter user from a Spring web application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec259"/>Getting ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Twitter</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec260"/>How to do it…</h2></div></div></div><p>Here are the steps to retrieve the last tweets of a Twitter user:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">TwitterController</code> class, add a <code class="literal">Model</code> argument to the <code class="literal">tw()</code> method:<div class="informalexample"><pre class="programlisting">@RequestMapping("/fw")
public String fb(HttpServletRequest request, Model model) {
...</pre></div></li><li class="listitem">In that method, use the Twitter object to retrieve the user's tweets:<div class="informalexample"><pre class="programlisting">List&lt;Tweet&gt; tweets = twitter.timelineOperations().getUserTimeline();</pre></div></li><li class="listitem">Pass the list of tweets to the JSP view:<div class="informalexample"><pre class="programlisting">model.addAttribute("tweets", tweets);</pre></div></li><li class="listitem">In the JSP, display the list of tweets:<div class="informalexample"><pre class="programlisting">&lt;c:forEach items="${tweets}" var="tweet"&gt;
  &lt;p&gt;${tweet.text}&lt;/p&gt;
&lt;/c:forEach&gt;</pre></div></li></ol></div></div></div>
<div class="section" title="Posting a tweet to Twitter"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec111"/>Posting a tweet to Twitter</h1></div></div></div><p>In this recipe, you'll learn how to post a tweet on behalf of a user from a Spring web application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec261"/>Getting ready</h2></div></div></div><p>This recipe<a id="id483" class="indexterm"/> uses the code from the <span class="emphasis"><em>Connecting to Twitter</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec262"/>How to do it…</h2></div></div></div><p>In the <code class="literal">TwitterController</code> class, in<a id="id484" class="indexterm"/> the <code class="literal">tw()</code> method, use the Twitter object to post a tweet.</p><div class="informalexample"><pre class="programlisting">twitter.timelineOperations().updateStatus("Just a test");</pre></div></div></div>
<div class="section" title="Sending a private message to another Twitter user"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec112"/>Sending a private message to another Twitter user</h1></div></div></div><p>In this recipe, you'll learn how to send a private message to another Twitter user from a Spring web <a id="id485" class="indexterm"/>application. Note that the user who is the recipient has to be a follower of the user who is the sender.</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec263"/>Getting Ready</h2></div></div></div><p>This recipe uses the code from the <span class="emphasis"><em>Connecting to Twitter</em></span> recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec264"/>How to do it…</h2></div></div></div><p>In the <span class="strong"><strong>TwitterController</strong></span> class, in the <span class="strong"><strong>tw()</strong></span> method, use the Twitter object to send a private message to another Twitter user:</p><div class="informalexample"><pre class="programlisting">twitter.directMessageOperations().sendDirectMessage("jeromejaglale", "Hey Jerome, I'm just testing your recipe.");</pre></div></div></div></body></html>