<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><div id="_idContainer540" class="Basic-Text-Frame">
    <h1 class="chapterNumber">20</h1>
    <h1 id="_idParaDest-496" class="chapterTitle">Monitoring Microservices</h1>
    <p class="normal">In this chapter, we will learn how to use Prometheus and Grafana to collect, monitor, and alert about performance metrics. As we mentioned in <em class="chapterRef">Chapter 1</em>, <em class="italic">Introduction to Microservices</em>, in a production environment it is crucial to be able to collect metrics for application performance and hardware resource usage. Monitoring these metrics is required to avoid long response times or outages for API requests and other processes.</p>
    <p class="normal">To be able to monitor a system landscape of microservices in a cost-efficient and proactive way, we must also be able to define alarms that are triggered automatically if the metrics exceed the configured limits.</p>
    <p class="normal">In this chapter, we will cover the following topics:</p>
    <ul>
      <li class="bulletList">Introduction to performance monitoring using Prometheus and Grafana</li>
      <li class="bulletList">Changes in source code to collect application metrics</li>
      <li class="bulletList">Building and deploying the microservices</li>
      <li class="bulletList">Monitoring microservices using Grafana dashboards</li>
      <li class="bulletList">Setting up alarms in Grafana</li>
    </ul>
    <h1 id="_idParaDest-497" class="heading-1">Technical requirements</h1>
    <p class="normal">For instructions on how to install the tools used in this book and how to access the source code for this book, see:</p>
    <ul>
      <li class="bulletList"><em class="chapterRef">Chapter 21</em>, <em class="italic">Installation Instructions for macOS</em></li>
      <li class="bulletList"><em class="chapterRef">Chapter 22</em>, <em class="italic">Installation Instructions for Microsoft Windows with WSL 2 and Ubuntu</em></li>
    </ul>
    <p class="normal">The code examples in this chapter all come from the source code in <code class="inlineCode">$BOOK_HOME/Chapter19</code>.</p>
    <p class="normal">If you want to view the changes applied to the source code in this chapter so that you can use Prometheus and Grafana to monitor and alert on performance metrics, you can compare it with the source code for <em class="chapterRef">Chapter 19</em>, <em class="italic">Centralized Logging with the EFK Stack</em>. You can use your favorite diff tool and compare the two folders, <code class="inlineCode">$BOOK_HOME/Chapter19</code> and <code class="inlineCode">$BOOK_HOME/Chapter20</code>.</p>
    <h1 id="_idParaDest-498" class="heading-1">Introduction to performance monitoring using Prometheus and Grafana</h1>
    <p class="normal">In this chapter, we will reuse the deployment of Prometheus and Grafana that we created in <em class="chapterRef">Chapter 18</em>, <em class="italic">Using a Service Mesh to Improve Observability and Management</em>, in the <em class="italic">Deploying Istio in a Kubernetes cluster</em> section. Also in that chapter, we were briefly introduced to<a id="_idIndexMarker1466"/> Prometheus, a popular open source<a id="_idIndexMarker1467"/> database for collecting and storing time series data such as performance metrics. We learned about Grafana, an open source tool to visualize performance metrics. With the Grafana deployment comes a set of Istio-specific dashboards. Kiali can also render some performance-related graphs without the use of Grafana. In this chapter, we will get some hands-on experience with these tools.</p>
    <p class="normal">The Istio configuration we deployed in <em class="chapterRef">Chapter 18</em> includes a configuration of Prometheus, which automatically collects metrics from Pods in Kubernetes. All we need to do is set up an endpoint in our microservice that produces metrics in a format Prometheus can consume. We also need to add annotations to the Kubernetes Pods so that Prometheus can find the address of these endpoints. See the <em class="italic">Changes in source code to collect application metrics</em> section of this chapter for details on how to set this up. To demonstrate Grafana’s capabilities to raise alerts, we will also deploy a local mail server.</p>
    <p class="normal">The following diagram illustrates the relationship between the runtime components we just discussed:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_01.png" alt="A screenshot of a computer  Description automatically generated with low confidence" width="878" height="467"/></figure>
    <p class="packt_figref">Figure 20.1: Adding Prometheus and Grafana to the system landscape</p>
    <p class="normal">Here, we can see how Prometheus uses the annotations in the definitions of the Kubernetes Pods to be able to <a id="_idIndexMarker1468"/>collect metrics from our microservices. It then stores these metrics in <a id="_idIndexMarker1469"/>its database. A user can access the web UIs of Kiali and Grafana to monitor these<a id="_idIndexMarker1470"/> metrics in a <strong class="keyWord">web browser</strong>. The web<a id="_idIndexMarker1471"/> browser uses the <strong class="keyWord">minikube tunnel</strong> that was introduced in <em class="chapterRef">Chapter 18</em>, in the <em class="italic">Setting up access to Istio services</em> section, to access Kiali, Grafana, and also a web page from the mail server to see alerts sent out by Grafana.</p>
    <div class="packt_tip">
      <p class="normal">Please remember that the configuration that was used to deploy Istio from <em class="chapterRef">Chapter 18</em> is only intended for development and testing, not production. For example, performance metrics stored in the Prometheus database will not survive the Prometheus Pod being restarted!</p>
    </div>
    <p class="normal">With the Istio version used in this book, v1.17.0, comes Grafana v9.0.1 and Prometheus v2.34.0. In Grafana v8, a new alerting system was introduced. To support readers of this book that use older versions of Grafana than v8, the older way of configuring alerts will be used. Grafana will be configured to use the older alert system in the <em class="italic">Configuring Grafana </em>section below.</p>
    <p class="normal">In the next section, we will look at what changes have been applied to the source code to make the microservices produce performance metrics that Prometheus can collect.</p>
    <h1 id="_idParaDest-499" class="heading-1">Changes in source code to collect application metrics</h1>
    <p class="normal">Spring Boot 2 introduced <a id="_idIndexMarker1472"/>support for producing performance metrics in a Prometheus format using the <strong class="keyWord">Micrometer</strong> library (<a href="https://micrometer.io"><span class="url">https://micrometer.io</span></a>). There’s only <a id="_idIndexMarker1473"/>one change we need to make to the source code of the microservices: we need to add a dependency on the Micrometer library, <code class="inlineCode">micrometer-registry-prometheus</code>, in the Gradle build files, <code class="inlineCode">build.gradle</code>. The dependency looks like this:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">implementation</span> <span class="hljs-string">'io.micrometer:micrometer-registry-prometheus'</span>
</code></pre>
    <p class="normal">This will make the microservices produce Prometheus metrics on port <code class="inlineCode">4004</code> using the <code class="inlineCode">/actuator/prometheus</code> path.</p>
    <div class="packt_tip">
      <p class="normal">In <em class="chapterRef">Chapter 18</em>, we separated the management port, used by the actuator, from the port serving requests to APIs exposed by a microservice. See the <em class="italic">Observing the service mesh </em>section for a recap, if required.</p>
    </div>
    <p class="normal">To let Prometheus know about these endpoints, each microservice’s Pod is annotated with the following code:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">annotations:</span>
  <span class="hljs-attr">prometheus.io/scrape:</span> <span class="hljs-string">"true"</span>
  <span class="hljs-attr">prometheus.io/port:</span> <span class="hljs-string">"4004"</span>
  <span class="hljs-attr">prometheus.io/scheme:</span> <span class="hljs-string">http</span>
  <span class="hljs-attr">prometheus.io/path:</span> <span class="hljs-string">"/actuator/prometheus"</span>
</code></pre>
    <div class="packt_tip">
      <p class="normal">This is added to the <code class="inlineCode">values.yaml</code> file of each component’s Helm chart. See <code class="inlineCode">kubernetes/helm/components</code>.</p>
    </div>
    <p class="normal">To make it easier to identify the source of the metrics once they have been collected by Prometheus, they are tagged with the name of the microservice that produced the metric. This is achieved by adding the following configuration to the common configuration file, <code class="inlineCode">config-repo/application.yml</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">management.metrics.tags.application:</span> <span class="hljs-string">${spring.application.name}</span>
</code></pre>
    <p class="normal">This will result in each metric that’s produced having an extra label named <code class="inlineCode">application</code>. It will contain <a id="_idIndexMarker1474"/>the value of the standard Spring property for the name of a microservice, <code class="inlineCode">spring.application.name</code>.</p>
    <p class="normal">Finally, to ensure that we get metrics from the configured Prometheus endpoints, a test has been added to <code class="inlineCode">test-em-all.bash</code>. It looks like:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">if</span> [[ $USE_K8S == <span class="hljs-string">"true"</span> ]]
then
  # Verify access to Prometheus formatted metrics
  echo <span class="hljs-string">"Prometheus metrics tests"</span>
  assertCurl <span class="hljs-number">200</span> <span class="hljs-string">"curl -ks https://health.minikube.me/actuator/prometheus"</span>
fi
</code></pre>
    <p class="normal">Note that this test only runs if the test script is run against Kubernetes.</p>
    <p class="normal">These are all the changes that are required to prepare the microservices to produce performance metrics and make Prometheus aware of what endpoints to use to start collecting them. In the next section, we will build and deploy the microservices.</p>
    <h1 id="_idParaDest-500" class="heading-1">Building and deploying the microservices</h1>
    <p class="normal">Building, deploying, and <a id="_idIndexMarker1475"/>verifying the deployment using the <code class="inlineCode">test-em-all.bash</code> test script is <a id="_idIndexMarker1476"/>done in the same way it was done in <em class="chapterRef">Chapter 19</em>, <em class="italic">Centralized Logging with the EFK Stack</em>, in the <em class="italic">Building and deploying the microservices</em> section. Run the following commands:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Build the Docker images from the source with the following commands:
        <pre class="programlisting con"><code class="hljs-con">cd $BOOK_HOME/Chapter20
eval $(minikube docker-env -u)
./gradlew build
eval $(minikube docker-env)
docker-compose build
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">The <code class="inlineCode">eval $(minikube docker-env -u)</code> command ensures that the <code class="inlineCode">./gradlew build</code> command uses the host’s Docker engine and not the Docker engine in the Minikube instance. The <code class="inlineCode">build</code> command uses Docker to run test containers.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Recreate the <a id="_idIndexMarker1477"/>namespace, <code class="inlineCode">hands-on</code>, and set it as the default namespace:
        <pre class="programlisting con"><code class="hljs-con">kubectl delete namespace hands-on
kubectl apply -f kubernetes/hands-on-namespace.yml
kubectl config set-context $(kubectl config current-context) --namespace=hands-on 
</code></pre>
      </li>
      <li class="numberedList">Resolve the Helm chart <a id="_idIndexMarker1478"/>dependencies with the following commands. <p class="normal">First, we update the dependencies in the <code class="inlineCode">components</code> folder:</p>
        <pre class="programlisting con"><code class="hljs-con">for f in kubernetes/helm/components/*; do helm dep up $f; done
</code></pre>
        <p class="normal">Next, we update the dependencies in the <code class="inlineCode">environments</code> folder:</p>
        <pre class="programlisting con"><code class="hljs-con">for f in kubernetes/helm/environments/*; do helm dep up $f; done
</code></pre>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Deploy the system landscape using Helm and wait for all deployments to complete:
        <pre class="programlisting con"><code class="hljs-con">helm install hands-on-dev-env \
  kubernetes/helm/environments/dev-env \
  -n hands-on --wait
</code></pre>
      </li>
      <li class="numberedList">Start the Minikube tunnel, if it’s not already running, as follows (see the <em class="italic">Setting up access to Istio services</em> section, in <em class="chapterRef">Chapter 18</em>, for a recap if you need one):
        <pre class="programlisting con"><code class="hljs-con">minikube tunnel
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Remember that this command requires that your user has <code class="inlineCode">sudo</code> privileges and that you enter your password during startup. It takes a couple of seconds before the command asks for the password, so it is easy to miss!</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Run the normal tests to verify the deployment with the following command:
        <pre class="programlisting con"><code class="hljs-con">./test-em-all.bash
</code></pre>
      </li>
    </ol>
    <p class="normal">Expect the <a id="_idIndexMarker1479"/>output to be similar to what we’ve seen in the <a id="_idIndexMarker1480"/>previous chapters:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_02.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="621" height="244"/></figure>
    <p class="packt_figref">Figure 20.2: All tests OK</p>
    <p class="normal">With the microservices deployed, we can move on and start monitoring our microservices using Grafana!</p>
    <h1 id="_idParaDest-501" class="heading-1">Monitoring microservices using Grafana dashboards</h1>
    <p class="normal">As we already mentioned<a id="_idIndexMarker1481"/> in the introduction, Kiali provides some very useful dashboards out of the box. In general, they are focused on application-level performance metrics such as requests per<a id="_idIndexMarker1482"/> second, response times, and fault percentages to process requests. As we will see shortly, they are<a id="_idIndexMarker1483"/> very useful on an application level. But if we want to understand the usage of the underlying hardware resources, we need more detailed metrics, for example, Java VM-related metrics.</p>
    <p class="normal">Grafana has an active community that, among other things, shares reusable dashboards. We will try out a dashboard from the community that’s tailored to get a lot of valuable Java VM-related metrics from a Spring Boot application such as our microservices. Finally, we will see how we can build our own dashboards in Grafana. But let’s<a id="_idIndexMarker1484"/> start by exploring the dashboards that come out of the box in Kiali and Grafana.</p>
    <p class="normal">Before we do that, we need to make two <a id="_idIndexMarker1485"/>preparations:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Install a local mail server for tests and configure Grafana to be able to send alert emails to it. We will use the mail server in the <em class="italic">Setting up alarms in Grafana</em> section.</li>
      <li class="numberedList">To be able to <a id="_idIndexMarker1486"/>monitor some metrics, we will start the load test tool we used in previous chapters.</li>
    </ol>
    <h2 id="_idParaDest-502" class="heading-2">Installing a local mail server for tests</h2>
    <p class="normal">In this section, we <a id="_idIndexMarker1487"/>will set up a local test mail server and configure Grafana to send alert emails to the mail server.</p>
    <p class="normal">Grafana can send emails to any SMTP mail server, but to keep the tests local, we will deploy a test mail server named <code class="inlineCode">maildev</code>. Go through the following steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Install the test mail server in Istio’s namespace with the following commands:
        <pre class="programlisting con"><code class="hljs-con">kubectl -n istio-system create deployment mail-server --image maildev/maildev:2.0.5
kubectl -n istio-system expose deployment mail-server --port=1080,1025 --type=ClusterIP
kubectl -n istio-system wait --timeout=60s --for=condition=ready pod -l app=mail-server
</code></pre>
      </li>
      <li class="numberedList">To make the mail server’s web UI available from the outside of Minikube, a set of <code class="inlineCode">Gateway</code>, <code class="inlineCode">VirtualService</code>, and <code class="inlineCode">DestinationRule</code> manifest files has been added for the mail server in Istio’s Helm chart. See the template <code class="inlineCode">kubernetes/helm/environments/istio-system/templates/expose-mail.yml</code>. Run a <code class="inlineCode">helm upgrade</code> command to apply the new manifest files:
        <pre class="programlisting con"><code class="hljs-con">helm upgrade istio-hands-on-addons kubernetes/helm/environments/istio-system -n istio-system
</code></pre>
      </li>
      <li class="numberedList">Verify that the test mail server is up and running by visiting its web page at <a href="https://mail.minikube.me"><span class="url">https://mail.minikube.me</span></a>. Expect a <a id="_idIndexMarker1488"/>web page such as the following to be rendered:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_03.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="812" height="347"/></figure>
    <p class="packt_figref">Figure 20.3: Mail server web page</p>
    <div class="packt_tip">
      <p class="normal">For more information on the mail server, see <a href="https://hub.docker.com/r/maildev/maildev"><span class="url">https://hub.docker.com/r/maildev/maildev</span></a>.</p>
    </div>
    <p class="normal">With the mail server installed, we can configure Grafana in the next section to send emails to the server for alerts.</p>
    <h2 id="_idParaDest-503" class="heading-2">Configuring Grafana</h2>
    <p class="normal">Configuring<a id="_idIndexMarker1489"/> Grafana can be done by setting up environment variables in its Kubernetes Deployment <a id="_idIndexMarker1490"/>object. To enable the old alert system and configure Grafana to send emails to the test mail server, run the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con">kubectl -n istio-system set env deployment/grafana \
    GF_ALERTING_ENABLED=true \
    GF_UNIFIED_ALERTING_ENABLED=false \
    GF_SMTP_ENABLED=true \
    GF_SMTP_SKIP_VERIFY=true \
    GF_SMTP_HOST=mail-server:1025 \
    GF_SMTP_FROM_ADDRESS=grafana@minikube.me
kubectl -n istio-system wait --timeout=60s --for=condition=ready pod -l app=Grafana
</code></pre>
    <p class="normal">The variables <code class="inlineCode">GF_ALERTING_ENABLED</code> and <code class="inlineCode">GF_UNIFIED_ALERTING_ENABLED</code> are used to enable the use of the older alerting system mentioned in the <em class="italic">Introduction to performance monitoring using Prometheus and Grafana</em> section above. The <code class="inlineCode">GF_SMTP_ENABLED </code>variable is used to allow Grafana to send emails. The <code class="inlineCode">GF_SMTP_SKIP_VERIFY</code> variable is used to tell Grafana to skip SSL checks with the test mail server. </p>
    <p class="normal">The <code class="inlineCode">GF_SMTP_HOST</code> variable points to our mail server and, finally, the <code class="inlineCode">GF_SMTP_FROM_ADDRESS</code> variable specifies what “from” address to use in the mail.</p>
    <p class="normal">Now that Grafana has been configured, in the next section we will start the load test tool.</p>
    <h2 id="_idParaDest-504" class="heading-2">Starting up the load test</h2>
    <p class="normal">To have something to <a id="_idIndexMarker1491"/>monitor, let’s start up the load test using Siege, which we used in previous chapters. Run the following commands to get an access token and then start up the load test, using the access token for authorization:</p>
    <pre class="programlisting con"><code class="hljs-con">ACCESS_TOKEN=$(curl https://writer:secret-writer@minikube.me/oauth2/token -d grant_type=client_credentials -d scope="product:read product:write" -ks | jq .access_token -r)
echo ACCESS_TOKEN=$ACCESS_TOKEN
siege https://minikube.me/product-composite/1 -H "Authorization: Bearer $ACCESS_TOKEN" -c1 -d1 -v
</code></pre>
    <div class="packt_tip">
      <p class="normal">Remember that an access token is only valid for 1 hour – after that, you need to get a new one.</p>
    </div>
    <p class="normal">Now, we are ready to learn about the dashboards in Kiali and Grafana and explore the Grafana<a id="_idIndexMarker1492"/> dashboards that come with Istio.</p>
    <h2 id="_idParaDest-505" class="heading-2">Using Kiali’s built-in dashboards</h2>
    <p class="normal">In <em class="chapterRef">Chapter 18</em>, we learned about Kiali, but we skipped the part where Kiali shows performance metrics. Now, it’s<a id="_idIndexMarker1493"/> time to get back to that subject!</p>
    <p class="normal">Execute the following steps to learn about Kiali’s built-in dashboards:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Open the Kiali web UI in a web browser using the <a href="https://kiali.minikube.me"><span class="url">https://kiali.minikube.me</span></a> URL. Log in with <code class="inlineCode">admin</code>/<code class="inlineCode">admin</code> if required.</li>
      <li class="numberedList">To see our deployments, go to the workloads page by clicking on the <strong class="screenText">Workloads</strong> tab from the menu on the left-hand side.</li>
      <li class="numberedList">Select the <strong class="screenText">product-composite</strong> deployment by clicking on it.</li>
      <li class="numberedList">On the <strong class="screenText">product-composite</strong> page, select the <strong class="screenText">Outbound Metrics</strong> tab. You will see a page like the following screenshot: <figure class="mediaobject"><img src="../Images/B19825_20_04.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="812" height="499"/></figure>
        <p class="packt_figref">Figure 20.4: Kiali outbound metrics</p>
        <p class="normal">Kiali will visualize some overall performance graphs that are of great value, and there are more graphs to explore. Feel free to try them out on your own!</p>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">However, far more detailed performance metrics are available in Grafana. Open the Grafana web UI in a web browser using the <a href="https://grafana.minikube.me"><span class="url">https://grafana.minikube.me</span></a> URL.</li>
      <li class="numberedList">You will be<a id="_idIndexMarker1494"/> presented with a welcome page with the text <strong class="screenText">Welcome to Grafana</strong>. Over the welcome text is a <strong class="screenText">Home</strong> link; click on it and you will be presented with an overview of available dashboards. You will see a folder named <strong class="screenText">Istio</strong> that contains the dashboards that were installed when Grafana was deployed together with Istio in <em class="chapterRef">Chapter 18</em>. Click on the folder to expand it and select the dashboard named <strong class="screenText">Istio Mesh Dashboard</strong>. <p class="numberedList">Expect a web page like the following:</p>
        <figure class="mediaobject"><img src="../Images/B19825_20_05.png" alt="A screenshot of a computer  Description automatically generated" width="812" height="560"/></figure>
        <p class="packt_figref">Figure 20.5: Grafana showing Istio Mesh Dashboard</p>
        <p class="normal">This <a id="_idIndexMarker1495"/>dashboard gives a very good overview of metrics for the microservices involved in the service mesh, like request rates, response times, and success rates.</p>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">There are a lot of detailed performance metrics available. Go back to the <strong class="screenText">Istio</strong> folder (click on <strong class="screenText">Istio</strong> in the top menu) and select the dashboard named <strong class="screenText">Istio Workload Dashboard</strong><strong class="keyWord">.</strong> Select the <strong class="screenText">hands-on</strong> namespace and the <strong class="screenText">product-composite </strong>workload. Finally, expand the <strong class="screenText">Outbound Services</strong> tab. The web page should look like the following screenshot:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_06.png" alt="A screenshot of a computer  Description automatically generated" width="812" height="647"/></figure>
    <p class="packt_figref">Figure 20.6: Grafana with a lot of metrics for a microservice</p>
    <p class="normal">The page displays metrics like response codes, duration, and bytes sent per destination. Feel free to look around among the remaining dashboards provided by Istio!</p>
    <p class="normal">As we’ve already <a id="_idIndexMarker1496"/>mentioned, the Istio dashboards give a very good overview at an application level. But there is also a need to monitor the metrics for hardware usage per microservice. In the next section, we will learn about how existing dashboards can be imported – specifically, a dashboard showing Java VM metrics for a Spring Boot-based application.</p>
    <h2 id="_idParaDest-506" class="heading-2">Importing existing Grafana dashboards</h2>
    <p class="normal">As we’ve already<a id="_idIndexMarker1497"/> mentioned, Grafana has an active community that shares reusable dashboards. They can be explored at <a href="https://grafana.com/grafana/dashboards"><span class="url">https://grafana.com/grafana/dashboards</span></a>. We will try out a dashboard called <strong class="keyWord">JVM (Micrometer) - Kubernetes - Prometheus by Istio</strong> that’s tailored <a id="_idIndexMarker1498"/>to get a lot of valuable JVM-related metrics from Spring Boot applications in a Kubernetes environment. The link to the dashboard is <a href="https://grafana.com/grafana/dashboards/11955"><span class="url">https://grafana.com/grafana/dashboards/11955</span></a>. Perform the following steps to import this dashboard:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Import the dashboard named <strong class="keyWord">JVM (Micrometer) </strong>by following these steps:<ol class="alphabeticList" style="list-style-type: lower-alpha;">
          <li class="alphabeticList" value="1">On the Grafana web page, hover the mouse over the <strong class="screenText">Dashboard</strong> icon (four squares) in the menu to the left. Select <strong class="screenText">+ Import</strong> from the menu that pops up.</li>
          <li class="alphabeticList">On the <strong class="screenText">Import</strong> page, enter the dashboard ID <code class="inlineCode">11955</code> into the <strong class="screenText">Import via grafana.com</strong> field and click on the <strong class="screenText">Load</strong> button next to it.</li>
          <li class="alphabeticList">On the <strong class="screenText">Import</strong> page that will be displayed, click on the <strong class="screenText">Prometheus</strong> drop-down menu and select the <strong class="screenText">Prometheus</strong> data source.</li>
          <li class="alphabeticList">Now, by clicking on the <strong class="screenText">Import</strong> button, the <strong class="screenText">JVM (Micrometer) </strong>dashboard will be imported and rendered.</li>
        </ol>
      </li>
      <li class="numberedList">Inspect the <strong class="screenText">JVM (Micrometer)</strong> dashboard by following these steps:<ol class="alphabeticList" style="list-style-type: lower-alpha;">
          <li class="alphabeticList" value="1">To get a good view of the metrics, use the time picker (in the top-right corner) to select <strong class="screenText">Last 5 minutes</strong>, and select a refresh rate of <strong class="screenText">5s</strong> in the dropdown to the right.</li>
          <li class="alphabeticList">In the <strong class="screenText">Application</strong> drop-down menu, which can be found at the top-left of the page, select the <strong class="screenText">product-composite</strong> microservice.</li>
          <li class="alphabeticList">Since we are running a load test using Siege in the background, we will see a lot of metrics. The following is a sample screenshot:</li>
        </ol>
      </li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_07.png" alt="A screenshot of a computer  Description automatically generated" width="818" height="811"/></figure>
    <p class="packt_figref">Figure 20.7: Grafana showing Java VM metrics</p>
    <p class="normal">In this dashboard, we can find all types of Java VM relevant metrics for, among <a id="_idIndexMarker1499"/>other things, CPU, memory, heap, and I/O usage, as well as HTTP-related metrics such as requests/second, average duration, and error rates. Feel free to explore these metrics on your own!</p>
    <p class="normal">Being able to import existing dashboards is of great value when we want to get started quickly. However, what’s even more important is to know how to create our own dashboard. We<a id="_idIndexMarker1500"/> will learn about this in the next section.</p>
    <h2 id="_idParaDest-507" class="heading-2">Developing your own Grafana dashboards</h2>
    <p class="normal">Getting started with<a id="_idIndexMarker1501"/> developing Grafana dashboards is straightforward. The important thing for us to understand is what metrics Prometheus makes available for us.</p>
    <p class="normal">In this section, we will learn how to examine the available metrics. Based on these, we will create a dashboard that can be used to monitor some of the more interesting metrics.</p>
    <h3 id="_idParaDest-508" class="heading-3">Examining Prometheus metrics</h3>
    <p class="normal">Earlier, in the <em class="italic">Changes in source code to collect application metrics</em> section, we configured <a id="_idIndexMarker1502"/>Prometheus to collect metrics from our microservices. We can make a call to the same endpoint and see what metrics Prometheus collects. Run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">curl https://health.minikube.me/actuator/prometheus -ks
</code></pre>
    <p class="normal">Expect a lot of output from the command, as in the following example:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_08.png" alt="A screen shot of a computer  Description automatically generated with medium confidence" width="878" height="216"/></figure>
    <p class="packt_figref">Figure 20.8: Prometheus metrics</p>
    <p class="normal">Among all of the metrics that are reported, there are two very interesting ones:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">resilience4j_retry_calls</code>: Resilience4j reports on how the retry mechanism operates. It reports four different values for successful and failed requests, combined with and without retries.</li>
      <li class="bulletList"><code class="inlineCode">resilience4j_circuitbreaker_state</code>: Resilience4j reports on the state of the circuit breaker.</li>
    </ul>
    <p class="normal">Note that the metrics have a label named <code class="inlineCode">application</code>, which contains the name of the microservice. This field comes from the configuration of the <code class="inlineCode">management.metrics.tags.application</code> property, which we did in the <em class="italic">Changes in source code to collect application metrics</em> section.</p>
    <p class="normal">These metrics are<a id="_idIndexMarker1503"/> interesting to monitor. None of the dashboards we have used so far use metrics from Resilience4j. In the next section, we will create a dashboard for these metrics.</p>
    <h3 id="_idParaDest-509" class="heading-3">Creating the dashboard</h3>
    <p class="normal">In this section, we <a id="_idIndexMarker1504"/>will learn how to create a dashboard that visualizes the Resilience4j metrics we described in the previous section.</p>
    <p class="normal">We will set up the dashboard in the following stages:</p>
    <ul>
      <li class="bulletList">Creating an empty dashboard</li>
      <li class="bulletList">Creating a new panel for the circuit breaker metric</li>
      <li class="bulletList">Creating a new panel for the retry metric</li>
      <li class="bulletList">Arranging the panels</li>
    </ul>
    <h4 class="heading-4">Creating an empty dashboard</h4>
    <p class="normal">Perform the following steps to<a id="_idIndexMarker1505"/> create an empty dashboard:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">On the Grafana web page, hover the mouse over the <strong class="screenText">Dashboard</strong> icon (four squares) in the menu to the left. Select <strong class="screenText">+ New Dashboard</strong> from the menu that pops up. A web page named <strong class="screenText">New dashboard</strong> will be displayed: </li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_09.png" alt="A screenshot of a phone  Description automatically generated with low confidence" width="812" height="115"/></figure>
    <p class="packt_figref">Figure 20.9: Creating a new dashboard in Grafana</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Click on the Dashboard settings button (it has a gear as its icon), in the menu shown in<a id="_idIndexMarker1506"/> the preceding screenshot. Then, follow these steps:<ol class="alphabeticList" style="list-style-type: lower-alpha;">
          <li class="alphabeticList" value="1">Specify the name of the dashboard in the <strong class="screenText">Name</strong> field and set the value to <code class="inlineCode">Hands-on Dashboard</code>.</li>
          <li class="alphabeticList">Click on the top-left back button on the web page (not to be mixed up with the web browser’s back button).</li>
        </ol>
      </li>
      <li class="numberedList">Click on the time picker and select <strong class="screenText">Last 5 minutes</strong> as the range.</li>
      <li class="numberedList">Click on the refresh rate icon to the right and specify <strong class="screenText">5s</strong> as the refresh rate.</li>
    </ol>
    <h4 class="heading-4">Creating a new panel for the circuit breaker metric</h4>
    <p class="normal">Perform the following<a id="_idIndexMarker1507"/> steps to create a new panel for the circuit breaker metric:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <strong class="screenText">Add panel</strong> section, click on the <strong class="screenText">Add a new panel</strong> button.</li>
    </ol>
    <p class="normal">A page will be displayed where the new panel can be configured.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">In the tab to the right, set the <strong class="screenText">Panel title</strong> to <code class="inlineCode">Circuit Breaker</code>.</li>
      <li class="numberedList">Also in the tab to the right, set the <strong class="screenText">Tooltip mode</strong> to <strong class="screenText">All</strong>.</li>
      <li class="numberedList">In the bottom-left <strong class="screenText">Query</strong> panel, under the letter <strong class="screenText">A</strong>, specify the query as the name of the circuit breaker metric for the <strong class="screenText">closed</strong> state, as follows:<ol class="alphabeticList" style="list-style-type: lower-alpha;">
          <li class="alphabeticList" value="1">Set <strong class="screenText">Metric</strong> to <code class="inlineCode">resilience4j_circuitbreaker_state</code>.</li>
          <li class="alphabeticList">Set <strong class="screenText">Label</strong> to <strong class="screenText">state</strong> and specify that it shall be equal to <strong class="screenText">closed</strong>.</li>
          <li class="alphabeticList">Verify that the <strong class="screenText">Raw query</strong> is set to <code class="inlineCode">resilience4j_circuitbreaker_state{state="closed"}</code>.</li>
        </ol>
      </li>
      <li class="numberedList">Expand the <strong class="screenText">Options</strong> tab, and in the <strong class="screenText">Legend</strong> drop-down box, select <strong class="screenText">Custom</strong>. In the <strong class="screenText">Legend</strong> field, specify the value <code class="inlineCode">{{state}}</code>. This will create a legend in the panel where the names of the different states are displayed. <p class="normal">The filled-in <a id="_idIndexMarker1508"/>values should look as follows:</p>
      </li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_10.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="759" height="371"/></figure>
    <p class="packt_figref">Figure 20.10: Specifying circuit breaker metrics in Grafana</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Click on the <strong class="screenText">+ Query</strong> button at the bottom of the page to enter a new query under <strong class="screenText">B</strong> for the <strong class="screenText">open</strong> state. Repeat the steps for query <strong class="screenText">A</strong>, but set the state’s value to <strong class="screenText">open</strong>. Verify that the <strong class="screenText">Raw query</strong> field is set to <code class="inlineCode">resilience4j_circuitbreaker_state{state="open"}</code> and set the <strong class="screenText">Legend</strong> field to <code class="inlineCode">{{state}}</code>.</li>
      <li class="numberedList">Click on the <strong class="screenText">+ Query</strong> button a final time to enter a new query under <strong class="screenText">C</strong> for the <strong class="screenText">half_open</strong> state. Set the state’s value to <code class="inlineCode">half_open</code>, and verify that the <strong class="screenText">Raw query</strong> field is set to <code class="inlineCode">resilience4j_circuitbreaker_state{state="half_open"}</code> and set the <strong class="screenText">Legend</strong> field to <code class="inlineCode">{{state}}</code>.</li>
      <li class="numberedList">Click on the back button at the top left of the page to get back to the dashboard.</li>
    </ol>
    <h4 class="heading-4">Creating a new panel for the retry metric</h4>
    <p class="normal">Here, we will repeat the same procedure that we went through to add a panel for the preceding <a id="_idIndexMarker1509"/>circuit breaker metric, but instead, we will specify the values for the retry metrics:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a new panel by clicking on the <strong class="screenText">Add panel</strong> icon (a chart with a plus sign) in the top-level menu, and click on <strong class="screenText">Add a new panel </strong>in the new panel.</li>
      <li class="numberedList">Specify <code class="inlineCode">Retry</code> as the <strong class="screenText">Panel title</strong>, and the <strong class="screenText">Tooltip mode</strong> as <strong class="screenText">All</strong> in the same way as for the previous panel.</li>
      <li class="numberedList">Set <strong class="screenText">Metric</strong> to <code class="inlineCode">resilience4j_retry_calls_total</code>.</li>
      <li class="numberedList">Since the retry metric is a counter, its value will only go up. An ever-increasing metric is rather uninteresting to monitor. Therefore, a <strong class="keyWord">rate</strong> function is used to convert the retry metric into a rate-per-second metric. The time window specified, that is, <code class="inlineCode">30s</code>, is used by the rate function to calculate the average values of the rate. To apply the rate function:<ol class="alphabeticList" style="list-style-type: lower-alpha;">
          <li class="alphabeticList" value="1">Click on the <strong class="screenText">+ Operations</strong> button.</li>
          <li class="alphabeticList">Click on <strong class="screenText">Range functions</strong> and select the <strong class="screenText">Rate</strong> function.</li>
          <li class="alphabeticList">Set the <strong class="screenText">Range</strong> to <strong class="screenText">30s</strong>.</li>
        </ol>
      </li>
      <li class="numberedList">In the <strong class="screenText">Raw query</strong> field, verify that it is set to <code class="inlineCode">rate(resilience4j_retry_calls_total[30s])</code>.</li>
      <li class="numberedList">Expand the <strong class="screenText">Options</strong> tab, and in the <strong class="screenText">Legend</strong> drop-down box, select <strong class="screenText">Custom</strong>. In the <strong class="screenText">Legend</strong> field, specify the value <code class="inlineCode">{{kind}}</code>. This will create a legend in the panel where the names of the different kinds of retries are displayed.</li>
      <li class="numberedList">Note that Grafana immediately starts to render a graph in the panel editor based on the specified values.</li>
      <li class="numberedList">Click on the back button to get back to the dashboard.</li>
    </ol>
    <h4 class="heading-4">Arranging the panels</h4>
    <p class="normal">Perform the following<a id="_idIndexMarker1510"/> steps to arrange the panels on the dashboard:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">You can resize a panel by dragging its lower right-hand corner to the preferred size.</li>
      <li class="numberedList">You can also move a panel by dragging its header to the desired position.</li>
    </ol>
    <p class="normal">The following is an example layout of the two panels:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_11.png" alt="A screenshot of a computer  Description automatically generated" width="452" height="618"/></figure>
    <p class="packt_figref">Figure 20.11: Moving and resizing a panel in Grafana</p>
    <p class="normal">Since this screenshot was taken with Siege running in the background, the <strong class="screenText">Retry</strong> panel reports <code class="inlineCode">successful_without_retry</code> metrics, while the <strong class="screenText">Circuit Breaker</strong> reports that <strong class="screenText">closed</strong><strong class="keyWord"> </strong>equals<strong class="keyWord"> </strong><strong class="screenText">1</strong> and <strong class="screenText">open</strong> and <strong class="screenText">half_open</strong><strong class="keyWord"> </strong>equal<strong class="keyWord"> </strong><strong class="screenText">0</strong>, meaning that it is closed and operating normally (something that is about to<a id="_idIndexMarker1511"/> change in the next section).</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Finally, click on the <strong class="screenText">Save</strong> button at the top of the page. A <strong class="screenText">Save dashboard as...</strong> dialog will show up; ensure that the name is <strong class="screenText">Hands-on Dashboard</strong> and hit the <strong class="screenText">Save</strong> button.</li>
    </ol>
    <div class="packt_tip">
      <p class="normal">If you get stuck when configuring the dashboard, take a look at the end of the <em class="italic">Trying out the circuit breaker alarm</em> section. There is an easy solution described.</p>
    </div>
    <p class="normal">With the dashboard created, we are ready to try it out. In the next section, we will try out both<a id="_idIndexMarker1512"/> metrics.</p>
    <h3 id="_idParaDest-510" class="heading-3">Trying out the new dashboard</h3>
    <p class="normal">Before we start testing<a id="_idIndexMarker1513"/> the new dashboard, we must stop the load test tool, Siege. To do this, go to the command window where Siege is running and press <strong class="keyWord">Ctrl + C</strong> to stop it.</p>
    <p class="normal">Let’s start by testing how to monitor the circuit breaker. Afterward, we will try out the retry metrics.</p>
    <h4 class="heading-4">Testing the circuit breaker metrics</h4>
    <p class="normal">If we force the<a id="_idIndexMarker1514"/> circuit breaker to open up, its state will change from <strong class="screenText">closed</strong> to <strong class="screenText">open</strong>, and then eventually to the <strong class="screenText">half-open</strong> state. This should be reported in the circuit breaker panel.</p>
    <p class="normal">Open the circuit, just like we did in <em class="chapterRef">Chapter 13</em>, <em class="italic">Improving Resilience Using Resilience4j</em>, in the <em class="italic">Trying out the circuit breaker and retry mechanism</em> section – that is, make some requests to the API in a row, all of which will fail. Run the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con">ACCESS_TOKEN=$(curl https://writer:secret-writer@minikube.me/oauth2/token -d grant_type=client_credentials -d scope="product:read product:write" -ks | jq .access_token -r)
echo ACCESS_TOKEN=$ACCESS_TOKEN
for ((n=0; n&lt;4; n++)); do curl -o /dev/null -skL -w "%{http_code}\n" https://minikube.me/product-composite/1?delay=3 -H "Authorization: Bearer $ACCESS_TOKEN" -s; done
</code></pre>
    <p class="normal">We can expect three <code class="inlineCode">500</code> responses and a final <code class="inlineCode">200</code>, indicating three errors in a row, which is what it takes to open the circuit breaker. The last <code class="inlineCode">200</code> indicates a <strong class="keyWord">fail-fast</strong> response from the <code class="inlineCode">product-composite</code> microservice when it detects that the circuit is open.</p>
    <div class="packt_tip">
      <p class="normal">On some rare occasions, I have noticed that the circuit breaker metrics are not reported in Grafana directly after the dashboard is created. If they don’t show up after a minute, simply rerun the preceding command to reopen the circuit breaker again.</p>
    </div>
    <p class="normal">Expect the value for the <strong class="screenText">closed</strong> state to drop to <strong class="screenText">0</strong> and the <strong class="screenText">open</strong> state to take the value <strong class="screenText">1</strong>, meaning that the circuit is now open. After 10s, the circuit will turn to the half-open state, indicated by the <strong class="screenText">half-open</strong> metrics having the value <strong class="screenText">1</strong> and <strong class="screenText">open</strong> being set to <strong class="screenText">0</strong>. This means that the circuit breaker is ready to test some requests to see if the <a id="_idIndexMarker1515"/>problem that opened the circuit is gone.</p>
    <p class="normal">Close the circuit breaker again by issuing three successful requests to the API with the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">for ((n=0; n&lt;4; n++)); do curl -o /dev/null -skL -w "%{http_code}\n" https://minikube.me/product-composite/1?delay=0 -H "Authorization: Bearer $ACCESS_TOKEN" -s; done
</code></pre>
    <p class="normal">We will get only <code class="inlineCode">200</code> responses. Note that the circuit breaker metric goes back to normal again, meaning that the <strong class="screenText">closed</strong> metric goes back to <strong class="screenText">1</strong>.</p>
    <p class="normal">After this test, the Grafana dashboard should look as follows:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_12.png" alt="A screenshot of a computer  Description automatically generated with low confidence" width="441" height="613"/></figure>
    <p class="packt_figref">Figure 20.12: Retries and Circuit Breaker in action as viewed in Grafana</p>
    <p class="normal">From the preceding screenshot, we can see that the retry mechanism also reports metrics that succeeded and failed. When the circuit was opened, all requests failed without<a id="_idIndexMarker1516"/> retries. When the circuit was closed, all requests were successful without any retries. This is as expected.</p>
    <p class="normal">Now that we have seen the circuit breaker metrics in action, let’s see the retry metrics in action!</p>
    <div class="packt_tip">
      <p class="normal">If you want to check the state of the circuit breaker, you can do it with the following command:</p>
      <pre class="programlisting con"><code class="hljs-con">curl -ks https://health.minikube.me/actuator/health | jq -r .components.circuitBreakers.details.product.details.state
</code></pre>
      <p class="normal">It should report <code class="inlineCode">CLOSED</code>, <code class="inlineCode">OPEN</code>, or <code class="inlineCode">HALF_OPEN</code>, depending on its state.</p>
    </div>
    <h4 class="heading-4">Testing the retry metrics</h4>
    <p class="normal">To trigger the retry <a id="_idIndexMarker1517"/>mechanism, we will use the <code class="inlineCode">faultPercentage</code> parameter we used in previous chapters. To avoid triggering the circuit breaker, we need to use relatively low values for the parameter. Run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">while true; do curl -o /dev/null -s -L -w "%{http_code}\n" -H "Authorization: Bearer $ACCESS_TOKEN" -k https://minikube.me/product-composite/1?faultPercent=10; sleep 3; done
</code></pre>
    <p class="normal">This command will call the API once every third second. It specifies that 10% of the requests should fail so that the retry mechanism will kick in and retry the failed requests.</p>
    <p class="normal">After a few minutes, the dashboard should report metrics such as the following:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_13.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="521" height="718"/></figure>
    <p class="packt_figref">Figure 20.13: Result of retry tests viewed in Grafana</p>
    <p class="normal">In the preceding screenshot, we can see that most of the requests have been executed successfully, without any retries. Approximately 10% of the requests have been retried by the<a id="_idIndexMarker1518"/> retry mechanism and successfully executed after the retry.</p>
    <p class="normal">Before we leave the section on creating dashboards, we will learn how we can export and import dashboards.</p>
    <h2 id="_idParaDest-511" class="heading-2">Exporting and importing Grafana dashboards</h2>
    <p class="normal">Once a dashboard has <a id="_idIndexMarker1519"/>been created, we typically want to take two actions:</p>
    <ul>
      <li class="bulletList">Save the definition of the dashboard as source code in a Git repo</li>
      <li class="bulletList">Move the dashboard to other Grafana instances, for example, those used in QA and production environments</li>
    </ul>
    <p class="normal">To perform these actions, we can use Grafana’s API for exporting and importing dashboards. Since<a id="_idIndexMarker1520"/> we only have one Grafana instance, we<a id="_idIndexMarker1521"/> will perform the following steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Export the dashboard to a JSON file.</li>
      <li class="numberedList">Delete the dashboard.</li>
      <li class="numberedList">Import the dashboard from the JSON file.</li>
    </ol>
    <p class="normal">Before we perform these steps, we need to understand the two different types of IDs that a dashboard has:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">id</code>, an auto-incremented identifier that is unique only within a Grafana instance.</li>
      <li class="bulletList"><code class="inlineCode">uid</code>, a unique identifier that can be used in multiple Grafana instances. It is part of the URL when accessing dashboards, meaning that links to a dashboard will stay the same as long as the <code class="inlineCode">uid</code> of a dashboard remains the same. When a dashboard is created, a random <code class="inlineCode">uid</code> is created by Grafana.</li>
    </ul>
    <p class="normal">When we import a dashboard, Grafana will try to update it if the <code class="inlineCode">id</code> field is set. To be able to test importing a dashboard in a Grafana instance that doesn’t have the dashboard already installed, we need to set the <code class="inlineCode">id</code> field to <code class="inlineCode">null</code>.</p>
    <p class="normal">Perform the following actions to export and then import your dashboard:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Identify the <code class="inlineCode">uid</code> of your dashboard.</li>
    </ol>
    <p class="normal">The <code class="inlineCode">uid</code> value can be found in the URL in the web browser where the dashboard is shown. It will look like this:</p>
    <pre class="programlisting code"><code class="hljs-code"><a href="https://grafana.minikube.me/d/YMcDoBg7k/hands-on-dashboard"><span class="url">https://grafana.minikube.me/d/YMcDoBg7k/hands-on-dashboard</span></a>
</code></pre>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">The <code class="inlineCode">uid</code> in the URL above is <code class="inlineCode">YMcDoBg7k</code>. In a terminal window, create a variable with its value. In my case, it will be:</li>
    </ol>
    <pre class="programlisting gen"><code class="hljs"><code class="inlineCode">ID=YMcDoBg7k</code>
</code></pre>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Export the dashboard to a JSON file with the following command:
        <pre class="programlisting con"><code class="hljs-con">curl -sk https://grafana.minikube.me/api/dashboards/uid/$ID | jq '.dashboard.id=null' &gt; "Hands-on-Dashboard.json"
</code></pre>
      </li>
    </ol>
    <p class="normal">The <code class="inlineCode">curl</code> command exports the dashboard to the JSON format. The <code class="inlineCode">jq</code> statement sets the <code class="inlineCode">id</code> field to <code class="inlineCode">null</code>, and the output from the <code class="inlineCode">jq</code> command is written to a file named <code class="inlineCode">Hands-on-Dashboard.json</code>.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Delete the dashboard.</li>
    </ol>
    <p class="normal">In the web browser, select <strong class="screenText">Dashboards</strong> and <strong class="screenText">Browse</strong> in the menu to the left. Identify the <strong class="screenText">Hands-on Dashboard</strong> in the list of dashboards and select it by clicking on the checkbox<a id="_idIndexMarker1522"/> in front of it. A red <strong class="screenText">Delete</strong> button will<a id="_idIndexMarker1523"/> be shown; click on it, and then click on the new <strong class="screenText">Delete</strong> button that is shown in the confirm dialog box that pops up.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Recreate the dashboard by importing it from the JSON file with the following command:
        <pre class="programlisting con"><code class="hljs-con">curl -i -XPOST -H 'Accept: application/json' -H 'Content-Type: application/json' -k \
    'https://grafana.minikube.me/api/dashboards/db' \
    -d @Hands-on-Dashboard.json
</code></pre>
      </li>
    </ol>
    <p class="normal">Note that the URL used to access the dashboard is still valid, in my case, <a href="https://grafana.minikube.me/d/YMcDoBg7k/hands-on-dashboard"><span class="url">https://grafana.minikube.me/d/YMcDoBg7k/hands-on-dashboard</span></a>.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Verify that the imported dashboard reports metrics in the same way as before it was deleted and re-imported. Since the request loop started in the <em class="italic">Testing the retry metrics</em> section is still running, the same metrics from that section should be reported.</li>
    </ol>
    <div class="packt_tip">
      <p class="normal">For more information regarding Grafana’s APIs, see <a href="https://grafana.com/docs/grafana/v9.0/developers/http_api/dashboard/#get-dashboard-by-uid"><span class="url">https://grafana.com/docs/grafana/v9.0/developers/http_api/dashboard/#get-dashboard-by-uid</span></a>.</p>
    </div>
    <p class="normal">Before proceeding to the next section, remember to stop the request loop that we started for the retry test by pressing <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> in the terminal window where the request loop executes!</p>
    <p class="normal">In the next section, we will learn how to set up alarms in Grafana, based on these metrics.</p>
    <h1 id="_idParaDest-512" class="heading-1">Setting up alarms in Grafana</h1>
    <p class="normal">Being able to monitor the circuit breaker and retry metrics is of great value, but even more important is the <a id="_idIndexMarker1524"/>capability to define automated alarms on these metrics. Automated alarms relieve us from monitoring the <a id="_idIndexMarker1525"/>metrics manually.</p>
    <p class="normal">Grafana comes with built-in support to define alarms and send notifications to a number of channels. In this section, we will define alerts on the circuit breaker and configure Grafana to send emails to the test mail server when alerts are raised. The local test mail server was installed earlier in the <em class="italic">Installing a local mail server for tests</em> section.</p>
    <div class="packt_tip">
      <p class="normal">For other types of channels supported by the version of Grafana used in this chapter, see <a href="https://grafana.com/docs/grafana/v7.2/alerting/notifications/#list-of-supported-notifiers"><span class="url">https://grafana.com/docs/grafana/v7.2/alerting/notifications/#list-of-supported-notifiers</span></a>.</p>
    </div>
    <p class="normal">In the next section, we will define a mail-based notification channel that will be used by the alert in the section after this.</p>
    <h2 id="_idParaDest-513" class="heading-2">Setting up a mail-based notification channel</h2>
    <p class="normal">To configure a <a id="_idIndexMarker1526"/>mail-based notification channel in Grafana, perform the following steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">On the Grafana web page, on the menu to the left, click on the Alerting<strong class="screenText"> </strong>menu choice (with an alarm bell as its icon) and select <strong class="screenText">Notification channels</strong>.</li>
      <li class="numberedList">Click on the <strong class="screenText">Add channel</strong> button.</li>
      <li class="numberedList">Set the name to <code class="inlineCode">mail</code>.</li>
      <li class="numberedList">Select the type as <strong class="screenText">Email</strong>.</li>
      <li class="numberedList">Enter an email address of your choice. Emails will only be sent to the local test mail server, independent of the email address that’s specified.</li>
      <li class="numberedList">Expand <strong class="screenText">Notification settings</strong> and select <strong class="screenText">Default (Use this notification for all alerts)</strong>.</li>
    </ol>
    <p class="normal">The configuration of the notification channel should look as follows:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_14.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="812" height="1025"/></figure>
    <p class="packt_figref">Figure 20.14: Setting up an email-based notification channel</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Click on the <strong class="screenText">Test</strong> button<a id="_idIndexMarker1527"/> to send a test mail.</li>
      <li class="numberedList">Click on the <strong class="screenText">Save</strong> button.</li>
      <li class="numberedList">Click on the <strong class="screenText">Dashboard</strong> button in the left-hand side menu and then on the <strong class="keyWord">Browse</strong> menu entry.</li>
      <li class="numberedList">Select <strong class="screenText">Hands-on Dashboard</strong> from the list to get back to the dashboard.</li>
      <li class="numberedList">Check the test mail server’s web page to ensure that we have received a test email. You should receive the following:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_15.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="812" height="453"/></figure>
    <p class="packt_figref">Figure 20.15: Verifying the test mail on the mail server’s web page</p>
    <p class="normal">With a notification<a id="_idIndexMarker1528"/> channel in place, we are ready to define an alert on the circuit breaker.</p>
    <h2 id="_idParaDest-514" class="heading-2">Setting up an alarm on the circuit breaker</h2>
    <p class="normal">To create an alarm on <a id="_idIndexMarker1529"/>the circuit breaker, we need to create the alert and then add an alert list to the dashboard, where we can see what alert events have occurred over time.</p>
    <p class="normal">Perform the following steps to create an alert for the circuit breaker:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <strong class="screenText">Hands-on Dashboard</strong>, click on the header of the <strong class="screenText">Circuit Breaker</strong> panel. A drop-down menu will appear.</li>
      <li class="numberedList">Select the <strong class="screenText">Edit</strong> menu option.</li>
      <li class="numberedList">Select the <strong class="screenText">Alert</strong> tab in the tab list (shown as an alarm bell icon).</li>
      <li class="numberedList">Click on the <strong class="screenText">Create Alert</strong> button.</li>
      <li class="numberedList">In the <strong class="screenText">Evaluate every</strong> field, set the value to <code class="inlineCode">10s</code>.</li>
      <li class="numberedList">In the <strong class="screenText">For</strong> field, set the value to <code class="inlineCode">0m</code>.</li>
      <li class="numberedList">In the <strong class="screenText">Conditions</strong> section, specify the following values:<ul>
          <li class="bulletList">For the <strong class="screenText">WHEN</strong> field, select <code class="inlineCode">max()</code></li>
          <li class="bulletList">Set the <strong class="screenText">OF</strong> field to <code class="inlineCode">query(A, 10s, now)</code></li>
          <li class="bulletList">Change <strong class="screenText">IS ABOVE</strong> to <strong class="screenText">IS BELOW</strong>, and set its value to <code class="inlineCode">0.5</code></li>
        </ul>
      </li>
    </ol>
    <p class="normal">These settings will result in an alert being raised if the <strong class="screenText">closed</strong> state (related to the <code class="inlineCode">A</code> variable) goes below 0.5 during the last 10 seconds. When the circuit breaker is closed, this variable has the value 1, and 0 otherwise. So, this means that an alert is raised when the circuit breaker is no longer closed.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Scroll down to the <strong class="screenText">Notifications</strong> section to confirm that the notification will be sent to the default notification channel, that is, the mail channel we defined <a id="_idIndexMarker1530"/>previously. The alarm definition should look as follows:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_16.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="812" height="306"/></figure>
    <p class="packt_figref">Figure 20.16: Setting up an alarm in Grafana, part 1</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Click on the <strong class="screenText">Save</strong> button (top-right), enter a note like <code class="inlineCode">Added an alarm</code>, and then click on the <strong class="screenText">Save</strong> button.</li>
      <li class="numberedList">Click on the back button (left arrow) to get back to the dashboard.</li>
    </ol>
    <p class="normal">Then, we need to perform the following steps to create an alarm list:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Click on the <strong class="screenText">Add panel</strong> button in the top-level menu.</li>
      <li class="numberedList">Click on the <strong class="screenText">Add new panel</strong> button in the new panel.</li>
      <li class="numberedList">In the top-right corner, click on the <strong class="screenText">Time series</strong> drop-down button and select the <strong class="screenText">Alert list</strong> option.</li>
      <li class="numberedList">In the tab to the right, do the following:<ol class="alphabeticList" style="list-style-type: lower-alpha;">
          <li class="alphabeticList" value="1">Enter <code class="inlineCode">Circuit Breaker Alerts</code> as the <strong class="screenText">Panel title</strong>.</li>
          <li class="alphabeticList">In the <strong class="screenText">Option</strong> section, set the <strong class="screenText">Show</strong> field to the value <strong class="screenText">Recent state changes</strong>.</li>
          <li class="alphabeticList">Finally, enable the toggle switch named <strong class="screenText">Alerts from this dashboard</strong>.</li>
        </ol>
      </li>
      <li class="numberedList">Expand the <strong class="screenText">Visualization</strong> row below the <strong class="screenText">Settings</strong> row and select <strong class="screenText">Alert list</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Panel</strong> <strong class="screenText">options</strong> row below, set<a id="_idIndexMarker1531"/> the <strong class="screenText">Show</strong> field to <strong class="screenText">Recent state changes</strong>, set <strong class="screenText">Max items </strong>to <code class="inlineCode">10</code>, and enable the option <strong class="screenText">Alerts from this dashboard</strong>.</li>
    </ol>
    <p class="normal">The settings should look as follows:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_17.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="452" height="865"/></figure>
    <p class="packt_figref">Figure 20.17: Setting up an alarm in Grafana, part 2</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Click on the back button to get back to the dashboard.</li>
      <li class="numberedList">Rearrange the panel to suit your needs.</li>
      <li class="numberedList">Save the <a id="_idIndexMarker1532"/>changes to the dashboard with a note like <code class="inlineCode">Added an alert list</code>.</li>
    </ol>
    <p class="normal">Here is a sample layout with the alarm list added:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_18.png" alt="A screenshot of a device  Description automatically generated with medium confidence" width="479" height="891"/></figure>
    <p class="packt_figref">Figure 20.18: Setting up a layout in Grafana with Retry, Circuit Breaker, and alert panels</p>
    <p class="normal">We can see that the circuit breaker reports the metrics as healthy (with a green heart icon) and <a id="_idIndexMarker1533"/>that the alert list is currently empty.</p>
    <p class="normal">Now, it’s time to try out the alarm!</p>
    <h2 id="_idParaDest-515" class="heading-2">Trying out the circuit breaker alarm</h2>
    <p class="normal">Here, we will repeat the tests from the <em class="italic">Testing the circuit breaker metrics</em> section, but this<a id="_idIndexMarker1534"/> time, we expect alarms to be raised and emails to be sent as well! Let’s get started:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Acquire a new access token, if required (valid for 1 hour):
        <pre class="programlisting con"><code class="hljs-con">ACCESS_TOKEN=$(curl https://writer:secret-writer@minikube.me/oauth2/token -d grant_type=client_credentials -d scope="product:read product:write" -ks | jq .access_token -r)
echo ACCESS_TOKEN=$ACCESS_TOKEN
</code></pre>
      </li>
      <li class="numberedList">Open the circuit breaker as we did before:
        <pre class="programlisting con"><code class="hljs-con">for ((n=0; n&lt;4; n++)); do curl -o /dev/null -skL -w "%{http_code}\n" https://minikube.me/product-composite/1?delay=3 -H "Authorization: Bearer $ACCESS_TOKEN" -s; done
</code></pre>
      </li>
    </ol>
    <p class="normal">The dashboard should report the circuit as open as it did previously. After a few seconds, an alarm should be raised, and an email is also sent. Expect the dashboard to look like the following screenshot (you might need to refresh the web page to make the alert show up):</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_19.png" alt="A screenshot of a device  Description automatically generated with low confidence" width="426" height="612"/></figure>
    <p class="packt_figref">Figure 20.19: Alarm raised in Grafana</p>
    <p class="normal">Take note of the alarm icon in the header of the circuit breaker panel (a red broken<a id="_idIndexMarker1535"/> heart). The red line marks the time of the alert event and that an alert has been added to the alert list.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In the test mail server, you should see an email, as shown in the following screenshot:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_20.png" alt="A screenshot of a computer  Description automatically generated" width="812" height="568"/></figure>
    <p class="packt_figref">Figure 20.20: Alarm email</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Great! We got alarms, just like we expected! Now, close the circuit with the following <a id="_idIndexMarker1536"/>command, simulating that the problem is gone:
        <pre class="programlisting con"><code class="hljs-con">for ((n=0; n&lt;4; n++)); do curl -o /dev/null -skL -w "%{http_code}\n" https://minikube.me/product-composite/1?delay=0 -H "Authorization: Bearer $ACCESS_TOKEN" -s; done
</code></pre>
      </li>
    </ol>
    <p class="normal">The <strong class="screenText">closed</strong> metric should go back to normal, that is, <strong class="screenText">1</strong>, and the alert should turn green again.</p>
    <p class="normal">Expect the dashboard to look like the following screenshot:</p>
    <figure class="mediaobject"><img src="../Images/B19825_20_21.png" alt="A screenshot of a device  Description automatically generated with low confidence" width="556" height="842"/></figure>
    <p class="packt_figref">Figure 20.21: Error resolved as reported in Grafana</p>
    <p class="normal">Note that the<a id="_idIndexMarker1537"/> alarm icon in the header of the circuit breaker panel is green again; the green line marks the time of the <strong class="screenText">OK</strong> event and that it has been added to the alert list.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">In the test mail server, you should see an email, as shown in the following screenshot:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_22.png" alt="A screenshot of a computer  Description automatically generated with medium confidence" width="812" height="463"/></figure>
    <p class="packt_figref">Figure 20.22: Error resolved as reported in an email</p>
    <p class="normal">That completes how<a id="_idIndexMarker1538"/> to monitor microservices using Prometheus and Grafana.</p>
    <div class="packt_tip">
      <p class="normal">If you want to export the configuration of the mail notification, you can do that with the following command:</p>
      <pre class="programlisting con"><code class="hljs-con">curl https://grafana.minikube.me/api/alert-notifications/1 -ks | jq '.id=null' &gt; mail-notification.jso
</code></pre>
      <p class="normal">To import it, the following command can be used:</p>
      <pre class="programlisting con"><code class="hljs-con">curl -ik -XPOST -H 'Accept: application/json' \
  -H 'Content-Type: application/json' \
  'https://grafana.minikube.me/api/alert-notifications' \
  -d @mail-notification.json
</code></pre>
      <p class="normal">For your convenience, the folder <code class="inlineCode">$BOOK_HOME/Chapter20/kubernetes/grafana/api-export-import</code> contains export files for both the mail notifier and the dashboard that we learned how to export and import in the <em class="italic">Exporting and importing Grafana dashboards</em> section.</p>
    </div>
    <h1 id="_idParaDest-516" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, we learned how to use Prometheus and Grafana to collect and monitor alerts on performance metrics.</p>
    <p class="normal">We saw that, to collect performance metrics, we can use Prometheus in a Kubernetes environment. We then learned how Prometheus can automatically collect metrics from a Pod when a few Prometheus annotations are added to the Pod’s definition. To produce metrics in our microservices, we used Micrometer.</p>
    <p class="normal">Then, we saw how we can monitor the collected metrics using dashboards in both Kiali and Grafana, which comes with the installation of Istio. We also experienced how to consume dashboards shared by the Grafana community, and learned how to develop our own dashboards, where we used metrics from Resilience4j to monitor the usage of its circuit breaker and retry mechanisms. Using the Grafana API, we can export created dashboards and import them into other Grafana instances.</p>
    <p class="normal">Finally, we learned how to define alerts on metrics in Grafana and how to use Grafana to send out alert notifications. We used a local test mail server to receive alert notifications from Grafana as emails.</p>
    <p class="normal">The next two chapters should already be familiar to you, covering the installation of tools on a Mac or Windows PC. Instead, head over to the last chapter in this book, which will introduce how we can compile our Java-based microservices into binary executable files using the brand-new <strong class="keyWord">Spring Native</strong> project, still in beta at the time of writing. This will enable the microservices to start up in a fraction of a second, but increased complexity and time are involved when it comes to building them.</p>
    <h1 id="_idParaDest-517" class="heading-1">Questions</h1>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What changes did we need to make to the source code in the microservices to make them produce metrics that are consumed by Prometheus?</li>
      <li class="numberedList">What is the <code class="inlineCode">management.metrics.tags.application</code> config parameter used for?</li>
      <li class="numberedList">If you want to analyze a support case regarding high CPU consumption, which of the dashboards in this chapter would you start with?</li>
      <li class="numberedList">If you want to analyze a support case regarding slow API responses, which of the dashboards in this chapter would you start with?</li>
      <li class="numberedList">What is the problem with counter-based metrics such as Resilience4j’s retry metrics, and what can be done so that we can monitor them in a useful way?</li>
      <li class="numberedList">What is going on here?</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_20_23.png" alt="" role="presentation" width="668" height="839"/></figure>
    <p class="packt_figref">Figure 20.23: What is going on here?</p>
    <p class="normal">If you are reading this with screenshots rendered in grayscale, it might be hard to figure out what the metrics say. So, here’s some help:</p>
    <ol class="alphabeticList" style="list-style-type: lower-alpha;">
      <li class="alphabeticList" value="1">The state transitions reported by the circuit breaker are, in order:<ol class="numberedList" style="list-style-type: decimal;">
          <li class="numberedList" value="1"><strong class="screenText">half_open </strong>→ <strong class="screenText">open</strong></li>
          <li class="numberedList"><strong class="screenText">open</strong> → <strong class="screenText">half_open</strong></li>
          <li class="numberedList"><strong class="screenText">half_open</strong> → <strong class="screenText">closed</strong></li>
        </ol>
      </li>
      <li class="alphabeticList">The retry mechanism reports:<ol class="numberedList" style="list-style-type: decimal;">
          <li class="numberedList" value="1">An initial burst of requests, where most of them are reported as <strong class="screenText">failed_without_retry</strong> and a few are reported as <strong class="screenText">successful_without_retry</strong>.</li>
          <li class="numberedList">A second burst of requests, all reported as <strong class="screenText">successful_without_retry</strong>.</li>
        </ol>
      </li>
    </ol>
    <h1 id="_idParaDest-518" class="heading-1">Join our community on Discord</h1>
    <p class="normal">Join our community’s Discord space for discussion with the author and other readers:</p>
    <p class="normal"><a href="https://packt.link/SpringBoot3e"><span class="url">https://packt.link/SpringBoot3e</span></a></p>
    <p class="normal"><img src="../Images/QR_Code1849216352344398875.png" alt="" role="presentation" width="177" height="177"/></p>
  </div>
</div>
</div>
</body></html>