<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Command Line Flags</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In the previous chapter, we looked a<span class="calibre7">t several security changes to the JDK. Java 9's security enhancements provide developers with the ability to write and maintain applications that implement security. Specifically, we covered d</span>atagram transport layer security, Keystores, improving security application performance, the TLS application-layer protocol negotiation extension, leveraging CPU instructions for GHASH and RSA, OCSP stapling for TLS, and DRBG-based <kbd class="calibre16">SecureRandom</kbd> implementations.</p>
<p class="mce-root">In this chapter, we will explore several changes to the Java 9 platform with the common theme of command-line flags. Specifically, we will cover the following concepts:</p>
<ul class="calibre13">
<li class="calibre14">Unified JVM logging</li>
<li class="calibre14">Compiler control</li>
<li class="calibre14">Diagnostic commands</li>
<li class="calibre14">Heap profiling agent</li>
<li class="calibre14">Removing your JHAT</li>
<li class="calibre14">Command-line flag argument validation</li>
<li class="calibre14">Compiling for older platform versions</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Unified JVM Logging [JEP 158]</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Creating a unified logging schema for the JVM was the central goal of JEP-158. Here is a comprehensive list of the goals of the JEP:</p>
<ul class="calibre13">
<li class="calibre14">Create a JVM-wide set of command-line options for all logging operations</li>
<li class="calibre14">Use categorized tags for logging</li>
<li class="calibre14">Permit messages to have multiple tags, also referred to as tag sets</li>
<li class="calibre14">Provide six levels of logging:
<ul class="calibre13">
<li class="calibre14">Error</li>
<li class="calibre14">Warning</li>
<li class="calibre14">Information</li>
<li class="calibre14">Debug</li>
<li class="calibre14">Trace</li>
<li class="calibre14">Develop</li>
</ul>
</li>
<li class="calibre14">Select which messages are logged based on levels</li>
<li class="calibre14">Optionally direct logging to the console or a file
<ul class="calibre13">
<li class="calibre14">Print one line at a time and do not support interleaving within the same line</li>
</ul>
</li>
<li class="calibre14">Permit output of multiple line logs (non-interleaved)</li>
<li class="calibre14">Format all logging messages so that they are easily human-read</li>
<li class="calibre14">Add decorations such as uptime, level, and tags</li>
<li class="calibre14">Like levels, select which messages are logged based on decorations</li>
<li class="calibre14">Convert pre-Java 9 <kbd class="calibre16">tty&gt;print</kbd> logging to use unified logging as the output</li>
<li class="calibre14">Permit dynamic message configuration using <kbd class="calibre16">jcmd</kbd> and <kbd class="calibre16">MBeans</kbd></li>
<li class="calibre14">Permit the ability to enable and disable individual log messages</li>
<li class="calibre14">Add ability to determine the order in which decorations are printed</li>
</ul>
<p class="mce-root">The unified logging changes to the JVM can be grouped into the five categories listed here:</p>
<ul class="calibre13">
<li class="calibre14"><span class="calibre5">Command-line options</span></li>
<li class="calibre14">Decorations</li>
<li class="calibre14">Levels</li>
<li class="calibre14">Output</li>
<li class="calibre14">Tags</li>
</ul>
<p class="mce-root">Let's briefly look at each of these categories.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Command-line options</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The new command-line option, <kbd class="calibre16">-Xlog</kbd>, was added to the logging framework in Java 9. This command-line option has an extensive array of parameters and possibilities. The basic syntax is simply <kbd class="calibre16">-Xlog</kbd> followed by an option. Here is the formal basic syntax:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog[:option]</strong></pre>
<p class="mce-root">Here is a basic example with the <kbd class="calibre16">all</kbd> option:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog:all</strong></pre>
<p class="mce-root">Here is the extensive command-line syntax used to configure the new unified logging:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog[:option]</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">option          := [&lt;what&gt;][:[&lt;output&gt;][:[&lt;decorators&gt;][:&lt;output-options&gt;]]]</strong><br class="calibre2"/><strong class="calibre3">                   'help'</strong><br class="calibre2"/><strong class="calibre3">                   'disable'</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">what            := &lt;selector&gt;[,...]</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">selector        := &lt;tag-set&gt;[*][=&lt;level&gt;]</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">tag-set         := &lt;tag&gt;[+..]</strong><br class="calibre2"/><strong class="calibre3">                   'all'</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">tag             := name of tag</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">level           := trace</strong><br class="calibre2"/><strong class="calibre3">                   debug</strong><br class="calibre2"/><strong class="calibre3">                   info</strong><br class="calibre2"/><strong class="calibre3">                   warning</strong><br class="calibre2"/><strong class="calibre3">                   error</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">output          := 'stderr'</strong><br class="calibre2"/><strong class="calibre3">                   'stdout'</strong><br class="calibre2"/><strong class="calibre3">                   [file=]&lt;filename&gt;</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">decorators      := &lt;decorator&gt;[,...]</strong><br class="calibre2"/><strong class="calibre3">                   'none'</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">decorator       := time</strong><br class="calibre2"/><strong class="calibre3">                   uptime</strong><br class="calibre2"/><strong class="calibre3">                   timemillis</strong><br class="calibre2"/><strong class="calibre3">                   uptimemillis</strong><br class="calibre2"/><strong class="calibre3">                   timenanos</strong><br class="calibre2"/><strong class="calibre3">                   uptimenanos</strong><br class="calibre2"/><strong class="calibre3">                   pid</strong><br class="calibre2"/><strong class="calibre3">                   tid</strong><br class="calibre2"/><strong class="calibre3">                   level</strong><br class="calibre2"/><strong class="calibre3">                   tags</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">output-options  := &lt;output_option&gt;[,...]</strong><br class="calibre2"/><br class="calibre2"/><strong class="calibre3">output-option   := filecount=&lt;file count&gt;</strong><br class="calibre2"/><strong class="calibre3">                   filesize=&lt;file size in kb&gt;</strong><br class="calibre2"/><strong class="calibre3">                   parameter=value</strong></pre>
<p class="mce-root">The following <kbd class="calibre16">-Xlog</kbd> examples are followed by a description:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog:all</strong></pre>
<p class="mce-root">In the preceding example, we are telling the JVM to take the following actions:</p>
<ul class="calibre13">
<li class="calibre14">Log all messages</li>
<li class="calibre14">Use the <kbd class="calibre16">info</kbd> level</li>
<li class="calibre14">Provide output to <kbd class="calibre16">stdout</kbd></li>
</ul>
<div class="packt_infobox">With this example, all <kbd class="calibre39">warning</kbd> messages will still be output to <kbd class="calibre39">stderr</kbd>.</div>
<p class="mce-root">The next example, shown here, logs messages at the <kbd class="calibre16">debug</kbd> level:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog:gc+rt*=debug</strong></pre>
<p class="mce-root">In the preceding example, we are telling the JVM to take the following actions:</p>
<ul class="calibre13">
<li class="calibre14">Log all messages tagged with, at a minimum, the <kbd class="calibre16">gc</kbd> and <kbd class="calibre16">rt</kbd> tags</li>
<li class="calibre14">Use the <kbd class="calibre16">debug</kbd> level</li>
<li class="calibre14">Provide output to <kbd class="calibre16">stdout</kbd></li>
</ul>
<p class="mce-root">The next example pushes the output to an external file:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog:disable - Xlog:rt=debug:rtdebug.txt</strong></pre>
<p class="mce-root">In the preceding example, we are telling the JVM to take the following actions:</p>
<ul class="calibre13">
<li class="calibre14">Disable all messages except those tagged with <kbd class="calibre16">rt</kbd> tags</li>
<li class="calibre14">Use the <kbd class="calibre16">debug</kbd> level</li>
<li class="calibre14">Provide output to a file named <kbd class="calibre16">rtdebug.txt</kbd></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Decorations</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In the context of Java 9's logging framework, decorations are metadata about the log message. Here is the alphabetic list of decorations that are available:</p>
<ul class="calibre13">
<li class="calibre14"><strong class="calibre3">level</strong>: The level associated with the logged message</li>
<li class="calibre14"><strong class="calibre3">pid</strong>: PID = Processor IDentifier</li>
<li class="calibre14"><strong class="calibre3">tags</strong>: The tag-set associated with the logged message</li>
<li class="calibre14"><strong class="calibre3">tid</strong>: TID = Thread IDentifier</li>
<li class="calibre14"><strong class="calibre3">time</strong>: Refers to current date and time using ISO-8601 format</li>
<li class="calibre14"><strong class="calibre3">timemillis</strong>: Current time in milliseconds</li>
<li class="calibre14"><strong class="calibre3">timenanos</strong>: Current time in nanoseconds</li>
<li class="calibre14"><strong class="calibre3">uptime</strong>: Time, in seconds and milliseconds, since the JVM started</li>
<li class="calibre14"><strong class="calibre3">uptimemillis</strong>: Time, in milliseconds, since the JVM started</li>
<li class="calibre14"><strong class="calibre3">uptimenanos</strong>: Time, in nanoseconds, since the JVM started</li>
</ul>
<p class="mce-root">Decorations can be surpassed or included in unified logging output. Regardless of which decorations are used, they will appear in the output in the following order:</p>
<ol class="calibre18">
<li class="chapter">time</li>
<li class="chapter">uptime</li>
<li class="chapter">timemillis</li>
<li class="chapter">uptimemillis</li>
<li class="chapter">timenanos</li>
<li class="chapter">uptimenanos</li>
<li class="chapter">pid</li>
<li class="chapter">tid</li>
<li class="chapter">level</li>
<li class="chapter">tags</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Levels</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Logged messages are individually associated with a verbosity level. As previously listed, the levels are <strong class="calibre8">error</strong>, <strong class="calibre8">warning</strong>, <strong class="calibre8">information</strong>, <strong class="calibre8">debug</strong>, <strong class="calibre8">trace</strong>, and <strong class="calibre8">develop</strong>. The following chart shows how the levels have an increasing level of verbosity in respect to how much information is logged. The <strong class="calibre8">develop</strong> level is for development purposes only and is not available in on-product application builds:</p>
<div class="mce-root1"><img src="Images/51f2610d-700d-41b6-823b-56c4022a6c55.png" width="1370" height="1126" class="calibre153"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Output</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The Java 9 logging framework supports three types of output with examples of direct use with the <kbd class="calibre16">-Xlog</kbd> command-line syntax:</p>
<p class="mce-root">In the following example, we provide output to <kbd class="calibre16">stderr</kbd>:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog:all=warning:stderr:none</strong></pre>
<p class="mce-root">The following example provides output to <kbd class="calibre16">stdout</kbd>:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog:all=warning:stdout:none</strong></pre>
<p class="mce-root">The following example writes the output to a text file:</p>
<pre class="calibre21"><strong class="calibre3">-Xlog:all=warning:file=logmessages.txt:none</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Tags</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The new logging framework consists of a set of tags identified in the JVM. These tags can be changed in source code if needed. The tags should be self-identifying, such as <kbd class="calibre16">gc</kbd> for garbage collection.</p>
<p class="mce-root">When more than one tag is grouped together, they form a tag-set. When we add our own tags via source code, each tag should be associated with a tag-set. This will help ensure the tags stay organized and easily human-readable.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Compiler control [JEP 165]</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Controlling Java Virtual Machine compilers might seem like an unnecessary task, but for many developers, this is an important aspect of testing. Java Enhancement Proposal 165 detailed a plan to implement runtime management of JVM compilers. This is accomplished with method-dependent compiler flags.</p>
<p class="mce-root">In this section, we will start with a look at JVM compilation modes, then look at the compiler that can be controlled using the Java 9 platform.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Compilation modes</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The changes in the Java 9 platform include granular control of both the c1 and c2 JVM compliers. As you can see in the following illustration, the Java HotSpot JVM has two <span class="calibre7"><strong class="calibre8">Just-in-Time</strong> (<strong class="calibre8">JIT</strong>)</span> compilation modes--<strong class="calibre8">c1</strong> and <strong class="calibre8">c2</strong>:</p>
<div class="mce-root1"><img src="Images/6378a448-1912-44bd-81a9-4accb01fb99d.png" width="1580" height="1210" class="calibre154"/></div>
<p class="mce-root">The <strong class="calibre8">C1</strong> and <strong class="calibre8">C2</strong> compilation modes use different compilation techniques and, if used on the same code base, can produce different sets of machine code.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">C1 compilation mode</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The C1 compilation mode inside Java HotSpot VM is typically used for applications that have the following characteristics:</p>
<ul class="calibre13">
<li class="calibre14">Quick startup</li>
<li class="calibre14">Increased optimization</li>
<li class="calibre14">Client-side</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">C2 compilation mode</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The second compilation mode, C2, is used by applications with the following listed characteristics:</p>
<ul class="calibre13">
<li class="calibre14">Long runtimes</li>
<li class="calibre14">Server-side</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Tiered compilation</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Tiered compilation allows us to use both <strong class="calibre8">c1</strong> and <strong class="calibre8">c2</strong> compilation modes. Starting with Java 8, tiered compilation is the default process. As illustrated here, the <strong class="calibre8">c1</strong> mode is used at startup to help provide greater optimization. Then, once the app has sufficiently warmed up, the <strong class="calibre8">c2</strong> mode is employed:</p>
<div class="mce-root1"><img src="Images/c749390b-2a49-46c9-90b0-ef1f9fd71074.png" width="1626" height="1118" class="calibre155"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Compiler control in Java 9</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Java 9 comes with the promise of the ability to have finite control over JVM compilers and to make changes at runtime. These additional abilities do not degrade performance. This permits greater fidelity of testing and testing optimization as we can run small compiler tests without having to relaunch the entire JVM.</p>
<p class="mce-root">To control compiler operations, we need to create a directives file. These files contain compiler directives which consist of a set of options with values. Directive files essentially use a subset of JSON:</p>
<div class="mce-root1"><img src="Images/0fe04758-0407-4944-bd87-861f14ad54e6.png" width="978" height="960" class="calibre156"/></div>
<p class="mce-root">The <strong class="calibre8">JavaScript Object Notation</strong> (<strong class="calibre8">JSON</strong>) format is used for data-interchange. The directive files have the following formatting differences from JSON:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre16">int</kbd> and <kbd class="calibre16">doubles</kbd> are the only supported number formats</li>
<li class="calibre14">Double forward slash (<kbd class="calibre16">//</kbd>) can be used for comment lines</li>
<li class="calibre14">Trailing commas (<kbd class="calibre16">,</kbd>) can be used in arrays and objects</li>
<li class="calibre14">Escape characters are not supported</li>
<li class="calibre14">Option names are formatted as strings and do not have to be quoted</li>
</ul>
<div class="packt_tip">You can learn more about JSON at <a href="http://www.json.org" class="calibre25 pcalibre pcalibre3 pcalibre2 pcalibre1">http://www.json.org</a>.</div>
<p class="mce-root">We can add our directive file using the following syntax at the command line:</p>
<pre class="calibre21"><strong class="calibre3">-XX:CompilerDirectivesFile=&lt;file&gt;</strong></pre>
<p class="mce-root">Here is a shell example of a directives file:</p>
<pre class="calibre21"><span class="calibre5">    [  // Open square bracket marks the start of the directives file<br class="calibre2"/></span><span class="calibre5"><br class="calibre2"/>    { // Open curly brace marks the start of a directive block<br class="calibre2"/><br class="calibre2"/></span><span class="calibre5">      // A directives block that applies specifically to the C1 mode<br class="calibre2"/></span><span class="calibre5">      c1: {   <br class="calibre2"/></span><span class="calibre5">             // directives go here<br class="calibre2"/></span><span class="calibre5">          },<br class="calibre2"/></span><span class="calibre5">    <br class="calibre2"/></span><span class="calibre5">      // A directives block that applies specifically to the C2 mode<br class="calibre2"/></span><span class="calibre5">      c2: {   <br class="calibre2"/></span><span class="calibre5">             // directives go here<br class="calibre2"/></span><span class="calibre5">          },<br class="calibre2"/><br class="calibre2"/></span><span class="calibre5">      // Here we can put a directives that do not apply to<br class="calibre2"/></span><span class="calibre5">      // a specific compiler mode<br class="calibre2"/><br class="calibre2"/></span><span class="calibre5">    },<br class="calibre2"/><br class="calibre2"/></span><span class="calibre5">    {  // can have multiple directive blocks<br class="calibre2"/><br class="calibre2"/></span><span class="calibre5">       c1: {<br class="calibre2"/></span><span class="calibre5">             // directives go here<br class="calibre2"/></span><span class="calibre5">           }   <br class="calibre2"/></span><span class="calibre5"><br class="calibre2"/>       c2: {<br class="calibre2"/></span><span class="calibre5">             // directives go here<br class="calibre2"/></span><span class="calibre5">           }    <br class="calibre2"/></span><span class="calibre5">    }<br class="calibre2"/></span><span class="calibre5"><br class="calibre2"/>    ] </span><span class="calibre5">// Close square bracket marks the start of the directives file</span></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Diagnostic commands [JEP 228]</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The Java Enhancement Proposal 228, <strong class="calibre8">Add More Diagnostic Commands</strong>, defined seven additional diagnostic commands to enhance the ability to diagnose the JDK and the JVM. The new diagnostic commands are detailed here.</p>
<p class="mce-root">The <kbd class="calibre16">print_codegenlist</kbd> command <span class="calibre7">prints methods that are currently queued for compilation. Since c1 and c2 compilation modes are on separate queues, this command would need to be issued to a</span> specific queue<span class="calibre7">.</span></p>
<p class="mce-root"><span class="calibre7">The <kbd class="calibre16">dump_codelist</kbd> diagnostic command will print the following listed information for the compiled methods:</span></p>
<ul class="calibre13">
<li class="calibre14">Full signature</li>
<li class="calibre14">Address range</li>
<li class="calibre14">State
<ul class="calibre13">
<li class="calibre14">Alive</li>
<li class="calibre14">Nonentrant</li>
<li class="calibre14">Zombie</li>
</ul>
</li>
</ul>
<p class="mce-root"><span class="calibre7">In addition, the <kbd class="calibre16">dump_codelist</kbd> diagnostic command allows the output to be directed to <kbd class="calibre16">stdout</kbd> or to a specified file. Output can be in XML form or standard text.</span></p>
<p class="mce-root">The <kbd class="calibre16">print_codeblocks</kbd> command allows us to print:</p>
<ul class="calibre13">
<li class="calibre14"><span class="calibre5">Code cache size</span></li>
<li class="calibre14"><span class="calibre5">Code cache list</span></li>
<li class="calibre14"><span class="calibre5">List of blocks in the code cache</span></li>
<li class="calibre14"><span class="calibre5">Addresses for code blocks</span></li>
</ul>
<p class="mce-root"><span class="calibre7">Th <kbd class="calibre16">datadump_request</kbd> diagnostic command sends a dump request to the <strong class="calibre8">Java Virtual Machine Tool Interface</strong> (<strong class="calibre8">JVMTI</strong>). This replaces the <strong class="calibre8">Java Virtual Machine Debug Interface</strong> (<strong class="calibre8">JVMDI</strong>) and the <strong class="calibre8">Java Virtual Machine Profiling Interface</strong> (<strong class="calibre8">JVMPI</strong>) interfaces.</span></p>
<p class="mce-root"><span class="calibre7">With the <kbd class="calibre16">set_vmflag</kbd> command, we can set a command-line flag or option in the JVM or the libraries.</span></p>
<p class="mce-root"><span class="calibre7">Th <kbd class="calibre16">print_class_summary</kbd> diagnostic command prints a list of all loaded classes as well as the structure of their inheritance.</span></p>
<p class="mce-root"><span class="calibre7">The <kbd class="calibre16">print_utf8pool</kbd> command prints all UTF-8 string constants.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Heap profiling agent [JEP 240]</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Java Enhancement Proposal 240 is titled <em class="calibre20">Remove the JVM TI hprof Agent</em>. Here are the key terms associated with this JEP and referenced in the title that might be new to you:</p>
<ul class="calibre13">
<li class="calibre14"><strong class="calibre3">Tool Interface (TI)</strong>: This is a native programming interface that allows tools to control the execution of applications that are being run inside the Java Virtual Machine. The interface also permits state inquiries. The full nomenclature for this tool is the Java Virtual Machine Tool Interface, or JVM TI.</li>
<li class="calibre14"><strong class="calibre3">Heap Profiling (HPROF)</strong>: This is an internal JDK tool used for profiling a JVM's use of CPUs and the heap. The most common exposure developers have to <kbd class="calibre16">hprof</kbd> is the file that is generated when following a crash. The generated file contains a heap dump.</li>
</ul>
<p class="mce-root">The Java 9 JDK does not contain the <kbd class="calibre16">hprof</kbd> agent. It was removed largely because there are superior alternatives available. Here is a table of the related functionality:</p>
<table class="calibre30">
<tbody class="calibre31">
<tr class="calibre32">
<td class="calibre33"><strong class="calibre3">HPROF Functionality</strong></td>
<td class="calibre33"><strong class="calibre3">Alternative</strong></td>
</tr>
<tr class="calibre34">
<td class="calibre33">
<p class="mce-root3">Allocation Profiler</p>
<p class="mce-root3">(heap=sites)</p>
</td>
<td class="calibre33">
<p class="mce-root3">Java VisualVM</p>
</td>
</tr>
<tr class="calibre32">
<td class="calibre33">
<p class="mce-root3">CPU Profiler</p>
<p class="mce-root3">(cpu=samples)</p>
<p class="mce-root3">(cpu=times)</p>
</td>
<td class="calibre33">
<p class="mce-root3">Java VisualVM</p>
<p class="mce-root3">Java Flight Recorder</p>
</td>
</tr>
<tr class="calibre35">
<td class="calibre33">
<p class="mce-root3">Heap Dumps</p>
<p class="mce-root3">(heap=dump)</p>
</td>
<td class="calibre33">
<p class="mce-root3">Internal JVM functionality:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre16">GC.heap_dump(icmd &lt;pid&gt; GC.heap_dump)</kbd></li>
<li class="calibre14"><kbd class="calibre16">jmap -dump</kbd></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p class="mce-root"> </p>
<p class="mce-root">Interestingly, when HPROF was originally created, it was not intended to be used in production. In fact, it was only meant to test code for the JVM Tool Interface. So, with the advent of the Java 9 platform, the HPROF library (<kbd class="calibre16">libhprof.so</kbd>) will no longer be part of the JDK.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Removing your JHAT [JEP 241]</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The <strong class="calibre8">Java Heap Analysis Tool</strong> (<strong class="calibre8">JHAT</strong>) is used to parse Java heap dump files. The syntax for this heap dump file parsing tool is as follows:</p>
<pre class="calibre21"><strong class="calibre3">jhat <br class="calibre2"/>     [-stack &lt;bool&gt;] <br class="calibre2"/>     [-refs &lt;bool&gt;] <br class="calibre2"/>     [-port &lt;port&gt;] <br class="calibre2"/>     [-baseline &lt;file&gt;] <br class="calibre2"/>     [-debug &lt;int&gt;] <br class="calibre2"/>     [-version] <br class="calibre2"/>     [-h|-help] <br class="calibre2"/>     &lt;file&gt;</strong></pre>
<p class="mce-root">Here is a quick look at the options associated with the JHAT command:</p>
<table class="calibre30">
<tbody class="calibre31">
<tr class="calibre32">
<td class="calibre33"><strong class="calibre3">Option</strong></td>
<td class="calibre33"><strong class="calibre3">Description</strong></td>
<td class="calibre33"><strong class="calibre3">Default</strong></td>
</tr>
<tr class="calibre34">
<td class="calibre33"><kbd class="calibre16">-J&lt;flag&gt;</kbd></td>
<td class="calibre33">This passes <kbd class="calibre16">&lt;flag&gt;</kbd> to the runtime system.</td>
<td class="calibre33">N/A</td>
</tr>
<tr class="calibre32">
<td class="calibre33"><kbd class="calibre16">-stack&lt;bool&gt;</kbd></td>
<td class="calibre33">Toggles tracking of object allocation call stack.</td>
<td class="calibre33"><kbd class="calibre16">true</kbd></td>
</tr>
<tr class="calibre34">
<td class="calibre33"><kbd class="calibre16">-refs&lt;bool&gt;</kbd></td>
<td class="calibre33">Toggles tracking of references to objects.</td>
<td class="calibre33"><kbd class="calibre16">true</kbd></td>
</tr>
<tr class="calibre32">
<td class="calibre33"><kbd class="calibre16">-port&lt;port&gt;</kbd></td>
<td class="calibre33">Indicates the port for the JHAT HTTP server.</td>
<td class="calibre33"><kbd class="calibre16">7000</kbd></td>
</tr>
<tr class="calibre34">
<td class="calibre33"><kbd class="calibre16">-exclude&lt;exclude-filename&gt;</kbd></td>
<td class="calibre33">Exclude indicated file from reachable objects query.</td>
<td class="calibre33">N/A</td>
</tr>
<tr class="calibre32">
<td class="calibre33"><kbd class="calibre16">-baseline&lt;filename&gt;</kbd></td>
<td class="calibre33">Specifies the baseline heap dump for use in comparisons.</td>
<td class="calibre33">N/A</td>
</tr>
<tr class="calibre34">
<td class="calibre33"><kbd class="calibre16">-debug&lt;int&gt;</kbd></td>
<td class="calibre33">Sets verbosity of output.</td>
<td class="calibre33">N/A</td>
</tr>
<tr class="calibre32">
<td class="calibre33"><kbd class="calibre16">-version</kbd></td>
<td class="calibre33">Simply outputs the <span class="calibre5">JHAT</span> release number.</td>
<td class="calibre33">N/A</td>
</tr>
<tr class="calibre35">
<td class="calibre33">
<p class="mce-root3"><kbd class="calibre16">-h</kbd></p>
<p class="mce-root3"><kbd class="calibre16">-help</kbd></p>
</td>
<td class="calibre33">Provides help text.</td>
<td class="calibre33">N/A</td>
</tr>
</tbody>
</table>
<p class="mce-root"> </p>
<p class="mce-root">JHAT has been part of the Java platform since JDK-6 in an experimental form. It was not supported and has been deemed to be outdated. Starting with Java 9, this tool will no longer be part of the JDK.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">JVM command-line flag argument validation [JEP 245]</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In this chapter, you have gained exposure to much of the command-line flag usage with the Java 9 platform. Java Enhancement Proposal 245, titled <em class="calibre20">Validate JVM Command-Line Flag Arguments</em>, was created to ensure all JVM command-line flags with arguments are validated. The primary goals of this effort were:</p>
<ul class="calibre13">
<li class="calibre14">Avoid JVM crashes</li>
<li class="calibre14">Provide error messages to inform of invalid flag arguments</li>
</ul>
<p class="mce-root">As you can see from the following graphic, there was no attempt to auto-correct the flag argument errors; rather, just to identify the errors and prevent the JVM from crashing:</p>
<div class="mce-root1"><img src="Images/247f3f1f-0ca5-4e37-b4d7-36ee886d8fdf.png" width="1436" height="942" class="calibre157"/></div>
<p class="mce-root">A sample error message is provided here and indicates that the flag argument was out of range. This error would be displayed during the flag argument range check performed during the JVM's initialization:</p>
<pre class="calibre21"><strong class="calibre3">exampleFlag UnguardOnExecutionViolation = 4 is outside the allowed range [ 0 . . . 3]</strong></pre>
<p class="mce-root">Here are some specifics regarding this change to the Java platform:</p>
<ul class="calibre13">
<li class="calibre14">Expand on the current <kbd class="calibre16">globals.hpp</kbd> source file to ensure complete flag default values and permissible ranges are documented</li>
<li class="calibre14">Define a framework to support adding new JVM command-line flags in the future:
<ul class="calibre13">
<li class="calibre14">This will include value ranges and value sets</li>
<li class="calibre14">This will ensure the validity checking will apply to all newly added command-line flags</li>
</ul>
</li>
<li class="calibre14">Modify macro tables:
<ul class="calibre13">
<li class="calibre14">Add min/max for optional range</li>
<li class="calibre14">Add constraint entries for the following:
<ul class="calibre13">
<li class="calibre14">Ensure constraint checks are performed each time a flag changes</li>
<li class="calibre14">All manageable flags will continue to be checked while the JVM is running</li>
</ul>
</li>
</ul>
</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Compile for older platform versions [JEP 247]</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The Java Compiler, <kbd class="calibre16">javac</kbd>, has been updated for Java 9 to ensure it can be used to compile Java programs to run on user-selected older versions of the Java platform. This was the focus of Java Enhancement Proposal 247, <strong class="calibre8">Compile for Older Platform Versions</strong>.</p>
<p class="mce-root">As you can see in the following screenshot, <kbd class="calibre16">javac</kbd> has several options including <kbd class="calibre16">-source</kbd> and <kbd class="calibre16">-target</kbd>. The <kbd class="calibre16">javac</kbd> presented in the following screenshot is from Java 8:</p>
<div class="mce-root1"><img src="Images/b5ad87fc-702d-4aa3-abfc-9605980c9904.png" width="1800" height="1096" class="calibre158"/></div>
<p class="mce-root">The <kbd class="calibre16">-source</kbd> option is used to dictate the Java version accepted by the compiler. The <kbd class="calibre16">-target</kbd> option informs which version of class files <kbd class="calibre16">javac</kbd> will produce. By default, <kbd class="calibre16">javac</kbd> generates class files in the most recent java version and that of the platform APIs. This can cause a problem when the compiled application uses APIs that are only available in the most recent platform version. This would render the application ineligible to run on older platform versions, despite what is dictated with the <kbd class="calibre16">-source</kbd> and <kbd class="calibre16">-target</kbd> options.</p>
<p class="mce-root">To address the aforementioned problem, a new command-line option is introduced with the Java 9 platform. This option is the <kbd class="calibre16">--release</kbd> option and, when used, will automatically configure javac to generate class files that link against a specific platform version. The following screenshot shows the <kbd class="calibre16">javac</kbd> options with the Java 9 platform. As you can see, the new <kbd class="calibre16">--release</kbd> option is included:</p>
<div class="mce-root1"><img src="Images/83ad1148-a99c-48cc-ad34-2ab5c35f2d5e.png" width="706" height="996" class="calibre159"/></div>
<p class="mce-root">Here is the syntax for the new option:</p>
<pre class="calibre21"><strong class="calibre3">javac --release &lt;release&gt; &lt;source files&gt;</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In this chapter we explored several changes to the Java 9 platform with the common theme of command-line flags. Specifically, we covered <span class="calibre7">unified JVM logging,</span> compiler control, <span class="calibre7">new diagnostic commands, removal of the HPROF h</span><span class="calibre7">eap profiling agent, the removal of the</span> <span class="calibre7">JHAT,</span> <span class="calibre7">command-line flag argument validation, and</span> <span class="calibre7">the ability to compile for older platform versions.</span></p>
<p class="mce-root">In the next chapter, we will focus on best practices with additional utilities provided with the Java 9 platform. These will include UTF-8, Unicode 7.0, Linux, and more.</p>


            </article>

            
        </section>
    </div>



  </body></html>