<html><head></head><body>
<div class="IMG---Figure" id="_idContainer137">
<h1 class="chapter-number" id="_idParaDest-297"><a id="_idTextAnchor306"/><span class="koboSpan" id="kobo.1.1">15</span></h1>
<h1 id="_idParaDest-298"><a id="_idTextAnchor307"/><span class="koboSpan" id="kobo.2.1">Driving the Web Layer</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we complete our web application by adding a web endpoint. </span><span class="koboSpan" id="kobo.3.2">We will learn how to write HTTP integration tests using the built-in Java HTTP client. </span><span class="koboSpan" id="kobo.3.3">We will test-drive the web adapter code that runs this endpoint, using an open source HTTP server framework. </span><span class="koboSpan" id="kobo.3.4">This web adapter is responsible for converting HTTP requests into commands we can execute in our domain layer. </span><span class="koboSpan" id="kobo.3.5">At the end of the chapter, we will assemble all the pieces of our application into a microservice. </span><span class="koboSpan" id="kobo.3.6">The web adapter and database adapters will be linked to the domain model using dependency injection. </span><span class="koboSpan" id="kobo.3.7">We will need to run a few manual database commands, install a web client called Postman, and then we can play </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">our game.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we’re going to cover the following </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">main topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">Starting a </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">new game</span></span></li>
<li><span class="koboSpan" id="kobo.9.1">Playing </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">the game</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Integrating </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">the application</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Using </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">the application</span></span></li>
</ul>
<h1 id="_idParaDest-299"><a id="_idTextAnchor308"/><span class="koboSpan" id="kobo.15.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.16.1">The code for this chapter is available </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">at </span></span><a href="B18384_15.xhtml#_idTextAnchor314"><span class="No-Break"><span class="koboSpan" id="kobo.18.1">https://github.com/PacktPublishing/Test-Driven-Development-with-Java/tree/main/chapter15</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.19.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.20.1">Before attempting to run the final application, perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.22.1">Ensure the </span><strong class="bold"><span class="koboSpan" id="kobo.23.1">Postgres</span></strong><span class="koboSpan" id="kobo.24.1"> database is </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">running locally.</span></span></li>
<li><span class="koboSpan" id="kobo.26.1">Ensure the database setup steps from </span><a href="B18384_14.xhtml#_idTextAnchor293"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.27.1">Chapter 14</span></em></span></a><em class="italic"><span class="koboSpan" id="kobo.28.1"> , Driving the Database Layer,</span></em><span class="koboSpan" id="kobo.29.1"> have </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">been completed.</span></span></li>
<li><span class="koboSpan" id="kobo.31.1">Open the </span><strong class="bold"><span class="koboSpan" id="kobo.32.1">Postgres pqsl</span></strong><span class="koboSpan" id="kobo.33.1"> command terminal and enter the following </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">SQL command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.35.1">insert into word values (1, 'ARISE'), (2, 'SHINE'), (3, 'LIGHT'), (4, 'SLEEP'), (5, 'BEARS'), (6, 'GREET'), (7, 'GRATE');</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.36.1">Install </span><strong class="bold"><span class="koboSpan" id="kobo.37.1">Postman</span></strong><span class="koboSpan" id="kobo.38.1"> by following the instructions </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">at </span></span><a href="B18384_15.xhtml#_idTextAnchor313"><span class="No-Break"><span class="koboSpan" id="kobo.40.1">https://www.postman.com/downloads/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.41.1">.</span></span></li>
</ol>
<h1 id="_idParaDest-300"><a id="_idTextAnchor309"/><span class="koboSpan" id="kobo.42.1">Starting a new game</span></h1>
<p><span class="koboSpan" id="kobo.43.1">In this section, we will test-drive a web adapter</span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.44.1"> that will provide our domain model with an HTTP API.  </span><span class="koboSpan" id="kobo.44.2">External web clients will be able to send HTTP requests to this endpoint to trigger actions in our domain model so that we can play the game. </span><span class="koboSpan" id="kobo.44.3">The API will return appropriate HTTP responses, indicating the score for the submitted guess and reporting when the game </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">is over.</span></span></p>
<p><span class="koboSpan" id="kobo.46.1">The following open source libraries</span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.47.1"> will be used to help us write </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">the code:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.49.1">Molecule</span></strong><span class="koboSpan" id="kobo.50.1">: This is a lightweight </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">HTTP framework</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.52.1">Undertow</span></strong><span class="koboSpan" id="kobo.53.1">: This is a lightweight HTTP web server that powers the </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">Molecule framework</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">GSON</span></strong><span class="koboSpan" id="kobo.56.1">: This is a Google library that converts between Java objects and  JSON </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">structured data</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.58.1">To start building, we first add the required libraries as dependencies to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.59.1">build.gradle</span></strong><span class="koboSpan" id="kobo.60.1"> file. </span><span class="koboSpan" id="kobo.60.2">Then we can begin writing an integration test for our HTTP endpoint and test-drive </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">the implementation.</span></span></p>
<h2 id="_idParaDest-301"><a id="_idTextAnchor310"/><span class="koboSpan" id="kobo.62.1">Adding required libraries to the project</span></h2>
<p><span class="koboSpan" id="kobo.63.1">We need to add</span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.64.1"> the three libraries</span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.65.1"> Molecule, Undertow, and Gson to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.66.1">build.gradle</span></strong><span class="koboSpan" id="kobo.67.1"> file</span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.68.1"> before we can </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">use them:</span></span></p>
<p><span class="koboSpan" id="kobo.70.1">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.71.1">build.gradle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.72.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.73.1">
dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.2'
    testImplementation 'org.assertj:assertj-core:3.22.0'
    testImplementation 'org.mockito:mockito-core:4.8.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:4.8.0'
    testImplementation 'com.github.database-rider:rider-core:1.35.0'
    testImplementation 'com.github.database-rider:rider-junit5:1.35.0'
    implementation 'org.postgresql:postgresql:42.5.0'
    implementation 'org.jdbi:jdbi3-core:3.34.0'
    implementation 'org.apache.commons:commons-lang3:3.12.0'
</span><strong class="bold"><span class="koboSpan" id="kobo.74.1">    </span></strong><strong class="bold"><span class="koboSpan" id="kobo.75.1">implementation 'com.vtence.molecule:molecule:0.15.0'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.76.1">    implementation 'io.thorntail:undertow:2.7.0.Final'</span></strong><span class="koboSpan" id="kobo.77.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.78.1">implementation 'com.google.code.gson:gson:2.10'</span></strong><span class="koboSpan" id="kobo.79.1">
}</span></pre>
<h2 id="_idParaDest-302"><a id="_idTextAnchor311"/><span class="koboSpan" id="kobo.80.1">Writing the failing test</span></h2>
<p><span class="koboSpan" id="kobo.81.1">We will follow the normal TDD cycle</span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.82.1"> to create our web adapter. </span><span class="koboSpan" id="kobo.82.2">When writing</span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.83.1"> tests for objects in the adapter layer, we must focus on testing the translation between objects in our domain layer and communications with external systems. </span><span class="koboSpan" id="kobo.83.2">Our adapter layer will use the Molecule HTTP framework to handle HTTP requests </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">and responses.</span></span></p>
<p><span class="koboSpan" id="kobo.85.1">As we have used hexagonal architecture and started with the domain layer, we already know that the game logic is working. </span><span class="koboSpan" id="kobo.85.2">The goal of this test is to prove that the web adapter layer is performing its responsibility. </span><span class="koboSpan" id="kobo.85.3">That is to translate HTTP requests and responses to objects in our </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">domain layer.</span></span></p>
<p><span class="koboSpan" id="kobo.87.1">As ever, we begin by creating </span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.88.1">a </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">test class:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.90.1">First, we write </span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.91.1">our test class. </span><span class="koboSpan" id="kobo.91.2">We’ll call it </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">WordzEndpointTest</span></strong><span class="koboSpan" id="kobo.93.1">, and it belongs in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">com.wordz.adapters.api</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.95.1"> package:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.96.1">
package com.wordz.adapters.api;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.97.1">
public class WordzEndpointTest {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.98.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.99.1">The reason for including this package is as part of our hexagonal architecture. </span><span class="koboSpan" id="kobo.99.2">Code in this web adapter is allowed to use anything from the domain model. </span><span class="koboSpan" id="kobo.99.3">The domain model itself is unaware of the existence of this </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">web adapter.</span></span></p>
<p><span class="koboSpan" id="kobo.101.1">Our first test will be to start a </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">new game:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.103.1">
@Test
void </span><strong class="bold"><span class="koboSpan" id="kobo.104.1">startGame</span></strong><span class="koboSpan" id="kobo.105.1">() {
}</span></pre>
<ol>
<li value="2"><span class="koboSpan" id="kobo.106.1">This test needs to capture the design decision that surrounds our intended web API. </span><span class="koboSpan" id="kobo.106.2">One decision is that when a game has successfully started, we will return a simple </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">204 No Content</span></strong><span class="koboSpan" id="kobo.108.1"> HTTP status code. </span><span class="koboSpan" id="kobo.108.2">We will start with the assert to capture </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">this decision:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.110.1">
@Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.111.1">
void startGame() {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.112.1">
    HttpResponse res;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.113.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.114.1">assertThat(res)</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.115.1">       .hasStatusCode(HttpStatus.NO_CONTENT.code);</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.116.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.117.1">Next, we write the Act step. </span><span class="koboSpan" id="kobo.117.2">The action here is for an external HTTP client to send a request</span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.118.1"> to our web endpoint. </span><span class="koboSpan" id="kobo.118.2">To achieve this, we use the built-in HTTP client</span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.119.1"> provided by Java itself. </span><span class="koboSpan" id="kobo.119.2">We arrange the code to send the request, and then discard any HTTP response body, as our design does not return </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">a body:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.121.1">
@Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.122.1">
void startGame()</span><strong class="bold"><span class="koboSpan" id="kobo.123.1"> throws IOException,</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.124.1">                        InterruptedException</span></strong><span class="koboSpan" id="kobo.125.1"> {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.126.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.127.1">var </span></strong><span class="koboSpan" id="kobo.128.1">httpClient</span><strong class="bold"><span class="koboSpan" id="kobo.129.1"> = HttpClient.newHttpClient();</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.130.1">    </span></strong><strong class="bold"><span class="koboSpan" id="kobo.131.1">HttpResponse res</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.132.1">        = </span></strong><span class="koboSpan" id="kobo.133.1">httpClient.send(req</span><strong class="bold"><span class="koboSpan" id="kobo.134.1">,</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.135.1">            HttpResponse.BodyHandlers.discarding());</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.136.1">
    assertThat(res)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.137.1">
       .hasStatusCode(HttpStatus.NO_CONTENT.code);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.138.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.139.1">The Arrange step is where we capture our decisions about the HTTP request to send. </span><span class="koboSpan" id="kobo.139.2">In order to start a new game, we need a </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">Player</span></strong><span class="koboSpan" id="kobo.141.1"> object to identify the player. </span><span class="koboSpan" id="kobo.141.2">We will send this as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.142.1">Json</span></strong><span class="koboSpan" id="kobo.143.1"> object in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">Request</span></strong><span class="koboSpan" id="kobo.145.1"> body. </span><span class="koboSpan" id="kobo.145.2">The request will cause a state change on our server, so we choose the HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">POST</span></strong><span class="koboSpan" id="kobo.147.1"> method to represent that. </span><span class="koboSpan" id="kobo.147.2">Finally, we choose a route whose path </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">/start</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.151.1">
@Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.152.1">
private static final Player PLAYER</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.153.1">
       </span><strong class="bold"><span class="koboSpan" id="kobo.154.1">= new Player("alan2112");</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.155.1">
void startGame() </span><strong class="bold"><span class="koboSpan" id="kobo.156.1">throws IOException,</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.157.1">                        InterruptedException</span></strong><span class="koboSpan" id="kobo.158.1"> {</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.159.1">    var req = HttpRequest.newBuilder()</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.160.1">       .uri(URI.create("htp://localhost:8080/start"))</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.161.1">       .POST(HttpRequest.BodyPublishers</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.162.1">            .ofString(new Gson().toJson(PLAYER)))</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.163.1">            .build();</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.164.1">
    var httpClient = HttpClient.newHttpClient();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.165.1">
    HttpResponse res</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.166.1">
        = httpClient.send(req,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.167.1">
            HttpResponse.BodyHandlers.discarding());</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.168.1">
    assertThat(res)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.169.1">
       .hasStatusCode(HttpStatus.NO_CONTENT.code);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.170.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.171.1">We see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">Gson</span></strong><span class="koboSpan" id="kobo.173.1"> library being</span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.174.1"> used to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">Player</span></strong><span class="koboSpan" id="kobo.176.1"> object into its JSON</span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.177.1"> representation. </span><span class="koboSpan" id="kobo.177.2">We also see a </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">POST</span></strong><span class="koboSpan" id="kobo.179.1"> method is constructed and sent to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">/start</span></strong><span class="koboSpan" id="kobo.181.1"> path on </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">localhost</span></strong><span class="koboSpan" id="kobo.183.1">.  </span><span class="koboSpan" id="kobo.183.2">Eventually, we will want to move the </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">localhost</span></strong><span class="koboSpan" id="kobo.185.1"> detail into configuration. </span><span class="koboSpan" id="kobo.185.2">But, for now, it will get the test working on our </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">local machine.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.187.1">We can run our integration test and confirm that </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">it fails:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer124">
<span class="koboSpan" id="kobo.189.1"><img alt="Figure 15.1 – A failed test – no HTTP server" src="image/Figure_15.01_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.190.1">Figure 15.1 – A failed test – no HTTP server</span></p>
<p><span class="koboSpan" id="kobo.191.1">Unsurprisingly, this test fails because</span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.192.1"> it cannot connect to an HTTP</span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.193.1"> server. </span><span class="koboSpan" id="kobo.193.2">Fixing that is our </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">next task.</span></span></p>
<h2 id="_idParaDest-303"><a id="_idTextAnchor312"/><span class="koboSpan" id="kobo.195.1">Creating our HTTP server</span></h2>
<p><span class="koboSpan" id="kobo.196.1">The failing test allows us to test-drive code</span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.197.1"> that implements an HTTP server. </span><span class="koboSpan" id="kobo.197.2">We will</span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.198.1"> use the Molecule library to provide HTTP services </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">to us:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.200.1">Add an endpoint class, which we will call </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">class WordzEndpoint</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.203.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.204.1">
    void startGame() throws IOException,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.205.1">
                            InterruptedException {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.206.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.207.1">var endpoint</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.208.1">           = new WordzEndpoint("localhost", 8080);</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.209.1">The two parameters passed into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">WordzEndpoint</span></strong><span class="koboSpan" id="kobo.211.1"> constructor define the host and port that the web endpoint will </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">run on.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.213.1">Using the IDE, we generate </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">the class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.215.1">
package com.wordz.adapters.api;</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.216.1">public class WordzEndpoint {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.217.1">    public WordzEndpoint(String host, int port) {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.218.1">    }</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.219.1">}</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.220.1">In this case, we’re not going to store the host and port details in fields. </span><span class="koboSpan" id="kobo.220.2">Instead, we are going to start a </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">WebServer</span></strong><span class="koboSpan" id="kobo.222.1"> using a class from the </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">Molecule library.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.224.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">WebServer</span></strong><span class="koboSpan" id="kobo.226.1"> using</span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.227.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">Molecule</span></span><span class="No-Break"><a id="_idIndexMarker801"/></span><span class="No-Break"><span class="koboSpan" id="kobo.229.1"> library:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.230.1">
package com.wordz.adapters.api;</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.231.1">import com.vtence.molecule.WebServer;</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.232.1">
public class WordzEndpoint {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.233.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.234.1">private final WebServer server;</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.235.1">
    public WordzEndpoint(String host, int port) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.236.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.237.1">server = WebServer.create(host, port);</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.238.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.239.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.240.1">The preceding code is enough to start an HTTP server running and allow the test to connect to it. </span><span class="koboSpan" id="kobo.240.2">Our HTTP server does nothing useful in terms of playing our game. </span><span class="koboSpan" id="kobo.240.3">We need to add some routes to this server along with the code to respond </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">to them.</span></span></p>
<h2 id="_idParaDest-304"><a id="_idTextAnchor313"/><span class="koboSpan" id="kobo.242.1">Adding routes to the HTTP server</span></h2>
<p><span class="koboSpan" id="kobo.243.1">To be useful, the HTTP endpoint</span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.244.1"> must respond to HTTP commands, interpret</span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.245.1"> them, and send them as commands to our domain layer. </span><span class="koboSpan" id="kobo.245.2">As design decisions, we decide on </span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.247.1">That a </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">/start</span></strong><span class="koboSpan" id="kobo.249.1"> route must be called to start </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">the game</span></span></li>
<li><span class="koboSpan" id="kobo.251.1">That we will use the HTTP </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">POST</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.253.1"> method</span></span></li>
<li><span class="koboSpan" id="kobo.254.1">That we will identify which player the game belongs to as JSON data in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">POST</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.256.1"> body</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.257.1">To add routes</span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.258.1"> to the  HTTP server, do</span><a id="_idIndexMarker805"/> <span class="No-Break"><span class="koboSpan" id="kobo.259.1">the following:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.260.1">Test-drive the </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">/start</span></strong><span class="koboSpan" id="kobo.262.1"> route. </span><span class="koboSpan" id="kobo.262.2">To work in small steps, initially, we will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">NOT_IMPLEMENTED</span></strong><span class="koboSpan" id="kobo.264.1"> HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">response code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.266.1">
public class WordzEndpoint {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.267.1">
    private final WebServer server;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.268.1">
    public WordzEndpoint(String host, int port) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.269.1">
        server = WebServer.create(host, port);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.270.1">
        try {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.271.1">
            server.route(new Routes() {{</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.272.1">
                post("/start")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.273.1">
                  .to(request -&gt; startGame(request));</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.274.1">
            }});</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.275.1">
        } catch (IOException ioe) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.276.1">
            throw new IllegaStateException(ioe);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.277.1">
        }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.278.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.279.1">
    private Response startGame(Request request) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.280.1">
        return Response</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.281.1">
                 .of(HttpStatus.NOT_IMPLEMENTED)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.282.1">
                 .done();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.283.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.284.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.285.1">We can run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">WordzEndpointTest</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.287.1">integration test:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer125">
<span class="koboSpan" id="kobo.288.1"><img alt="Figure 15.2 – An incorrect HTTP status" src="image/Figure_15.02_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.289.1">Figure 15.2 – An incorrect HTTP status</span></p>
<p><span class="koboSpan" id="kobo.290.1">The test fails, as expected. </span><span class="koboSpan" id="kobo.290.2">We have</span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.291.1"> made progress because the test now fails</span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.292.1"> for a different reason. </span><span class="koboSpan" id="kobo.292.2">We can now connect to the web endpoint, but it does not return the right HTTP response. </span><span class="koboSpan" id="kobo.292.3">Our next task is to connect this web endpoint to the domain layer code and take the relevant actions to start </span><span class="No-Break"><span class="koboSpan" id="kobo.293.1">a game.</span></span></p>
<h2 id="_idParaDest-305"><a id="_idTextAnchor314"/><span class="koboSpan" id="kobo.294.1">Connecting to the domain layer</span></h2>
<p><span class="koboSpan" id="kobo.295.1">Our next task is to receive an HTTP request </span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.296.1">and translate that into domain layer</span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.297.1"> calls. </span><span class="koboSpan" id="kobo.297.2">This involves parsing JSON request data, using the Google Gson library, into Java objects, then sending that response data to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">class </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">Wordz</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.300.1"> port:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.301.1">Add the code to call the domain layer port implemented as </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">class Wordz</span></strong><span class="koboSpan" id="kobo.303.1">. </span><span class="koboSpan" id="kobo.303.2">We will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">Mockito</span></strong><span class="koboSpan" id="kobo.305.1"> to create a test double for this object. </span><span class="koboSpan" id="kobo.305.2">This allows us to test only the web endpoint code, decoupled from all </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">other code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.307.1">@ExtendWith(MockitoExtension.class)</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.308.1">
public class WordzEndpointTest {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.309.1">
    @Mock</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.310.1">
    private Wordz mockWordz;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.311.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.312.1">
    void startGame() throws IOException,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.313.1">
                            InterruptedException {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.314.1">
        var endpoint</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.315.1">
        = new WordzEndpoint(</span><strong class="bold"><span class="koboSpan" id="kobo.316.1">mockWordz</span></strong><span class="koboSpan" id="kobo.317.1">,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.318.1">
                            "localhost", 8080);</span></pre></li>
<li><span class="koboSpan" id="kobo.319.1">We need to provide our </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">class Wordz</span></strong><span class="koboSpan" id="kobo.321.1"> domain object to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">class WordzEndpoint</span></strong><span class="koboSpan" id="kobo.323.1"> object. </span><span class="koboSpan" id="kobo.323.2">We use</span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.324.1"> dependency injection to inject</span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.325.1"> it into </span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">the constructor:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.327.1">
public class WordzEndpoint {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.328.1">
    private final WebServer server;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.329.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.330.1">private final Wordz wordz;</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.331.1">
    public WordzEndpoint(Wordz wordz,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.332.1">
                         String host, int port) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.333.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.334.1">this.wordz = wordz;</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.335.1">Next, we need to add the code to start a game. </span><span class="koboSpan" id="kobo.335.2">To do that, we first extract the </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">Player</span></strong><span class="koboSpan" id="kobo.337.1"> object from the JSON data</span><a id="_idIndexMarker812"/><span class="koboSpan" id="kobo.338.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">request</span></strong><span class="koboSpan" id="kobo.340.1"> body. </span><span class="koboSpan" id="kobo.340.2">That identifies which player to start a game</span><a id="_idIndexMarker813"/><span class="koboSpan" id="kobo.341.1"> for. </span><span class="koboSpan" id="kobo.341.2">Then we call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">wordz.newGame()</span></strong><span class="koboSpan" id="kobo.343.1"> method. </span><span class="koboSpan" id="kobo.343.2">If it is successful, we return an HTTP status code of </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">204 No Content</span></strong><span class="koboSpan" id="kobo.345.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">indicating success:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.347.1">
private Response startGame(Request request) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.348.1">
    try {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.349.1">
        Player player</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.350.1">
                = new Gson().fromJson(request.body(),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.351.1">
                                      Player.class);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.352.1">
        boolean isSuccessful = wordz.newGame(player);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.353.1">
        if (isSuccessful) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.354.1">
            return Response</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.355.1">
                    .of(HttpStatus.NO_CONTENT)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.356.1">
                    .done();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.357.1">
        }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.358.1">
    } catch (IOException e) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.359.1">
        throw new RuntimeException(e);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.360.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.361.1">
    throw new</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.362.1">
       UnsupportedOperationException("Not</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.363.1">
                                     implemented");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.364.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.365.1">Now, we can</span><a id="_idIndexMarker814"/><span class="koboSpan" id="kobo.366.1"> run</span><a id="_idIndexMarker815"/><span class="koboSpan" id="kobo.367.1"> the test, however, </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">it fails:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer126">
<span class="koboSpan" id="kobo.369.1"><img alt="Figure 15.3 – An incorrect HTTP response" src="image/Figure_15.03_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.370.1">Figure 15.3 – An incorrect HTTP response</span></p>
<p><span class="koboSpan" id="kobo.371.1">It failed because the return value from </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">wordz.newGame()</span></strong><span class="koboSpan" id="kobo.373.1"> was false. </span><span class="koboSpan" id="kobo.373.2">The mock object needs to be set up to </span><span class="No-Break"><span class="koboSpan" id="kobo.374.1">return </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">true</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.377.1">Return the correct</span><a id="_idIndexMarker816"/><span class="koboSpan" id="kobo.378.1"> value from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">mockWordz</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.380.1"> stub:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.381.1">
   @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.382.1">
void startsGame() throws IOException,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.383.1">
                         InterruptedException {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.384.1">
    var endpoint</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.385.1">
         = new WordzEndpoint(mockWordz,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.386.1">
                             "localhost", 8080);</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.387.1">    when(mockWordz.newGame(eq(PLAYER)))</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.388.1">          .thenReturn(true);</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.389.1">Then, run </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">the test:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer127">
<span class="koboSpan" id="kobo.391.1"><img alt="Figure 15.4 – The test passes" src="image/Figure_15.04_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.392.1">Figure 15.4 – The test passes</span></p>
<p><span class="koboSpan" id="kobo.393.1">The integration test passes. </span><span class="koboSpan" id="kobo.393.2">The HTTP request</span><a id="_idIndexMarker817"/><span class="koboSpan" id="kobo.394.1"> has been received, called the domain layer code</span><a id="_idIndexMarker818"/><span class="koboSpan" id="kobo.395.1"> to start a new game, and the HTTP response is returned. </span><span class="koboSpan" id="kobo.395.2">The next step is to </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">consider refactoring.</span></span></p>
<h2 id="_idParaDest-306"><a id="_idTextAnchor315"/><span class="koboSpan" id="kobo.397.1">Refactoring the start game code</span></h2>
<p><span class="koboSpan" id="kobo.398.1">As usual, once a test passes, we consider what – if anything – we need </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">to refactor.</span></span></p>
<p><span class="koboSpan" id="kobo.400.1">It will be worthwhile</span><a id="_idIndexMarker819"/><span class="koboSpan" id="kobo.401.1"> to refactor the test to simplify writing new tests by collating common code into </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">one place:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.403.1">
@ExtendWith(MockitoExtension.class)
public class WordzEndpointTest {
    @Mock
    private Wordz mockWordz;
    private WordzEndpoint endpoint;
</span><strong class="bold"><span class="koboSpan" id="kobo.404.1">    private static final Player PLAYER</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.405.1">                       = new Player("alan2112");</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.406.1">    private final HttpClient httpClient</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.407.1">                       = HttpClient.newHttpClient();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.408.1">    @BeforeEach</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.409.1">    void setUp() {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.410.1">        endpoint = new WordzEndpoint(mockWordz,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.411.1">                                  "localhost", 8080);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.412.1">    }</span></strong><span class="koboSpan" id="kobo.413.1">
    @Test
    void startsGame() throws IOException,
                             InterruptedException {
        when(mockWordz.newGame(eq(player)))
                              .thenReturn(true);
        var req = </span><strong class="bold"><span class="koboSpan" id="kobo.414.1">requestBuilder("start")</span></strong><span class="koboSpan" id="kobo.415.1">
                .POST(</span><strong class="bold"><span class="koboSpan" id="kobo.416.1">asJsonBody(PLAYER))</span></strong><span class="koboSpan" id="kobo.417.1">
                .build();
        var res
          = httpClient.send(req,
                HttpResponse.BodyHandlers.discarding());
        assertThat(res)
             .hasStatusCode(HttpStatus.NO_CONTENT.code);
    }
</span><strong class="bold"><span class="koboSpan" id="kobo.418.1">    private HttpRequest.Builder requestBuilder(</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.419.1">        String path) {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.420.1">        return HttpRequest.newBuilder()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.421.1">                .uri(URI.create("http://localhost:8080/"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.422.1">                                  + path));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.423.1">    }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.424.1">    private HttpRequest.BodyPublisher asJsonBody(</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.425.1">        Object source) {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.426.1">        return HttpRequest.BodyPublishers</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.427.1">                 .ofString(new Gson().toJson(source));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.428.1">    }</span></strong><span class="koboSpan" id="kobo.429.1">
}</span></pre>
<h2 id="_idParaDest-307"><a id="_idTextAnchor316"/><span class="koboSpan" id="kobo.430.1">Handling errors when starting a game</span></h2>
<p><span class="koboSpan" id="kobo.431.1">One of our design</span><a id="_idIndexMarker820"/><span class="koboSpan" id="kobo.432.1"> decisions is that a player cannot start a game when one is in progress. </span><span class="koboSpan" id="kobo.432.2">We need to test-drive this behavior. </span><span class="koboSpan" id="kobo.432.3">We choose to return an HTTP status of </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">409 Conflict</span></strong><span class="koboSpan" id="kobo.434.1"> to indicate that a game is already in progress for a player and a new one cannot be started </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">for them:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.436.1">Write the test to return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">409 Conflict</span></strong><span class="koboSpan" id="kobo.438.1"> if the game is already </span><span class="No-Break"><span class="koboSpan" id="kobo.439.1">in progress:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.440.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.441.1">
    void rejectsRestart() throws Exception {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.442.1">
        when(mockWordz.newGame(eq(player)))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.443.1">
                         .thenReturn(false);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.444.1">
        var req = requestBuilder("start")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.445.1">
                .POST(asJsonBody(player))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.446.1">
                .build();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.447.1">
        var res</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.448.1">
           = httpClient.send(req,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.449.1">
                HttpResponse.BodyHandlers.discarding());</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.450.1">
        assertThat(res)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.451.1">
               .hasStatusCode(HttpStatus.CONFLICT.code);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.452.1">
    }</span></pre></li>
<li><span class="koboSpan" id="kobo.453.1">Next, run the test. </span><span class="koboSpan" id="kobo.453.2">It should fail, as we have</span><a id="_idIndexMarker821"/><span class="koboSpan" id="kobo.454.1"> yet to write the </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">implementation code:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer128">
<span class="koboSpan" id="kobo.456.1"><img alt="Figure 15.5 – A failing test" src="image/Figure_15.05_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.457.1">Figure 15.5 – A failing test</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.458.1">Test-drive the code to report that the game cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.459.1">be restarted:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.460.1">
private Response startGame(Request request) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.461.1">
    try {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.462.1">
        Player player</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.463.1">
                = new Gson().fromJson(request.body(),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.464.1">
                                      Player.class);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.465.1">
        boolean isSuccessful = wordz.newGame(player);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.466.1">
        if (isSuccessful) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.467.1">
            return Response</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.468.1">
                    .of(HttpStatus.NO_CONTENT)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.469.1">
                    .done();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.470.1">
        }</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.471.1">        return Response</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.472.1">                .of(HttpStatus.CONFLICT)</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.473.1">                .done();</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.474.1">
    } catch (IOException e) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.475.1">
        throw new RuntimeException(e);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.476.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.477.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.478.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">test</span></span><span class="No-Break"><a id="_idIndexMarker822"/></span><span class="No-Break"><span class="koboSpan" id="kobo.480.1"> again:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer129">
<span class="koboSpan" id="kobo.481.1"><img alt="Figure 15. 6 – The test passes" src="image/Figure_15.06_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.482.1">Figure 15. </span><span class="koboSpan" id="kobo.482.2">6 – The test passes</span></p>
<p><span class="koboSpan" id="kobo.483.1">The test passes when run on its own now that the implementation is in place. </span><span class="koboSpan" id="kobo.483.2">Let’s run all the </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">WordzEndpointTests</span></strong><span class="koboSpan" id="kobo.485.1"> tests to double-check </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">our progress.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.487.1">Run </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">all </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">WordzEndpointTests</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer130">
<span class="koboSpan" id="kobo.491.1"><img alt="Figure 15.7 – Test failure due to restarting the server" src="image/Figure_15.07_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.492.1">Figure 15.7 – Test failure due to restarting the server</span></p>
<p><span class="koboSpan" id="kobo.493.1">Unexpectedly, the tests fail when run</span><a id="_idIndexMarker823"/><span class="koboSpan" id="kobo.494.1"> one after </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">the other.</span></span></p>
<h2 id="_idParaDest-308"><a id="_idTextAnchor317"/><span class="koboSpan" id="kobo.496.1">Fixing the unexpectedly failing tests</span></h2>
<p><span class="koboSpan" id="kobo.497.1">When we run all of the tests, they now fail. </span><span class="koboSpan" id="kobo.497.2">The tests all previously ran correctly</span><a id="_idIndexMarker824"/><span class="koboSpan" id="kobo.498.1"> when run one at a time. </span><span class="koboSpan" id="kobo.498.2">A recent change has clearly broken something. </span><span class="koboSpan" id="kobo.498.3">We lost our test isolation at some point. </span><span class="koboSpan" id="kobo.498.4">This error message indicates the web server is being started twice on the same port, which is </span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">not possible.</span></span></p>
<p><span class="koboSpan" id="kobo.500.1">The options are to stop the web server after each test or to only start the web server once for all tests. </span><span class="koboSpan" id="kobo.500.2">As this is intended to be a long-running microservice, only starting once seems the better </span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">choice here:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.502.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">@BeforeAll</span></strong><span class="koboSpan" id="kobo.504.1"> annotation to only start the HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">server once:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.506.1">@BeforeAll</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.507.1">
void setUp() {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.508.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.509.1">mockWordz = mock(Wordz.class);</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.510.1">
    endpoint = new WordzEndpoint(mockWordz,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.511.1">
                                 "localhost", 8080);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.512.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.513.1">We change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.515.1"> annotation to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">@BeforeAll</span></strong><span class="koboSpan" id="kobo.517.1"> annotation to make the endpoint creation only happen once per test. </span><span class="koboSpan" id="kobo.517.2">To support this, we also must create the mock and use an annotation on the test itself to control the life cycle </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">of objects:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.519.1">
@ExtendWith(MockitoExtension.class)
</span><strong class="bold"><span class="koboSpan" id="kobo.520.1">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span></strong><span class="koboSpan" id="kobo.521.1">
public class WordzEndpointTest {</span></pre>
<p><span class="koboSpan" id="kobo.522.1">Both tests in </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">WordzEndpointTest</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.524.1">now pass.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.525.1">With all tests passing again, we can consider refactoring the code. </span><span class="koboSpan" id="kobo.525.2">A readability improvement will come from extracting an </span><strong class="source-inline"><span class="koboSpan" id="kobo.526.1">extractPlayer()</span></strong><span class="koboSpan" id="kobo.527.1"> method. </span><span class="koboSpan" id="kobo.527.2">We can also make the conditional HTTP status</span><a id="_idIndexMarker825"/><span class="koboSpan" id="kobo.528.1"> code </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">more concise:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.530.1">
private Response startGame(Request request) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.531.1">
    try {</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.532.1">        Player player = extractPlayer(request);</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.533.1">
        boolean isSuccessful = wordz.newGame(player);</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.534.1">        HttpStatus status</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.535.1">                = isSuccessful?</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.536.1">                    HttpStatus.NO_CONTENT :</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.537.1">                    HttpStatus.CONFLICT;</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.538.1">
            return Response</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.539.1">                    .of(status)</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.540.1">
                    .done();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.541.1">
    } catch (IOException e) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.542.1">
        throw new RuntimeException(e);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.543.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.544.1">
}</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.545.1">private Player extractPlayer(Request request)</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.546.1">                                 throws IOException {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.547.1">    return new Gson().fromJson(request.body(),</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.548.1">                               Player.class);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.549.1">}</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.550.1">We have now completed the major part</span><a id="_idIndexMarker826"/><span class="koboSpan" id="kobo.551.1"> of the coding needed to start a game. </span><span class="koboSpan" id="kobo.551.2">To handle the remaining error condition, we can now test-drive the code to return </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">400 BAD REQUEST</span></strong><span class="koboSpan" id="kobo.553.1"> if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">Player</span></strong><span class="koboSpan" id="kobo.555.1"> object cannot be read from the JSON payload. </span><span class="koboSpan" id="kobo.555.2">We will omit that code here. </span><span class="koboSpan" id="kobo.555.3">In the next section, we will move on to test-driving the code for guessing the </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">target word.</span></span></p>
<h1 id="_idParaDest-309"><a id="_idTextAnchor318"/><span class="koboSpan" id="kobo.557.1">Playing the game</span></h1>
<p><span class="koboSpan" id="kobo.558.1">In this section, we will test-drive</span><a id="_idIndexMarker827"/><span class="koboSpan" id="kobo.559.1"> the code to play the game. </span><span class="koboSpan" id="kobo.559.2">This involves submitting</span><a id="_idIndexMarker828"/><span class="koboSpan" id="kobo.560.1"> multiple guess attempts to the endpoint until a game-over response </span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">is received.</span></span></p>
<p><span class="koboSpan" id="kobo.562.1">We start by creating an integration test for the new </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">/guess</span></strong><span class="koboSpan" id="kobo.564.1"> route in </span><span class="No-Break"><span class="koboSpan" id="kobo.565.1">our endpoint:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.566.1">The first step is to code the Arrange step. </span><span class="koboSpan" id="kobo.566.2">Our domain model provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">assess()</span></strong><span class="koboSpan" id="kobo.568.1"> method on </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">class Wordz</span></strong><span class="koboSpan" id="kobo.570.1"> to assess the score for a guess, along with reporting whether the game is over. </span><span class="koboSpan" id="kobo.570.2">To test-drive this, we set up the </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">mockWordz</span></strong><span class="koboSpan" id="kobo.572.1"> stub to return a valid </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">GuessResult</span></strong><span class="koboSpan" id="kobo.574.1"> object when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">assess()</span></strong><span class="koboSpan" id="kobo.576.1"> method </span><span class="No-Break"><span class="koboSpan" id="kobo.577.1">is called:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.578.1">@Test</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.579.1">void partiallyCorrectGuess() {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.580.1">    var score = new Score("-U---");</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.581.1">    score.assess("GUESS");</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.582.1">    var result = new GuessResult(score, false, false);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.583.1">    when(mockWordz.assess(eq(player), eq("GUESS")))</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.584.1">            .thenReturn(result);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.585.1">}</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.586.1">The Act step will call our endpoint</span><a id="_idIndexMarker829"/><span class="koboSpan" id="kobo.587.1"> with a web request submitting</span><a id="_idIndexMarker830"/><span class="koboSpan" id="kobo.588.1"> the guess. </span><span class="koboSpan" id="kobo.588.2">Our design decision is to send an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">POST</span></strong><span class="koboSpan" id="kobo.590.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">/guess</span></strong><span class="koboSpan" id="kobo.592.1"> route. </span><span class="koboSpan" id="kobo.592.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">request</span></strong><span class="koboSpan" id="kobo.594.1"> body will contain a JSON representation of the guessed word. </span><span class="koboSpan" id="kobo.594.2">To create this, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">record GuessRequest</span></strong><span class="koboSpan" id="kobo.596.1"> and use Gson to convert that into JSON </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">for us:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.598.1">
@Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.599.1">
void partiallyCorrectGuess() {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.600.1">
    var score = new Score("-U---");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.601.1">
    score.assess("GUESS");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.602.1">
    var result = new GuessResult(score, false, false);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.603.1">
    when(mockWordz.assess(eq(player), eq("GUESS")))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.604.1">
            .thenReturn(result);</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.605.1">    var guessRequest = new GuessRequest(player, "-U---");</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.606.1">    var body = new Gson().toJson(guessRequest);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.607.1">    var req = requestBuilder("guess")</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.608.1">            .POST(ofString(body))</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.609.1">            .build();</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.610.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.611.1">Next, we define </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">the record:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.613.1">
package com.wordz.adapters.api;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.614.1">
import com.wordz.domain.Player;</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.615.1">public record GuessRequest(Player player, String guess) {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.616.1">}</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.617.1">Then, we send the request</span><a id="_idIndexMarker831"/><span class="koboSpan" id="kobo.618.1"> over HTTP to our endpoint, awaiting</span><a id="_idIndexMarker832"/> <span class="No-Break"><span class="koboSpan" id="kobo.619.1">the response:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.620.1">
@Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.621.1">
void partiallyCorrectGuess() </span><strong class="bold"><span class="koboSpan" id="kobo.622.1">throws Exception</span></strong><span class="koboSpan" id="kobo.623.1"> {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.624.1">
    var score = new Score("-U---");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.625.1">
    score.assess("GUESS");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.626.1">
    var result = new GuessResult(score, false, false);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.627.1">
    when(mockWordz.assess(eq(player), eq("GUESS")))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.628.1">
            .thenReturn(result);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.629.1">
    var guessRequest = new GuessRequest(player, "-U---");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.630.1">
    var body = new Gson().toJson(guessRequest);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.631.1">
    var req = requestBuilder("guess")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.632.1">
            .POST(ofString(body))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.633.1">
            .build();</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.634.1">    var res</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.635.1">       = httpClient.send(req,</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.636.1">            HttpResponse.BodyHandlers.ofString());</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.637.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.638.1">Then, we extract the returned</span><a id="_idIndexMarker833"/><span class="koboSpan" id="kobo.639.1"> body data and assert it against</span><a id="_idIndexMarker834"/> <span class="No-Break"><span class="koboSpan" id="kobo.640.1">our expectations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.641.1">
@Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.642.1">
void partiallyCorrectGuess() throws Exception {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.643.1">
    var score = new Score("-U--G");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.644.1">
    score.assess("GUESS");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.645.1">
    var result = new GuessResult(score, false, false);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.646.1">
    when(mockWordz.assess(eq(player), eq("GUESS")))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.647.1">
            .thenReturn(result);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.648.1">
    var guessRequest = new GuessRequest(player,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.649.1">
                                        "-U--G");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.650.1">
    var body = new Gson().toJson(guessRequest);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.651.1">
    var req = requestBuilder("guess")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.652.1">
            .POST(ofString(body))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.653.1">
            .build();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.654.1">
    var res</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.655.1">
       = httpClient.send(req,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.656.1">
            HttpResponse.BodyHandlers.ofString());</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.657.1">    var response</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.658.1">       = new Gson().fromJson(res.body(),</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.659.1">                         GuessHttpResponse.class);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.660.1">    // Key to letters in scores():</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.661.1">    // C correct, P part correct, X incorrect</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.662.1">    Assertions.assertThat(response.scores())</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.663.1">        .isEqualTo("PCXXX");</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.664.1">    Assertions.assertThat(response.isGameOver())</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.665.1">        </span></strong><strong class="bold"><span class="koboSpan" id="kobo.666.1">.isFalse();</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.667.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.668.1">One API design decision</span><a id="_idIndexMarker835"/><span class="koboSpan" id="kobo.669.1"> here is to return the per-letter scores</span><a id="_idIndexMarker836"/><span class="koboSpan" id="kobo.670.1"> as a five-character </span><strong class="source-inline"><span class="koboSpan" id="kobo.671.1">String</span></strong><span class="koboSpan" id="kobo.672.1"> object. </span><span class="koboSpan" id="kobo.672.2">The single letters </span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">X</span></strong><span class="koboSpan" id="kobo.674.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">C</span></strong><span class="koboSpan" id="kobo.676.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">P</span></strong><span class="koboSpan" id="kobo.678.1"> are used to indicate incorrect, correct, and partially correct letters. </span><span class="koboSpan" id="kobo.678.2">We capture this decision in </span><span class="No-Break"><span class="koboSpan" id="kobo.679.1">the assertion.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.680.1">We define a record to represent the JSON data structure we will return as a response from </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">our endpoint:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.682.1">
package com.wordz.adapters.api;</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.683.1">public record GuessHttpResponse(String scores,</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.684.1">                                boolean isGameOver) {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.685.1">}</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.686.1">As we have decided to </span><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">POST</span></strong><span class="koboSpan" id="kobo.688.1"> to a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">/guess</span></strong><span class="koboSpan" id="kobo.690.1"> route, we need to add this route to the routing table. </span><span class="koboSpan" id="kobo.690.2">We also need to bind it to a method that will take action, which we will </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">call </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.692.1">guessWord()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.693.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.694.1">
public WordzEndpoint(Wordz wordz, String host,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.695.1">
                     int port) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.696.1">
    this.wordz = wordz;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.697.1">
    server = WebServer.create(host, port);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.698.1">
    try {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.699.1">
        server.route(new Routes() {{</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.700.1">
            post("/start")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.701.1">
                .to(request -&gt; startGame(request));</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.702.1">
            </span><strong class="bold"><span class="koboSpan" id="kobo.703.1">post("/guess")</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.704.1">                .to(request -&gt; guessWord(request));</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.705.1">
        }});</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.706.1">
    } catch (IOException e) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.707.1">
        throw new IllegalStateException(e);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.708.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.709.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.710.1">We add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">IllegalStateException</span></strong><span class="koboSpan" id="kobo.712.1"> to rethrow any problems that occur when starting the HTTP</span><a id="_idIndexMarker837"/><span class="koboSpan" id="kobo.713.1"> server. </span><span class="koboSpan" id="kobo.713.2">For this application, this exception</span><a id="_idIndexMarker838"/><span class="koboSpan" id="kobo.714.1"> may propagate upwards and cause the application to stop running. </span><span class="koboSpan" id="kobo.714.2">Without a working web server, none of the web code makes sense </span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">to run.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.716.1">We implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.717.1">guessWord()</span></strong><span class="koboSpan" id="kobo.718.1"> method with code to extract the </span><strong class="source-inline"><span class="koboSpan" id="kobo.719.1">request</span></strong><span class="koboSpan" id="kobo.720.1"> data from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.721.1">POST</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.722.1"> body:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.723.1">
private Response </span><strong class="bold"><span class="koboSpan" id="kobo.724.1">guessWord</span></strong><span class="koboSpan" id="kobo.725.1">(Request request) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.726.1">
    try {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.727.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.728.1">GuessRequest gr =</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.729.1">             extractGuessRequest(request);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.730.1">        return null ;</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.731.1">
    } catch (IOException e) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.732.1">
        throw new RuntimeException(e);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.733.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.734.1">
}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.735.1">
private GuessRequest </span><strong class="bold"><span class="koboSpan" id="kobo.736.1">extractGuessRequest</span></strong><span class="koboSpan" id="kobo.737.1">(Request request) throws IOException {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.738.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.739.1">return new Gson().fromJson(request.body(),</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.740.1">                               GuessRequest.class);</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.741.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.742.1">Now we have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">request</span></strong><span class="koboSpan" id="kobo.744.1"> data, it’s time to call our domain </span><a id="_idIndexMarker839"/><span class="koboSpan" id="kobo.745.1">layer to do the real</span><a id="_idIndexMarker840"/><span class="koboSpan" id="kobo.746.1"> work. </span><span class="koboSpan" id="kobo.746.2">We will capture the </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">GuessResult</span></strong><span class="koboSpan" id="kobo.748.1"> object returned, so we can base our HTTP response from the endpoint </span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">on it:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.750.1">
private Response guessWord(Request request) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.751.1">
    try {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.752.1">
        GuessRequest gr =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.753.1">
             extractGuessRequest(request);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.754.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.755.1">GuessResult result</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.756.1">                = wordz.assess(gr.player(),</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.757.1">                  gr.guess());</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.758.1">
        return null;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.759.1">
    } catch (IOException e) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.760.1">
        throw new RuntimeException(e);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.761.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.762.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.763.1">We choose to return a different format of data from our endpoint compared to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">GuessResult</span></strong><span class="koboSpan" id="kobo.765.1"> object returned</span><a id="_idIndexMarker841"/><span class="koboSpan" id="kobo.766.1"> from our domain model. </span><span class="koboSpan" id="kobo.766.2">We will need to transform the result</span><a id="_idIndexMarker842"/><span class="koboSpan" id="kobo.767.1"> from the </span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">domain model:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.769.1">
private Response guessWord(Request request) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.770.1">
    try {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.771.1">
        GuessRequest gr =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.772.1">
            extractGuessRequest(request);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.773.1">
        GuessResult result = wordz.assess(gr.player(),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.774.1">
                             gr.guess());</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.775.1">        return Response.ok()</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.776.1">                .body(createGuessHttpResponse(result))</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.777.1">                .done();</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.778.1">
    } catch (IOException e) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.779.1">
        throw new RuntimeException(e);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.780.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.781.1">
}</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.782.1">private String createGuessHttpResponse(GuessResult result) {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.783.1">    </span></strong><strong class="bold"><span class="koboSpan" id="kobo.784.1">GuessHttpResponse httpResponse</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.785.1">          = new</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.786.1">            GuessHttpResponseMapper().from(result);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.787.1">    return new Gson().toJson(httpResponse);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.788.1">}</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.789.1">We add an empty version</span><a id="_idIndexMarker843"/><span class="koboSpan" id="kobo.790.1"> of the object doing</span><a id="_idIndexMarker844"/><span class="koboSpan" id="kobo.791.1"> the transformation, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.792.1">class GuessHttpResponseMapper</span></strong><span class="koboSpan" id="kobo.793.1">. </span><span class="koboSpan" id="kobo.793.2">In this first step, it will simply </span><span class="No-Break"><span class="koboSpan" id="kobo.794.1">return </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.795.1">null</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.797.1">
package com.wordz.adapters.api;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.798.1">
import com.wordz.domain.GuessResult;</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.799.1">public class GuessHttpResponseMapper {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.800.1">    public GuessHttpResponse from(GuessResult result) {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.801.1">        </span></strong><strong class="bold"><span class="koboSpan" id="kobo.802.1">return null;</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.803.1">    }</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.804.1">}</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.805.1">This is enough to compile and be able to run the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.806.1">WordzEndpointTest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.807.1"> test:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer131">
<span class="koboSpan" id="kobo.808.1"><img alt="Figure 15.8 – The test fails" src="image/Figure_15.08_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.809.1">Figure 15.8 – The test fails</span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.810.1">With a failing test in place, we can now test-drive the details of the transform class. </span><span class="koboSpan" id="kobo.810.2">To do this, we switch to adding a new unit test called </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.811.1">class GuessHttpResponseMapperTest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.813.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.814.1">The details of this are omitted but can be found on GitHub – it follows the standard approach used throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.815.1">the book.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.816.1">Once we have test-driven the detailed implementation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">class GuessHttpResponseMapper</span></strong><span class="koboSpan" id="kobo.818.1">, we can rerun the </span><span class="No-Break"><span class="koboSpan" id="kobo.819.1">integration test:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer132">
<span class="koboSpan" id="kobo.820.1"><img alt="Figure 15.9 – The endpoint test passes" src="image/Figure_15.09_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.821.1">Figure 15.9 – The endpoint test passes</span></p>
<p><span class="koboSpan" id="kobo.822.1">As we see in the</span><a id="_idIndexMarker845"/><span class="koboSpan" id="kobo.823.1"> preceding image, the integration test has passed! </span><span class="koboSpan" id="kobo.823.2">Time for a well-earned coffee</span><a id="_idIndexMarker846"/><span class="koboSpan" id="kobo.824.1"> break. </span><span class="koboSpan" id="kobo.824.2">Well, mine’s a nice English breakfast tea, but that’s just me. </span><span class="koboSpan" id="kobo.824.3">After that, we can test-drive the response to any errors that occurred. </span><span class="koboSpan" id="kobo.824.4">Then it’s time to bring the microservice together. </span><span class="koboSpan" id="kobo.824.5">In the next section, we will assemble our application into a </span><span class="No-Break"><span class="koboSpan" id="kobo.825.1">running microservice.</span></span></p>
<h1 id="_idParaDest-310"><a id="_idTextAnchor319"/><span class="koboSpan" id="kobo.826.1">Integrating the application</span></h1>
<p><span class="koboSpan" id="kobo.827.1">In this section, we will bring together</span><a id="_idIndexMarker847"/><span class="koboSpan" id="kobo.828.1"> the components of our test-driven application. </span><span class="koboSpan" id="kobo.828.2">We will form a microservice that runs our endpoint and provides the frontend web interface to our service. </span><span class="koboSpan" id="kobo.828.3">It will use the Postgres database </span><span class="No-Break"><span class="koboSpan" id="kobo.829.1">for storage.</span></span></p>
<p><span class="koboSpan" id="kobo.830.1">We need to write a short </span><strong class="source-inline"><span class="koboSpan" id="kobo.831.1">main()</span></strong><span class="koboSpan" id="kobo.832.1"> method to link together the major components of our code. </span><span class="koboSpan" id="kobo.832.2">This will involve creating concrete objects and injecting dependencies into constructors. </span><span class="koboSpan" id="kobo.832.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.833.1">main()</span></strong><span class="koboSpan" id="kobo.834.1"> method exists on </span><strong class="source-inline"><span class="koboSpan" id="kobo.835.1">class WordzApplication</span></strong><span class="koboSpan" id="kobo.836.1">, which is the entry point to our fully integrated </span><span class="No-Break"><span class="koboSpan" id="kobo.837.1">web service:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.838.1">
package com.wordz;
import com.wordz.adapters.api.WordzEndpoint;
import com.wordz.adapters.db.GameRepositoryPostgres;
import com.wordz.adapters.db.WordRepositoryPostgres;
import com.wordz.domain.Wordz;
public class WordzApplication {
    public static void main(String[] args) {
        var config = new WordzConfiguration(args);
        new WordzApplication().run(config);
    }
    private void run(WordzConfiguration config) {
        var gameRepository
         = new GameRepositoryPostgres(config.getDataSource());
        var wordRepository
         = new WordRepositoryPostgres(config.getDataSource());
        var randomNumbers = new ProductionRandomNumbers();
        var wordz = new Wordz(gameRepository,
                              wordRepository,
                              randomNumbers);
        var api = new WordzEndpoint(wordz,
                                    config.getEndpointHost(),
                                    config.getEndpointPort());
        waitUntilTerminated();
    }
    private void waitUntilTerminated() {
        try {
            while (true) {
                Thread.sleep(10000);
            }
        } catch (InterruptedException e) {
            return;
        }
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.839.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.840.1">main()</span></strong><span class="koboSpan" id="kobo.841.1"> method instantiates</span><a id="_idIndexMarker848"/><span class="koboSpan" id="kobo.842.1"> the domain model, and dependency injects the concrete version of our adapter classes into it. </span><span class="koboSpan" id="kobo.842.2">One notable detail is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.843.1">waitUntilTerminated()</span></strong><span class="koboSpan" id="kobo.844.1">method. </span><span class="koboSpan" id="kobo.844.2">This prevents </span><strong class="source-inline"><span class="koboSpan" id="kobo.845.1">main()</span></strong><span class="koboSpan" id="kobo.846.1"> from terminating until the application is closed down. </span><span class="koboSpan" id="kobo.846.2">This, in turn, keeps the HTTP endpoint responding </span><span class="No-Break"><span class="koboSpan" id="kobo.847.1">to requests.</span></span></p>
<p><span class="koboSpan" id="kobo.848.1">Configuration data for the application is held in </span><strong class="source-inline"><span class="koboSpan" id="kobo.849.1">class WordzConfiguration</span></strong><span class="koboSpan" id="kobo.850.1">. </span><span class="koboSpan" id="kobo.850.2">This has default settings for the endpoint host and port settings, along with database connection settings. </span><span class="koboSpan" id="kobo.850.3">These can also be passed in as command line arguments. </span><span class="koboSpan" id="kobo.850.4">The class and its associated test can be seen in the GitHub code for </span><span class="No-Break"><span class="koboSpan" id="kobo.851.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.852.1">In the next section, we will use the Wordz web service application using the popular HTTP testing </span><span class="No-Break"><span class="koboSpan" id="kobo.853.1">tool, Postman.</span></span></p>
<h1 id="_idParaDest-311"><a id="_idTextAnchor320"/><span class="koboSpan" id="kobo.854.1">Using the application</span></h1>
<p><span class="koboSpan" id="kobo.855.1">To use our newly assembled</span><a id="_idIndexMarker849"/><span class="koboSpan" id="kobo.856.1"> web application, first ensure that the database setup steps and the Postman installation described in the </span><em class="italic"><span class="koboSpan" id="kobo.857.1">Technical requirements</span></em><span class="koboSpan" id="kobo.858.1"> section have been successfully completed. </span><span class="koboSpan" id="kobo.858.2">Then run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.859.1">main()</span></strong><span class="koboSpan" id="kobo.860.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">class</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.862.1">WordzApplication</span></strong><span class="koboSpan" id="kobo.863.1"> in IntelliJ. </span><span class="koboSpan" id="kobo.863.2">That starts the endpoint, ready to </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">accept requests.</span></span></p>
<p><span class="koboSpan" id="kobo.865.1">Once the service is running, the way we interact with it is by sending HTTP requests to the endpoint. </span><span class="koboSpan" id="kobo.865.2">Launch Postman and (on macOS) a window that looks like this </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">will appear:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer133">
<span class="koboSpan" id="kobo.867.1"><img alt="Figure 15.10 – Postman home screen" src="image/Figure_15.10_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.868.1">Figure 15.10 – Postman home screen</span></p>
<p><span class="koboSpan" id="kobo.869.1">We first need to start a game. </span><span class="koboSpan" id="kobo.869.2">To do that, we need</span><a id="_idIndexMarker850"/><span class="koboSpan" id="kobo.870.1"> to send HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.871.1">POST</span></strong><span class="koboSpan" id="kobo.872.1"> requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">/start</span></strong><span class="koboSpan" id="kobo.874.1"> route on our endpoint. </span><span class="koboSpan" id="kobo.874.2">By default, this will be available at </span><strong class="source-inline"><span class="koboSpan" id="kobo.875.1">http://localhost:8080/start</span></strong><span class="koboSpan" id="kobo.876.1">. </span><span class="koboSpan" id="kobo.876.2">We need to send a body, containing the JSON </span><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">{"</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">name":"testuser"}</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.879.1"> text.</span></span></p>
<p><span class="koboSpan" id="kobo.880.1">We can send this request from Postman. </span><span class="koboSpan" id="kobo.880.2">We click the </span><strong class="bold"><span class="koboSpan" id="kobo.881.1">Create a request</span></strong><span class="koboSpan" id="kobo.882.1"> button on the home page. </span><span class="koboSpan" id="kobo.882.2">This takes us to a view where we can enter the URL, select the </span><strong class="bold"><span class="koboSpan" id="kobo.883.1">POST</span></strong><span class="koboSpan" id="kobo.884.1"> method and type our JSON </span><span class="No-Break"><span class="koboSpan" id="kobo.885.1">body data:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.886.1">Create a </span><strong class="bold"><span class="koboSpan" id="kobo.887.1">POST</span></strong><span class="koboSpan" id="kobo.888.1"> request to start </span><span class="No-Break"><span class="koboSpan" id="kobo.889.1">the game:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer134">
<span class="koboSpan" id="kobo.890.1"><img alt="Figure 15.11 – Start a new game" src="image/Figure_15.11_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.891.1">Figure 15.11 – Start a new game</span></p>
<p><span class="koboSpan" id="kobo.892.1">Click the blue </span><strong class="bold"><span class="koboSpan" id="kobo.893.1">Send</span></strong><span class="koboSpan" id="kobo.894.1"> button. </span><span class="koboSpan" id="kobo.894.2">The screenshot in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.895.1">Figure 15</span></em></span><em class="italic"><span class="koboSpan" id="kobo.896.1">.11</span></em><span class="koboSpan" id="kobo.897.1"> shows both the request that was sent – in the upper portion</span><a id="_idIndexMarker851"/><span class="koboSpan" id="kobo.898.1"> of the screen – and the response. </span><span class="koboSpan" id="kobo.898.2">In this case, the game was successfully started for the player named </span><strong class="source-inline"><span class="koboSpan" id="kobo.899.1">testuser</span></strong><span class="koboSpan" id="kobo.900.1">. </span><span class="koboSpan" id="kobo.900.2">The endpoint performed as expected and sent an HTTP status code of </span><strong class="source-inline"><span class="koboSpan" id="kobo.901.1">204 No Content</span></strong><span class="koboSpan" id="kobo.902.1">. </span><span class="koboSpan" id="kobo.902.2">This can be seen in the response panel, towards the bottom of </span><span class="No-Break"><span class="koboSpan" id="kobo.903.1">the screenshot.</span></span></p>
<p><span class="koboSpan" id="kobo.904.1">A quick check of the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">game</span></strong><span class="koboSpan" id="kobo.906.1"> table in the database shows that a row for this game has </span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">been created:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.908.1">wordzdb=# select * from game;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.909.1"> player_name | word  | attempt_number | is_game_over</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.910.1">-------------+-------+----------------+--------------</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.911.1"> testuser    | ARISE |              0 | f</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.912.1">(1 row)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.913.1">wordzdb=#</span></strong></pre>
<ol>
<li value="2"><span class="koboSpan" id="kobo.914.1">We can now make our first guess</span><a id="_idIndexMarker852"/><span class="koboSpan" id="kobo.915.1"> at the word. </span><span class="koboSpan" id="kobo.915.2">Let’s try a guess of </span><strong class="source-inline"><span class="koboSpan" id="kobo.916.1">"STARE"</span></strong><span class="koboSpan" id="kobo.917.1">. </span><span class="koboSpan" id="kobo.917.2">The </span><strong class="bold"><span class="koboSpan" id="kobo.918.1">POST</span></strong><span class="koboSpan" id="kobo.919.1"> request for this and the response from our endpoint appears, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.920.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer135">
<span class="koboSpan" id="kobo.921.1"><img alt="Figure 15.12 – Score returned" src="image/Figure_15.12_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.922.1">Figure 15.12 – Score returned</span></p>
<p><span class="koboSpan" id="kobo.923.1">The endpoint returns an HTTP status code of </span><strong class="source-inline"><span class="koboSpan" id="kobo.924.1">200 OK</span></strong><span class="koboSpan" id="kobo.925.1">. </span><span class="koboSpan" id="kobo.925.2">This time, a body of JSON formatted data is returned. </span><span class="koboSpan" id="kobo.925.3">We see </span><strong class="source-inline"><span class="koboSpan" id="kobo.926.1">"scores":"PXPPC"</span></strong><span class="koboSpan" id="kobo.927.1"> indicating that the first letter of our guess, </span><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">S</span></strong><span class="koboSpan" id="kobo.929.1">, appears in the word somewhere but not in the first position. </span><span class="koboSpan" id="kobo.929.2">The second letter of our guess, </span><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">T</span></strong><span class="koboSpan" id="kobo.931.1">, is incorrect and does not appear in the target word. </span><span class="koboSpan" id="kobo.931.2">We got two more part-correct letters and one final correct letter in our guess, which was the letter </span><strong class="source-inline"><span class="koboSpan" id="kobo.932.1">E</span></strong><span class="koboSpan" id="kobo.933.1"> at </span><span class="No-Break"><span class="koboSpan" id="kobo.934.1">the end.</span></span></p>
<p><span class="koboSpan" id="kobo.935.1">The response also shows </span><strong class="source-inline"><span class="koboSpan" id="kobo.936.1">"isGameOver":false</span></strong><span class="koboSpan" id="kobo.937.1">. </span><span class="koboSpan" id="kobo.937.2">We haven’t finished the </span><span class="No-Break"><span class="koboSpan" id="kobo.938.1">game yet.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.939.1">We will make one more guess, cheating slightly. </span><span class="koboSpan" id="kobo.939.2">Let’s send a </span><strong class="bold"><span class="koboSpan" id="kobo.940.1">POST</span></strong><span class="koboSpan" id="kobo.941.1"> request with a guess </span><span class="No-Break"><span class="koboSpan" id="kobo.942.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">"ARISE"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.944.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer136">
<span class="koboSpan" id="kobo.945.1"><img alt="Figure 15.13 – A successful guess" src="image/Figure_15.13_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.946.1">Figure 15.13 – A successful guess</span></p>
<p><span class="koboSpan" id="kobo.947.1">Winner! </span><span class="koboSpan" id="kobo.947.2">We see </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">"scores":"CCCCC"</span></strong><span class="koboSpan" id="kobo.949.1"> telling us all five letters of our guess are correct. </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">"isGameOver":true</span></strong><span class="koboSpan" id="kobo.951.1"> tells us that </span><a id="_idIndexMarker853"/><span class="koboSpan" id="kobo.952.1">our game has ended, on this </span><span class="No-Break"><span class="koboSpan" id="kobo.953.1">occasion, successfully.</span></span></p>
<p><span class="koboSpan" id="kobo.954.1">We’ve successfully played one game of Wordz using </span><span class="No-Break"><span class="koboSpan" id="kobo.955.1">our microservice.</span></span></p>
<h1 id="_idParaDest-312"><a id="_idTextAnchor321"/><span class="koboSpan" id="kobo.956.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.957.1">In this section, we have completed our Wordz application. </span><span class="koboSpan" id="kobo.957.2">We used an integration test with TDD to drive out an HTTP endpoint for Wordz. </span><span class="koboSpan" id="kobo.957.3">We used open source HTTP libraries – Molecule, Gson, and Undertow. </span><span class="koboSpan" id="kobo.957.4">We made effective use of hexagonal architecture. </span><span class="koboSpan" id="kobo.957.5">Using ports and adapters, these frameworks became an implementation detail rather than a defining feature of </span><span class="No-Break"><span class="koboSpan" id="kobo.958.1">our design.</span></span></p>
<p><span class="koboSpan" id="kobo.959.1">We assembled our final application to bring together the business logic held in the domain layer with the Postgres database adapter and the HTTP endpoint adapter. </span><span class="koboSpan" id="kobo.959.2">Working together, our application forms a </span><span class="No-Break"><span class="koboSpan" id="kobo.960.1">small microservice.</span></span></p>
<p><span class="koboSpan" id="kobo.961.1">In this final chapter, we have arrived at a small-scale yet typical microservice comprising an HTTP API and a SQL database. </span><span class="koboSpan" id="kobo.961.2">We’ve developed the code test first, using tests to guide our design choices. </span><span class="koboSpan" id="kobo.961.3">We have applied the SOLID principles to improve how our software fits together. </span><span class="koboSpan" id="kobo.961.4">We have learned how the ports and adapters of hexagonal architecture simplify the design of code that works with external systems. </span><span class="koboSpan" id="kobo.961.5">Using hexagonal architecture is a natural fit for TDD, allowing us to develop our core application logic with FIRST unit tests. </span><span class="koboSpan" id="kobo.961.6">We have created both a database adapter and an HTTP adapter test first, using integration tests. </span><span class="koboSpan" id="kobo.961.7">We applied the rhythms of TDD – Red, Green, Refactor and Arrange, Act and Assert to our work. </span><span class="koboSpan" id="kobo.961.8">We have applied test doubles using the Mockito library to stand in for external systems, simplifying </span><span class="No-Break"><span class="koboSpan" id="kobo.962.1">the development.</span></span></p>
<p><span class="koboSpan" id="kobo.963.1">In this book, we have covered a wide range of TDD and software design techniques. </span><span class="koboSpan" id="kobo.963.2">We can now create code with fewer defects, and that is safer and easier to </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">work with.</span></span></p>
<h1 id="_idParaDest-313"><a id="_idTextAnchor322"/><span class="koboSpan" id="kobo.965.1">Questions and answers</span></h1>
<ol>
<li value="1"><span class="koboSpan" id="kobo.966.1">What further work could </span><span class="No-Break"><span class="koboSpan" id="kobo.967.1">be done?</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.968.1">Further work could include adding a </span><strong class="bold"><span class="koboSpan" id="kobo.969.1">Continuous Integration (CI)</span></strong><span class="koboSpan" id="kobo.970.1"> pipeline so that whenever we commit code, the application gets pulled from source control, built, and all tests run. </span><span class="koboSpan" id="kobo.970.2">We could consider deployment and automation of that. </span><span class="koboSpan" id="kobo.970.3">One example might be to package up the Wordz application and the Postgres database as a Docker image. </span><span class="koboSpan" id="kobo.970.4">It would be good to add database schema automation, using a tool such </span><span class="No-Break"><span class="koboSpan" id="kobo.971.1">as Flyway.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.972.1">Could we replace the Molecule library and use something else for our </span><span class="No-Break"><span class="koboSpan" id="kobo.973.1">web endpoint?</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.974.1">Yes. </span><span class="koboSpan" id="kobo.974.2">As the web endpoint sits in our adapter layer of the hexagonal architecture, it does not affect the core functionality in the domain model. </span><span class="koboSpan" id="kobo.974.3">Any suitable web framework could </span><span class="No-Break"><span class="koboSpan" id="kobo.975.1">be used.</span></span></p>
<h1 id="_idParaDest-314"><a id="_idTextAnchor323"/><span class="koboSpan" id="kobo.976.1">Further reading</span></h1>
<ul>
<li><a href="B18384_15.xhtml#_idTextAnchor321"><span class="No-Break"><span class="koboSpan" id="kobo.977.1">https://martinfowler.com/articles/richardsonMaturityModel.html</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.978.1">An overview of what a REST web interface means, along with some </span><span class="No-Break"><span class="koboSpan" id="kobo.979.1">common variations</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.980.1">Java OOP Done Right</span></em><span class="koboSpan" id="kobo.981.1">, Alan Mellor, </span><span class="No-Break"><span class="koboSpan" id="kobo.982.1">ISBN 9781527284449</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.983.1">The author’s book gives some more details on OO basics with some useful </span><span class="No-Break"><span class="koboSpan" id="kobo.984.1">design patterns</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.985.1">https://www.postman.com/</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.986.1">A popular testing tool that sends HTTP requests and </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">displays responses</span></span></p>
<ul>
<li><a href="B18384_15.xhtml#_idTextAnchor319"><span class="No-Break"><span class="koboSpan" id="kobo.988.1">http://molecule.vtence.com/</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.989.1">A lightweight HTTP framework </span><span class="No-Break"><span class="koboSpan" id="kobo.990.1">for Java</span></span></p>
<ul>
<li><a href="B18384_15.xhtml#_idTextAnchor318"><span class="No-Break"><span class="koboSpan" id="kobo.991.1">https://undertow.io/</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.992.1">An HTTP server for Java that works well with the </span><span class="No-Break"><span class="koboSpan" id="kobo.993.1">Molecule framework</span></span></p>
<ul>
<li><a href="B18384_15.xhtml#_idTextAnchor317"><span class="No-Break"><span class="koboSpan" id="kobo.994.1">https://github.com/google/gson</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.995.1">Google’s library to convert between Java objects and the </span><span class="No-Break"><span class="koboSpan" id="kobo.996.1">JSON format</span></span></p>
<ul>
<li><a href="B18384_15.xhtml#_idTextAnchor316"><span class="No-Break"><span class="koboSpan" id="kobo.997.1">https://aws.amazon.com/what-is/restful-api/</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.998.1">Amazon’s guide to </span><span class="No-Break"><span class="koboSpan" id="kobo.999.1">REST APIs</span></span></p>
<ul>
<li><a href="B18384_15.xhtml#_idTextAnchor315"><span class="No-Break"><span class="koboSpan" id="kobo.1000.1">https://docs.oracle.com/en/java/javase/12/docs/api/java.net.http/java/net/http/HttpClient.html</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.1001.1">Official Java documentation about the test HHTP client used in </span><span class="No-Break"><span class="koboSpan" id="kobo.1002.1">this chapter</span></span></p>
</div>
</body></html>