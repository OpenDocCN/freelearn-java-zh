- en: Chapter 4. Marvel Dashboard
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The previous two chapters covered Elasticsearch-head and Bigdesk, two open source
    monitoring tools. This chapter covers Marvel, a non-free tool for monitoring Elasticsearch.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: 'Unlike Elasticsearch-head and Bigdesk, Marvel continuously captures and saves
    performance metrics to an index. This lets users refer to historical data for
    analysis, as opposed to just real-time data analysis. In this chapter, we will
    look a bit closer at the following topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Setting up Marvel
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Upgrading Marvel
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configuring Marvel
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Marvel index configuration
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Marvel dashboard
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Monitoring node failures
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Setting up Marvel
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: See [Chapter 2](ch02.html "Chapter 2. Installation and the Requirements for
    Elasticsearch"), *Installation and the Requirements for Elasticsearch*, for instructions
    on how to install the Marvel Agent and the Marvel Kibana dashboard.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: 'Marvel stores its metrics data inside Elasticsearch. It is possible to store
    these metrics alongside production data in the same Elasticsearch cluster; however,
    this is inadvisable because:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: Marvel's data indices can grow quite large and, in a production setting, you
    won't want these indices affecting the performance of your primary cluster.
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the primary cluster is experiencing issues, having Marvel on a separate cluster
    will allow you to more easily diagnose those issues.
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If Marvel is running on a normal data node, it can inadvertently be configured
    to collect data on its own metrics indices. For example, if you log in to the
    Marvel dashboard and start querying the Marvel indices, these queries will then
    be logged back to the Marvel indices. This is probably not the intended behavior.
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'For these reasons, this chapter covers how to set up a separate Elasticsearch
    cluster for storing Marvel metrics data. Our primary Elasticsearch cluster from
    the last chapter contains three data nodes: `elasticsearch-node-01`, `elasticsearch-node-02`,
    and `elasticsearch-node-03`. We''ll add a new cluster with a single Elasticsearch
    node to store Marvel''s data.'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: 'Follow these steps to create a new Elasticsearch cluster for Marvel data:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: On a new host called `elasticsearch-marvel-01`, install Elasticsearch 2.3.2
    using the instructions from [Chapter 2](ch02.html "Chapter 2. Installation and
    the Requirements for Elasticsearch"), *Installation and the Requirements for Elasticsearch*.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Configure Elasticsearch by editing the `elasticsearch.yml` configuration file
    to look like this:'
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-19
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Install Elasticsearch-head on `elasticsearch-marvel-01`:'
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-21
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Install the Marvel Agent on the three primary Elasticsearch nodes (`elasticsearch-node-01`,
    `elasticsearch-node-02`, and `elasticsearch-node-03`). Log in to each host and
    run the following command to install Marvel:'
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-23
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Tip
  id: totrans-24
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
- en: As mentioned in [Chapter 2](ch02.html "Chapter 2. Installation and the Requirements
    for Elasticsearch"), *Installation and the Requirements for Elasticsearch*, make
    sure to restart each node after installing Marvel, in order to get the Marvel
    agent started.
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Add the following lines of configuration to the `elasticsearch.yml` in each
    of the original three `elasticsearch-node-0*` nodes:'
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下配置行添加到原始三个 `elasticsearch-node-0*` 节点上的 `elasticsearch.yml`：
- en: '[PRE3]'
  id: totrans-27
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'For a larger Marvel cluster with three nodes, for example, the configuration
    line might look like this:'
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于具有三个节点的较大 Marvel 集群，例如，配置行可能看起来像这样：
- en: '[PRE4]'
  id: totrans-29
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Install Kibana and the Marvel Kibana plugin on `elasticsearch-marvel-01` using
    the instructions found in [Chapter 2](ch02.html "Chapter 2. Installation and the
    Requirements for Elasticsearch"), *Installation and the Requirements for Elasticsearch*.
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 根据 [第 2 章](ch02.html "第 2 章。Elasticsearch 的安装和需求") 中找到的说明，在 `elasticsearch-marvel-01`
    上安装 Kibana 和 Marvel Kibana 插件，*Elasticsearch 的安装和需求*。
- en: 'Configure the Marvel Kibana plugin by editing `config/kibana.yml` to look like
    this:'
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过编辑 `config/kibana.yml` 来配置 Marvel Kibana 插件，使其看起来像这样：
- en: '[PRE5]'
  id: totrans-32
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Start Kibana on `elasticsearch-marvel-01` from the Kibana installation directory
    with the following command:'
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令从 Kibana 安装目录启动 `elasticsearch-marvel-01` 上的 Kibana：
- en: '[PRE6]'
  id: totrans-34
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'The output from this command should look like this:'
  id: totrans-35
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此命令的输出应如下所示：
- en: '![Setting up Marvel](img/B03798_04_01.jpg)'
  id: totrans-36
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![设置 Marvel](img/B03798_04_01.jpg)'
- en: Visit the Marvel dashboard on `elasticsearch-marvel-01` in a browser by going
    to `http://elasticsearch-marvel-01:5601/app/marvel`, as seen in the following
    screenshot:![Setting up Marvel](img/B03798_04_02.jpg)
  id: totrans-37
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过访问 `http://elasticsearch-marvel-01:5601/app/marvel` 在浏览器中访问 `elasticsearch-marvel-01`
    上的 Marvel 仪表板，如以下截图所示：![设置 Marvel](img/B03798_04_02.jpg)
- en: Scroll down the page and click the **Show History** or **Hide History** button
    (highlighted in the next screenshot) to view shard activity for the `twitter`
    index:![Setting up Marvel](img/B03798_04_03.jpg)
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 滚动页面并单击 **显示历史记录** 或 **隐藏历史记录** 按钮（如下一张截图所示）以查看 `twitter` 索引的分片活动：![设置 Marvel](img/B03798_04_03.jpg)
- en: Open Elasticsearch-head on `elasticsearch-marvel-01` and view the indices automatically
    created by Marvel by visiting `http://elasticsearch-marvel-01:9200/_plugin/head/`:![Setting
    up Marvel](img/B03798_04_04.jpg)
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `elasticsearch-marvel-01` 上打开 Elasticsearch-head 并通过访问 `http://elasticsearch-marvel-01:9200/_plugin/head/`
    查看Marvel自动创建的索引：![设置 Marvel](img/B03798_04_04.jpg)
- en: The `.marvel-2015.12.20` index contains historical data collected by Marvel.
    By default, Marvel creates one new index per day to store its data.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: '`.marvel-2015.12.20` 索引包含 Marvel 收集的历史数据。默认情况下，Marvel 每天创建一个新的索引来存储其数据。'
- en: Note
  id: totrans-41
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '**Server time synchronization**'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: '**服务器时间同步**'
- en: 'The clocks on all Elasticsearch hosts must be synchronized or Marvel won''t
    show any data. Clock synchronization varies depending on server setup. On a cluster
    of Ubuntu hosts, run this command on all nodes to synchronize their clocks:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 所有 Elasticsearch 主机上的时钟必须同步，否则 Marvel 不会显示任何数据。时钟同步取决于服务器配置。在 Ubuntu 主机集群上，请在所有节点上运行以下命令以同步它们的时钟：
- en: '[PRE7]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Upgrading Marvel
  id: totrans-45
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 升级 Marvel
- en: Marvel can be upgraded on a rolling basis. This means that nodes are upgraded
    one at a time rather than having to shut down the entire cluster to perform an
    upgrade. For environments with a monitoring cluster and a production cluster,
    upgrade Marvel on the monitoring cluster before upgrading it on the production
    cluster.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: Marvel 可以滚动升级。这意味着节点是一个接一个地升级，而不是必须关闭整个集群以执行升级。对于具有监控集群和生产集群的环境，请在升级生产集群之前先在监控集群上升级
    Marvel。
- en: 'To upgrade the Marvel Agent, run these steps on all nodes in the monitoring
    cluster (in this case, just `elasticsearch-marvel-01`), then for each node in
    the production cluster (`elasticsearch-node-01`, `elasticsearch-node-02`, and
    `elasticsearch-node-03`):'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 要升级 Marvel Agent，请在监控集群（在这种情况下，仅为 `elasticsearch-marvel-01`）的所有节点上运行以下步骤，然后对于生产集群（`elasticsearch-node-01`、`elasticsearch-node-02`
    和 `elasticsearch-node-03`）中的每个节点：
- en: 'Optional: Disable shard allocation on all nodes.'
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 可选：在所有节点上禁用分片分配。
- en: Tip
  id: totrans-49
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: Disabling shard allocation will make the upgrade faster because the cluster
    won't try to reallocate shards to other nodes when the node goes down for an upgrade.
  id: totrans-50
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 禁用分片分配将使升级更快，因为当节点因升级而关闭时，集群不会尝试将分片重新分配到其他节点。
- en: 'Run the following command:'
  id: totrans-51
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 运行以下命令：
- en: '[PRE8]'
  id: totrans-52
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Stop Elasticsearch:'
  id: totrans-53
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 停止 Elasticsearch：
- en: '[PRE9]'
  id: totrans-54
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Remove the old Marvel plugin:'
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 删除旧的 Marvel 插件：
- en: '[PRE10]'
  id: totrans-56
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Install the new Marvel plugin:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装新的 Marvel 插件：
- en: '[PRE11]'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Start Elasticsearch:'
  id: totrans-59
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动 Elasticsearch：
- en: '[PRE12]'
  id: totrans-60
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Check logs for errors:'
  id: totrans-61
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 检查日志以查找错误：
- en: '[PRE13]'
  id: totrans-62
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Once all nodes in the cluster are upgraded, re-enable shard allocation:'
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦集群中的所有节点都升级完成，重新启用分片分配：
- en: '[PRE14]'
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Repeat all of these steps for the production cluster.
  id: totrans-65
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对生产集群重复所有这些步骤。
- en: To upgrade the Marvel Kibana dashboard, run the following commands on `elasticsearch-marvel-01`
  id: totrans-66
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Uninstall the old Marvel Kibana plugin with the following command:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-68
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Install the new Marvel Kibana plugin. In this example, we are upgrading to
    Marvel 2.3.2:'
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-70
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Configuring Marvel
  id: totrans-71
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'This section covers how to configure the Marvel Agent and data index. Specifically,
    we cover:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: Setting the Marvel data store location
  id: totrans-73
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Specifying which indices to monitor
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Security settings
  id: totrans-75
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Data export frequency
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Marvel index configuration
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Marvel agent configuration settings
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This section covers configuring the Marvel Agent. Configure the Agent by editing
    the `elasticsearch.yml` file on each node we are monitoring.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: 'The `marvel.agent.exporters` setting determines where the Agent will deliver
    its metrics to. By default, the Marvel agent will export data to the same Elasticsearch
    instance that it is installed on. In our example cluster, we are exporting data
    to `elasticsearch-marvel-01`, and the configuration value looks like this:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Other options for the `marvel.agent.exporters` settings include:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Other `elasticsearch.yml` configuration options are described here:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: '| Option | Default Value | Description |'
  id: totrans-85
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  id: totrans-86
  prefs: []
  type: TYPE_TB
- en: '| `marvel.enabled` | `true` | Controls whether monitoring data will be exported
    from this node. |'
  id: totrans-87
  prefs: []
  type: TYPE_TB
- en: '| `marvel.agent.interval` | `10s` | Time interval between monitoring data exports.
    Can be set to `-1` to disable exporting of data altogether. |'
  id: totrans-88
  prefs: []
  type: TYPE_TB
- en: '| `marvel.agent.indices` | `_all List of` | Indices to export data from. Supports
    wildcard `*`, addition `+`, and subtraction `-` operators. For example, to export
    data only from nodes that start with `twitter_`, except for the index `twitter_development`,
    we would set this parameter to `+twitter_*,-twitter_development`. |'
  id: totrans-89
  prefs: []
  type: TYPE_TB
- en: '| `marvel.agent.cluster.state.timeout` | `10m` | Timeout for collecting cluster
    state. |'
  id: totrans-90
  prefs: []
  type: TYPE_TB
- en: '| `marvel.agent.cluster.stats.timeout` | `10m` | Timeout for collecting cluster
    statistics. |'
  id: totrans-91
  prefs: []
  type: TYPE_TB
- en: '| `marvel.history.duration` | `7d` | Length of time to retain Marvel indices.
    The `marvel-agent` will automatically delete indices older than this value. Set
    to `-1` to disable automatic index deletion. |'
  id: totrans-92
  prefs: []
  type: TYPE_TB
- en: 'After making any changes to `elasticsearch.yml`, restart Elasticsearch:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Marvel index configuration
  id: totrans-95
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'This section covers how to configure the number of shards, replicas, and various
    other index settings used by Marvel. By default, each Marvel index uses one shard
    and one replica:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
- en: 'To view the default settings used by Marvel, run:'
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'This will return a large JSON object. The settings that are important are `marvel.order`,
    `marvel.template`, and `marvel.settings`:'
  id: totrans-99
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'For large Marvel clusters, consider increasing the number of shards to no more
    than the number of hosts in your cluster for optimal performance. For example,
    for a four-node Marvel monitoring cluster, increase the number of shards to four
    with the following command:'
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Note
  id: totrans-103
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Notice the template is set to `.marvel*` in order to only alter Marvel's indices.
    Additionally, the `order` setting is `1` so this template, `marvel_01`, will have
    higher precedence than the default template `marvel`.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 注意模板设置为`.marvel*`，以便仅更改Marvel的索引。此外，`order`设置为`1`，因此此模板`marvel_01`将比默认模板`marvel`具有更高的优先级。
- en: 'Now, when checking the Marvel settings, we should see:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，当检查Marvel设置时，我们应该看到：
- en: '[PRE23]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Understanding the Marvel dashboard
  id: totrans-107
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 理解Marvel仪表板
- en: This section covers how to use the Marvel dashboard to better understand the
    state of your cluster.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 本节介绍如何使用Marvel仪表板更好地了解集群的状态。
- en: To make monitoring our cluster more interesting, we'll stream more Twitter data
    into it using the `stream2es` program, and run random queries against the index
    using a custom bash script described in this section.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使监控我们的集群更有趣，我们将使用`stream2es`程序将更多Twitter数据流式传输到其中，并使用本节中描述的自定义bash脚本对索引运行随机查询。
- en: 'See [Chapter 3](ch03.html "Chapter 3. Elasticsearch-head and Bigdesk"), *Elasticsearch-head
    and Bigdesk* for detailed instructions on how to install and use `stream2es`,
    but, for quick reference, start `stream2es` using the following command:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 查看[第3章](ch03.html "第3章。Elasticsearch-head 和 Bigdesk")，*Elasticsearch-head 和
    Bigdesk*，获取有关如何安装和使用`stream2es`的详细说明，但为了快速参考，请使用以下命令启动`stream2es`：
- en: '[PRE24]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Next, we''ll simulate user interactions by running random queries against the
    `twitter` index. Create a new bash script called `run_queries.sh` with the following
    content:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将通过运行针对`twitter`索引的随机查询来模拟用户交互。创建一个名为`run_queries.sh`的新bash脚本，内容如下：
- en: '[PRE25]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: This script queries the Elasticsearch `twitter` index with a random dictionary
    word once every second.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本每秒查询Elasticsearch的`twitter`索引，使用随机字典单词。
- en: Note
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: You may need to install a dictionary on some Linux systems to get this to work.
    On Ubuntu, to get a dictionary of American English or British English words, run
    the following.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 您可能需要在某些Linux系统上安装字典才能使此功能正常工作。在Ubuntu上，要获取美式英语或英式英语单词的字典，请运行以下命令。
- en: 'For American English:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 对于美式英语：
- en: '[PRE26]'
  id: totrans-118
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'For British English:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 对于英式英语：
- en: '[PRE27]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Now make the `run_queries.sh` script executable:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 现在使`run_queries.sh`脚本可执行：
- en: '[PRE28]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'And finally, run the `run_queries.sh` script to start hitting our cluster with
    random queries once a second:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，运行`run_queries.sh`脚本，每秒对集群进行随机查询。
- en: '[PRE29]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: After running `stream2es` and `run_queries.sh` for a few minutes, open Marvel
    and navigate to the Overview dashboard to explore the impact of these scripts
    on our cluster.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 运行`stream2es`和`run_queries.sh`几分钟之后，打开Marvel并导航到概览仪表板，以探索这些脚本对我们集群的影响。
- en: Overview dashboard
  id: totrans-126
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 概览仪表板
- en: 'The **Overview** dashboard is the landing page of the Marvel Kibana dashboard.
    After running the `stream2es` command and `run_queries.sh` script mentioned previously
    for a few minutes, this dashboard will look something like this:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: '**概览**仪表板是Marvel Kibana仪表板的登录页面。运行`stream2es`命令和前面提到的`run_queries.sh`脚本几分钟之后，此仪表板看起来可能如下所示：'
- en: '![Overview dashboard](img/B03798_04_05.jpg)'
  id: totrans-128
  prefs: []
  type: TYPE_IMG
  zh: '![概览仪表板](img/B03798_04_05.jpg)'
- en: 'Here are the labels from the previous screenshot:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 这是前一张截图中的标签：
- en: '| No. | Description |'
  id: totrans-130
  prefs: []
  type: TYPE_TB
  zh: '| No. | 描述 |'
- en: '| --- | --- |'
  id: totrans-131
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| **1** | Dashboard title. |'
  id: totrans-132
  prefs: []
  type: TYPE_TB
  zh: '| **1** | 仪表板标题。|'
- en: '| **2** | Other Marvel dashboards. |'
  id: totrans-133
  prefs: []
  type: TYPE_TB
  zh: '| **2** | 其他Marvel仪表板。|'
- en: '| **3** | Page auto-refresh interval. |'
  id: totrans-134
  prefs: []
  type: TYPE_TB
  zh: '| **3** | 页面自动刷新间隔。|'
- en: '| **4** | Time filter. Defaults to **Last 1 hour**. |'
  id: totrans-135
  prefs: []
  type: TYPE_TB
  zh: '| **4** | 时间过滤器。默认为**过去1小时**。|'
- en: '| **5** | Cluster information including cluster status, number of nodes, total
    memory, and number of documents. |'
  id: totrans-136
  prefs: []
  type: TYPE_TB
  zh: '| **5** | 包括集群状态、节点数量、总内存和文档数量的集群信息。|'
- en: '| **6** | Current and historical search rate. Sample use case: see how heavy
    search traffic affects the cluster. |'
  id: totrans-137
  prefs: []
  type: TYPE_TB
  zh: '| **6** | 当前和历史搜索速率。示例用例：查看搜索流量如何影响集群。|'
- en: '| **7** | Current and historical search latency. Sample use case: diagnose
    why queries are running slow. |'
  id: totrans-138
  prefs: []
  type: TYPE_TB
  zh: '| **7** | 当前和历史搜索延迟。示例用例：诊断查询运行缓慢的原因。|'
- en: '| **8** | Current and historical indexing rate. Sample use case: diagnose why
    a bulk index operation failed. |'
  id: totrans-139
  prefs: []
  type: TYPE_TB
  zh: '| **8** | 当前和历史索引速率。示例用例：诊断为何批量索引操作失败。|'
- en: '| **9** | Current and historical indexing latency. Sample use case: diagnose
    why indexing operations are slow. |'
  id: totrans-140
  prefs: []
  type: TYPE_TB
  zh: '| **9** | 当前和历史索引延迟。示例用例：诊断索引操作为何缓慢。|'
- en: '| **10** | Shard activity. Gives the status of shards when they are recovering.
    |'
  id: totrans-141
  prefs: []
  type: TYPE_TB
  zh: '| **10** | 分片活动。在分片恢复时提供分片的状态。|'
- en: Note
  id: totrans-142
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Note that `run_queries.sh` only runs one query per second, but the **Search
    Request Rate** chart shows an average of about three queries per second. This
    is because every time a query is run, it's actually being run against all three
    data nodes. The **Search Request Rate** chart shows the average queries per second
    across all data nodes.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
- en: 'Any of Marvel''s charts can be filtered by time range by clicking and dragging
    on the chart, shown in the following figure:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
- en: '![Overview dashboard](img/B03798_04_06.jpg)'
  id: totrans-145
  prefs: []
  type: TYPE_IMG
- en: 'Here is the label from the previous screenshot:'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
- en: '| Number | Description |'
  id: totrans-147
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  id: totrans-148
  prefs: []
  type: TYPE_TB
- en: '| **1** | Click and drag on any chart to filter the chart by time. |'
  id: totrans-149
  prefs: []
  type: TYPE_TB
- en: 'After applying a filter, the Marvel charts and cluster information banner will
    update to show the state of the cluster at the selected moment in time. In the
    following screenshot, we can see that the cluster was in a `yellow` state during
    the selected time period:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
- en: '![Overview dashboard](img/B03798_04_07.jpg)'
  id: totrans-151
  prefs: []
  type: TYPE_IMG
- en: Indices dashboard
  id: totrans-152
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The **Indices** dashboard lets you examine historical data for a specific index,
    including:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
- en: Search rate
  id: totrans-154
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Index rate
  id: totrans-155
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Index size
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Memory
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Document count
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Field data size
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The **Indices** dashboard is very similar to the **Overview** dashboard, except
    for the list of indices at the bottom of the page, as seen in the following screenshot:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
- en: '![Indices dashboard](img/B03798_04_08.jpg)'
  id: totrans-161
  prefs: []
  type: TYPE_IMG
- en: 'Here is the label from the preceding screenshot:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
- en: '| Number | Description |'
  id: totrans-163
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  id: totrans-164
  prefs: []
  type: TYPE_TB
- en: '| **1** | List of all indices in the cluster. |'
  id: totrans-165
  prefs: []
  type: TYPE_TB
- en: 'Click on the `twitter` index at the bottom of this page to bring us to a page
    showing historical and real-time metrics for that particular index:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
- en: '![Indices dashboard](img/B03798_04_09.jpg)'
  id: totrans-167
  prefs: []
  type: TYPE_IMG
- en: 'Here are the labels from the previous screenshot:'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
- en: '| Number | Description |'
  id: totrans-169
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  id: totrans-170
  prefs: []
  type: TYPE_TB
- en: '| **1** | Index details. |'
  id: totrans-171
  prefs: []
  type: TYPE_TB
- en: '| **2** | Historical and real-time search rate for the index. |'
  id: totrans-172
  prefs: []
  type: TYPE_TB
- en: '| **3** | Historical and real-time indexing rate. |'
  id: totrans-173
  prefs: []
  type: TYPE_TB
- en: '| **4** | Historical and real-time index size. |'
  id: totrans-174
  prefs: []
  type: TYPE_TB
- en: '| **5** | Historical and real-time Lucene memory size. |'
  id: totrans-175
  prefs: []
  type: TYPE_TB
- en: '| **6** | Historical and real-time document count. |'
  id: totrans-176
  prefs: []
  type: TYPE_TB
- en: '| **7** | Historical and real-time field data size. Sample use case: diagnose
    `OutOfMemoryError` exceptions. |'
  id: totrans-177
  prefs: []
  type: TYPE_TB
- en: '| **8** | Shard distribution for this index. Click on any of the nodes to go
    to the node details page, described in the next section. |'
  id: totrans-178
  prefs: []
  type: TYPE_TB
- en: Nodes dashboard
  id: totrans-179
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The **Nodes** dashboard provides an overview of the cluster''s health and node
    utilization, in addition to historical and real-time statistics for specific nodes.
    This dashboard is used to examine Elasticsearch issues such as:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: Nodes in the cluster that are down
  id: totrans-181
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Nodes that are running low on disk space
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Nodes with high CPU and memory usage
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Opening the **Nodes** dashboard brings us to the following page:'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: '![Nodes dashboard](img/B03798_04_10.jpg)'
  id: totrans-185
  prefs: []
  type: TYPE_IMG
- en: This screenshot shows an overview of all nodes in the cluster, along with some
    real-time metrics. One advantage this page has over Elasticsearch-head is that
    if a node goes down, this page will identify that the node used to be part of
    the cluster but is currently offline. Elasticsearch-head on the other hand won't
    display the offline node at all.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 此截图显示了集群中所有节点的概述，以及一些实时指标。这个页面的一个优点是，如果节点宕机，此页面将识别出该节点曾经是集群的一部分，但目前处于离线状态。另一方面，Elasticsearch-head根本不会显示离线的节点。
- en: 'Clicking on a specific node opens up a dashboard showing data only for that
    host. The next screenshot shows the node stats for `elasticsearch-node-02`:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 点击特定的节点将打开一个仪表板，显示该主机的数据。下一张截图显示了`elasticsearch-node-02`的节点统计信息：
- en: '![Nodes dashboard](img/B03798_04_11.jpg)'
  id: totrans-188
  prefs: []
  type: TYPE_IMG
  zh: '![节点仪表板](img/B03798_04_11.jpg)'
- en: 'This page shows several historical and real-time metrics for the selected node:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 此页面显示了所选节点的几个历史和实时指标：
- en: '**Search Latency**: Historical analysis of search performance.'
  id: totrans-190
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**搜索延迟**：对搜索性能的历史分析。'
- en: '**Index Latency**: Historical analysis of data index performance.'
  id: totrans-191
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**索引延迟**：对数据索引性能的历史分析。'
- en: '**JVM Heap Usage**: High heap usage may indicate Java `OutOfMemoryError` exceptions.'
  id: totrans-192
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**JVM堆使用率**：高堆使用率可能表明Java `OutOfMemoryError`异常。'
- en: '**CPU Utilization**: High CPU utilization can be caused by a number of factors,
    but some common causes are running complex queries and shard movement.'
  id: totrans-193
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**CPU利用率**：高CPU利用率可能由多种因素引起，但一些常见的原因是运行复杂的查询和分片移动。'
- en: '**System Load Average**: This metric is a measure of the average amount of
    work performed by the node. This value should ideally be less than the number
    of CPU cores on the node.'
  id: totrans-194
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**系统负载平均**：此指标是衡量节点平均工作量的指标。此值理想情况下应小于节点的CPU核心数。'
- en: '**Segment Count**: Number of Lucene segments. This statistic will vary from
    cluster to cluster, but if the value increases to higher than usual, try running
    a cluster optimization.'
  id: totrans-195
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**段数量**：Lucene段的数量。这个统计数据会因集群而异，但如果值增加到高于正常水平，尝试运行集群优化。'
- en: '**Shard Legend**: Shows what shards are allocated to this node.'
  id: totrans-196
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**分片图例**：显示哪些分片分配给了此节点。'
- en: Monitoring node failures
  id: totrans-197
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 监控节点故障
- en: As mentioned previously, Marvel keeps track of nodes even after they leave the
    cluster. This is useful when working with large clusters that have many nodes
    to keep track of.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，Marvel即使在节点离开集群后也会跟踪节点。这对于需要跟踪大量节点的大型集群来说非常有用。
- en: 'We will demonstrate how the Marvel **Nodes** dashboard displays node failures
    by shutting down `elasticsearch-node-01`:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将通过关闭`elasticsearch-node-01`来演示Marvel **节点**仪表板如何显示节点故障：
- en: '[PRE30]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'The **Nodes** dashboard in Marvel now looks like this:'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: Marvel的**节点**仪表板现在看起来是这样的：
- en: '![Monitoring node failures](img/B03798_04_12.jpg)'
  id: totrans-202
  prefs: []
  type: TYPE_IMG
  zh: '![监控节点故障](img/B03798_04_12.jpg)'
- en: Here we can see Marvel indicates `elasticsearch-node-01` used to be part of
    the cluster, but is currently offline.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以看到Marvel指出`elasticsearch-node-01`曾经是集群的一部分，但目前处于离线状态。
- en: 'Elasticsearch-head, on the other hand, shows us the cluster in a `yellow` state,
    but does not indicate that `elasticsearch-node-01` was ever part of the cluster:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: Elasticsearch-head另一方面，显示集群处于`黄色`状态，但并未表明`elasticsearch-node-01`曾经是集群的一部分：
- en: '![Monitoring node failures](img/B03798_04_13.jpg)'
  id: totrans-205
  prefs: []
  type: TYPE_IMG
  zh: '![监控节点故障](img/B03798_04_13.jpg)'
- en: Note
  id: totrans-206
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Elasticsearch-head only displays `elasticsearch-node-02` and `elasticsearch-node-03`,
    not `elasticsearch-node-01`.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: Elasticsearch-head仅显示`elasticsearch-node-02`和`elasticsearch-node-03`，不显示`elasticsearch-node-01`。
- en: Summary
  id: totrans-208
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: This chapter covered how to install and configure the Marvel Agent and the Marvel
    Kibana dashboard. Additionally, it covered setting up a secondary monitoring cluster
    for Marvel to store its metrics. Finally, the chapter talked about the various
    Marvel Kibana dashboard pages and discussed at a high level how to use those pages
    to diagnose cluster issues. The next chapter talks about another monitoring tool,
    Kopf, and goes into more detail about how to use Kibana.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍了如何安装和配置Marvel代理以及Marvel Kibana仪表板。此外，还介绍了为Marvel设置一个二级监控集群以存储其指标的方法。最后，本章讨论了各种Marvel
    Kibana仪表板页面，并从高层次上讨论了如何使用这些页面来诊断集群问题。下一章将讨论另一个监控工具Kopf，并更详细地介绍如何使用Kibana。
