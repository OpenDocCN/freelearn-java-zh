<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Enterprise Integration Patterns"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Enterprise Integration Patterns</h1></div></div></div><p>In previous chapters, we have seen how a processor or a bean can be used to implement behavioral changes on the messages.</p><p>However, some of those functions provide ways to implement solutions to common problems and, instead of reimplementing the same function in different routes, we can reuse an existing one. Some of these generic message operations are described in the Enterprise Integration Patterns (EIPs) from Gregor Hohpe and <a id="id195" class="indexterm"/>Bobby Woolf (<a class="ulink" href="http://www.enterpriseintegrationpatterns.com/">http://www.enterpriseintegrationpatterns.com/</a>).</p><p>This chapter will introduce the most used EIPs provided by Camel:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The messaging systems EIPs</li><li class="listitem" style="list-style-type: disc">The messaging channels EIPs</li><li class="listitem" style="list-style-type: disc">The message construction EIPs</li><li class="listitem" style="list-style-type: disc">The message routing EIPs</li><li class="listitem" style="list-style-type: disc">The message transformation EIPs</li><li class="listitem" style="list-style-type: disc">The messaging endpoints EIPs</li><li class="listitem" style="list-style-type: disc">The system management EIPs</li></ul></div><p>Some of these generic message operations are described in the Enterprise Integration Patterns (EIPs) from Gregor Hohpe and Bobby Woolf. It describes the patterns, Camel provides the implementation.</p><div class="section" title="EIP processors"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>EIP processors</h1></div></div></div><p>The purpose of an EIP <a id="id196" class="indexterm"/>pattern is to apply a change on the message or create a new message:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A change on the content of the message itself</li><li class="listitem" style="list-style-type: disc">A change on the destination endpoint of the message</li><li class="listitem" style="list-style-type: disc">A change on the routing depending on the message</li><li class="listitem" style="list-style-type: disc">Creating a new message or exchange</li></ul></div><p>In the previous chapter, we have seen how Camel processors and beans can be used to implement such changes.</p><p>To provide support of EIPs, Camel actually provides ready-to-use processors, with the DSL language to directly use those processors.</p><p>So, instead of reimplementing your own same processor in multiple routes, you can directly use an EIP processor provided by Camel.</p><p>The EIPs are classified in different categories, depending on the change performed on the message and the routing function implemented. We will be covering each category in the following sections.</p></div></div>
<div class="section" title="Messaging systems EIPs"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Messaging systems EIPs</h1></div></div></div><p>Messaging systems EIPs gather<a id="id197" class="indexterm"/> all patterns related to the delivery of <a id="id198" class="indexterm"/>messages, which are moving along in the routing logic.</p><div class="section" title="Message Channel"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec18"/>Message Channel</h2></div></div></div><p>The Message Channel EIP is the <a id="id199" class="indexterm"/>generic name for the communication between endpoints in a Camel route.</p><p>In the examples of the previous chapters, we used endpoints with the following syntax:</p><div class="informalexample"><pre class="programlisting">component:option?key=value&amp;key=value</pre></div><p>For instance, we can have a route as follows:</p><div class="informalexample"><pre class="programlisting">&lt;from uri="timer:fire?period=5000"/&gt;
&lt;to uri="log:myLog"/&gt;</pre></div><p>This route uses two endpoints (<code class="literal">timer</code> and <code class="literal">log</code>). Camel implicitly creates a Message Channel between the two endpoints.</p><p>The purpose is to decouple the endpoint producing the message from the application consuming the message.</p><p>This EIP is actually used in basically all routes in an implicit way (you don't have to use a special notation to use Message Channel, it's in Camel).</p></div><div class="section" title="Message"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec19"/>Message</h2></div></div></div><p>Another implicit EIP in<a id="id200" class="indexterm"/> Camel is the Message EIP.</p><p>This EIP is basically implemented by the Camel message interface and wrapped in an exchange.</p><p>This EIP is used in combination with the Message Channel one—the message channel transports messages.</p><p>Thanks to the Exchange message wrapper, Camel implements the whole Message EIP, including support of the message exchange patterns.</p><p>In a Camel Exchange, we have the following pattern property:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If the pattern is set to <code class="literal">InOnly</code>, Camel implements an event message (a single inbound message)</li><li class="listitem" style="list-style-type: disc">If the pattern is set to <code class="literal">InOut</code>, Camel implements a <code class="literal">request-reply</code> with an inbound and outbound message</li></ul></div><p>The first endpoint of a Camel route (the <code class="literal">from</code>) is responsible for the creation of the exchange and hence, the message with the corresponding pattern. Each endpoint defines the expected pattern (and so if one is waiting for an outbound message to return to the client or not).</p></div><div class="section" title="Pipeline"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec20"/>Pipeline</h2></div></div></div><p>The purpose of the <a id="id201" class="indexterm"/>Pipeline EIP is to apply a series of actions using the message. For that, we <a id="id202" class="indexterm"/>move the message through different steps, like in a pipeline.</p><p>We can define a pipeline in two ways with Camel:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The implicit pipeline is what we used in previous chapters. We simply define the steps in the route definition itself.</li><li class="listitem" style="list-style-type: disc">The explicit pipeline uses the pipeline DSL syntax.</li></ul></div><div class="section" title="The implicit pipeline"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec01"/>The implicit pipeline</h3></div></div></div><p>The implicit pipeline is the <a id="id203" class="indexterm"/>default Camel behavior—the route definition containing the chain of different processors and endpoints is actually a pipeline.</p><p>To illustrate this, we create an example containing a Camel route written with the Blueprint DSL.</p><p>First, we create the following Maven <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5a&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>This <code class="literal">pom.xml</code> file is very simple—it just packages our route as an OSGi bundle that we will deploy into the Apache Karaf container. In the project, we create two very simple beans that just display a<a id="id204" class="indexterm"/> message when they receive the <code class="literal">in</code> message.</p><p>The first bean is named <code class="literal">Step1Bean</code>:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5a;

public class Step1Bean {

  public static void single(String body) {
      System.out.println("STEP 1: " + body);
  }

}</pre></div><p>The second bean is named <code class="literal">Step2Bean</code>:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5a;

public class Step2Bean {

  public static void single(String body) {
      System.out.println("STEP 2: " + body);
  }

}</pre></div><p>Finally, we <a id="id205" class="indexterm"/>create the Blueprint XML describing the route (in <code class="literal">src/main/resources/OSGI-INF/blueprint/route.xml</code>):</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="step1" class="com.packt.camel.chapter5a.Step1Bean"/&gt;

  &lt;bean id="step2" class="com.packt.camel.chapter5a.Step2Bean"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;
              &lt;constant&gt;Hello Chapter5a&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;bean ref="step1"/&gt;
          &lt;bean ref="step2"/&gt;
          &lt;to uri="log:pipeline"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We can see the pipeline here; Camel will route the exchange from the timer's endpoint to the <code class="literal">step1</code> bean, next to the <code class="literal">step2</code> bean, and finally to the <code class="literal">log</code> endpoint.</p><p>It's an implicit pipeline. We can see the route in action by building and deploying the bundle into Karaf.</p><p>To build the bundle packaging both the route and the beans, we simply do:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>We can start a Karaf container as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>

<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div><p>We install the <code class="literal">camel-blueprint</code> support in Karaf:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We can now install<a id="id206" class="indexterm"/> our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5a/1.0-SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>Very quickly, we can see the route execution:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>STEP 1: Hello Chapter5a</strong></span>
<span class="strong"><strong>STEP 2: Hello Chapter5a</strong></span>
<span class="strong"><strong>STEP 1: Hello Chapter5a</strong></span>
<span class="strong"><strong>STEP 2: Hello Chapter5a</strong></span>
<span class="strong"><strong>STEP 1: Hello Chapter5a</strong></span>
<span class="strong"><strong>STEP 2: Hello Chapter5a</strong></span>
</pre></div><p>We can note the pipeline behavior where the message flows from the timer endpoint to the different steps of the route execution.</p></div><div class="section" title="The explicit pipeline"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec02"/>The explicit pipeline</h3></div></div></div><p>Another way to use the <a id="id207" class="indexterm"/>pipeline EIP is by explicitly defining it with the corresponding DSL syntax.</p><p>The different steps are defined with the <code class="literal">pipeline</code> keyword.</p><p>To illustrate this, we will create a route exactly like the previous one (a message created by a timer is sent to two beans and a log endpoint) but this time using the <code class="literal">&lt;pipeline/&gt;</code> element in the route definition.</p><p>The Maven <code class="literal">pom.xml</code> file is similar to the previous one:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5b&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>We still have<a id="id208" class="indexterm"/> our two beans that display the <code class="literal">in</code> message. The first bean is as follows:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5b;

public class Step1Bean {

  public static void single(String body) {
      System.out.println("STEP 1: " + body);
  }

}</pre></div><p>The second bean that displays the <code class="literal">in</code> message is as follows:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5b;

public class Step2Bean {

  public static void single(String body) {
      System.out.println("STEP 2: " + body);
  }

}</pre></div><p>Only the Blueprint XML describing the route is different:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="step1" class="com.packt.camel.chapter5b.Step1Bean"/&gt;

  &lt;bean id="step2" class="com.packt.camel.chapter5b.Step2Bean"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;
              &lt;constant&gt;Hello Chapter5b&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;pipeline&gt;
              &lt;bean ref="step1"/&gt;
              &lt;bean ref="step2"/&gt;
              &lt;to uri="log:pipeline"/&gt;
          &lt;/pipeline&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>As we did in the<a id="id209" class="indexterm"/> previous example, we build the OSGi bundle using Maven:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>We deploy our bundle in Karaf:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5b/1.0-SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>We can see that the route execution is exactly the same as it is in the previous example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>STEP 1: Hello Chapter5b</strong></span>
<span class="strong"><strong>STEP 2: Hello Chapter5b</strong></span>
<span class="strong"><strong>STEP 1: Hello Chapter5b</strong></span>
<span class="strong"><strong>STEP 2: Hello Chapter5b</strong></span>
</pre></div><p>Basically, the routes are exactly the same internally in Camel, only the notation is different.</p><p>In most cases, we use the implicit pipeline (default behavior) which allows you to simplify the<a id="id210" class="indexterm"/> route definition.</p></div><div class="section" title="Message router"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec03"/>Message router</h3></div></div></div><p>The Message Router EIP moves a message to different destinations depending on a condition.</p><p>The condition is actually a<a id="id211" class="indexterm"/> predicate defined using one of the languages supported by Camel (simple, header, xpath, xquery, mvel, ognl, and so on).</p><p>The predicate can use any data to implement the condition. If it uses the content of the message itself, we talk about Content Based Router (which we will see later in this chapter).</p><p>To illustrate the Message Router EIP, we create a route that will consume files and copy the files to different output folders depending on the file extension.</p><p>We directly write this route using the Blueprint DSL to a <code class="literal">route.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;choice&gt;
              &lt;when&gt;
                 &lt;simple&gt;${file:ext} == 'xml'&lt;/simple&gt;
                 &lt;to uri="file:/tmp/out/xml"/&gt;
              &lt;/when&gt;
              &lt;when&gt;
                 &lt;simple&gt;${file:ext} == 'txt'&lt;/simple&gt;
                 &lt;to uri="file:/tmp/out/txt"/&gt;
              &lt;/when&gt;
              &lt;otherwise&gt;
                 &lt;to uri="file:/tmp/out/binaries"/&gt;
              &lt;/otherwise&gt;
          &lt;/choice&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We can see the usage of the <code class="literal">&lt;choice/&gt;</code> element, which is the notation of the Message Router EIP.</p><p>In this choice, we define two conditional routings:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using the <code class="literal">simple</code> language, we define the first predicate checking whether the file extension is <code class="literal">.xml</code>. If so, the message is routed to a file endpoint creating an output file in the <code class="literal">/tmp/out/xml</code> folder.</li><li class="listitem" style="list-style-type: disc">The second<a id="id212" class="indexterm"/> condition also uses the simple language. This predicate checks whether the file extension is <code class="literal">.txt</code>. If so, the message is routed to a file endpoint creating an output file in the <code class="literal">/tmp/out/txt</code> folder.</li></ul></div><p>If the two first conditions are not matched, the message is routed to a file endpoint creating an output file in the <code class="literal">/tmp/out/binaries</code> folder. We start Karaf and install the <code class="literal">camel-blueprint</code> support:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We can now simply drop the <code class="literal">route.xml</code> file in the Karaf <code class="literal">deploy</code> folder.</p><p>In the <code class="literal">/tmp/in</code> folder, we create three files.</p><p>The first file is <code class="literal">file.xml</code>, which contains :</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&lt;test&gt;foobar&lt;/test&gt;</strong></span>
</pre></div><p>The second file is <code class="literal">file.txt</code>, which contains :</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Foobar</strong></span>
</pre></div><p>The third file is <code class="literal">file.csv</code>, which contains :</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>foo,bar</strong></span>
</pre></div><p>We can see in the <code class="literal">/tmp/out</code> directory that the three folders have been created and they contain the expected files:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>/tmp/out$ tree</strong></span>
<span class="strong"><strong>.</strong></span>
<span class="strong"><strong>├── binaries</strong></span>
<span class="strong"><strong>│   └── test.csv</strong></span>
<span class="strong"><strong>├── txt</strong></span>
<span class="strong"><strong>│   └── file.txt</strong></span>
<span class="strong"><strong>└── xml</strong></span>
<span class="strong"><strong>  └── file.xml</strong></span>
</pre></div></div></div><div class="section" title="Message Translator"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec21"/>Message Translator</h2></div></div></div><p>The Message Translator EIP is basically<a id="id213" class="indexterm"/> the transformation of the message content.</p><p>Some steps of the route <a id="id214" class="indexterm"/>change the content of the message.</p><p>In Camel, you have three ways to implement a message translator:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can use the transform DSL notation to call any language supported by Camel</li><li class="listitem" style="list-style-type: disc">If the purpose of the translator is to convert from one data format to another, you can use the marshalling/unmarshalling functions provided by Camel</li><li class="listitem" style="list-style-type: disc">If you want complete control and implement complex transformation, you can use your own processor or bean to implement the transformation logic</li></ul></div><div class="section" title="The transform notation"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec04"/>The transform notation</h3></div></div></div><p>It's possible to use any language supported by Camel (<code class="literal">simple</code>, <code class="literal">ruby</code>, <code class="literal">groovy</code>, and so on) in the <code class="literal">transform</code> keyword.</p><p>The external language is used to apply a transformation on the message.</p><p>To illustrate the usage of the<a id="id215" class="indexterm"/> transform notation, we can create a Camel route using the following Blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;transform&gt;
             &lt;simple&gt;Hello ${in.body}&lt;/simple&gt;
          &lt;/transform&gt;
          &lt;to uri="file:/tmp/out"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>This Camel route uses a Message Translator EIP to prepend <code class="literal">Hello</code> to the body of the <code class="literal">in</code> message.</p><p>The route consumes files from the <code class="literal">/tmp/in</code> folder (thanks to the <code class="literal">from</code> file endpoint), uses the transform notation with the simple language, and writes the message to a file in the <code class="literal">/tmp/out</code> folder (thanks to the <code class="literal">to</code> file endpoint).</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We just drop the Blueprint XML file in the Karaf <code class="literal">deploy</code> folder. We create the <code class="literal">test.txt</code> file in the <code class="literal">/tmp/in</code> folder, only containing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>World</strong></span>
</pre></div><p>The Camel route <a id="id216" class="indexterm"/>creates a <code class="literal">test.txt</code> file in the <code class="literal">/tmp/out</code> folder, containing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Hello World</strong></span>
</pre></div><p>We can note that the Message Translator EIP changed the body of the <code class="literal">in</code> message (from <code class="literal">World</code> to <code class="literal">Hello World</code>).</p></div><div class="section" title="Using processor or bean"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec05"/>Using processor or bean</h3></div></div></div><p>In previous chapters, we have already used a Camel processor or a bean to change the body of the <code class="literal">in</code> message.</p><p>We perform the same<a id="id217" class="indexterm"/> task as we did in the previous example using a processor.</p><p>This time, a simple Blueprint XML file is not enough, we have to package the Blueprint XML and the processor in an OSGi bundle.</p><p>We create the following Maven <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5e&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;dependencies&gt;
      &lt;dependency&gt;
          &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
          &lt;artifactId&gt;camel-core&lt;/artifactId&gt;
          &lt;version&gt;2.12.4&lt;/version&gt;
      &lt;/dependency&gt;
  &lt;/dependencies&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>This Maven <code class="literal">pom.xml</code> file is very simple, it just<a id="id218" class="indexterm"/> defined the <code class="literal">camel-core</code> dependency (required by our<a id="id219" class="indexterm"/> Camel processor) and the OSGi bundle packaging.</p><p>We create a <code class="literal">PrependProcessor</code> class:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5e;

import org.apache.camel.Exchange;
import org.apache.camel.Processor;

public class PrependProcessor implements Processor {

  public void process(Exchange exchange) throws Exception {
      String inBody = exchange.getIn().getBody(String.class);
      inBody = "Hello " + inBody;
      exchange.getIn().setBody(inBody);
  }

}</pre></div><p>This processor is actually the implementation of the Message Translator EIP—it prepends <code class="literal">Hello</code> to the inbound message.</p><p>Finally, we use this processor in a Camel route written using the Blueprint DSL:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="prependProcessor" class="com.packt.camel.chapter5e.PrependProcessor"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;process ref="prependProcessor"/&gt;
          &lt;to uri="file:/tmp/out"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We use Maven to<a id="id220" class="indexterm"/> build and package our OSGi bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We install our bundle in Karaf:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5e/1.0-SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>As in the previous example, we will put a <code class="literal">test.txt</code> file in the <code class="literal">/tmp/in</code> folder, which contains this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>World</strong></span>
</pre></div><p>Then, we can see <code class="literal">/tmp/in/test.txt</code> containing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Hello World</strong></span>
</pre></div><p>So, we implemented the<a id="id221" class="indexterm"/> same Message Translator EIP but this time using a processor.</p><p>A processor or a bean gives you complete control of the Camel Exchange, and allows you to implement very complex message transformations.</p></div><div class="section" title="Marshalling/umarshalling"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec06"/>Marshalling/umarshalling</h3></div></div></div><p>Instead of changing the content <a id="id222" class="indexterm"/>of the message itself, the Message Translator EIP can be used to convert the message from one data format to another.</p><p>Camel supports different <a id="id223" class="indexterm"/>data formats and provides functions to directly convert from one data format to another.</p><p>To illustrate marshalling and unmarshalling, we create a route that consumes XML files and unmarshal/marshal the XML messages as JSON messages, which are sent to another file endpoint.</p><p>We use the Camel Blueprint DSL to define the route:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;dataFormats&gt;
          &lt;xmljson id="xmljson"/&gt;
      &lt;/dataFormats&gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;marshal ref="xmljson"/&gt;
          &lt;to uri="file:/tmp/out"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>This route uses the <code class="literal">xmljson</code> Camel data format. The marshal element is the implementation of the Message Translator EIP, which converts the message from XML to JSON.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> and <code class="literal">camel-xmljson</code> features:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-xmljson</strong></span>
</pre></div><p>We directly drop our <code class="literal">route.xml</code> in the <code class="literal">deploy</code> folder.</p><p>In the <code class="literal">/tmp/in</code> folder, we create the following <code class="literal">person.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;person&gt;
      &lt;name&gt;jbonofre&lt;/name&gt;
      &lt;address&gt;My Street, Paris&lt;/address&gt;
&lt;/person&gt;</pre></div><p>In the <code class="literal">/tmp/out</code> folder, we can see a <code class="literal">person.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">{"name":"jbonofre","address":"My Street, Paris"}</pre></div><p>Our Message<a id="id224" class="indexterm"/> Translator EIP has been executed, using<a id="id225" class="indexterm"/> marshalling/unmarshalling to different data formats.</p></div></div><div class="section" title="Message Endpoint"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec22"/>Message Endpoint</h2></div></div></div><p>The Message Endpoint EIP just <a id="id226" class="indexterm"/>defines the way an application can produce or consume messages in the routing system. Basically, in Camel, it's directly implemented and described by the <code class="literal">endpoint</code> interface. An endpoint is created by a component and described by an URI.</p></div></div>
<div class="section" title="Messaging channels EIPs"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Messaging channels EIPs</h1></div></div></div><p>Messaging Channel EIPs<a id="id227" class="indexterm"/> gather all the patterns moving data from<a id="id228" class="indexterm"/> one point to another, using a communication channel.</p><div class="section" title="Point To Point Channel"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec23"/>Point To Point Channel</h2></div></div></div><p>The Point To Point<a id="id229" class="indexterm"/> Channel EIP ensures that only one receiver consumes a message.</p><p>In Camel, the support of this EIP is dedicated to the components.</p><p>Some components are designed to implement and support this EIP.</p><p>For instance, this is the case for:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The SEDA and VM components, for communication between routes</li><li class="listitem" style="list-style-type: disc">The JMS component, when working with JMS queues</li></ul></div><p>To illustrate the Point To Point Channel EIP, we create three routes using the Camel Blueprint DSL:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first route starts with a timer and produces a message in a JMS queue</li><li class="listitem" style="list-style-type: disc">The second and third routes consume messages from the JMS queue</li></ul></div><p>We will see that one message will only be consumed by one consumer route.</p><p>We create the following <code class="literal">route.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="amqConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;
      &lt;property name="brokerURL" value="vm://broker"/&gt;
  &lt;/bean&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=1000"/&gt;
          &lt;setBody&gt;
             &lt;constant&gt;Hello chapter5g&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;to uri="jms:queue:input?connectionFactory=#amqConnectionFactory"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="jms:queue:input?connectionFactory=#amqConnectionFactory"/&gt;
          &lt;delay&gt;
              &lt;constant&gt;2000&lt;/constant&gt;
          &lt;/delay&gt;
          &lt;to uri="log:consumer1"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="jms:queue:input?connectionFactory=#amqConnectionFactory"/&gt;
          &lt;delay&gt;
              &lt;constant&gt;2000&lt;/constant&gt;
          &lt;/delay&gt;
          &lt;to uri="log:consumer2"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We define a JMS <a id="id230" class="indexterm"/>connection factory that embeds an Apache ActiveMQ JMS broker. This connection factory is used in different Camel JMS endpoints.</p><p>We start a Karaf instance and we install the <code class="literal">camel-blueprint</code> and <code class="literal">activemq-camel</code> features:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add activemq 5.7.0</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.activemq/activemq-karaf/5.7.0/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install activemq-camel</strong></span>
<span class="strong"><strong>Refreshing bundles org.apache.servicemix.bundles.jaxb-impl (69), org.apache.camel.camel-core (70)</strong></span>
</pre></div><p>We can now directly drop the <code class="literal">route.xml</code> file into the Karaf <code class="literal">deploy</code> folder. In the log (<code class="literal">$KARAF_HOME/data/log</code>), we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 15:25:22,142 | INFO  | sConsumer[input] | consumer2  | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5g]</strong></span>
<span class="strong"><strong>2014-12-15 15:25:23,105 | INFO  | sConsumer[input] | consumer1 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5g]</strong></span>
<span class="strong"><strong>2014-12-15 15:25:24,146 | INFO  | sConsumer[input] | consumer2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5g]</strong></span>
<span class="strong"><strong>2014-12-15 15:25:25,107 | INFO  | sConsumer[input] | consumer1 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5g]</strong></span>
<span class="strong"><strong>2014-12-15 15:25:26,149 | INFO  | sConsumer[input] | consumer2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5g]</strong></span>
<span class="strong"><strong>2014-12-15 15:25:27,109 | INFO  | sConsumer[input] | consumer1 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5g]</strong></span>
<span class="strong"><strong>2014-12-15 15:25:28,151 | INFO  | sConsumer[input] | consumer2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5g]</strong></span>
</pre></div><p>We can see that each<a id="id231" class="indexterm"/> message is consumed by one route, illustrating the Point To Point Channel EIP.</p></div><div class="section" title="Publish Subscribe Channel"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec24"/>Publish Subscribe Channel</h2></div></div></div><p>The Publish Subscribe <a id="id232" class="indexterm"/>Channel EIP is similar to the Point To Point Channel EIP, but instead of being consumed by only one consumer, each message is consumed by multiple consumers.</p><p>The message is duplicated to all consumers.</p><p>As in the Point To Point Channel EIP, Camel supports the Publish Subscribe Channel at a component level.</p><p>Some components are designed to implement and support this EIP, such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The JMS component when working with JMS topics</li><li class="listitem" style="list-style-type: disc">The SEDA/VM components when working with <code class="literal">multipleConsumers=true</code> on the endpoints</li></ul></div><p>To illustrate this EIP, we<a id="id233" class="indexterm"/> update the previous example to use a topic instead of a queue:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="amqConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;
      &lt;property name="brokerURL" value="vm://broker"/&gt;
  &lt;/bean&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=1000"/&gt;
          &lt;setBody&gt;
             &lt;constant&gt;Hello chapter5h&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;to uri="jms:topic: input?connectionFactory=#amqConnectionFactory"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="jms:topic :input?connectionFactory=#amqConnectionFactory"/&gt;
          &lt;delay&gt;
              &lt;constant&gt;2000&lt;/constant&gt;
          &lt;/delay&gt;
          &lt;to uri="log:consumer1"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="jms:topic:input?connectionFactory=#amqConnectionFactory"/&gt;
          &lt;delay&gt;
              &lt;constant&gt;2000&lt;/constant&gt;
          &lt;/delay&gt;
          &lt;to uri="log:consumer2"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>As we did in the previous example, we start Karaf and install the <code class="literal">camel-blueprint</code> and <code class="literal">activemq-camel</code> features:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add activemq 5.7.0</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.activemq/activemq-karaf/5.7.0/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install activemq-camel</strong></span>
<span class="strong"><strong>Refreshing bundles org.apache.servicemix.bundles.jaxb-impl (69), org.apache.camel.camel-core (70)</strong></span>
</pre></div><p>We<a id="id234" class="indexterm"/> drop the <code class="literal">route.xml</code> directly into the <code class="literal">deploy</code> folder. Now, we can see the following in the log:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 15:47:45,363 | INFO  | sConsumer[input] | consumer1 | 70 -org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:45,363 | INFO  | sConsumer[input] | consumer2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:47,367 | INFO  | sConsumer[input] | consumer2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:47,367 | INFO  | sConsumer[input] | consumer1 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:49,369 | INFO  | sConsumer[input] | consumer1 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:49,369 | INFO  | sConsumer[input] | consumer2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:51,371 | INFO  | sConsumer[input] | consumer2  | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:51,371 | INFO  | sConsumer[input] | consumer1 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:53,373 | INFO  | sConsumer[input] | consumer2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
<span class="strong"><strong>2014-12-15 15:47:53,373 | INFO  | sConsumer[input] | consumer1 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5h]</strong></span>
</pre></div><p>We can note that each message has been consumed by the two routes (see the timestamps).</p></div><div class="section" title="Dead Letter Channel"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec25"/>Dead Letter Channel</h2></div></div></div><p>The Dead Letter Channel EIP allows you to reroute a message to another destination when the actual destination delivery fails.</p><p>This EIP is related to<a id="id235" class="indexterm"/> the management of errors in Camel routes.</p><p>Camel uses extensive support for error management, thanks to different error handlers and policies. We will see error handlers and hence, the Dead Letter Channel EIP, in <a class="link" href="ch07.html" title="Chapter 7. Error Handling">Chapter 7</a>, <span class="emphasis"><em>Error Handling</em></span>.</p></div><div class="section" title="Guaranteed Delivery"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec26"/>Guaranteed Delivery</h2></div></div></div><p>Guaranteed Delivery<a id="id236" class="indexterm"/> ensures that we don't lose any message. It means basically that the messages are persistent and stored in a persistent store.</p><p>It allows you to create some checkpoints in your route—if a route stops, the messages are stored. As soon as the route restarts, the <span class="emphasis"><em>pending</em></span> messages are processed.</p><p>Camel, by itself, doesn't provide storage for messages, but you can use endpoints allowing the storage of the messages, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">File endpoints, where the messages are produced as files on the filesystem by a route, and consumed by routes. The store is actually the filesystem.</li><li class="listitem" style="list-style-type: disc">JMS endpoints, where the messages (flagged as durable messages) are added  into a JMS queue by a route, and consumed by other routes. The message store is actually the broker persistent messages store.</li><li class="listitem" style="list-style-type: disc">JPA endpoints, where the messages are produced and stored in a database, and other routes poll the database. The message store is actually the database.</li></ul></div><p>We can illustrate this EIP using two routes sharing a directory on the filesystem to store the messages.</p><p>The purpose is to see that, even if the second route is stopped, the messages are persistent and taken by the route as soon as it's started again.</p><p>We create a first <code class="literal">route1.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=1000"/&gt;
          &lt;setBody&gt;
             &lt;constant&gt;Hello chapter5i&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;to uri="file:/tmp/exchange"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop the <code class="literal">route1.xml</code> into the <code class="literal">deploy</code> folder. We can see the first files coming into the <code class="literal">/tmp/exchange</code> folder:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ /tmp/exchange$ ls -l</strong></span>
<span class="strong"><strong>total 16</strong></span>
<span class="strong"><strong>-rw-rw-r-- 1 jbonofre jbonofre 15 Dec 15 16:21 ID-latitude-51643-1418656861977-0-1</strong></span>
<span class="strong"><strong>-rw-rw-r-- 1 jbonofre jbonofre 15 Dec 15 16:21 ID-latitude-51643-1418656861977-0-3</strong></span>
<span class="strong"><strong>-rw-rw-r-- 1 jbonofre jbonofre 15 Dec 15 16:21 ID-latitude-51643-1418656861977-0-5</strong></span>
<span class="strong"><strong>-rw-rw-r-- 1 jbonofre jbonofre 15 Dec 15 16:21 ID-latitude-51643-1418656861977-0-7</strong></span>
</pre></div><p>Now, we<a id="id237" class="indexterm"/> create a <code class="literal">route2.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/exchange"/&gt;
            &lt;convertBodyTo type="java.lang.String"/&gt;
          &lt;to uri="log:route2"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We drop this <code class="literal">route2.xml</code> file into the <code class="literal">deploy</code> folder of Karaf.</p><p>Now, we can see the following in the Karaf log:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 17:04:11,258 | INFO  | :///tmp/exchange | route2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5i]</strong></span>
<span class="strong"><strong>2014-12-15 17:04:11,260 | INFO  | :///tmp/exchange | route2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5i]</strong></span>
<span class="strong"><strong>2014-12-15 17:04:11,260 | INFO  | :///tmp/exchange | route2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5i]</strong></span>
<span class="strong"><strong>2014-12-15 17:04:11,261 | INFO  | :///tmp/exchange | route2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5i]</strong></span>
<span class="strong"><strong>2014-12-15 17:04:11,262 | INFO  | :///tmp/exchange | route2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5i]</strong></span>
<span class="strong"><strong>2014-12-15 17:04:11,263 | INFO  | :///tmp/exchange | route2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5i]</strong></span>
<span class="strong"><strong>2014-12-15 17:04:11,263 | INFO  | :///tmp/exchange | route2 | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5i]</strong></span>
</pre></div><p>So even if the <a id="id238" class="indexterm"/>second route is not deployed, the messages are not lost and stored on the filesystem. It's an implementation of the Guaranteed Delivery EIP.</p></div><div class="section" title="Message Bus"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec27"/>Message Bus</h2></div></div></div><p>The Message Bus EIP describes the<a id="id239" class="indexterm"/> architecture to plug and play applications that have to interact. This EIP gathers the messaging infrastructure, and the other layers required to implement routing.</p><p>So, basically, Camel itself is an implementation of the Message Bus EIP.</p></div></div>
<div class="section" title="Message Construction EIPs"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Message Construction EIPs</h1></div></div></div><p>These EIPs are<a id="id240" class="indexterm"/> responsible for creating messages in response<a id="id241" class="indexterm"/> to other messages.</p><div class="section" title="The Event Message EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec28"/>The Event Message EIP</h2></div></div></div><p>The Event Message<a id="id242" class="indexterm"/> EIP describes how to use messaging to transmit events from one application to another.</p><p>Camel supports this EIP by the use of the Message Exchange Pattern in the exchange. When defined as <code class="literal">InOnly</code>, it means that we deal with a one way event message.</p><p>So, basically, the Event Message EIP means one directional messages.</p><p>The first endpoint of the route defines the expected Exchange pattern, but, at any point in the route, you can force the Exchange pattern to <code class="literal">InOnly</code> to make it act as an Event Message EIP.</p><p>For this, you have to<a id="id243" class="indexterm"/> use the <code class="literal">inOnly</code> notation:</p><div class="informalexample"><pre class="programlisting">&lt;route&gt;
   &lt;from uri="direct:start"/&gt;
   &lt;inOnly uri="bean:myBean"/&gt;
&lt;/route&gt;</pre></div><p>You can also use the <code class="literal">setExchangePattern</code> notation:</p><div class="informalexample"><pre class="programlisting">&lt;route&gt;
   &lt;from uri="direct:start"/&gt;
   &lt;setExchangePattern pattern="InOnly"/&gt;
   &lt;to uri="bean:myBean"/&gt;
&lt;/route&gt;</pre></div><p>It's also possible to define the pattern as an attribute of the endpoint:</p><div class="informalexample"><pre class="programlisting">&lt;route&gt;
   &lt;from uri="direct:start"/&gt;
   &lt;to uri="bean:myBean" pattern="InOnly"/&gt;
&lt;/route&gt;</pre></div></div><div class="section" title="The Request Reply EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec29"/>The Request Reply EIP</h2></div></div></div><p>The Request Reply EIP is<a id="id244" class="indexterm"/> like the Event Message EIP, but this time, a response is expected from the target application.</p><p>As it does with Event Message, Camel supports this EIP using the Message Exchange pattern defined as <code class="literal">InOut</code>.</p><p>Again, the <code class="literal">from</code> endpoint defines the pattern that it expects. For instance, a CXF endpoint will define the pattern as <code class="literal">InOut</code> as it has to return something to the client.</p><p>As in the <code class="literal">InOnly</code> pattern, you can <span class="emphasis"><em>force</em></span> the pattern to <code class="literal">InOut</code>, using the same notations.</p></div><div class="section" title="The Correlation Identifier EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec30"/>The Correlation Identifier EIP</h2></div></div></div><p>The Correlation Identifier EIP<a id="id245" class="indexterm"/> is useful when used with the Request Reply pattern. With this pattern, an identifier can be added to a message, which can be used to correlate the response message with the request message.</p><p>Camel supports this EIP by defining a dedicated header in the message or a property on the exchange. This header (or a property) is actually the Correlation Identifier.</p><p>Some other EIPs (that we will see later) leverage this header to correlate multiple messages all together. For instance, the Splitter EIP defines the Correlation Identifier as a property of the exchanges<a id="id246" class="indexterm"/> resulting from the split (for instance, to be able to aggregate the messages).</p></div><div class="section" title="The Return Address EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec31"/>The Return Address EIP</h2></div></div></div><p>The Return Address EIP <a id="id247" class="indexterm"/>describes how a target endpoint knows where it has to send a response. This EIP has to be used in combination with the Request Reply pattern, as we expect a response from the target endpoint.</p><p>Camel supports this EIP by populating a <code class="literal">JMSReplyTo</code> header in the message in the case of the JMS endpoints involved.</p><p>When working with the JMS component, this <code class="literal">JMSReplyTo</code> header is directly used and transported by the broker.</p><p>It's also possible to use the <code class="literal">ReplyTo</code> option on the JMS endpoint to populate the <code class="literal">JMSReplyTo</code> header on the fly:</p><div class="informalexample"><pre class="programlisting">&lt;to uri="jms:queue:request?replyTo=response"/&gt;</pre></div></div></div>
<div class="section" title="Message Routing"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec45"/>Message Routing</h1></div></div></div><p>These EIPs are the<a id="id248" class="indexterm"/> core routing patterns. It's mostly where Camel provides <a id="id249" class="indexterm"/>specific syntax to handle routing.</p><div class="section" title="The Content Based Router EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec32"/>The Content Based Router EIP</h2></div></div></div><p>The Content Based Router EIP is a special case of the Message Router EIP.</p><p>As we've seen <a id="id250" class="indexterm"/>previously, the Message Router EIP is a generic routing EIP defining a conditional routing on the message.</p><p>The Content Based Router EIP is used in cases where the condition is based on the content of the body of the message itself. In the Message Router example, the condition was on the extension of the consumed files.</p><p>Here, to illustrate the Content Based Router EIP, we create an example that will route the files depending on an <code class="literal">XPath</code> predicate in the body of the message.</p><p>We create the following <code class="literal">route.xml</code> Blueprint description:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;choice&gt;
              &lt;when&gt;
                 &lt;xpath&gt;//address='France'&lt;/xpath&gt;
                 &lt;to uri="file:/tmp/out/france"/&gt;
              &lt;/when&gt;
              &lt;when&gt;
                 &lt;xpath&gt;//address='USA'&lt;/xpath&gt;
                 &lt;to uri="file:/tmp/out/usa"/&gt;
              &lt;/when&gt;
              &lt;otherwise&gt;
                 &lt;to uri="file:/tmp/out/others"/&gt;
              &lt;/otherwise&gt;
  &lt;/choice&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>The route<a id="id251" class="indexterm"/> consumes files from the <code class="literal">/tmp/in</code> folder. The message body contains the contents of the file. We use the <code class="literal">XPath</code> predicates to test the <code class="literal">address</code> element in the message, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If the address is France, the message is routed to the <code class="literal">/tmp/out/france</code> folder.</li><li class="listitem" style="list-style-type: disc">If the address is USA, the message is routed to the <code class="literal">/tmp/out/usa</code> folder.</li><li class="listitem" style="list-style-type: disc">If the address is not France or USA, the message is routed to the <code class="literal">/tmp/out/others</code> folder.</li></ul></div><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop the <code class="literal">route.xml</code> into the Karaf <code class="literal">deploy</code> folder. In the <code class="literal">/tmp/in</code> folder, we create the <code class="literal">first.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;person&gt;
&lt;name&gt;jbonofre&lt;/name&gt;
&lt;address&gt;France&lt;/address&gt;
&lt;/person&gt;</pre></div><p>We also drop the <code class="literal">second.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;person&gt;
&lt;name&gt;Bob&lt;/name&gt;
&lt;address&gt;USA&lt;/address&gt;
&lt;/person&gt;</pre></div><p>We also drop the <code class="literal">third.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;person&gt;
&lt;name&gt;Juan&lt;/name&gt;
&lt;address&gt;Spain&lt;/address&gt;
&lt;/person&gt;</pre></div><p>We can see that the files have been routed to different folders, as expected:</p><div class="informalexample"><pre class="programlisting">/tmp/out$ tree
.
├── france
│ └── first.xml
├── others
│ └── third.xml
└── usa
└── second.xml</pre></div></div><div class="section" title="The Message Filter EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec33"/>The Message Filter EIP</h2></div></div></div><p>The Message Filter EIP <a id="id252" class="indexterm"/>describes how to select only the messages that we want to process.</p><p>We define a predicate to match and process the messages. If the messages don't match, their predicate will be ignored.</p><p>As in the Message Router EIP, we can use any language supported by Camel to write the predicate.</p><p>To illustrate the Message Filter EIP, we use the following <code class="literal">route.xml</code> Blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;filter&gt;
               &lt;xpath&gt;//name='jbonofre'&lt;/xpath&gt;
               &lt;to uri="direct:next"/&gt;
          &lt;/filter&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:next"/&gt;
          &lt;convertBodyTo type="java.lang.String"/&gt;
          &lt;to uri="log:file"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>The first route consumes the files from the <code class="literal">/tmp/in</code> folder. If the file contains the name element with <code class="literal">jbonofre</code>, the message is moved forward to the second route (thanks to the <code class="literal">direct</code> endpoint).</p><p>If the <code class="literal">XPath</code> predicate is not matched, the message is ignored.</p><p>We start Karaf and<a id="id253" class="indexterm"/> install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>In the <code class="literal">/tmp/in</code> folder, we create the same three files as we did in the previous example.</p><p>The <code class="literal">first.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;person&gt;
&lt;name&gt;jbonofre&lt;/name&gt;
&lt;address&gt;France&lt;/address&gt;
&lt;/person&gt;</pre></div><p>The <code class="literal">second.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;person&gt;
&lt;name&gt;Bob&lt;/name&gt;
&lt;address&gt;USA&lt;/address&gt;
&lt;/person&gt;</pre></div><p>The <code class="literal">third.xml</code> file, containing:</p><div class="informalexample"><pre class="programlisting">&lt;person&gt;
&lt;name&gt;Juan&lt;/name&gt;
&lt;address&gt;Spain&lt;/address&gt;
&lt;/person&gt;</pre></div><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 18:12:10,944 | INFO  | - file:///tmp/in | file | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body:</strong></span>
<span class="strong"><strong>&lt;person&gt;&lt;name&gt;jbonofre&lt;/name&gt;&lt;address&gt;France&lt;/address&gt;&lt;/person&gt;]</strong></span>
</pre></div><p>This means that only<a id="id254" class="indexterm"/> the message from the <code class="literal">first.xml</code> file has been processed.</p></div><div class="section" title="The Dynamic Router EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec34"/>The Dynamic Router EIP</h2></div></div></div><p>The Dynamic Router EIP describes how to dynamically route the message. When using the Message Router EIP, the<a id="id255" class="indexterm"/> different routing destinations and the conditions are statically defined at design time.</p><p>With the Dynamic Router EIP, the condition and the destinations are evaluated at runtime, and so, can be changed dynamically.</p><p>It's also possible to send the message to multiple destinations on one condition.</p><p>To illustrate this EIP, we create a route that uses a dynamic router. The dynamic router uses a bean to evaluate the condition and define the routing destinations.</p><p>We create a very simple Maven <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5l&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>This Maven <code class="literal">pom.xml</code> file just packages the route and the bean as an OSGi bundle.</p><p>We create the<a id="id256" class="indexterm"/> <code class="literal">DynamicRouterBean</code> class:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5l;

import java.util.Random;

public class DynamicRouterBean {

  public String slip(String body) {
      Random random = new Random();
      int value = random.nextInt(1000);
      if (value &gt;= 500) {
          return "direct:large";
      } else {
          return "direct:small";
      }
  }

}</pre></div><p>This bean randomly and dynamically routes the message to two endpoints—if the generated random number is greater than <code class="literal">500</code>, the message is routed to the <code class="literal">direct:large</code> endpoint, otherwise, the message is routed to the <code class="literal">direct:small</code> endpoint.</p><p>We now create the route using a Blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="dynamicRouterBean" class="com.packt.camel.chapter5l.DynamicRouterBean"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;
              &lt;constant&gt;Hello chapter5l&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;dynamicRouter&gt;
              &lt;method ref="dynamicRouterBean" method="slip"/&gt;
          &lt;/dynamicRouter&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:large"/&gt;
          &lt;to uri="log:large"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:small"/&gt;
          &lt;to uri="log:small"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>This route uses the bean in the <code class="literal">dynamicRouter</code> notation. We create the two routes corresponding to<a id="id257" class="indexterm"/> the target endpoints of the dynamic router.</p><p>We build our OSGi bundle with:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>Our bundle is now ready to be deployed in Karaf.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We deploy and start our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5l/1.0- SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 18:45:48,518 | INFO  | 1 - timer://fire | large | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5l]</strong></span>
<span class="strong"><strong>2014-12-15 18:45:48,518 | INFO  | 1 - timer://fire | small | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5l]</strong></span>
<span class="strong"><strong>2014-12-15 18:45:48,518 | INFO  | 1 - timer://fire | large | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5l]</strong></span>
<span class="strong"><strong>2014-12-15 18:45:48,519 | INFO  | 1 - timer://fire | small | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5l]</strong></span>
<span class="strong"><strong>2014-12-15 18:45:48,519 | INFO  | 1 - timer://fire | large | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5l]</strong></span>
<span class="strong"><strong>2014-12-15 18:45:48,519 | INFO  | 1 - timer://fire | large | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5l]</strong></span>
<span class="strong"><strong>2014-12-15 18:45:48,519 | INFO  | 1 - timer://fire | large | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5l]</strong></span>
</pre></div></div><div class="section" title="Multicast and Recipient List EIPs"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec35"/>Multicast and Recipient List EIPs</h2></div></div></div><p>The Recipient List EIP describes how to send the same message to multiple destinations.</p><p>We have two<a id="id258" class="indexterm"/> kinds of Recipient List:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">When the <a id="id259" class="indexterm"/>destinations are statically defined (at design time), we talk about the static Recipient List or multicast.</li><li class="listitem" style="list-style-type: disc">When the destinations are dynamically defined (at runtime), we talk about the dynamic recipient list</li></ul></div><div class="section" title="The Multicast EIP"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec07"/>The Multicast EIP</h3></div></div></div><p>Let's start with a first example of the Multicast EIP (or a static recipient list).</p><p>We create the following <code class="literal">route.xml</code> Blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:first?period=5000"/&gt;
          &lt;setBody&gt;&lt;constant&gt;Hello chapter5m&lt;/constant&gt;&lt;/setBody&gt;
          &lt;multicast&gt;
              &lt;to uri="direct:france"/&gt;
              &lt;to uri="direct:usa"/&gt;
              &lt;to uri="direct:spain"/&gt;
          &lt;/multicast&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:france"/&gt;
          &lt;to uri="log:france"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:usa"/&gt;
          &lt;to uri="log:usa"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:spain"/&gt;
          &lt;to uri="log:spain"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>The first route creates a <code class="literal">Hello chapter5m</code> message every 5 seconds. This message is sent to three<a id="id260" class="indexterm"/> destinations, <code class="literal">france</code>, <code class="literal">usa</code>, and <code class="literal">spain</code>.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop our <code class="literal">route.xml</code> file into the Karaf <code class="literal">deploy</code> folder.</p><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 18:59:17,198 | INFO  |  - timer://first | france | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5m]</strong></span>
<span class="strong"><strong>2014-12-15 18:59:17,199 | INFO  |  - timer://first | usa | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5m]</strong></span>
<span class="strong"><strong>2014-12-15 18:59:17,200 | INFO  |  - timer://first | spain | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5m]</strong></span>
<span class="strong"><strong>2014-12-15 18:59:22,180 | INFO  |  - timer://first | france | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5m]</strong></span>
<span class="strong"><strong>2014-12-15 18:59:22,182 | INFO  |  - timer://first | usa | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5m]</strong></span>
<span class="strong"><strong>2014-12-15 18:59:22,183 | INFO  |  - timer://first | spain | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5m]</strong></span>
</pre></div><p>We can see that each message has been sent to the three destinations.</p></div><div class="section" title="The Recipient List EIP"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec08"/>The Recipient List EIP</h3></div></div></div><p>To illustrate <a id="id261" class="indexterm"/>a dynamic recipient list, we create a route that uses a bean to dynamically define the target destinations.</p><p>We create a simple Maven <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5n&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>This Maven <code class="literal">pom.xml</code> file just packages our route and the bean as an OSGi bundle.</p><p>We create a simple <code class="literal">RouterBean</code> class that randomly changes the recipient list:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5n;

import java.util.Random;

public class RouterBean {

  public String populate(String body) {
      Random random = new Random();
      int value = random.nextInt(1000);
      if (value &gt;= 500) {
          return "direct:one,direct:two,direct:three";
      } else {
          return "direct:one,direct:two";
      }
  }
}</pre></div><p>If the random<a id="id262" class="indexterm"/> integer is greater than <code class="literal">500</code>, the message is routed to the <code class="literal">direct:one</code>, <code class="literal">direct:two</code>, and <code class="literal">direct:three</code> endpoints. Otherwise, the message is just routed to the <code class="literal">direct:one</code> and <code class="literal">direct:two</code> endpoints.</p><p>Finally, we use this bean to populate a header in a route. This header is used by the recipient list:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="routerBean" class="com.packt.camel.chapter5n.RouterBean"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;
              &lt;constant&gt;Hello chapter5n&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;setHeader headerName="recipientList"&gt;
              &lt;method bean="routerBean" method="populate"/&gt;
          &lt;/setHeader&gt;
          &lt;recipientList delimiter=","&gt;
              &lt;header&gt;recipientList&lt;/header&gt;
          &lt;/recipientList&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:one"/&gt;
          &lt;to uri="log:one"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:two"/&gt;
          &lt;to uri="log:two"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:three"/&gt;
          &lt;to uri="log:three"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We build our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>Our bundle is ready to be deployed in Karaf.</p><p>We start Karaf<a id="id263" class="indexterm"/> and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We install our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5n/1.0- SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 19:12:32,975 | INFO  | 1 - timer://fire | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5n]</strong></span>
<span class="strong"><strong>2014-12-15 19:12:32,976 | INFO  | 1 - timer://fire | two | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5n]</strong></span>
<span class="strong"><strong>2014-12-15 19:12:37,949 | INFO  | 1 - timer://fire | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5n]</strong></span>
<span class="strong"><strong>2014-12-15 19:12:37,950 | INFO  | 1 - timer://fire | two | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5n]</strong></span>
<span class="strong"><strong>2014-12-15 19:12:37,950 | INFO  | 1 - timer://fire | three | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5n]</strong></span>
</pre></div><p>We can see that the destinations dynamically change, depending on the result of the randomized integer.</p></div></div><div class="section" title="The Splitter and Aggregator EIPs"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec36"/>The Splitter and Aggregator EIPs</h2></div></div></div><p>These EIPs <a id="id264" class="indexterm"/>are responsible for splitting a big message into<a id="id265" class="indexterm"/> chunks, or aggregating  small chunks in one whole message.</p><div class="section" title="The Splitter EIP"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec09"/>The Splitter EIP</h3></div></div></div><p>The Splitter EIP describes how to split big messages into multiple chunks, processed individually.</p><p>Camel supports this EIP, allowing you to define the splitting logic using any supported language or a processor/bean.</p><p>To illustrate the Splitter EIP, we create the following <code class="literal">route.xml</code> Blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;split&gt;
              &lt;xpath&gt;//person&lt;/xpath&gt;
              &lt;to uri="log:chunk"/&gt;
          &lt;/split&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>This route consumes files from the <code class="literal">/tmp/in</code> folder, and splits the content using <code class="literal">XPath</code>.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop the <code class="literal">route.xml</code> into the Karaf <code class="literal">deploy</code> folder.</p><p>In the <code class="literal">/tmp/in</code> folder, we create the following <code class="literal">persons.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;persons&gt;
   &lt;person&gt;
    &lt;name&gt;jbonofre&lt;/name&gt;
    &lt;address&gt;France&lt;/address&gt;
   &lt;/person&gt;
   &lt;person&gt;
    &lt;name&gt;Bob&lt;/name&gt;
    &lt;address&gt;USA&lt;/address&gt;
   &lt;/person&gt;
   &lt;person&gt;
    &lt;name&gt;Juan&lt;/name&gt;
    &lt;address&gt;Spain&lt;/address&gt;
   &lt;/person&gt;
&lt;/persons&gt;</pre></div><p>In the<a id="id266" class="indexterm"/> Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 19:30:35,624 | INFO  | - file:///tmp/in | chunk | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: org.apache.xerces.dom.DeferredElementNSImpl, Body: &lt;person&gt; &lt;name&gt;jbonofre&lt;/name&gt; &lt;address&gt;France&lt;/address&gt; &lt;/person&gt;]</strong></span>
<span class="strong"><strong>2014-12-15 19:30:35,624 | INFO  | - file:///tmp/in | chunk | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: org.apache.xerces.dom.DeferredElementNSImpl, Body: &lt;person&gt; &lt;name&gt;Bob&lt;/name&gt; &lt;address&gt;USA&lt;/address&gt;   &lt;/person&gt;]</strong></span>
<span class="strong"><strong>2014-12-15 19:30:35,625 | INFO  | - file:///tmp/in | chunk | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: org.apache.xerces.dom.DeferredElementNSImpl, Body: &lt;person&gt;    &lt;name&gt;Juan&lt;/name&gt;    &lt;address&gt;Spain&lt;/address&gt; &lt;/person&gt;]</strong></span>
</pre></div><p>We can see that the <span class="emphasis"><em>big</em></span> file has been split into <span class="emphasis"><em>small</em></span> messages.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Camel supports multiple split strategies (using languages, tokens, custom beans, and so on).</p></div></div></div><div class="section" title="Aggregator"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec10"/>Aggregator</h3></div></div></div><p>The Aggregator EIP is the <a id="id267" class="indexterm"/>exact opposite of the Splitter EIP—we receive multiple <span class="emphasis"><em>small</em></span> messages that we want to aggregate into one <span class="emphasis"><em>big</em></span> message.</p><p>Camel supports this EIP. You have to provide two things to the aggregator:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A bean implementing Camel <code class="literal">AggregationStrategy</code>, which defines the way you aggregate the new message with the previously aggregated message (the <span class="emphasis"><em>message growing</em></span>)</li><li class="listitem" style="list-style-type: disc">The aggregation completion, which defines when we consider the aggregation to be complete</li></ul></div><p>You have different alternatives for the completion of the following task:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">completionTimeout</code> is an inactivity timeout. If no new exchanges come into the aggregator after this timeout, the aggregation is considered to be complete.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">completionInterval</code> considers the aggregation to be complete after a given amount of time.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">completionSize</code> is a static number of exchanges to aggregate.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">completionPredicate</code> is the most evolved. The aggregation is considered to be complete when the predicate is true.</li></ul></div><p>To illustrate the <a id="id268" class="indexterm"/>Aggregator EIP, we create a route that aggregates a static number of messages.</p><p>We package the bean (used for the aggregation strategy) and the route definition as an OSGi bundle.</p><p>We create the following Maven <code class="literal">pom.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5p&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;dependencies&gt;
      &lt;dependency&gt;
          &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
          &lt;artifactId&gt;camel-core&lt;/artifactId&gt;
          &lt;version&gt;2.12.4&lt;/version&gt;
      &lt;/dependency&gt;
  &lt;/dependencies&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>We create the <code class="literal">StringAggregator</code> class, which implements an aggregation strategy appending <a id="id269" class="indexterm"/>strings:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5p;

import org.apache.camel.Exchange;
import org.apache.camel.processor.aggregate.AggregationStrategy;

public class StringAggregator implements AggregationStrategy {

  public Exchange aggregate(Exchange oldExchange, Exchange newExchange) {
      if (oldExchange == null) {
          return newExchange;
      }
      String oldBody = oldExchange.getIn().getBody(String.class);
      String newBody = newExchange.getIn().getBody(String.class);
      oldExchange.getIn().setBody(oldBody + "+" + newBody);
      return oldExchange;
  }

}</pre></div><p>We create the route using the Blueprint DSL with an aggregator with our <code class="literal">StringAggregator</code> and a <code class="literal">completionSize</code> class:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="aggregator" class="com.packt.camel.chapter5p.StringAggregator"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;
              &lt;constant&gt;Hello chapter5p&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;setHeader headerName="id"&gt;
              &lt;constant&gt;same&lt;/constant&gt;
          &lt;/setHeader&gt;
          &lt;aggregate strategyRef="aggregator" completionSize="5"&gt;
              &lt;correlationExpression&gt;
                  &lt;simple&gt;header.id&lt;/simple&gt;
              &lt;/correlationExpression&gt;
              &lt;to uri="log:aggregated"/&gt;
          &lt;/aggregate&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>The messages correlation (to identify that we are in the same aggregation unit) is defined using the<a id="id270" class="indexterm"/> header ID. This route aggregates five messages together.</p><p>We build our OSGi bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>Our bundle is ready to be deployed in Karaf.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We install and start our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5p/1.0- SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 21:07:22,386 | INFO  | 1 - timer://fire | aggregated | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5p+Hello chapter5p+Hello chapter5p+Hello chapter5p+Hello chapter5p]</strong></span>
<span class="strong"><strong>2014-12-15 21:07:47,380 | INFO  | 1 - timer://fire | aggregated | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5p+Hello chapter5p+Hello chapter5p+Hello chapter5p+Hello chapter5p]</strong></span>
</pre></div><p>We can see that our route aggregated 5 <code class="literal">Hello chapter5p</code> messages.</p></div></div><div class="section" title="The Resequencer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec37"/>The Resequencer EIP</h2></div></div></div><p>The Resequencer EIP describes how to sort the processing of the messages. It uses a comparator to define the sequence of the messages.</p><p>Camel uses an expression<a id="id271" class="indexterm"/> to create the comparator. It means that the comparator can use the body of the message, a header, and so on. You define the expression in the Camel resequencer notation.</p><p>To illustrate the Resequencer EIP, we use the following <code class="literal">route.xml</code> Blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:first?period=2000"/&gt;
          &lt;setBody&gt;&lt;constant&gt;one&lt;/constant&gt;&lt;/setBody&gt;
          &lt;to uri="direct:resequencer"/&gt;
      &lt;/route
      &lt;route&gt;
          &lt;from uri="timer:second?period=2000"/&gt;
          &lt;setBody&gt;&lt;constant&gt;two&lt;/constant&gt;&lt;/setBody&gt;
          &lt;to uri="direct:resequencer"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
           &lt;from uri="direct:resequencer"/&gt;
           &lt;resequence&gt;
              &lt;simple&gt;body&lt;/simple&gt;
              &lt;to uri="log:requencer"/&gt;
           &lt;/resequence&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>Two routes generate a message every 2 seconds. Both routes send the message to the resequencer route. The resequencer uses a string comparator on the body of the messages, to guarantee the same processing order, <code class="literal">one</code> first, <code class="literal">two</code> after.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop the <code class="literal">route.xml</code> file into the Karaf <code class="literal">deploy</code> folder.</p><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 21:22:16,769 | INFO  | 0 - Batch Sender | requencer | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: one]</strong></span>
<span class="strong"><strong>2014-12-15 21:22:16,770 | INFO  | 0 - Batch Sender | requencer | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: two]</strong></span>
<span class="strong"><strong>2014-12-15 21:22:18,746 | INFO  | 0 - Batch Sender | requencer | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: one]</strong></span>
<span class="strong"><strong>2014-12-15 21:22:18,747 | INFO  | 0 - Batch Sender | requencer | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: two]</strong></span>
</pre></div><p>We can see<a id="id272" class="indexterm"/> that the messages are always processed in the same sequence, <code class="literal">one</code> first, <code class="literal">two</code> after.</p></div><div class="section" title="The Composed Message Processor EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>The Composed Message Processor EIP</h2></div></div></div><p>The Composed <a id="id273" class="indexterm"/>Message Processor EIP is a combination of the Splitter EIP and the Aggregator EIP. The purpose is:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To split a big message into chunk messages</li><li class="listitem" style="list-style-type: disc">To process each chunk independently</li><li class="listitem" style="list-style-type: disc">To reaggregate each chunk response as a big message again</li></ul></div><p>Camel supports this EIP in two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using a pure combination of the Splitter and Aggregator EIPs</li><li class="listitem" style="list-style-type: disc">Using only Splitter</li></ul></div><p>The later is the easiest to use. It allows you to define the aggregation strategy directly on the splitter. The aggregation completion is defined by the Splitter as he knows the number of chunks he has created.</p><p>We illustrate the splitter-based Composed Message Processor EIP with an example that splits a <code class="literal">persons.xml</code> file with <code class="literal">XPath</code>, processes each person individually, and reaggregates the resulting message as a big one.</p><p>We create the following Maven <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5r&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;dependencies&gt;
      &lt;dependency&gt;
          &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
          &lt;artifactId&gt;camel-core&lt;/artifactId&gt;
          &lt;version&gt;2.12.4&lt;/version&gt;
      &lt;/dependency&gt;
  &lt;/dependencies&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>We create<a id="id274" class="indexterm"/> a custom aggregation strategy, <code class="literal">MyAggregator</code>, that works directly using the message string:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5r;

import org.apache.camel.Exchange;
import org.apache.camel.processor.aggregate.AggregationStrategy;

public class MyAggregator implements AggregationStrategy {

  public Exchange aggregate(Exchange oldExchange, Exchange   newExchange) {

      if (oldExchange == null) {
          return newExchange;
      }

      String persons = oldExchange.getIn().getBody(String.class);
      String newPerson = newExchange.getIn().getBody(String.class);

      // put orders together separating by semi colon
      persons = persons + newPerson;
      oldExchange.getIn().setBody(persons);

      return oldExchange;
  }

}</pre></div><p>We create a route using the Blueprint DSL:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="aggregator" class="com.packt.camel.chapter5r.MyAggregator"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="file:/tmp/in"/&gt;
          &lt;split strategyRef="aggregator"&gt;
              &lt;xpath&gt;//person&lt;/xpath&gt;
              &lt;to uri="log:person"/&gt;
          &lt;/split&gt;
          &lt;to uri="log:persons"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>This route <a id="id275" class="indexterm"/>consumes files from the <code class="literal">/tmp/in</code> folder, splits the messages using an <code class="literal">XPath</code> expression, and reaggregates after using the <code class="literal">MyAggregator</code> strategy.</p><p>We can now compile our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">$ bin/karaf
karaf@root()&gt; feature:repo-add camel 2.12.4
Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features
karaf@root()&gt; feature:install camel-blueprint</pre></div><p>We install and start our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5r/1.0- SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>In the Karaf <a id="id276" class="indexterm"/>
<code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 21:42:38,803 | INFO  | - file:///tmp/in | person | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: org.apache.xerces.dom.DeferredElementNSImpl, Body: &lt;person&gt;&lt;name&gt;jbonofre&lt;/name&gt;&lt;address&gt;France&lt;/address&gt;&lt;/person&gt;]</strong></span>
<span class="strong"><strong>2014-12-15 21:42:38,804 | INFO  | - file:///tmp/in | person | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: org.apache.xerces.dom.DeferredElementNSImpl, Body: &lt;person&gt;&lt;name&gt;Bob&lt;/name&gt;&lt;address&gt;USA&lt;/address&gt;&lt;/person&gt;]</strong></span>
<span class="strong"><strong>2014-12-15 21:42:38,806 | INFO  | - file:///tmp/in | person | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: org.apache.xerces.dom.DeferredElementNSImpl, Body: &lt;person&gt;&lt;name&gt;Juan&lt;/name&gt;&lt;address&gt;Spain&lt;/address&gt;&lt;/person&gt;]</strong></span>
<span class="strong"><strong>2014-12-15 21:42:38,806 | INFO  | - file:///tmp/in | persons | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: &lt;person&gt;&lt;name&gt;jbonofre&lt;/name&gt;&lt;address&gt;France&lt;/address&gt;&lt;/person&gt;&lt;perso n&gt;&lt;name&gt;Bob&lt;/name&gt;&lt;address&gt;USA&lt;/address&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Juan&lt;/ name&gt;&lt;address&gt;Spain&lt;/address&gt;&lt;/person&gt;]</strong></span>
</pre></div><p>We can see that the splitter isolated each person that has been processed individually. After the split, the messages have been reaggregated again, as we can see in the latest <code class="literal">log</code> message.</p></div><div class="section" title="The Scatter-Gather EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>The Scatter-Gather EIP</h2></div></div></div><p>The Scatter-Gather EIP is similar to<a id="id277" class="indexterm"/> the Composed Message Processor EIP, but instead of splitting and aggregating, we first use a recipient list (static or dynamic) and an aggregator with the response coming from the different recipients.</p><p>Camel supports this EIP with the combination of recipient list/multicast and aggregate.</p></div><div class="section" title="The Routing Slip EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>The Routing Slip EIP</h2></div></div></div><p>The Routing Slip<a id="id278" class="indexterm"/> EIP describes how to dynamically define the processing steps of a message.</p><p>In a Camel route, the routing steps are statically defined; it's the route itself. However, you can use the <code class="literal">routingSlip</code> notation to define the next steps of the routing at runtime.</p><p>It's exactly like a dynamic recipient list, but the processing is not in parallel, it's in sequence.</p><p>To illustrate this EIP, we create a route that uses a bean to position a header containing the next <a id="id279" class="indexterm"/>processing steps.</p><p>We create the following Maven <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5s&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>We create the following <code class="literal">RoutingSlipBean</code> class, which randomly defines the next steps of the routing:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5s;

import java.util.Random;

public class RoutingSlipBean {

  public String nextSteps(String body) {
      Random random = new Random();
      int value = random.nextInt(1000);
      if (value &gt;= 500) {
          return "direct:one,direct:two";
      } else {
          return "direct:one";
      }
  }

}</pre></div><p>We use this<a id="id280" class="indexterm"/> bean in a Camel route written using the Blueprint DSL to define a <code class="literal">slip</code> header. This header is used by <code class="literal">routingslip</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="routingSlipBean" class="com.packt.camel.chapter5s.RoutingSlipBean"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;
              &lt;constant&gt;Hello chapter5s&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;setHeader headerName="slip"&gt;
              &lt;method bean="routingSlipBean" method="nextSteps"/&gt;
          &lt;/setHeader&gt;
          &lt;routingSlip uriDelimiter=","&gt;
              &lt;header&gt;slip&lt;/header&gt;
          &lt;/routingSlip&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:one"/&gt;
          &lt;to uri="log:one"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:two"/&gt;
          &lt;to uri="log:two"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We now build our OSGi bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>Our bundle is ready to be deployed in Karaf.</p><p>We start Karaf<a id="id281" class="indexterm"/> and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We install and start our bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5s/1.0- SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-15 22:02:19,110 | INFO  | 1 - timer://fire | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5s]</strong></span>
<span class="strong"><strong>2014-12-15 22:02:19,111 | INFO  | 1 - timer://fire | two | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5s]</strong></span>
<span class="strong"><strong>2014-12-15 22:02:24,090 | INFO  | 1 - timer://fire | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5s]</strong></span>
<span class="strong"><strong>2014-12-15 22:02:29,090 | INFO  | 1 - timer://fire | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5s]</strong></span>
<span class="strong"><strong>2014-12-15 22:02:29,091 | INFO  | 1 - timer://fire | two | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5s]</strong></span>
<span class="strong"><strong>2014-12-15 22:02:34,090 | INFO  | 1 - timer://fire | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5s]</strong></span>
<span class="strong"><strong>2014-12-15 22:02:39,091 | INFO  | 1 - timer://fire | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5s]</strong></span>
</pre></div><p>We can see (with the timestamps) that, sometimes, both one and two steps/routes are called, and sometimes only one is called.</p></div><div class="section" title="The Throttler and Sampling EIPs"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>The Throttler and Sampling EIPs</h2></div></div></div><p>These EIPs provide support of messaging Quality of Service (QoS). This  allows you to implement some <a id="id282" class="indexterm"/>Service Level Agreement (SLA), limiting the threshold <a id="id283" class="indexterm"/>on some endpoints.</p><div class="section" title="The Throttler EIP"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec11"/>The Throttler EIP</h3></div></div></div><p>The Throttler EIP describes how to limit the number of messages reaching an endpoint, to avoid it. This allows you to guarantee SLA on routes, parts of routes, and applications.</p><p>Camel supports this EIP by providing the <code class="literal">throttle</code> notation. On the Throttle, you define a given period, and the maximum number of messages (or requests) allowed in the period. This number of messages can be static, or dynamic (using a header for instance).</p><p>To illustrate the Throttler EIP, we create the following <code class="literal">route.xml</code> Blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:first?period=500"/&gt;
          &lt;setBody&gt;&lt;constant&gt;Hello chapter5t&lt;/constant&gt;&lt;/setBody&gt;
          &lt;throttle timePeriodMillis="2000"&gt;
              &lt;constant&gt;1&lt;/constant&gt;
              &lt;to uri="direct:sla"/&gt;
          &lt;/throttle&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:sla"/&gt;
          &lt;to uri="log:sla"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop the <code class="literal">route.xml</code> into the Karaf <code class="literal">deploy</code> folder.</p><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-16 07:05:03,106 | INFO  |  - timer://first | sla | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5t]</strong></span>
<span class="strong"><strong>2014-12-16 07:05:05,105 | INFO  |  - timer://first | sla | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5t]</strong></span>
<span class="strong"><strong>2014-12-16 07:05:07,105 | INFO  |  - timer://first | sla | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5t]</strong></span>
<span class="strong"><strong>2014-12-16 07:05:09,105 | INFO  |  - timer://first | sla | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5t]</strong></span>
<span class="strong"><strong>2014-12-16 07:05:11,104 | INFO  |  - timer://first | sla | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5t]</strong></span>
</pre></div><p>We can note the<a id="id284" class="indexterm"/> timestamp where we have only one message every two seconds, whereas the timer creates a message every 0.5 seconds; we have here an illustration of the Throttler EIP.</p></div><div class="section" title="The Sampling EIP"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec12"/>The Sampling EIP</h3></div></div></div><p>The Sampling EIP is related to<a id="id285" class="indexterm"/> the Throttler EIP. The purpose is to take a message sample periodically:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Every given number of messages</li><li class="listitem" style="list-style-type: disc">Every given time</li></ul></div><p>All the <span class="emphasis"><em>other</em></span> traffic is ignored.</p><p>Camel supports this EIP via the usage of the <code class="literal">sample</code> notation. The sample notation supports the <code class="literal">messageFrequency</code> or <code class="literal">samplePeriod</code> properties.</p><p>To illustrate the Sampling EIP, we create the following <code class="literal">route.xml</code> blueprint XML descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:first?period=500"/&gt;
          &lt;setBody&gt;&lt;constant&gt;Hello chapter5u&lt;/constant&gt;&lt;/setBody&gt;
          &lt;to uri="log:regular"/&gt;
          &lt;sample messageFrequency="5"&gt;
              &lt;to uri="direct:frequency"/&gt;
          &lt;/sample&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:frequency"/&gt;
          &lt;to uri="log:frequency"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>The first route creates a message every 0.5 seconds. We log with the <code class="literal">regular</code> log. We use a <code class="literal">sample</code> notation to send the fifth message to the frequency route (so every five messages, we send the sample).</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop <a id="id286" class="indexterm"/>our <code class="literal">route.xml</code> file into the Karaf <code class="literal">deploy</code> folder.</p><p>In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-16 14:57:59,342 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:57:59,824 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:00,324 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:00,824 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:01,324 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:01,325 | INFO  |  - timer://first | frequency | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:01,824 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:02,324 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:02,825 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:03,325 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:03,825 | INFO  |  - timer://first | regular | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
<span class="strong"><strong>2014-12-16 14:58:03,826 | INFO  |  - timer://first | frequency | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5u]</strong></span>
</pre></div><p>So, we can <a id="id287" class="indexterm"/>see that the frequency route gets a <code class="literal">sample</code> notation for every five messages of regular load.</p></div></div><div class="section" title="The Delayer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec42"/>The Delayer EIP</h2></div></div></div><p>The Delayer EIP allows you to add some kind of pause in the delivery of a message. It's like a sleep in the routing.</p><p>Camel supports this<a id="id288" class="indexterm"/> EIP using the <code class="literal">delay</code> notation. The delay notation accepts an expression to get the pause time. You can use any language supported by Camel for this expression.</p><p>We used this EIP in the <code class="literal">chapter5g</code> and <code class="literal">chapter5h</code> examples.</p><p>In these examples, we used a constant to define the delay time. It's also possible to use an expression returning the delay time. As always, the expression can be written using any language supported by Camel.</p><p>To illustrate the Delayer EIP with a dynamic delay time, we create a route that uses a bean to define the delay time (randomly).</p><p>We create the following Maven <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.packt.camel&lt;/groupId&gt;
  &lt;artifactId&gt;chapter5v&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;bundle&lt;/packaging&gt;

  &lt;build&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
              &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.3.7&lt;/version&gt;
              &lt;extensions&gt;true&lt;/extensions&gt;
              &lt;configuration&gt;
                  &lt;instructions&gt;
                      &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                  &lt;/instructions&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
  &lt;/build&gt;

&lt;/project&gt;</pre></div><p>This Maven <code class="literal">pom.xml</code> file is very simple, just packaging the Blueprint XML definition of the route and the bean as an OSGi bundle.</p><p>We create a<a id="id289" class="indexterm"/> simple bean that randomly creates the delay time:</p><div class="informalexample"><pre class="programlisting">package com.packt.camel.chapter5v;

import java.util.Random;

public class DelayBean {

  public int delay() {
      Random random = new Random();
      return random.nextInt(10000);
  }

}</pre></div><p>We create a route using the blueprint DSL:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;bean id="delayBean" class="com.packt.camel.chapter5v.DelayBean"/&gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=1000"/&gt;
          &lt;setBody&gt;
              &lt;constant&gt;Hello chapter5v&lt;/constant&gt;
          &lt;/setBody&gt;
          &lt;delay&gt;
              &lt;method ref="delayBean" method="delay"/&gt;
          &lt;/delay&gt;
          &lt;to uri="log:delay"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>This route<a id="id290" class="indexterm"/> creates a message every second with a timer, and uses the bean in the <code class="literal">delay</code> notation.</p><p>We build our OSGi bundle:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean install</strong></span>
</pre></div><p>Our OSGi bundle is ready to be deployed in Karaf.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We deploy our OSGi bundle in Karaf:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install -s mvn:com.packt.camel/chapter5v/1.0- SNAPSHOT</strong></span>
<span class="strong"><strong>Bundle ID: 73</strong></span>
</pre></div><p>If we take a look in the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-16 17:23:57,477 | INFO  | 1 - timer://fire | delay | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5v]</strong></span>
<span class="strong"><strong>2014-12-16 17:23:58,914 | INFO  | 1 - timer://fire | delay | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5v]</strong></span>
<span class="strong"><strong>2014-12-16 17:24:05,976 | INFO  | 1 - timer://fire | delay | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5v]</strong></span>
<span class="strong"><strong>2014-12-16 17:24:14,083 | INFO  | 1 - timer://fire | delay | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5v]</strong></span>
<span class="strong"><strong>2014-12-16 17:24:20,893 | INFO  | 1 - timer://fire | delay | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5v]</strong></span>
<span class="strong"><strong>2014-12-16 17:24:30,350 | INFO  | 1 - timer://fire | delay | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5v]</strong></span>
</pre></div><p>We can note that the message is delivered randomly (see the timestamp), showing the Delayer EIP in<a id="id291" class="indexterm"/> action.</p></div><div class="section" title="The Load Balancer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec43"/>The Load Balancer EIP</h2></div></div></div><p>The Load Balancer<a id="id292" class="indexterm"/> EIP dispatches the load of messages to different endpoints.</p><p>Camel supports this EIP with the <code class="literal">loadBalance</code> notation, which also supports different balancing policies such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The round-robin policy uses a kind of <span class="emphasis"><em>circle</em></span> between the different endpoints</li><li class="listitem" style="list-style-type: disc">The random policy picks up one endpoint randomly</li><li class="listitem" style="list-style-type: disc">The sticky policy uses an expression to select the target endpoint</li><li class="listitem" style="list-style-type: disc">The topic policy sends the message to all the endpoints (like a JMS topic)</li><li class="listitem" style="list-style-type: disc">The failover policy forwards the message to the next endpoint if the first target failed</li><li class="listitem" style="list-style-type: disc">The weighted round-robin policy is like the round-robin policy, but you can give a ratio to the different endpoints to use them on high priority</li><li class="listitem" style="list-style-type: disc">The weighted random policy is like the random policy, but you can give a ratio to the different endpoints to use them on high priority</li><li class="listitem" style="list-style-type: disc">The custom policy allows you to implement your own load balancing policy</li></ul></div><p>To illustrate the Load Balancer EIP, we use the following <code class="literal">route.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:first?period=1000"/&gt;
          &lt;setBody&gt;&lt;constant&gt;Hello chapter5w&lt;/constant&gt;&lt;/setBody&gt;
          &lt;loadBalance&gt;
               &lt;roundRobin/&gt;
               &lt;to uri="direct:one"/&gt;
               &lt;to uri="direct:two"/&gt;
               &lt;to uri="direct:three"/&gt;
          &lt;/loadBalance&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:one"/&gt;
          &lt;to uri="log:one"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:two"/&gt;
          &lt;to uri="log:two"/&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:three"/&gt;
          &lt;to uri="log:three"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>The first route creates a message every second. The message is load balanced with the round-robin policy to the three endpoints: <code class="literal">direct:one</code>, <code class="literal">direct:two</code>, and <code class="literal">direct:three</code>.</p><p>We start<a id="id293" class="indexterm"/> Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop the <code class="literal">route.xml</code> file into the Karaf <code class="literal">deploy</code> folder. In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-16 17:58:33,370 | INFO  |  - timer://first | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
<span class="strong"><strong>2014-12-16 17:58:34,356 | INFO  |  - timer://first | two | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
<span class="strong"><strong>2014-12-16 17:58:35,355 | INFO  |  - timer://first | three | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
<span class="strong"><strong>2014-12-16 17:58:36,355 | INFO  |  - timer://first | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
<span class="strong"><strong>2014-12-16 17:58:37,355 | INFO  |  - timer://first | two | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
<span class="strong"><strong>2014-12-16 17:58:38,355 | INFO  |  - timer://first | three | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
<span class="strong"><strong>2014-12-16 17:58:39,355 | INFO  |  - timer://first | one | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
<span class="strong"><strong>2014-12-16 17:58:40,356 | INFO  |  - timer://first | two | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5w]</strong></span>
</pre></div><p>Here, we note that<a id="id294" class="indexterm"/> each message is load balanced to the three endpoints in a round-robin manner.</p></div><div class="section" title="The Loop EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec44"/>The Loop EIP</h2></div></div></div><p>The Loop EIP describes <a id="id295" class="indexterm"/>how to iterate a message on the same endpoint multiple times.</p><p>Camel supports this EIP using the <code class="literal">loop</code> notation. The number of iterations can be a constant, or the result of an expression (using any language supported by Camel).</p><p>To illustrate the Loop EIP, we create the following <code class="literal">route.xml</code> blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:first?period=1000"/&gt;
          &lt;setBody&gt;&lt;constant&gt;Hello chapter5x&lt;/constant&gt;&lt;/setBody&gt;
          &lt;to uri="log:main"/&gt;
          &lt;loop&gt;
              &lt;constant&gt;3&lt;/constant&gt;
              &lt;to uri="direct:loop"/&gt;
          &lt;/loop&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:loop"/&gt;
          &lt;to uri="log:loop"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>This route creates a message every second and logs this message. The message is sent to a loop performing three iterations.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop the <code class="literal">route.xml</code> file into the Karaf <code class="literal">deploy</code> folder. In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-16 18:19:35,000 | INFO  |  - timer://first | main | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
<span class="strong"><strong>2014-12-16 18:19:35,001 | INFO  |  - timer://first | loop | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
<span class="strong"><strong>2014-12-16 18:19:35,002 | INFO  |  - timer://first | loop | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
<span class="strong"><strong>2014-12-16 18:19:35,002 | INFO  |  - timer://first | loop | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
<span class="strong"><strong>2014-12-16 18:19:35,982 | INFO  |  - timer://first | main | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
<span class="strong"><strong>2014-12-16 18:19:35,982 | INFO  |  - timer://first | loop | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
<span class="strong"><strong>2014-12-16 18:19:35,983 | INFO  |  - timer://first | loop | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
<span class="strong"><strong>2014-12-16 18:19:35,983 | INFO  |  - timer://first | loop | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5x]</strong></span>
</pre></div><p>We can<a id="id296" class="indexterm"/> note that the message has been processed three times by the loop route.</p></div></div>
<div class="section" title="Message Transformation EIPs"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Message Transformation EIPs</h1></div></div></div><p>These EIPs are<a id="id297" class="indexterm"/> extensions of the Message Translator EIP, and are dedicated to <a id="id298" class="indexterm"/>some special use cases.</p><div class="section" title="The Content Enricher EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec45"/>The Content Enricher EIP</h2></div></div></div><p>The Content Enricher EIP describes how to enrich the message with another system. For instance, the message <a id="id299" class="indexterm"/>contains an identifier, and you want to populate the data associated with this ID from a database.</p><p>To implement this EIP, you can use a bean or a processor as you do in the Message Translator EIP.</p><p>You can also use an endpoint that uses a transformation tool (such as <code class="literal">Velocity</code>, <code class="literal">Xslt</code>, and so on).</p><p>However, Camel provides two notations dedicated to content enrichment. They are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">enrich</code> uses a producer endpoint to retrieve the data and use an aggregation strategy (like in the Aggregator EIP) to merge the data. For instance, <code class="literal">enrich</code> is used to call a webservice or another direct endpoint.</li><li class="listitem" style="list-style-type: disc"><code class="literal">pollEnrich</code>, on the other hand, uses a consumer endpoint to poll the data and use an aggregation strategy<a id="id300" class="indexterm"/> to merge the data. For instance, <code class="literal">pollEnrich</code> is used when polling a file on the filesystem.</li></ul></div></div><div class="section" title="The Content Filter EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec46"/>The Content Filter EIP</h2></div></div></div><p>The Content Filter EIP<a id="id301" class="indexterm"/> describes how to remove part of the content of the message when the message is too large.</p><p>Camel supports this EIP by:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using a bean or a processor as in the Message Translator EIP</li><li class="listitem" style="list-style-type: disc">Using the <code class="literal">setBody</code> notation containing a filter expression (such as <code class="literal">XPath</code>)</li></ul></div></div><div class="section" title="The Claim Check EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec47"/>The Claim Check EIP</h2></div></div></div><p>The Claim Check EIP describes<a id="id302" class="indexterm"/> how to replace the content of the message with a claim check (unique key), which you can use later to retrieve the message again. The message content is identified by the identifier and stored temporarily in a store such as a database or the filesystem. This pattern is really interesting to deal with very large messages that you don't want to transport to all parts of the routing.</p><p>Camel supports this EIP by combining Pipeline and a dedicated bean to store and retrieve the message using the identifier.</p></div><div class="section" title="The Normalizer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec48"/>The Normalizer EIP</h2></div></div></div><p>The Normalizer EIP is a<a id="id303" class="indexterm"/> combination of the Message Router EIP to deal with multiple message formats, and transform the messages into a canonical and normalized message format. One <span class="emphasis"><em>classic</em></span> use is to transform all messages into a unique canonical format.</p><p>Camel supports this EIP by combining a content-based router and a series of beans to translate the message into the normalized format.</p></div><div class="section" title="The Sort EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec49"/>The Sort EIP</h2></div></div></div><p>The Sort EIP sorts the content of the message. Basically, it applies a comparator to the message body.</p><p>Camel supports this EIP<a id="id304" class="indexterm"/> using the <code class="literal">sort</code> notation. You can provide what you want to sort (basically the body) and optionally, the comparator to use.</p></div><div class="section" title="The Validate EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec50"/>The Validate EIP</h2></div></div></div><p>The Validate EIP uses an expression or a predicate to validate the content of the message. This EIP allows you to validate the payload of a message before processing it. Thanks to this, you avoid mistakes<a id="id305" class="indexterm"/> due to an invalid format.</p><p>Camel supports this EIP with the <code class="literal">validate</code> notation. The validate notation expects an expression, which is defined using any language supported by Camel.</p></div></div>
<div class="section" title="The Messaging Endpoints EIPs"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec47"/>The Messaging Endpoints EIPs</h1></div></div></div><p>The Messaging Endpoints EIPs are<a id="id306" class="indexterm"/> related to endpoints in a Camel route. Camel supports them implicitly by using the different features provided by the<a id="id307" class="indexterm"/> endpoints.</p><div class="section" title="The Messaging Mapper EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec51"/>The Messaging Mapper EIP</h2></div></div></div><p>The Messaging<a id="id308" class="indexterm"/> Mapper EIP is actually the same thing as the Message Translator EIP, just located at the endpoint level.</p><p>In Camel, it just means that you use a bean or a processor in the same way that you do to implement the Message Translator EIP.</p></div><div class="section" title="The Event Driven Consumer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec52"/>The Event Driven Consumer EIP</h2></div></div></div><p>The Event Driven Consumer EIP describes an endpoint that listens for incoming messages. The <a id="id309" class="indexterm"/>endpoint reacts when it gets a message.</p><p>Camel supports this EIP by providing the components' bootstrapping endpoints that can work this way. It's the case for the CXF or JMS components, for instance.</p><p>This EIP is supported implicitly by Camel (you don't have to use any special notation).</p></div><div class="section" title="The Polling Consumer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec53"/>The Polling Consumer EIP</h2></div></div></div><p>The Polling<a id="id310" class="indexterm"/> Consumer EIP describes an endpoint that periodically polls a system (database, file system) to generate messages.</p><p>As in the Event Driven Consumer EIP, Camel supports this EIP by providing the components' bootstrapping endpoints that can work this way. This is the case for the file or FTP components, for instance.</p><p>This EIP is supported implicitly by Camel (you don't have to use any special notation).</p></div><div class="section" title="The Competing Consumer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec54"/>The Competing Consumer EIP</h2></div></div></div><p>The Competing Consumer EIP describes how to use multiple concurrent consumers on a single endpoint.</p><p>Camel supports this EIP <a id="id311" class="indexterm"/>on some components. For instance, the SEDA, VM, and JMS components support this EIP using the <code class="literal">concurrentConsumers</code> property (with a value greater than <code class="literal">1</code>).</p></div><div class="section" title="The Message Dispatcher EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec55"/>The Message Dispatcher EIP</h2></div></div></div><p>The Message Dispatcher EIP describes how to dispatch a message to different endpoints, depending on some conditions. It's basically the same as the Message Router EIP.</p><p>Camel supports the <a id="id312" class="indexterm"/>Message Dispatcher EIP in two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using the Content Based Router EIP (and so, the <code class="literal">choice</code> notation)</li><li class="listitem" style="list-style-type: disc">Using the JMS component (and a message selector)</li></ul></div></div><div class="section" title="The Selective Consumer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec56"/>The Selective Consumer EIP</h2></div></div></div><p>The Selective Consumer EIP describes how an endpoint can consume only some messages, based<a id="id313" class="indexterm"/> on a filter.</p><p>Camel supports this EIP in two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using the Message Filter EIP (and the <code class="literal">filter</code> notation)</li><li class="listitem" style="list-style-type: disc">Using a message selector on the JMS component</li></ul></div></div><div class="section" title="The Durable Subscriber EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec57"/>The Durable Subscriber EIP</h2></div></div></div><p>The Durable Subscriber<a id="id314" class="indexterm"/> EIP describes how to use a publish-subscribe model, where the messages are stored when the subscriber is not connected, which are waiting to be delivered when they are back online.</p><p>Camel supports this EIP using the JMS component. A JMS endpoint consumer on a topic supports the <code class="literal">clientId</code> and <code class="literal">durableSubscriptionName</code> properties, allowing it to act as a durable subscriber.</p></div><div class="section" title="The Idempotent Consumer EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec58"/>The Idempotent Consumer EIP</h2></div></div></div><p>The Idempotent <a id="id315" class="indexterm"/>Consumer EIP is used to filter duplicate messages, by identifying each message uniquely. It acts as a message filter to filter the duplicated messages. Basically, each message identifier is stored in a backend, and the EIP checks each incoming message, if it's not already present in the store.</p><p>Camel supports this EIP with the <code class="literal">idempotentConsumer</code> notation. Different message stores are available:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">MemoryIdempotentRepository</code> stores the messages in a HashMap in the memory</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileIdempotentRepository</code> stores the messages on the filesystem (in a property file)</li><li class="listitem" style="list-style-type: disc"><code class="literal">HazelcastIdempotentRepository</code> stores the messages on a Hazelcast-distributed HashMap</li><li class="listitem" style="list-style-type: disc"><code class="literal">JdbcMessageIdRepository</code> stores the messages in a database</li></ul></div></div><div class="section" title="The Transactional Client EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec59"/>The Transactional Client EIP</h2></div></div></div><p>The Transactional Client EIP describes how an endpoint can participate in a transaction. This means that it's possible that the client explicitly performs commit and rollback on a transaction. The <a id="id316" class="indexterm"/>client can be considered to be a transactional resource and can therefore manage a two-phase commit.</p><p>Camel supports this EIP by providing the components' supporting transactions. This is the case for the JMS endpoint.</p></div><div class="section" title="The Message Gateway and Service Activator EIPs"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec60"/>The Message Gateway and Service Activator EIPs</h2></div></div></div><p>The Message<a id="id317" class="indexterm"/> Gateway EIP describes<a id="id318" class="indexterm"/> how to wrap a message format to another message format. Basically, it wraps a Java interface as a message exchange.</p><p>Camel supports this EIP by providing components that support such wrapping, for instance, the <a id="id319" class="indexterm"/>Bean and CXF components.</p><p>Basically, the Service <a id="id320" class="indexterm"/>Activator EIP is very similar to the Message Gateway EIP.</p></div></div>
<div class="section" title="System Management EIPs"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec48"/>System Management EIPs</h1></div></div></div><p>These EIPs are not <a id="id321" class="indexterm"/>directly related to the messages. They provide a very convenient way to implement system and are useful in analyzing and managing the routing system itself.</p><div class="section" title="The ControlBus EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec61"/>The ControlBus EIP</h2></div></div></div><p>The purpose of the <a id="id322" class="indexterm"/>ControlBus EIP is to be able to manage and control the routing system itself. This means being able to stop the routing system, start it again, get details about the routing activity, and so on.</p><p>Camel supports this EIP in two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Camel provides a lot of JMX MBeans, where you can find a lot of metrics and control the involved routes, processors, components, and so on.</li><li class="listitem" style="list-style-type: disc">Camel provides a <code class="literal">controlbus</code> component that you can use to manage the Camel routes.</li></ul></div><p>Using a <code class="literal">controlbus</code> endpoint, you can send a message, for instance, to stop or start a route.</p></div><div class="section" title="The Detour EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec62"/>The Detour EIP</h2></div></div></div><p>The Detour EIP allows you to send messages on additional and specific steps when a control condition is met. You can use it to add extra validation, test, and debug steps when needed.</p><p>Camel supports this<a id="id323" class="indexterm"/> EIP with a message router. The condition of the message router is implemented with a bean; this bean implements the logic to define whether the detour is needed or not.</p></div><div class="section" title="The Wire Tap EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec63"/>The Wire Tap EIP</h2></div></div></div><p>The Wire Tap EIP allows you to send a copy of the message to a specific endpoint, without impacting the main route. This EIP is very useful to implement logging or auditing system.</p><p>Camel supports this EIP with the <code class="literal">wireTap</code> notation.</p><p>To illustrate the Wire Tap<a id="id324" class="indexterm"/> EIP, we create the following <code class="literal">route.xml</code> blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;&lt;constant&gt;Hello chapter5y&lt;/constant&gt;&lt;/setBody&gt;
          &lt;wireTap uri="direct:wiretap"/&gt;
          &lt;delay&gt;
             &lt;constant&gt;3000&lt;/constant&gt;
             &lt;to uri="log:main"/&gt;
          &lt;/delay&gt;
      &lt;/route&gt;
      &lt;route&gt;
          &lt;from uri="direct:wiretap"/&gt;
          &lt;to uri="log:wiretap"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>The first route creates a message every 5 seconds. The Wire Tap EIP sends a copy of the message to the <code class="literal">wiretap</code> route. The main route keeps on processing, using a delay of 3 seconds.</p><p>We start Karaf and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache- camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop our <code class="literal">route.xml</code> into the Karaf <code class="literal">deploy</code> folder. In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-16 21:41:12,553 | INFO  | ead #2 - WireTap | wiretap | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5y]</strong></span>
<span class="strong"><strong>2014-12-16 21:41:15,550 | INFO  | 1 - timer://fire | main | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5y]</strong></span>
<span class="strong"><strong>2014-12-16 21:41:17,540 | INFO  | ead #3 - WireTap | wiretap | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5y]</strong></span>
<span class="strong"><strong>2014-12-16 21:41:20,540 | INFO  | 1 - timer://fire | main | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5y]</strong></span>
</pre></div><p>The wire tap<a id="id325" class="indexterm"/> message has been logged, whereas the main route is still on the fly. We note here that the <code class="literal">wire tap route</code> doesn't impact the main one (in terms of performances or blocking messages).</p><p>The Wire Tap EIP is especially interesting when the logging backend can take time (using a JDBC appender for instance).</p></div><div class="section" title="The Message History EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec64"/>The Message History EIP</h2></div></div></div><p>The Message History EIP is used to analyze and debug the flow of messages.</p><p>Basically, it means attaching a history to a message that provides the list of all the endpoints that the message passed through.</p><p>Camel supports this<a id="id326" class="indexterm"/> EIP with the Camel Tracer feature. The Tracer is basically an interceptor on the channels; it traces all exchange details.</p><p>Due to this information, you can see where the message passed through the body of the message on each endpoint, and so on.</p><p>Every Camel route embeds the Tracer feature, but it's disabled by default. You can enable the Tracer via JMX on the route MBean.</p></div><div class="section" title="The Log EIP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec65"/>The Log EIP</h2></div></div></div><p>The Log EIP allows you to create a log message with all or part of the message.</p><p>Camel supports this EIP in two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using the<a id="id327" class="indexterm"/> log component, as we did in most of the examples of this chapter</li><li class="listitem" style="list-style-type: disc">Providing the <code class="literal">log</code> notation, allowing you to specify the log message format</li></ul></div><p>To illustrate the Log EIP, we create the following <code class="literal">route.xml</code> blueprint descriptor:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint &gt;

  &lt;camelContext &gt;
      &lt;route&gt;
          &lt;from uri="timer:fire?period=5000"/&gt;
          &lt;setBody&gt;&lt;constant&gt;Hello chapter5z&lt;/constant&gt;&lt;/setBody&gt;
          &lt;to uri="log:component"/&gt;
          &lt;log message="Hey, you said ${body} !" loggingLevel="WARN" logName="EIP"/&gt;
      &lt;/route&gt;
  &lt;/camelContext&gt;

&lt;/blueprint&gt;</pre></div><p>We can see here the two ways to log—using the log component or using the <code class="literal">log</code> notation.</p><p>The <code class="literal">log</code> notation (EIP) gives you complete control over what you want to log, the log level, the logger name, and possibly the log markup.</p><p>We start Karaf <a id="id328" class="indexterm"/>and install the <code class="literal">camel-blueprint</code> feature:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bin/karaf</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:repo-add camel 2.12.4</strong></span>
<span class="strong"><strong>Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.4/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt; feature:install camel-blueprint</strong></span>
</pre></div><p>We drop our <code class="literal">route.xml</code> file into the Karaf <code class="literal">deploy</code> folder. In the Karaf <code class="literal">log</code> file, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2014-12-16 21:47:34,641 | INFO  | 1 - timer://fire | component | 70 - org.apache.camel.camel-core - 2.12.4 | Exchange[ExchangePattern: InOnly, BodyType: String, Body: Hello chapter5z]</strong></span>
<span class="strong"><strong>2014-12-16 21:47:34,642 | WARN  | 1 - timer://fire | EIP | 70 - org.apache.camel.camel-core - 2.12.4 | Hey, you said Hello chapter5z !</strong></span>
</pre></div><p>Here, we can see the log messages generated by the log component and the Log EIP.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Summary</h1></div></div></div><p>We have seen that Camel supports all kinds of Enterprise Integration Patterns; from Messaging Systems EIPs to System Management EIPs, you are now ready to use the patterns that you need, and can easily implement them in your routes.</p><p>The notations are a very convenient way to describe and specify complex routing behaviors. The combination of the connectivity components and the Enterprise Integration Patterns makes Camel the most flexible and powerful routing system available.</p><p>And, if the provided components or patterns don't suit your requirements, you can always create your own specific component, as we will see in the next chapter.</p></div></body></html>