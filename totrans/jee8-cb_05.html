<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Security of Enterprise Architecture</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">This chapter covers the following recipes:</p>
<ul class="calibre13">
<li class="calibre14">Domain protection with authentication</li>
<li class="calibre14">Granting rights through authorization</li>
<li class="calibre14">Protecting data confidentiality and integrity with SSL/TLS</li>
<li class="calibre14">Using declarative security</li>
<li class="calibre14">Using programmatic security</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root"><strong class="calibre7">Security</strong> is surely one of the hottest topics of all time in the software industry, and there's no reason for that to change any time soon. Actually, it will probably become even hotter as time goes on.</p>
<p class="mce-root">With all your data being streamed through the cloud, passing through uncountable servers, links, databases, sessions, devices, and so on, what you would expect, at least, is that it is well-protected, secured, and that its integrity is kept.</p>
<p class="mce-root">Now, finally, Java EE has its own Security API, with Soteria <span class="calibre8">being</span><span class="calibre8"> </span><span class="calibre8">its reference implementation.</span></p>
<p class="mce-root"><span class="calibre8">Security is a subject worthy of dozens of books; that's a fact. But t</span>his chapter will cover some common use cases that you may come across in your daily projects.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Domain protection with authentication</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Authentication is whatever process, task, and/or policy is used to define who can access your domain. It's like, for example, a badge that you use to access your office.</p>
<p class="mce-root">In applications, the most common use of authentication is to allow access to your domain to users who are already registered.</p>
<p class="mce-root">This recipe will show you how to use a simple code and configuration to control who can and who cannot access some of the resources of your application.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">We begin by adding our dependency:</p>
<pre class="calibre21">        &lt;dependency&gt;<br class="calibre2"/>            &lt;groupId&gt;javax&lt;/groupId&gt;<br class="calibre2"/>            &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;<br class="calibre2"/>            &lt;version&gt;8.0&lt;/version&gt;<br class="calibre2"/>            &lt;scope&gt;provided&lt;/scope&gt;<br class="calibre2"/>        &lt;/dependency&gt;</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre19">
<li class="chapter">First, we do some configuration in the <kbd class="calibre16">web.xml</kbd> file:</li>
</ol>
<pre class="calibre21">    &lt;security-constraint&gt;<br class="calibre2"/>        &lt;web-resource-collection&gt;<br class="calibre2"/>            &lt;web-resource-name&gt;CH05-Authentication&lt;/web-resource-name&gt;<br class="calibre2"/>            &lt;url-pattern&gt;/authServlet&lt;/url-pattern&gt;<br class="calibre2"/>        &lt;/web-resource-collection&gt;<br class="calibre2"/>        &lt;auth-constraint&gt;<br class="calibre2"/>            &lt;role-name&gt;role1&lt;/role-name&gt;<br class="calibre2"/>        &lt;/auth-constraint&gt;<br class="calibre2"/>    &lt;/security-constraint&gt;<br class="calibre2"/><br class="calibre2"/>    &lt;security-role&gt;<br class="calibre2"/>        &lt;role-name&gt;role1&lt;/role-name&gt;<br class="calibre2"/>    &lt;/security-role&gt;</pre>
<ol start="2" class="calibre19">
<li class="chapter">Then we create a servlet to deal with our user access:</li>
</ol>
<pre class="mce-root2">@DeclareRoles({"role1", "role2", "role3"})<br class="calibre2"/>@WebServlet(name = "/UserAuthenticationServlet", urlPatterns = {"/UserAuthenticationServlet"})<br class="calibre2"/>public class UserAuthenticationServlet extends HttpServlet {<br class="calibre2"/><br class="calibre2"/>    private static final long serialVersionUID = 1L;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private javax.security.enterprise.SecurityContext <br class="calibre2"/>    securityContext;<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void doGet(HttpServletRequest request, <br class="calibre2"/>    HttpServletResponse response) throws ServletException, <br class="calibre2"/>    IOException {<br class="calibre2"/><br class="calibre2"/>        String name = request.getParameter("name");<br class="calibre2"/>        if (null != name || !"".equals(name)) {<br class="calibre2"/>            AuthenticationStatus status = <br class="calibre2"/>            securityContext.authenticate(<br class="calibre2"/>                    request, response, <br class="calibre2"/>                    AuthenticationParameters.withParams().credential<br class="calibre2"/>                    (new CallerOnlyCredential(name)));<br class="calibre2"/><br class="calibre2"/>            response.getWriter().write("Authentication status: " <br class="calibre2"/>            + status.name() + "\n");<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        String principal = null;<br class="calibre2"/>        if (request.getUserPrincipal() != null) {<br class="calibre2"/>            principal = request.getUserPrincipal().getName();<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        response.getWriter().write("User: " + principal + "\n");<br class="calibre2"/>        response.getWriter().write("Role \"role1\" access: " + <br class="calibre2"/>        request.isUserInRole("role1") + "\n");<br class="calibre2"/>        response.getWriter().write("Role \"role2\" access: " + <br class="calibre2"/>        request.isUserInRole("role2") + "\n");<br class="calibre2"/>        response.getWriter().write("Role \"role3\" access: " + <br class="calibre2"/>        request.isUserInRole("role3") + "\n");<br class="calibre2"/>        response.getWriter().write("Access to /authServlet? " + <br class="calibre2"/>        securityContext.hasAccessToWebResource("/authServlet") + <br class="calibre2"/>        "\n");<br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<ol start="3" class="calibre19">
<li class="chapter">And finally, we create the class that will define our authentication policy:</li>
</ol>
<pre class="mce-root2">@ApplicationScoped<br class="calibre2"/>public class AuthenticationMechanism implements <br class="calibre2"/>HttpAuthenticationMechanism {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public AuthenticationStatus validateRequest(HttpServletRequest <br class="calibre2"/>    request, <br class="calibre2"/>    HttpServletResponse response, HttpMessageContext  <br class="calibre2"/>    httpMessageContext) <br class="calibre2"/>    throws AuthenticationException {<br class="calibre2"/><br class="calibre2"/>        if (httpMessageContext.isAuthenticationRequest()) {<br class="calibre2"/><br class="calibre2"/>            Credential credential = <br class="calibre2"/>            httpMessageContext.getAuthParameters().getCredential();<br class="calibre2"/>            if (!(credential instanceof CallerOnlyCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid <br class="calibre2"/>                mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            CallerOnlyCredential callerOnlyCredential = <br class="calibre2"/>            (CallerOnlyCredential) credential;<br class="calibre2"/><br class="calibre2"/>            if ("user".equals(callerOnlyCredential.getCaller())) {<br class="calibre2"/>                return <br class="calibre2"/>                httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>                (callerOnlyCredential.getCaller(), new HashSet&lt;&gt; <br class="calibre2"/>                (Arrays.asList("role1","role2")));<br class="calibre2"/>            } else{<br class="calibre2"/>                throw new AuthenticationException();<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        return httpMessageContext.doNothing();<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>}</pre>
<p class="mce-root">If you run this project in a Java EE 8-compatible server, you should use this URL (assuming that you are running locally. If not, make the appropriate changes):</p>
<p class="mce-root"><kbd class="calibre16">http://localhost:8080/ch05-authentication/UserAuthenticationServlet?name=user</kbd></p>
<p class="mce-root">This should result in a page with these messages:</p>
<pre class="calibre21"><strong class="calibre3">Authentication status: SUCCESS</strong><br class="calibre2"/><strong class="calibre3">User: user</strong><br class="calibre2"/><strong class="calibre3">Role "role1" access: true</strong><br class="calibre2"/><strong class="calibre3">Role "role2" access: true</strong><br class="calibre2"/><strong class="calibre3">Role "role3" access: false</strong><br class="calibre2"/><strong class="calibre3">Access to /authServlet? true</strong></pre>
<p class="mce-root">Try making any change to the <kbd class="calibre16">name</kbd> parameter, such as this:</p>
<p class="mce-root"><kbd class="calibre16">http://localhost:8080/ch05-authentication/UserAuthenticationServlet?name=anotheruser</kbd></p>
<p class="mce-root">Then the result will be as follows:</p>
<pre class="calibre21"><strong class="calibre3">Authentication status: SEND_FAILURE</strong><br class="calibre2"/><strong class="calibre3">User: null</strong><br class="calibre2"/><strong class="calibre3">Role "role1" access: false</strong><br class="calibre2"/><strong class="calibre3">Role "role2" access: false</strong><br class="calibre2"/><strong class="calibre3">Role "role3" access: false</strong><br class="calibre2"/><strong class="calibre3">Access to /authServlet? false</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's split up the code shown earlier, so that we can better understand what's happening.</p>
<p class="mce-root">In the <kbd class="calibre16">web.xml</kbd> file, we are creating a security constraint:</p>
<pre class="calibre21">    &lt;security-constraint&gt;<br class="calibre2"/>       ...<br class="calibre2"/>    &lt;/security-constraint&gt;</pre>
<p class="mce-root">We're defining a resource inside it:</p>
<pre class="calibre21">        &lt;web-resource-collection&gt;<br class="calibre2"/>            &lt;web-resource-name&gt;CH05-Authentication&lt;/web-resource-name&gt;<br class="calibre2"/>            &lt;url-pattern&gt;/authServlet&lt;/url-pattern&gt;<br class="calibre2"/>        &lt;/web-resource-collection&gt;</pre>
<p class="mce-root">And we're defining an authorization policy. In this case, it's a role:</p>
<pre class="calibre21">        &lt;auth-constraint&gt;<br class="calibre2"/>            &lt;role-name&gt;role1&lt;/role-name&gt;<br class="calibre2"/>        &lt;/auth-constraint&gt;</pre>
<p class="mce-root">Now we have <kbd class="calibre16">UserAuthenticationServlet</kbd>. We should pay attention to this annotation:</p>
<pre class="calibre21">@DeclareRoles({"role1", "role2", "role3"})</pre>
<p class="mce-root">It defines which roles are part of the context of this particular servlet.</p>
<p class="mce-root">Another important actor in this scene is this one:</p>
<pre class="calibre21">    @Inject<br class="calibre2"/>    private SecurityContext securityContext;</pre>
<p class="mce-root">Here, we are asking the server to give us a security context so that we can use it for our purpose. It will make sense in a minute.</p>
<p class="mce-root">Then, if the <kbd class="calibre16">name</kbd> parameter is filled, we reach this line:</p>
<pre class="calibre21">            AuthenticationStatus status = securityContext.authenticate(<br class="calibre2"/>                    request, response, withParams().credential(new <br class="calibre2"/>                    CallerOnlyCredential(name)));</pre>
<p class="mce-root">This will ask the Java EE server to process an authentication. But...based on what? That's where our <kbd class="calibre16">HttpAuthenticationMechanism</kbd> implementation comes in.</p>
<p class="mce-root">As the preceding code created <kbd class="calibre16">CallerOnlyCredential</kbd>, our authentication mechanism will be based on it:</p>
<pre class="calibre21">            Credential credential = httpMessageContext.getAuthParameters()<br class="calibre2"/>            .getCredential();<br class="calibre2"/>            if (!(credential instanceof CallerOnlyCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            CallerOnlyCredential callerOnlyCredential = <br class="calibre2"/>           (CallerOnlyCredential) credential;</pre>
<p class="mce-root">And once we have a <kbd class="calibre16">credential</kbd> instance, we can check if the user "exists":</p>
<pre class="calibre21">            if ("user".equals(callerOnlyCredential.getCaller())) {<br class="calibre2"/>                ...<br class="calibre2"/>            } else{<br class="calibre2"/>                throw new AuthenticationException();<br class="calibre2"/>            }</pre>
<p class="mce-root">As an example, we have just compared the names, but in a real case you could search your database, an LDAP server, and so on.</p>
<p class="mce-root">If the user exists, we proceed with the authentication based on some rules:</p>
<pre class="calibre21">return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>(callerOnlyCredential.getCaller(), new HashSet&lt;&gt;(asList("role1","role2")));</pre>
<p class="mce-root">In this case, we have said that the user has access to <kbd class="calibre16">"role1"</kbd> and <kbd class="calibre16">"role2"</kbd>.</p>
<p class="mce-root">Once the authentication is done, it comes back to the servlet and uses the result to finish the process:</p>
<pre class="calibre21">        response.getWriter().write("Role \"role1\" access: " + <br class="calibre2"/>        request.isUserInRole("role1") + "\n");<br class="calibre2"/>        response.getWriter().write("Role \"role2\" access: " + <br class="calibre2"/>        request.isUserInRole("role2") + "\n");<br class="calibre2"/>        response.getWriter().write("Role \"role3\" access: " + <br class="calibre2"/>        request.isUserInRole("role3") + "\n");<br class="calibre2"/>        response.getWriter().write("Access to /authServlet? " + <br class="calibre2"/>        securityContext.hasAccessToWebResource("/authServlet") + "\n");</pre>
<p class="mce-root">So, this code will print <kbd class="calibre16">true</kbd> for <kbd class="calibre16">"role1"</kbd> and <kbd class="calibre16">"role2"</kbd>, and <kbd class="calibre16">false</kbd> for <kbd class="calibre16">"role3"</kbd>. Because <kbd class="calibre16">"/authServlet"</kbd> is allowed for <kbd class="calibre16">"role1"</kbd>, the user will have access to it.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article class="calibre2">
                
<ul class="calibre13">
<li class="calibre14">The full source code of this recipe is available at <a href="https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-authentication" target="_blank" class="pcalibre pcalibre3 pcalibre1 calibre12 pcalibre2">https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-authentication</a>.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Granting rights through authorization</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">If authentication is the way to define who can access a particular resource, authorization is the way to <span class="calibre8">define what a user can and </span><span class="calibre8">cannot </span><span class="calibre8">do</span><span class="calibre8"> </span><span class="calibre8">once they have access to the domain.</span></p>
<p class="mce-root">It's like allowing someone to get into your house, but denying them access to the remote control for your TV (very important access, by the way). Or, allowing access to the remote control, but denying access to adult channels.</p>
<p class="mce-root">One way to do it is through profiles, and that's what we are going to do in this recipe.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start by adding the dependency:</p>
<pre class="calibre21">        &lt;dependency&gt;<br class="calibre2"/>            &lt;groupId&gt;javax&lt;/groupId&gt;<br class="calibre2"/>            &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;<br class="calibre2"/>            &lt;version&gt;8.0&lt;/version&gt;<br class="calibre2"/>            &lt;scope&gt;provided&lt;/scope&gt;<br class="calibre2"/>        &lt;/dependency&gt;</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre19">
<li class="chapter">First, we define some roles in a separate class so that we can reuse it:</li>
</ol>
<pre class="mce-root2">public class Roles {<br class="calibre2"/>    public static final String ROLE1 = "role1";<br class="calibre2"/>    public static final String ROLE2 = "role2";<br class="calibre2"/>    public static final String ROLE3 = "role3";<br class="calibre2"/>}</pre>
<ol start="2" class="calibre19">
<li class="chapter">Then we define some things that the application's users can do:</li>
</ol>
<pre class="mce-root2">@Stateful<br class="calibre2"/>public class UserActivity {<br class="calibre2"/>    <br class="calibre2"/>    @RolesAllowed({Roles.ROLE1})<br class="calibre2"/>    public void role1Allowed(){<br class="calibre2"/>        System.out.println("role1Allowed executed");<br class="calibre2"/>    }<br class="calibre2"/>    <br class="calibre2"/>    @RolesAllowed({Roles.ROLE2})<br class="calibre2"/>    public void role2Allowed(){<br class="calibre2"/>        System.out.println("role2Allowed executed");<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    @RolesAllowed({Roles.ROLE3})<br class="calibre2"/>    public void role3Allowed(){<br class="calibre2"/>        System.out.println("role3Allowed executed");<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    @PermitAll<br class="calibre2"/>    public void anonymousAllowed(){<br class="calibre2"/>        System.out.println("anonymousAllowed executed");<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    @DenyAll<br class="calibre2"/>    public void noOneAllowed(){<br class="calibre2"/>        System.out.println("noOneAllowed executed");<br class="calibre2"/>    } <br class="calibre2"/>    <br class="calibre2"/>}</pre>
<ol start="3" class="calibre19">
<li class="chapter">Let's create an interface for executable tasks:</li>
</ol>
<pre class="mce-root2">public interface Executable {<br class="calibre2"/>    void execute() throws Exception;<br class="calibre2"/>}</pre>
<ol start="4" class="calibre19">
<li class="chapter">And let's create another for the roles that will execute them:</li>
</ol>
<pre class="mce-root2">public interface RoleExecutable {<br class="calibre2"/>    void run(Executable executable) throws Exception;<br class="calibre2"/>}</pre>
<ol start="5" class="calibre19">
<li class="chapter">For each role, we create an executor. It will be like an environment that owns the rights of that role:</li>
</ol>
<pre class="mce-root2">@Named<br class="calibre2"/>@RunAs(Roles.ROLE1)<br class="calibre2"/>public class Role1Executor implements RoleExecutable {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void run(Executable executable) throws Exception {<br class="calibre2"/>        executable.execute();<br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<pre class="mce-root2">@Named<br class="calibre2"/>@RunAs(Roles.ROLE2)<br class="calibre2"/>public class Role2Executor implements RoleExecutable {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void run(Executable executable) throws Exception {<br class="calibre2"/>        executable.execute();<br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<pre class="mce-root2">@Named<br class="calibre2"/>@RunAs(Roles.ROLE3)<br class="calibre2"/>public class Role3Executor implements RoleExecutable {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void run(Executable executable) throws Exception {<br class="calibre2"/>        executable.execute();<br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<ol start="6" class="calibre19">
<li class="chapter">Then we implement <kbd class="calibre16">HttpAuthenticationMechanism</kbd>:</li>
</ol>
<pre class="mce-root2">@ApplicationScoped<br class="calibre2"/>public class AuthenticationMechanism implements <br class="calibre2"/>HttpAuthenticationMechanism {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public AuthenticationStatus validateRequest(HttpServletRequest <br class="calibre2"/>     request, HttpServletResponse response, HttpMessageContext <br class="calibre2"/>     httpMessageContext) throws AuthenticationException {<br class="calibre2"/><br class="calibre2"/>        if (httpMessageContext.isAuthenticationRequest()) {<br class="calibre2"/><br class="calibre2"/>            Credential credential = <br class="calibre2"/>            httpMessageContext.getAuthParameters()<br class="calibre2"/>            .getCredential();<br class="calibre2"/>            if (!(credential instanceof CallerOnlyCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid <br class="calibre2"/>                mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            CallerOnlyCredential callerOnlyCredential = <br class="calibre2"/>            (CallerOnlyCredential) credential;<br class="calibre2"/><br class="calibre2"/>            if (null == callerOnlyCredential.getCaller()) {<br class="calibre2"/>                throw new AuthenticationException();<br class="calibre2"/>            } else switch (callerOnlyCredential.getCaller()) {<br class="calibre2"/>                case "user1":<br class="calibre2"/>                    return  <br class="calibre2"/>                    httpMessageContext.<br class="calibre2"/>                    notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(),<br class="calibre2"/>                     new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ROLE1)));<br class="calibre2"/>                case "user2":<br class="calibre2"/>                    return <br class="calibre2"/>                    httpMessageContext.<br class="calibre2"/>                    notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(), <br class="calibre2"/>                     new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ROLE2)));<br class="calibre2"/>                case "user3":<br class="calibre2"/>                    return <br class="calibre2"/>                    httpMessageContext.<br class="calibre2"/>                    notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(), <br class="calibre2"/>                     new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ROLE3)));<br class="calibre2"/>                default:<br class="calibre2"/>                    throw new AuthenticationException();<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        return httpMessageContext.doNothing();<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>}</pre>
<ol start="7" class="calibre19">
<li class="chapter">And finally, we create the servlet that will manage all these resources:</li>
</ol>
<pre class="mce-root2">@DeclareRoles({Roles.ROLE1, Roles.ROLE2, Roles.ROLE3})<br class="calibre2"/>@WebServlet(name = "/UserAuthorizationServlet", urlPatterns = {"/UserAuthorizationServlet"})<br class="calibre2"/>public class UserAuthorizationServlet extends HttpServlet {<br class="calibre2"/><br class="calibre2"/>    private static final long serialVersionUID = 1L;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private SecurityContext securityContext;<br class="calibre2"/>    <br class="calibre2"/>    @Inject<br class="calibre2"/>    private Role1Executor role1Executor;<br class="calibre2"/>    <br class="calibre2"/>    @Inject<br class="calibre2"/>    private Role2Executor role2Executor;<br class="calibre2"/>    <br class="calibre2"/>    @Inject<br class="calibre2"/>    private Role3Executor role3Executor;<br class="calibre2"/>    <br class="calibre2"/>    @Inject<br class="calibre2"/>    private UserActivity userActivity;<br class="calibre2"/>    <br class="calibre2"/>    @Override<br class="calibre2"/>    public void doGet(HttpServletRequest request, <br class="calibre2"/>    HttpServletResponse <br class="calibre2"/>    response) throws ServletException, IOException {<br class="calibre2"/><br class="calibre2"/>        try {<br class="calibre2"/>            String name = request.getParameter("name");<br class="calibre2"/>            if (null != name || !"".equals(name)) {<br class="calibre2"/>                AuthenticationStatus status = <br class="calibre2"/>                securityContext.authenticate(<br class="calibre2"/>                        request, response, withParams().credential(<br class="calibre2"/>                        new CallerOnlyCredential(name)));<br class="calibre2"/><br class="calibre2"/>                response.getWriter().write("Authentication <br class="calibre2"/>                status: " + status.name() + "\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            String principal = null;<br class="calibre2"/>            if (request.getUserPrincipal() != null) {<br class="calibre2"/>                principal = request.getUserPrincipal().getName();<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            response.getWriter().write("User: " + principal +<br class="calibre2"/>            "\n");<br class="calibre2"/>            response.getWriter().write("Role \"role1\" access: " + <br class="calibre2"/>            request.isUserInRole(Roles.ROLE1) + "\n");<br class="calibre2"/>            response.getWriter().write("Role \"role2\" access: " + <br class="calibre2"/>            request.isUserInRole(Roles.ROLE2) + "\n");<br class="calibre2"/>            response.getWriter().write("Role \"role3\" access: " + <br class="calibre2"/>            request.isUserInRole(Roles.ROLE3) + "\n");<br class="calibre2"/><br class="calibre2"/>            RoleExecutable executable = null;<br class="calibre2"/><br class="calibre2"/>            if (request.isUserInRole(Roles.ROLE1)) {<br class="calibre2"/>                executable = role1Executor;<br class="calibre2"/>            } else if (request.isUserInRole(Roles.ROLE2)) {<br class="calibre2"/>                executable = role2Executor;<br class="calibre2"/>            } else if (request.isUserInRole(Roles.ROLE3)) {<br class="calibre2"/>                executable = role3Executor;<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            if (executable != null) {<br class="calibre2"/>                executable.run(() -&gt; {<br class="calibre2"/>                    try {<br class="calibre2"/>                        userActivity.role1Allowed();<br class="calibre2"/>                        response.getWriter().write("role1Allowed <br class="calibre2"/>                        executed: true\n");<br class="calibre2"/>                    } catch (Exception e) {<br class="calibre2"/>                        response.getWriter().write("role1Allowed  <br class="calibre2"/>                        executed: false\n");<br class="calibre2"/>                    }<br class="calibre2"/><br class="calibre2"/>                    try {<br class="calibre2"/>                        userActivity.role2Allowed();<br class="calibre2"/>                        response.getWriter().write("role2Allowed <br class="calibre2"/>                        executed: true\n");<br class="calibre2"/>                    } catch (Exception e) {<br class="calibre2"/>                        response.getWriter().write("role2Allowed  <br class="calibre2"/>                        executed: false\n");<br class="calibre2"/>                    }<br class="calibre2"/><br class="calibre2"/>                    try {<br class="calibre2"/>                        userActivity.role3Allowed();<br class="calibre2"/>                        response.getWriter().write("role2Allowed <br class="calibre2"/>                        executed: true\n");<br class="calibre2"/>                    } catch (Exception e) {<br class="calibre2"/>                        response.getWriter().write("role2Allowed <br class="calibre2"/>                        executed: false\n");<br class="calibre2"/>                    }<br class="calibre2"/><br class="calibre2"/>                });<br class="calibre2"/><br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            try {<br class="calibre2"/>                userActivity.anonymousAllowed();<br class="calibre2"/>                response.getWriter().write("anonymousAllowed  <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("anonymousAllowed <br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            }<br class="calibre2"/>            <br class="calibre2"/>            try {<br class="calibre2"/>                userActivity.noOneAllowed();<br class="calibre2"/>                response.getWriter().write("noOneAllowed <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("noOneAllowed <br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            } <br class="calibre2"/><br class="calibre2"/>        } catch (Exception ex) {<br class="calibre2"/>            System.err.println(ex.getMessage());<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<p class="mce-root">To try this code out, you can run these URLs:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre16">http://localhost:8080/ch05-authorization/UserAuthorizationServlet?name=user1</kbd></li>
<li class="calibre14"><kbd class="calibre16">http://localhost:8080/ch05-authorization/UserAuthorizationServlet?name=user2</kbd></li>
<li class="calibre14"><kbd class="calibre16">http://localhost:8080/ch05-authorization/UserAuthorizationServlet?name=user3</kbd></li>
</ul>
<p class="mce-root">The result for <kbd class="calibre16">user1</kbd>, for example, will be like this:</p>
<pre class="calibre21"><strong class="calibre3">Authentication status: SUCCESS</strong><br class="calibre2"/><strong class="calibre3">User: user1</strong><br class="calibre2"/><strong class="calibre3">Role "role1" access: true</strong><br class="calibre2"/><strong class="calibre3">Role "role2" access: false</strong><br class="calibre2"/><strong class="calibre3">Role "role3" access: false</strong><br class="calibre2"/><strong class="calibre3">role1Allowed executed: true</strong><br class="calibre2"/><strong class="calibre3">role2Allowed executed: false</strong><br class="calibre2"/><strong class="calibre3">role2Allowed executed: false</strong><br class="calibre2"/><strong class="calibre3">anonymousAllowed executed: true</strong><br class="calibre2"/><strong class="calibre3">noOneAllowed executed: false</strong></pre>
<p class="mce-root">And if you try with a user that doesn't exist, the result will be like this:</p>
<pre class="calibre21"><strong class="calibre3">Authentication status: SEND_FAILURE</strong><br class="calibre2"/><strong class="calibre3">User: null</strong><br class="calibre2"/><strong class="calibre3">Role "role1" access: false</strong><br class="calibre2"/><strong class="calibre3">Role "role2" access: false</strong><br class="calibre2"/><strong class="calibre3">Role "role3" access: false</strong><br class="calibre2"/><strong class="calibre3">anonymousAllowed executed: true</strong><br class="calibre2"/><strong class="calibre3">noOneAllowed executed: false</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Well, we have a lot of things happening here! Let's begin with our <kbd class="calibre16">UserActivity</kbd> class.</p>
<p class="mce-root">We used the <kbd class="calibre16">@RolesAllowed</kbd> annotation to define the role that can access each method of the class:</p>
<pre class="calibre21">    @RolesAllowed({Roles.ROLE1})<br class="calibre2"/>    public void role1Allowed(){<br class="calibre2"/>        System.out.println("role1Allowed executed");<br class="calibre2"/>    }</pre>
<p class="mce-root">You can add more than one role inside the annotation (it's an array).</p>
<p class="mce-root">We also had two others interesting annotations, <kbd class="calibre16">@PermitAll</kbd> and <kbd class="calibre16">@DenyAll</kbd>:</p>
<ul class="calibre13">
<li class="calibre14">The <span class="calibre5"><kbd class="calibre16">@PermitAll</kbd> annotation allows anyone to access the method, even without any authentication. </span></li>
<li class="calibre14">The <span class="calibre5"><kbd class="calibre16">@DenyAll</kbd> annotation denies everyone access to the method, even authenticated users with the highest privileges.</span></li>
</ul>
<p class="mce-root">Then we have what we called executors:</p>
<pre class="calibre21">@Named<br class="calibre2"/>@RunAs(Roles.ROLE1)<br class="calibre2"/>public class Role1Executor implements RoleExecutable {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void run(Executable executable) throws Exception {<br class="calibre2"/>        executable.execute();<br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<p class="mce-root">We used the <kbd class="calibre16">@RunAs</kbd> annotation at the class level, which means that this class inherits all the privileges of the defined role (in this case, <kbd class="calibre16">"role1"</kbd>). It means that every single method of this class will have the <kbd class="calibre16">"role1"</kbd> privileges.</p>
<p class="mce-root">Now, looking at <kbd class="calibre16">UserAuthorizationServlet</kbd>, right at the beginning we have an important object:</p>
<pre class="calibre21">    @Inject<br class="calibre2"/>    private SecurityContext securityContext;</pre>
<p class="mce-root">Here, we are asking the server to give us a security context instance so that we can use it for authentication purposes.</p>
<p class="mce-root">Then, if the <kbd class="calibre16">name</kbd> parameter is filled, we reach this line:</p>
<pre class="calibre21">            AuthenticationStatus status = securityContext.authenticate(<br class="calibre2"/>                    request, response, withParams().credential(new <br class="calibre2"/>                    CallerOnlyCredential(name)));</pre>
<p class="mce-root">This will ask the Java EE server to process an authentication. That's where our <kbd class="calibre16">HttpAuthenticationMechanism</kbd> implementation <span class="calibre8">comes</span><span class="calibre8"> in</span><span class="calibre8">.</span></p>
<p class="mce-root">As the preceding code created <kbd class="calibre16">CallerOnlyCredential</kbd>, our authentication mechanism will be based on it:</p>
<pre class="calibre21">            Credential credential = httpMessageContext.getAuthParameters().<br class="calibre2"/>            getCredential();<br class="calibre2"/>            if (!(credential instanceof CallerOnlyCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            CallerOnlyCredential callerOnlyCredential = <br class="calibre2"/>           (CallerOnlyCredential) credential;</pre>
<p class="mce-root">And once we have a credential instance, we can check if the user exists:</p>
<pre class="calibre21">            if (null == callerOnlyCredential.getCaller()) {<br class="calibre2"/>                throw new AuthenticationException();<br class="calibre2"/>            } else switch (callerOnlyCredential.getCaller()) {<br class="calibre2"/>                case "user1":<br class="calibre2"/>                    return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(), new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ROLE1)));<br class="calibre2"/>                case "user2":<br class="calibre2"/>                    return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(), new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ROLE2)));<br class="calibre2"/>                case "user3":<br class="calibre2"/>                    return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(), new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ROLE3)));<br class="calibre2"/>                default:<br class="calibre2"/>                    throw new AuthenticationException();<br class="calibre2"/>            }</pre>
<p class="mce-root">So we are saying that <kbd class="calibre16">"user1"</kbd> has access to <kbd class="calibre16">"role1"</kbd>, <kbd class="calibre16">"user2"</kbd> to <kbd class="calibre16">"role2"</kbd>, and so on.</p>
<p class="mce-root">Once the user role is defined, we are back to the servlet and can choose which environment (executor) will be used:</p>
<pre class="calibre21">            if (request.isUserInRole(Roles.ROLE1)) {<br class="calibre2"/>                executable = role1Executor;<br class="calibre2"/>            } else if (request.isUserInRole(Roles.ROLE2)) {<br class="calibre2"/>                executable = role2Executor;<br class="calibre2"/>            } else if (request.isUserInRole(Roles.ROLE3)) {<br class="calibre2"/>                executable = role3Executor;<br class="calibre2"/>            }</pre>
<p class="mce-root">And then we try all the methods of the <kbd class="calibre16">UserActivity</kbd> class. Only the methods allowed for that specific role will be executed; the others will fall into an exception, except for the <kbd class="calibre16">@PermitAll</kbd> method, which will run anyway, and <kbd class="calibre16">@DenyAll</kbd>, which will not run anyway.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article class="calibre2">
                
<ul class="calibre13">
<li class="calibre14">Check the full source code of this recipe at <a href="https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-authorization" target="_blank" class="pcalibre pcalibre3 pcalibre1 calibre12 pcalibre2">https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-authorization</a>.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Protecting data confidentiality and integrity with SSL/TLS</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Security also means protecting the transportation of your data, and for this purpose we have the most popular method, which is called the <strong class="calibre7">Secure Sockets Layer</strong> (<strong class="calibre7">SSL</strong>).</p>
<p class="mce-root"><strong class="calibre7">Transport Layer Security</strong>, or <strong class="calibre7">TLS</strong>, is the newest version of SSL. So, we have SSL 3.0 and TLS 1.0 as the protocols supported by GlassFish 5.0.</p>
<p class="mce-root">This recipe will show you how to enable GlassFish 5.0 to work properly with SSL. All Java EE servers have their own way of doing this.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">To enable SSL in GlassFish, you need to configure an HTTP listener for SSL. All you need to do is this:</p>
<ol class="calibre19">
<li class="chapter">Make sure GlassFish is up and running.</li>
<li class="chapter">Use the <kbd class="calibre16">create-ssl</kbd> command to create your HTTP listener for SSL.</li>
<li class="chapter">Restart the GlassFish server.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre19">
<li class="chapter">To do this task, you need to access the GlassFish remote <strong class="calibre3">command-line interface</strong> (<strong class="calibre3">CLI</strong>). You can do it by going to this path:</li>
</ol>
<p class="calibre26"><kbd class="calibre16">$GLASSFISH_HOME/bin</kbd></p>
<ol start="2" class="calibre19">
<li class="chapter">Once you are there, execute the following command:</li>
</ol>
<pre class="mce-root2"><strong class="calibre3">./asadmin</strong></pre>
<ol start="3" class="calibre19">
<li class="chapter">When the prompt is ready, you can execute this command:</li>
</ol>
<pre class="mce-root2"><strong class="calibre3">create-ssl --type http-listener --certname cookbookCert http-listener-1</strong></pre>
<ol start="4" class="calibre19">
<li class="chapter">Then you can restart the server and your <kbd class="calibre16">http-listener-1</kbd> will work with SSL. If you want to drop SSL from the listener, just go back to the prompt and execute this command:</li>
</ol>
<pre class="mce-root2"><strong class="calibre3">delete-ssl --type http-listener http-listener-1</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">With SSL, both the client and the server encrypt data before sending it, and decrypt data upon receiving it. When a browser opens a secured website (using HTTPS), something happens that is called a <strong class="calibre7">handshake</strong>.</p>
<p class="mce-root">In the handshake, the browser asks the server  for a session; the server answers by sending a certificate and the public key. The browser validates the certificate and, if it is valid, generates an unique session key, encrypts it with the server public key, and sends it back to the server. Once the server receives the session key, it decrypts it with its private key.</p>
<p class="mce-root">Now, both client and server, and only them, have a copy of the session key and can ensure that the communication is secure.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">It's strongly recommended that you use a certificate from a <span class="calibre8"><strong class="calibre7">Certification Authority</strong> </span>(<strong class="calibre7"><span class="calibre8">CA</span></strong>) instead of a self-created certificate like we did in this recipe.</p>
<p class="mce-root">You can check out <a href="https://letsencrypt.org" class="pcalibre pcalibre3 pcalibre1 calibre12 pcalibre2">https://letsencrypt.org</a>, where you can get your free certificate.</p>
<p class="mce-root">The process of using it is the same; you will just change the value in the <kbd class="calibre16">--certname</kbd> parameter.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article class="calibre2">
                
<ul class="calibre13">
<li class="calibre14">For detailed information about all the security aspects and configuration for GlassFish 5, check out <a href="https://javaee.github.io/glassfish/doc/5.0/security-guide.pdf" target="_blank" class="pcalibre pcalibre3 pcalibre1 calibre12 pcalibre2">https://javaee.github.io/glassfish/doc/5.0/security-guide.pdf</a>.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Using declarative security</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">When building your application's security features, you can basically use two approaches: <strong class="calibre7">programmatic security</strong> and <strong class="calibre7">declarative security</strong>:</p>
<ul class="calibre13">
<li class="calibre14">The programmatic approach is when you define the security policy of your application using code.</li>
<li class="calibre14">The declarative approach is when you do it by declaring the policies and then applying them accordingly.</li>
</ul>
<p class="mce-root">This recipe will show you the declarative approach.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start by adding the dependency:</p>
<pre class="calibre21">        &lt;dependency&gt;<br class="calibre2"/>            &lt;groupId&gt;javax&lt;/groupId&gt;<br class="calibre2"/>            &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;<br class="calibre2"/>            &lt;version&gt;8.0&lt;/version&gt;<br class="calibre2"/>            &lt;scope&gt;provided&lt;/scope&gt;<br class="calibre2"/>        &lt;/dependency&gt;</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre19">
<li class="chapter">Let's create a list of roles for our application:</li>
</ol>
<pre class="mce-root2">public class Roles {<br class="calibre2"/>    public static final String ADMIN = "admin";<br class="calibre2"/>    public static final String USER = "user";<br class="calibre2"/>}</pre>
<ol start="2" class="calibre19">
<li class="chapter">Then we create a list of tasks that could be performed by only one of the roles, one task that everyone can do, and another task that no one can do:</li>
</ol>
<pre class="mce-root2">@Stateful<br class="calibre2"/>public class UserBean {<br class="calibre2"/>    <br class="calibre2"/>    @RolesAllowed({Roles.ADMIN})<br class="calibre2"/>    public void adminOperation(){<br class="calibre2"/>        System.out.println("adminOperation executed");<br class="calibre2"/>    }<br class="calibre2"/>    <br class="calibre2"/>    @RolesAllowed({Roles.USER})<br class="calibre2"/>    public void userOperation(){<br class="calibre2"/>        System.out.println("userOperation executed");<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    @PermitAll<br class="calibre2"/>    public void everyoneCanDo(){<br class="calibre2"/>        System.out.println("everyoneCanDo executed");<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    @DenyAll<br class="calibre2"/>    public void noneCanDo(){<br class="calibre2"/>        System.out.println("noneCanDo executed");<br class="calibre2"/>    } <br class="calibre2"/>    <br class="calibre2"/>}</pre>
<ol start="3" class="calibre19">
<li class="chapter">Now we create an environment for both the <kbd class="calibre16">USER</kbd> and <kbd class="calibre16">ADMIN</kbd> roles to do their stuff:</li>
</ol>
<pre class="mce-root2">@Named<br class="calibre2"/>@RunAs(Roles.USER)<br class="calibre2"/>public class UserExecutor implements RoleExecutable {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void run(Executable executable) throws Exception {<br class="calibre2"/>        executable.execute();<br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<pre class="mce-root2">@Named<br class="calibre2"/>@RunAs(Roles.ADMIN)<br class="calibre2"/>public class AdminExecutor implements RoleExecutable {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void run(Executable executable) throws Exception {<br class="calibre2"/>        executable.execute();<br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<ol start="4" class="calibre19">
<li class="chapter">Then we implement <kbd class="calibre16">HttpAuthenticationMechanism</kbd>:</li>
</ol>
<pre class="mce-root2">@ApplicationScoped<br class="calibre2"/>public class AuthenticationMechanism implements HttpAuthenticationMechanism {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public AuthenticationStatus validateRequest(HttpServletRequest <br class="calibre2"/>    request, HttpServletResponse response, HttpMessageContext <br class="calibre2"/>    httpMessageContext) <br class="calibre2"/>    throws AuthenticationException {<br class="calibre2"/><br class="calibre2"/>        if (httpMessageContext.isAuthenticationRequest()) {<br class="calibre2"/><br class="calibre2"/>            Credential credential = <br class="calibre2"/>            httpMessageContext.getAuthParameters().<br class="calibre2"/>            getCredential();<br class="calibre2"/>            if (!(credential instanceof CallerOnlyCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid <br class="calibre2"/>                mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            CallerOnlyCredential callerOnlyCredential = <br class="calibre2"/>            (CallerOnlyCredential) <br class="calibre2"/>            credential;<br class="calibre2"/><br class="calibre2"/>            if (null == callerOnlyCredential.getCaller()) {<br class="calibre2"/>                throw new AuthenticationException();<br class="calibre2"/>            } else switch (callerOnlyCredential.getCaller()) {<br class="calibre2"/>                case Roles.ADMIN:<br class="calibre2"/>                    return httpMessageContext<br class="calibre2"/>                    .notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(),<br class="calibre2"/>                     new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ADMIN)));<br class="calibre2"/>                case Roles.USER:<br class="calibre2"/>                    return httpMessageContext<br class="calibre2"/>                   .notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(),<br class="calibre2"/>                    new HashSet&lt;&gt; <br class="calibre2"/>                    (asList(Roles.USER)));<br class="calibre2"/>                default:<br class="calibre2"/>                    throw new AuthenticationException();<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        return httpMessageContext.doNothing();<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>}</pre>
<ol start="5" class="calibre19">
<li class="chapter">And finally, we create one servlet for each role (<kbd class="calibre16">USER</kbd> and <kbd class="calibre16">ADMIN</kbd>):</li>
</ol>
<pre class="mce-root2">@DeclareRoles({Roles.ADMIN, Roles.USER})<br class="calibre2"/>@WebServlet(name = "/UserServlet", urlPatterns = {"/UserServlet"})<br class="calibre2"/>public class UserServlet extends HttpServlet {<br class="calibre2"/><br class="calibre2"/>    private static final long serialVersionUID = 1L;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private SecurityContext securityContext;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private UserExecutor userExecutor;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private UserBean userActivity;<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void doGet(HttpServletRequest request, <br class="calibre2"/>    HttpServletResponse response) throws ServletException, <br class="calibre2"/>    IOException {<br class="calibre2"/><br class="calibre2"/>        try {<br class="calibre2"/>            securityContext.authenticate(<br class="calibre2"/>                    request, response, withParams().credential(new <br class="calibre2"/>                    CallerOnlyCredential(Roles.USER)));<br class="calibre2"/><br class="calibre2"/>            response.getWriter().write("Role \"admin\" access: " + <br class="calibre2"/>            request.isUserInRole(Roles.ADMIN) + "\n");<br class="calibre2"/>            response.getWriter().write("Role \"user\" access: " + <br class="calibre2"/>            request.isUserInRole(Roles.USER) + "\n");<br class="calibre2"/><br class="calibre2"/>            userExecutor.run(() -&gt; {<br class="calibre2"/>                try {<br class="calibre2"/>                    userActivity.adminOperation();<br class="calibre2"/>                    response.getWriter().write("adminOperation <br class="calibre2"/>                    executed: true\n");<br class="calibre2"/>                } catch (Exception e) {<br class="calibre2"/>                    response.getWriter().write("adminOperation <br class="calibre2"/>                    executed: false\n");<br class="calibre2"/>                }<br class="calibre2"/><br class="calibre2"/>                try {<br class="calibre2"/>                    userActivity.userOperation();<br class="calibre2"/>                    response.getWriter().write("userOperation <br class="calibre2"/>                    executed: true\n");<br class="calibre2"/>                } catch (Exception e) {<br class="calibre2"/>                    response.getWriter().write("userOperation  <br class="calibre2"/>                    executed: false\n");<br class="calibre2"/>                }<br class="calibre2"/><br class="calibre2"/>            });<br class="calibre2"/><br class="calibre2"/>            try {<br class="calibre2"/>                userActivity.everyoneCanDo();<br class="calibre2"/>                response.getWriter().write("everyoneCanDo <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("everyoneCanDo<br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            try {<br class="calibre2"/>                userActivity.noneCanDo();<br class="calibre2"/>                response.getWriter().write("noneCanDo <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("noneCanDo <br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>        } catch (Exception ex) {<br class="calibre2"/>            System.err.println(ex.getMessage());<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<pre class="mce-root2">@DeclareRoles({Roles.ADMIN, Roles.USER})<br class="calibre2"/>@WebServlet(name = "/AdminServlet", urlPatterns = {"/AdminServlet"})<br class="calibre2"/>public class AdminServlet extends HttpServlet {<br class="calibre2"/><br class="calibre2"/>    private static final long serialVersionUID = 1L;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private SecurityContext securityContext;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private AdminExecutor adminExecutor;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private UserBean userActivity;<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void doGet(HttpServletRequest request, <br class="calibre2"/>    HttpServletResponse <br class="calibre2"/>    response) throws ServletException, IOException {<br class="calibre2"/><br class="calibre2"/>        try {<br class="calibre2"/>            securityContext.authenticate(<br class="calibre2"/>                    request, response, withParams().credential(new <br class="calibre2"/>                    CallerOnlyCredential(Roles.ADMIN)));<br class="calibre2"/><br class="calibre2"/>            response.getWriter().write("Role \"admin\" access: " + <br class="calibre2"/>            request.isUserInRole(Roles.ADMIN) + "\n");<br class="calibre2"/>            response.getWriter().write("Role \"user\" access: " + <br class="calibre2"/>            request.isUserInRole(Roles.USER) + "\n");<br class="calibre2"/><br class="calibre2"/>            adminExecutor.run(() -&gt; {<br class="calibre2"/>                try {<br class="calibre2"/>                    userActivity.adminOperation();<br class="calibre2"/>                    response.getWriter().write("adminOperation <br class="calibre2"/>                    executed: true\n");<br class="calibre2"/>                } catch (Exception e) {<br class="calibre2"/>                    response.getWriter().write("adminOperation <br class="calibre2"/>                    executed: false\n");<br class="calibre2"/>                }<br class="calibre2"/><br class="calibre2"/>                try {<br class="calibre2"/>                    userActivity.userOperation();<br class="calibre2"/>                    response.getWriter().write("userOperation <br class="calibre2"/>                    executed: true\n");<br class="calibre2"/>                } catch (Exception e) {<br class="calibre2"/>                    response.getWriter().write("userOperation <br class="calibre2"/>                    executed: false\n");<br class="calibre2"/>                }<br class="calibre2"/><br class="calibre2"/>            });<br class="calibre2"/><br class="calibre2"/>            try {<br class="calibre2"/>                userActivity.everyoneCanDo();<br class="calibre2"/>                response.getWriter().write("everyoneCanDo <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("everyoneCanDo<br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            try {<br class="calibre2"/>                userActivity.noneCanDo();<br class="calibre2"/>                response.getWriter().write("noneCanDo <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("noneCanDo <br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>        } catch (Exception ex) {<br class="calibre2"/>            System.err.println(ex.getMessage());<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>    }<br class="calibre2"/>}</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Looking at <kbd class="calibre16">UserServlet</kbd> (which applies to the <kbd class="calibre16">USER</kbd> role), we first see the authentication step:</p>
<pre class="calibre21">            securityContext.authenticate(<br class="calibre2"/>                    request, response, withParams().credential(new <br class="calibre2"/>                    CallerOnlyCredential(Roles.ADMIN)));</pre>
<p class="mce-root">For example, we've used the role name as a username because if we look at the <kbd class="calibre16">AuthenticationMechanism</kbd> class (implementing <kbd class="calibre16">HttpAuthenticationMechanism</kbd>), we see it doing all the hard work of authenticating and assigning the right role to the user:</p>
<pre class="calibre21">            Credential credential = <br class="calibre2"/>            httpMessageContext.getAuthParameters()<br class="calibre2"/>            .getCredential();<br class="calibre2"/>            if (!(credential instanceof CallerOnlyCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            CallerOnlyCredential callerOnlyCredential = <br class="calibre2"/>            (CallerOnlyCredential) <br class="calibre2"/>            credential;<br class="calibre2"/><br class="calibre2"/>            if (null == callerOnlyCredential.getCaller()) {<br class="calibre2"/>                throw new AuthenticationException();<br class="calibre2"/>            } else switch (callerOnlyCredential.getCaller()) {<br class="calibre2"/>                case Roles.ADMIN:<br class="calibre2"/>                    return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(), new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.ADMIN)));<br class="calibre2"/>                case Roles.USER:<br class="calibre2"/>                    return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>                    (callerOnlyCredential.getCaller(), new HashSet&lt;&gt;<br class="calibre2"/>                    (asList(Roles.USER)));<br class="calibre2"/>                default:<br class="calibre2"/>                    throw new AuthenticationException();<br class="calibre2"/>            }</pre>
<p class="mce-root">And back to our <kbd class="calibre16">UserServlet</kbd>, now that the user has the proper role assigned, it is just a matter of what they can and cannot do:</p>
<pre class="calibre21">            userExecutor.run(() -&gt; {<br class="calibre2"/>                try {<br class="calibre2"/>                    userActivity.adminOperation();<br class="calibre2"/>                    response.getWriter().write("adminOperation  <br class="calibre2"/>                    executed: true\n");<br class="calibre2"/>                } catch (Exception e) {<br class="calibre2"/>                    response.getWriter().write("adminOperation <br class="calibre2"/>                    executed: false\n");<br class="calibre2"/>                }<br class="calibre2"/><br class="calibre2"/>                try {<br class="calibre2"/>                    userActivity.userOperation();<br class="calibre2"/>                    response.getWriter().write("userOperation <br class="calibre2"/>                    executed: true\n");<br class="calibre2"/>                } catch (Exception e) {<br class="calibre2"/>                    response.getWriter().write("userOperation <br class="calibre2"/>                    executed:  false\n");<br class="calibre2"/>                }<br class="calibre2"/><br class="calibre2"/>            });</pre>
<p class="mce-root">And also, we try the tasks that everyone and no one can perform:</p>
<pre class="calibre21">            try {<br class="calibre2"/>                userActivity.everyoneCanDo();<br class="calibre2"/>                response.getWriter().write("everyoneCanDo <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("everyoneCanDo <br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            try {<br class="calibre2"/>                userActivity.noneCanDo();<br class="calibre2"/>                response.getWriter().write("noneCanDo <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } catch (Exception e) {<br class="calibre2"/>                response.getWriter().write("noneCanDo <br class="calibre2"/>                executed: false\n");<br class="calibre2"/>            }</pre>
<p class="mce-root">The <kbd class="calibre16">AdminServlet</kbd> class goes through exactly the same steps using an <kbd class="calibre16">AdminExecutor</kbd> environment, so we will omit it for the sake of space.</p>
<p class="mce-root">To try out this code, just run it on a Java EE 8-compatible server using these URLs:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre16">http://localhost:8080/ch05-declarative/AdminServlet</kbd></li>
<li class="calibre14"><kbd class="calibre16">http://localhost:8080/ch05-declarative/UserServlet</kbd></li>
</ul>
<p class="mce-root">The result example for <kbd class="calibre16">AdminServlet</kbd> will be like this:</p>
<pre class="calibre21"><strong class="calibre3">Role "admin" access: true</strong><br class="calibre2"/><strong class="calibre3">Role "user" access: false</strong><br class="calibre2"/><strong class="calibre3">adminOperation executed: true</strong><br class="calibre2"/><strong class="calibre3">userOperation executed: false</strong><br class="calibre2"/><strong class="calibre3">everyoneCanDo executed: true</strong><br class="calibre2"/><strong class="calibre3">noneCanDo executed: false</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article class="calibre2">
                
<ul class="calibre13">
<li class="calibre14">Check the full source code of this recipe at <a href="https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-declarative" target="_blank" class="pcalibre pcalibre3 pcalibre1 calibre12 pcalibre2">https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-declarative</a>.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Using programmatic security</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root"><span class="calibre8">We've already seen the declarative approach, so now let's see the</span> programmatic approach.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start by adding the dependency:</p>
<pre class="calibre21">        &lt;dependency&gt;<br class="calibre2"/>            &lt;groupId&gt;javax&lt;/groupId&gt;<br class="calibre2"/>            &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;<br class="calibre2"/>            &lt;version&gt;8.0&lt;/version&gt;<br class="calibre2"/>            &lt;scope&gt;provided&lt;/scope&gt;<br class="calibre2"/>        &lt;/dependency&gt;</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre19">
<li class="chapter">Let's first define our roles list:</li>
</ol>
<pre class="mce-root2">public class Roles {<br class="calibre2"/>    public static final String ADMIN = "admin";<br class="calibre2"/>    public static final String USER = "user";<br class="calibre2"/>}</pre>
<ol start="2" class="calibre19">
<li class="chapter">Then, let's define a list of tasks to be done based on the role:</li>
</ol>
<pre class="mce-root2">@Stateful<br class="calibre2"/>public class UserBean {<br class="calibre2"/>    <br class="calibre2"/>    @RolesAllowed({Roles.ADMIN})<br class="calibre2"/>    public void adminOperation(){<br class="calibre2"/>        System.out.println("adminOperation executed");<br class="calibre2"/>    }<br class="calibre2"/>    <br class="calibre2"/>    @RolesAllowed({Roles.USER})<br class="calibre2"/>    public void userOperation(){<br class="calibre2"/>        System.out.println("userOperation executed");<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    @PermitAll<br class="calibre2"/>    public void everyoneCanDo(){<br class="calibre2"/>        System.out.println("everyoneCanDo executed");<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>}</pre>
<ol start="3" class="calibre19">
<li class="chapter">Now let's implement the <kbd class="calibre16">IndentityStore</kbd> interface. Here, we define our policy for validating the user's identity:</li>
</ol>
<pre class="mce-root2">@ApplicationScoped<br class="calibre2"/>public class UserIdentityStore implements IdentityStore {<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public CredentialValidationResult validate(Credential credential) {<br class="calibre2"/>        if (credential instanceof UsernamePasswordCredential) {<br class="calibre2"/>            return validate((UsernamePasswordCredential) credential);<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        return CredentialValidationResult.NOT_VALIDATED_RESULT;<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    public CredentialValidationResult validate(UsernamePasswordCredential <br class="calibre2"/>    usernamePasswordCredential) {<br class="calibre2"/><br class="calibre2"/>        if (usernamePasswordCredential.<br class="calibre2"/>        getCaller().equals(Roles.ADMIN)<br class="calibre2"/>                &amp;&amp; usernamePasswordCredential.<br class="calibre2"/>                getPassword().compareTo("1234")) <br class="calibre2"/>        {<br class="calibre2"/><br class="calibre2"/>            return new CredentialValidationResult(<br class="calibre2"/>                    new CallerPrincipal<br class="calibre2"/>                    (usernamePasswordCredential.getCaller()),<br class="calibre2"/>                    new HashSet&lt;&gt;(Arrays.asList(Roles.ADMIN)));<br class="calibre2"/>        } else if (usernamePasswordCredential.<br class="calibre2"/>          getCaller().equals(Roles.USER)<br class="calibre2"/>                &amp;&amp; usernamePasswordCredential.<br class="calibre2"/>                getPassword().compareTo("1234")) <br class="calibre2"/>        {<br class="calibre2"/><br class="calibre2"/>            return new CredentialValidationResult(<br class="calibre2"/>                    new CallerPrincipal<br class="calibre2"/>                    (usernamePasswordCredential.getCaller()),<br class="calibre2"/>                    new HashSet&lt;&gt;(Arrays.asList(Roles.USER)));<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        return CredentialValidationResult.INVALID_RESULT;<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>}</pre>
<ol start="4" class="calibre19">
<li class="chapter">Here, we implement the <kbd class="calibre16">HttpAuthenticationMethod</kbd> interface:</li>
</ol>
<pre class="mce-root2">@ApplicationScoped<br class="calibre2"/>public class AuthenticationMechanism implements HttpAuthenticationMechanism {<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private UserIdentityStore identityStore;<br class="calibre2"/>    <br class="calibre2"/>    @Override<br class="calibre2"/>    public AuthenticationStatus validateRequest(HttpServletRequest <br class="calibre2"/>    request, <br class="calibre2"/>    HttpServletResponse response, HttpMessageContext <br class="calibre2"/>    httpMessageContext) <br class="calibre2"/>    throws AuthenticationException {<br class="calibre2"/><br class="calibre2"/>        if (httpMessageContext.isAuthenticationRequest()) {<br class="calibre2"/><br class="calibre2"/>            Credential credential = <br class="calibre2"/>            httpMessageContext.getAuthParameters()<br class="calibre2"/>            .getCredential();<br class="calibre2"/>            if (!(credential instanceof UsernamePasswordCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid <br class="calibre2"/>                mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>            (identityStore.validate(credential));<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        return httpMessageContext.doNothing();<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>}</pre>
<ol start="5" class="calibre19">
<li class="chapter">And finally, we create the servlet where the user will both authenticate and do their stuff:</li>
</ol>
<pre class="mce-root2">@DeclareRoles({Roles.ADMIN, Roles.USER})<br class="calibre2"/>@WebServlet(name = "/OperationServlet", urlPatterns = {"/OperationServlet"})<br class="calibre2"/>public class OperationServlet extends HttpServlet {<br class="calibre2"/><br class="calibre2"/>    private static final long serialVersionUID = 1L;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private SecurityContext securityContext;<br class="calibre2"/><br class="calibre2"/>    @Inject<br class="calibre2"/>    private UserBean userActivity;<br class="calibre2"/><br class="calibre2"/>    @Override<br class="calibre2"/>    public void doGet(HttpServletRequest request, <br class="calibre2"/>    HttpServletResponse <br class="calibre2"/>    response) throws ServletException, IOException {<br class="calibre2"/><br class="calibre2"/>        String name = request.getParameter("name");<br class="calibre2"/>        String password = request.getParameter("password");<br class="calibre2"/><br class="calibre2"/>        Credential credential = new UsernamePasswordCredential(name, <br class="calibre2"/>        new Password(password));<br class="calibre2"/><br class="calibre2"/>        AuthenticationStatus status = securityContext.authenticate(<br class="calibre2"/>                request, response, <br class="calibre2"/>        withParams().credential(credential));<br class="calibre2"/><br class="calibre2"/>        response.getWriter().write("Role \"admin\" access: " + <br class="calibre2"/>        request.isUserInRole(Roles.ADMIN) + "\n");<br class="calibre2"/>        response.getWriter().write("Role \"user\" access: " + <br class="calibre2"/>        request.isUserInRole(Roles.USER) + "\n");<br class="calibre2"/><br class="calibre2"/>        if (status.equals(AuthenticationStatus.SUCCESS)) {<br class="calibre2"/><br class="calibre2"/>            if (request.isUserInRole(Roles.ADMIN)) {<br class="calibre2"/>                userActivity.adminOperation();<br class="calibre2"/>                response.getWriter().write("adminOperation <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } else if (request.isUserInRole(Roles.USER)) {<br class="calibre2"/>                userActivity.userOperation();<br class="calibre2"/>                response.getWriter().write("userOperation <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            userActivity.everyoneCanDo();<br class="calibre2"/>            response.getWriter().write("everyoneCanDo <br class="calibre2"/>            executed: true\n");<br class="calibre2"/><br class="calibre2"/>        } else {<br class="calibre2"/>            response.getWriter().write("Authentication failed\n");<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>    }<br class="calibre2"/>}</pre>
<p class="mce-root">To try out this code, run it in a Java EE 8-compatible server using these URLs:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre16">http://localhost:8080/ch05-programmatic/OperationServlet?name=user&amp;password=1234</kbd></li>
<li class="calibre14"><kbd class="calibre16">http://localhost:8080/ch05-programmatic/OperationServlet?name=admin&amp;password=1234</kbd></li>
</ul>
<p class="mce-root">An example of an <kbd class="calibre16">ADMIN</kbd> role's result is as follows:</p>
<p class="mce-root"> </p>
<pre class="calibre21"><strong class="calibre3">Role "admin" access: true<br class="calibre2"/>Role "user" access: false</strong><br class="calibre2"/><strong class="calibre3">adminOperation executed: true</strong><br class="calibre2"/><strong class="calibre3">everyoneCanDo executed: true</strong></pre>
<p class="mce-root">And if you use a wrong name/password pair, you get this result:</p>
<pre class="calibre21"><strong class="calibre3">Role "admin" access: false</strong><br class="calibre2"/><strong class="calibre3">Role "user" access: false</strong><br class="calibre2"/><strong class="calibre3">Authentication failed</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Contrary to the declarative approach (see the previous recipe in this chapter), here we are using code to validate the user. We've done it by implementing the <kbd class="calibre16">IdentityStore</kbd> interface.</p>
<p class="mce-root">For example, even though we've hardcoded the password, you can use the same piece of code to validate the password against a database, LDAP, an external endpoint, and many more:</p>
<pre class="calibre21">        if (usernamePasswordCredential.getCaller().equals(Roles.ADMIN)<br class="calibre2"/>                &amp;&amp; <br class="calibre2"/>        usernamePasswordCredential.getPassword().compareTo("1234")) <br class="calibre2"/>        {<br class="calibre2"/><br class="calibre2"/>            return new CredentialValidationResult(<br class="calibre2"/>                    new CallerPrincipal(usernamePasswordCredential<br class="calibre2"/>                    .getCaller()),<br class="calibre2"/>                    new HashSet&lt;&gt;(asList(Roles.ADMIN)));<br class="calibre2"/>        } else if (usernamePasswordCredential.getCaller()<br class="calibre2"/>          .equals(Roles.USER)<br class="calibre2"/>                &amp;&amp; usernamePasswordCredential.<br class="calibre2"/>                getPassword().compareTo("1234")) <br class="calibre2"/>        {<br class="calibre2"/><br class="calibre2"/>            return new CredentialValidationResult(<br class="calibre2"/>                    new CallerPrincipal(usernamePasswordCredential<br class="calibre2"/>                   .getCaller()),<br class="calibre2"/>                    new HashSet&lt;&gt;(asList(Roles.USER)));<br class="calibre2"/>        }<br class="calibre2"/><br class="calibre2"/>        return INVALID_RESULT;</pre>
<p class="mce-root">Authenticating using <kbd class="calibre16">IdentityStore</kbd> means just delegating using <kbd class="calibre16">HttpAuthenticationMethod</kbd>:</p>
<pre class="calibre21">            Credential credential = <br class="calibre2"/>            httpMessageContext.getAuthParameters().getCredential();<br class="calibre2"/>            if (!(credential instanceof UsernamePasswordCredential)) {<br class="calibre2"/>                throw new IllegalStateException("Invalid mechanism");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            return httpMessageContext.notifyContainerAboutLogin<br class="calibre2"/>            (identityStore.validate(credential));</pre>
<p class="mce-root">And then, <kbd class="calibre16">OperationServlet</kbd> will just try an authentication:</p>
<pre class="calibre21">        String name = request.getParameter("name");<br class="calibre2"/>        String password = request.getParameter("password");<br class="calibre2"/><br class="calibre2"/>        Credential credential = new UsernamePasswordCredential(name, <br class="calibre2"/>        new Password(password));<br class="calibre2"/><br class="calibre2"/>        AuthenticationStatus status = securityContext.authenticate(<br class="calibre2"/>                request, response, <br class="calibre2"/>               withParams().credential(credential));</pre>
<p class="mce-root">Based on this, we will define the flow of what will happen next:</p>
<pre class="calibre21">        if (status.equals(AuthenticationStatus.SUCCESS)) {<br class="calibre2"/><br class="calibre2"/>            if (request.isUserInRole(Roles.ADMIN)) {<br class="calibre2"/>                userActivity.adminOperation();<br class="calibre2"/>                response.getWriter().write("adminOperation <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            } else if (request.isUserInRole(Roles.USER)) {<br class="calibre2"/>                userActivity.userOperation();<br class="calibre2"/>                response.getWriter().write("userOperation <br class="calibre2"/>                executed: true\n");<br class="calibre2"/>            }<br class="calibre2"/><br class="calibre2"/>            userActivity.everyoneCanDo();<br class="calibre2"/>            response.getWriter().write("everyoneCanDo executed:</pre>
<pre class="calibre21"><br class="calibre2"/>        true\n");<br class="calibre2"/><br class="calibre2"/>        } else {<br class="calibre2"/>            response.getWriter().write("Authentication failed\n");<br class="calibre2"/>        }</pre>
<p class="mce-root">Pay attention! That is your code defining what each role will do.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article class="calibre2">
                
<ul class="calibre13">
<li class="calibre14">See the full source code for this recipe at <a href="https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-programmatic" target="_blank" class="pcalibre pcalibre3 pcalibre1 calibre12 pcalibre2">https://github.com/eldermoraes/javaee8-cookbook/tree/master/chapter05/ch05-programmatic</a>.</li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>