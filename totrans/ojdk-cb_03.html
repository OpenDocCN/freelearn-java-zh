<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Building OpenJDK 7"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Building OpenJDK 7</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Building OpenJDK 7 on Ubuntu Linux 12.04 LTS</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 7 on Mac OS X</li><li class="listitem" style="list-style-type: disc">Building 32-bit FreeType libraries for OpenJDK 7 on Windows</li><li class="listitem" style="list-style-type: disc">Building 64-bit FreeType libraries for OpenJDK 7 on Windows</li><li class="listitem" style="list-style-type: disc">Building 32-bit OpenJDK 7 on Windows 7 SP1</li><li class="listitem" style="list-style-type: disc">Building 64-bit OpenJDK 7 on Windows 7 x64 SP1</li><li class="listitem" style="list-style-type: disc">Preparing a standalone toolchain for 32- and 64-bit Windows builds</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Introduction</h1></div></div></div><p>OpenJDK 7<a id="id94" class="indexterm"/> is a free and open source implementation of Java Platform, Standard Edition Version 7. At the time of writing this book, it is the latest version of OpenJDK that was ready for the production usage.</p><p>Initially, a lot of advanced changes were planned for OpenJDK 7, such as the modular VM and lambda expression support, but due to various technical and organizational reasons, after Sun Microsystems' acquisition by Oracle, most of the new features were postponed for the next versions of OpenJDK. This expedited the release. It reached <span class="strong"><strong>General Availability</strong></span> status<a id="id95" class="indexterm"/> on 28 July 2011 and was the first OpenJDK version released as a Reference Implementation for the Java platform.</p><p>The major updates to OpenJDK 7 numbered update 2, update 4, and update 6 were released during the next year. After that, version numbering was changed and the next update 40, which is the latest version at the time of writing, was released in September 2013. The following update 60 was planned for May 2014 and the lifetime of OpenJDK 7 will end with update 80 in early 2015.</p><p>OpenJDK 7 release cycle differ from Oracle Java release cycles. Oracle Java updates are released for regular security-related changes and for OpenJDK updates. Oracle security changes are propagated to OpenJDK 7 (and to OpenJDK 6 where applicable) but OpenJDK is not released immediately after that. Instead, releases are done on major changes and cumulative security changes usually contain updated versions of HotSpot VM.</p><p>OpenJDK 7<a id="id96" class="indexterm"/> is supported on Linux, Windows, Mac OS X, and Solaris operating systems. Only Windows, Linux, and Mac OS X versions will be discussed further. For both Linux and Windows operating systems, x86 and x86_64 architectures are supported. For Mac OS X only x86_64 is supported. To conform with OpenJDK terminology, the <span class="strong"><strong>i586</strong></span> term<a id="id97" class="indexterm"/> will be used for x86 architecture and <span class="strong"><strong>amd64</strong></span><a id="id98" class="indexterm"/> will be used for the x86_64 one. OpenJDK 7 does not support cross-compilation, so the i586 operating system must be used to build the i586 version and the same is true for amd64. The build process for both architectures is almost the same for Linux version, but differs greatly for the Windows one.</p><p>In this chapter, we will use sources from the official OpenJDK 7 update 40 tarball.</p></div></div>
<div class="section" title="Building OpenJDK 7 on Ubuntu Linux 12.04 LTS"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Building OpenJDK 7 on Ubuntu Linux 12.04 LTS</h1></div></div></div><p>This recipe is similar to recipe <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</em></span> from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span>.</p><p>The build <a id="id99" class="indexterm"/>process of OpenJDK relies heavily on Unix-like development tools. Linux-based operating systems usually have<a id="id100" class="indexterm"/> top notch support for such tools, so building OpenJDK on Linux (and on Mac OS X) can be simpler than on Windows. For major distributions such as Fedora or Ubuntu, the build toolchain and all the dependencies are already included in distributions as packages and can be installed easily.</p><p>Ubuntu 12.04 LTS was chosen for this book because it is one of the most popular Linux distributions. For readers running other operating systems, Ubuntu 12.04 virtual images may be found online for the most popular virtualization tools, such as Oracle VirtualBox or VMware.</p><p>To build binaries for i586 and amd64 architectures, corresponding versions of Ubuntu should be used. The build instructions are exactly the same for both architectures so they won't be mentioned further in this recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec74"/>Getting ready</h2></div></div></div><p>For this recipe, we will need clean Ubuntu 12.04 (server or desktop version) running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec75"/>How to do it...</h2></div></div></div><p>The following instructions will help us to build OpenJDK 7:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the prepackaged binaries of OpenJDK 6:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install openjdk-6-jdk</strong></span>
</pre></div></li><li class="listitem">Install the GCC <code class="literal">toolchain</code> and build dependencies:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get build-dep openjdk-6</strong></span>
</pre></div></li><li class="listitem">Download<a id="id101" class="indexterm"/> and decompress the official OpenJDK 7 update 40 archive (results will be placed into the <code class="literal">openjdk</code> directory):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wget http://download.java.net/openjdk/jdk7u40/promoted/b43/openjdk-7u40-fcs-src-b43-26_aug_2013.zip</strong></span>
<span class="strong"><strong>unzip -q openjdk-7u40-fcs-src-b43-26_aug_2013.zip</strong></span>
</pre></div></li><li class="listitem">Create <a id="id102" class="indexterm"/>a new text file <code class="literal">buildenv.sh</code> with the following environment settings:<div class="informalexample"><pre class="programlisting">export LD_LIBRARY_PATH=
export CLASSPATH=
export JAVA_HOME=
export LANG=C
export ALT_BOOTDIR=/usr/lib/jvm/java-6-openjdk</pre></div></li><li class="listitem">Import the environment into the current shell session (note a dot and a space before it):<div class="informalexample"><pre class="programlisting">. buildenv.sh</pre></div></li><li class="listitem">Start the build process from the <code class="literal">openjdk</code> directory:<div class="informalexample"><pre class="programlisting">make 2&gt;&amp;1 | tee make.log</pre></div></li><li class="listitem">Wait for the build to finish, and try to run the newly built binaries:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd build/linux-amd64/j2sdk-image/</strong></span>
<span class="strong"><strong>./bin/java –version</strong></span>
<span class="strong"><strong>openjdk version "1.7.0-internal"</strong></span>
<span class="strong"><strong>OpenJDK Runtime Environment (build 1.7.0-internal-ubuntu_2014_02_08_08_56-b00)</strong></span>
<span class="strong"><strong>OpenJDK 64-Bit Server VM (build 24.0-b56, mixed mode)</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec76"/>How it works...</h2></div></div></div><p>The prepackaged binaries of OpenJDK 6 are required because some of the build steps are run using the external Java runtime.</p><p>The <code class="literal">build-dep</code> command is used to install all the dependencies that are required to build the specified package. As<a id="id103" class="indexterm"/> Ubuntu packaged OpenJDK 6 is quite close to the official OpenJDK 6, this command will install almost all the required dependencies.</p><p>After a<a id="id104" class="indexterm"/> successful build on the amd64 platform, JDK files will be placed into <code class="literal">build/linux-amd64/j2sdk-image</code> and JRE files will be placed into <code class="literal">build/linux-amd64/j2re-image</code>. On the i586 platform, the <code class="literal">build/linux-i586</code> path will be used instead. An additional package of Server JRE that contains JDK without demos and samples will be placed into the <code class="literal">j2sdk-server-image</code> directory.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec77"/>There's more...</h2></div></div></div><p>The Javadoc generation takes a lot of time and is the most memory consuming step of the build. It may be skipped with an additional environment variable:</p><div class="informalexample"><pre class="programlisting">export NO_DOCS=true</pre></div><p>Contrary to previous version, OpenJDK 7 supports parallel (multicore) native library compilation. The following environment variables may be used for the <code class="literal">jdk</code> and <code class="literal">hotspot</code> modules respectively:</p><div class="informalexample"><pre class="programlisting">PARALLEL_COMPILE_JOBS=N
HOTSPOT_BUILD_JOBS=N</pre></div><p>This build has generated a milestone tag and build number <code class="literal">b00</code>. Predefined build numbers and milestones may be set using additional environment variables:</p><div class="informalexample"><pre class="programlisting">export MILESTONE=ubuntu-build
export BUILD_NUMBER=b30</pre></div><p>The <code class="literal">cacerts</code> file may be provided during the build, using additional environment variable:</p><div class="informalexample"><pre class="programlisting">export ALT_CACERTS_FILE=path/to/cacerts</pre></div><p>For amd64 builds preinstalled Java provided by variable <code class="literal">ALT_BOOTDIR</code> may be either the amd64 or i586 build. The i586 binaries consume less memory and may be used for amd64 builds on limited hardware.</p><p>OpenJDK 7 has the same minimum build requirements on Linux as the previous version, so Debian 5.0 Lenny may be used to build the most compatible version.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec78"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Setting up the minimum build environment for the most compatible Linux builds</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK 7 at <a class="ulink" href="http://hg.openjdk.java.net/jdk7u/jdk7u/raw-file/tip/README-builds.html">http://hg.openjdk.java.net/jdk7u/jdk7u/raw-file/tip/README-builds.html</a></li></ul></div></div></div>
<div class="section" title="Building OpenJDK 7 on Mac OS X"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Building OpenJDK 7 on Mac OS X</h1></div></div></div><p>OpenJDK 7 <a id="id105" class="indexterm"/>supports the Mac OS X platform as a <span class="emphasis"><em>first class citizen</em></span> and building it using the proper version of <code class="literal">toolchain</code> is almost as easy as on Linux.</p><p>Historically, Java<a id="id106" class="indexterm"/> had first class support on Mac OS X. JDK was based on Sun codebase but built by Apple and integrated fully into their operating system environment. Up to Mac OS X 10.4 Tiger, graphical user interface applications written using the standard Swing toolkit had access to most of the Cocoa native interface features. Applications written in Java were very close to native ones, while still being cross-platform.</p><p>But with the next releases, the level of Java support went down. Starting from Mac OS X 10.5 Leopard, newer Cocoa features became unsupported for Java. Release of Apple Java 6 was postponed (comparing to Sun releases for other platforms) for more than a year. Java 6 was released in December 2006 but was not available for Mac OS X users until April 2008. Finally in October 2010, Apple officially announced discontinuation of Java support. Apple Java 6 is still being updated with security updates and may be installed on Mac OS X 10.9 Mavericks (the latest version at the time of writing) but no future Java versions will be released by Apple.</p><p>Third-party open source Java distributions existed for Mac OS X. The most notable is the SoyLatte—X11-based port of the FreeBSD Java 1.6 patchset to Mac OS X Intel machines. SoyLatte predated OpenJDK, was licensed under Java Research License, and supported Java 6 builds. Now it is part of the OpenJDK BSD-Port project.</p><p>Currently the official latest stable Java version for Mac OS X is Oracle Java 7 which matches closely with OpenJDK. In this recipe, we will build an OpenJDK 7 update 40 on Mac OS X 10.7.5 Lion. This operating system version was chosen because 10.7.3 is the official minimum build requirement platform that should provide the most compatible binaries for Mac OS X, and 10.7.5 matches it quite closely, but may run on newer Intel Ivy Bridge processors and may also be virtualized relatively easily using popular virtualization tools such as Oracle VirtualBox or VMware.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec79"/>Getting ready</h2></div></div></div><p>For this recipe, we will need clean Mac OS X 10.7.5 Lion running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec80"/>How to do it...</h2></div></div></div><p>The following procedures will help us to build OpenJDK 7:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download Xcode 3.4.2 for Lion (March 22, 2012) from <a class="ulink" href="https://developer.apple.com/xcode/">https://developer.apple.com/xcode/</a> (an Apple developer's account is required, registration is free) and install it.</li><li class="listitem">Download the Command Line Tools for Xcode—late March 2012 (March 21, 2012) using the same download link mentioned previously and install it.</li><li class="listitem">Run this command from the terminal to set up the command line tools:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer/</strong></span>
</pre></div></li><li class="listitem">Navigate <a id="id107" class="indexterm"/>to <span class="strong"><strong>Applications</strong></span> | <span class="strong"><strong>Utilities</strong></span> and run <span class="strong"><strong>X11.app</strong></span> to install it as an additional download.</li><li class="listitem">Install the JDK 7—Oracle<a id="id108" class="indexterm"/> distribution, or prebuilt OpenJDK binaries may be used.</li><li class="listitem">Download Apache Ant 1.8.4 from <a class="ulink" href="http://archive.apache.org/dist/ant/binaries/">http://archive.apache.org/dist/ant/binaries/</a> and decompress it.</li><li class="listitem">Download the source archive <code class="literal">openjdk-7u40-fcs-src-b43-26_aug_2013.zip</code> from <a class="ulink" href="http://download.java.net/openjdk/jdk7u40/promoted/b43/">http://download.java.net/openjdk/jdk7u40/promoted/b43/</a> and decompress it.</li><li class="listitem">Create a new text file <code class="literal">buildenv.sh</code> with the following environment settings:<div class="informalexample"><pre class="programlisting">export LD_LIBRARY_PATH=
export CLASSPATH=
export JAVA_HOME=
export LANG=C
export ANT_HOME=path/to/ant
export PATH=path/to/ant/bin:$PATH
export ALT_BOOTDIR=path/to/jdk7</pre></div></li><li class="listitem">Import the environment into the current terminal session (note a dot and a space before it):<div class="informalexample"><pre class="programlisting">. buildenv.sh</pre></div></li><li class="listitem">Start the build process from the <code class="literal">openjdk</code> directory:<div class="informalexample"><pre class="programlisting">make 2&gt;&amp;1 | tee make.log</pre></div></li><li class="listitem">Wait for the build to finish, and try to run the newly built binaries:<div class="informalexample"><pre class="programlisting">cd build/macosx-x86_64/j2sdk-image/
./bin/java –version
openjdk version "1.7.0-internal"
OpenJDK Runtime Environment (build 1.7.0-internal-obf_2014_02_07_21_32-b00)
OpenJDK 64-Bit Server VM (build 24.0-b56, mixed mode)</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec81"/>How it works...</h2></div></div></div><p>As well as the <a id="id109" class="indexterm"/>Xcode Command Line Tools that are used for the main part of the native source, Xcode itself is also required to build platform specific code.</p><p>OpenJDK on<a id="id110" class="indexterm"/> Mac OS X is moving away from using the X11 server, but it is still required for Version 7 builds. Mac OS X 10.7 Lion has X11 preinstalled, it just needs to be run once to be configured for the build.</p><p>Apple JDK6 may be used instead of OpenJDK7, but it requires additional configuration.</p><p>The Apache Ant build tool is required for some modules of the build.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec82"/>There's more...</h2></div></div></div><p>This recipe uses the official Apple builds of GCC (and G++) Version 4.2 as compilers. After that version, official Apple support for GCC was discontinued for licensing reasons. Clang—the open source compiler initially developed by Apple—is the default and preferred compiler in newer versions of Mac OS X. While newer versions of OpenJDK support Clang on Mac OS X, Version 7 still requires GCC.</p><p>OpenJDK 7 could be built on Mac OS X 10.8 Mountain Lion using the same steps. The only addition is that the X11 server should be installed separately using the XQuartz project.</p><p>Newer versions of Xcode and recent updates of Mac OS X 10.9 Mavericks may break the OpenJDK builds. If builds using newer OS / <code class="literal">toolchain</code> are desired, it is better to check the current situation with the build and proposed solutions on OpenJDK mailing lists.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec83"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span> for information about build tuning</li><li class="listitem" style="list-style-type: disc">The official build instructions for Mac OS X on OpenJDK Wikipedia at <a class="ulink" href="https://wikis.oracle.com/display/OpenJ">https://wikis.oracle.com/display/OpenJ</a></li></ul></div></div></div>
<div class="section" title="Building 32-bit FreeType libraries for OpenJDK 7 on Windows"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Building 32-bit FreeType libraries for OpenJDK 7 on Windows</h1></div></div></div><p>The <a id="id111" class="indexterm"/>majority of fonts used in modern software are encoded in vector format for proper scaling support. There are<a id="id112" class="indexterm"/> multiple <a id="id113" class="indexterm"/>standards for vector fonts, for example Metafont from Professor Donald E. Knuth, Type1 from Adobe, TrueType from Apple and Microsoft, and OpenType from Adobe and Microsoft.</p><p>Rasterization of vector fonts is a remarkably complex task and most desktop software (such as web browsers or text processors) use third-party libraries to work with fonts.</p><p>Sun Microsystems licensed a third-party <a id="id114" class="indexterm"/>closed source font library for use in Sun Java implementation. The sources for this library could not be released to the public along with the initial release of OpenJDK. The Font Scaler Replacement Project was launched in the early days of OpenJDK to adopt the open source font library instead.</p><p>FreeType<a id="id115" class="indexterm"/> is a free and open source (under permissive license) font rasterization library. It is widely used in open source desktop software. FreeType was chosen by the OpenJDK team as a replacement for the closed source font library and is now used by OpenJDK on all supported platforms. Prebuilt static and dynamic FreeType libraries are required for OpenJDK builds on Windows.</p><p>FreeType may be built for OpenJDK 7 using the same Microsoft Windows SDK for Windows 7 and .NET Framework 4 (Version 7.1) that we will use for both i586 and amd64 OpenJDK builds. We will use the freely available Visual Studio 2010 Express Edition to configure the build settings for the FreeType project.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec84"/>Getting ready</h2></div></div></div><p>For this recipe, we should have Windows 7 SP1 i586 running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec85"/>How to do it...</h2></div></div></div><p>The following procedure will help us to build FreeType:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download Microsoft .NET Framework 4 from the Microsoft website and install it.</li><li class="listitem">Download Microsoft Windows SDK for Windows 7 and .NET Framework 4 (Version 7.1) from the Microsoft website and install it to the default location with image filename <code class="literal">GRMSDK_EN_DVD.iso</code>.</li><li class="listitem">Download Visual Studio 2010 Express Edition from the Microsoft website and install it to the default location. Only the Visual C++ component is required.</li><li class="listitem">Download the FreeType 2.5.2 sources tarball from <a id="id116" class="indexterm"/><a class="ulink" href="http://freetype.org/">http://freetype.org/</a> and decompress it.</li><li class="listitem">Open the file <code class="literal">include\config\ftoption.h</code> and uncomment line 95:<div class="informalexample"><pre class="programlisting">#define FT_CONFIG_OPTION_SUBPIXEL_RENDERING</pre></div></li><li class="listitem">Change lines 269 and 271 from <code class="literal">/* #define FT_EXPORT(x)      extern x */ </code>and <code class="literal">/* #define FT_EXPORT_DEF(x)  x */</code> to <code class="literal">#define FT_EXPORT(x) __declspec(dllexport) x</code> and <code class="literal">#define FT_EXPORT_DEF(x) __declspec(dllexport) x</code>.</li><li class="listitem">Open the solution <code class="literal">builds\windows\vc2010\freetype.sln</code> in Visual Studio.</li><li class="listitem">In the main menu, go to <span class="strong"><strong>Project</strong></span> | <span class="strong"><strong>Properties</strong></span> | <span class="strong"><strong>Configuration Properties</strong></span> and choose Windows7.1 SDK in the <span class="strong"><strong>Platform Toolset</strong></span> field.</li><li class="listitem">On the <a id="id117" class="indexterm"/>main screen choose <span class="strong"><strong>Release Multithreaded</strong></span> as the <span class="strong"><strong>Solution Configuration</strong></span>.</li><li class="listitem">Run build, and <a id="id118" class="indexterm"/>the <code class="literal">freetype252MT.lib</code> library will be placed into the <code class="literal">freetype\objs\win32\vc2010</code> directory; rename it to <code class="literal">freetype.lib</code>, and save it for later use.</li><li class="listitem">In the <a id="id119" class="indexterm"/>main menu, go to <span class="strong"><strong>Project</strong></span> | <span class="strong"><strong>Properties</strong></span> | <span class="strong"><strong>Configuration Properties</strong></span>, change <span class="strong"><strong>Configuration Type</strong></span> to <span class="strong"><strong>Dynamic Library (.dll)</strong></span>, and build the solution. The <code class="literal">freetype252MT.dll</code> and <code class="literal">freetype252MT.exp</code> files will be placed into the <code class="literal">objs\release_mt</code> directory. Rename these files <code class="literal">freetype.dll</code> and <code class="literal">freetype.exp</code> and use them with the previously generated <code class="literal">freetype.lib</code> during the OpenJDK build.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec86"/>How it works...</h2></div></div></div><p>FreeType for i586 may be built using Visual Studio's own toolset, but we used the Windows SDK7.1 toolset to ensure compatibility with the OpenJDK build that uses the same toolset.</p><p>The <code class="literal">FT_CONFIG_OPTION_SUBPIXEL_RENDERING</code> macro<a id="id120" class="indexterm"/> enables subpixel rendering functionality in FreeType implementation.</p><p>The <code class="literal">FT_EXPORT</code><a id="id121" class="indexterm"/> and <code class="literal">FT_EXPORT_DEF</code><a id="id122" class="indexterm"/> macros should be adjusted with the calling conventions for the current platform. We changed them to use Windows-specific calling conventions.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec87"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 64-bit FreeType libraries for OpenJDK 7 on Windows</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The FreeType official website at <a class="ulink" href="http://freetype.org/">http://freetype.org/</a></li><li class="listitem" style="list-style-type: disc">Professor Donald E. Knuth's interview covering Metafont and TrueType at <a class="ulink" href="http://www.advogato.org/article/28.html">http://www.advogato.org/article/28.html</a></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>OpenJDK: Font Scaler Replacement Project</em></span> page at <a class="ulink" href="http://openjdk.java.net/projects/font-scaler/">http://openjdk.java.net/projects/font-scaler/</a></li></ul></div></div></div>
<div class="section" title="Building 64-bit FreeType libraries for OpenJDK 7 on Windows"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Building 64-bit FreeType libraries for OpenJDK 7 on Windows</h1></div></div></div><p>The FreeType build for <a id="id123" class="indexterm"/>Windows <a id="id124" class="indexterm"/>amd64 is similar<a id="id125" class="indexterm"/> to the i586 build from the previous recipe. Only different steps will be written in this recipe. Please refer to the previous recipe, <span class="emphasis"><em>Building 32-bit FreeType libraries for OpenJDK 7 on Windows</em></span> for more detailed instructions.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec88"/>Getting ready</h2></div></div></div><p>For this recipe, we should have Windows 7 SP1 amd64 running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec89"/>How to do it...</h2></div></div></div><p>The following procedures will help us in building FreeType:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download Microsoft .NET Framework 4 (Version 7.1), Microsoft Windows SDK for Windows 7 and Visual Studio 2010 Express Edition from the Microsoft website, and install them to default locations. The amd64 version of the SDK from the <code class="literal">GRMSDKX_EN_DVD.iso</code> file should be used.</li><li class="listitem">Follow steps 4 to 9 from the previous recipe to download and adjust the FreeType sources and configure the project in Visual Studio.</li><li class="listitem">On the main screen choose <span class="strong"><strong>x64</strong></span> as the <span class="strong"><strong>Solution Platform</strong></span>.</li><li class="listitem">Follow steps 10 and 11 from the previous recipe. Libraries will be placed into the <code class="literal">freetype\builds\windows\vc2010\x64\Release Multithreaded</code> directory.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec90"/>How it works...</h2></div></div></div><p>FreeType amd64 cannot be built using the Express Edition of Visual Studio 2010. The Professional Edition or the Windows SDK toolset should be used. As we will use Windows SDK 7.1 for OpenJDK builds, we are also using it for appropriate FreeType builds.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec91"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 32-bit FreeType libraries for OpenJDK 7 on Windows</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Building 32-bit OpenJDK 7 on Windows 7 SP1"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Building 32-bit OpenJDK 7 on Windows 7 SP1</h1></div></div></div><p>The OpenJDK 7 build<a id="id126" class="indexterm"/> process on the Windows platform has undertaken major improvements in comparison to Version 6. Despite that, the build <a id="id127" class="indexterm"/>environment setup is still much more complex than on Linux and Mac OS X. Much of the complexity of the build comes from its usage of a Unix-like build environment through Cygwin tools.</p><p>The official compiler requirement for i586 builds is Microsoft Visual Studio C++ 2010 Professional Edition. The Express Edition of Visual Studio 2010 also may be used for the i586 build. While this edition is free (as in "free beer") it has an evaluation period of 30 days and requires registration after that. While registration is also free, this requirement may be problematic for some usage scenarios (for example, automated build services).</p><p>Instead of Visual Studio 2010, we will use Microsoft Windows SDK Version 7.1 for Windows 7. This SDK is also available for free from the Microsoft website and may be used without registration. It uses the same compiler as Visual Studio 2010 Express. It contains only Command Line Tools (no GUI) but may be used as an external toolset from Visual Studio 2010 if GUI is desired.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec92"/>Getting ready</h2></div></div></div><p>For this recipe, we should have Windows 7 SP1 i586 running with no antivirus software installed. Antivirus software is not allowed because it may interfere with Cygwin runtime.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec93"/>How to do it...</h2></div></div></div><p>The following procedure will help us to build OpenJDK:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download Microsoft .NET Framework 4 from the Microsoft website and install it.</li><li class="listitem">Download the Microsoft Windows SDK for Windows 7 from the Microsoft website and install it to the default location. The .NET Development and Common Utilities components are not required.</li><li class="listitem">Download and install the Microsoft DirectX 9.0 SDK (Summer 2004) to the default installation path. Note that this distribution is not available any more on the Microsoft website. It may however be downloaded from other places. The file details are as follows:<div class="informalexample"><pre class="programlisting">name: dxsdk_sum2004.exe
size: 239008008 bytes
sha1sum: 73d875b97591f48707c38ec0dbc63982ff45c661</pre></div></li><li class="listitem">Install or copy a preinstalled version of Cygwin to <code class="literal">c:\cygwin</code>.</li><li class="listitem">Create the <code class="literal">c:\path_prepend</code> directory and copy into it <code class="literal">find.exe</code> and <code class="literal">sort.exe</code> files from the Cygwin installation.</li><li class="listitem">Download <a id="id128" class="indexterm"/>GNU make utility binary from <a class="ulink" href="http://www.cmake.org/">http://www.cmake.org/</a> using <a class="ulink" href="http://www.cmake.org/files/cygwin/make.exe-cygwin1.7">http://www.cmake.org/files/cygwin/make.exe-cygwin1.7</a>, rename it to <code class="literal">make.exe</code>, and put it in the <code class="literal">c:\make</code> directory.</li><li class="listitem">Download the Apache Ant Version 1.8.4 zip distribution from <a class="ulink" href="http://apache.org/">http://apache.org/</a> and decompress it to the <code class="literal">c:\ant</code> directory.</li><li class="listitem">Download the prebuilt FreeType libraries from the <code class="literal">openjdk-unofficial-builds GitHub</code> project (directory <code class="literal">7_32</code>) and put the binaries into the <code class="literal">c:\freetype\lib</code> directory and the header files into the <code class="literal">c:\freetype\include</code> directory.</li><li class="listitem">Install<a id="id129" class="indexterm"/> the OpenJDK 6 binaries or Oracle Java 6 into <code class="literal">c:\jdk6</code>.</li><li class="listitem">Download the official OpenJDK 7 update 40 source archive from the <a class="ulink" href="http://download.java.net/openjdk/jdk7u40/promoted/b43/">http://download.java.net/openjdk/jdk7u40/promoted/b43/</a> web page and decompress it to the <code class="literal">c:\sources</code> directory.</li><li class="listitem">Create the <code class="literal">build.bat</code> batch file and write the following environment variables settings:<div class="informalexample"><pre class="programlisting">@echo off
rem clear variables
set LD_LIBRARY_PATH=
set CLASSPATH=
set JAVA_HOME=
rem ALT_* variables
set ALT_BOOTDIR=C:/jdk7
set ALT_FREETYPE_LIB_PATH=C:/freetype/lib
set ALT_FREETYPE_HEADERS_PATH=C:/freetype/include
set NO_DOCS=true
rem set compiler environment manually
set WINDOWSSDKDIR=C:/Program Files/Microsoft SDKs/Windows/v7.1/
set VSDIR=C:/Program Files/Microsoft Visual Studio 10.0/
set VS100COMNTOOLS=%VSDIR%/Common7/Tools
set Configuration=Release
set WindowsSDKVersionOverride=v7.1
set ToolsVersion=4.0
set TARGET_CPU=x86
set CURRENT_CPU=x86
set PlatformToolset=Windows7.1SDK
set TARGET_PLATFORM=WIN7
set LIB=%VSDIR%/VC/Lib;%WINDOWSSDKDIR%/Lib
set LIBPATH=%VSDIR%/VC/Lib
rem set path
set PATH=C:/path_prepend;%VSDIR%/Common7/IDE;%VS100COMNTOOLS%;%VSDIR%/VC/Bin;%VSDIR%/VC/Bin/VCPackages;%WINDOWSSDKDIR%/Bin;C:/WINDOWS/system32;C:/WINDOWS;C:/WINDOWS/System32/Wbem;C:/make;C:/cygwin/bin;C:/jdk7/bin;C:/ant/bin
set INCLUDE=%VSDIR%/VC/INCLUDE;%WINDOWSSDKDIR%/INCLUDE;%WINDOWSSDKDIR%/INCLUDE/gl;
bash
echo Press any key to close window ...
pause &gt; nul</pre></div></li><li class="listitem">Run <code class="literal">build.bat</code> from Windows Explorer. The <code class="literal">cmd.exe</code> window should appear with bash launched.</li><li class="listitem">From the<a id="id130" class="indexterm"/> bash Command Prompt run the following commands:<div class="informalexample"><pre class="programlisting">cd /cygdrive/c/sources
chmod –R 777 .
make &gt; make.log 2&gt;&amp;1</pre></div></li><li class="listitem">Launch another Cygwin console and run the following commands:<div class="informalexample"><pre class="programlisting">cd /cygdrive/c/sources
tail -f make.log</pre></div></li><li class="listitem">Wait for the build to finish.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec94"/>How it works...</h2></div></div></div><p>Cygwin installation<a id="id131" class="indexterm"/> is covered in the <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span>.</p><p>Directories in the root of disk C are used here for brevity. Generally, arbitrary paths consist of ASCII letters or numbers and no spaces may be used.</p><p>A newer version of the DirectX SDK also may be used.</p><p>Different GNU make versions might have different problems on Windows. This particular version from the cmake project was tested on different Windows versions and works fine.</p><p>This recipe uses prebuilt FreeType 2.4.10 libraries from the <code class="literal">openjdk-unofficial-builds GitHub</code> project. FreeType may be built from sources using the same Windows SDK 7.1 toolchain. Please see the <span class="emphasis"><em>Building 32-bit FreeType libraries for OpenJDK 7 on Windows</em></span> recipe in this chapter.</p><p>In the environment settings, additional attention should be paid to the order of the <code class="literal">PATH</code> variable content. Sort and find Cygwin utilities should go at start of the <code class="literal">PATH</code> variable to avoid being overshadowed by the Windows' utilities with the same name but different functionality. Make goes before Cygwin to avoid being overshadowed by another version of make that may be included in the Cygwin installation.</p><p>The <code class="literal">chmod 777</code> command<a id="id132" class="indexterm"/> is required to fix Cygwin file permissions that may cause errors later stages of the build.</p><p>The make output will be redirected to the <code class="literal">make.log</code> file. The <code class="literal">2&gt;&amp;1 </code>statement ensures that both <code class="literal">stdout</code> and <code class="literal">stderr</code> will be redirected.</p><p>The <code class="literal">tail -f</code> command<a id="id133" class="indexterm"/> allows us to watch the contents of the <code class="literal">make.log</code> file as they are written during the build process.</p><p>The <code class="literal">pause &gt; nul</code> command<a id="id134" class="indexterm"/> is added at the end of the batch file to prevent the <code class="literal">cmd.exe</code> window disappearing in the case of runtime errors.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec95"/>There's more...</h2></div></div></div><p>To build the most compatible binaries, the same recipe should be used, but the Windows XP operating system should be used instead of Windows 7.</p><p>In Windows XP, the <code class="literal">chmod 777</code> command is not required.</p><p>The <code class="literal">tee</code> command<a id="id135" class="indexterm"/> may be used instead of <code class="literal">&gt;</code> and <code class="literal">tail</code> to write the build log to file and console simultaneously.</p><p>The <code class="literal">SetEnv.Cmd</code> script<a id="id136" class="indexterm"/> from Windows SDK may be used (with proper flags) to set the compiler environment instead of setting variables manually.</p><p>Visual Studio 2010 Express or Professional edition may be used instead of Windows SDK 7.1.</p><p>Prebuilt OpenJDK 7 or Oracle Java 7 may be used as the boot JDK instead of 6.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec96"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 32-bit OpenJDK 6 on Windows 7 SP1</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span> for information about build tuning</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 32-bit FreeType libraries for OpenJDK 7 on Windows</em></span> recipe from this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe from this chapter</li><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK 7 at <a class="ulink" href="http://hg.openjdk.java.net/jdk7u/jdk7u/raw-file/tip/README-builds.html">http://hg.openjdk.java.net/jdk7u/jdk7u/raw-file/tip/README-builds.html</a></li></ul></div></div></div>
<div class="section" title="Building 64-bit OpenJDK 7 on Windows 7 x64 SP1"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Building 64-bit OpenJDK 7 on Windows 7 x64 SP1</h1></div></div></div><p>The <a id="id137" class="indexterm"/>amd64 build in Windows 7 is similar to the i586 build, but has additional complications.</p><p>Cygwin (at least the more common i586 version) works much worse on amd64 Windows. Due to the much bigger address space size, Cygwin<a id="id138" class="indexterm"/> fork techniques work much slower and are less reliable.</p><p>Visual Studio 2010 Express Edition does not support amd64 architecture, so Microsoft Windows SDK version 7.1 for Windows 7 or the Professional Edition of Visual Studio should be used.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec97"/>Getting ready</h2></div></div></div><p>For this recipe, we should have Windows 7 SP1 amd64 running with no antivirus software installed. Antivirus software is not allowed because it may interfere with Cygwin runtime.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec98"/>How to do it...</h2></div></div></div><p>The following procedures will help us to build OpenJDK:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Follow steps 1 to 10 from the previous recipe, <span class="emphasis"><em>Building 32-bit OpenJDK 7 on Windows 7 SP1</em></span>, using the amd64 version of the Windows SDK and the FreeType libraries from the <code class="literal">7_64</code> directory.</li><li class="listitem">Create a <code class="literal">build.bat</code> batch file and write the following environment variables settings there:<div class="informalexample"><pre class="programlisting">@echo off
rem clear variables
set LD_LIBRARY_PATH=
set CLASSPATH=
set JAVA_HOME=
rem ALT_* variables
set ALT_BOOTDIR=C:/jdk7
set ALT_FREETYPE_LIB_PATH=C:/freetype/lib
set ALT_FREETYPE_HEADERS_PATH=C:/freetype/include
set NO_DOCS=true
rem set compiler environment manually
set WINDOWSSDKDIR=C:/Program Files/Microsoft SDKs/Windows/v7.1/
set VSDIR=C:/Program Files (x86)/Microsoft Visual Studio 10.0/
set VS100COMNTOOLS=%VSDIR%/Common7/Tools
set Configuration=Release
set WindowsSDKVersionOverride=v7.1
set ToolsVersion=4.0
set TARGET_CPU=x64
set CURRENT_CPU=x64
set PlatformToolset=Windows7.1SDK
set TARGET_PLATFORM=WIN7
set LIB=%VSDIR%/VC/Lib/amd64;%WINDOWSSDKDIR%/Lib/x64
set LIBPATH=%VSDIR%/VC/Lib/amd64
rem set path
set PATH=C:/path_prepend;%VSDIR%/Common7/IDE;%VS100COMNTOOLS%;%VSDIR%/VC/Bin/x86_amd64;%VSDIR%/VC/Bin;%VSDIR%/VC/Bin/VCPackages;%WINDOWSSDKDIR%/Bin;C:/WINDOWS/system32;C:/WINDOWS;C:/WINDOWS/System32/Wbem;C:/make;C:/cygwin/bin;C:/jdk7/bin;C:/ant/bin
set INCLUDE=%VSDIR%/VC/INCLUDE;%WINDOWSSDKDIR%/INCLUDE;%WINDOWSSDKDIR%/INCLUDE/gl;
bash
echo Press any key to close window ...
pause &gt; nul</pre></div></li><li class="listitem">Follow steps 12 to 15 from the previous recipe.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec99"/>How it works...</h2></div></div></div><p>The amd64 build <a id="id139" class="indexterm"/>is similar to the i586 build, but can be much slower because Cygwin works slower on a 64-bit OS.</p><p>The build can be <a id="id140" class="indexterm"/>done using either the i586 or amd64 boot JDK, the only difference is amd64 requires more memory (not less than 1024MB).</p><p>For additional details, please see the <span class="emphasis"><em>How it works...</em></span> section of the previous recipe <span class="emphasis"><em>Building 32-bit OpenJDK 7 on Windows 7 SP1</em></span>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec100"/>There's more...</h2></div></div></div><p>To build the most compatible binaries, the same recipe should be used, but the Windows 2003 Server amd64 operating system should be used instead of Windows 7.</p><p>In Windows 2003, the <code class="literal">chmod 777</code> command is not required.</p><p>A prebuilt OpenJDK 7 or Oracle Java 7 may be used as the boot JDK instead of 6.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec101"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 32-bit OpenJDK 7 on Windows 7 SP1</em></span> recipe from this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 64-bit OpenJDK 6 on Windows 7 x64 SP1</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 6 on Ubuntu Linux 12.04 LTS</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span>, for information about build tuning</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 64-bit FreeType libraries for OpenJDK 7 on Windows</em></span> recipe from this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Preparing CA certificates</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The official build instructions for OpenJDK 7 at <a class="ulink" href="http://hg.openjdk.java.net/jdk7u/jdk7u/raw-file/tip/README-builds.html">http://hg.openjdk.java.net/jdk7u/jdk7u/raw-file/tip/README-builds.html</a></li></ul></div></div></div>
<div class="section" title="Preparing a standalone toolchain for 32- and 64-bit Windows' builds"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Preparing a standalone toolchain for 32- and 64-bit Windows' builds</h1></div></div></div><p>In the<a id="id141" class="indexterm"/> previous recipes in this chapter, we built OpenJDK 7 for Windows using Windows SDK Version 7.1. This SDK requires installation prior to using it. The installation process requires .NET Framework 2 (to run the installer, included in Windows 7) and .NET Framework 4. Installation of these components may be very time consuming in some usage scenarios. For example, to automated builds it may be desirable to use completely clean Windows images for the builds. Besides being slow, the .NET Framework and SDK installers are graphical tools and may be hard to script for automatic installation.</p><p>In this recipe, we will create a set of files and an environment script that can be used to build OpenJDK 7 i586 and amd64 on completely clean Windows installations (with corresponding architecture) without installing any tools through GUI installers. Such a set of files may be put under the version control system to be checked out prior to the build.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec102"/>Getting ready</h2></div></div></div><p>For this recipe, we should have two clean images of Windows 7 SP1. One of them should have the i586 architecture and other should have the amd64 architecture.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec103"/>How to do it...</h2></div></div></div><p>The following procedure will help us to prepare a standalone toolchain:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download the Microsoft Windows SDK for Windows 7 i586 (<code class="literal">GRMSDK_EN_DVD.iso</code>) from the Microsoft website and install it on the i586 Windows instance in the default location. The <code class="literal">.NET Development</code> and <code class="literal">Common Utilities</code> components are not required.</li><li class="listitem">Create a <code class="literal">toolchain</code> directory. We will put various tools and libraries there and will refer to this directory as <code class="literal">&lt;toolchain&gt;</code>.</li><li class="listitem">Copy the SDK files from the <code class="literal">C:\Program Files\Microsoft SDKs\Windows\v7.1 to &lt;toolchain&gt;\winsdk71\sdk</code> directory.</li><li class="listitem">Copy the Visual Studio files shipped with the SDK from the <code class="literal">C:\Program Files\Microsoft Visual Studio 10.0 to &lt;toolchain&gt;\winsdk71\vs2010e</code> directory.</li><li class="listitem">Download the Microsoft Windows SDK for Windows 7 amd64 (<code class="literal">GRMSDKX_EN_DVD.iso</code>) from the Microsoft website and install it on the amd64 Windows instance in the default location. The <code class="literal">.NET Development</code> and <code class="literal">Common Utilities</code> components are not required.</li><li class="listitem">Copy the <code class="literal">C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\x64</code> directory from the SDK amd64 installation to the <code class="literal">&lt;toolchain&gt;\winsdk71\sdk/Bin/x64</code> directory.</li><li class="listitem">Download <a id="id142" class="indexterm"/>and install the Microsoft DirectX 9.0 SDK (Summer 2004) to the default installation path on the i586 Windows instance. Note that this distribution is not available anymore on the Microsoft website. It may be downloaded from another place online, and the file details are as follows:<div class="informalexample"><pre class="programlisting">name: dxsdk_sum2004.exe
size: 239008008 bytes
sha1sum: 73d875b97591f48707c38ec0dbc63982ff45c661</pre></div></li><li class="listitem">Copy files from the <code class="literal">C:\Program Files\Microsoft DirectX 9.0 SDK (Summer 2004)</code> directory to the <code class="literal">&lt;toolchain&gt;\directx</code> directory.</li><li class="listitem">On the Windows i586 instance copy the files from the <code class="literal">C:\Windows\System32</code> directory to the <code class="literal">&lt;toolchain&gt;\msvcr/7_32</code> directory:<div class="informalexample"><pre class="programlisting">msvcp100.dll
msvcr100.dll
msvcr100_clr0400.dll</pre></div></li><li class="listitem">On the Windows amd64 instance copy the same files as on the previous step (they should have the amd64 architecture) to the <code class="literal">&lt;toolchain&gt;\msvcr\7_64</code> directory.</li><li class="listitem">Create an <code class="literal">env_32.bat</code> file with the following environment configuration that may be used for i586 builds:<div class="informalexample"><pre class="programlisting">set TOOLCHAIN=&lt;toolchain&gt;
set VS=%TOOLCHAIN%/winsdk71/vs2010e
set WINSDK=%TOOLCHAIN%/winsdk71/sdk
set ALT_COMPILER_PATH=%VS%/VC/Bin
set ALT_WINDOWSSDKDIR=%WINSDK%
set ALT_MSVCRNN_DLL_PATH=%TOOLCHAIN%/msvcr/7_32
set ALT_DXSDK_PATH=%TOOLCHAIN%/directx
set WINDOWSSDKDIR=%WINSDK%
set VS100COMNTOOLS=%VS%/Common7/Tools
set Configuration=Release
set WindowsSDKVersionOverride=v7.1
set ToolsVersion=4.0
set TARGET_CPU=x86
set CURRENT_CPU=x86
set PlatformToolset=Windows7.1SDK
set TARGET_PLATFORM=XP
set LIB=%VS%/VC/Lib;%WINSDK%/Lib
set LIBPATH=%VS%/VC/Lib
set PATH=%VS%/Common7/IDE;%VS%/Common7/Tools;%VS%/VC/Bin;%VS%/VC/Bin/VCPackages;%WINSDK%/Bin;C:/WINDOWS/system32;C:/WINDOWS;C:/WINDOWS/System32/Wbem;%TOOLCHAIN%/msvcr/7_32
set INCLUDE=%VS%/VC/INCLUDE;%WINSDK%/INCLUDE;%WINSDK%/INCLUDE/gl;</pre></div></li><li class="listitem">Create <a id="id143" class="indexterm"/>an <code class="literal">env_64.bat</code> file with the following environment configuration that may be used for amd64 builds:<div class="informalexample"><pre class="programlisting">set TOOLCHAIN=...
set VS=%TOOLCHAIN%/winsdk71/vs2010e
set WINSDK=%TOOLCHAIN%/winsdk71/sdk
set ALT_COMPILER_PATH=%VS%/VC/Bin/x86_amd64
set ALT_WINDOWSSDKDIR=%WINSDK%
set ALT_MSVCRNN_DLL_PATH=%TOOLCHAIN%/msvcr/7_64
set ALT_DXSDK_PATH=%TOOLCHAIN%/directx
set WINDOWSSDKDIR=%WINSDK%
set VS100COMNTOOLS=%VS%/Common7/Tools
set Configuration=Release
set WindowsSDKVersionOverride=v7.1
set ToolsVersion=4.0
set TARGET_CPU=x64
set CURRENT_CPU=x64
set PlatformToolset=Windows7.1SDK
set TARGET_PLATFORM=XP
set LIB=%VS%/VC/Lib/amd64;%WINSDK%/Lib/x64
set LIBPATH=%VS%/VC/Lib/amd64
set PATH=%VS%/Common7/IDE;%VS%/Common7/Tools;%VS%/VC/Bin/x86_amd64;%VS%/VC/Bin;%VS%/VC/Bin/VCPackages;%WINSDK%/Bin;C:/WINDOWS/System32;C:/WINDOWS;C:/WINDOWS/System32/wbem;%LIBS_DIR%/msvcr/7_64;%TOOLCHAIN%/msvcr/7_32;%VS%/Common7/IDE
set INCLUDE=%VS%/VC/INCLUDE;%WINSDK%/INCLUDE;%WINSDK%/INCLUDE/gl;</pre></div></li><li class="listitem">Add the <code class="literal">toolchain</code> directory to the source control repository. This file set is a standalone toolchain and may be used to build both the i586 and amd64 versions of OpenJDK 7 (and OpenJDK 8) on clean Windows images with corresponding architectures.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec104"/>How it works...</h2></div></div></div><p>The process in <a id="id144" class="indexterm"/>this recipe is quite straightforward: collect the installed files that are to be copied later on clean Windows images and prepare the environment for them.</p><p>One possible problem is that, while the Microsoft linker tool <code class="literal">link.exe</code> from the Windows SDK 7.1 does not require .NET 4 runtime to link native binaries, it requires the .NET shared library, <code class="literal">msvcr100_clr0400.dll</code> (see step 7 of this recipe). This library must be found in <code class="literal">PATH</code>, otherwise the build will fail at the HotSpot VM link stage with an unclear error.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec105"/>There's more...</h2></div></div></div><p>The OpenJDK configuration not specific to the Microsoft toolchain (Cygwin, FreeType, and so on) was removed from the environment files in this recipe for brevity. It should be added back to the environment files to perform the OpenJDK builds.</p><p>The result standalone toolchain is not specific to OpenJDK and may be used to build other software on Windows.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec106"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building 32-bit OpenJDK 7 on Windows 7 SP1</em></span> recipe and the <span class="emphasis"><em>Building 64-bit FreeType libraries for OpenJDK 7 on Windows</em></span> recipe from this chapter. They can be adjusted to use the standalone toolchain from this recipe</li><li class="listitem" style="list-style-type: disc">A question from <a class="ulink" href="http://stackoverflow.com/">http://stackoverflow.com/</a> about the linker dependencies on .NET4 runtime at <a class="ulink" href="http://stackoverflow.com/questions/13571628/compiling-c-code-using-windows-sdk-7-1-without-net-framework-4-0">http://stackoverflow.com/questions/13571628/compiling-c-code-using-windows-sdk-7-1-without-net-framework-4-0</a></li></ul></div></div></div></body></html>