<html><head></head><body>
<div id="_idContainer048">
<h1 class="chapter-number" id="_idParaDest-251"><a id="_idTextAnchor250"/><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-252"><a id="_idTextAnchor251"/><span class="koboSpan" id="kobo.2.1">gRPC API Development and Testing</span></h1>
<p><span class="koboSpan" id="kobo.3.1">You will learn how to implement gRPC-based APIs in this chapter. </span><span class="koboSpan" id="kobo.3.2">You will learn how to write the gRPC server and client along with writing APIs based on gRPC. </span><span class="koboSpan" id="kobo.3.3">In the later part of this chapter, you will be introduced to microservices and see how they can help you to design modern, </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">scalable architecture.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">You will also go through the implementation of two services – the gRPC server and the gRPC client. </span><span class="koboSpan" id="kobo.5.2">gRPC-based APIs are more popular and preferred over REST APIs for service-to-service communication in a microservice-based system. </span><span class="koboSpan" id="kobo.5.3">Hence, gRPC development skills are important in the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">API space.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">After completing this chapter, you will be well versed in the gRPC server and client development, gRPC-based API testing automation, and </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">microservice concepts.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">You will explore the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Writing </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">an API</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Developing the </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">gRPC server</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.15.1">Handling errors</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Developing the </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">gRPC client</span></span></li>
<li><span class="koboSpan" id="kobo.18.1">Learning </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">microservice concepts</span></span></li>
</ul>
<h1 id="_idParaDest-253"><a id="_idTextAnchor252"/><span class="koboSpan" id="kobo.20.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.21.1">This chapter contains a great deal of theory on gRPC. </span><span class="koboSpan" id="kobo.21.2">However, you will also undertake the development and testing of gRPC-based web services, for which you will need </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.23.1">Any Java IDE, such as NetBeans, IntelliJ, </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">or Eclipse</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.25.1">Java Development Kit</span></strong><span class="koboSpan" id="kobo.26.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.27.1">JDK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">) 17</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">An internet connection to clone the code and download the dependencies </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">and Gradle</span></span></li>
<li><span class="koboSpan" id="kobo.31.1">Postman/cURL (for </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">API testing)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.33.1">Please visit the following link to check the </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">code: </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11"><span class="No-Break"><span class="koboSpan" id="kobo.35.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11</span></span></a></p>
<p><span class="koboSpan" id="kobo.36.1">So, </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">let’s begin!</span></span></p>
<h1 id="_idParaDest-254"><a id="_idTextAnchor253"/><span class="koboSpan" id="kobo.38.1">Writing an API</span></h1>
<p><span class="koboSpan" id="kobo.39.1">In this section, we will write the API using </span><strong class="bold"><span class="koboSpan" id="kobo.40.1">Protocol Buffer</span></strong><span class="koboSpan" id="kobo.41.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.42.1">Protobuf</span></strong><span class="koboSpan" id="kobo.43.1">) for a payment service. </span><span class="koboSpan" id="kobo.43.2">If you recall, this </span><a id="_idIndexMarker953"/><span class="koboSpan" id="kobo.44.1">is the piece that you haven’t yet implemented in the sample </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">e-commerce app.</span></span></p>
<p><span class="koboSpan" id="kobo.46.1">Before writing the API, let’s set up the </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">Gradle project.</span></span></p>
<h2 id="_idParaDest-255"><a id="_idTextAnchor254"/><span class="koboSpan" id="kobo.48.1">Setting up the project</span></h2>
<p><span class="koboSpan" id="kobo.49.1">The code for this chapter will </span><a id="_idIndexMarker954"/><span class="koboSpan" id="kobo.50.1">contain three projects under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.51.1">Chapter11</span></strong><span class="koboSpan" id="kobo.52.1"> directory – the API, server, </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">and client:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.54.1">API</span></strong><span class="koboSpan" id="kobo.55.1">: This is a library project that contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">.proto</span></strong><span class="koboSpan" id="kobo.57.1"> file and its generated Java classes packaged in a JAR file. </span><span class="koboSpan" id="kobo.57.2">This project will generate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">payment-gateway-api-0.0.1.jar</span></strong><span class="koboSpan" id="kobo.59.1"> library artifact, which you will publish in a local repository. </span><span class="koboSpan" id="kobo.59.2">This library will then be used in both the server and </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">client projects.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.61.1">Server</span></strong><span class="koboSpan" id="kobo.62.1">: This project represents the gRPC server, which will implement the gRPC services and serve the </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">gRPC requests.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.64.1">Client</span></strong><span class="koboSpan" id="kobo.65.1">: This project contains the gRPC client, which will call the gRPC server. </span><span class="koboSpan" id="kobo.65.2">To kick off the inter-service communication between the gRPC server and client applications, you are going to implement a REST call, which will call the gRPC server internally to serve the </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">HTTP request.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.67.1">Let’s first create the server and </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">client projects.</span></span></p>
<h3><span class="koboSpan" id="kobo.69.1">Creating the gRPC server and client projects</span></h3>
<p><span class="koboSpan" id="kobo.70.1">Either you can clone the </span><a href="B19349_11.xhtml#_idTextAnchor250"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.71.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.72.1"> code from the Git repository (</span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11"><span class="koboSpan" id="kobo.73.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11</span></a><span class="koboSpan" id="kobo.74.1">) or you can start by creating the new Spring project from</span><a id="_idIndexMarker955"/><span class="koboSpan" id="kobo.75.1"> scratch using </span><strong class="bold"><span class="koboSpan" id="kobo.76.1">Spring Initializr</span></strong><span class="koboSpan" id="kobo.77.1"> (</span><a href="https://start.spring.io/"><span class="koboSpan" id="kobo.78.1">https://start.spring.io/</span></a><span class="koboSpan" id="kobo.79.1">) for the </span><a id="_idIndexMarker956"/><span class="koboSpan" id="kobo.80.1">server and client with the following options (later, you will create a gRPC </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">api</span></strong><span class="koboSpan" id="kobo.82.1"> library </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">project separately):</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.84.1">Project</span></strong><span class="koboSpan" id="kobo.85.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">Gradle - </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.87.1">Groovy</span></strong></span></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.88.1">Language</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">Java</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.91.1">Spring Boot</span></strong><span class="koboSpan" id="kobo.92.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">3.0.8</span></strong><span class="koboSpan" id="kobo.94.1">. </span></li>
</ul>
<p><span class="koboSpan" id="kobo.95.1">The preferred version is </span><em class="italic"><span class="koboSpan" id="kobo.96.1">3.0+</span></em><span class="koboSpan" id="kobo.97.1">. </span><span class="koboSpan" id="kobo.97.2">Please choose the version that is available. </span><span class="koboSpan" id="kobo.97.3">You can modify it manually in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">build.gradle</span></strong><span class="koboSpan" id="kobo.99.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">later too.</span></span></p>
<ul>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.101.1">Project metadata</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">:</span></span><ul><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.103.1">Group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.105.1">com.packt.modern.api</span></strong></span></li><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.106.1">Artifact</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">chapter11</span></strong></span></li><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.109.1">Name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">Chapter11</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.112.1">Description</span></strong><span class="koboSpan" id="kobo.113.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">Chapter 11 code of book Modern API Development with Spring and Spring Boot </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.115.1">Ed 2</span></strong></span></li></ul></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.116.1">Package </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.117.1">name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">com.packt.modern.api</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">.</span></span></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.121.1">Packaging</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">Jar</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.125.1">Java</span></strong><span class="koboSpan" id="kobo.126.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">17</span></strong><span class="koboSpan" id="kobo.128.1">. </span></li>
</ul>
<p><span class="koboSpan" id="kobo.129.1">You can opt for any new version, such as </span><em class="italic"><span class="koboSpan" id="kobo.130.1">20</span></em><span class="koboSpan" id="kobo.131.1">. </span><span class="koboSpan" id="kobo.131.2">It can be modified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">build.gradle</span></strong><span class="koboSpan" id="kobo.133.1"> file later too, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.135.1">
sourceCompatibility = JavaVersion.VERSION_20</span></pre> <ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.136.1">ADD DEPENDENCIES</span></strong><span class="koboSpan" id="kobo.137.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">Spring Web</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.140.1">Then, you can click on </span><strong class="bold"><span class="koboSpan" id="kobo.141.1">GENERATE</span></strong><span class="koboSpan" id="kobo.142.1"> and download </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">the project.</span></span></p>
<p><span class="koboSpan" id="kobo.144.1">The downloaded project can be used to create both the server and the client. </span><span class="koboSpan" id="kobo.144.2">Then, create separate </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">server</span></strong><span class="koboSpan" id="kobo.146.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">client</span></strong><span class="koboSpan" id="kobo.148.1"> directories under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">Chapter11</span></strong><span class="koboSpan" id="kobo.150.1"> directory. </span><span class="koboSpan" id="kobo.150.2">After creating </span><a id="_idIndexMarker957"/><span class="koboSpan" id="kobo.151.1">the directories, copy the extracted content </span><a id="_idIndexMarker958"/><span class="koboSpan" id="kobo.152.1">from the downloaded zipped project </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">into them.</span></span></p>
<p><span class="koboSpan" id="kobo.154.1">You can configure the server and client projects later. </span><span class="koboSpan" id="kobo.154.2">Let’s first create the gRPC API library project as this library is going to be used in both the server and </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">client projects.</span></span></p>
<h3><span class="koboSpan" id="kobo.156.1">Creating the gRPC API library project</span></h3>
<p><span class="koboSpan" id="kobo.157.1">Create a new directory, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">api</span></strong><span class="koboSpan" id="kobo.159.1">, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">Chapter11</span></strong><span class="koboSpan" id="kobo.161.1"> directory. </span><span class="koboSpan" id="kobo.161.2">Then, use Gradle to create a new Gradle project </span><a id="_idIndexMarker959"/><span class="koboSpan" id="kobo.162.1">using the following command executed from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">Chapter11</span></strong><span class="koboSpan" id="kobo.164.1"> directory. </span><span class="koboSpan" id="kobo.164.2">It will ask for a few options. </span><span class="koboSpan" id="kobo.164.3">The following block is executed after setting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">JAVA_HOME</span></strong><span class="koboSpan" id="kobo.166.1"> environment variable to Java 17 and adding Java 17 to the path. </span><span class="koboSpan" id="kobo.166.2">You may find the order of questions a bit different in some systems. </span><span class="koboSpan" id="kobo.166.3">You should select the options highlighted in the following terminal </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">interface output:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.168.1">
$ mkdir api$ cd api
(you can also use gradlew from other chapter's code)
$ ../server/gradlew init
Select type of project to generate:
  1: basic
  2: application
  3: library
  4: Gradle plugin
Enter selection (default: basic) [1..4] 3
Select implementation language:
  1: C++
  2: Groovy
  3: Java
  4: Kotlin
  5: Scala
  6: Swift
Enter selection (default: Java) [1..6] 3
Select build script DSL:
  1: Groovy
  2: Kotlin
Enter selection (default: Groovy) [1..2] 1
Generate build using new APIs and behavior (some features may change in the next minor release)? </span><span class="koboSpan" id="kobo.168.2">(default: no) [yes, no] no
Select test framework:
  1: JUnit 4
  2: TestNG
  3: Spock
  4: JUnit Jupiter
Enter selection (default: JUnit Jupiter) [1..4] 4
Project name (default: api): api
Source package (default: api): com.packt.modern.api
&gt; Task :init
BUILD SUCCESSFUL in 1m 41s
2 actionable tasks: 2 executed</span></pre>
<p><span class="koboSpan" id="kobo.169.1">The project is </span><a id="_idIndexMarker960"/><span class="koboSpan" id="kobo.170.1">bootstrapped by Gradle. </span><span class="koboSpan" id="kobo.170.2">Next, you will configure the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">api</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.172.1"> project.</span></span></p>
<h3><span class="koboSpan" id="kobo.173.1">Configuring the gRPC API library project</span></h3>
<p><span class="koboSpan" id="kobo.174.1">Here, you will configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">plugins</span></strong><span class="koboSpan" id="kobo.176.1"> section in </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">api/libs/build.gradle</span></strong><span class="koboSpan" id="kobo.178.1"> with the Protobuf and </span><a id="_idIndexMarker961"/><span class="koboSpan" id="kobo.179.1">Maven Publish plugins. </span><span class="koboSpan" id="kobo.179.2">These plugins and setting their configuration are key steps. </span><span class="koboSpan" id="kobo.179.3">Let’s do this </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.181.1">Modify </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">api/settings.gradle</span></strong><span class="koboSpan" id="kobo.183.1"> in the project’s </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">root directory:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.185.1">
rootProject.name = '</span><strong class="bold"><span class="koboSpan" id="kobo.186.1">payment-gateway-api</span></strong><span class="koboSpan" id="kobo.187.1">'</span></pre></li> <li><span class="koboSpan" id="kobo.188.1">Next, modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">api/lib/build.gradle</span></strong><span class="koboSpan" id="kobo.190.1"> file. </span><span class="koboSpan" id="kobo.190.2">Add the Protobuf and Maven Publish Gradle plugins. </span><span class="koboSpan" id="kobo.190.3">Also, replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">java-library</span></strong><span class="koboSpan" id="kobo.192.1"> plugin with </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">java</span></strong><span class="koboSpan" id="kobo.194.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">shown next:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.196.1">
plugins {    id 'java'    id 'maven-publish'    id "com.google.protobuf" version "0.9.2"}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.197.1">The Maven Publish plugin will be used to publish the generated </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">Jar</span></strong><span class="koboSpan" id="kobo.199.1"> artifact to the local </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">Maven repository.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.201.1">Add the group name, version, and source compatibility in </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">api/libs/build.gradle</span></strong><span class="koboSpan" id="kobo.203.1">, as shown in the following code block. </span><span class="koboSpan" id="kobo.203.2">The group and version will be used by the Maven Publish plugin to name the </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">published artifact:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.205.1">
group = 'com.packt.modern.api'version = '0.0.1'sourceCompatibility = JavaVersion.VERSION_17</span></pre></li> <li><span class="koboSpan" id="kobo.206.1">Next, add the following dependencies, which are required for Protobuf and gRPC (check the highlighted part). </span><span class="koboSpan" id="kobo.206.2">You can remove the existing dependencies added while generating the project using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">gradlew init</span></strong><span class="koboSpan" id="kobo.208.1"> command and keep the dependencies </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">mentioned next:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.210.1">
def grpcVersion = '1.54.0'dependencies { implementation "</span><strong class="bold"><span class="koboSpan" id="kobo.211.1">io.grpc:grpc-protobuf</span></strong><span class="koboSpan" id="kobo.212.1">:${grpcVersion}" implementation "</span><strong class="bold"><span class="koboSpan" id="kobo.213.1">io.grpc:grpc-stub</span></strong><span class="koboSpan" id="kobo.214.1">:${grpcVersion}" implementation "</span><strong class="bold"><span class="koboSpan" id="kobo.215.1">io.grpc:grpc-netty</span></strong><span class="koboSpan" id="kobo.216.1">:${grpcVersion}" implementation '</span><strong class="bold"><span class="koboSpan" id="kobo.217.1">javax.annotation</span></strong><span class="koboSpan" id="kobo.218.1">:</span><strong class="bold"><span class="koboSpan" id="kobo.219.1">javax.annotation</span></strong><span class="koboSpan" id="kobo.220.1">-    </span><strong class="bold"><span class="koboSpan" id="kobo.221.1">api</span></strong><span class="koboSpan" id="kobo.222.1">:1.3.2' testImplementation 'org.junit.jupiter:junit-jupiter-    api:5.9.2' testRuntimeOnly 'org.junit.jupiter:junit-   jupiter-engine'}</span></pre></li> <li><span class="koboSpan" id="kobo.223.1">Next, let’s configure the Protobuf Gradle plugin using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">protoc</span></strong><span class="koboSpan" id="kobo.225.1"> command-line compiler. </span><span class="koboSpan" id="kobo.225.2">The </span><a id="_idIndexMarker962"/><span class="koboSpan" id="kobo.226.1">plugin searches for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">protoc</span></strong><span class="koboSpan" id="kobo.228.1"> executable in the system path by default. </span><span class="koboSpan" id="kobo.228.2">However, you can add a Protobuf compiler artifact to the plugin, which will make the build file self-sufficient as far as the gRPC compile task is concerned. </span><span class="koboSpan" id="kobo.228.3">Let’s configure it as shown in the following code block by adding a </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">protobuf</span></strong><span class="koboSpan" id="kobo.230.1"> section to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">api/libs/build.gradle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.232.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.233.1">
protobuf {  protoc {    artifact = "</span><strong class="bold"><span class="koboSpan" id="kobo.234.1">com.google.protobuf:protoc</span></strong><span class="koboSpan" id="kobo.235.1">:3.22.2"  }  plugins {    grpc {      artifact = "</span><strong class="bold"><span class="koboSpan" id="kobo.236.1">io.grpc:protoc-gen-grpc-java</span></strong><span class="koboSpan" id="kobo.237.1">:1.54.0"    }  }  generateProtoTasks {    all()*.plugins {      grpc { }    }  }}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.238.1">In the preceding code, you have configured the artifact used by the Protobuf compiler (</span><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">protoc</span></strong><span class="koboSpan" id="kobo.240.1">) and its Java plugin (</span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">protoc-gen-grpc-java</span></strong><span class="koboSpan" id="kobo.242.1">), which will generate the Java code based on </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.244.1">proto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.245.1"> files.</span></span></p>
<p><span class="koboSpan" id="kobo.246.1">When you run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">gradlew</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.248.1">build</span></strong><span class="koboSpan" id="kobo.249.1"> command for the first time, Gradle will download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">protoc</span></strong><span class="koboSpan" id="kobo.251.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">protoc-gen-grpc-java</span></strong><span class="koboSpan" id="kobo.253.1"> executables based on </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">the OS.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.255.1">The Protobuf Gradle plugin works with the configuration shared hitherto in this subsection. </span><span class="koboSpan" id="kobo.255.2">It </span><a id="_idIndexMarker963"/><span class="koboSpan" id="kobo.256.1">works when you run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">build</span></strong><span class="koboSpan" id="kobo.258.1"> command from the command line. </span><span class="koboSpan" id="kobo.258.2">However, the IDE may give a compilation error if you don’t add the following block to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">api/libs/build.gradle</span></strong><span class="koboSpan" id="kobo.260.1"> file to add the generated source files </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">sourceSets</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.264.1">
sourceSets {  main {    proto {      // In addition to the default "src/main/proto"      srcDir "src/main/grpc"    }  }}task sourcesJar(type: Jar, dependsOn: classes) {    archiveClassifier = "sources"    from sourceSets.main.allSource}</span></pre></li> <li><span class="koboSpan" id="kobo.265.1">Finally, you will add the following block to configure the Maven </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">Publish plugin:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.267.1">
publishing {  publications {    mavenJava(MavenPublication) {      artifactId = 'payment-gateway-api'      from components.java    }  }}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.268.1">Here, you have </span><a id="_idIndexMarker964"/><span class="koboSpan" id="kobo.269.1">configured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">api</span></strong><span class="koboSpan" id="kobo.271.1"> project. </span><span class="koboSpan" id="kobo.271.2">You </span><a id="_idIndexMarker965"/><span class="koboSpan" id="kobo.272.1">can find more information about the Protobuf Gradle plugin </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">at </span></span><a href="https://github.com/google/protobuf-gradle-plugin"><span class="No-Break"><span class="koboSpan" id="kobo.274.1">https://github.com/google/protobuf-gradle-plugin</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.275.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.276.1">Now that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">api</span></strong><span class="koboSpan" id="kobo.278.1"> project setup is done, we are ready to write the service definitions using Protobuf in the next subsection. </span><span class="koboSpan" id="kobo.278.2">You haven’t yet implemented the payment functionality for our sample e-commerce app. </span><span class="koboSpan" id="kobo.278.3">This is because it needs to be integrated with a payment gateway service such as Stripe or PayPal. </span><span class="koboSpan" id="kobo.278.4">Therefore, you are going to write the sample payment gateway service definition using gRPC in the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">next section.</span></span></p>
<h2 id="_idParaDest-256"><a id="_idTextAnchor255"/><span class="koboSpan" id="kobo.280.1">Writing the payment gateway functionalities</span></h2>
<p><span class="koboSpan" id="kobo.281.1">Before you write the </span><a id="_idIndexMarker966"/><span class="koboSpan" id="kobo.282.1">payment gateway service definition, let’s first understand the basic functionality of the payment gateway system in </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">easy terms.</span></span></p>
<p><span class="koboSpan" id="kobo.284.1">The payment gateway provides a way to capture and transfer a payment from a customer to online sellers and then returns Accepted/Declined as a response to the customer. </span><span class="koboSpan" id="kobo.284.2">It performs various other actions here, such as verification, security, encryption, and communication with </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">all participants.</span></span></p>
<p><span class="koboSpan" id="kobo.286.1">The following are the actors who participate in </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">this transaction:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.288.1">Payment gateway</span></strong><span class="koboSpan" id="kobo.289.1">: A web interface that allows the processing of online payments and coordinates </span><a id="_idIndexMarker967"/><span class="koboSpan" id="kobo.290.1">with all other actors. </span><span class="koboSpan" id="kobo.290.2">This is very similar to physical </span><strong class="bold"><span class="koboSpan" id="kobo.291.1">point-of-sale</span></strong><span class="koboSpan" id="kobo.292.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.293.1">POS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">) terminals.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.295.1">Merchant</span></strong><span class="koboSpan" id="kobo.296.1">: Merchants are online sellers or service providers, such as Amazon, Uber, </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">and Airbnb.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.298.1">Customer</span></strong><span class="koboSpan" id="kobo.299.1">: This is you, the customer, who performs the buy/pay transaction for products or services and uses credit/debit cards, digital wallets, or </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">online banking.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.301.1">Issuing bank</span></strong><span class="koboSpan" id="kobo.302.1">: The party that provides the functionality to perform online money transfers, such as Visa, Mastercard, AmEx, PayPal, Stripe, or </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">traditional banks.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.304.1">Acquirer or acquiring bank</span></strong><span class="koboSpan" id="kobo.305.1">: The institution that holds the merchant account. </span><span class="koboSpan" id="kobo.305.2">It passes the transaction to the issuing bank to </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">receive payment.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.307.1">You are going to create two gRPC services – </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">ChargeService</span></strong><span class="koboSpan" id="kobo.309.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">SourceService</span></strong><span class="koboSpan" id="kobo.311.1"> – as part of the payment gateway service. </span><span class="koboSpan" id="kobo.311.2">Don’t get confused with the web service, which is an executable/deployable artifact. </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">ChargeService</span></strong><span class="koboSpan" id="kobo.313.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">SourceService</span></strong><span class="koboSpan" id="kobo.315.1"> are part of the service </span><a id="_idIndexMarker968"/><span class="koboSpan" id="kobo.316.1">component of Protobuf’s </span><strong class="bold"><span class="koboSpan" id="kobo.317.1">interface definition language</span></strong><span class="koboSpan" id="kobo.318.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.319.1">IDL</span></strong><span class="koboSpan" id="kobo.320.1">) file, the same as we learned about in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">EmployeeService</span></strong><span class="koboSpan" id="kobo.322.1"> example in the last chapter (the </span><em class="italic"><span class="koboSpan" id="kobo.323.1">How gRPC uses Protobuf</span></em><span class="koboSpan" id="kobo.324.1"> section of </span><a href="B19349_10.xhtml#_idTextAnchor233"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.325.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.326.1">, </span><em class="italic"><span class="koboSpan" id="kobo.327.1">Getting Started with gRPC</span></em><span class="koboSpan" id="kobo.328.1">). </span><span class="koboSpan" id="kobo.328.2">Both services are inspired by Stripe public </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">REST APIs.</span></span></p>
<p><span class="koboSpan" id="kobo.330.1">Let’s understand the </span><a id="_idIndexMarker969"/><span class="koboSpan" id="kobo.331.1">transaction flow before we jump into creating the service components of a gRPC-based payment </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">gateway service.</span></span></p>
<h3><span class="koboSpan" id="kobo.333.1">Online payment workflow steps</span></h3>
<p><span class="koboSpan" id="kobo.334.1">The following steps </span><a id="_idIndexMarker970"/><span class="koboSpan" id="kobo.335.1">are performed when an online transaction </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">takes place:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.337.1">First, the customer should have a payment source (read method) created before initiating the payment. </span><span class="koboSpan" id="kobo.337.2">If not, then the customer creates a source, such as their </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">card details.</span></span></li>
<li><span class="koboSpan" id="kobo.339.1">Payment is initiated by creating a charge against the payment source (</span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">read method).</span></span></li>
<li><span class="koboSpan" id="kobo.341.1">The payment gateway performs all the necessary validation and verification steps and then allows the charge to be captured. </span><span class="koboSpan" id="kobo.341.2">These steps trigger the fund transfer from the issuing bank to the </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">merchant account.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.343.1">You can observe that there are two objects (resources) involved in this workflow (aka source and charge). </span><span class="koboSpan" id="kobo.343.2">Therefore, you are going to write two services that function around these two objects. </span><span class="koboSpan" id="kobo.343.3">There are various other functionalities performed by the payment gateway, such as disputes, refunds, and payouts. </span><span class="koboSpan" id="kobo.343.4">However, you are going to implement only two services, charge and source, in </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">this chapter.</span></span></p>
<h3><span class="koboSpan" id="kobo.345.1">Writing the payment gateway service definitions</span></h3>
<p><span class="koboSpan" id="kobo.346.1">Writing a Protobuf-based IDL is very similar to the way you defined the OpenAPI Specification for </span><a id="_idIndexMarker971"/><span class="koboSpan" id="kobo.347.1">REST APIs. </span><span class="koboSpan" id="kobo.347.2">In REST, you define the models and API endpoints, whereas in gRPC, you define the messages and RPC procedures wrapped in the service. </span><span class="koboSpan" id="kobo.347.3">Let’s write our payment gateway service IDL using the </span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.349.1">First, let’s create a new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">PaymentGatewayService.proto</span></strong><span class="koboSpan" id="kobo.351.1">, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">api/lib/src/main/proto</span></strong><span class="koboSpan" id="kobo.353.1"> directory under the root directory of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">api</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.355.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.356.1">After creating a new file, you can add the metadata, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">code block:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.358.1">syntax</span></strong><span class="koboSpan" id="kobo.359.1"> = "proto3";                                   //1</span><strong class="bold"><span class="koboSpan" id="kobo.360.1">package</span></strong><span class="koboSpan" id="kobo.361.1"> com.packtpub.v1;                             //2</span><strong class="bold"><span class="koboSpan" id="kobo.362.1">option</span></strong><span class="koboSpan" id="kobo.363.1"> java_</span><strong class="bold"><span class="koboSpan" id="kobo.364.1">package</span></strong><span class="koboSpan" id="kobo.365.1"> = "com.packt.modern.api.grpc.v1";//3</span><strong class="bold"><span class="koboSpan" id="kobo.366.1">option</span></strong><span class="koboSpan" id="kobo.367.1"> java_</span><strong class="bold"><span class="koboSpan" id="kobo.368.1">multiple</span></strong><span class="koboSpan" id="kobo.369.1">_files = true;                   //4</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.370.1">Let’s understand the preceding code </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">in detail:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.372.1">Line </span><em class="italic"><span class="koboSpan" id="kobo.373.1">1</span></em><span class="koboSpan" id="kobo.374.1"> tells the compiler to use version 3 of Protobuf by using the syntax specifier. </span><span class="koboSpan" id="kobo.374.2">If you don’t specify this, then the compiler will use version 2 </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">of Protobuf.</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.376.1">Line 2</span></em><span class="koboSpan" id="kobo.377.1"> uses the optional package specifier to attach the namespace to message types. </span><span class="koboSpan" id="kobo.377.2">This </span><a id="_idIndexMarker972"/><span class="koboSpan" id="kobo.378.1">prevents name clashes among message types. </span><span class="koboSpan" id="kobo.378.2">We must postfix it with a package version that allows us to create new versions of APIs with </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">backward compatibility.</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.380.1">Line 3</span></em><span class="koboSpan" id="kobo.381.1"> uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">java_package</span></strong><span class="koboSpan" id="kobo.383.1"> option specifier. </span><span class="koboSpan" id="kobo.383.2">This specifies the Java package to be used in the generated Java files. </span><span class="koboSpan" id="kobo.383.3">If you don’t use this option specifier and declare the </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">package</span></strong><span class="koboSpan" id="kobo.385.1"> specifier, then the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">package</span></strong><span class="koboSpan" id="kobo.387.1"> will be used as a Java package in the generated Java </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">files instead.</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.389.1">Line 4</span></em><span class="koboSpan" id="kobo.390.1"> declares the </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">java_multiple_files</span></strong><span class="koboSpan" id="kobo.392.1"> option specifier, which is a Boolean option. </span><span class="koboSpan" id="kobo.392.2">It is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">false</span></strong><span class="koboSpan" id="kobo.394.1"> by default. </span><span class="koboSpan" id="kobo.394.2">If it is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">true</span></strong><span class="koboSpan" id="kobo.396.1">, then it generates separate Java files for each top-level message type, enumeration (</span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">enum</span></strong><span class="koboSpan" id="kobo.398.1">), </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">and service.</span></span></li>
</ul>
<ol>
<li value="3"><span class="koboSpan" id="kobo.400.1">Next, let’s add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">ChargeService</span></strong><span class="koboSpan" id="kobo.402.1"> service, which contains the operations required for charge functionality denoted by </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">rpc</span></strong><span class="koboSpan" id="kobo.404.1"> (as shown in the following code block). </span><span class="koboSpan" id="kobo.404.2">Charge objects get created for charging the card, bank account, or digital wallet. </span><span class="koboSpan" id="kobo.404.3">Let’s add the charge service to the Protobuf (</span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">proto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">) file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.408.1">service</span></strong><span class="koboSpan" id="kobo.409.1"> ChargeService { rpc </span><strong class="bold"><span class="koboSpan" id="kobo.410.1">Create(CreateChargeReq)</span></strong><span class="koboSpan" id="kobo.411.1">     returns(</span><strong class="bold"><span class="koboSpan" id="kobo.412.1">CreateChargeReq.Response</span></strong><span class="koboSpan" id="kobo.413.1">); rpc </span><strong class="bold"><span class="koboSpan" id="kobo.414.1">Retrieve(ChargeId)</span></strong><span class="koboSpan" id="kobo.415.1">     returns (</span><strong class="bold"><span class="koboSpan" id="kobo.416.1">ChargeId.Response</span></strong><span class="koboSpan" id="kobo.417.1">); rpc </span><strong class="bold"><span class="koboSpan" id="kobo.418.1">Update(UpdateChargeReq)</span></strong><span class="koboSpan" id="kobo.419.1">     returns(</span><strong class="bold"><span class="koboSpan" id="kobo.420.1">UpdateChargeReq.Response</span></strong><span class="koboSpan" id="kobo.421.1">); rpc </span><strong class="bold"><span class="koboSpan" id="kobo.422.1">Capture(CaptureChargeReq)</span></strong><span class="koboSpan" id="kobo.423.1">     returns(</span><strong class="bold"><span class="koboSpan" id="kobo.424.1">CaptureChargeReq.Response</span></strong><span class="koboSpan" id="kobo.425.1">); rpc </span><strong class="bold"><span class="koboSpan" id="kobo.426.1">RetrieveAll(CustomerId)</span></strong><span class="koboSpan" id="kobo.427.1">     returns (</span><strong class="bold"><span class="koboSpan" id="kobo.428.1">CustomerId.Response</span></strong><span class="koboSpan" id="kobo.429.1">);}</span></pre></li> </ol>
<p><span class="No-Break"><span class="koboSpan" id="kobo.430.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/api/lib/src/main/proto/PaymentGatewayService.proto</span></span></p>
<p><span class="koboSpan" id="kobo.431.1">Each of these </span><a id="_idIndexMarker973"/><span class="koboSpan" id="kobo.432.1">procedures in </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">ChargeService</span></strong><span class="koboSpan" id="kobo.434.1"> will perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">following operations:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.436.1">Create</span></strong><span class="koboSpan" id="kobo.437.1">: This procedure creates a new </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">Charge</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.439.1"> object.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.440.1">Retrieve</span></strong><span class="koboSpan" id="kobo.441.1">: This procedure retrieves the </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">Charge</span></strong><span class="koboSpan" id="kobo.443.1"> object based on the given charge ID that was </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">previously created.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.445.1">Update</span></strong><span class="koboSpan" id="kobo.446.1">: This procedure updates the </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">Charge</span></strong><span class="koboSpan" id="kobo.448.1"> object identified by the given charge ID by setting the values of the parameters passed. </span><span class="koboSpan" id="kobo.448.2">Any parameters not provided will be </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">left unchanged.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.450.1">Capture</span></strong><span class="koboSpan" id="kobo.451.1">: This procedure captures the payment of an existing, uncaptured charge. </span><span class="koboSpan" id="kobo.451.2">This is the payment workflow step, where you first create a charge with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">capture</span></strong><span class="koboSpan" id="kobo.453.1"> option set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">false</span></strong><span class="koboSpan" id="kobo.455.1">. </span><span class="koboSpan" id="kobo.455.2">Uncaptured payments expire precisely seven </span><a id="_idIndexMarker974"/><span class="koboSpan" id="kobo.456.1">days after they are created. </span><span class="koboSpan" id="kobo.456.2">If they are not captured by that point in time, they will be marked as refunded and capture will no longer </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">be allowed.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.458.1">RetrieveAll</span></strong><span class="koboSpan" id="kobo.459.1">: This procedure returns the list of charges that belong to the given </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">customer ID.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.461.1">Empty request or response type</span></p>
<p class="callout"><span class="koboSpan" id="kobo.462.1">You can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">google.protobuf.Empty</span></strong><span class="koboSpan" id="kobo.464.1"> for void/empty request and response types. </span><span class="koboSpan" id="kobo.464.2">This can be used in </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">.proto</span></strong><span class="koboSpan" id="kobo.466.1"> files. </span><span class="koboSpan" id="kobo.466.2">You just must place the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">import</span></strong><span class="koboSpan" id="kobo.468.1"> statement before any message/service </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">is defined:</span></span></p>
<p class="callout"><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">import "google/protobuf/timestamp.proto";</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.472.1">Then, you can use it as </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">shown next:</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">rpc delete(SourceId) returns (</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">google.protobuf. </span><span class="koboSpan" id="kobo.475.2">Empty);</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.477.1">The amount is charged to a source, which could be a card, bank account, or digital wallet. </span><span class="koboSpan" id="kobo.477.2">A variety of payment methods can be used by the customer using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.478.1">Source</span></strong><span class="koboSpan" id="kobo.479.1"> object. </span><span class="koboSpan" id="kobo.479.2">Therefore, you need a service that will allow you to perform operations on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">source</span></strong><span class="koboSpan" id="kobo.481.1"> resource. </span><span class="koboSpan" id="kobo.481.2">Let’s add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">Source</span></strong><span class="koboSpan" id="kobo.483.1"> service and its operations to the Protobuf (</span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">proto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">) file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.487.1">
service SourceService {  rpc </span><strong class="bold"><span class="koboSpan" id="kobo.488.1">Create(CreateSourceReq)</span></strong><span class="koboSpan" id="kobo.489.1">      returns (</span><strong class="bold"><span class="koboSpan" id="kobo.490.1">CreateSourceReq.Response</span></strong><span class="koboSpan" id="kobo.491.1">);  rpc Retrieve(SourceId)      returns (SourceId.Response);  rpc </span><strong class="bold"><span class="koboSpan" id="kobo.492.1">Update(UpdateSourceReq)</span></strong><span class="koboSpan" id="kobo.493.1">      returns (</span><strong class="bold"><span class="koboSpan" id="kobo.494.1">UpdateSourceReq.Response</span></strong><span class="koboSpan" id="kobo.495.1">);  rpc </span><strong class="bold"><span class="koboSpan" id="kobo.496.1">Attach(AttachOrDetachReq)</span></strong><span class="koboSpan" id="kobo.497.1">      returns (</span><strong class="bold"><span class="koboSpan" id="kobo.498.1">AttachOrDetachReq.Response</span></strong><span class="koboSpan" id="kobo.499.1">);  rpc </span><strong class="bold"><span class="koboSpan" id="kobo.500.1">Detach(AttachOrDetachReq)</span></strong><span class="koboSpan" id="kobo.501.1">      returns (</span><strong class="bold"><span class="koboSpan" id="kobo.502.1">AttachOrDetachReq.Response</span></strong><span class="koboSpan" id="kobo.503.1">);}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.504.1">Each of these procedures in </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">SourceService</span></strong><span class="koboSpan" id="kobo.506.1"> will perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">following operations:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.508.1">Create</span></strong><span class="koboSpan" id="kobo.509.1">: This procedure creates a new </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">Source</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.511.1"> object.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.512.1">Retrieve</span></strong><span class="koboSpan" id="kobo.513.1">: This procedure allows you to retrieve the </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">Source</span></strong><span class="koboSpan" id="kobo.515.1"> object based on the given </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">source ID.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.517.1">Update</span></strong><span class="koboSpan" id="kobo.518.1">: This procedure </span><a id="_idIndexMarker975"/><span class="koboSpan" id="kobo.519.1">allows you to update certain fields of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">Source</span></strong><span class="koboSpan" id="kobo.521.1"> object passed using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">UpdateSourceReq</span></strong><span class="koboSpan" id="kobo.523.1"> object. </span><span class="koboSpan" id="kobo.523.2">Any field that is not part of </span><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">UpdateSourceReq</span></strong><span class="koboSpan" id="kobo.525.1"> will </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">remain unchanged.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.527.1">Attach</span></strong><span class="koboSpan" id="kobo.528.1">: This procedure attaches the </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">Source</span></strong><span class="koboSpan" id="kobo.530.1"> object to the customer. </span><span class="koboSpan" id="kobo.530.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">AttachOrDetachReq</span></strong><span class="koboSpan" id="kobo.532.1"> parameter contains the IDs of both the source and the customer. </span><span class="koboSpan" id="kobo.532.2">However, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">Source</span></strong><span class="koboSpan" id="kobo.534.1"> object should be in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">CHARGEABLE</span></strong><span class="koboSpan" id="kobo.536.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">PENDING</span></strong><span class="koboSpan" id="kobo.538.1"> state to perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">attached operation.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.540.1">Detach</span></strong><span class="koboSpan" id="kobo.541.1">: This procedure will detach the </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">Source</span></strong><span class="koboSpan" id="kobo.543.1"> object from the customer. </span><span class="koboSpan" id="kobo.543.2">It will also change the state of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">Source</span></strong><span class="koboSpan" id="kobo.545.1"> object to </span><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">consumed</span></strong><span class="koboSpan" id="kobo.547.1"> and it can no longer be used to create the charge. </span><span class="koboSpan" id="kobo.547.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.548.1">AttachOrDetachReq</span></strong><span class="koboSpan" id="kobo.549.1"> parameter contains the IDs of both the source and </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">the customer.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.551.1">The recommended approach for defining the request and response types</span></p>
<p class="callout"><span class="koboSpan" id="kobo.552.1">It is recommended to always use the wrapper request and response types. </span><span class="koboSpan" id="kobo.552.2">This allows you to add another field to the request or </span><span class="No-Break"><span class="koboSpan" id="kobo.553.1">response types.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.554.1">Now that the service definitions are done, you can define the given parameters and the returned </span><a id="_idIndexMarker976"/><span class="koboSpan" id="kobo.555.1">types of these procedures. </span><span class="koboSpan" id="kobo.555.2">Let’s first define the parameters and returned types of </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">ChargeService</span></strong><span class="koboSpan" id="kobo.557.1">. </span><span class="koboSpan" id="kobo.557.2">First, you will define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">Charge</span></strong><span class="koboSpan" id="kobo.559.1"> message type, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.561.1">
message Charge {  </span><strong class="bold"><span class="koboSpan" id="kobo.562.1">string</span></strong><span class="koboSpan" id="kobo.563.1"> id = 1;  uint32 amount = 2;  uint32 amountCaptured = 3;  </span><strong class="bold"><span class="koboSpan" id="kobo.564.1">uint32</span></strong><span class="koboSpan" id="kobo.565.1"> amountRefunded = 4;  string balanceTransactionId = 5;  </span><strong class="bold"><span class="koboSpan" id="kobo.566.1">BillingDetails</span></strong><span class="koboSpan" id="kobo.567.1"> billingDetails = 6;  string calculatedStatementDescriptor = 7;  </span><strong class="bold"><span class="koboSpan" id="kobo.568.1">bool</span></strong><span class="koboSpan" id="kobo.569.1"> captured = 8;  uint64 created = 9;  string currency = 10;  string customerId = 11;  string description = 12;  bool disputed = 13;  uint32 failureCode = 14;  string failureMessage = 15;  string invoiceId = 16;  string orderId = 17;  bool paid = 18;  string paymentMethodId = 19;  PaymentMethodDetails paymentMethodDetails = 20;  string receiptEmail = 21;  string receiptNumber = 22;  bool refunded = 23;  </span><strong class="bold"><span class="koboSpan" id="kobo.570.1">repeated</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.571.1">Refund</span></strong><span class="koboSpan" id="kobo.572.1"> refunds = 24;  string statementDescriptor = 25;  </span><strong class="bold"><span class="koboSpan" id="kobo.573.1">enum</span></strong><span class="koboSpan" id="kobo.574.1"> Status {    SUCCEEDED = 0;    PENDING = 1;    FAILED = 2;  }  </span><strong class="bold"><span class="koboSpan" id="kobo.575.1">Status</span></strong><span class="koboSpan" id="kobo.576.1"> status = 26;  string sourceId = 27;}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.577.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">Charge</span></strong><span class="koboSpan" id="kobo.579.1"> message contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">following fields:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">id</span></strong><span class="koboSpan" id="kobo.582.1">: The unique </span><a id="_idIndexMarker977"/><span class="koboSpan" id="kobo.583.1">identifier of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">Charge</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.585.1"> object.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">amount</span></strong><span class="koboSpan" id="kobo.587.1">: The amount is a positive number or zero, referring to the amount of </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">the payment.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">amountCaptured</span></strong><span class="koboSpan" id="kobo.590.1">: This is the captured amount (a positive number or zero). </span><span class="koboSpan" id="kobo.590.2">It can be less than the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">amount</span></strong><span class="koboSpan" id="kobo.592.1"> field if a partial capture </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">is made.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">amountRefunded</span></strong><span class="koboSpan" id="kobo.595.1">: The amount refunded (a positive number or zero). </span><span class="koboSpan" id="kobo.595.2">It can be less than the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">amount</span></strong><span class="koboSpan" id="kobo.597.1"> field if a partial refund </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">is issued.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">balanceTransactionId</span></strong><span class="koboSpan" id="kobo.600.1">: The ID of the balance transaction, which describes the impact of this charge on your account balance (not including refunds </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">or disputes).</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">billingDetails</span></strong><span class="koboSpan" id="kobo.603.1">: The object of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">BillingDetails</span></strong><span class="koboSpan" id="kobo.605.1"> message type, which contains billing information associated with the payment method at the time of </span><span class="No-Break"><span class="koboSpan" id="kobo.606.1">the transaction.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">calculatedStatementDescriptor</span></strong><span class="koboSpan" id="kobo.608.1">: The statement description that is passed to card networks and is displayed on your customers’ credit card and </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">bank statements.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.610.1">captured</span></strong><span class="koboSpan" id="kobo.611.1">: A Boolean field that represents whether a charge has since been </span><a id="_idIndexMarker978"/><span class="koboSpan" id="kobo.612.1">captured. </span><span class="koboSpan" id="kobo.612.2">(It is possible to create a charge without capturing the charge details. </span><span class="koboSpan" id="kobo.612.3">Therefore, this field is added, which determines whether a charge will be captured </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">or not.)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.614.1">created</span></strong><span class="koboSpan" id="kobo.615.1">: The timestamp (measured in seconds since the Unix epoch) at which the object </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">was created.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">currency</span></strong><span class="koboSpan" id="kobo.618.1">: The three-letter ISO </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">currency code.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">customerId</span></strong><span class="koboSpan" id="kobo.621.1">: The ID of the customer owning </span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">the charge.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">description</span></strong><span class="koboSpan" id="kobo.624.1">: A description of the charge displayed to </span><span class="No-Break"><span class="koboSpan" id="kobo.625.1">the user.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">disputed</span></strong><span class="koboSpan" id="kobo.627.1">: A Boolean field that represents whether the charge has </span><span class="No-Break"><span class="koboSpan" id="kobo.628.1">been disputed.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.629.1">failureCode</span></strong><span class="koboSpan" id="kobo.630.1">: The error code of </span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">the failure.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">failureMessage</span></strong><span class="koboSpan" id="kobo.633.1">: A description of the failure. </span><span class="koboSpan" id="kobo.633.2">The reason may be stated if this option </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1">is available.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">invoiceId</span></strong><span class="koboSpan" id="kobo.636.1">: The ID of the invoice this charge </span><span class="No-Break"><span class="koboSpan" id="kobo.637.1">is for.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">orderId</span></strong><span class="koboSpan" id="kobo.639.1">: The ID of the order this charge </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">is for.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">paid</span></strong><span class="koboSpan" id="kobo.642.1">: The Boolean value represents whether the charge succeeded or was successfully authorized for </span><span class="No-Break"><span class="koboSpan" id="kobo.643.1">subsequent capture.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">paymentMethodId</span></strong><span class="koboSpan" id="kobo.645.1">: The ID of the </span><span class="No-Break"><span class="koboSpan" id="kobo.646.1">payment method.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">paymentMethodDetails</span></strong><span class="koboSpan" id="kobo.648.1">: The object that contains the details of the </span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">payment method.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">receiptEmail</span></strong><span class="koboSpan" id="kobo.651.1">: The email where receipt of the charge will </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">be sent.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">receiptNumber</span></strong><span class="koboSpan" id="kobo.654.1">: This represents the transaction number in the charge receipt that </span><a id="_idIndexMarker979"/><span class="koboSpan" id="kobo.655.1">was sent by email. </span><span class="koboSpan" id="kobo.655.2">It should remain null until a charge receipt </span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">is sent.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.657.1">refunded</span></strong><span class="koboSpan" id="kobo.658.1">: A Boolean field that represents whether the charge </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1">was refunded.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.660.1">refunds</span></strong><span class="koboSpan" id="kobo.661.1">: This contains the list of refunds that have been issued. </span><span class="koboSpan" id="kobo.661.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1">repeated</span></strong><span class="koboSpan" id="kobo.663.1"> keyword is used to create a list of </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">Refund</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.665.1"> objects.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">statementDescriptor</span></strong><span class="koboSpan" id="kobo.667.1">: The description of a charge for </span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">a card.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">status</span></strong><span class="koboSpan" id="kobo.670.1">: An object of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.671.1">Status</span></strong><span class="koboSpan" id="kobo.672.1"> enumeration type (</span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">SUCCEEDED</span></strong><span class="koboSpan" id="kobo.674.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">PENDING</span></strong><span class="koboSpan" id="kobo.676.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">FAILED</span></strong><span class="koboSpan" id="kobo.678.1">) that represents the status of </span><span class="No-Break"><span class="koboSpan" id="kobo.679.1">the charge.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.680.1">sourceId</span></strong><span class="koboSpan" id="kobo.681.1">: ID of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.682.1">Source</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.683.1"> object.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.684.1">The UInt32 and string scalar types were discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.685.1">How gRPC uses Protobuf</span></em><span class="koboSpan" id="kobo.686.1"> subsection under the </span><em class="italic"><span class="koboSpan" id="kobo.687.1">How does gRPC work?</span></em><span class="koboSpan" id="kobo.688.1"> section in the previous chapter (</span><a href="B19349_10.xhtml#_idTextAnchor233"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.689.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.690.1">, </span><em class="italic"><span class="koboSpan" id="kobo.691.1">Getting Started with gRPC</span></em><span class="koboSpan" id="kobo.692.1">). </span><span class="koboSpan" id="kobo.692.2">You can refer to it for </span><span class="No-Break"><span class="koboSpan" id="kobo.693.1">further information.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.694.1">Predefined well-known types</span></p>
<p class="callout"><span class="koboSpan" id="kobo.695.1">Apart from scalar types, Protobuf also provides predefined types such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">Empty</span></strong><span class="koboSpan" id="kobo.697.1"> (which we saw earlier in </span><em class="italic"><span class="koboSpan" id="kobo.698.1">step 3</span></em><span class="koboSpan" id="kobo.699.1">), </span><strong class="source-inline"><span class="koboSpan" id="kobo.700.1">Timestamp</span></strong><span class="koboSpan" id="kobo.701.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.702.1">Duration</span></strong><span class="koboSpan" id="kobo.703.1">. </span><span class="koboSpan" id="kobo.703.2">You can find the complete list </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">at </span></span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">https://developers.google.com/protocol-buffers/docs/reference/google.protobuf</span></span><span class="No-Break"><span class="koboSpan" id="kobo.706.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.707.1">Now, you can define the remaining message types of the other parameters (</span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">CreateChargeReq</span></strong><span class="koboSpan" id="kobo.709.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.710.1">ChargeId</span></strong><span class="koboSpan" id="kobo.711.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.712.1">UpdateChargeReq</span></strong><span class="koboSpan" id="kobo.713.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">CaptureChargeReq</span></strong><span class="koboSpan" id="kobo.715.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">CustomerId</span></strong><span class="koboSpan" id="kobo.717.1">) and return the </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">ChargeList</span></strong><span class="koboSpan" id="kobo.719.1"> type of </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">ChargeService</span></strong><span class="koboSpan" id="kobo.721.1">, as </span><a id="_idIndexMarker980"/><span class="koboSpan" id="kobo.722.1">shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.723.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.724.1">
message </span><strong class="bold"><span class="koboSpan" id="kobo.725.1">CreateChargeReq</span></strong><span class="koboSpan" id="kobo.726.1"> {  uint32 amount = 1;  string currency = 2;  string customerId = 3;  string description = 4;  string receiptEmail = 5;  Source source Id = 6;  string statementDescriptor = 7;  message Response { Charge charge = 1; }}message </span><strong class="bold"><span class="koboSpan" id="kobo.727.1">UpdateChargeReq</span></strong><span class="koboSpan" id="kobo.728.1"> {  string chargeId = 1;  string customerId = 2;  string description = 3;  string receiptEmail = 4;  message Response { Charge charge = 1; }}message </span><strong class="bold"><span class="koboSpan" id="kobo.729.1">CaptureChargeReq</span></strong><span class="koboSpan" id="kobo.730.1"> {  string chargeId = 1;  uint32 amount = 2;  string receiptEmail = 3;  string statementDescriptor = 4;  message Response { Charge charge = 1; }}message </span><strong class="bold"><span class="koboSpan" id="kobo.731.1">ChargeId</span></strong><span class="koboSpan" id="kobo.732.1"> {  string id = 1;  message Response { Charge charge = 1; }}message </span><strong class="bold"><span class="koboSpan" id="kobo.733.1">CustomerId</span></strong><span class="koboSpan" id="kobo.734.1"> {  string id = 1;  message Response { repeated Charge charge = 1; }}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.735.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">CreateChargeReq</span></strong><span class="koboSpan" id="kobo.737.1"> type contains the required attribute’s charge amount (</span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">amount</span></strong><span class="koboSpan" id="kobo.739.1">) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">currency</span></strong><span class="koboSpan" id="kobo.741.1">. </span><span class="koboSpan" id="kobo.741.2">It also contains several optional attributes – </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">customerId</span></strong><span class="koboSpan" id="kobo.743.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.744.1">receiptEmail</span></strong><span class="koboSpan" id="kobo.745.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.746.1">source</span></strong><span class="koboSpan" id="kobo.747.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.748.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">statementDescriptor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.750.1">.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.751.1">UpdateChargeReq</span></strong><span class="koboSpan" id="kobo.752.1"> contains </span><a id="_idIndexMarker981"/><span class="koboSpan" id="kobo.753.1">all the optional attributes – </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1">customerId</span></strong><span class="koboSpan" id="kobo.755.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">description</span></strong><span class="koboSpan" id="kobo.757.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.758.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">receiptEmail</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.760.1">.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.761.1">CaptureChargeReq</span></strong><span class="koboSpan" id="kobo.762.1"> contains all the optional attributes – </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">amount</span></strong><span class="koboSpan" id="kobo.764.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.765.1">receiptEmail</span></strong><span class="koboSpan" id="kobo.766.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.767.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">statementDescriptor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.769.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.770.1">Less well-known Google common types</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">Money</span></strong><span class="koboSpan" id="kobo.772.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.773.1">Date</span></strong><span class="koboSpan" id="kobo.774.1"> (not </span><strong class="source-inline"><span class="koboSpan" id="kobo.775.1">Timestamp</span></strong><span class="koboSpan" id="kobo.776.1">) are less commonly known types that can be used. </span><span class="koboSpan" id="kobo.776.2">However, you must copy the definitions instead of importing them (unlike what you do for </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">Empty</span></strong><span class="koboSpan" id="kobo.778.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.779.1">Timestamp</span></strong><span class="koboSpan" id="kobo.780.1">). </span><span class="koboSpan" id="kobo.780.2">You can copy the definitions from the following links: </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">Money</span></strong><span class="koboSpan" id="kobo.782.1"> from https://github.com/googleapis/googleapis/blob/master/google/type/money.proto and </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">Date</span></strong><span class="koboSpan" id="kobo.784.1"> from https://github.com/googleapis/googleapis/blob/master/google/type/date.proto. </span><span class="koboSpan" id="kobo.784.2">Other common types that you can use are also available in </span><span class="No-Break"><span class="koboSpan" id="kobo.785.1">the repository.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.786.1">Now, you </span><a id="_idIndexMarker982"/><span class="koboSpan" id="kobo.787.1">can define the parameters and return the </span><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">SourceService</span></strong><span class="koboSpan" id="kobo.789.1"> types. </span><span class="koboSpan" id="kobo.789.2">First, let’s define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.790.1">Source</span></strong><span class="koboSpan" id="kobo.791.1"> message type, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">following code.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.793.1">The source uses a </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">Flow</span></strong><span class="koboSpan" id="kobo.795.1"> value, which could be either </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">REDIRECT</span></strong><span class="koboSpan" id="kobo.797.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">RECEIVER</span></strong><span class="koboSpan" id="kobo.799.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">CODEVERIFICATION</span></strong><span class="koboSpan" id="kobo.801.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.802.1">NONE</span></strong><span class="koboSpan" id="kobo.803.1">. </span><span class="koboSpan" id="kobo.803.2">Similarly, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">Usage</span></strong><span class="koboSpan" id="kobo.805.1"> value could be </span><strong class="source-inline"><span class="koboSpan" id="kobo.806.1">REUSABLE</span></strong><span class="koboSpan" id="kobo.807.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.808.1">SINGLEUSE</span></strong><span class="koboSpan" id="kobo.809.1">. </span><span class="koboSpan" id="kobo.809.2">Therefore, let’s first create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">Flow</span></strong><span class="koboSpan" id="kobo.811.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">Usage</span></strong><span class="koboSpan" id="kobo.813.1"> enumerations </span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.815.1">enum</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.816.1">:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.817.1">enum</span></strong><span class="koboSpan" id="kobo.818.1"> Flow {  REDIRECT = 0;
  RECEIVER = 1;
  CODEVERIFICATION = 2;
  NONE = 3;
}
</span><strong class="bold"><span class="koboSpan" id="kobo.819.1">enum</span></strong><span class="koboSpan" id="kobo.820.1"> Usage {
  REUSABLE = 0;
  SINGLEUSE = 1;
}</span></pre>
<p><span class="koboSpan" id="kobo.821.1">Now, you can use this </span><strong class="source-inline"><span class="koboSpan" id="kobo.822.1">Flow</span></strong><span class="koboSpan" id="kobo.823.1"> enum in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.824.1">Source</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.825.1"> message:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.826.1">
message Source {  string id = 1;
  uint32 amount = 2;
  string clientSecret = 3;
  uint64 created = 4;
  string currency = 5;
  Flow flow = 6;
  Owner owner = 7;
  Receiver receiver = 8;
  string statementDescriptor = 9;
  enum Status {
    CANCELLED = 0;
    CHARGEABLE = 1;
    CONSUMNED = 2;
    FAILED = 3;
    PENDING = 4;
  }
  Status status = 10;
  string type = 11;
  Usage usage = 12;
}</span></pre>
<ol>
<li value="8"><span class="koboSpan" id="kobo.827.1">Now, you can </span><a id="_idIndexMarker983"/><span class="koboSpan" id="kobo.828.1">define the remaining message types for the other parameters of </span><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">SourceService</span></strong><span class="koboSpan" id="kobo.830.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.831.1">CreateSourceReq</span></strong><span class="koboSpan" id="kobo.832.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.833.1">UpdateSourceReq</span></strong><span class="koboSpan" id="kobo.834.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.835.1">AttachOrDetachReq</span></strong><span class="koboSpan" id="kobo.836.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">SourceId</span></strong><span class="koboSpan" id="kobo.838.1"> – as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.839.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.840.1">
message CreateSourceReq {  string type = 1;  uint32 amount = 2;  string currency = 3;  Owner owner = 4;  string statementDescriptor = 5;  Flow flow = 6;  Receiver receiver = 7;  Usage usage = 8;  message Response { Source source = 1; }}message UpdateSourceReq {  string sourceId = 1;  uint32 amount = 2;  Owner owner = 3;  message Response { Source source = 1; }}message SourceId {  string id = 1;  message Response { Source source = 1; }}message AttachOrDetachReq {  string sourceId = 1;  string customerId = 2;  message Response { Source source = 1; }}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.841.1">The other </span><a id="_idIndexMarker984"/><span class="koboSpan" id="kobo.842.1">message types used in these messages can be referred to in the payment gateway definition file, located </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">at </span></span><span class="No-Break"><span class="koboSpan" id="kobo.844.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/api/lib/src/main/proto/PaymentGatewayService.proto</span></span><span class="No-Break"><span class="koboSpan" id="kobo.845.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.846.1">Multiple .proto files</span></p>
<p class="callout"><span class="koboSpan" id="kobo.847.1">You can also create a separate definition file for each service, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.848.1">ChargeService.proto</span></strong><span class="koboSpan" id="kobo.849.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.850.1">SourceService.proto</span></strong><span class="koboSpan" id="kobo.851.1">, for modularity. </span><span class="koboSpan" id="kobo.851.2">You can then import these files into another Protobuf file using </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">import "SourceService.proto";</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.853.1">.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.854.1">You can find more information about importing </span><span class="No-Break"><span class="koboSpan" id="kobo.855.1">at </span></span><span class="No-Break"><span class="koboSpan" id="kobo.856.1">https://protobuf.dev/programming-guides/proto3/#importing-definitions</span></span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.858.1">You are now done </span><a id="_idIndexMarker985"/><span class="koboSpan" id="kobo.859.1">with the payment gateway service definitions in the Protobuf file. </span><span class="koboSpan" id="kobo.859.2">Now, you can use this file to generate the gRPC server interface and stubs for the </span><span class="No-Break"><span class="koboSpan" id="kobo.860.1">gRPC client.</span></span></p>
<p><span class="koboSpan" id="kobo.861.1">Next, you will publish the Java classes generated from the Protobuf file packaged in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.862.1">Jar</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.863.1"> file.</span></span></p>
<h3><span class="koboSpan" id="kobo.864.1">Publishing the payment gateway service gRPC server, stubs, and models</span></h3>
<p><span class="koboSpan" id="kobo.865.1">You can use the </span><a id="_idIndexMarker986"/><span class="koboSpan" id="kobo.866.1">following </span><a id="_idIndexMarker987"/><span class="koboSpan" id="kobo.867.1">command, which should be </span><a id="_idIndexMarker988"/><span class="koboSpan" id="kobo.868.1">executed from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">api</span></strong><span class="koboSpan" id="kobo.870.1"> project’s </span><span class="No-Break"><span class="koboSpan" id="kobo.871.1">root directory:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.872.1">
# Make sure to enable UTF-8 for file encoding because# we are using UTF characters in Java files.
</span><span class="koboSpan" id="kobo.872.2">$ export JAVA_TOOL_OPTIONS="-Dfile.encoding=UTF8"
$ gradlew clean publishToMavenLocal</span></pre>
<p><span class="koboSpan" id="kobo.873.1">With the preceding command, you are setting the file encoding to UTF-8 first because we are using the UTF characters in Java files. </span><span class="koboSpan" id="kobo.873.2">Then, you are performing clean, build, and publish operations. </span><span class="koboSpan" id="kobo.873.3">The second command will first remove the existing files. </span><span class="koboSpan" id="kobo.873.4">Then, it will generate the Java files (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">generateProto</span></strong><span class="koboSpan" id="kobo.875.1"> Gradle task) from the Protobuf file, build it (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">build</span></strong><span class="koboSpan" id="kobo.877.1"> Gradle task), and publish the artifact to your local Maven repository (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">publishToMavenLocal</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.879.1">Gradle task).</span></span></p>
<p><span class="koboSpan" id="kobo.880.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.881.1">generateProto</span></strong><span class="koboSpan" id="kobo.882.1"> Gradle task will generate the two types of Java classes in two directories, as </span><span class="No-Break"><span class="koboSpan" id="kobo.883.1">shown next:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.884.1">Models</span></strong><span class="koboSpan" id="kobo.885.1">: This </span><a id="_idIndexMarker989"/><span class="koboSpan" id="kobo.886.1">Protobuf </span><a id="_idIndexMarker990"/><span class="koboSpan" id="kobo.887.1">Gradle plugin generates </span><a id="_idIndexMarker991"/><span class="koboSpan" id="kobo.888.1">messages (aka models) and classes in separate Java files in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.889.1">/api/lib/build/generated/source/proto/main/java</span></strong><span class="koboSpan" id="kobo.890.1"> directory, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.891.1">Card.java</span></strong><span class="koboSpan" id="kobo.892.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.893.1">Address.java</span></strong><span class="koboSpan" id="kobo.894.1">. </span><span class="koboSpan" id="kobo.894.2">This directory will also contain the Java files of request and response objects used in operation contracts, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">CreateChargeReq</span></strong><span class="koboSpan" id="kobo.896.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">CreateSourceReq</span></strong><span class="koboSpan" id="kobo.898.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.899.1">Charge.java</span></strong><span class="koboSpan" id="kobo.900.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.901.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">Source.java</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.903.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.904.1">gRPC classes</span></strong><span class="koboSpan" id="kobo.905.1">: This Protobuf Gradle plugin generates the service definitions of both services (</span><strong class="source-inline"><span class="koboSpan" id="kobo.906.1">ChargeServiceGrpc.java</span></strong><span class="koboSpan" id="kobo.907.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">SourceServiceGrpc .java</span></strong><span class="koboSpan" id="kobo.909.1">) in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.910.1">/api/lib/build/generated/source/proto/main /grpc</span></strong><span class="koboSpan" id="kobo.911.1"> directory. </span><span class="koboSpan" id="kobo.911.2">Each of these gRPC Java files contains a base class, stub classes, and methods for each operation defined in the service descriptor for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">Charge</span></strong><span class="koboSpan" id="kobo.913.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.914.1">Source</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.915.1"> services.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.916.1">The following key static classes are defined </span><span class="No-Break"><span class="koboSpan" id="kobo.917.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.918.1">ChargeServiceGrpc</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.919.1">:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">ChargeServiceImplBase</span></strong><span class="koboSpan" id="kobo.921.1"> (abstract </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1">base class)</span></span></li>
<li><span class="koboSpan" id="kobo.923.1">Stubs: </span><strong class="source-inline"><span class="koboSpan" id="kobo.924.1">ChargeServiceStub</span></strong><span class="koboSpan" id="kobo.925.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.926.1">ChargeServiceBlockingStub</span></strong><span class="koboSpan" id="kobo.927.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.928.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.929.1">ChargeServiceFutureStub</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.930.1">Similarly, the following key static classes are defined </span><span class="No-Break"><span class="koboSpan" id="kobo.931.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.932.1">SourceServiceGrpc</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">SourceServiceImplBase</span></strong><span class="koboSpan" id="kobo.935.1"> (abstract </span><span class="No-Break"><span class="koboSpan" id="kobo.936.1">base class)</span></span></li>
<li><span class="koboSpan" id="kobo.937.1">Stubs: </span><strong class="source-inline"><span class="koboSpan" id="kobo.938.1">SourceServiceStub</span></strong><span class="koboSpan" id="kobo.939.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.940.1">SourceServiceBlockingStub</span></strong><span class="koboSpan" id="kobo.941.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.942.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">SourceServiceFutureStub</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.944.1">The abstract base classes described earlier contain the operations defined in the service block in the </span><a id="_idIndexMarker992"/><span class="koboSpan" id="kobo.945.1">Protobuf file. </span><span class="koboSpan" id="kobo.945.2">You can </span><a id="_idIndexMarker993"/><span class="koboSpan" id="kobo.946.1">use these base classes to </span><a id="_idIndexMarker994"/><span class="koboSpan" id="kobo.947.1">implement the business logic for operations offered by these services, just like you implemented the REST endpoints from the Swagger-generated API </span><span class="No-Break"><span class="koboSpan" id="kobo.948.1">Java interfaces.</span></span></p>
<p><span class="koboSpan" id="kobo.949.1">These abstract classes should be implemented to provide the business logic implementations to the services offered by the gRPC server. </span><span class="koboSpan" id="kobo.949.2">Let’s develop the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.950.1">server next.</span></span></p>
<h1 id="_idParaDest-257"><a id="_idTextAnchor256"/><span class="koboSpan" id="kobo.951.1">Developing the gRPC server</span></h1>
<p><span class="koboSpan" id="kobo.952.1">You need to </span><a id="_idIndexMarker995"/><span class="koboSpan" id="kobo.953.1">configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.954.1">server</span></strong><span class="koboSpan" id="kobo.955.1"> project before implementing these abstract classes. </span><span class="koboSpan" id="kobo.955.2">Let’s configure the server </span><span class="No-Break"><span class="koboSpan" id="kobo.956.1">project first.</span></span></p>
<p><span class="koboSpan" id="kobo.957.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">server</span></strong><span class="koboSpan" id="kobo.959.1"> project directory structure will look like the following. </span><span class="koboSpan" id="kobo.959.2">The project root directory contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">build.gradle</span></strong><span class="koboSpan" id="kobo.961.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">settings.gradle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.963.1"> files:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.964.1">
├── server    ├── build.gradle
    ├── gradle
    │   └── wrapper
    ├── gradlew
    ├── gradlew.bat
    ├── settings.gradle
    └── src
        ├── main
        │   ├── java
        │   │   └── com
        │   │       └── packt
        │   │           └── modern
        │   │               └── api
        │   └── resources
        └── test
            └── java</span></pre>
<p><span class="koboSpan" id="kobo.965.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">resources</span></strong><span class="koboSpan" id="kobo.967.1"> directory </span><a id="_idIndexMarker996"/><span class="koboSpan" id="kobo.968.1">will contain the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">application.properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.970.1"> file.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.971.1">Using the Sprint Boot gRPC starters</span></p>
<p class="callout"><span class="koboSpan" id="kobo.972.1">There are two Spring Boot starter projects that you can use. </span><span class="koboSpan" id="kobo.972.2">However, we’ll stick to the libraries provided by gRPC for </span><a id="_idIndexMarker997"/><span class="koboSpan" id="kobo.973.1">a simplified solution and to aid understanding of the gRPC concepts. </span><span class="koboSpan" id="kobo.973.2">These libraries are available at the following links: https://github.com/LogNet/grpc-spring-boot-starter </span><span class="No-Break"><span class="koboSpan" id="kobo.974.1">and </span></span><span class="No-Break"><span class="koboSpan" id="kobo.975.1">https://github.com/yidongnan/grpc-spring-boot-starter</span></span><span class="No-Break"><span class="koboSpan" id="kobo.976.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.977.1">Let’s perform the following steps to configure </span><span class="No-Break"><span class="koboSpan" id="kobo.978.1">the project:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.979.1">First, you need to modify the project name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.980.1">Chapter11/server/ settings.gradle</span></strong><span class="koboSpan" id="kobo.981.1"> file to represent the server, as </span><span class="No-Break"><span class="koboSpan" id="kobo.982.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.983.1">
rootProject.name = 'chapter11-server'</span></pre></li> <li><span class="koboSpan" id="kobo.984.1">Next, you can</span><a id="_idIndexMarker998"/><span class="koboSpan" id="kobo.985.1"> add the dependencies required for </span><strong class="source-inline"><span class="koboSpan" id="kobo.986.1">server</span></strong><span class="koboSpan" id="kobo.987.1"> projects to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.988.1">Chapter11/server/build.gradle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.989.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.990.1">
def grpcVersion = '1.54.1'dependencies { implementation </span><strong class="bold"><span class="koboSpan" id="kobo.991.1">'com.packt.modern.api:payment-gateway-</span></strong><span class="koboSpan" id="kobo.992.1">      </span><strong class="bold"><span class="koboSpan" id="kobo.993.1">api:0.0.1</span></strong><span class="koboSpan" id="kobo.994.1">' implementation "</span><strong class="bold"><span class="koboSpan" id="kobo.995.1">io.grpc:grpc-protobuf</span></strong><span class="koboSpan" id="kobo.996.1">:${grpcVersion}" implementation "</span><strong class="bold"><span class="koboSpan" id="kobo.997.1">io.grpc:grpc-stub</span></strong><span class="koboSpan" id="kobo.998.1">:${grpcVersion}" implementation "</span><strong class="bold"><span class="koboSpan" id="kobo.999.1">io.grpc:grpc-netty</span></strong><span class="koboSpan" id="kobo.1000.1">:${grpcVersion}" implementation '</span><strong class="bold"><span class="koboSpan" id="kobo.1001.1">com.google.api.grpc:googleapis-</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1002.1">     common-protos:0.0.3</span></strong><span class="koboSpan" id="kobo.1003.1">' implementation 'org.springframework.boot:spring-boot-     starter-web' testImplementation 'org.springframework.boot:spring-     boot-starter-test' testImplementation "</span><strong class="bold"><span class="koboSpan" id="kobo.1004.1">io.grpc:grpc-testing</span></strong><span class="koboSpan" id="kobo.1005.1">     :${grpcVersion}"}</span></pre></li> <li><span class="koboSpan" id="kobo.1006.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1007.1">payment-gateway-api</span></strong><span class="koboSpan" id="kobo.1008.1"> dependency is published in the local Maven repository. </span><span class="koboSpan" id="kobo.1008.2">Therefore, you need to add the local Maven repository to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1009.1">repositories</span></strong><span class="koboSpan" id="kobo.1010.1"> section in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1011.1">Chapter11/server/build.gradle</span></strong><span class="koboSpan" id="kobo.1012.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1013.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1014.1">
repositories {  mavenCentral()  </span><strong class="bold"><span class="koboSpan" id="kobo.1015.1">mavenLocal()</span></strong><span class="koboSpan" id="kobo.1016.1">}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1017.1">You are done with the Gradle configuration! </span><span class="koboSpan" id="kobo.1017.2">Now, you can write the gRPC server. </span><span class="koboSpan" id="kobo.1017.3">However, before </span><a id="_idIndexMarker999"/><span class="koboSpan" id="kobo.1018.1">writing the server, you need to implement the base abstract classes generated by Protobuf. </span><span class="koboSpan" id="kobo.1018.2">Once the source and charge services (using base classes) are implemented, you can write the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.1019.1">server code.</span></span></p>
<h2 id="_idParaDest-258"><a id="_idTextAnchor257"/><span class="koboSpan" id="kobo.1020.1">Implementation of the gRPC server</span></h2>
<p><span class="koboSpan" id="kobo.1021.1">You are going to use the same layered architecture that you used in the REST implementation – persistence store &gt; repository layer &gt; service layer &gt; </span><span class="No-Break"><span class="koboSpan" id="kobo.1022.1">API endpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.1023.1">First, you need </span><a id="_idIndexMarker1000"/><span class="koboSpan" id="kobo.1024.1">a persistence store where you can save the data, aka the first layer. </span><span class="koboSpan" id="kobo.1024.2">You are going to use in-memory persistence (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1025.1">ConcurrentHashMap</span></strong><span class="koboSpan" id="kobo.1026.1">) for storing and retrieving the data. </span><span class="koboSpan" id="kobo.1026.2">If you want, you can use the external database the way it is used in REST web services. </span><span class="koboSpan" id="kobo.1026.3">This is done to keep the focus on gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.1027.1">server implementation.</span></span></p>
<p><span class="koboSpan" id="kobo.1028.1">First, create the in-memory persistence store for both the charge and source data stores. </span><span class="koboSpan" id="kobo.1028.2">Create a new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1029.1">server/src/main/java/com/packt/modern/api/server/ repository/DbStore.java</span></strong><span class="koboSpan" id="kobo.1030.1">, and add code, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1031.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1032.1">
@Componentpublic class DbStore {
 private static final Map&lt;String, Source&gt; sourceEntities =
    new ConcurrentHashMap&lt;&gt;();
 private static final Map&lt;String, Charge&gt; chargeEntities =
    new ConcurrentHashMap&lt;&gt;();
 public DbStore() {
  Source source = Source.newBuilder().setId(
      RandomHolder.randomKey())
      .setType("card").setAmount(100)
      .setOwner(createOwner()).
</span><span class="koboSpan" id="kobo.1032.2">      setReceiver(createReceiver())
      .setCurrency("USD").setStatementDescriptor("Statement")
      .setFlow(Flow.RECEIVER).setUsage(Usage.REUSABLE)
      .setCreated(Instant.now().getEpochSecond()).build();
  sourceEntities.put(source.getId(), source);
  Charge charge = Charge.newBuilder().setId(
      RandomHolder.randomKey()).setAmount(1000)
      .setCurrency("USD").setCustomerId("ab1ab2ab3ab4ab5")
      .setDescription("ChargeDescription")
      .setReceiptEmail("receipt@email.com")
      .setStatementDescriptor("Statement Descriptor")
      .setSourceId(source.getId())
      .setCreated(Instant.now().getEpochSecond()).build();
  chargeEntities.put(charge.getId(), charge);
 }
// continue …</span></pre>
<p><span class="No-Break"><span class="koboSpan" id="kobo.1033.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/ server/repository/DbStore.java</span></span></p>
<p><span class="koboSpan" id="kobo.1034.1">Here, you create two </span><strong class="source-inline"><span class="koboSpan" id="kobo.1035.1">ConcurrentHashMap</span></strong><span class="koboSpan" id="kobo.1036.1"> objects for storing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1037.1">Charge</span></strong><span class="koboSpan" id="kobo.1038.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1">Store</span></strong><span class="koboSpan" id="kobo.1040.1"> objects, respectively. </span><span class="koboSpan" id="kobo.1040.2">You create two seed objects of each of these in the constructor using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">builder</span></strong><span class="koboSpan" id="kobo.1042.1"> and store them in their respective </span><span class="No-Break"><span class="koboSpan" id="kobo.1043.1">hash maps.</span></span></p>
<p><span class="koboSpan" id="kobo.1044.1">According to the operations defined in the service contract, you create the methods in the database store </span><a id="_idIndexMarker1001"/><span class="koboSpan" id="kobo.1045.1">to perform the operations. </span><span class="koboSpan" id="kobo.1045.2">These operations are implemented with basic business logic to keep the flow and logic concise and to </span><span class="No-Break"><span class="koboSpan" id="kobo.1046.1">the point.</span></span></p>
<p><span class="koboSpan" id="kobo.1047.1">Let’s now add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1048.1">createSource()</span></strong><span class="koboSpan" id="kobo.1049.1"> method to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1">create()</span></strong><span class="koboSpan" id="kobo.1051.1"> contract of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">SourceService</span></strong><span class="koboSpan" id="kobo.1053.1"> defined in the Protobuf file, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1054.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1055.1">
public CreateSourceReq.Response       createSource(CreateSourceReq req) {
  </span><strong class="bold"><span class="koboSpan" id="kobo.1056.1">Source source</span></strong><span class="koboSpan" id="kobo.1057.1"> = Source.newBuilder().setId(
      RandomHolder.randomKey()).setType(req.getType())
      .setAmount(req.getAmount()).setOwner(</span><strong class="bold"><span class="koboSpan" id="kobo.1058.1">createOwner</span></strong><span class="koboSpan" id="kobo.1059.1">())
      .setReceiver(</span><strong class="bold"><span class="koboSpan" id="kobo.1060.1">createReceiver</span></strong><span class="koboSpan" id="kobo.1061.1">())
      .setCurrency(req.getCurrency())
      .setStatementDescriptor(req.getStatementDescriptor())
      .setFlow(req.getFlow()).setUsage(req.getUsage())
      .setCreated(Instant.now().getEpochSecond()).build();
  sourceEntities.put(source.getId(), source);
  return CreateSourceReq.Response.newBuilder()
         .setSource(</span><strong class="bold"><span class="koboSpan" id="kobo.1062.1">source</span></strong><span class="koboSpan" id="kobo.1063.1">).build();
}</span></pre>
<p><span class="koboSpan" id="kobo.1064.1">This method creates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1065.1">source</span></strong><span class="koboSpan" id="kobo.1066.1"> object from the values received from the request object (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1067.1">CreateSourceReq</span></strong><span class="koboSpan" id="kobo.1068.1">). </span><span class="koboSpan" id="kobo.1068.2">This newly created </span><strong class="source-inline"><span class="koboSpan" id="kobo.1069.1">Source</span></strong><span class="koboSpan" id="kobo.1070.1"> object is then saved in a hash map called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1071.1">sourceEntities</span></strong><span class="koboSpan" id="kobo.1072.1"> and returned to the caller. </span><span class="koboSpan" id="kobo.1072.2">You can enhance this method by adding validation that would validate the request object (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1073.1">req</span></strong><span class="koboSpan" id="kobo.1074.1">). </span><span class="koboSpan" id="kobo.1074.2">Owner and receiver objects (highlighted in the code) should be retrieved from the request object. </span><span class="koboSpan" id="kobo.1074.3">To keep the program simple, we have hardcoded these </span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">values here.</span></span></p>
<p><span class="koboSpan" id="kobo.1076.1">Similarly, you can implement other contract methods for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">source</span></strong><span class="koboSpan" id="kobo.1078.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">charge</span></strong><span class="koboSpan" id="kobo.1080.1"> along with their persistence. </span><span class="koboSpan" id="kobo.1080.2">You can find the full source code of this class </span><span class="No-Break"><span class="koboSpan" id="kobo.1081.1">at </span></span><span class="No-Break"><span class="koboSpan" id="kobo.1082.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/DbStore.java</span></span><span class="No-Break"><span class="koboSpan" id="kobo.1083.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1084.1">Now, you have</span><a id="_idIndexMarker1002"/><span class="koboSpan" id="kobo.1085.1"> the in-memory persistence store – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1">DbStore</span></strong><span class="koboSpan" id="kobo.1087.1">. </span><span class="koboSpan" id="kobo.1087.2">Next, let’s use this store in </span><span class="No-Break"><span class="koboSpan" id="kobo.1088.1">repository classes.</span></span></p>
<h3><span class="koboSpan" id="kobo.1089.1">Writing repository classes</span></h3>
<p><span class="koboSpan" id="kobo.1090.1">Now, you </span><a id="_idIndexMarker1003"/><span class="koboSpan" id="kobo.1091.1">can implement the next layer – the repository layer. </span><span class="koboSpan" id="kobo.1091.2">The in-memory persistence store (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1092.1">DbStore</span></strong><span class="koboSpan" id="kobo.1093.1">) can be consumed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">ChargeRepositoryImpl</span></strong><span class="koboSpan" id="kobo.1095.1"> repository class to interact, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1096.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1097.1">
@Repositorypublic class ChargeRepositoryImpl implements
    ChargeRepository {
  private DbStore dbStore;
  public ChargeRepositoryImpl(DbStore dbStore) {
    this.dbStore = dbStore;
  }
  @Override
  public CreateChargeReq.Response create(
      CreateChargeReq req) {
    return dbStore.createCharge(req);
  }
  // code truncated for brevity</span></pre>
<p><span class="No-Break"><span class="koboSpan" id="kobo.1098.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/ChargeRepositoryImpl.java</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1099.1">ChargeRepositoryImpl</span></strong><span class="koboSpan" id="kobo.1100.1"> implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">ChargeRepository</span></strong><span class="koboSpan" id="kobo.1102.1"> interface and makes use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">DbStore</span></strong><span class="koboSpan" id="kobo.1104.1"> to perform the operations. </span><span class="koboSpan" id="kobo.1104.2">The code of this repository interface is available </span><span class="No-Break"><span class="koboSpan" id="kobo.1105.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/ChargeRepository.java"><span class="No-Break"><span class="koboSpan" id="kobo.1106.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/ChargeRepository.java</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1107.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1108.1">Similarly, you </span><a id="_idIndexMarker1004"/><span class="koboSpan" id="kobo.1109.1">can create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">SourceRepositoryImpl</span></strong><span class="koboSpan" id="kobo.1111.1"> class, which implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.1112.1">SourceRespository</span></strong><span class="koboSpan" id="kobo.1113.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1114.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1115.1">
@Repositorypublic class SourceRepositoryImpl
    implements SourceRepository {
 private DbStore dbStore;
 public SourceRepositoryImpl(DbStore dbStore) {
   this.dbStore = dbStore;
 }
 @Override
 public UpdateSourceReq.Response update
    (UpdateSourceReq req) {
   return dbStore.updateSource(req);
 }
 // Other methods removed for brevity</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/SourceRepositoryImpl.java"><span class="No-Break"><span class="koboSpan" id="kobo.1116.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/SourceRepositoryImpl.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1117.1">Like </span><strong class="source-inline"><span class="koboSpan" id="kobo.1118.1">ChangeRepositoryImpl</span></strong><span class="koboSpan" id="kobo.1119.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1120.1">SourceRepositoryImpl</span></strong><span class="koboSpan" id="kobo.1121.1"> too makes use of a persistence store to persist the data. </span><span class="koboSpan" id="kobo.1121.2">You can find the code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1122.1">SourceRepository</span></strong><span class="koboSpan" id="kobo.1123.1"> interface </span><span class="No-Break"><span class="koboSpan" id="kobo.1124.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/SourceRepository.java"><span class="No-Break"><span class="koboSpan" id="kobo.1125.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/SourceRepository.java</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1126.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1127.1">Methods of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1128.1">Source</span></strong><span class="koboSpan" id="kobo.1129.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1130.1">Charge</span></strong><span class="koboSpan" id="kobo.1131.1"> repository classes are consumed by the service classes. </span><span class="koboSpan" id="kobo.1131.2">Service </span><a id="_idIndexMarker1005"/><span class="koboSpan" id="kobo.1132.1">base classes are generated by gRPC (part of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1133.1">api</span></strong><span class="koboSpan" id="kobo.1134.1"> project). </span><span class="koboSpan" id="kobo.1134.2">Service classes implement these abstract-generated base classes (service </span><span class="No-Break"><span class="koboSpan" id="kobo.1135.1">base classes).</span></span></p>
<p><span class="koboSpan" id="kobo.1136.1">Let’s write the service </span><span class="No-Break"><span class="koboSpan" id="kobo.1137.1">layer next.</span></span></p>
<h3><span class="koboSpan" id="kobo.1138.1">Implementing service classes</span></h3>
<p><span class="koboSpan" id="kobo.1139.1">Now you </span><a id="_idIndexMarker1006"/><span class="koboSpan" id="kobo.1140.1">have the underlying implementation ready in the form of repository and database store classes, which can be used to implement the gRPC service’s </span><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">base classes.</span></span></p>
<p><span class="koboSpan" id="kobo.1142.1">Let’s implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1143.1">Source</span></strong><span class="koboSpan" id="kobo.1144.1"> service first, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1145.1">shown next:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1146.1">Create a new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1147.1">SourceService.java</span></strong><span class="koboSpan" id="kobo.1148.1">, in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1">server/src/main/com/packt/modern/api/server/service</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1150.1"> directory.</span></span></li>
<li><span class="koboSpan" id="kobo.1151.1">Add the implementations to operations defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1152.1">SourceService</span></strong><span class="koboSpan" id="kobo.1153.1"> abstract base class, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1154.1">shown next:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1155.1">
@Servicepublic class SourceService     extends </span><strong class="bold"><span class="koboSpan" id="kobo.1156.1">SourceServiceImplBase</span></strong><span class="koboSpan" id="kobo.1157.1"> {  private final SourceRepository repository;  public SourceService(SourceRepository repository) {    this.repository = repository;  }@Overridepublic void create(CreateSourceReq req, </span><strong class="bold"><span class="koboSpan" id="kobo.1158.1">StreamObserver&lt;CreateSourceReq.Response&gt;</span></strong><span class="koboSpan" id="kobo.1159.1"> resObserver) {  CreateSourceReq.Response resp = repository.create      (req);  resObserver.</span><strong class="bold"><span class="koboSpan" id="kobo.1160.1">onNext</span></strong><span class="koboSpan" id="kobo.1161.1">(resp);  resObserver.</span><strong class="bold"><span class="koboSpan" id="kobo.1162.1">onCompleted</span></strong><span class="koboSpan" id="kobo.1163.1">();}// Other methods removed for brevity</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/service/SourceService.java"><span class="No-Break"><span class="koboSpan" id="kobo.1164.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/service/SourceService.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1165.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1166.1">SourceServiceImplBase</span></strong><span class="koboSpan" id="kobo.1167.1"> abstract class is autogenerated by the Protobuf plugin, which contains the contract methods of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1168.1">Source</span></strong><span class="koboSpan" id="kobo.1169.1"> service. </span><span class="koboSpan" id="kobo.1169.2">A unique part of </span><a id="_idIndexMarker1007"/><span class="koboSpan" id="kobo.1170.1">the method signature generated is the second argument, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1171.1">StreamObserver</span></strong><span class="koboSpan" id="kobo.1172.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1173.1">StreamObserver</span></strong><span class="koboSpan" id="kobo.1174.1"> receives notifications from observable streams. </span><span class="koboSpan" id="kobo.1174.2">It is being used here for service implementation. </span><span class="koboSpan" id="kobo.1174.3">Similarly, it is also used in the client stubs. </span><span class="koboSpan" id="kobo.1174.4">The gRPC library provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">StreamObserver</span></strong><span class="koboSpan" id="kobo.1176.1"> argument for outgoing messages. </span><span class="koboSpan" id="kobo.1176.2">However, you also must implement it for </span><span class="No-Break"><span class="koboSpan" id="kobo.1177.1">incoming messages.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1178.1">StreamObserver</span></strong><span class="koboSpan" id="kobo.1179.1"> arguments are not thread-safe, so you must take care of multithreading and should use </span><span class="No-Break"><span class="koboSpan" id="kobo.1180.1">synchronized calls.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1181.1">There are three primary methods </span><span class="No-Break"><span class="koboSpan" id="kobo.1182.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1183.1">StreamObserver</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1184.1">:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1185.1">onNext()</span></strong><span class="koboSpan" id="kobo.1186.1">: This method receives the value from the stream. </span><span class="koboSpan" id="kobo.1186.2">It can be called multiple times. </span><span class="koboSpan" id="kobo.1186.3">However, it should not be called after </span><strong class="source-inline"><span class="koboSpan" id="kobo.1187.1">onCompleted()</span></strong><span class="koboSpan" id="kobo.1188.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">onError()</span></strong><span class="koboSpan" id="kobo.1190.1">. </span><span class="koboSpan" id="kobo.1190.2">Multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.1191.1">onNext()</span></strong><span class="koboSpan" id="kobo.1192.1"> calls are required for streams when multiple datasets are sent </span><span class="No-Break"><span class="koboSpan" id="kobo.1193.1">to clients.</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1194.1">onCompleted()</span></strong><span class="koboSpan" id="kobo.1195.1">: This marks the completion of the stream and no further method calls are allowed after that. </span><span class="koboSpan" id="kobo.1195.2">It can only be </span><span class="No-Break"><span class="koboSpan" id="kobo.1196.1">called once.</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1197.1">onError()</span></strong><span class="koboSpan" id="kobo.1198.1">: This method receives the termination error from the stream. </span><span class="koboSpan" id="kobo.1198.2">Like </span><strong class="source-inline"><span class="koboSpan" id="kobo.1199.1">onCompleted()</span></strong><span class="koboSpan" id="kobo.1200.1">, it can only be called once and no further method calls </span><span class="No-Break"><span class="koboSpan" id="kobo.1201.1">are allowed.</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.1202.1">Similarly, you can implement the other methods of an </span><span class="No-Break"><span class="koboSpan" id="kobo.1203.1">abstract class.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.1204.1">Next, you </span><a id="_idIndexMarker1008"/><span class="koboSpan" id="kobo.1205.1">can implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1206.1">Charge</span></strong><span class="koboSpan" id="kobo.1207.1"> service in the same way you have implemented the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">Source</span></strong><span class="koboSpan" id="kobo.1209.1"> service. </span><span class="koboSpan" id="kobo.1209.2">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.1210.1">do it:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1211.1">Create a new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1212.1">ChargeService.java</span></strong><span class="koboSpan" id="kobo.1213.1">, in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1214.1">server/src/main/com/packt/modern/api/server/service</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1215.1"> directory.</span></span></li>
<li><span class="koboSpan" id="kobo.1216.1">Add the implementations to operations defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1217.1">ChargeService</span></strong><span class="koboSpan" id="kobo.1218.1"> abstract base class, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1219.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1220.1">
@Servicepublic class ChargeService       extends </span><strong class="bold"><span class="koboSpan" id="kobo.1221.1">ChargeServiceImplBase</span></strong><span class="koboSpan" id="kobo.1222.1"> {  private final ChargeRepository repository;  public ChargeService(ChargeRepository repository) {    this.repository = repository;  }  @Override  public void create(CreateChargeReq req,  </span><strong class="bold"><span class="koboSpan" id="kobo.1223.1">StreamObserver&lt;CreateChargeReq.Response&gt;</span></strong><span class="koboSpan" id="kobo.1224.1">     resObserver) {    CreateSourceReq.Response resp =                                 repository.create(req);    resObserver.</span><strong class="bold"><span class="koboSpan" id="kobo.1225.1">onNext</span></strong><span class="koboSpan" id="kobo.1226.1">(resp);    resObserver.</span><strong class="bold"><span class="koboSpan" id="kobo.1227.1">onCompleted</span></strong><span class="koboSpan" id="kobo.1228.1">();  }  // Other methods truncated for brevity</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/service/ChargeService.java"><span class="No-Break"><span class="koboSpan" id="kobo.1229.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/service/ChargeService.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1230.1">This is along the same lines as the way the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1231.1">SourceService</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1232.1">create</span></strong><span class="koboSpan" id="kobo.1233.1"> method </span><span class="No-Break"><span class="koboSpan" id="kobo.1234.1">was implemented.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1235.1">Similarly, you can implement the other methods of the abstract class. </span><span class="koboSpan" id="kobo.1235.2">Please refer to the link </span><a id="_idIndexMarker1009"/><span class="koboSpan" id="kobo.1236.1">to the source code after the preceding code block for the complete </span><span class="No-Break"><span class="koboSpan" id="kobo.1237.1">code implementation.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.1238.1">Now, you have the service layer implementation ready. </span><span class="koboSpan" id="kobo.1238.2">Let’s implement the API layer (gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.1239.1">server) next.</span></span></p>
<h2 id="_idParaDest-259"><a id="_idTextAnchor258"/><span class="koboSpan" id="kobo.1240.1">Implementation of the gRPC server class</span></h2>
<p><span class="koboSpan" id="kobo.1241.1">The Spring Boot </span><a id="_idIndexMarker1010"/><span class="koboSpan" id="kobo.1242.1">application runs on its own server. </span><span class="koboSpan" id="kobo.1242.2">However, we want to run the gRPC server, which internally uses the Netty web server. </span><span class="koboSpan" id="kobo.1242.3">Therefore, we first need to modify the Spring Boot configuration to stop running its web server. </span><span class="koboSpan" id="kobo.1242.4">You can do that by modifying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1243.1">server/src/main/resources/application.properties</span></strong><span class="koboSpan" id="kobo.1244.1"> file, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1245.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1246.1">
spring.main.web-application-type=nonegrpc.port=8080</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/resources/application.properties"><span class="No-Break"><span class="koboSpan" id="kobo.1247.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/resources/application.properties</span></span></a></p>
<p><span class="koboSpan" id="kobo.1248.1">Next, let’s create the gRPC server. </span><span class="koboSpan" id="kobo.1248.2">It will have three methods – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1249.1">start()</span></strong><span class="koboSpan" id="kobo.1250.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1251.1">stop()</span></strong><span class="koboSpan" id="kobo.1252.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1253.1">block()</span></strong><span class="koboSpan" id="kobo.1254.1"> – for starting </span><a id="_idIndexMarker1011"/><span class="koboSpan" id="kobo.1255.1">up the server, stopping the server, and serving requests until a termination request is </span><span class="No-Break"><span class="koboSpan" id="kobo.1256.1">received, respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.1257.1">Create a new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1258.1">GrpcServer.java</span></strong><span class="koboSpan" id="kobo.1259.1">, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1260.1">server/src/main/com/packt/ modern/api/server</span></strong><span class="koboSpan" id="kobo.1261.1"> directory and the code, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1263.1">
@Componentpublic class GrpcServer {
  @Value("${grpc.port:8080}");
  private int port;
  private Server server;
  private final ChargeService chargeService;
  private final SourceService sourceService;
  private final ExceptionInterceptor exceptionInterceptor;
  public GrpcServer(…) { // code removed for brevity }
  public void start() throws IOException,
     InterruptedException {
    server = ServerBuilder.forPort(port)
        .addService(sourceService).
</span><span class="koboSpan" id="kobo.1263.2">            addService(chargeService)
        .intercept(exceptionInterceptor).build().start();
        server.getServices().stream().forEach(s -&gt;
           Systen.out.println("Service Name: {}",
           s.getServiceDescriptor().getName()));
    Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {
       GrpcServer.this.stop();
    }));
  }
  private void stop() {
    if (server != null) { server.shutdown(); }
  }
  public void block() throws InterruptedException {
    if (server != null) {
      // received the request until application is
         terminated
      server.awaitTermination();
    }
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/GrpcServer.java"><span class="No-Break"><span class="koboSpan" id="kobo.1264.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/GrpcServer.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1265.1">The server library of gRPC provides the server builder for building the server. </span><span class="koboSpan" id="kobo.1265.2">You can see that both services </span><a id="_idIndexMarker1012"/><span class="koboSpan" id="kobo.1266.1">are added to the server. </span><span class="koboSpan" id="kobo.1266.2">The builder also allows you to add interceptors that can intercept the incoming request and response. </span><span class="koboSpan" id="kobo.1266.3">We are going to use the interceptor in the </span><em class="italic"><span class="koboSpan" id="kobo.1267.1">Coding for handling </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1268.1">errors</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1269.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.1270.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1271.1">GrpcServer start()</span></strong><span class="koboSpan" id="kobo.1272.1"> method has also added a shutdown hook that calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1273.1">stop()</span></strong><span class="koboSpan" id="kobo.1274.1"> method, which internally calls the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1275.1">server.shutdown()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1276.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.1277.1">The server code is ready. </span><span class="koboSpan" id="kobo.1277.2">Now, you need an interface to start the server. </span><span class="koboSpan" id="kobo.1277.3">You are going to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1278.1">CommandLineRunner</span></strong><span class="koboSpan" id="kobo.1279.1"> function interface to run </span><span class="No-Break"><span class="koboSpan" id="kobo.1280.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.1281.1">Create a </span><a id="_idIndexMarker1013"/><span class="koboSpan" id="kobo.1282.1">new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1283.1">GrpcServerRunner.java</span></strong><span class="koboSpan" id="kobo.1284.1">, in the same directory where you created the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">GrpcServer.java</span></strong><span class="koboSpan" id="kobo.1286.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1287.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1288.1">
@Profile("!test")@Component
public class GrpcServerRunner implements CommandLineRunner {
  private GrpcServer grpcServer;
  public GrpcServerRunner(GrpcServer grpcServer) {
    this.grpcServer = grpcServer;
  }
  @Override
  public void run(String... </span><span class="koboSpan" id="kobo.1288.2">args) throws Exception {
    grpcServer.start();
    grpcServer.block();
  }
}</span></pre>
<p><span class="No-Break"><span class="koboSpan" id="kobo.1289.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/GrpcServerRunner.java</span></span></p>
<p><span class="koboSpan" id="kobo.1290.1">Here, you override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1291.1">CommandLineRunner</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1292.1">run()</span></strong><span class="koboSpan" id="kobo.1293.1"> method and call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">start</span></strong><span class="koboSpan" id="kobo.1295.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">block</span></strong><span class="koboSpan" id="kobo.1297.1"> methods. </span><span class="koboSpan" id="kobo.1297.2">Therefore, when you execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">jar</span></strong><span class="koboSpan" id="kobo.1299.1"> file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1300.1">GrpcServerRunner</span></strong><span class="koboSpan" id="kobo.1301.1"> will be executed using its </span><strong class="source-inline"><span class="koboSpan" id="kobo.1302.1">run()</span></strong><span class="koboSpan" id="kobo.1303.1"> method and will start the </span><span class="No-Break"><span class="koboSpan" id="kobo.1304.1">gRPC server.</span></span></p>
<p><span class="koboSpan" id="kobo.1305.1">Another thing to remember is that you have marked the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">GrpcServerRunner</span></strong><span class="koboSpan" id="kobo.1307.1"> class with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1308.1">@Profile</span></strong><span class="koboSpan" id="kobo.1309.1"> annotation with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1310.1">"!test"</span></strong><span class="koboSpan" id="kobo.1311.1"> value, which means that when the test profile is active, this class won’t be loaded, and hence </span><span class="No-Break"><span class="koboSpan" id="kobo.1312.1">not executed.</span></span></p>
<p><span class="koboSpan" id="kobo.1313.1">You are now done </span><a id="_idIndexMarker1014"/><span class="koboSpan" id="kobo.1314.1">with both service and server implementation, so let’s test the gRPC server in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1315.1">next subsection.</span></span></p>
<h2 id="_idParaDest-260"><a id="_idTextAnchor259"/><span class="koboSpan" id="kobo.1316.1">Testing the gRPC server</span></h2>
<p><span class="koboSpan" id="kobo.1317.1">First of all, you </span><a id="_idIndexMarker1015"/><span class="koboSpan" id="kobo.1318.1">need to set the active profile to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1319.1">test</span></strong><span class="koboSpan" id="kobo.1320.1"> in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.1321.1">test</span></strong><span class="koboSpan" id="kobo.1322.1"> classes because doing so will disable </span><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">GrpcServerRunner</span></strong><span class="koboSpan" id="kobo.1324.1">. </span><span class="koboSpan" id="kobo.1324.2">Let’s do this and test it, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1325.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1326.1">
@ActiveProfiles("test")@SpringBootTest
@TestMethodOrder(OrderAnnotation.class)
class ServerAppTests {
  @Autowired
  private ApplicationContext context;
  @Test
  @Order(1)
  void beanGrpcServerRunnerTest() {
    assertNotNull(context.getBean(GrpcServer.class));
    assertThrows(NoSuchBeanDefinitionException.class,
        () -&gt; context.getBean(GrpcServerRunner.class),
        "GrpcServerRunner should not be loaded during
          test");
  }
  // continue …</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/test/java/com/packt/modern/api/ServerAppTests.java"><span class="No-Break"><span class="koboSpan" id="kobo.1327.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/test/java/com/packt/modern/api/ServerAppTests.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1328.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1329.1">beanGrpcServerRunnerTest()</span></strong><span class="koboSpan" id="kobo.1330.1"> method tests the loading of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1331.1">GrpcServer</span></strong><span class="koboSpan" id="kobo.1332.1"> class and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">GrpcServerRunner</span></strong><span class="koboSpan" id="kobo.1334.1"> and the test should pass if the profile is </span><span class="No-Break"><span class="koboSpan" id="kobo.1335.1">set correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.1336.1">Now, let’s move on to test the </span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1">gRPC services.</span></span></p>
<p><span class="koboSpan" id="kobo.1338.1">The gRPC test library provides a special class, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1339.1">GrpcCleanupRule</span></strong><span class="koboSpan" id="kobo.1340.1">, that manages the shutdown of registered servers and channels gracefully. </span><span class="koboSpan" id="kobo.1340.2">You need to annotate it with the JUnit </span><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">@Rule</span></strong><span class="koboSpan" id="kobo.1342.1"> to make it effective. </span><span class="koboSpan" id="kobo.1342.2">The gRPC test library also provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1343.1">InProcessServerBuilder</span></strong><span class="koboSpan" id="kobo.1344.1"> builder class, which allows you to build the server, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1345.1">InProcessChannelBuilder</span></strong><span class="koboSpan" id="kobo.1346.1"> builder class, which allows you to build the channel. </span><span class="koboSpan" id="kobo.1346.2">These three classes are all you need to build and manage the server </span><span class="No-Break"><span class="koboSpan" id="kobo.1347.1">and channel.</span></span></p>
<p><span class="koboSpan" id="kobo.1348.1">Therefore, you first </span><a id="_idIndexMarker1016"/><span class="koboSpan" id="kobo.1349.1">need to declare the required instances and then set up the method so that the execution environment is available before you fire the requests to the gRPC </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1">Source</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1351.1"> service.</span></span></p>
<p><span class="koboSpan" id="kobo.1352.1">Let’s add the required class instances and test the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1353.1">setup()</span></strong><span class="koboSpan" id="kobo.1354.1"> method in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1355.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1356.1">
@Rulepublic final GrpcCleanupRule grpcCleanup = new
    GrpcCleanupRule();
private static
  SourceServiceGrpc.SourceServiceBlockingStub blockingStub;
@Autowired
private static String newlyCreatedSourceId = null;
@BeforeAll
public static void setup(@Autowired SourceService
      srcSrvc, @Autowired ChargeService chrgSrvc,
      @Autowired ExceptionInterceptor exceptionInterceptor)
      throws IOException {
 String </span><strong class="bold"><span class="koboSpan" id="kobo.1357.1">sName</span></strong><span class="koboSpan" id="kobo.1358.1"> = InProcessServerBuilder.generateName(); </span><strong class="bold"><span class="koboSpan" id="kobo.1359.1">// 1</span></strong><span class="koboSpan" id="kobo.1360.1">
 grpcCleanup.</span><strong class="bold"><span class="koboSpan" id="kobo.1361.1">register</span></strong><span class="koboSpan" id="kobo.1362.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.1363.1">InProcessServerBuilder</span></strong><span class="koboSpan" id="kobo.1364.1">
      .forName(sName).directExecutor().addService(srcSrvc)
      .intercept(exceptionInterceptor)
      .build().start());                               </span><strong class="bold"><span class="koboSpan" id="kobo.1365.1">// 2</span></strong><span class="koboSpan" id="kobo.1366.1">
 blockingStub = SourceServiceGrpc.newBlockingStub(
      grpcCleanup</span><strong class="bold"><span class="koboSpan" id="kobo.1367.1">.register</span></strong><span class="koboSpan" id="kobo.1368.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.1369.1">InProcessChannelBuilder</span></strong><span class="koboSpan" id="kobo.1370.1">
      .forName(sName).directExecutor().build()));      </span><strong class="bold"><span class="koboSpan" id="kobo.1371.1">// 3</span></strong><span class="koboSpan" id="kobo.1372.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.1373.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1374.1">setup</span></strong><span class="koboSpan" id="kobo.1375.1"> method creates the server and channel with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1376.1">Source</span></strong><span class="koboSpan" id="kobo.1377.1"> service. </span><span class="koboSpan" id="kobo.1377.2">Let’s understand each of the lines mentioned in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1378.1">setup()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1379.1"> method:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1380.1">Line 1</span></em><span class="koboSpan" id="kobo.1381.1"> generates the unique name of </span><span class="No-Break"><span class="koboSpan" id="kobo.1382.1">the server.</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1383.1">Line 2</span></em><span class="koboSpan" id="kobo.1384.1"> registers the newly created server and adds the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">Source</span></strong><span class="koboSpan" id="kobo.1386.1"> service and server interceptor to it. </span><span class="koboSpan" id="kobo.1386.2">We’ll discuss </span><strong class="source-inline"><span class="koboSpan" id="kobo.1387.1">ExceptionInterceptor</span></strong><span class="koboSpan" id="kobo.1388.1"> in the </span><em class="italic"><span class="koboSpan" id="kobo.1389.1">Coding for handling errors</span></em><span class="koboSpan" id="kobo.1390.1"> section. </span><span class="koboSpan" id="kobo.1390.2">Then, it starts the server for </span><span class="No-Break"><span class="koboSpan" id="kobo.1391.1">serving requests.</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1392.1">Line 3</span></em><span class="koboSpan" id="kobo.1393.1"> creates the blocking stub, which will be used as a client for making the calls to the server. </span><span class="koboSpan" id="kobo.1393.2">Here again, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1394.1">GrpcCleanUpRule</span></strong><span class="koboSpan" id="kobo.1395.1"> is used to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.1396.1">client channel.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1397.1">Once the setup is executed, it provides </span><a id="_idIndexMarker1017"/><span class="koboSpan" id="kobo.1398.1">us with the environment to carry out the tests. </span><span class="koboSpan" id="kobo.1398.2">Let’s test our first request, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1399.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1400.1">
@Test@Order(2)
@DisplayName("Creates source object using create RPC call")
public void SourceService_Create() {
  CreateSourceReq.Response response = </span><strong class="bold"><span class="koboSpan" id="kobo.1401.1">blockingStub.create</span></strong><span class="koboSpan" id="kobo.1402.1">(
     CreateSourceReq.newBuilder().setAmount(100)
     .setCurrency("USD").build());
  assertNotNull(response);
  assertNotNull(response.getSource());
  newlyCreatedSourceId = response.getSource().getId();
  assertEquals(100, response.getSource().getAmount());
  assertEquals("USD", response.getSource().getCurrency());
}</span></pre>
<p><span class="koboSpan" id="kobo.1403.1">All the complex aspects of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1404.1">setup()</span></strong><span class="koboSpan" id="kobo.1405.1"> method are complete. </span><span class="koboSpan" id="kobo.1405.2">These tests now look pretty simple. </span><span class="koboSpan" id="kobo.1405.3">You just use the blocking stub to make a call. </span><span class="koboSpan" id="kobo.1405.4">You create the request object and use the stub </span><a id="_idIndexMarker1018"/><span class="koboSpan" id="kobo.1406.1">to call the server. </span><span class="koboSpan" id="kobo.1406.2">Finally, validate the </span><span class="No-Break"><span class="koboSpan" id="kobo.1407.1">server responses.</span></span></p>
<p><span class="koboSpan" id="kobo.1408.1">Similarly, you can test the validation error, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1409.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1410.1">
@Test@Order(3)
@DisplayName("Throws exception when invalid source id is
     passed to retrieve RPC call")
public void SourceService_RetrieveForInvalidId() {
  Throwable </span><strong class="bold"><span class="koboSpan" id="kobo.1411.1">throwable</span></strong><span class="koboSpan" id="kobo.1412.1"> = assertThrows(
       StatusRuntimeException.class, () -&gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1413.1">blockingStub</span></strong><span class="koboSpan" id="kobo.1414.1">
       </span><strong class="bold"><span class="koboSpan" id="kobo.1415.1">.retrieve</span></strong><span class="koboSpan" id="kobo.1416.1">(SourceId.newBuilder().</span><strong class="bold"><span class="koboSpan" id="kobo.1417.1">setId("")</span></strong><span class="koboSpan" id="kobo.1418.1">.build()));
  assertEquals("INVALID_ARGUMENT: Invalid Source ID passed"
       , </span><strong class="bold"><span class="koboSpan" id="kobo.1419.1">throwable.getMessage()</span></strong><span class="koboSpan" id="kobo.1420.1">);
}</span></pre>
<p><span class="koboSpan" id="kobo.1421.1">You can also test for the valid response for source retrieval, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1422.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1423.1">
@Test@Order(4)
@DisplayName("Retrieves source obj created by
   createRPC call")
public void SourceService_Retrieve() {
  SourceId.Response response = blockingStub.retrieve
    (SourceId
      .newBuilder().setId(newlyCreatedSourceId).build());
  assertNotNull(response);
  assertNotNull(response.getSource());
  assertEquals(100, response.getSource().getAmount());
  assertEquals("USD", response.getSource().getCurrency());
}</span></pre>
<p><span class="koboSpan" id="kobo.1424.1">This is the way in which you can write the test for the gRPC server and test the exposed RPC calls. </span><span class="koboSpan" id="kobo.1424.2">You can use the </span><a id="_idIndexMarker1019"/><span class="koboSpan" id="kobo.1425.1">same approach to write the rest of the test cases. </span><span class="koboSpan" id="kobo.1425.2">After writing the test, you may have an idea of how the client is going to send the request to </span><span class="No-Break"><span class="koboSpan" id="kobo.1426.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.1427.1">We have not yet discussed the exception interceptor that we have used in both the server code and test. </span><span class="koboSpan" id="kobo.1427.2">Let’s discuss this in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1428.1">next section.</span></span></p>
<h1 id="_idParaDest-261"><a id="_idTextAnchor260"/><span class="koboSpan" id="kobo.1429.1">Coding for handling errors</span></h1>
<p><span class="koboSpan" id="kobo.1430.1">You may have already </span><a id="_idIndexMarker1020"/><span class="koboSpan" id="kobo.1431.1">gone through the theory-based </span><em class="italic"><span class="koboSpan" id="kobo.1432.1">Handling errors and error status codes </span></em><span class="koboSpan" id="kobo.1433.1"> section in </span><a href="B19349_10.xhtml#_idTextAnchor233"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1434.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.1435.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1436.1">Getting Started with gRPC</span></em><span class="koboSpan" id="kobo.1437.1">, where </span><strong class="source-inline"><span class="koboSpan" id="kobo.1438.1">google.rpc.Status</span></strong><span class="koboSpan" id="kobo.1439.1"> and gRPC status codes were discussed. </span><span class="koboSpan" id="kobo.1439.2">You may want to revisit that section before going through this section as here you are going to write the </span><span class="No-Break"><span class="koboSpan" id="kobo.1440.1">actual code.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1441.1">io.grpc.ServerInterceptor</span></strong><span class="koboSpan" id="kobo.1442.1"> is a thread-safe interface for intercepting incoming calls that can be used for cross-cutting calls, such as authentication and authorization, logging, and monitoring. </span><span class="koboSpan" id="kobo.1442.2">Let’s use it to write </span><strong class="source-inline"><span class="koboSpan" id="kobo.1443.1">ExceptionInterceptor</span></strong><span class="koboSpan" id="kobo.1444.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1445.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1446.1">
@Componentpublic class ExceptionInterceptor implements </span><strong class="bold"><span class="koboSpan" id="kobo.1447.1">ServerInterceptor</span></strong><span class="koboSpan" id="kobo.1448.1"> {
 @Override
 public &lt;RQT, RST&gt; ServerCall.Listener&lt;RQT&gt; interceptCall(
    ServerCall&lt;RQT, RST&gt; serverCall, Metadata
        metadata,
    ServerCallHandler&lt;RQT, RST&gt; serverCallHandler) 
   ServerCall.Listener&lt;RQT&gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1449.1">listener</span></strong><span class="koboSpan" id="kobo.1450.1"> = serverCallHandler
          .startCall(serverCall, metadata);
   return new </span><strong class="bold"><span class="koboSpan" id="kobo.1451.1">ExceptionHandlingServerCallListener</span></strong><span class="koboSpan" id="kobo.1452.1"> &lt;&gt;(
       listener, serverCall, metadata);
}
// continue …</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/interceptor/ExceptionInterceptor.java"><span class="No-Break"><span class="koboSpan" id="kobo.1453.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/interceptor/ExceptionInterceptor.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1454.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1455.1">RQT</span></strong><span class="koboSpan" id="kobo.1456.1"> represents the request type, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1457.1">RST</span></strong><span class="koboSpan" id="kobo.1458.1"> represents the </span><span class="No-Break"><span class="koboSpan" id="kobo.1459.1">response type.</span></span></p>
<p><span class="koboSpan" id="kobo.1460.1">We are going to </span><a id="_idIndexMarker1021"/><span class="koboSpan" id="kobo.1461.1">use it for exception intercepting. </span><span class="koboSpan" id="kobo.1461.2">An interceptor will pass the call to the server listener (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1462.1">ExceptionHandlingServerCallListener</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1463.1">). </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1464.1">ExceptionHandlingServer</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.1465.1"> CallListener</span></strong><span class="koboSpan" id="kobo.1466.1"> is a private class in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1467.1">ExceptionInterceptor</span></strong><span class="koboSpan" id="kobo.1468.1"> that extends the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1469.1">ForwardingServerCallListener. </span><span class="koboSpan" id="kobo.1469.2">SimpleForwardingServerCallListener</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1470.1">abstract class.</span></span></p>
<p><span class="koboSpan" id="kobo.1471.1">The private listener class has overridden events, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1472.1">onHalfClose()</span></strong><span class="koboSpan" id="kobo.1473.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1474.1">onReady()</span></strong><span class="koboSpan" id="kobo.1475.1">, which will catch the exception and pass the call to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1476.1">handleException()</span></strong><span class="koboSpan" id="kobo.1477.1"> method. </span><span class="koboSpan" id="kobo.1477.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1478.1">handleException()</span></strong><span class="koboSpan" id="kobo.1479.1"> method will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1480.1">ExceptionUtils</span></strong><span class="koboSpan" id="kobo.1481.1"> method to trace the actual exception and respond with error details. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1482.1">ExceptionUtils</span></strong><span class="koboSpan" id="kobo.1483.1"> returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.1484.1">StatusRuntimeException</span></strong><span class="koboSpan" id="kobo.1485.1">, which is used to close the server call with an </span><span class="No-Break"><span class="koboSpan" id="kobo.1486.1">error status.</span></span></p>
<p><span class="koboSpan" id="kobo.1487.1">Let’s see how </span><a id="_idIndexMarker1022"/><span class="koboSpan" id="kobo.1488.1">this flow looks in code in the next </span><span class="No-Break"><span class="koboSpan" id="kobo.1489.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1490.1">
private class ExceptionHandlingServerCallListener&lt;RQT, RST&gt;    extends ForwardingServerCallListener
        .SimpleForwardingServerCallListener&lt;RQT&gt; {
  private final ServerCall&lt;RQT, RST&gt; serverCall;
  private final Metadata metadata;
  ExceptionHandlingServerCallListener
      (ServerCall.Listener&lt;RQT&gt;
     lsnr,ServerCall&lt;RQT, RST&gt; serverCall, Metadata mdata) {
    super(lstnr);
    this.serverCall = serverCall;
    this.metadata = mdata;
  }
  @Override
  public void </span><strong class="bold"><span class="koboSpan" id="kobo.1491.1">onHalfClose</span></strong><span class="koboSpan" id="kobo.1492.1">() {
    try { super.onHalfClose();}
    catch (RuntimeException e) {
      </span><strong class="bold"><span class="koboSpan" id="kobo.1493.1">handleException</span></strong><span class="koboSpan" id="kobo.1494.1">(e, serverCall, metadata);
      throw e;
    }
  }
  @Override
  public void </span><strong class="bold"><span class="koboSpan" id="kobo.1495.1">onReady</span></strong><span class="koboSpan" id="kobo.1496.1">() {
    try { super.onReady();}
    catch (RuntimeException e) {
      </span><strong class="bold"><span class="koboSpan" id="kobo.1497.1">handleException</span></strong><span class="koboSpan" id="kobo.1498.1">(e, serverCall, metadata);
      throw e;
    }
  }
  private void handleException(RuntimeException e,
       ServerCall&lt;RQT, RST&gt; serverCall, Metadata metadata) {
    StatusRuntimeException status = </span><strong class="bold"><span class="koboSpan" id="kobo.1499.1">ExceptionUtils.traceException</span></strong><span class="koboSpan" id="kobo.1500.1">(e);
    serverCall.close(status.getStatus(), metadata);
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/interceptor/ExceptionInterceptor.java"><span class="No-Break"><span class="koboSpan" id="kobo.1501.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/interceptor/ExceptionInterceptor.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1502.1">Let’s write the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1">ExceptionUtils</span></strong><span class="koboSpan" id="kobo.1504.1"> class next to complete the exception-handling core components. </span><span class="koboSpan" id="kobo.1504.2">Then, you </span><a id="_idIndexMarker1023"/><span class="koboSpan" id="kobo.1505.1">can use these components in a service implementation to raise </span><span class="No-Break"><span class="koboSpan" id="kobo.1506.1">the exceptions.</span></span></p>
<p><span class="koboSpan" id="kobo.1507.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1508.1">ExceptionUtils</span></strong><span class="koboSpan" id="kobo.1509.1"> class will have two types of </span><span class="No-Break"><span class="koboSpan" id="kobo.1510.1">overloaded methods:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1511.1">observerError()</span></strong><span class="koboSpan" id="kobo.1512.1">: This method will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">StreamObserver</span></strong><span class="koboSpan" id="kobo.1514.1"> to raise the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1515.1">onError()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1516.1"> event</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1517.1">traceException()</span></strong><span class="koboSpan" id="kobo.1518.1">: This method will trace the error from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1519.1">Throwable</span></strong><span class="koboSpan" id="kobo.1520.1"> and return the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1521.1">StatusRuntimeException</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1522.1"> instance</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1523.1">You can use the </span><a id="_idIndexMarker1024"/><span class="koboSpan" id="kobo.1524.1">following code to write the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1525.1">ExceptionUtils</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1526.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1527.1">
@Componentpublic class ExceptionUtils {
private static final Logger LOG = LoggerFactory.getLogger
    (ExceptionInterceptor.class);
  public static StatusRuntimeException
      traceException(Throwable e) {
    return </span><strong class="bold"><span class="koboSpan" id="kobo.1528.1">traceException</span></strong><span class="koboSpan" id="kobo.1529.1">(e, null);
  }
  public static &lt;T extends GeneratedMessageV3&gt; void
    </span><strong class="bold"><span class="koboSpan" id="kobo.1530.1">observeError</span></strong><span class="koboSpan" id="kobo.1531.1">(StreamObserver&lt;T&gt;
        responseObserver, Throwable e) {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1532.1">responseObserver</span></strong><span class="koboSpan" id="kobo.1533.1">.</span><strong class="bold"><span class="koboSpan" id="kobo.1534.1">onError</span></strong><span class="koboSpan" id="kobo.1535.1">(traceException(e));
  }
  public static &lt;T extends GeneratedMessageV3&gt; void
    </span><strong class="bold"><span class="koboSpan" id="kobo.1536.1">observeError</span></strong><span class="koboSpan" id="kobo.1537.1">(StreamObserver&lt;T&gt; responseObserver,
       Exception
      e, T defaultInstance) {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1538.1">responseObserver</span></strong><span class="koboSpan" id="kobo.1539.1">.</span><strong class="bold"><span class="koboSpan" id="kobo.1540.1">onError</span></strong><span class="koboSpan" id="kobo.1541.1">(
        traceException(e, defaultInstance));
  }
  // Continue …</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/exception/ExceptionUtils.java"><span class="No-Break"><span class="koboSpan" id="kobo.1542.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/exception/ExceptionUtils.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1543.1">Here, you can see that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1544.1">observerError()</span></strong><span class="koboSpan" id="kobo.1545.1"> method is also calling </span><strong class="source-inline"><span class="koboSpan" id="kobo.1546.1">traceException()</span></strong><span class="koboSpan" id="kobo.1547.1"> internally </span><a id="_idIndexMarker1025"/><span class="koboSpan" id="kobo.1548.1">for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1549.1">onError</span></strong><span class="koboSpan" id="kobo.1550.1"> events. </span><span class="koboSpan" id="kobo.1550.2">Let’s write the last overloaded method, </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1551.1">traceException()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1552.1">, next:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1553.1">
public static &lt;T extends       com.google.protobuf.GeneratedMessageV3&gt;
         StatusRuntimeException traceException(
            Throwable e, T defaultInstance) {
  com.google.rpc.Status status;
  StatusRuntimeException statusRuntimeException;
  if (e instanceof StatusRuntimeException) {
    statusRuntimeException = (StatusRuntimeException) e;
  } else {
    Throwable cause = e;
    if (cause != null &amp;&amp; cause.getCause() != null &amp;&amp;
        cause.getCause() != cause) {
      cause = cause.getCause();
    }
    if (cause instanceof SocketException) {
      String errorMessage = "Sample exception message";
      status = com.google.rpc.Status.newBuilder()
          .setCode(com.google.rpc.Code.UNAVAILABLE_VALUE)
          .setMessage(errorMessage + cause.getMessage())
          .addDetails(Any.pack(defaultInstance))
          .build();
    } else {
      status = com.google.rpc.Status.newBuilder()
          .setCode(com.google.rpc.Code.INTERNAL_VALUE)
          .setMessage("Internal server error")
          .addDetails(Any.pack(defaultInstance))
          .build();
    }
    statusRuntimeException = StatusProto
         .toStatusRuntimeException(status);
  }
  return statusRuntimeException;
}</span></pre>
<p><span class="koboSpan" id="kobo.1554.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1555.1">SocketException</span></strong><span class="koboSpan" id="kobo.1556.1"> is shown by way of an example. </span><span class="koboSpan" id="kobo.1556.2">You can add a check for another kind of exception here. </span><span class="koboSpan" id="kobo.1556.3">You may notice that here we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1557.1">com.google .rpc.Status</span></strong><span class="koboSpan" id="kobo.1558.1"> to build the status. </span><span class="koboSpan" id="kobo.1558.2">Then, this instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1559.1">Status</span></strong><span class="koboSpan" id="kobo.1560.1"> is passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1">toStatusRuntimeException()</span></strong><span class="koboSpan" id="kobo.1562.1"> of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1563.1">StatusProto</span></strong><span class="koboSpan" id="kobo.1564.1">, which converts the status </span><span class="No-Break"><span class="koboSpan" id="kobo.1565.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1566.1">StatusRuntimeException</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1567.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1568.1">Let’s add the </span><a id="_idIndexMarker1026"/><span class="koboSpan" id="kobo.1569.1">validation error in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1570.1">DbStore</span></strong><span class="koboSpan" id="kobo.1571.1"> class to make use of these exception-handling components, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1572.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1573.1">
public SourceId.Response retrieveSource(String sourceId) {  if (</span><strong class="bold"><span class="koboSpan" id="kobo.1574.1">Strings.isBlank(sourceId)</span></strong><span class="koboSpan" id="kobo.1575.1">) {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1576.1">com.google.rpc.Status status</span></strong><span class="koboSpan" id="kobo.1577.1"> =
         com.google.rpc.Status.newBuilder()
        </span><strong class="bold"><span class="koboSpan" id="kobo.1578.1">.setCode(Code.INVALID_ARGUMENT.getNumber())</span></strong><span class="koboSpan" id="kobo.1579.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.1580.1">.setMessage("Invalid Source ID is</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1581.1">           passed.").build();</span></strong><span class="koboSpan" id="kobo.1582.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.1583.1">throw StatusProto.toStatusRuntimeException(status);</span></strong><span class="koboSpan" id="kobo.1584.1">
  }
  Source </span><strong class="bold"><span class="koboSpan" id="kobo.1585.1">source</span></strong><span class="koboSpan" id="kobo.1586.1"> = sourceEntities.get(sourceId);
  if (</span><strong class="bold"><span class="koboSpan" id="kobo.1587.1">Objects.isNull(source))</span></strong><span class="koboSpan" id="kobo.1588.1"> {
    com.google.rpc.Status status =
         com.google.rpc.Status.newBuilder()
        .setCode(Code.INVALID_ARGUMENT.getNumber())
        .setMessage("Requested source is not available")
        .addDetails(Any.pack(
           SourceId.Response.getDefaultInstance())
              ).build();
    </span><strong class="bold"><span class="koboSpan" id="kobo.1589.1">throw StatusProto.toStatusRuntimeException(status)</span></strong><span class="koboSpan" id="kobo.1590.1">;
  }
  return SourceId.Response.newBuilder()
        .setSource(source).build();
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/DbStore.java"><span class="No-Break"><span class="koboSpan" id="kobo.1591.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/repository/DbStore.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1592.1">You can similarly raise </span><strong class="source-inline"><span class="koboSpan" id="kobo.1593.1">StatusRuntimeException</span></strong><span class="koboSpan" id="kobo.1594.1"> in any part of the service implementation. </span><span class="koboSpan" id="kobo.1594.2">You </span><a id="_idIndexMarker1027"/><span class="koboSpan" id="kobo.1595.1">can also use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1596.1">addDetails()</span></strong><span class="koboSpan" id="kobo.1597.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1598.1">com.google.rpc.Status</span></strong><span class="koboSpan" id="kobo.1599.1"> to add more details to the error status, as shown in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1600.1">traceException(Throwable e, T </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1601.1">defaultInstance)</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1602.1"> code.</span></span></p>
<p><span class="koboSpan" id="kobo.1603.1">Finally, you can capture the error raised by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1604.1">retrieve()</span></strong><span class="koboSpan" id="kobo.1605.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1606.1">SourceService</span></strong><span class="koboSpan" id="kobo.1607.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1608.1">Service</span></strong><span class="koboSpan" id="kobo.1609.1"> implementation class, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1610.1">shown next:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1611.1">
@Overridepublic void retrieve(SourceId sourceId, StreamObserver&lt;SourceId.Response&gt; resObserver) {
  try {
    SourceId.Response resp =
                      repository.retrieve(sourceId.getId());
    resObserver.onNext(resp);
    resObserver.onCompleted();
  } catch (Exception e) {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1612.1">ExceptionUtils.observeError</span></strong><span class="koboSpan" id="kobo.1613.1">(resObserver, e,
                      SourceId.Response.getDefaultInstance());
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/service/SourceService.java"><span class="No-Break"><span class="koboSpan" id="kobo.1614.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/server/src/main/java/com/packt/modern/api/server/service/SourceService.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1615.1">Exception handling is </span><a id="_idIndexMarker1028"/><span class="koboSpan" id="kobo.1616.1">explained simply and constructively in this chapter. </span><span class="koboSpan" id="kobo.1616.2">You can enhance it more as per your </span><span class="No-Break"><span class="koboSpan" id="kobo.1617.1">application requirements.</span></span></p>
<p><span class="koboSpan" id="kobo.1618.1">Now, let’s write the gRPC client in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1619.1">next section.</span></span></p>
<h1 id="_idParaDest-262"><a id="_idTextAnchor261"/><span class="koboSpan" id="kobo.1620.1">Developing the gRPC client</span></h1>
<p><span class="koboSpan" id="kobo.1621.1">A client project’s directory </span><a id="_idIndexMarker1029"/><span class="koboSpan" id="kobo.1622.1">structure will look as follows. </span><span class="koboSpan" id="kobo.1622.2">The project root directory contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1623.1">build.gradle</span></strong><span class="koboSpan" id="kobo.1624.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">settings.gradle</span></strong><span class="koboSpan" id="kobo.1626.1"> files, as shown in the following directory </span><span class="No-Break"><span class="koboSpan" id="kobo.1627.1">tree structure:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1628.1">
├── client   ├── </span><strong class="bold"><span class="koboSpan" id="kobo.1629.1">build.gradle</span></strong><span class="koboSpan" id="kobo.1630.1">
   ├── gradle
   │   └── wrapper
   ├── gradlew
   ├── gradlew.bat
   ├── </span><strong class="bold"><span class="koboSpan" id="kobo.1631.1">settings.gradle</span></strong><span class="koboSpan" id="kobo.1632.1">
   └── src
       ├── main
       │   ├── java
       │   │   └── com
       │   │       └── packt
       │   │           └── modern
       │   │               └── api
       │   └── resources
       └── test
           └── java</span></pre>
<p><span class="koboSpan" id="kobo.1633.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1634.1">resources</span></strong><span class="koboSpan" id="kobo.1635.1"> directory will contain the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1636.1">application.properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1637.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.1638.1">Let’s perform the </span><a id="_idIndexMarker1030"/><span class="koboSpan" id="kobo.1639.1">following steps to configure </span><span class="No-Break"><span class="koboSpan" id="kobo.1640.1">the project:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1641.1">First, you need to modify the project name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1642.1">Chapter11/client/ settings.gradle</span></strong><span class="koboSpan" id="kobo.1643.1"> file to represent the server, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1644.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1645.1">
rootProject.name = 'chapter11-client'</span></pre></li> <li><span class="koboSpan" id="kobo.1646.1">Next, you can add the dependencies required for client projects to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1647.1">Chapter11/client/build.gradle</span></strong><span class="koboSpan" id="kobo.1648.1"> file. </span><span class="koboSpan" id="kobo.1648.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1649.1">grpc-stub</span></strong><span class="koboSpan" id="kobo.1650.1"> library provides the stubs-related APIs, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1651.1">protobuf-java-util</span></strong><span class="koboSpan" id="kobo.1652.1"> provides the utility methods for Protobuf and </span><span class="No-Break"><span class="koboSpan" id="kobo.1653.1">JSON conversions:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1654.1">
def grpcVersion = '1.54.1'dependencies {    implementation '</span><strong class="bold"><span class="koboSpan" id="kobo.1655.1">com.packt.modern.api:payment-</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1656.1">      gateway-api</span></strong><span class="koboSpan" id="kobo.1657.1">:0.0.1'    implementation "io.grpc:grpc-stub:${grpcVersion}"    implementation "com.google.protobuf:</span><strong class="bold"><span class="koboSpan" id="kobo.1658.1">protobuf-java-</span></strong><span class="koboSpan" id="kobo.1659.1">      </span><strong class="bold"><span class="koboSpan" id="kobo.1660.1">util</span></strong><span class="koboSpan" id="kobo.1661.1">:3.22.2"    implementation 'org.springframework.boot:      spring-boot-starter-web'    testImplementation 'org.springframework.boot:      spring-boot-starter-test'}</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/build.gradle"><span class="No-Break"><span class="koboSpan" id="kobo.1662.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/build.gradle</span></span></a></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1663.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1664.1">payment-gateway-api</span></strong><span class="koboSpan" id="kobo.1665.1"> dependency is published in the local Maven repository. </span><span class="koboSpan" id="kobo.1665.2">Therefore, you </span><a id="_idIndexMarker1031"/><span class="koboSpan" id="kobo.1666.1">need to add the local Maven repository to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1667.1">repositories</span></strong><span class="koboSpan" id="kobo.1668.1"> section, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1670.1">
repositories {  mavenCentral()  mavenLocal()}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1671.1">You are done with the Gradle configuration. </span><span class="koboSpan" id="kobo.1671.2">Now, you can write the </span><span class="No-Break"><span class="koboSpan" id="kobo.1672.1">gRPC client.</span></span></p>
<h2 id="_idParaDest-263"><a id="_idTextAnchor262"/><span class="koboSpan" id="kobo.1673.1">Implementing the gRPC client</span></h2>
<p><span class="koboSpan" id="kobo.1674.1">As you know, the </span><a id="_idIndexMarker1032"/><span class="koboSpan" id="kobo.1675.1">Spring Boot application runs on its own server. </span><span class="koboSpan" id="kobo.1675.2">Therefore, the client’s application port should be different from the gRPC server port. </span><span class="koboSpan" id="kobo.1675.3">Also, we need to provide the gRPC server host and port. </span><span class="koboSpan" id="kobo.1675.4">These can be configured </span><span class="No-Break"><span class="koboSpan" id="kobo.1676.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1677.1">application.properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1678.1">:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1679.1">server.port=8081</span></strong><span class="koboSpan" id="kobo.1680.1">grpc.server.host=localhost
grpc.server.port=8080</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/resources/application.properties"><span class="No-Break"><span class="koboSpan" id="kobo.1681.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/resources/application.properties</span></span></a></p>
<p><span class="koboSpan" id="kobo.1682.1">Next, let’s create the gRPC client. </span><span class="koboSpan" id="kobo.1682.2">This client will be used to configure the gRPC service stubs with </span><a id="_idIndexMarker1033"/><span class="koboSpan" id="kobo.1683.1">the channel. </span><span class="koboSpan" id="kobo.1683.2">The channel is responsible for providing the virtual connection to a conceptual endpoint in order to perform </span><span class="No-Break"><span class="koboSpan" id="kobo.1684.1">gRPC calls.</span></span></p>
<p><span class="koboSpan" id="kobo.1685.1">Create a new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1686.1">GrpcClient.java</span></strong><span class="koboSpan" id="kobo.1687.1">, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1688.1">client/src/main/com/packt/modern/api/client</span></strong><span class="koboSpan" id="kobo.1689.1"> directory and add the code shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1690.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1691.1">
@Componentpublic class GrpcClient {
  @Value("${grpc.server.host:localhost}")
  private String host;
  @Value("${grpc.server.port:8080}")
  private int port;
  private </span><strong class="bold"><span class="koboSpan" id="kobo.1692.1">ManagedChannel channel</span></strong><span class="koboSpan" id="kobo.1693.1">;
  private SourceServiceBlockingStub sourceServiceStub;
  private ChargeServiceBlockingStub chargeServiceStub;
  public void start() {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1694.1">channel = ManagedChannelBuilder.forAddress(host, port)</span></strong><span class="koboSpan" id="kobo.1695.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.1696.1">.usePlaintext().build()</span></strong><span class="koboSpan" id="kobo.1697.1">;
    sourceServiceStub = SourceServiceGrpc
         .newBlockingStub(</span><strong class="bold"><span class="koboSpan" id="kobo.1698.1">channel</span></strong><span class="koboSpan" id="kobo.1699.1">);
    chargeServiceStub = ChargeServiceGrpc
        .newBlockingStub(</span><strong class="bold"><span class="koboSpan" id="kobo.1700.1">channel</span></strong><span class="koboSpan" id="kobo.1701.1">);
  }
  public void shutdown() throws InterruptedException {
    channel.shutdown().awaitTermination
      (1, TimeUnit.SECONDS);
  }
  public SourceServiceBlockingStub getSourceServiceStub() {
    return this.sourceServiceStub;
  }
  public ChargeServiceBlockingStub getChargeServiceStub() {
    return this.chargeServiceStub;
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/java/com/packt/modern/api/client/GrpcClient.java"><span class="No-Break"><span class="koboSpan" id="kobo.1702.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/java/com/packt/modern/api/client/GrpcClient.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1703.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1704.1">start()</span></strong><span class="koboSpan" id="kobo.1705.1"> is the key that initialized the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1706.1">Source</span></strong><span class="koboSpan" id="kobo.1707.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1708.1">Charge</span></strong><span class="koboSpan" id="kobo.1709.1"> service stubs. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1710.1">ManagedChannelBuilder</span></strong><span class="koboSpan" id="kobo.1711.1"> is used to build </span><strong class="source-inline"><span class="koboSpan" id="kobo.1712.1">ManagedChannel</span></strong><span class="koboSpan" id="kobo.1713.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1714.1">ManagedChannel</span></strong><span class="koboSpan" id="kobo.1715.1"> is a channel that also provides life cycle management. </span><span class="koboSpan" id="kobo.1715.2">This managed channel is passed </span><span class="No-Break"><span class="koboSpan" id="kobo.1716.1">to stubs.</span></span></p>
<p><span class="koboSpan" id="kobo.1717.1">You are using </span><a id="_idIndexMarker1034"/><span class="koboSpan" id="kobo.1718.1">plain-text communication. </span><span class="koboSpan" id="kobo.1718.2">However, it also provides </span><span class="No-Break"><span class="koboSpan" id="kobo.1719.1">encrypted communication.</span></span></p>
<p><span class="koboSpan" id="kobo.1720.1">We are now done with the client’s code. </span><span class="koboSpan" id="kobo.1720.2">Now, we need to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1721.1">start()</span></strong><span class="koboSpan" id="kobo.1722.1"> method. </span><span class="koboSpan" id="kobo.1722.2">You are going to implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.1723.1">CommandLineRunner</span></strong><span class="koboSpan" id="kobo.1724.1"> the way it was implemented for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1725.1">GrpcServerRunner</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1726.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.1727.1">It can be implemented as </span><span class="No-Break"><span class="koboSpan" id="kobo.1728.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1729.1">
@Profile("!test")@Component
public class GrpcClientRunner implements CommandLineRunner {
  private static final Logger LOG = LoggerFactory.getLogger
     (GrpcClient.class);
  @Autowired
  GrpcClient client;
  @Override
  public void </span><strong class="bold"><span class="koboSpan" id="kobo.1730.1">run</span></strong><span class="koboSpan" id="kobo.1731.1">(String... </span><span class="koboSpan" id="kobo.1731.2">args) {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1732.1">client.start()</span></strong><span class="koboSpan" id="kobo.1733.1">;
    </span><strong class="bold"><span class="koboSpan" id="kobo.1734.1">Runtime.getRuntime().addShutdownHook</span></strong><span class="koboSpan" id="kobo.1735.1">(new Thread(() -&gt; {
      try {
        </span><strong class="bold"><span class="koboSpan" id="kobo.1736.1">client.shutdown()</span></strong><span class="koboSpan" id="kobo.1737.1">;
      } catch (InterruptedException e) {
        System.out.println("error: {}", e.getMessage());
      }
    }));
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/java/com/packt/modern/api/client/GrpcClientRunner.java"><span class="No-Break"><span class="koboSpan" id="kobo.1738.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/java/com/packt/modern/api/client/GrpcClientRunner.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1739.1">This will initiate the </span><a id="_idIndexMarker1035"/><span class="koboSpan" id="kobo.1740.1">stub instantiation following the start of the application. </span><span class="koboSpan" id="kobo.1740.2">You can then call the </span><span class="No-Break"><span class="koboSpan" id="kobo.1741.1">stub methods.</span></span></p>
<p><span class="koboSpan" id="kobo.1742.1">Now, to call the stub methods, let’s add a simple REST endpoint. </span><span class="koboSpan" id="kobo.1742.2">This will demonstrate how to use the charge service stub to call its </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1743.1">retrieve</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1744.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.1745.1">You can create </span><a id="_idIndexMarker1036"/><span class="koboSpan" id="kobo.1746.1">a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1747.1">ChargeController.java</span></strong><span class="koboSpan" id="kobo.1748.1"> file for the REST controller in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1749.1">src/main/java/com/packts/modern/api/controller</span></strong><span class="koboSpan" id="kobo.1750.1"> directory and add the code as </span><span class="No-Break"><span class="koboSpan" id="kobo.1751.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1752.1">
@RestControllerpublic class ChargeController {
  private final </span><strong class="bold"><span class="koboSpan" id="kobo.1753.1">GrpcClient client</span></strong><span class="koboSpan" id="kobo.1754.1">;
  public ChargeController(GrpcClient client) {
    this.client = client;
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.1755.1">@GetMapping("/charges")</span></strong><span class="koboSpan" id="kobo.1756.1">
  public String getSources(@RequestParam(defaultValue =
      "ab1ab2ab3ab4ab5") String customerId)
        throws InvalidProtocolBufferException {
    var req = CustomerId.newBuilder()
        .setId(customerId).build();
    CustomerId.Response resp =
       </span><strong class="bold"><span class="koboSpan" id="kobo.1757.1">client.getChargeServiceStub().retrieveAll(req)</span></strong><span class="koboSpan" id="kobo.1758.1">;
    var printer = </span><strong class="bold"><span class="koboSpan" id="kobo.1759.1">JsonFormat.printer()</span></strong><span class="koboSpan" id="kobo.1760.1">
         </span><strong class="bold"><span class="koboSpan" id="kobo.1761.1">.includingDefaultValueFields()</span></strong><span class="koboSpan" id="kobo.1762.1">;
      return printer.print(resp);
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/java/com/packt/modern/api/controller/ChargeController.java"><span class="No-Break"><span class="koboSpan" id="kobo.1763.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11/client/src/main/java/com/packt/modern/api/controller/ChargeController.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.1764.1">Here, we have created a REST endpoint, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1765.1">/charges</span></strong><span class="koboSpan" id="kobo.1766.1">. </span><span class="koboSpan" id="kobo.1766.2">This uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1767.1">GrpcClient</span></strong><span class="koboSpan" id="kobo.1768.1"> instance to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1769.1">retrieveAll()</span></strong><span class="koboSpan" id="kobo.1770.1"> RPC method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1771.1">Charge</span></strong><span class="koboSpan" id="kobo.1772.1"> gRPC service </span><span class="No-Break"><span class="koboSpan" id="kobo.1773.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1774.1">ChargeServiceStub</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1775.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1776.1">Then, the response </span><a id="_idIndexMarker1037"/><span class="koboSpan" id="kobo.1777.1">is converted into a JSON-formatted string using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1778.1">JsonFormat</span></strong><span class="koboSpan" id="kobo.1779.1"> class from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1780.1">protobuf-java-util</span></strong><span class="koboSpan" id="kobo.1781.1"> library and returned as a response. </span><span class="koboSpan" id="kobo.1781.2">Generated JSON-formatted strings will also contain the fields with </span><span class="No-Break"><span class="koboSpan" id="kobo.1782.1">default values.</span></span></p>
<p><span class="koboSpan" id="kobo.1783.1">We are done with our development. </span><span class="koboSpan" id="kobo.1783.2">Let’s now test the complete flow in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1784.1">next subsection.</span></span></p>
<h2 id="_idParaDest-264"><a id="_idTextAnchor263"/><span class="koboSpan" id="kobo.1785.1">Testing the gRPC service</span></h2>
<p><span class="koboSpan" id="kobo.1786.1">Make sure that </span><a id="_idIndexMarker1038"/><span class="koboSpan" id="kobo.1787.1">your gRPC server is up and running before testing the client. </span><span class="koboSpan" id="kobo.1787.2">It is assumed that the gRPC </span><strong class="source-inline"><span class="koboSpan" id="kobo.1788.1">api</span></strong><span class="koboSpan" id="kobo.1789.1"> project has been built and that its latest artifacts have been published to the local </span><span class="No-Break"><span class="koboSpan" id="kobo.1790.1">Maven repository:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1791.1">First, make sure that your </span><strong class="source-inline"><span class="koboSpan" id="kobo.1792.1">api</span></strong><span class="koboSpan" id="kobo.1793.1"> project library is published in the local Maven repository because it is required by both the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1794.1">server</span></strong><span class="koboSpan" id="kobo.1795.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1796.1">client</span></strong><span class="koboSpan" id="kobo.1797.1"> projects. </span><span class="koboSpan" id="kobo.1797.2">Skip to </span><em class="italic"><span class="koboSpan" id="kobo.1798.1">step 2</span></em><span class="koboSpan" id="kobo.1799.1"> if you have already published the library. </span><span class="koboSpan" id="kobo.1799.2">Java should be set to version 17. </span><span class="koboSpan" id="kobo.1799.3">Execute the following commands from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1800.1">api</span></strong><span class="koboSpan" id="kobo.1801.1"> root </span><span class="No-Break"><span class="koboSpan" id="kobo.1802.1">project directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1803.1"># Make sure to enable UTF-8 for file encoding because</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1804.1"># we are using UTF characters in Java files.</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1805.1">$ export JAVA_TOOL_OPTIONS="-Dfile.encoding=UTF8"</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1806.1">$ ./gradlew clean publishToMavenLocal</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1807.1">Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1808.1">BUILD SUCCESSFUL in 6s</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1809.1">10 actionable tasks: 10 executed</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1810.1">Then, start the server using the following command. </span><span class="koboSpan" id="kobo.1810.2">Run it from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1811.1">server</span></strong><span class="koboSpan" id="kobo.1812.1"> project’s root directory (Java should be set to </span><span class="No-Break"><span class="koboSpan" id="kobo.1813.1">version 17):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1814.1">// Server project root directory</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1815.1">$ ./gradlew clean build</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1816.1">$ java -jar build/libs/chapter11-server-0.0.1-SNAPSHOT.jar</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1817.1">… … …</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1818.1">com.packt.modern.api.server.GrpcServer   : gRPC server started and listening on port: 8080.</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1819.1">Next, start the </span><a id="_idIndexMarker1039"/><span class="koboSpan" id="kobo.1820.1">client using the following command in a new terminal window. </span><span class="koboSpan" id="kobo.1820.2">Run it from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1821.1">client</span></strong><span class="koboSpan" id="kobo.1822.1"> project’s root directory (Java should be set to </span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">version 17):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1824.1">// Client project root directory</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1825.1">$ ./gradlew clean build</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1826.1">$ java -jar build/libs/chapter11-client-0.0.1-SNAPSHOT.jar</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1827.1">… … …</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1828.1">INFO 68732 Tomcat initialized with port(s): 8081 (http)</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1829.1">INFO com.packt.modern.api.client.GrpcClient   : gRPC client connected to localhost:8080</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1830.1">Once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1831.1">server</span></strong><span class="koboSpan" id="kobo.1832.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1833.1">client</span></strong><span class="koboSpan" id="kobo.1834.1"> services are up and running, open a new terminal window and execute the following command (the output </span><span class="No-Break"><span class="koboSpan" id="kobo.1835.1">is truncated):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1836.1">// calls the client service's charges API endpoint</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1837.1">$ curl http://localhost:8081/charges</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1838.1">{</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1839.1">  "charge": [{</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1840.1">    "id": "cle9e9oam6gajkkeivjof5pploq89ncp",</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1841.1">    "amount": 1000,</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1842.1">    "amountCaptured": 0,</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1843.1">    …</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1844.1">    "created": "1679924425",</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1845.1">    "currency": "USD",</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1846.1">    "customerId": "ab1ab2ab3ab4ab5",</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1847.1">    "description": "Charge Description",</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1848.1">    …</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1849.1">    "receiptEmail": "receipt@email.com",</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1850.1">    …</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1851.1">    "status": "SUCCEEDED",</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1852.1">    "sourceId": "0ovjn4l6crgp9apr79bhpefme4dok3qf"</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1853.1">  }]</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1854.1">}</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1855.1">A REST endpoint is used for demonstration purposes only. </span><span class="koboSpan" id="kobo.1855.2">Similarly, you can use the gRPC client to call </span><a id="_idIndexMarker1040"/><span class="koboSpan" id="kobo.1856.1">other services and their methods. </span><span class="koboSpan" id="kobo.1856.2">gRPC is often used for inter-service communication, which is essential for microservice-based applications. </span><span class="koboSpan" id="kobo.1856.3">However, it can also be used for </span><span class="No-Break"><span class="koboSpan" id="kobo.1857.1">web-based communication.</span></span></p>
<p><span class="koboSpan" id="kobo.1858.1">Let’s learn a bit about microservices in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1859.1">next section.</span></span></p>
<h1 id="_idParaDest-265"><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.1860.1">Understanding microservice concepts</span></h1>
<p><span class="koboSpan" id="kobo.1861.1">Microservices are self-contained </span><a id="_idIndexMarker1041"/><span class="koboSpan" id="kobo.1862.1">lightweight processes that communicate over a network. </span><span class="koboSpan" id="kobo.1862.2">Microservices provide narrowly focused APIs to their consumers. </span><span class="koboSpan" id="kobo.1862.3">These APIs can be implemented using REST, gRPC, </span><span class="No-Break"><span class="koboSpan" id="kobo.1863.1">or events.</span></span></p>
<p><span class="koboSpan" id="kobo.1864.1">Microservices are not new—they have been around for many years. </span><span class="koboSpan" id="kobo.1864.2">For example, </span><em class="italic"><span class="koboSpan" id="kobo.1865.1">Stubby</span></em><span class="koboSpan" id="kobo.1866.1">, a general-purpose infrastructure </span><a id="_idIndexMarker1042"/><span class="koboSpan" id="kobo.1867.1">based on RPC, was used in Google data centers in the early 2000s to connect several services with and across </span><span class="No-Break"><span class="koboSpan" id="kobo.1868.1">data centers.</span></span></p>
<p><span class="koboSpan" id="kobo.1869.1">They have seen a recent rise in popularity and visibility. </span><span class="koboSpan" id="kobo.1869.2">Before microservices became popular, monolithic architectures were mainly used for developing on-premises and </span><span class="No-Break"><span class="koboSpan" id="kobo.1870.1">cloud-based applications.</span></span></p>
<p><span class="koboSpan" id="kobo.1871.1">A monolithic architecture allows the development of different components, such as presentation, </span><a id="_idIndexMarker1043"/><span class="koboSpan" id="kobo.1872.1">application logic, business logic, and </span><strong class="bold"><span class="koboSpan" id="kobo.1873.1">data access objects</span></strong><span class="koboSpan" id="kobo.1874.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1875.1">DAOs</span></strong><span class="koboSpan" id="kobo.1876.1">), and then you either </span><a id="_idIndexMarker1044"/><span class="koboSpan" id="kobo.1877.1">bundle them </span><a id="_idIndexMarker1045"/><span class="koboSpan" id="kobo.1878.1">together in an </span><strong class="bold"><span class="koboSpan" id="kobo.1879.1">enterprise archive</span></strong><span class="koboSpan" id="kobo.1880.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1881.1">EAR</span></strong><span class="koboSpan" id="kobo.1882.1">) or </span><strong class="bold"><span class="koboSpan" id="kobo.1883.1">web archive</span></strong><span class="koboSpan" id="kobo.1884.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1885.1">WAR</span></strong><span class="koboSpan" id="kobo.1886.1">) or store them in a single directory hierarchy (such as Rails </span><span class="No-Break"><span class="koboSpan" id="kobo.1887.1">or Node.js).</span></span></p>
<p><span class="koboSpan" id="kobo.1888.1">Many famous applications, such as Netflix, have been developed using a microservices architecture. </span><span class="koboSpan" id="kobo.1888.2">Moreover, eBay, Amazon, and Groupon have evolved from monolithic architectures into microservices architectures. </span><span class="koboSpan" id="kobo.1888.3">Nowadays, microservices-based application development is very </span><a id="_idIndexMarker1046"/><span class="koboSpan" id="kobo.1889.1">common. </span><span class="koboSpan" id="kobo.1889.2">The gRPC server that we have developed in this chapter could be called a microservice (obviously if you keep the scope of the server to either the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1890.1">Source</span></strong><span class="koboSpan" id="kobo.1891.1"> service or </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1892.1">Charge</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1893.1"> server).</span></span></p>
<p><span class="koboSpan" id="kobo.1894.1">Let’s have a look at simple monolithic and microservices application designs in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1895.1">next subsection.</span></span></p>
<p><span class="koboSpan" id="kobo.1896.1">In this section, we will take a look at the different system designs, which are designed using a monolithic design, an SOA monolithic design, and a microservices design. </span><span class="koboSpan" id="kobo.1896.2">Let’s discuss each of these </span><span class="No-Break"><span class="koboSpan" id="kobo.1897.1">in turn.</span></span></p>
<h2 id="_idParaDest-266"><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.1898.1">Traditional monolithic design</span></h2>
<p><span class="koboSpan" id="kobo.1899.1">The following diagram </span><a id="_idIndexMarker1047"/><span class="koboSpan" id="kobo.1900.1">depicts the traditional monolithic application design. </span><span class="koboSpan" id="kobo.1900.2">This </span><a id="_idIndexMarker1048"/><span class="koboSpan" id="kobo.1901.1">design was widely used before SOA </span><span class="No-Break"><span class="koboSpan" id="kobo.1902.1">became popular:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer045">
<span class="koboSpan" id="kobo.1903.1"><img alt="Figure 11.1 – Traditional monolithic application design" src="image/Figure_11.1_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1904.1">Figure 11.1 – Traditional monolithic application design</span></p>
<p><span class="koboSpan" id="kobo.1905.1">In a traditional monolithic design, everything is bundled in the same archive (all the presentation code is </span><a id="_idIndexMarker1049"/><span class="koboSpan" id="kobo.1906.1">bundled in with the presentation </span><a id="_idIndexMarker1050"/><span class="koboSpan" id="kobo.1907.1">archive, the application logic goes into the application logic archive, and so on), regardless of how it all interacts with the database files or </span><span class="No-Break"><span class="koboSpan" id="kobo.1908.1">other sources.</span></span></p>
<h2 id="_idParaDest-267"><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.1909.1">Monolithic design with services</span></h2>
<p><span class="koboSpan" id="kobo.1910.1">After SOA, applications </span><a id="_idIndexMarker1051"/><span class="koboSpan" id="kobo.1911.1">started being developed based on services, where each component provides services to other components or external entities. </span><span class="koboSpan" id="kobo.1911.2">The following diagram depicts a monolithic application with different services; here, services are being used with a presentation component. </span><span class="koboSpan" id="kobo.1911.3">All services, the presentation component, or any other components are </span><span class="No-Break"><span class="koboSpan" id="kobo.1912.1">bundled together:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer046">
<span class="koboSpan" id="kobo.1913.1"><img alt="Figure 11.2 – Monolithic design with services" src="image/Figure_11.2_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1914.1">Figure 11.2 – Monolithic design with services</span></p>
<p><span class="koboSpan" id="kobo.1915.1">So, everything is bundled together in the form of EAR with a modules approach. </span><span class="koboSpan" id="kobo.1915.2">A few SOA services may </span><a id="_idIndexMarker1052"/><span class="koboSpan" id="kobo.1916.1">be deployed separately, but overall, it will be monolithic. </span><span class="koboSpan" id="kobo.1916.2">However, the database is shared across </span><span class="No-Break"><span class="koboSpan" id="kobo.1917.1">the services.</span></span></p>
<h2 id="_idParaDest-268"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.1918.1">Microservices design</span></h2>
<p><span class="koboSpan" id="kobo.1919.1">The following diagram depicts the microservices design. </span><span class="koboSpan" id="kobo.1919.2">Here, each component is autonomous. </span><span class="koboSpan" id="kobo.1919.3">Each </span><a id="_idIndexMarker1053"/><span class="koboSpan" id="kobo.1920.1">component can be developed, built, tested, and deployed independently. </span><span class="koboSpan" id="kobo.1920.2">Here, even the application’s UI component could also be a client and consume the microservices. </span><span class="koboSpan" id="kobo.1920.3">For our example, the layer designed is used within </span><span class="No-Break"><span class="koboSpan" id="kobo.1921.1">the microservice.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer047">
<span class="koboSpan" id="kobo.1922.1"><img alt="Figure 11.3 – Microservices design" src="image/Figure_11.3_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1923.1">Figure 11.3 – Microservices design</span></p>
<p><span class="koboSpan" id="kobo.1924.1">The API gateway provides an interface where different clients can access the individual services and solve various problems, such as what to do when you want to send different responses to </span><a id="_idIndexMarker1054"/><span class="koboSpan" id="kobo.1925.1">different clients for the same service. </span><span class="koboSpan" id="kobo.1925.2">For example, a booking service could send different responses to a mobile client (minimal information) and a desktop client (detailed information), providing different details to each, before providing something different again to a </span><span class="No-Break"><span class="koboSpan" id="kobo.1926.1">third-party client.</span></span></p>
<p><span class="koboSpan" id="kobo.1927.1">A response may require the fetching of information from two or </span><span class="No-Break"><span class="koboSpan" id="kobo.1928.1">more services.</span></span></p>
<p><span class="koboSpan" id="kobo.1929.1">Each API service will be developed and deployed as a separate process and communication among these will happen based on </span><span class="No-Break"><span class="koboSpan" id="kobo.1930.1">exposed APIs.</span></span></p>
<p><span class="koboSpan" id="kobo.1931.1">For a sample e-commerce app, you can divide the application based on domains and bounded context </span><a id="_idIndexMarker1055"/><span class="koboSpan" id="kobo.1932.1">and then develop a separate microservice for each of the domains. </span><span class="koboSpan" id="kobo.1932.2">The following is a brief list of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1933.1">provided microservices:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1934.1">Customers</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1935.1">Orders</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1936.1">Billing</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1937.1">Shipping</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1938.1">Invoicing</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1939.1">Inventory</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1940.1">Payment collection</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1941.1">You can develop each of these separately and use inter-process (inter-service) communication to stitch the </span><span class="No-Break"><span class="koboSpan" id="kobo.1942.1">solution together.</span></span></p>
<h1 id="_idParaDest-269"><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.1943.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1944.1">In this chapter, you explored Protobuf and gRPC-based service implementation. </span><span class="koboSpan" id="kobo.1944.2">You developed the gRPC server and then consumed its services by developing a gRPC client. </span><span class="koboSpan" id="kobo.1944.3">You learned about unit-testing the gRPC server and handling exceptions for gRPC-based services, and you also learned about the basic concepts </span><span class="No-Break"><span class="koboSpan" id="kobo.1945.1">of microservices.</span></span></p>
<p><span class="koboSpan" id="kobo.1946.1">You now have the skills to develop gRPC-based services (servers) and clients by defining the services </span><span class="No-Break"><span class="koboSpan" id="kobo.1947.1">using Protobuf.</span></span></p>
<p><span class="koboSpan" id="kobo.1948.1">In the next chapter, you will learn about distributed logging and tracing in </span><span class="No-Break"><span class="koboSpan" id="kobo.1949.1">web services.</span></span></p>
<h1 id="_idParaDest-270"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.1950.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.1951.1">Why should you use gRPC for binary large object transfers </span><span class="No-Break"><span class="koboSpan" id="kobo.1952.1">via HTTP/2?</span></span></li>
<li><span class="koboSpan" id="kobo.1953.1">You have implemented exception handling using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1954.1">com.google.rpc.Status</span></strong><span class="koboSpan" id="kobo.1955.1">. </span><span class="koboSpan" id="kobo.1955.2">Can you do so without </span><span class="No-Break"><span class="koboSpan" id="kobo.1956.1">using this?</span></span></li>
<li><span class="koboSpan" id="kobo.1957.1">What is the difference between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1958.1">com.google.rpc.Status</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1959.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1960.1">io.grpc.Status</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1961.1">?</span></span></li>
</ol>
<h1 id="_idParaDest-271"><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.1962.1">Answers</span></h1>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1963.1">Because, unlike HTTP libraries, gRPC libraries also provide the </span><span class="No-Break"><span class="koboSpan" id="kobo.1964.1">following features:</span></span><ul><li><span class="koboSpan" id="kobo.1965.1">Interaction with flow control at the </span><span class="No-Break"><span class="koboSpan" id="kobo.1966.1">application layer</span></span></li><li><span class="koboSpan" id="kobo.1967.1">Cascading </span><span class="No-Break"><span class="koboSpan" id="kobo.1968.1">call cancellation</span></span></li><li><span class="koboSpan" id="kobo.1969.1">Load balancing </span><span class="No-Break"><span class="koboSpan" id="kobo.1970.1">and failover</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.1971.1">Yes, you can. </span><span class="koboSpan" id="kobo.1971.2">You can use the metadata shown in the following code block. </span><span class="koboSpan" id="kobo.1971.3">However, making use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1972.1">com.google.rpc.Status</span></strong><span class="koboSpan" id="kobo.1973.1"> allows you to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1974.1">details</span></strong><span class="koboSpan" id="kobo.1975.1"> (with a type of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1976.1">Any</span></strong><span class="koboSpan" id="kobo.1977.1">) object, which can capture </span><span class="No-Break"><span class="koboSpan" id="kobo.1978.1">more information:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1979.1">
Metadata.Key&lt;SourceId.Response&gt; key = ProtoUtils    .keyForProto(SourceId.Response. </span><span class="koboSpan" id="kobo.1979.2">getDefaultInstance);Metadata metadata = new Metadata();metadata.put(key, sourceIdResponse);respObserver.onError(Status.INVALID_ARGUMENT   .withDescription("Invalid Source ID")   .asRuntimeException(metadata));</span></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.1980.1">com.google.rpc.Status</span></strong><span class="koboSpan" id="kobo.1981.1"> can include details of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1982.1">Any</span></strong><span class="koboSpan" id="kobo.1983.1"> type, which can be used to provide more error details. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1984.1">io.grpc.Status</span></strong><span class="koboSpan" id="kobo.1985.1"> does not have a field that contains the error details. </span><span class="koboSpan" id="kobo.1985.2">You must rely on another class’s metadata to provide the error-related details, which may or may not contain only error </span><span class="No-Break"><span class="koboSpan" id="kobo.1986.1">specific information.</span></span></li>
</ol>
<h1 id="_idParaDest-272"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.1987.1">Further reading</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.1988.1">Protobuf version 3 </span><span class="No-Break"><span class="koboSpan" id="kobo.1989.1">documentation: </span></span><a href="https://developers.google.com/protocol-buffers/docs/proto3"><span class="No-Break"><span class="koboSpan" id="kobo.1990.1">https://developers.google.com/protocol-buffers/docs/proto3</span></span></a></li>
<li><span class="koboSpan" id="kobo.1991.1">Protobuf’s well-known </span><span class="No-Break"><span class="koboSpan" id="kobo.1992.1">types: </span></span><a href="https://developers.google.com/protocol-buffers/docs/reference/google.protobuf"><span class="No-Break"><span class="koboSpan" id="kobo.1993.1">https://developers.google.com/protocol-buffers/docs/reference/google.protobuf</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1994.1">Practical </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1995.1">gRPC</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1996.1">: </span></span><a href="https://www.packtpub.com/in/web-development/practical-grpc"><span class="No-Break"><span class="koboSpan" id="kobo.1997.1">https://www.packtpub.com/in/web-development/practical-grpc</span></span></a></li>
</ul>
</div>
</body></html>