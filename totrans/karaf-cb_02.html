<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Making Smart Routers with Apache Camel"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Making Smart Routers with Apache Camel</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing Apache Camel modules into Apache Karaf</li><li class="listitem" style="list-style-type: disc">Listing Camel Contexts in Karaf</li><li class="listitem" style="list-style-type: disc">Displaying Camel Context information in Karaf</li><li class="listitem" style="list-style-type: disc">Starting and stopping Camel Contexts in Karaf</li><li class="listitem" style="list-style-type: disc">Listing routes in Karaf</li><li class="listitem" style="list-style-type: disc">Displaying route information in Karaf</li><li class="listitem" style="list-style-type: disc">Starting, stopping, suspending, and resuming routes in Karaf</li><li class="listitem" style="list-style-type: disc">Listing endpoints in Karaf</li><li class="listitem" style="list-style-type: disc">Making a pure Java-based Camel Router for deployment in Karaf</li><li class="listitem" style="list-style-type: disc">Creating a Blueprint-based Camel Router for deployment in Karaf</li><li class="listitem" style="list-style-type: disc">Adding Configuration Admin to a Blueprint-based Camel Router</li><li class="listitem" style="list-style-type: disc">Creating a managed service factory implementation of a Camel Router</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Introduction</h1></div></div></div><p>Apache Karaf provides a friendly OSGi-based container environment to deploy, manage, and most importantly, enjoy your applications. One of the more common projects to be hosted on Karaf is the Apache Camel-based router. In this chapter, we'll explore recipes to help make using Camel on Karaf quick, easy, and fun.</p><p>Before we proceed, let's take a closer look at Apache Camel.</p><p>Apache Camel provides a rule-based routing and mediation engine for Java, implementing <a id="id78" class="indexterm"/>
<span class="strong"><strong>Enterprise Integration Patterns</strong></span> (<span class="strong"><strong>EIPs</strong></span>) as described in <span class="emphasis"><em>Enterprise Integration Patterns: Designing, Building, and Deploying Messaging Solutions</em></span>, <span class="emphasis"><em>Gregor Hohpe and Bobby Woolf</em></span>, <span class="emphasis"><em>Addison Wesley</em></span>. One of the<a id="id79" class="indexterm"/> key features of the Camel library is its domain-specific language to configure routers and mediation. This allows for type-safe completion of rules in an integrated development environment, thereby greatly saving time and reducing complexity.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>The purpose of this chapter is to explore the Apache Camel-Apache Karaf integration. For more in-depth exploration of Enterprise Integration Patterns and Camel, read <span class="emphasis"><em>Apache Camel Developer's Cookbook</em></span>, <span class="emphasis"><em>Instant Apache Camel Messaging System</em></span>, or <span class="emphasis"><em>Instant Apache Camel Message Routing</em></span>, all by Packt Publishing.</p></div></div></div></div>
<div class="section" title="Installing Apache Camel modules into Apache Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Installing Apache Camel modules into Apache Karaf</h1></div></div></div><p>Before <a id="id80" class="indexterm"/>we can begin to explore <a id="id81" class="indexterm"/>how to build Camel-Karaf smart routers, we must first install all the required Camel modules into the Karaf container.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec38"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, and Internet connectivity.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec39"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we add an URL to the Camel feature to our Karaf installation feature repository using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; feature:repo-add mvn:org.apache.camel.karaf/apache-camel/2.12.2/xml/features</strong></span>
<span class="strong"><strong> Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.12.2/xml/features</strong></span>
<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>Alternatively, you can use the <code class="literal">feature:repo-add camel 2.12.2</code> command.</p></div></div><p>Upon adding the feature URL, Karaf will then be ready to install all Apache Camel dependencies. If you'd like to see all of the install targets, issue the <code class="literal">feature:list | grep –i camel</code> command.</p></li><li class="listitem">The next step is installing the base Camel feature into Karaf. We install a feature by executing the <code class="literal">feature:install</code> command and the feature's name, as shown in the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt;  feature:install camel</strong></span>
</pre></div><p>We can verify the installation by executing the <code class="literal">list –t 0 | grep camel</code> command, which will list all the installed Camel components in Karaf (camel-core, camel-karaf-commands, camel-spring, and camel-blueprint).</p></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec40"/>How it works…</h2></div></div></div><p>The <a id="id82" class="indexterm"/>Apache Camel community<a id="id83" class="indexterm"/> maintains an Apache Karaf features descriptor for each release of their project. When the descriptor file is added (using the <code class="literal">feature:repo-add</code> command) to Karaf, the container processes its <a id="id84" class="indexterm"/>content, making each feature's target available to be installed. The following diagram shows how various Camel bundles are deployed on top of a base Karaf system:</p><div class="mediaobject"><img src="graphics/5081OS_02_01.jpg" alt="How it works…"/></div><p>When a particular feature, in this case Camel, is installed (using the <code class="literal">feature:install</code> command), Karaf will use the appropriate URL handlers to obtain the required resources and install them into the container, and will then attempt to bring them to a <code class="literal">Started</code> state. If you execute <code class="literal">list –t 0</code> on the Karaf console, you will see Camel and all other artifacts deployed into the container. We can depict the integration of Camel components into Karaf more simply by illustrating the key Camel artifacts being deployed <a id="id85" class="indexterm"/>atop<a id="id86" class="indexterm"/> a standard Karaf installation.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec41"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Deploying applications as a feature</em></span> recipe of <a class="link" href="ch01.html" title="Chapter 1. Apache Karaf for System Builders">Chapter 1</a>, <span class="emphasis"><em>Apache Karaf for System Builders</em></span></li></ul></div></div></div>
<div class="section" title="Listing Camel Contexts in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Listing Camel Contexts in Karaf</h1></div></div></div><p>The<a id="id87" class="indexterm"/> installation of Apache Camel into Apache <a id="id88" class="indexterm"/>Karaf includes a set of custom Camel commands as part of the <code class="literal">camel-karaf-commands</code> bundle. The Camel community has developed and maintained these commands for the benefit of Karaf users, and as such have helped to fully integrate Camel into the Karaf experience. These commands are listed in the following screenshot:</p><div class="mediaobject"><img src="graphics/5081OS_02_02.jpg" alt="Listing Camel Contexts in Karaf"/></div><p>As of Apache Camel 2.12.2, there are 18 Camel-Karaf commands (as shown in the previous screenshot), and in the following recipes, we'll explore the most commonly used commands.</p><p>One common task Camel users want to perform is to list all of the Camel Contexts deployed into a Karaf container.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec42"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor.</p><p>A sample Camel application has been developed for this recipe, and is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe2">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe2</a>. Building the application requires executing a Maven install and then deploying the assembled bundle into Karaf (using the <code class="literal">install –s mvn:com.packt/sample</code> command).</p><p>Follow<a id="id89" class="indexterm"/> the instructions in the <span class="emphasis"><em>Installing Apache Camel modules into Apache Karaf</em></span> recipe to provide the base requirements to operate<a id="id90" class="indexterm"/> the sample code. We'll reuse this recipe's resources several times.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec43"/>How to do it…</h2></div></div></div><p>To list all of the Camel Contexts deployed in Karaf, execute the <code class="literal">camel:context-list</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:context-list</strong></span>
<span class="strong"><strong> Context               Status         Uptime             </strong></span>
<span class="strong"><strong> -------               ------         ------             </strong></span>
<span class="strong"><strong> CamelCommandContext   Started        1 hour 44 minutes  </strong></span>
<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div><p>In the previous command invocation, we observe the sample Camel Router's context name displayed (in this example, the context name was set in Blueprint—see the recipe's source code for details).</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec44"/>How it works…</h2></div></div></div><p>When the <code class="literal">camel-karaf-commands</code> bundle is installed into Karaf via the Camel feature, the Camel commands become automatically available on the Karaf console. Under the hood, the Camel command Blueprint descriptor is instantiated and the various Camel-Karaf commands are wired into the container.</p><p>When the <code class="literal">context-list</code> command is executed, the context IDs of each Camel Context deployed is displayed along with their current status, and if available, their uptime.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec45"/>There's more…</h2></div></div></div><p>The Apache <a id="id91" class="indexterm"/>Camel community maintains updated information on their commands, which you can find at <a class="ulink" href="http://camel.apache.org/karaf.html">http://camel.apache.org/karaf.html</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec46"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Displaying Camel Context information in Karaf</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Displaying Camel Context information in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Displaying Camel Context information in Karaf</h1></div></div></div><p>Karaf can <a id="id92" class="indexterm"/>display detailed<a id="id93" class="indexterm"/> information about individual Camel Contexts deployed in the container using the <code class="literal">camel:context-info</code> command. Context-wide statistics, behaviors, contained components, and more can be discovered using this command.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec47"/>Getting ready</h2></div></div></div><p>Follow the instructions in the <span class="emphasis"><em>Listing Camel Contexts in Karaf</em></span> recipe's <span class="emphasis"><em>Getting ready</em></span> section for this recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec48"/>How to do it…</h2></div></div></div><p>Use the following <code class="literal">camel:context-info</code> command on the Karaf console to retrieve context information—a small warning, there may be a lot of output generated:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:context-info CamelCommandContext </strong></span>
</pre></div><p>The output will be as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Camel Context CamelCommandContext</strong></span>
<span class="strong"><strong>  Name: CamelCommandContext</strong></span>
<span class="strong"><strong>  ManagementName: 123-CamelCommandContext</strong></span>
<span class="strong"><strong>  Version: 2.12.2</strong></span>
<span class="strong"><strong>  Status: Started</strong></span>
<span class="strong"><strong>  Uptime: 1 hour 50 minutes</strong></span>
<span class="strong"><strong>Statistics</strong></span>
<span class="strong"><strong>  Exchanges Total: 1321</strong></span>
<span class="strong"><strong>  Exchanges Completed: 1321</strong></span>
<span class="strong"><strong>  Exchanges Failed: 0</strong></span>
<span class="strong"><strong>  Min Processing Time: 0ms</strong></span>
<span class="strong"><strong>  Max Processing Time: 6ms</strong></span>
<span class="strong"><strong>  Mean Processing Time: 0ms</strong></span>
<span class="strong"><strong>  Total Processing Time: 1110ms</strong></span>
<span class="strong"><strong>  Last Processing Time: 1ms</strong></span>
<span class="strong"><strong>  Delta Processing Time: 0ms</strong></span>
<span class="strong"><strong>  Load Avg: 0.00, 0.00, 0.00</strong></span>
<span class="strong"><strong>  Reset Statistics Date: 2014-02-27 16:01:41</strong></span>
<span class="strong"><strong>  First Exchange Date: 2014-02-27 16:01:42</strong></span>
<span class="strong"><strong>  Last Exchange Completed Date: 2014-02-27 17:51:43</strong></span>
<span class="strong"><strong>  Number of running routes: 1</strong></span>
<span class="strong"><strong>  Number of not running routes: 0</strong></span>

<span class="strong"><strong>Miscellaneous</strong></span>
<span class="strong"><strong>  Auto Startup: true</strong></span>
<span class="strong"><strong>  Starting Routes: false</strong></span>
<span class="strong"><strong>  Suspended: false</strong></span>
<span class="strong"><strong>  Shutdown timeout: 300 sec.</strong></span>
<span class="strong"><strong>  Message History: true</strong></span>
<span class="strong"><strong>  Tracing: false</strong></span>

<span class="strong"><strong>Properties</strong></span>

<span class="strong"><strong>Advanced</strong></span>
<span class="strong"><strong>  ClassResolver: org.apache.camel.core.osgi.OsgiClassResolver@2ffd5a29</strong></span>
<span class="strong"><strong>  PackageScanClassResolver: org.apache.camel.core.osgi.OsgiPackageScanClassResolver@222a525c</strong></span>
<span class="strong"><strong>  ApplicationContextClassLoader: BundleDelegatingClassLoader(sample [123])</strong></span>
<span class="strong"><strong>Components</strong></span>
<span class="strong"><strong>  mock</strong></span>
<span class="strong"><strong>  bean</strong></span>
<span class="strong"><strong>  timer</strong></span>
<span class="strong"><strong>  properties</strong></span>

<span class="strong"><strong>Dataformats</strong></span>

<span class="strong"><strong>Languages</strong></span>
<span class="strong"><strong>  simple</strong></span>

<span class="strong"><strong>Routes</strong></span>
<span class="strong"><strong>  CamelRoute-timerToLog</strong></span>
</pre></div><p>The <a id="id94" class="indexterm"/>preceding <code class="literal">camel:context-info</code> invocation <a id="id95" class="indexterm"/>demonstrates that a large quantity of data is available about each context; it is not uncommon for users to capture this output for analysis.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec49"/>How it works…</h2></div></div></div><p>The <code class="literal">context-info</code> command <a id="id96" class="indexterm"/>hooks into Camel's own facilities to access context information. Upon retrieval, the data is then formatted for display on Karaf's console.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec50"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <a id="id97" class="indexterm"/><span class="emphasis"><em>Starting and </em></span><a id="id98" class="indexterm"/><span class="emphasis"><em>stopping Camel Contexts in Karaf</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Starting and stopping Camel Contexts in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Starting and stopping Camel Contexts in Karaf</h1></div></div></div><p>Starting<a id="id99" class="indexterm"/> and stopping the bundle that <a id="id100" class="indexterm"/>contains a Camel Context can be<a id="id101" class="indexterm"/> very<a id="id102" class="indexterm"/> clumsy; you can use the <code class="literal">camel:context-start</code> and <code class="literal">camel:context-stop</code> commands to manage specific contexts.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec51"/>Getting ready</h2></div></div></div><p>Follow the instructions under the <span class="emphasis"><em>Listing Camel Contexts in Karaf</em></span> recipe's <span class="emphasis"><em>Getting ready</em></span> section for this recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec52"/>How to do it…</h2></div></div></div><p>Managing Camel Contexts in Karaf is easy, but requires you to become familiar with two commands, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">camel:context-start contextName</code>: This<a id="id103" class="indexterm"/> command is used to start a context</li><li class="listitem" style="list-style-type: disc"><code class="literal">camel:context-stop contextName</code>: This <a id="id104" class="indexterm"/>command is used to stop a context</li></ul></div><p>The following Camel command invocations demonstrate the result of stopping a context:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:context-list</strong></span>
<span class="strong"><strong> Context               Status         Uptime         </strong></span>
<span class="strong"><strong> -------               ------         ------         </strong></span>
<span class="strong"><strong> CamelCommandContext   Started        3.139 seconds  </strong></span>
<span class="strong"><strong>karaf@root()&gt; camel:context-stop CamelCommandContext </strong></span>
<span class="strong"><strong>karaf@root()&gt; camel:context-list</strong></span>
<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec53"/>How it works…</h2></div></div></div><p>The context commands operate on the Camel framework and do not represent the OSGi life <a id="id105" class="indexterm"/>cycle. Depending<a id="id106" class="indexterm"/> upon <a id="id107" class="indexterm"/>your<a id="id108" class="indexterm"/> application, a stopped context may result in the need to restart its host bundle.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec54"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Listing routes in Karaf</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Listing routes in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Listing routes in Karaf</h1></div></div></div><p>It is <a id="id109" class="indexterm"/>common to <a id="id110" class="indexterm"/>deploy dozens of Camel routes into an Apache Karaf container. To make administrating these routes easier, Apache Camel has provided a command to list all Camel-deployed routes by their ID.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec55"/>Getting ready</h2></div></div></div><p>Follow the instructions in the <span class="emphasis"><em>Listing Camel Contexts in Karaf</em></span> recipe's <span class="emphasis"><em>Getting ready</em></span> section for this recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec56"/>How to do it…</h2></div></div></div><p>Use<a id="id111" class="indexterm"/> the <code class="literal">camel:route-list</code> command to list all routes deployed in Karaf as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:route-list </strong></span>
<span class="strong"><strong> Context               Route                   Status   </strong></span>
<span class="strong"><strong> -------               -----                   ------   </strong></span>
<span class="strong"><strong> CamelCommandContext   CamelRoute-timerToLog   Started   </strong></span>
</pre></div><p>The preceding invocation gathers and displays all the routes deployed in the container on Karaf's console.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec57"/>How it works…</h2></div></div></div><p>When<a id="id112" class="indexterm"/> the <code class="literal">route-list</code> command is executed, the route IDs of each route in each Camel Context are displayed along with their current status.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>When developing routes, assign a descriptive ID to help make administration easier.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec58"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <a id="id113" class="indexterm"/><span class="emphasis"><em>Displaying </em></span><a id="id114" class="indexterm"/><span class="emphasis"><em>route information in Karaf</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Displaying route information in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Displaying route information in Karaf</h1></div></div></div><p>Apache<a id="id115" class="indexterm"/> Camel provides mechanisms<a id="id116" class="indexterm"/> to gather information surrounding the routes deployed inside a Camel Context. The <code class="literal">route-info</code> command has <a id="id117" class="indexterm"/>been provided to display route properties, statistics, and definitions to Karaf's console.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec59"/>Getting ready</h2></div></div></div><p>Follow the instructions in the <span class="emphasis"><em>Listing Camel Contexts in Karaf</em></span> recipe's <span class="emphasis"><em>Getting ready</em></span> section for this recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec60"/>How to do it…</h2></div></div></div><p>Use the <a id="id118" class="indexterm"/>following <code class="literal">camel:route-info routeId</code> command to display information on a Camel route to Karaf's console; similar to the <code class="literal">camel:context-info</code> command, this command may generate a lot of output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:route-info CamelRoute-timerToLog </strong></span>
<span class="strong"><strong>Camel Route CamelRoute-timerToLog</strong></span>
<span class="strong"><strong>  Camel Context: CamelCommandContext</strong></span>

<span class="strong"><strong>Properties</strong></span>
<span class="strong"><strong>    id = CamelRoute-timerToLog</strong></span>
<span class="strong"><strong>    parent = 20443040</strong></span>

<span class="strong"><strong>Statistics</strong></span>
<span class="strong"><strong>  Inflight Exchanges: 0</strong></span>
<span class="strong"><strong>  Exchanges Total: 44</strong></span>
<span class="strong"><strong>  Exchanges Completed: 44</strong></span>
<span class="strong"><strong>  Exchanges Failed: 0</strong></span>
<span class="strong"><strong>  Min Processing Time: 0 ms</strong></span>
<span class="strong"><strong>  Max Processing Time: 2 ms</strong></span>
<span class="strong"><strong>  Mean Processing Time: 0 ms</strong></span>
<span class="strong"><strong>  Total Processing Time: 38 ms</strong></span>
<span class="strong"><strong>  Last Processing Time: 1 ms</strong></span>
<span class="strong"><strong>  Delta Processing Time: 0 ms</strong></span>
<span class="strong"><strong>  Load Avg: 0.00, 0.00, 0.00</strong></span>
<span class="strong"><strong>  Reset Statistics Date: 2014-02-27 17:59:46</strong></span>
<span class="strong"><strong>  First Exchange Date: 2014-02-27 17:59:47</strong></span>
<span class="strong"><strong>  Last Exchange Completed Date: 2014-02-27 18:03:22</strong></span>

<span class="strong"><strong>Definition</strong></span>
<span class="strong"><strong>&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</strong></span>
<span class="strong"><strong>&lt;route customId="true" id="CamelRoute-timerToLog" &gt;</strong></span>
<span class="strong"><strong>    &lt;from uri="timer:foo?period=5000"/&gt;</strong></span>
<span class="strong"><strong>    &lt;setBody id="setBody8"&gt;</strong></span>
<span class="strong"><strong>        &lt;method ref="helloBean" method="hello"&gt;&lt;/method&gt;</strong></span>
<span class="strong"><strong>    &lt;/setBody&gt;</strong></span>
<span class="strong"><strong>    &lt;log message="The message contains ${body}" id="log8"/&gt;</strong></span>
<span class="strong"><strong>    &lt;to uri="mock:result" id="to8"/&gt;</strong></span>
<span class="strong"><strong>&lt;/route&gt;</strong></span>

<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div><p>The <a id="id119" class="indexterm"/>preceding invocation shows the output <a id="id120" class="indexterm"/>generated when our sample Camel application's route is displayed.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec61"/>How it works…</h2></div></div></div><p>Apache Camel provides mechanisms to track route statistics; the <code class="literal">route-info</code> command connects to these facilities to provide route information. Note the appending of <code class="literal">8</code> to various IDs in the route definition—this is generated by Camel to help differentiate different components and avoid name collisions. The original route definitions will not carry this value.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec62"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Starting, stopping, suspending, and resuming routes in Karaf</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Starting, stopping, suspending, and resuming routes in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec24"/>Starting, stopping, suspending, and resuming routes in Karaf</h1></div></div></div><p>Apache <a id="id121" class="indexterm"/>Camel <a id="id122" class="indexterm"/>provides <a id="id123" class="indexterm"/>users <a id="id124" class="indexterm"/>with <a id="id125" class="indexterm"/>fine-grained control <a id="id126" class="indexterm"/>of routes deployed inside a Camel Context, and as such, has provided Karaf with access to these controls. These <a id="id127" class="indexterm"/>management facilities are separate from OSGi's life<a id="id128" class="indexterm"/> cycle model, allowing users to select small portions of the Camel code that is currently being executed to start, stop, suspend, and resume operations.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec63"/>Getting ready</h2></div></div></div><p>Follow the instructions in the <span class="emphasis"><em>Listing Camel Contexts in Karaf</em></span> recipe's <span class="emphasis"><em>Getting ready</em></span> section for this recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec64"/>How to do it…</h2></div></div></div><p>Managing Camel routes in Karaf is easy, and requires you to become familiar with four commands, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">camel:route-start routeName</code>: This<a id="id129" class="indexterm"/> command is used to start a route</li><li class="listitem" style="list-style-type: disc"><code class="literal">camel:route-stop routeName</code>: This<a id="id130" class="indexterm"/> command is used to stop a route</li><li class="listitem" style="list-style-type: disc"><code class="literal">camel:route-suspend routeName</code>: This <a id="id131" class="indexterm"/>command is used to suspend a route</li><li class="listitem" style="list-style-type: disc"><code class="literal">camel:route-resume routeName</code>: This<a id="id132" class="indexterm"/> command is used to resume a suspended route</li></ul></div><p>To make these commands clear, let's review how to use them with the supplied sample Camel application from the <span class="emphasis"><em>Listing Camel Contexts in Karaf</em></span> recipe.</p><p>In the following invocation, we list all the Camel routes deployed in Karaf and then issue a stop order upon <code class="literal">CamelRoute-timerToLog</code> (our sample Camel application). We can observe that it changes the status of the route from <code class="literal">Started</code> to <code class="literal">Stopped</code>. This can be done using the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:route-list</strong></span>
<span class="strong"><strong> Context               Route                   Status   </strong></span>
<span class="strong"><strong> -------               -----                   ------   </strong></span>
<span class="strong"><strong> CamelCommandContext   CamelRoute-timerToLog   Started  </strong></span>
<span class="strong"><strong>karaf@root()&gt; camel:route-stop CamelRoute-timerToLog</strong></span>
<span class="strong"><strong>karaf@root()&gt; camel:route-list</strong></span>
<span class="strong"><strong> Context               Route                   Status   </strong></span>
<span class="strong"><strong> -------               -----                   ------   </strong></span>
<span class="strong"><strong> CamelCommandContext   CamelRoute-timerToLog   Stopped  </strong></span>
</pre></div><p>We can <a id="id133" class="indexterm"/>then<a id="id134" class="indexterm"/> issue the<a id="id135" class="indexterm"/> <code class="literal">route-start</code> command<a id="id136" class="indexterm"/> to return the <a id="id137" class="indexterm"/>route to the <code class="literal">Started</code> state, as shown in the following command snippet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:route-start CamelRoute-timerToLog </strong></span>
<span class="strong"><strong>karaf@root()&gt; camel:route-list</strong></span>
<span class="strong"><strong> Context               Route                   Status   </strong></span>
<span class="strong"><strong> -------               -----                   ------   </strong></span>
<span class="strong"><strong> CamelCommandContext   CamelRoute-timerToLog   Started  </strong></span>
</pre></div><p>We can<a id="id138" class="indexterm"/> now suspend the route via the <code class="literal">route-suspend</code> command and confirm that the named route enters the <code class="literal">Suspended</code> state, as shown in the following command snippet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:route-suspend CamelRoute-timerToLog </strong></span>
<span class="strong"><strong>karaf@root()&gt; camel:route-list</strong></span>
<span class="strong"><strong> Context               Route                   Status     </strong></span>
<span class="strong"><strong> -------               -----                   ------     </strong></span>
<span class="strong"><strong> CamelCommandContext   CamelRoute-timerToLog   Suspended  </strong></span>
</pre></div><p>Finally, we<a id="id139" class="indexterm"/> can issue the <code class="literal">route-resume</code> command to return the suspended route to the <code class="literal">Started</code> state, as shown in the following command snippet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:route-resume CamelRoute-timerToLog </strong></span>
<span class="strong"><strong>karaf@root()&gt; camel:route-list</strong></span>
<span class="strong"><strong> Context               Route                   Status   </strong></span>
<span class="strong"><strong> -------               -----                   ------   </strong></span>
<span class="strong"><strong> CamelCommandContext   CamelRoute-timerToLog   Started  </strong></span>
<span class="strong"><strong>karaf@root()&gt;</strong></span>
</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec65"/>How it works…</h2></div></div></div><p>The<a id="id140" class="indexterm"/> Camel route<a id="id141" class="indexterm"/> management <a id="id142" class="indexterm"/>commands are working<a id="id143" class="indexterm"/> from <a id="id144" class="indexterm"/>the <a id="id145" class="indexterm"/>point of view of the Camel Context, independently of the OSGi life cycle. During the execution of the commands, the<a id="id146" class="indexterm"/> host<a id="id147" class="indexterm"/> bundle's OSGi status is unaffected. This provides users with a fine-grained management approach, allowing a host bundle to remain running with its context(s), only manipulating one or more routes.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec66"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Starting and stopping Camel Contexts in Karaf</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Listing endpoints in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec25"/>Listing endpoints in Karaf</h1></div></div></div><p>Apache <a id="id148" class="indexterm"/>Camel users use endpoints to denote URIs from<a id="id149" class="indexterm"/> which events and information come from or go to. In Karaf, the <code class="literal">endpoint-list</code> command has been provided to help simplify tracking these URIs.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec67"/>Getting ready</h2></div></div></div><p>Follow the instructions in the <span class="emphasis"><em>Listing Camel Contexts in Karaf</em></span> recipe's <span class="emphasis"><em>Getting ready</em></span> section for this recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec68"/>How to do it…</h2></div></div></div><p>Use<a id="id150" class="indexterm"/> the <code class="literal">camel:endpoint-list</code> command to list all endpoints in Karaf (use the <code class="literal">camel:endpoint-list context-name</code> command if you want to restrict output to one context's routes). This is shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:endpoint-list </strong></span>
<span class="strong"><strong> Context               Uri                       Status   </strong></span>
<span class="strong"><strong> -------               ---                       ------   </strong></span>
<span class="strong"><strong> CamelCommandContext   mock://result             Started  </strong></span>
<span class="strong"><strong> CamelCommandContext   timer://foo?period=5000   Started  </strong></span>
</pre></div><p>In the preceding invocation, all endpoints found in Karaf are displayed (in this example, the endpoints were set in Blueprint—see the recipe's source code for details).</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec69"/>How it works…</h2></div></div></div><p>When the endpoint list command is executed, all routes in every Camel Context are scanned and listed to Karaf's console.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec70"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating our own custom Karaf command using a Maven archetype</em></span> recipe of <a class="link" href="ch01.html" title="Chapter 1. Apache Karaf for System Builders">Chapter 1</a>, <span class="emphasis"><em>Apache Karaf for System Builders</em></span></li></ul></div></div></div>
<div class="section" title="Making a pure Java-based Camel Router for deployment in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec26"/>Making a pure Java-based Camel Router for deployment in Karaf</h1></div></div></div><p>Developing <a id="id151" class="indexterm"/>our first Camel Router for deployment in Karaf doesn't necessarily require using a handful of frameworks and libraries. In this recipe, we'll make a Camel router using pure Java code with just a sprinkling of OSGi and Camel libraries.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec71"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor. The sample code for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe3">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe3</a>. Follow the instructions in the <span class="emphasis"><em>Installing Apache Camel modules into Apache Karaf</em></span> recipe to provide the base requirements to operate the sample code.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec72"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is creating a Maven-based project. A <code class="literal">pom.xml</code> file containing the essential Maven coordinate information and bundle packaging directive will suffice.</li><li class="listitem">The next step is adding Apache Camel and OSGi dependencies to the POM file. We need to add the <code class="literal">camel-core</code> and <code class="literal">org.osgi.core</code> artifacts' dependencies to the POM file. This is described in the following code:<div class="informalexample"><pre class="programlisting">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
        &lt;artifactId&gt;camel-core&lt;/artifactId&gt;
        &lt;version&gt;${camel.version}&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.osgi&lt;/groupId&gt;
        &lt;artifactId&gt;org.osgi.core&lt;/artifactId&gt;
        &lt;version&gt;${osgi.version}&lt;/version&gt;
        &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</pre></div><p>For Apache Karaf 3.0.0, we use Camel Version 2.12.2 and OSGi Version 5.0.0.</p></li><li class="listitem">Next, we<a id="id152" class="indexterm"/> add our build configuration, as shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
            &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
            &lt;version&gt;${maven-bundle-plugin.version}&lt;/version&gt;
            &lt;extensions&gt;true&lt;/extensions&gt;
            &lt;configuration&gt;
                &lt;instructions&gt;
                    &lt;Bundle-SymbolicName&gt;
                    ${project.artifactId}
                    &lt;/Bundle-SymbolicName&gt;
                    &lt;Bundle-Version&gt;
                    ${project.version}
                    &lt;/Bundle-Version&gt;
<span class="strong"><strong>                    &lt;Bundle-Activator&gt;</strong></span>
<span class="strong"><strong>                    com.packt.Activator</strong></span>
<span class="strong"><strong>                    &lt;/Bundle-Activator&gt;</strong></span>
                    &lt;Export-Package&gt;
                    com.packt*;version=${project.version}
                    &lt;/Export-Package&gt;
                    &lt;Import-Package&gt;*&lt;/Import-Package&gt;
                &lt;/instructions&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</pre></div><p>We use <code class="literal">maven-bundle-plugin</code> to build our bundle, adding the <code class="literal">Bundle-Activator</code> instruction. When the bundle is deployed into Karaf, the OSGi container will call the start and stop methods contained within the <code class="literal">com.packt.Activator</code> class.</p></li><li class="listitem">The next step is implementing OSGi BundleActivator. Now that we have established a base project structure, we can implement our Java code. We'll start by creating the <code class="literal">Activator.java</code> file in the <code class="literal">src/main/java/com/packt</code> folder.<p>The <code class="literal">Activator</code> class we write will implement the BundleActivator interface. The<a id="id153" class="indexterm"/> BundleActivator interface implements the methods the OSGi container calls when starting or stopping a bundle. We'll use the bundle's start and stop methods to control the creation of a Camel Context, the addition of a Camel route, and the actual start and stop of the router. For more details <a id="id154" class="indexterm"/>on Apache Camel, visit <a class="ulink" href="http://camel.apache.org">http://camel.apache.org</a>. Consider the following code:</p><div class="informalexample"><pre class="programlisting">public void start(BundleContext context) {
    System.out.println("Starting the bundle");
<span class="strong"><strong>    camelContext = new DefaultCamelContext();</strong></span>
    try {
<span class="strong"><strong>        camelContext.addRoutes(new MyRouteBuilder());</strong></span>
<span class="strong"><strong>        camelContext.start();</strong></span>
    }
    catch (Exception ex) {
        // Use logging subsystem in non-sample code.
        System.out.println("Exception occured! " + ex.getMessage());
    }
}</pre></div><p>When <a id="id155" class="indexterm"/>our Activator interface is started, we will create a new <code class="literal">CamelContext</code> object, then attempt to add a <code class="literal">MyRouteBuilder</code> function (this creates a Camel route), and then start the context and the routes it contains. Consider the following code:</p><div class="informalexample"><pre class="programlisting">public void stop(BundleContext context) {
    System.out.println("Stopping the bundle");
    if (camelContext != null) {
        try { 
<span class="strong"><strong>            camelContext.stop();</strong></span>
        }
        catch (Exception ex) {
            System.out.println("Exception occurred during stop context.");
        }
    }
}</pre></div><p>When our Activator interface is stopped, we first check whether our <code class="literal">CamelContext</code> object is null and then attempt to call the <code class="literal">stop</code> function upon it. When the context is stopped, all routes contained within it are also stopped.</p></li><li class="listitem">Next, we implement our Camel Router. Our Camel router is defined in a custom router builder, which we extend from Camel's <code class="literal">RouteBuilder</code> class. This is shown in the following code:<div class="informalexample"><pre class="programlisting">public class MyRouteBuilder extends RouteBuilder {

    public void configure() {

        from("file:src/data?noop=true")
            .choice()
                .when(xpath("/recipe = 'cookie'"))
                    .log("Cookie  message")
                    .to("file:target/messages/cookies")
                .otherwise()
                    .log("Other message")
                    .to("file:target/messages/others");
    }

}</pre></div><p>The <code class="literal">MyRouteBuilder</code> class extends the Camel <code class="literal">RouteBuilder</code> class, which provides the router configuration interface. We add a Camel route definition to the <code class="literal">configure</code> method using the Java-based DSL.</p></li><li class="listitem">The <a id="id156" class="indexterm"/>next step is building and deploying our Camel Router into Karaf. Now that we have implemented our build configuration (POM file), tied it into the OSGi runtime (the <code class="literal">Activator</code> class), and implemented our Camel Router (the <code class="literal">MyRouteBuilder</code> class), we can proceed to compile and deploy the code into Karaf. Our first step is to invoke <code class="literal">mvn install</code>, and then we execute <code class="literal">install –s mvn:com.packt/osgi</code> (<code class="literal">mvn:groupId/artifactId</code>) on the Karaf console.</li><li class="listitem">As the final step, we're ready to test out our Camel Router! Once our router bundle is installed and active in Karaf, you'll see a <code class="literal">src/data</code> folder created in the <code class="literal">KARAF_HOME</code> folder. Our sample router configuration processes XML-based recipe files. When it sees a cookie recipe (<code class="literal">&lt;recipe&gt;cookie&lt;/recipe&gt;</code>), it places a copy of it in the <code class="literal">KARAF_HOME/target/messages/cookies</code> folder; otherwise, it places that copy in the <code class="literal">KARAF_HOME/target/message/other</code> folder.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec73"/>How it works…</h2></div></div></div><p>Our pure Java-based Camel Router works by taking advantage of OSGi's BundleActivator start and stop interfaces and direct use of the Apache Camel library. When deployed into Karaf, we can visualize the relevant components as shown in the following diagram:</p><div class="mediaobject"><img src="graphics/5081OS_02_03.jpg" alt="How it works…"/></div><p>When <a id="id157" class="indexterm"/>a bundle is started in an OSGi container, it will have its <code class="literal">Bundle-Activator</code> class' <code class="literal">start</code> method called. Our sample project configures this to the <code class="literal">com.packt.Activator</code> class. We reuse the Activator's start and stop methods to control a Camel Context, which contains a Camel Router as built by our <code class="literal">RouteBuilder</code> class implementation.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec74"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a Blueprint-based Camel Router for deployment in Karaf</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a Blueprint-based Camel Router for deployment in Karaf"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec27"/>Creating a Blueprint-based Camel Router for deployment in Karaf</h1></div></div></div><p>Blueprint <a id="id158" class="indexterm"/>provides a dependency injection framework for OSGi. Many users will find that it has similarities with the Spring framework. However, Blueprint has been designed to deal with the dynamic runtime of OSGi where services come and go regularly.</p><p>The standard Apache Camel-Karaf feature contains the required Camel-Blueprint libraries for users to immediately start using Blueprint to wire together their routes. In this recipe, we'll build a Camel Router, taking advantage of the Blueprint Inversion of Control framework.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec75"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor. The sample code for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe4">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe4</a>. Follow the instructions in the <span class="emphasis"><em>Installing Apache Camel modules into Apache Karaf</em></span> recipe's <span class="emphasis"><em>Getting ready</em></span> section to provide the base requirements to operate the sample code.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec76"/>How to do it…</h2></div></div></div><p>The Apache Camel community has provided its users with a Maven archetype to generate a Blueprint-based OSGi Camel Router:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is generating a Camel Blueprint project with a Maven archetype. We can create our project by invoking the archetype as shown in the following command snippet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mvn archetype:generate \</strong></span>
<span class="strong"><strong>  -DarchetypeGroupId=org.apache.camel.archetypes \</strong></span>
<span class="strong"><strong>  -DarchetypeArtifactId=camel-archetype-blueprint \</strong></span>
<span class="strong"><strong>  -DarchetypeVersion=2.12.2 \</strong></span>
<span class="strong"><strong>  -DarchetypeRepository=https://repository.apache.org/content/groups/snapshots-group</strong></span>
</pre></div><p>During the generation process, you will be asked to supply a <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and project <code class="literal">version</code> value.</p><p>This archetype invocation will produce a POM file, Java source for a Hello interface and to implement HelloBean, a Blueprint descriptor XML file, and a sample unit test. The interface and the bean component are purely for sample purposes; in a real-world development scenario, you will delete these artifacts.</p></li><li class="listitem">The next step is building and deploying the project into Karaf. To build the project, we invoke the <code class="literal">mvn install</code> command. This will populate your local <code class="literal">m2</code> repository with <a id="id159" class="indexterm"/>our bundle. To install the sample, execute the following command on the Karaf console:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install –s mvn:com.packt/bp/1.0.0-SNAPSHOT</strong></span>
</pre></div><p>In the preceding command, we substitute your Maven coordinates in the format <code class="literal">mvn:{groupId}/{artifactID}/{version}</code>.</p></li><li class="listitem">The last step is verifying the router function. Once installed and started (using the <code class="literal">start BundleID</code> command), you will observe the following entries in your Karaf logfile:<div class="informalexample"><pre class="programlisting">2014-02-06 10:00:49,074 | INFO  | Local user karaf | BlueprintCamelContext            | 85 - org.apache.camel.camel-core - 2.12.2 | Total 1 routes, of which 1 is started.
2014-02-06 10:00:49,075 | INFO  | Local user karaf | BlueprintCamelContext            | 85 - org.apache.camel.camel-core - 2.12.2 | Apache Camel 2.12.2 (CamelContext: blueprintContext) started in 0.357 seconds
2014-02-06 10:00:50,075 | INFO  | 12 - timer://foo | timerToLog       | 85 - org.apache.camel.camel-core - 2.12.2 | The message contains Hi from Camel at 2014-02-06 10:00:50</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec77"/>How it works…</h2></div></div></div><p>When our project bundle is deployed into Karaf, the project's dependencies are resolved, and upon start, the Blueprint descriptor file is processed and objects are instantiated and populated into the Blueprint container. The following diagram highlights the high-level view of the deployed components in Karaf:</p><div class="mediaobject"><img src="graphics/5081OS_02_04.jpg" alt="How it works…"/></div><p>Given a successful instantiation of the <a id="id160" class="indexterm"/>services deployed into the Blueprint container, the <code class="literal">CamelContext</code> object embedded within the container is automatically started.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec78"/>There's more…</h2></div></div></div><p>The Apache Camel project also provides a Camel-Spring library in its standard feature deployment. The Spring framework can be made to work in a Karaf environment, but it's generally preferred to use Blueprint or Declarative Services.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec79"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding Configuration Admin to a Blueprint-based Camel Router</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Adding Configuration Admin to a Blueprint-based Camel Router"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec28"/>Adding Configuration Admin to a Blueprint-based Camel Router</h1></div></div></div><p>Blueprint allows us to<a id="id161" class="indexterm"/> externalize <a id="id162" class="indexterm"/>some configuration elements from our code; we can take this to the next level by taking advantage of the OSGi configuration administration service (generally referred to as Configuration Admin).</p><p>The Configuration Admin service provides configuration properties to services in an OSGi container. In Apache Karaf, this functionality is improved by including the Apache Felix File Install directory-based management agent. File Install monitors a directory and can automatically install and start a bundle or make a configuration file update to Configuration Admin.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Apache Felix File Install provides the magic behind Karaf's <code class="literal">deploy</code> and <code class="literal">etc</code> folders, automatically handling files as they are added, removed, or updated.</p></div></div><p>In this recipe, we'll integrate the Configuration Admin service into our Blueprint-based Camel project.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec80"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor. The sample code for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe5">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe5</a>. Follow the instructions in the <span class="emphasis"><em>Installing Apache Camel modules into Apache Karaf</em></span> recipe to provide the base requirements to operate the sample code.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec81"/>How to do it…</h2></div></div></div><p>The Apache Camel community has provided its users with a Maven archetype to generate a Blueprint-based OSGi Camel Router. We'll use this as a starting point to build our project, adding in the required bits for Configuration Admin support:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is generating a Camel Blueprint project with a Maven archetype. We can create our project by invoking the archetype as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mvn archetype:generate \</strong></span>
<span class="strong"><strong>  -DarchetypeGroupId=org.apache.camel.archetypes \</strong></span>
<span class="strong"><strong>  -DarchetypeArtifactId=camel-archetype-blueprint \</strong></span>
<span class="strong"><strong>  -DarchetypeVersion=2.12.2 \ </strong></span>
<span class="strong"><strong>  -DarchetypeRepository=https://repository.apache.org/content/groups/snapshots-group</strong></span>
</pre></div><p>During the generation process, you will be asked to supply a <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and project <code class="literal">version</code> value.</p><p>This will produce a POM file, Java source for a Hello interface and to implement HelloBean, a Blueprint descriptor XML file, and a sample unit test.</p></li><li class="listitem">Now<a id="id163" class="indexterm"/> that we <a id="id164" class="indexterm"/>have a basic project structure, let's modify it to use Configuration Admin. As we're using Blueprint, we only need to modify the descriptor file found in the <code class="literal">src/main/resources/OSGI-INF/blueprint</code> folder.<p>Our first modification is to add an additional namespace for Configuration Admin, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;blueprint 
        
        
<span class="strong"><strong>        </strong></span>
        xsi:schemaLocation="
        http://www.osgi.org/xmlns/blueprint/v1.0.0
        http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
<span class="strong"><strong>        http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0</strong></span>
        http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd"&gt;</pre></div><p>We'll use the namespace <code class="literal">cm</code> to access configuration management.</p></li><li class="listitem">The next step is modifying the bean wiring in the Blueprint file to use a Configuration Admin variable. We update the provided <code class="literal">HelloBean</code> bean to accept a configuration variable, as shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;bean id="helloBean" class="com.packt.HelloBean"&gt;
<span class="strong"><strong>        &lt;property name="say" value="${greeting}"/&gt;</strong></span>
&lt;/bean&gt;</pre></div><p>Variables use the syntax <code class="literal">${variable-name}</code>.</p></li><li class="listitem">Now, we can add our reference to Configuration Admin, as follows:<div class="informalexample"><pre class="programlisting">&lt;!-- OSGI blueprint property placeholder --&gt;
&lt;!-- etc/recipe.cfg --&gt;
&lt;cm:property-placeholder persistent-id="recipe"<span class="strong"><strong>  update-strategy="reload"&gt;</strong></span>

    &lt;!-- list some properties for this test --&gt;
<span class="strong"><strong>    &lt;cm:default-properties&gt;</strong></span>
<span class="strong"><strong>        &lt;cm:property name="greeting" </strong></span>
<span class="strong"><strong>                    value="Hello World"/&gt;</strong></span>
<span class="strong"><strong>        &lt;cm:property name="result" </strong></span>
<span class="strong"><strong>                    value="mock:result"/&gt;</strong></span>
    &lt;/cm:default-properties&gt;
&lt;/cm:property-placeholder&gt;</pre></div><p>Here, we set the configuration management behavior to reload applications with configuration updates. Then, we provide default values to a pair of variables we'll use in the Blueprint file. We also set a <code class="literal">persistent-id</code> placeholder that we can use in conjunction with Karaf's <code class="literal">etc</code> folder to provide dynamic external configuration. In the preceding code, we can create a <code class="literal">recipe.cfg</code> file in the <code class="literal">etc</code> folder that contains the <code class="literal">greeting</code> and <code class="literal">result</code> properties.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>When writing an Apache Karaf feature descriptor, you can add a configuration file(s) to the list of resources the feature will install.</p></div></div></li><li class="listitem">The <a id="id165" class="indexterm"/>next step is<a id="id166" class="indexterm"/> updating the Camel Context in Blueprint to use a Configuration Admin variable. This can be done as follows:<div class="informalexample"><pre class="programlisting">&lt;camelContext id="blueprintContext" trace="false" &gt;
    &lt;route id="timerToLog"&gt;
        &lt;from uri="timer:foo?period=5000"/&gt;
        &lt;setBody&gt;
<span class="strong"><strong>            &lt;method ref="helloBean" method="hello"/&gt;</strong></span>
        &lt;/setBody&gt;
        &lt;log message="The message contains ${body}"/&gt;
<span class="strong"><strong>        &lt;to uri="{{result}}"/&gt;</strong></span>
    &lt;/route&gt;
&lt;/camelContext&gt;</pre></div><p>Our Camel route contains one direct modification: the introduction of a <code class="literal">{{result}}</code> variable. Camel uses double curly braces syntax for external variables. The <code class="literal">helloBean</code> reference remains unchanged. However, its runtime behavior is to now use a default variable from the Blueprint descriptor or a value provided by Configuration Admin.</p></li><li class="listitem">The next step is building and deploying the project into Karaf. To build the project, we invoke the <code class="literal">mvn install</code> command. This will populate your local <code class="literal">m2</code> repository with our bundle. To install the sample, execute the following command on the Karaf console:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; bundle:install –s mvn:com.packt/bp-configadmin/1.0.0-SNAPSHOT</strong></span>
</pre></div><p>In the preceding command, we substitute your Maven coordinates in the <code class="literal">mvn:{groupId}/{artifactID}/{version}</code> format.</p></li><li class="listitem">The <a id="id167" class="indexterm"/>last step is <a id="id168" class="indexterm"/>verifying the router function. Once the router is installed and started, you will observe entries of the following form in your Karaf logfile:<div class="informalexample"><pre class="programlisting">2014-02-06 13:36:01,892 | INFO  | Local user karaf | BlueprintCamelContext | 85 - org.apache.camel.camel-core - 2.12.2 | Total 1 routes, of which 1 is started.
2014-02-06 13:36:01,892 | INFO  | Local user karaf | BlueprintCamelContext | 85 - org.apache.camel.camel-core - 2.12.2 | Apache Camel 2.12.2 (CamelCon: blueprintContext) started in 0.272 seconds
2014-02-06 13:36:02,891 text| INFO  | 15 - timer://foo | timerToLog | 85 - org.apache.camel.camel-core - 2.12.2 |   The message contains Hello World at2014-02-06 13:36:02 </pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>Changing variable values requires editing the Blueprint file and refreshing the bundle in Karaf. However, changes to values in the configuration file will be picked up almost instantly.</p></div></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec82"/>How it works…</h2></div></div></div><p>This recipe extends the <span class="emphasis"><em>Creating a Blueprint-based Camel Router for deployment in Karaf</em></span> recipe by introducing Configuration Admin to the design. The following diagram highlights the high-level view of the deployed components in Karaf:</p><div class="mediaobject"><img src="graphics/5081OS_02_05.jpg" alt="How it works…"/></div><p>The addition of Configuration<a id="id169" class="indexterm"/> Admin to<a id="id170" class="indexterm"/> Blueprint exposes the Camel route to external configuration. This external configuration appears as Java properties files in Karaf's <code class="literal">etc</code> folder.</p><p>So, how do we associate the properties file to the Configuration Admin reference in our Blueprint specification? This is accomplished by setting the persistence ID in the Configuration Admin property placeholder's Blueprint definition. In our demo code, we use the persistence ID recipe—in our <code class="literal">etc</code> folder, we'd use a corresponding file named <code class="literal">recipe.cfg</code>.</p><p>How do we use the property name-value pairs? We include the default name-value pairs in the Blueprint definition. These are automatically overridden by Configuration Admin if values are available. We access their values using single curly braces in beans and double curly braces in Blueprint-defined Camel Contexts.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec83"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a managed service factory implementation of a Camel Router</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a managed service factory implementation of a Camel Router"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec29"/>Creating a managed service factory implementation of a Camel Router</h1></div></div></div><p>In<a id="id171" class="indexterm"/> this recipe, we'll introduce the power of the OSGi pattern ManagedServiceFactory interface to Apache <a id="id172" class="indexterm"/>Camel smart routers. This pattern will allow us to manage multiple service instances, or in our case, Camel routes, via configuration. In fact, we'll produce a new router instance for each configuration we supply our service factory!</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec84"/>Getting ready</h2></div></div></div><p>The ingredients of this recipe include the Apache Karaf distribution kit, access to JDK, Maven, and a source code editor. The sample code for this recipe is available at <a class="ulink" href="https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe6">https://github.com/jgoodyear/ApacheKarafCookbook/tree/master/chapter2/chapter2-recipe6</a>. Follow the instructions in the <span class="emphasis"><em>Installing Apache Camel modules into Apache Karaf</em></span> recipe to provide the base requirements to operate the sample code.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec85"/>How to do it…</h2></div></div></div><p>This recipe will be somewhat more complex than our previous recipes. It is strongly urged that you follow along with the provided example code:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, create a Blueprint-based Camel project using the handy Maven archetype we've used in the previous recipes (see the <span class="emphasis"><em>Creating a Blueprint-based Camel Router for deployment in Karaf</em></span> recipe). We'll use this as a base to build our project, removing and/or modifying resources as required.</li><li class="listitem">The next step is adding dependencies to the POM file. We'll edit the POM file, adding dependencies on the OSGi core and compendium, as shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
    &lt;groupId&gt;org.osgi&lt;/groupId&gt;
    &lt;artifactId&gt;org.osgi.core&lt;/artifactId&gt;
    &lt;version&gt;${osgi-core-version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.osgi&lt;/groupId&gt;
    &lt;artifactId&gt;org.osgi.compendium&lt;/artifactId&gt;
    &lt;version&gt;${osgi-compendium-version}&lt;/version&gt;
&lt;/dependency&gt;</pre></div><p>For Apache Karaf 3.0.0, we use the OSGi core and compendium version 5.0.0.</p></li><li class="listitem">Now, we prune the generated project structure. We'll remove the prepopulated <code class="literal">blueprint.xml</code> file, the <code class="literal">main</code> folder, and the <code class="literal">test</code> folder.</li><li class="listitem">Now, we'll implement <a id="id173" class="indexterm"/>our ManagedServiceFactory interface in the <code class="literal">src/main/java</code> folder. To do this, we'll create a factory class that implements the<a id="id174" class="indexterm"/> ManagedServiceFactory interface and plug a dispatcher into this framework, which will handle building and executing of Camel routes. We'll cover the intricacies of these classes in the <span class="emphasis"><em>How it works…</em></span> section of this recipe.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>The OSGi compendium rev 5 ManagedServiceFactory interface can be found at the OSGi <a id="id175" class="indexterm"/>Alliance website at <a class="ulink" href="http://www.osgi.org/javadoc/r5/cmpn/org/osgi/service/cm/ManagedServiceFactory.html">http://www.osgi.org/javadoc/r5/cmpn/org/osgi/service/cm/ManagedServiceFactory.html</a>.</p></div></div></li><li class="listitem">Next, we create a Blueprint file in the <code class="literal">src/main/resources</code> folder that wires together Configuration Admin, a Camel Context, and our <code class="literal">Factory</code> class.<div class="informalexample"><pre class="programlisting">&lt;blueprint 
    
    
    
    xsi:schemaLocation="
    http://www.osgi.org/xmlns/blueprint/v1.0.0
    http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
    http://camel.apache.org/schema/blueprint 
    http://camel.apache.org/schema/blueprint/camel-blueprint.xsd"&gt;

  &lt;!—- Setup process Id name for configuration file --&gt;
  &lt;cm:property-placeholder persistent-id="com.packt.hellofactory" update-strategy="reload"&gt;
    &lt;cm:default-properties&gt;
        &lt;cm:property name="com.packt.hellofactory.pid" value="com.packt.hellofactory"/&gt;
    &lt;/cm:default-properties&gt;
  &lt;/cm:property-placeholder&gt;

  &lt;!—- Create Camel Context --&gt;
  &lt;camelContext id="helloContext"  autoStartup="true"&gt;
  &lt;/camelContext&gt;

  &lt;!—- Setup Bean, wiring in contexts, andconfiguration data  --&gt;
  &lt;bean id="apacheKarafCookbook" class="com.packt.HelloFactory" init-method="init" destroy-method="destroy"&gt;
    &lt;property name="bundleContext" ref="blueprintBundleContext"/&gt;
    &lt;property name="configurationPid"       value="${com.packt.hellofactory.pid}"/&gt;
    &lt;property name="camelContext" ref="helloContext"/&gt;
  &lt;/bean&gt;

&lt;/blueprint&gt;</pre></div><p>The Blueprint file in the preceding code contains the general structural elements required; we will cover the details of these entries in the <span class="emphasis"><em>How it works…</em></span> section of this recipe.</p></li><li class="listitem">The next step is building <a id="id176" class="indexterm"/>and <a id="id177" class="indexterm"/>deploying the router into Karaf. We build and deploy this assembly as a bundle into Karaf and provision it with configuration files in the <code class="literal">etc</code> folder. The configuration files each take the form of <code class="literal">PID-name.cfg</code>, with their contents being Java-style properties.<p>To build our sample project, execute the <code class="literal">mvn install</code> command. Deployment will require the following two commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; install -s mvn:commons-lang/commons-lang/2.6</strong></span>
<span class="strong"><strong>karaf@root()&gt; install -s mvn:com.packt/msf/1.0.0-SNAPSHOT</strong></span>
</pre></div></li><li class="listitem">Our managed service factory implementation of a Camel Router is now ready for use. The last step is creating a configuration for our router instances. Consider a sample configuration of the <code class="literal">etc/com.packt.hellofactory-test1.cfg</code> file with the following entries:<div class="informalexample"><pre class="programlisting">HELLO_GREETING=hello 
HELLO_NAME=Jamie</pre></div><p>Also, consider the <code class="literal">etc/com.packt.hellofactory-test2.cfg</code> file with the following entries:</p><div class="informalexample"><pre class="programlisting">HELLO_GREETING=hi 
HELLO_NAME=Laura </pre></div><p>On running appropriate commands, these sample configurations will produce the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>karaf@root()&gt; camel:route-list </strong></span>
<span class="strong"><strong>  Context        Route          Status   </strong></span>
<span class="strong"><strong>  -------        -----          ------   </strong></span>
<span class="strong"><strong>  helloContext   Hello Jamie    Started  </strong></span>
<span class="strong"><strong>  helloContext   Hello Laura    Started  </strong></span>
<span class="strong"><strong>karaf@root()&gt; log:display</strong></span>
<span class="strong"><strong>hello Jamie</strong></span>
<span class="strong"><strong>hi Laura</strong></span>
</pre></div></li></ol></div><p>Now that we've reviewed a high-level process to build a managed service factory implementation of a Camel Router, let's dive deep into how and why this works.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec86"/>How it works…</h2></div></div></div><p>Bundles implementing <a id="id178" class="indexterm"/>the ManagedServiceFactory interface connect into the Configuration Admin service's capability to build and configure instances of the bundle. In our sample project, we use <a id="id179" class="indexterm"/>this functionality to create new route instances based upon the provided configurations.</p><p>Each service (route) instance is represented by a factory configuration called PID. When a given<a id="id180" class="indexterm"/> PID is updated, Configuration Admin will call the factory's updated method. If a new PID is passed in, then a new instance is created; if the PID exists, then its configuration is updated. The following diagram highlights the high-level view of the deployed components in Karaf:</p><div class="mediaobject"><img src="graphics/5081OS_02_06.jpg" alt="How it works…"/></div><p>When we deploy the <a id="id181" class="indexterm"/>Camel components<a id="id182" class="indexterm"/> and the sample project into Karaf, we'll wire the MSF bundle and Configuration Admin via Blueprint. Under the hood, the MSF bundle is composed of three classes: <code class="literal">HelloConstants</code>, <code class="literal">HelloDispatcher</code>, and <code class="literal">HelloFactory</code>.</p><p>The <code class="literal">HelloFactory</code> class<a id="id183" class="indexterm"/> implements the ManagedServiceFactory interface. In our sample project, we override the <code class="literal">getName()</code>, <code class="literal">updated(String pid, Dictionary dict)</code>, and <code class="literal">deleted(String pid)</code> methods. We then provide the initialization and destruction methods to clean up after our routers. Finally, we provide setters to wire in our PID, <code class="literal">bundleContext</code>, and <code class="literal">camelContext</code> objects. Let's take a closer look at the core interface implementation in the <code class="literal">HelloFactory</code> class. Consider the following code:</p><div class="informalexample"><pre class="programlisting">@Override
public String getName() {
    return configurationPid;
}</pre></div><p>We override the <code class="literal">getName()</code> method, returning our configuration PID, as shown in the preceding code. Consider the following code:</p><div class="informalexample"><pre class="programlisting">@Override
public void updated(String pid, Dictionary dict) 
        throws ConfigurationException {
        log.info("updated " + pid + " with " + dict.toString());
        HelloDispatcher engine = null;

        if (dispatchEngines.containsKey(pid)) {
            engine = dispatchEngines.get(pid);

            if (engine != null) {
                destroyEngine(engine);
            }
            dispatchEngines.remove(pid);
        }</pre></div><p>In the <code class="literal">updated</code> method in the preceding code, we begin by setting up our <code class="literal">HelloDispatcher</code> engine. A map of <code class="literal">&lt;PID, HelloDispatcher&gt;</code> is maintained, which we <a id="id184" class="indexterm"/>use to internally<a id="id185" class="indexterm"/> track our Camel Routers. If we have a PID entry for the dispatcher, then we safely destroy the existing engine so that a new one can be constructed. Now, consider the following code:</p><div class="informalexample"><pre class="programlisting">    //Verify dictionary contents before applying them to Hello
if (dict.get(HelloConstants.HELLO_GREETING) != null &amp;&amp; !StringUtils.isEmpty(dict.get(HelloConstants.HELLO_GREETING).toString())) {
  log.info("HELLO_GREETING set to " + dict.get(HelloConstants.HELLO_GREETING));
} else {
  throw new IllegalArgumentException("Missing HELLO_GREETING");
}

if (dict.get(HelloConstants.HELLO_NAME) != null &amp;&amp; !StringUtils.isEmpty(dict.get(HelloConstants.HELLO_NAME).toString())) {
  log.info("HELLO_NAME set to " + dict.get(HelloConstants.HELLO_NAME));
} else {
  throw new IllegalArgumentException("Missing HELLO_NAME");
}</pre></div><p>We then verify the presence of the required configuration entries in the properties dictionary provided by Configuration Admin. These dictionaries are constructed when configuration files are placed in Karaf's <code class="literal">etc</code> folder. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">    //Configuration was verified above, now create engine.
<span class="strong"><strong>engine = new HelloDispatcher();</strong></span>
<span class="strong"><strong>engine.setCamelContext(camelContext);</strong></span>
<span class="strong"><strong>engine.setGreeting(dict.get(HelloConstants.HELLO_GREETING).toString());</strong></span>
<span class="strong"><strong>engine.setName(dict.get(HelloConstants.HELLO_NAME).toString());</strong></span>

dispatchEngines.put(pid, engine);
log.debug("Start the engine...");
if (engine == null) {
    log.debug("Engine was null, check configuration.");
}
<span class="strong"><strong>    engine.start();</strong></span>
}</pre></div><p>The <code class="literal">updated</code> method then creates and configures a new <code class="literal">HelloDispatcher</code> object and then starts operating it. Now, consider<a id="id186" class="indexterm"/> the<a id="id187" class="indexterm"/> following<a id="id188" class="indexterm"/> code:</p><div class="informalexample"><pre class="programlisting">@Override
public void deleted(String pid) {
    if (dispatchEngines.containsKey(pid)) {
        HelloDispatcher engine = dispatchEngines.get(pid);

        if (engine != null) {
            destroyEngine(engine);
    }
        dispatchEngines.remove(pid);
    }
    log.info("deleted " + pid);
}</pre></div><p>The <code class="literal">deleted</code> method<a id="id189" class="indexterm"/> safely cleans up all currently executing <code class="literal">HelloDispatcher</code> objects (our routers) when a PID is removed.</p><p>To integrate the <code class="literal">HelloFactory</code> object into the container, we included the <code class="literal">init</code> and <code class="literal">destroy</code> methods. The <code class="literal">init</code> call is used to register the ManagedServiceFactory interface with the register service and establish a ServiceTracker wiring (which is a utility class that simplifies working with service references from the service registry) between the ManagedServiceFactory interface bundle and the Configuration Admin service. The <code class="literal">destroy</code> call's main function is to clean up by unregistering the bundle safely from the registerService and close its <code class="literal">ServiceTracker</code> object.</p><p>The <code class="literal">HelloDispatcher</code> object implements our Camel Router. We provide start and stop <a id="id190" class="indexterm"/>methods that handle integration of our Camel route instance into an existing Camel Context. We also provide methods to set our parameters and specify the Camel Context we want to deploy our route into. Finally, we provide a mechanism from which our Camel route will be constructed. Let's take a closer look at the route builder in the <code class="literal">HelloDispatcher</code> object. This is shown in the following code:</p><div class="informalexample"><pre class="programlisting">protected RouteBuilder buildHelloRouter() throws Exception {

    return new RouteBuilder() {

        @Override
        public void configure() throws Exception {

<span class="strong"><strong>        from("timer://helloTimer?fixedRate=true&amp;period=10000").</strong></span>
<span class="strong"><strong>    routeId("Hello " + name).</strong></span>
<span class="strong"><strong>    log(greeting + " " + name);</strong></span>
    }
};</pre></div><p>The preceding route uses a timer<a id="id191" class="indexterm"/> component to <a id="id192" class="indexterm"/>generate an event every 10 seconds and then sends a message to a log. The configuration elements provide a <code class="literal">routeId</code> based on the name parameter, and the log message contains the <code class="literal">greeting</code> and <code class="literal">name</code> parameters.</p><p>Finally, <code class="literal">HelloConstants</code> is a utility class that provides our configuration parameter name constants.</p><p>The wiring of the ManagedServiceFactory bundle to Configuration Admin happens inside our Blueprint XML file. Let's take a closer look at the three important sections of this descriptor file, which are as follows:</p><div class="informalexample"><pre class="programlisting">&lt;cm:property-placeholder persistent-id="com.packt.hellofactory" update-strategy="reload"&gt;
  &lt;cm:default-properties&gt;
<span class="strong"><strong>    &lt;cm:property name="com.packt.hellofactory.pid" value="com.packt.hellofactory"/&gt;</strong></span>
  &lt;/cm:default-properties&gt;
&lt;/cm:property-placeholder&gt;</pre></div><p>The <code class="literal">cm</code> namespace is used to set up configuration management. Consider the following code:</p><div class="informalexample"><pre class="programlisting">&lt;camelContext id="helloContext"autoStartup="true"&gt;
&lt;/camelContext&gt;</pre></div><p>Our Camel Context is created as our route container. This context will be shared by each route instance we introduce to the system. Consider the following code:</p><div class="informalexample"><pre class="programlisting">&lt;bean id="apacheKarafCookbook" class="com.packt.HelloFactory" init-method="init" destroy-method="destroy"&gt;
  &lt;property name="bundleContext"
<span class="strong"><strong>    ref="blueprintBundleContext"/&gt;</strong></span>
  &lt;property name="configurationPid"
<span class="strong"><strong>    value="${com.packt.hellofactory.pid}"/&gt;</strong></span>
  &lt;property name="camelContext" ref="helloContext"/&gt;
&lt;/bean&gt;</pre></div><p>Finally, we wire<a id="id193" class="indexterm"/> together <a id="id194" class="indexterm"/>our <code class="literal">HelloFactory</code> object to the Blueprint context, Configuration Admin services, and to our shared Camel Context. We also wire in our factory's <code class="literal">init</code> and <code class="literal">destroy</code> methods. The following diagram illustrates the three instances of the Camel route, each producing a different message based upon their configuration:</p><div class="mediaobject"><img src="graphics/5081OS_02_07.jpg" alt="How it works…"/></div><p>Once our ManagedServiceFactory bundle, Blueprint file, and Configuration Admin services are wired <a id="id195" class="indexterm"/>together and started, it will now accept <a id="id196" class="indexterm"/>configurations and instantiate routes. In Karaf, you can add configuration files of the <code class="literal">pid-name.cfg</code> format to the <code class="literal">etc</code> folder. For example, in our sample project, our configuration files are named <code class="literal">com.packt.hellofactory-test1.cfg</code>, <code class="literal">com.packt.hellofactory-test2.cfg</code>, and so on.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec87"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For more information on ActiveMQ and CXF, read <a class="link" href="ch03.html" title="Chapter 3. Deploying a Message Broker with Apache ActiveMQ">Chapter 3</a>, <span class="emphasis"><em>Deploying a Message Broker with Apache ActiveMQ,</em></span> and <a class="link" href="ch04.html" title="Chapter 4. Hosting a Web Server with Pax Web">Chapter 4</a>, <span class="emphasis"><em>Hosting a Web Server with Pax Web</em></span></li></ul></div></div></div></body></html>