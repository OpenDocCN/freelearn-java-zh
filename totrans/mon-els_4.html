<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Marvel Dashboard"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Marvel Dashboard</h1></div></div></div><p>The previous two chapters covered Elasticsearch-head and Bigdesk, two open source monitoring tools. This chapter covers Marvel, a non-free tool for monitoring Elasticsearch.</p><p>Unlike Elasticsearch-head and Bigdesk, Marvel continuously captures and saves performance metrics to an index. This lets<a id="id132" class="indexterm"/> users refer to historical data for analysis, as opposed to just real-time data analysis. In this chapter, we will look a bit closer at the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up Marvel</li><li class="listitem" style="list-style-type: disc">Upgrading Marvel</li><li class="listitem" style="list-style-type: disc">Configuring Marvel</li><li class="listitem" style="list-style-type: disc">Marvel index configuration</li><li class="listitem" style="list-style-type: disc">Marvel dashboard</li><li class="listitem" style="list-style-type: disc">Monitoring node failures</li></ul></div><div class="section" title="Setting up Marvel"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec22"/>Setting up Marvel</h1></div></div></div><p>See <a class="link" href="ch02.html" title="Chapter 2. Installation and the Requirements for Elasticsearch">Chapter 2</a>, <span class="emphasis"><em>Installation and the Requirements for Elasticsearch</em></span>, for instructions on how to install the Marvel Agent and the Marvel Kibana dashboard.</p><p>Marvel stores its metrics data inside<a id="id133" class="indexterm"/> Elasticsearch. It is possible to store these metrics alongside production data in the same Elasticsearch cluster; however, this is inadvisable because:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Marvel's data indices can grow quite large and, in a production setting, you won't want these indices affecting the performance of your primary cluster.</li><li class="listitem" style="list-style-type: disc">If the primary cluster is experiencing issues, having Marvel on a separate cluster will allow you to more easily diagnose those issues.</li><li class="listitem" style="list-style-type: disc">If Marvel is running on a normal data node, it can inadvertently be configured to collect data on its own metrics indices. For example, if you log in to the Marvel dashboard and start querying the Marvel indices, these queries will then be logged back to the Marvel indices. This is probably not the intended behavior.</li></ul></div><p>For these reasons, this <a id="id134" class="indexterm"/>chapter covers how to set up a separate Elasticsearch cluster for storing Marvel metrics data. Our primary Elasticsearch cluster from the last chapter contains three data nodes: <code class="literal">elasticsearch-node-01</code>, <code class="literal">elasticsearch-node-02</code>, and <code class="literal">elasticsearch-node-03</code>. We'll add a new cluster with a single Elasticsearch node to store Marvel's data.</p><p>Follow these steps to create a new Elasticsearch cluster for Marvel data:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On a new host called <code class="literal">elasticsearch-marvel-01</code>, install Elasticsearch 2.3.2 using the instructions from <a class="link" href="ch02.html" title="Chapter 2. Installation and the Requirements for Elasticsearch">Chapter 2</a>, <span class="emphasis"><em>Installation and the Requirements for Elasticsearch</em></span>.</li><li class="listitem">Configure Elasticsearch by editing the <code class="literal">elasticsearch.yml</code> configuration file to look like this:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>index.routing.allocation.disable_allocation: false</strong></span>
<span class="strong"><strong>cluster.routing.allocation.enable : all</strong></span>
<span class="strong"><strong>marvel.agent.enabled: false</strong></span>
<span class="strong"><strong>cluster.name: my_monitoring_cluster</strong></span>
<span class="strong"><strong>node.name: elasticsearch-marvel-01</strong></span>
<span class="strong"><strong>bootstrap.mlockall: true</strong></span>
<span class="strong"><strong>discovery.zen.ping.multicast.enabled: false</strong></span>
</pre></div></li><li class="listitem">Install Elasticsearch-head on <code class="literal">elasticsearch-marvel-01</code>:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>    sudo /usr/share/elasticsearch/bin/plugin </strong></span>
<span class="strong"><strong>      install mobz/elasticsearch-head</strong></span>
</pre></div></li><li class="listitem">Install the Marvel Agent on the three primary Elasticsearch nodes (<code class="literal">elasticsearch-node-01</code>, <code class="literal">elasticsearch-node-02</code>, and <code class="literal">elasticsearch-node-03</code>). Log in to each host and run the following command to install Marvel:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>    sudo /usr/share/elasticsearch/bin/plugin install license</strong></span>
<span class="strong"><strong>    sudo /usr/share/elasticsearch/bin/plugin install marvel-agent</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>As mentioned in <a class="link" href="ch02.html" title="Chapter 2. Installation and the Requirements for Elasticsearch">Chapter 2</a>, <span class="emphasis"><em>Installation and the Requirements for Elasticsearch</em></span>, make sure to restart each node after installing Marvel, in order to get the Marvel agent started.</p></div></div></li><li class="listitem">Add the following lines of configuration to the <code class="literal">elasticsearch.yml</code> in each of the original three <code class="literal">elasticsearch-node-0*</code> nodes:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>marvel.agent.exporters:</strong></span>
<span class="strong"><strong>  my_monitoring_cluster:</strong></span>
<span class="strong"><strong>    type: http</strong></span>
<span class="strong"><strong>    host: ["http://elasticsearch-marvel-01:9200"]</strong></span>
</pre></div></li><li class="listitem">For a larger <a id="id135" class="indexterm"/>Marvel cluster with three nodes, for example, the configuration line might look like this:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>marvel.agent.exporters:</strong></span>
<span class="strong"><strong>  my_monitoring_cluster:</strong></span>
<span class="strong"><strong>    type: http</strong></span>
<span class="strong"><strong>    host: ["elasticsearch-marvel-01:9200", "elasticsearch-marvel-02:9200", "elasticsearch-marvel-03:9200"]</strong></span>
</pre></div></li><li class="listitem">Install Kibana and the Marvel Kibana plugin on <code class="literal">elasticsearch-marvel-01</code> using the instructions found in <a class="link" href="ch02.html" title="Chapter 2. Installation and the Requirements for Elasticsearch">Chapter 2</a>, <span class="emphasis"><em>Installation and the Requirements for Elasticsearch</em></span>.</li><li class="listitem">Configure the Marvel Kibana plugin by editing <code class="literal">config/kibana.yml</code> to look like this:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>server.port: 5601</strong></span>
<span class="strong"><strong>server.host: "0.0.0.0"</strong></span>
<span class="strong"><strong>elasticsearch.url: http://elasticsearch-marvel-01:9200</strong></span>
</pre></div></li><li class="listitem">Start Kibana on <code class="literal">elasticsearch-marvel-01</code> from the Kibana installation directory with the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>bin/kibana</strong></span>
</pre></div><p>The output from this command should look like this:</p><div class="mediaobject"><img src="graphics/B03798_04_01.jpg" alt="Setting up Marvel"/></div></li><li class="listitem">Visit the Marvel <a id="id136" class="indexterm"/>dashboard on <code class="literal">elasticsearch-marvel-01</code> in a browser by going to <code class="literal">http://elasticsearch-marvel-01:5601/app/marvel</code>, as seen in the following screenshot:<div class="mediaobject"><img src="graphics/B03798_04_02.jpg" alt="Setting up Marvel"/></div></li><li class="listitem">Scroll down the<a id="id137" class="indexterm"/> page and click the <span class="strong"><strong>Show History</strong></span> or <span class="strong"><strong>Hide History</strong></span> button (highlighted in the next screenshot) to view shard activity for the <code class="literal">twitter</code> index:<div class="mediaobject"><img src="graphics/B03798_04_03.jpg" alt="Setting up Marvel"/></div></li><li class="listitem">Open Elasticsearch-head <a id="id138" class="indexterm"/>on <code class="literal">elasticsearch-marvel-01</code> and view the indices automatically created by Marvel by visiting <code class="literal">http://elasticsearch-marvel-01:9200/_plugin/head/</code>:<div class="mediaobject"><img src="graphics/B03798_04_04.jpg" alt="Setting up Marvel"/></div></li></ol></div><p>The <code class="literal">.marvel-2015.12.20</code> index contains historical data collected by Marvel. By default, Marvel creates one<a id="id139" class="indexterm"/> new index per day to store its data.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>
<span class="strong"><strong>Server time synchronization</strong></span>
</p><p>The clocks on all Elasticsearch hosts must be synchronized or Marvel won't show any data. Clock synchronization varies depending on server setup. On a cluster of Ubuntu hosts, run this command on all nodes to synchronize their clocks:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo ntpupdate pool.ntp.org</strong></span>
</pre></div></div></div></div></div>
<div class="section" title="Upgrading Marvel"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec23"/>Upgrading Marvel</h1></div></div></div><p>Marvel can be upgraded on a<a id="id140" class="indexterm"/> rolling basis. This means that nodes are upgraded one at a time rather than having to shut down the entire cluster to perform an upgrade. For environments with a monitoring cluster and a production cluster, upgrade Marvel on the monitoring cluster before upgrading it on the production cluster.</p><p>To upgrade the Marvel Agent, run these steps on all nodes in the monitoring cluster (in this case, just <code class="literal">elasticsearch-marvel-01</code>), then for each node in the production cluster (<code class="literal">elasticsearch-node-01</code>, <code class="literal">elasticsearch-node-02</code>, and <code class="literal">elasticsearch-node-03</code>):</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Optional: Disable shard allocation on all nodes.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>Disabling shard allocation will make the upgrade faster because the cluster won't try to reallocate shards to other nodes when the node goes down for an upgrade.</p></div></div><p>Run the<a id="id141" class="indexterm"/> following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XPUT elasticsearch-host-01:9200/_cluster/settings </strong></span>
<span class="strong"><strong>-d '{</strong></span>
<span class="strong"><strong>       "transient" : {</strong></span>
<span class="strong"><strong>           "cluster.routing.allocation.enable" : "none"</strong></span>
<span class="strong"><strong>       }</strong></span>
<span class="strong"><strong> }' </strong></span>
</pre></div></li><li class="listitem">Stop Elasticsearch:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /etc/init.d/elasticsearch stop</strong></span>
</pre></div></li><li class="listitem">Remove the old Marvel plugin:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>bin/plugin remove marvel-agent</strong></span>
</pre></div></li><li class="listitem">Install the new Marvel plugin:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>plugin install marvel-agent </strong></span>
</pre></div></li><li class="listitem">Start Elasticsearch:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /etc/init.d/elasticsearch start </strong></span>
</pre></div></li><li class="listitem">Check logs for errors:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>tail -f /var/log/elasticsearch/*</strong></span>
</pre></div></li><li class="listitem">Once all nodes in the cluster are upgraded, re-enable shard allocation:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XPUT elasticsearch-host-01:9200/_cluster/settings -d '{ </strong></span>
<span class="strong"><strong>    "transient" : { </strong></span>
<span class="strong"><strong>        "cluster.routing.allocation.enable" : "all" </strong></span>
<span class="strong"><strong>    } </strong></span>
<span class="strong"><strong>}'</strong></span>
</pre></div></li><li class="listitem">Repeat all of these steps for the production cluster.<p>To upgrade the Marvel Kibana dashboard, run the following commands on <code class="literal">elasticsearch-marvel-01</code>
</p></li><li class="listitem">Uninstall the old Marvel Kibana plugin with the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>bin/kibana plugin --remove marvel</strong></span>
</pre></div></li><li class="listitem">Install the <a id="id142" class="indexterm"/>new Marvel Kibana plugin. In this example, we are upgrading to Marvel 2.3.2:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>bin/kibana plugin install marvel</strong></span>
<span class="strong"><strong>/2.3.2</strong></span>
</pre></div></li></ol></div></div>
<div class="section" title="Configuring Marvel"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec24"/>Configuring Marvel</h1></div></div></div><p>This section covers how to<a id="id143" class="indexterm"/> configure the Marvel Agent and data index. Specifically, we cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting the Marvel data store location</li><li class="listitem" style="list-style-type: disc">Specifying which indices to monitor</li><li class="listitem" style="list-style-type: disc">Security settings</li><li class="listitem" style="list-style-type: disc">Data export frequency</li><li class="listitem" style="list-style-type: disc">Marvel index configuration</li></ul></div><div class="section" title="Marvel agent configuration settings"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec43"/>Marvel agent configuration settings</h2></div></div></div><p>This section covers<a id="id144" class="indexterm"/> configuring the Marvel Agent. Configure the Agent by editing the <code class="literal">elasticsearch.yml</code> file on each node we are monitoring.</p><p>The <code class="literal">marvel.agent.exporters</code> setting determines where the Agent will deliver its metrics to. By default, the Marvel agent will export data to the same Elasticsearch instance that it is installed on. In our example cluster, we are exporting data to <code class="literal">elasticsearch-marvel-01</code>, and the configuration value looks like this:</p><div class="informalexample"><pre class="programlisting">marvel.agent.exporters:
  my_monitoring_cluster:
    type: http
    host: ["http://elasticsearch-marvel-01:9200"]</pre></div><p>Other options for the <code class="literal">marvel.agent.exporters</code> settings include:</p><div class="informalexample"><pre class="programlisting">marvel.agent.exporters:
  your_exporter_name:
    type: http # Set to local or http
    host: [ "http://host-01:9200", "http://host-02:9200" ]
    # List of hosts to send data to over http or https

    auth:
      username: basic_auth_username # optional           
      password: basic_auth_password # optional

    connection:
      timeout: 6s # optional: connection timeout 
      read_timeout: 60s # optional: response timeout.
      keep_alive: true # persistent connections 

    ssl:
      hostname_verification: true # https only: verify host certificate
      protocol: TLSv1.2 # https only: protocol
      truststore.path: /path/to/file # https only:  
.jks truststore
      truststore.password: password # https only: .jks truststore password
      truststore.algorithm: SunX509 # https only: .jks truststore algorithm

    index:
      name:
        time_format: YYYY.MM.dd 
        # marvel index suffix.  
        # Set to a value like YYYY.MM to create new 
        # indices monthly instead of daily</pre></div><p>Other <code class="literal">elasticsearch.yml</code> configuration<a id="id145" class="indexterm"/> options are described here:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Option</p>
</th><th style="text-align: left" valign="bottom">
<p>Default Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">marvel.enabled</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">true</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Controls <a id="id146" class="indexterm"/>whether monitoring data will be exported from this node. </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">marvel.agent.interval</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">10s</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Time<a id="id147" class="indexterm"/> interval between monitoring data exports. Can be set to <code class="literal">-1</code> to disable exporting of data altogether.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">marvel.agent.indices</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">_all List of</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Indices to<a id="id148" class="indexterm"/> export data from. Supports wildcard <code class="literal">*</code>, addition <code class="literal">+</code>, and subtraction <code class="literal">-</code> operators. For example, to export data only from nodes that start with <code class="literal">twitter_</code>, except for the index <code class="literal">twitter_development</code>, we would set this parameter to <code class="literal">+twitter_*,-twitter_development</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">marvel.agent.cluster.state.timeout</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">10m</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Timeout for<a id="id149" class="indexterm"/> collecting cluster state. </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">marvel.agent.cluster.stats.timeout</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">10m</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Timeout for<a id="id150" class="indexterm"/> collecting cluster statistics.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">marvel.history.duration</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">7d</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Length <a id="id151" class="indexterm"/>of time to retain Marvel indices. The <code class="literal">marvel-agent</code> will automatically delete indices older than this value. Set to <code class="literal">-1</code> to disable automatic index deletion.</p>
</td></tr></tbody></table></div><p>After making <a id="id152" class="indexterm"/>any changes to <code class="literal">elasticsearch.yml</code>, restart Elasticsearch:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /etc/init.d/elasticsearch restart</strong></span>
</pre></div></div></div>
<div class="section" title="Marvel index configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec25"/>Marvel index configuration</h1></div></div></div><p>This section covers <a id="id153" class="indexterm"/>how to configure the number of shards, replicas, and various other index settings used by Marvel. By default, each Marvel index uses one shard and one replica:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To view the default settings used by Marvel, run:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XGET "http://elasticsearch-marvel-01:9200/_template/marvel?pretty"</strong></span>
</pre></div><p>This will return a large JSON object. The settings that are important are <code class="literal">marvel.order</code>, <code class="literal">marvel.template</code>, and <code class="literal">marvel.settings</code>:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "marvel" : {</strong></span>
<span class="strong"><strong>    "order" : 0,</strong></span>
<span class="strong"><strong>    "template" : ".marvel*",</strong></span>
<span class="strong"><strong>    "settings" : {</strong></span>
<span class="strong"><strong>      "index.mapper.dynamic" : "true",</strong></span>
<span class="strong"><strong>      "index.marvel.index_format" : "6",</strong></span>
<span class="strong"><strong>      "index.analysis.analyzer.default.type" : "standard",</strong></span>
<span class="strong"><strong>      "index.number_of_replicas" : "1",</strong></span>
<span class="strong"><strong>      "index.number_of_shards" : "1",</strong></span>
<span class="strong"><strong>      "index.analysis.analyzer.default.stopwords" : "_none_"</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    ...</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></li><li class="listitem">For large Marvel clusters, consider increasing the number of shards to no more than the number of hosts in your cluster for optimal performance. For example, for a<a id="id154" class="indexterm"/> four-node Marvel monitoring cluster, increase the number of shards to four with the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XPOST  "http://elasticsearch-marvel-01:9200/_template/marvel_01?pretty" -d '{</strong></span>
<span class="strong"><strong>    "template": ".marvel*",</strong></span>
<span class="strong"><strong>    "order": 1,</strong></span>
<span class="strong"><strong>    "settings": {</strong></span>
<span class="strong"><strong>        "number_of_shards": 4</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>}'</strong></span>
</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>Notice the template is set to <code class="literal">.marvel*</code> in order to only alter Marvel's indices. Additionally, the <code class="literal">order</code> setting is <code class="literal">1</code> so this template, <code class="literal">marvel_01</code>, will have higher precedence than the default template <code class="literal">marvel</code>.</p></div></div><p>Now, when checking the Marvel settings, we should see:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>curl -XGET "http://elasticsearch-marvel-01:9200/_template/marvel_01?pretty"</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "marvel_01" : {</strong></span>
<span class="strong"><strong>    "order" : 1,</strong></span>
<span class="strong"><strong>    "template" : ".marvel*",</strong></span>
<span class="strong"><strong>    "settings" : {</strong></span>
<span class="strong"><strong>      "index.number_of_shards" : "4"</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    "mappings" : { },</strong></span>
<span class="strong"><strong>    "aliases" : { }</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></div>
<div class="section" title="Understanding the Marvel dashboard"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec26"/>Understanding the Marvel dashboard</h1></div></div></div><p>This section covers how<a id="id155" class="indexterm"/> to use the Marvel dashboard to better understand the state of your cluster.</p><p>To make <a id="id156" class="indexterm"/>monitoring our cluster more interesting, we'll stream more Twitter data into it using the <code class="literal">stream2es</code> program, and run random queries against the index using a custom bash script described in this section.</p><p>See <a class="link" href="ch03.html" title="Chapter 3. Elasticsearch-head and Bigdesk">Chapter 3</a>, <span class="emphasis"><em>Elasticsearch-head and Bigdesk</em></span> for detailed instructions on how to install and use <code class="literal">stream2es</code>, but, for quick reference, start <code class="literal">stream2es</code> using the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>./stream2es twitter --target http://elasticsearch-node-01:9200/twitter/status</strong></span>
</pre></div><p>Next, we'll simulate user interactions by running random queries against the <code class="literal">twitter</code> index. Create a new bash script called <code class="literal">run_queries.sh</code> with the following content:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

# Path to dictionary file
DICTIONARY_PATH=/usr/share/dict/words
ELASTICSEARCH_URI=http://elasticsearch-node-01:9200/twitter

# Total dictionary words
TOTAL_WORDS=`wc -l $DICTIONARY_PATH | awk '{print $1}'`

while :
do
    # Pick a random word
    WORD_INDEX=`python -c "import random;print random.randint(1,$TOTAL_WORDS)"`
    WORD=`sed "${WORD_INDEX}q;d" $DICTIONARY_PATH`

    # Run query
    echo "Querying elasticsearch $ELASTICSEARCH_URI for $WORD "
    curl -XGET "${ELASTICSEARCH_URI}/_search?q=$WORD"

    # Sleep for one second before running the next query
    echo
    echo "Press [CTRL+C] to stop.."
    sleep 1
done</pre></div><p>This script queries the Elasticsearch <code class="literal">twitter</code> index with a random dictionary word once every second.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>You may need to install a dictionary on some Linux systems to get this to work. On Ubuntu, to get a dictionary of American English or British English words, run the following.</p><p>For American English:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo apt-get install wamerican</strong></span>
</pre></div><p>For British English:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo apt-get install wbritish</strong></span>
</pre></div></div></div><p>Now make<a id="id157" class="indexterm"/> the <code class="literal">run_queries.sh</code> script executable:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>chmod +x run_queries.sh</strong></span>
</pre></div><p>And finally, run the <code class="literal">run_queries.sh</code> script to start hitting our cluster with random queries once a second:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>./run_queries.sh</strong></span>
</pre></div><p>After running <code class="literal">stream2es</code> and <code class="literal">run_queries.sh</code> for a few minutes, open Marvel and navigate to the Overview dashboard to explore the impact of these scripts on our cluster.</p><div class="section" title="Overview dashboard"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec44"/>Overview dashboard</h2></div></div></div><p>The <span class="strong"><strong>Overview</strong></span> dashboard is the<a id="id158" class="indexterm"/> landing page of the Marvel Kibana dashboard. After running the <code class="literal">stream2es</code> command and <code class="literal">run_queries.sh</code> script mentioned previously for a few minutes, this dashboard will look something like this:</p><div class="mediaobject"><img src="graphics/B03798_04_05.jpg" alt="Overview dashboard"/></div><p>Here are the<a id="id159" class="indexterm"/> labels from the previous screenshot:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>No.</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>1</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Dashboard title.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>2</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Other Marvel dashboards.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>3</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Page auto-refresh interval.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>4</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Time filter. Defaults to <span class="strong"><strong>Last 1 hour</strong></span>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>5</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Cluster information including cluster status, number of nodes, total memory, and number of documents.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>6</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Current and historical search rate. Sample use case: see how heavy search traffic affects the cluster.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>7</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Current and historical search latency. Sample use case: diagnose why queries are running slow.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>8</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Current and historical indexing rate. Sample use case: diagnose why a bulk index operation failed.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>9</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Current<a id="id160" class="indexterm"/> and historical indexing latency. Sample use case: diagnose why indexing operations are slow.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>10</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Shard activity. Gives the status of shards when they are recovering.</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>Note that <code class="literal">run_queries.sh</code> only runs one query per second, but the <span class="strong"><strong>Search Request Rate</strong></span> chart shows an average of about three queries per second. This is because every time a query is run, it's actually being run against all three data nodes. The <span class="strong"><strong>Search Request Rate</strong></span> chart shows the average queries per second across all data nodes.</p></div></div><p>Any of Marvel's charts can be filtered by time range by clicking and dragging on the chart, shown in the following figure:</p><div class="mediaobject"><img src="graphics/B03798_04_06.jpg" alt="Overview dashboard"/></div><p>Here is the label<a id="id161" class="indexterm"/> from the previous screenshot:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Number</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>1</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Click and drag on any chart to filter the chart by time.</p>
</td></tr></tbody></table></div><p>After applying a filter, the Marvel charts and cluster information banner will update to show the state of the cluster at the selected moment in time. In the following screenshot, we can see that the cluster was in a <code class="literal">yellow</code> state during the selected time period:</p><div class="mediaobject"><img src="graphics/B03798_04_07.jpg" alt="Overview dashboard"/></div></div><div class="section" title="Indices dashboard"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec45"/>Indices dashboard</h2></div></div></div><p>The <span class="strong"><strong>Indices</strong></span> dashboard lets<a id="id162" class="indexterm"/> you examine historical data for a specific index, including:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Search rate</li><li class="listitem" style="list-style-type: disc">Index rate</li><li class="listitem" style="list-style-type: disc">Index size</li><li class="listitem" style="list-style-type: disc">Memory</li><li class="listitem" style="list-style-type: disc">Document count</li><li class="listitem" style="list-style-type: disc">Field data size</li></ul></div><p>The <span class="strong"><strong>Indices</strong></span> dashboard is very similar to the <span class="strong"><strong>Overview</strong></span> dashboard, except for the list of indices at the bottom of the page, as seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03798_04_08.jpg" alt="Indices dashboard"/></div><p>Here is the<a id="id163" class="indexterm"/> label from the preceding screenshot:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Number</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>1</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>List of all indices in the cluster. </p>
</td></tr></tbody></table></div><p>Click on the <code class="literal">twitter</code> index at the bottom of this page to bring us to a page showing historical and real-time metrics for that particular index:</p><div class="mediaobject"><img src="graphics/B03798_04_09.jpg" alt="Indices dashboard"/></div><p>Here are the<a id="id164" class="indexterm"/> labels from the previous screenshot:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Number</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>1</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Index details.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>2</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Historical and real-time search rate for the index.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>3</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Historical and real-time indexing rate.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>4</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Historical and real-time index size.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>5</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Historical and real-time Lucene memory size.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>6</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Historical and real-time document count.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>7</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Historical and real-time field data size. Sample use case: diagnose <code class="literal">OutOfMemoryError</code> exceptions.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>8</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Shard<a id="id165" class="indexterm"/> distribution for this index. Click on any of the nodes to go to the node details page, described in the next section.</p>
</td></tr></tbody></table></div></div><div class="section" title="Nodes dashboard"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec46"/>Nodes dashboard</h2></div></div></div><p>The <span class="strong"><strong>Nodes</strong></span> dashboard<a id="id166" class="indexterm"/> provides an overview of the cluster's health and node utilization, in addition to historical and real-time statistics for specific nodes. This dashboard is used to examine Elasticsearch issues such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Nodes in the cluster that are down</li><li class="listitem" style="list-style-type: disc">Nodes that are running low on disk space</li><li class="listitem" style="list-style-type: disc">Nodes with high CPU and memory usage</li></ul></div><p>Opening the <span class="strong"><strong>Nodes</strong></span> dashboard brings us to the following page:</p><div class="mediaobject"><img src="graphics/B03798_04_10.jpg" alt="Nodes dashboard"/></div><p>This screenshot shows an overview of all nodes in the cluster, along with some real-time metrics. One advantage this page has over Elasticsearch-head is that if a node goes down, this page will identify that the node used to be part of the cluster but is currently offline. Elasticsearch-head on the other hand won't display the offline node at all.</p><p>Clicking on a specific node opens up a dashboard showing data only for that host. The next screenshot shows the node stats for <code class="literal">elasticsearch-node-02</code>:</p><div class="mediaobject"><img src="graphics/B03798_04_11.jpg" alt="Nodes dashboard"/></div><p>This page shows <a id="id167" class="indexterm"/>several historical and real-time metrics for the selected node:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Search Latency</strong></span>: Historical analysis of search performance.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Index Latency</strong></span>: Historical analysis of data index performance.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>JVM Heap Usage</strong></span>: High heap usage may indicate Java <code class="literal">OutOfMemoryError</code> exceptions.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>CPU Utilization</strong></span>: High CPU utilization can be caused by a number of factors, but some common causes are running complex queries and shard movement.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>System Load Average</strong></span>: This metric is a measure of the average amount of work performed by the node. This value should ideally be less than the number of CPU cores on the node.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Segment Count</strong></span>: Number of Lucene segments. This statistic will vary from cluster to cluster, but if the value increases to higher than usual, try running a cluster<a id="id168" class="indexterm"/> optimization.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Shard Legend</strong></span>: Shows what shards are allocated to this node.</li></ul></div></div></div>
<div class="section" title="Monitoring node failures"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec27"/>Monitoring node failures</h1></div></div></div><p>As mentioned previously, Marvel keeps track of nodes even after they leave the cluster. This is useful<a id="id169" class="indexterm"/> when working with large clusters that have many nodes to keep track of.</p><p>We will demonstrate how the Marvel <span class="strong"><strong>Nodes</strong></span> dashboard displays node failures by shutting down <code class="literal">elasticsearch-node-01</code>:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong># From elasticsearch-node-01</strong></span>
<span class="strong"><strong>sudo service elasticsearch stop</strong></span>
</pre></div><p>The <span class="strong"><strong>Nodes</strong></span> dashboard in Marvel now looks like this:</p><div class="mediaobject"><img src="graphics/B03798_04_12.jpg" alt="Monitoring node failures"/></div><p>Here we can see <a id="id170" class="indexterm"/>Marvel indicates <code class="literal">elasticsearch-node-01</code> used to be part of the cluster, but is currently offline.</p><p>Elasticsearch-head, on the other hand, shows us the cluster in a <code class="literal">yellow</code> state, but does not indicate that <code class="literal">elasticsearch-node-01</code> was ever part of the cluster:</p><div class="mediaobject"><img src="graphics/B03798_04_13.jpg" alt="Monitoring node failures"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>Elasticsearch-head only <a id="id171" class="indexterm"/>displays <code class="literal">elasticsearch-node-02</code> and <code class="literal">elasticsearch-node-03</code>, not <code class="literal">elasticsearch-node-01</code>.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec28"/>Summary</h1></div></div></div><p>This chapter covered how to install and configure the Marvel Agent and the Marvel Kibana dashboard. Additionally, it covered setting up a secondary monitoring cluster for Marvel to store its metrics. Finally, the chapter talked about the various Marvel Kibana dashboard pages and discussed at a high level how to use those pages to diagnose cluster issues. The next chapter talks about another monitoring tool, Kopf, and goes into more detail about how to use Kibana.</p></div></body></html>