<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Advanced Maven Usage"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Advanced Maven Usage</h1></div></div></div><p>Let us look at the following recipes in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating an assembly</li><li class="listitem" style="list-style-type: disc">Running a custom executable</li><li class="listitem" style="list-style-type: disc">Running an ANT task</li><li class="listitem" style="list-style-type: disc">Determining updates to Maven plugins</li><li class="listitem" style="list-style-type: disc">Determining updates to Maven dependencies</li><li class="listitem" style="list-style-type: disc">Controlling the constraints</li><li class="listitem" style="list-style-type: disc">Generating unique builds</li><li class="listitem" style="list-style-type: disc">Releasing a Maven project</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec104"/>Introduction</h1></div></div></div><p>In this chapter, we look at using features of Maven that may not be required on a regular basis or for projects. These range from assembling your project for distribution to releasing your project. These are not typical build tasks, but essential elements of a project lifecycle.</p></div></div>
<div class="section" title="Creating an assembly"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec105"/>Creating an assembly</h1></div></div></div><p>A typical project<a id="id564" class="indexterm"/> requirement is to aggregate the project output along with its dependencies, modules, and other files into a single distributable archive. An assembly is a group of files, directories, and dependencies that are assembled into an archive format and distributed. Maven provides prefabricated assembly descriptors to build these assemblies. The descriptors handle common operations, such as packaging a project's artifact, along with the dependencies.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec263"/>Getting ready</h2></div></div></div><p>Maven should be set up on <a id="id565" class="indexterm"/>your system and verified to work. To do this, refer to <a class="link" href="ch01.html" title="Chapter 1. Getting Started">Chapter 1</a>, <span class="emphasis"><em>Getting Started</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec264"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a Maven project for which you want to generate the assembly; in our case, <code class="literal">project-with-assembly</code>.</li><li class="listitem">Add the following plugin and configuration to the pom file:<div class="informalexample"><pre class="programlisting">&lt;plugin&gt;
  &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt; 
  &lt;version&gt;2.5.3&lt;/version&gt;
  &lt;configuration&gt;
    &lt;descriptorRefs&gt;
      &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;
    &lt;/descriptorRefs&gt;
    &lt;archive&gt;
      &lt;manifest&gt;
        &lt;mainClass&gt;com.packt.cookbook.App&lt;/mainClass&gt;
      &lt;/manifest&gt;
    &lt;/archive&gt;
  &lt;/configuration&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;make-assembly&lt;/id&gt; 
      &lt;phase&gt;package&lt;/phase&gt; 
      &lt;goals&gt;
        &lt;goal&gt;single&lt;/goal&gt;
      &lt;/goals&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre></div></li><li class="listitem">Run the following Maven command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn clean package</strong></span>
</pre></div></li><li class="listitem">Observe the output:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[INFO] --- maven-assembly-plugin:2.5.3:single (make-assembly) @ project-with-assembly ---</strong></span>
<span class="strong"><strong>[INFO] Building jar: C:\projects\apache-maven-cookbook\project-with-assembly\target\project-with-assembly-1.0-SNAPSHOT-jar-with-dependencies.jar</strong></span>
</pre></div></li><li class="listitem">Run the created distribution JAR:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>C:\projects\apache-maven-cookbook\project-with-assembly\target&gt;java -jar project-with-assembly-1.0-SNAPSHOT-jar-with-dependencies.jar</strong></span>
<span class="strong"><strong>07:13:25.660 [main] INFO  com.packt.cookbook.App - Hello World</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec265"/>How it works...</h2></div></div></div><p>We made the following <a id="id566" class="indexterm"/>changes to the pom file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We chose <code class="literal">jar-with-dependencies</code>, one of the prefabricated assembly descriptors provided by the Maven Assembly plugin. This creates a single JAR with all the dependencies of the project.</li><li class="listitem" style="list-style-type: disc">We also used the <code class="literal">archive</code> configuration to specify the main class of the project. This is to make the JAR file executable.</li><li class="listitem" style="list-style-type: disc">We then specified when the single goal of assembly should be run, namely, the <code class="literal">package</code> phase.</li></ul></div><p>When Maven ran, it used the preceding configurations to assemble a JAR with dependencies in the package phase. We could run this as a normal executable JAR.</p><p>Besides predefined descriptors, the Maven Assembly plugin also allows us to create custom descriptors that can have fine-grained control over the contents of the assembly.</p><p>The Assembly plugin can also build an assembly from a multi-module project, where the modules can be part of the final assembly.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec266"/>There's more...</h2></div></div></div><p>While opening the JAR file, you would have observed that all the dependant JARs have been unpacked as well.</p><div class="mediaobject"><img src="graphics/6124OS_11_12.jpg" alt="There's more..."/></div><p>This is due to the default configuration for the predefined descriptor. Let us see how to create the same distribution but retain dependant JARs as they are. To do this, we will now use one Maven JAR plugin, which uses a custom class loader to load dependant JARs within the parent JAR:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the project for which you want to create an executable with unpackaged dependant jars (<code class="literal">project-with-one-jar</code>).</li><li class="listitem">Add the<a id="id567" class="indexterm"/> following plugin in the pom file:<div class="informalexample"><pre class="programlisting">    &lt;plugin&gt;
        &lt;groupId&gt;org.dstovall&lt;/groupId&gt;
        &lt;artifactId&gt;onejar-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.4.4&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;make-assembly&lt;/id&gt; 
            &lt;phase&gt;package&lt;/phase&gt; 
            &lt;goals&gt;
              &lt;goal&gt;one-jar&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;</pre></div></li><li class="listitem">Add the JAR plugin to specify the main class for the executable JAR:<div class="informalexample"><pre class="programlisting">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
    &lt;archive&gt;
        &lt;manifest&gt;
                 &lt;mainClass&gt;com.packt.cookbook.App&lt;/mainClass&gt;
        &lt;/manifest&gt;
     &lt;/archive&gt;
   &lt;/configuration&gt;
&lt;/plugin&gt;</pre></div></li><li class="listitem">Add the following code as the plugin binaries are not in the central Maven repository:<div class="informalexample"><pre class="programlisting">    &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
            &lt;id&gt;onejar-maven-plugin.googlecode.com&lt;/id&gt;
            &lt;url&gt;http://onejar-maven-plugin.googlecode.com/svn/mavenrepo&lt;/url&gt;
        &lt;/pluginRepository&gt;
   &lt;/pluginRepositories&gt;</pre></div></li><li class="listitem">Run the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn package</strong></span>
</pre></div></li><li class="listitem">Run the generated executable and observe the result:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>java -jar project-with-one-jar-1.0-SNAPSHOT.one-jar.jar</strong></span>
<span class="strong"><strong>06:57:45.995 [main] INFO  com.packt.cookbook.App - Hello World</strong></span>
</pre></div></li><li class="listitem">Open the <a id="id568" class="indexterm"/>created JAR file:<div class="mediaobject"><img src="graphics/6124OS_11_01.jpg" alt="There's more..."/></div><p>We can see that in contrast to the assembly JAR, the executable JAR is created without unpacking the libraries (dependencies) involved.</p></li><li class="listitem">Navigate to the <code class="literal">lib</code> folder in the JAR:<div class="mediaobject"><img src="graphics/6124OS_11_13.jpg" alt="There's more..."/></div><p>The dependant JARs are stored in the <code class="literal">lib</code> folder.</p></li></ol></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec267"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Generating an executable JAR</em></span> recipe in <a class="link" href="ch10.html" title="Chapter 10. Java Development with Maven">Chapter 10</a>, <span class="emphasis"><em>Java Development with Maven</em></span></li></ul></div></div></div>
<div class="section" title="Running a custom executable"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec106"/>Running a custom executable</h1></div></div></div><p>There are many <a id="id569" class="indexterm"/>situations when you want Maven to run a specific executable on your computer. A simple use case would be to run the JAR that you created. Another case would be to have Maven run commands that are not provided as plugins (for instance, create a native Windows installer).</p><p>Maven provides support to run any executable system in a separate process along with Java programs in the same virtual machine on which Maven runs. The Maven Exec plugin provides this support using the <code class="literal">exec</code> goal (to run in a separate process) and the <code class="literal">java</code> goal (to run Java programs in the same process).</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec268"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a simple Maven project (<code class="literal">simple-project</code>).</li><li class="listitem">Run the command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn clean package exec:java –Dexec.mainClass="com.packt.cookbook.App"</strong></span>
</pre></div></li><li class="listitem">Observe the results:<div class="mediaobject"><img src="graphics/6124OS_11_02.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec269"/>How it works...</h2></div></div></div><p>We wanted to run the JAR file that we had created in the project. To do this, we called the <code class="literal">java</code> goal of the Maven Exec plugin. We provided the plugin with the required parameter (<code class="literal">mainClass</code>) so that it knew which main class needed to be run.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec270"/>There's more...</h2></div></div></div><p>You could integrate the running of the executable as part of the project lifecycle. Let us do this for our example:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the project (let's call it <code class="literal">project-with-exec</code>).</li><li class="listitem">Add the following code to the pom file:<div class="informalexample"><pre class="programlisting">      &lt;plugin&gt;
          &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
          &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
          &lt;version&gt;1.3.2&lt;/version&gt;
          &lt;executions&gt;
            &lt;execution&gt;
              &lt;id&gt;hello-world&lt;/id&gt;
              &lt;phase&gt;package&lt;/phase&gt;
              &lt;goals&gt;
                &lt;goal&gt;java&lt;/goal&gt;
              &lt;/goals&gt;
            &lt;/execution&gt;
          &lt;/executions&gt;
          &lt;configuration&gt;
            &lt;mainClass&gt;com.packt.cookbook.App&lt;/mainClass&gt;
          &lt;/configuration&gt;
        &lt;/plugin&gt;</pre></div></li><li class="listitem">Run the<a id="id570" class="indexterm"/> following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn clean package</strong></span>
</pre></div></li><li class="listitem">Observe the result:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ project-with-exec ---</strong></span>
<span class="strong"><strong>[INFO] Building jar: C:\projects\apache-maven-cookbook\project-with-exec\target\</strong></span>
<span class="strong"><strong>project-with-exec-1.0-SNAPSHOT.jar</strong></span>
<span class="strong"><strong>[INFO]</strong></span>
<span class="strong"><strong>[INFO] --- exec-maven-plugin:1.3.2:java (hello-world) @ project-with-exec ---</strong></span>
<span class="strong"><strong>[WARNING] Warning: killAfter is now deprecated. Do you need it ? Please comment</strong></span>
<span class="strong"><strong>on MEXEC-6.</strong></span>
<span class="strong"><strong>06:25:26.005 [com.packt.cookbook.App.main()] INFO  com.packt.cookbook.App - Hell</strong></span>
<span class="strong"><strong>o World</strong></span>
<span class="strong"><strong>[INFO] ------------------------------------------------------------------------</strong></span>
</pre></div></li></ol></div><p>The project is run during the package phase based on the configuration that we specified in the plugin.</p><p>The same can be done for non-Java executables; we need to invoke the <code class="literal">exec</code> goal instead of the <code class="literal">java</code> goal.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip24"/>Tip</h3><p>Running system executables makes the build nonportable, so use it with care.</p></div></div></div></div>
<div class="section" title="Running an ANT task"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec107"/>Running an ANT task</h1></div></div></div><p>ANT <a id="id571" class="indexterm"/>is a popular build automation tool that provides a great degree of flexibility. It also provides tasks, such as <code class="literal">echo</code> and <code class="literal">touch</code>, that are not available in Maven. There might be advantages in combining ANT tasks with Maven to achieve certain goals, though it is best to avoid it until it's inevitable.</p><p>Maven provides a <a id="id572" class="indexterm"/>mechanism to run arbitrary ANT tasks by way of the Maven AntRun plugin. Let us see how to use this to run an ANT task in our project.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec271"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a project for which you want to run ANT tasks (<code class="literal">project-with-ant</code>).</li><li class="listitem">Add the following plugin configuration to the pom file:<div class="informalexample"><pre class="programlisting">     &lt;plugin&gt;
        &lt;artifactId&gt;maven-antrun-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.8&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;configuration&gt;
              &lt;target&gt;
                  &lt;echo message="Calling ant task in package phase"/&gt;
              &lt;/target&gt;
            &lt;/configuration&gt;
            &lt;goals&gt;
              &lt;goal&gt;run&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;</pre></div></li><li class="listitem">Run the following Maven command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn clean package</strong></span>
</pre></div></li><li class="listitem">Observe the output:<div class="mediaobject"><img src="graphics/6124OS_11_03.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec272"/>How it works...</h2></div></div></div><p>We configured the <a id="id573" class="indexterm"/>Maven AntRun plugin to run an ANT target during the <code class="literal">package</code> phase. In the ANT target, we specified a simple <code class="literal">echo</code> task, which outputted a string we wanted.</p><p>Instead of the <code class="literal">echo</code> task, we could write more complex tasks. The Maven AntRun plugin also provides a means for ANT tasks to refer to Maven properties, class paths, and others.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec273"/>There's more...</h2></div></div></div><p>It is good practice to separate ANT tasks to a separate ANT build script (<code class="literal">build.xml</code>) and invoke the same from Maven. Let us see how to do this:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a simple ANT build script, <code class="literal">build.xml</code>, and add the following contents:<div class="informalexample"><pre class="programlisting">  &lt;project name="project-with-ant" default="echo" basedir="."&gt;
    &lt;description&gt;
        Simple ant task to echo a string
    &lt;/description&gt;

    &lt;target name="echo"&gt;
        &lt;echo message="Hello World"/&gt;
   &lt;/target&gt;
&lt;/project&gt; </pre></div></li><li class="listitem">Replace the <code class="literal">target</code> configuration in the pom file as follows:<div class="informalexample"><pre class="programlisting">&lt;target&gt;
    &lt;ant target="echo"/&gt;
 &lt;/target&gt;</pre></div></li><li class="listitem">Run the Maven command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn clean package</strong></span>
</pre></div></li><li class="listitem">Observe the output:<div class="mediaobject"><img src="graphics/6124OS_11_04.jpg" alt="There's more..."/></div></li></ol></div><p>The result is the same, but <a id="id574" class="indexterm"/>now the ANT scripts are separated from Maven.</p></div></div>
<div class="section" title="Determining updates to Maven plugin AntRun"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec108"/>Determining updates to Maven plugin AntRun</h1></div></div></div><p>In our build scripts, we <a id="id575" class="indexterm"/>explicitly specify the version of the Maven<a id="id576" class="indexterm"/> plugins that we use. This is required in order to create reproducible builds. In the absence of the version, Maven gives a warning such as the following:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[WARNING] Some problems were encountered while building the effective model for</strong></span>
<span class="strong"><strong>com.packt.cookbook:project-with-exec:jar:1.0-SNAPSHOT</strong></span>
<span class="strong"><strong>[WARNING] 'build.plugins.plugin.version' for org.codehaus.mojo:exec-maven-plugin is missing. @ line 42, column 17</strong></span>
<span class="strong"><strong>[WARNING]</strong></span>
<span class="strong"><strong>[WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.</strong></span>
<span class="strong"><strong>[WARNING]</strong></span>
<span class="strong"><strong>[WARNING] For this reason, future Maven versions might no longer support building such malformed projects.</strong></span>
</pre></div><p>Over a period of time, there could be updates to these plugins. It would be good to know if there are any so that we can suitably update the plugin versions. Let us see how we can do this.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec274"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Take a project for which you want to check the plugin update (<code class="literal">project-with-exec</code>).</li><li class="listitem">Change the version of the plugin to an older one:<div class="informalexample"><pre class="programlisting">  &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
   &lt;version&gt;1.2&lt;/version&gt;&gt;</pre></div></li><li class="listitem">Run the<a id="id577" class="indexterm"/> following<a id="id578" class="indexterm"/> command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn versions:display-plugin-updates</strong></span>
</pre></div></li><li class="listitem">Observe the output:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[INFO] --- versions-maven-plugin:2.0:display-plugin-updates (default-cli) @ proj</strong></span>
<span class="strong"><strong>ect-with-exec ---</strong></span>
<span class="strong"><strong>[INFO]</strong></span>
<span class="strong"><strong>[INFO] All plugins with a version specified are using the latest versions.</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>[WARNING] The following plugins do not have their version specified:</strong></span>
<span class="strong"><strong>[WARNING]   maven-clean-plugin .......................... (from super-pom) 2.5</strong></span>
<span class="strong"><strong>[WARNING]   maven-compiler-plugin ....................... (from super-pom) 3.1</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>[WARNING] Project does not define minimum Maven version, default is: 2.0</strong></span>
<span class="strong"><strong>[INFO] Plugins require minimum Maven version of: 2.2.1</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>[ERROR] Project does not define required minimum version of Maven.</strong></span>
<span class="strong"><strong>[ERROR] Update the pom.xml to contain</strong></span>
<span class="strong"><strong>[ERROR]     &lt;prerequisites&gt;</strong></span>
<span class="strong"><strong>[ERROR]       &lt;maven&gt;2.2.1&lt;/maven&gt;</strong></span>
<span class="strong"><strong>[ERROR]     &lt;/prerequisites&gt;</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>[INFO] Require Maven 2.2.1 to use the following plugin updates:</strong></span>
<span class="strong"><strong>[INFO]   maven-jar-plugin ................................................ 2.5</strong></span>
<span class="strong"><strong>[INFO]   maven-site-plugin ............................................... 3.2</strong></span>
<span class="strong"><strong>[INFO]   org.codehaus.mojo:exec-maven-plugin ........................... 1.3.2</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec275"/>How it works...</h2></div></div></div><p>The <code class="literal">display-plugin-updates</code> goal<a id="id579" class="indexterm"/> of the Maven Versions plugin downloads the metadata for all <a id="id580" class="indexterm"/>the plugins specified in the pom file and then <a id="id581" class="indexterm"/>produces a report. The report reveals a number of things that are of interest.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A <code class="literal">prerequisites</code> tag is absent. The <code class="literal">prerequisites</code> tag in the pom file specifies the minimum version of Maven that is required to build the project. In the absence of this, Maven takes the minimum version as <code class="literal">2.0</code>. There is a risk of nonreproducible builds if different developers use different versions of Maven. Hence, it is a good practice to specify a minimum version by using this tag.</li><li class="listitem" style="list-style-type: disc">There is a warning about plugin versions not being defined. As we have seen, plugins in the pom file don't need to be specified explicitly unless they need to be configured. Now, Maven still uses various plugins for execution (such as clean, resources, compile, test, and so on) and it needs to determine the version to be used. It uses the version specified by the super pom, which is fine in most cases. However, the Versions plugin alerts us that this is the case, so we can take action as appropriate.</li><li class="listitem" style="list-style-type: disc">There is a difference in plugin versions based on the Maven version. The report specifies different versions of various plugins based on the Maven version used. This is all the more reason why it is important to specify a prerequisite.</li></ul></div><p>As the output indicates, if we specify that we need at least the <code class="literal">2.2.1</code> version of Maven, then we can see that there is a newer version of the Maven Exec plugin, which is <code class="literal">1.3.2</code>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec276"/>There's more...</h2></div></div></div><p>Let us now specify the <code class="literal">prerequisites</code> element in the pom file and see how it affects the output of the goal:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following to the pom file:<div class="informalexample"><pre class="programlisting">  &lt;prerequisites&gt;
    &lt;maven&gt;3.2.5&lt;/maven&gt;
  &lt;/prerequisites&gt;</pre></div></li><li class="listitem">Run the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn versions:display-plugin-updates</strong></span>
</pre></div></li><li class="listitem">Observe the output:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[INFO] --- versions-maven-plugin:2.0:display-plugin-updates (default-cli) @ project-with-exec ---</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>[INFO]</strong></span>
<span class="strong"><strong>[INFO] The following plugin updates are available:</strong></span>
<span class="strong"><strong>[INFO]   org.codehaus.mojo:exec-maven-plugin .................... 1.2 -&gt; 1.3.2</strong></span>
<span class="strong"><strong>[INFO]</strong></span>
</pre></div></li></ol></div><p>We now see that the<a id="id582" class="indexterm"/> plugin reports a plugin update based on the <a id="id583" class="indexterm"/>prerequisite that we specified.</p><p>It is difficult to determine if there are updates to plugins that we do not explicitly define in the pom file. For instance, as per the output from the preceding command, which is as follows:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[WARNING] The following plugins do not have their version specified:</strong></span>
<span class="strong"><strong>[WARNING]   maven-clean-plugin .......................... (from super-pom) 2.5</strong></span>
<span class="strong"><strong>[WARNING]   maven-compiler-plugin ....................... (from super-pom) 3.1</strong></span>
<span class="strong"><strong>[WARNING]   maven-deploy-plugin ......................... (from super-pom) 2.7</strong></span>
<span class="strong"><strong>[WARNING]   maven-install-plugin ........................ (from super-pom) 2.4</strong></span>
</pre></div><p>However, as of writing this book, the latest version of the Maven Clean plugin is 2.6.1, that of the Maven Compiler plugin is 3.2, and so on. The version that the super pom has is the version that must have been the latest when it was created. The versions of these dependencies become important when bugs or newer features are present in the newer versions. In this case, we do want to get the newer version of these plugins. It is easy to get these by explicitly specifying the version of the plugins in the pom file.</p><p>Add the following to the pom file:</p><div class="informalexample"><pre class="programlisting">        &lt;plugin&gt;
          &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
          &lt;artifactId&gt;maven-clean-plugin&lt;/artifactId&gt;
          &lt;version&gt;2.5&lt;/version&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
          &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
          &lt;version&gt;3.1&lt;/version&gt;
        &lt;/plugin&gt;</pre></div><p>Now, re-run the <a id="id584" class="indexterm"/>previous<a id="id585" class="indexterm"/> command and note the output:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[INFO] The following plugin updates are available:</strong></span>
<span class="strong"><strong>[INFO]   maven-clean-plugin ..................................... 2.5 -&gt; 2.6.1</strong></span>
<span class="strong"><strong>[INFO]   maven-compiler-plugin .................................... 3.1 -&gt; 3.2</strong></span>
<span class="strong"><strong>[INFO]   org.codehaus.mojo:exec-maven-plugin .................... 1.2 -&gt; 1.3.2</strong></span>
</pre></div></div></div>
<div class="section" title="Determining updates to Maven dependencies"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec109"/>Determining updates to Maven dependencies</h1></div></div></div><p>We use a number of third-party<a id="id586" class="indexterm"/> libraries to build our projects. As<a id="id587" class="indexterm"/> you recall, we specify the <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and <code class="literal">version</code> elements of each of these dependant libraries in our pom file. There may be many occasions when there are updates to these libraries and new versions are released. It will be good to have a mechanism to get notified about these releases and update the project build file suitably.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec277"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Take a project for which you want to check for a dependency update, <code class="literal">simple-project</code>, which we had created using the quick-start archetype.</li><li class="listitem">Run the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn versions:display-dependency-updates</strong></span>
</pre></div></li><li class="listitem">Observe the output:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[INFO] --- versions-maven-plugin:2.1:display-dependency-updates (default-cli) @</strong></span>
<span class="strong"><strong>simple-project ---</strong></span>
<span class="strong"><strong>[INFO] artifact junit:junit: checking for updates from central</strong></span>
<span class="strong"><strong>[INFO] The following dependencies in Dependencies have newer versions:</strong></span>
<span class="strong"><strong>[INFO]   junit:junit ............................................ 3.8.1 -&gt; 4.12</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec278"/>How it works...</h2></div></div></div><p>The <code class="literal">display-dependency-updates</code> goal <a id="id588" class="indexterm"/>of the Maven Versions plugin uses the metadata of each of the maven dependencies to determine the latest version of each dependency. If it does not match the current version, it displays a report about the difference.</p><p>We have already seen <a id="id589" class="indexterm"/>earlier that <code class="literal">SNAPSHOT</code> versions are <a id="id590" class="indexterm"/>handled differently by Maven, and it automatically checks and updates these dependencies for each build as per the configuration. If the version number of the <code class="literal">SNAPSHOT</code> changes (<code class="literal">1.0-SNAPSHOT</code> to <code class="literal">1.1-SNAPSHOT</code>), then the Versions plugin indicates that.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec279"/>There's more...</h2></div></div></div><p>The Maven Versions plugin provides several other goals to manage updates to dependency and plugin versions. This includes automatically changing the versions to the latest release versions, replacing <code class="literal">SNAPSHOT</code> with release versions, and so on.</p></div></div>
<div class="section" title="Controlling the constraints"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec110"/>Controlling the constraints</h1></div></div></div><p>One of the requirements for a <a id="id591" class="indexterm"/>build tool is to be able to generate repeatable builds. In a project, the build tool should behave identically for all team members. While a project guideline can be made on the version of Java or Maven to be used, it would be easier if it could be enforced automatically.</p><p>This is where the Maven Enforcer plugin comes in.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec280"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a simple project (<code class="literal">project-with-enforcer</code>).</li><li class="listitem">Add the following plugin configuration:<div class="informalexample"><pre class="programlisting">      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-enforcer-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.3.1&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;enforce-versions&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;enforce&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
              &lt;rules&gt;
                &lt;requireMavenVersion&gt;
                  &lt;version&gt;3.2.3&lt;/version&gt;
                &lt;/requireMavenVersion&gt;
                &lt;requireJavaVersion&gt;
                  &lt;version&gt;1.8&lt;/version&gt;
                &lt;/requireJavaVersion&gt;
              &lt;/rules&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;</pre></div></li><li class="listitem">Build the project using Java 7 and Maven 3.2.3:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn clean package.</strong></span>
</pre></div></li><li class="listitem">Observe the<a id="id592" class="indexterm"/> output:<div class="mediaobject"><img src="graphics/6124OS_11_05.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec281"/>How it works...</h2></div></div></div><p>The Enforcer plugin<a id="id593" class="indexterm"/> uses the rules configuration and validates the project against the rules. If it finds violations, it reports the error(s) and does not proceed with the build.</p><p>In the preceding example, our project had two issues:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Maven version</strong></span>: We were<a id="id594" class="indexterm"/> using version 3.2.3 but we had specified 3.2.5 in the rules</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Java version</strong></span>: We were using<a id="id595" class="indexterm"/> Java 7 but we had specified Java 8 in the rules</li></ul></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec282"/>There's more...</h2></div></div></div><p>The Maven Enforcer plugin has several other rules to enforce various constraints. A couple of them are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">requireOS</code>: This<a id="id596" class="indexterm"/> ensures the project can be built only on specific operating systems</li><li class="listitem" style="list-style-type: disc"><code class="literal">requireFilesExist</code>: This<a id="id597" class="indexterm"/> ensures specific files exist for the project to build</li></ul></div><p>It is also possible to implement<a id="id598" class="indexterm"/> custom enforcer rules. One such is available at <a class="ulink" href="https://github.com/ferstl/pedantic-pom-enforcers">https://github.com/ferstl/pedantic-pom-enforcers</a>.</p></div></div>
<div class="section" title="Generating unique builds"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec111"/>Generating unique builds</h1></div></div></div><p>As we have seen, we use<a id="id599" class="indexterm"/> a <code class="literal">SNAPSHOT</code> version to specify that the project is under development. In the course of development, we will create several builds for the project. In many situations, it will be useful to distinguish one such build from another. One could be when we use continuous integration. Another would be when a tester needs to log defects against a build.</p><p>It would be nice if there was a way to generate a unique build number to identify a build in the case of <code class="literal">SNAPSHOT</code> versions.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec283"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the project for which you want to have a build number (<code class="literal">project-with-build-number</code>).</li><li class="listitem">Add the following plugin configuration:<div class="informalexample"><pre class="programlisting">    &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;buildnumber-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.3&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;phase&gt;validate&lt;/phase&gt;
            &lt;goals&gt;
              &lt;goal&gt;create&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
        &lt;configuration&gt;
           &lt;shortRevisionLength&gt;5&lt;/shortRevisionLength&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;</pre></div></li><li class="listitem">Add the following to use the unique build number created:<div class="informalexample"><pre class="programlisting">&lt;finalName&gt;${project.artifactId}-${project.version}-r${buildNumber}&lt;/finalName&gt;</pre></div></li><li class="listitem">Add the SCM configuration for the project:<div class="informalexample"><pre class="programlisting">&lt;scm&gt;
     &lt;developerConnection&gt;scm:git:https://bitbucket.org/maruhgar/apache-maven-cookbook&lt;/developerConnection&gt;
      &lt;url&gt;https://bitbucket.org/maruhgar/apache-maven-cookbook&lt;/url&gt;
  &lt;/scm&gt;</pre></div></li><li class="listitem">Build the project:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn clean package</strong></span>
</pre></div></li><li class="listitem">Observe the<a id="id600" class="indexterm"/> output:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[INFO] --- buildnumber-maven-plugin:1.3:create (default) @ project-with-build-nu</strong></span>
<span class="strong"><strong>mber ---</strong></span>
<span class="strong"><strong>[INFO] ShortRevision tag detected. The value is '5'.</strong></span>
<span class="strong"><strong>[INFO] Executing: cmd.exe /X /C "git rev-parse --verify --short=5 HEAD"</strong></span>
<span class="strong"><strong>[INFO] Working directory: C:\projects\apache-maven-cookbook\project-with-build-n</strong></span>
<span class="strong"><strong>umber</strong></span>
<span class="strong"><strong>[INFO] Storing buildNumber: 0950d at timestamp: 1421244408851</strong></span>
<span class="strong"><strong>[INFO] Storing buildScmBranch: master</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ project-with-build-number --</strong></span>
<span class="strong"><strong>-</strong></span>
<span class="strong"><strong>[INFO] Building jar: C:\projects\apache-maven-cookbook\project-with-build-number</strong></span>
<span class="strong"><strong>\target\project-with-build-number-1.0-SNAPSHOT-r0950d.jar</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec284"/>How it works...</h2></div></div></div><p>The Maven Build Number plugin provides three ways to generate a unique number, namely by using SCM, a sequential build number, or a timestamp.</p><p>In the preceding example, we used SCM as it is easy to map the build against the corresponding SCM version. We used <code class="literal">git</code> and specified the SCM details in the SCM tag of the pom file.</p><p>We also specified to the<a id="id601" class="indexterm"/> Maven Build Number plugin to use five characters and create the short revision, as a typical git revision is a long hash value. We also configured the plugin to run during the validation phase of the lifecycle.</p><p>We used the generated Build Number in the name of the generated artifact, by appending it along with the version number.</p><p>Now, each time a new check-in is done and the build is completed, an artifact with a unique name is generated. Based on the requirement, each such artifact can be archived or traced to a corresponding source.</p></div></div>
<div class="section" title="Releasing a Maven project"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec112"/>Releasing a Maven project</h1></div></div></div><p>The ultimate goal of any project <a id="id602" class="indexterm"/>is the release. After development is complete and bugs are fixed, it is time to release the project. Different projects are released in different ways. Web projects are released by deploying them to the web server. Other projects may be packaged into executable JARs. Still others may be packaged as executables or installers. If the project is a library or a dependency used in other projects, then it needs to be made available suitably.</p><p>As we have seen before, we use the <code class="literal">SNAPSHOT</code> version during development. When the project has to be released, this version now needs to be replaced with a concrete version.</p><p>One of the most advanced features of Maven is its support to do a project release. Let us explore this.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec285"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a project for which you want to do a release (<code class="literal">project-with-release</code>).</li><li class="listitem">Verify if the SCM details are present in the pom file:<div class="informalexample"><pre class="programlisting">&lt;scm&gt;
      &lt;developerConnection&gt;scm:git:https://bitbucket.org/maruhgar/apache-maven-cookbook&lt;/developerConnection&gt;
       &lt;url&gt;https://bitbucket.org/maruhgar/apache-maven-cookbook&lt;/url&gt;
    &lt;tag&gt;HEAD&lt;/tag&gt;
  &lt;/scm&gt;</pre></div></li><li class="listitem">Add the plugin definition in order to specify the latest version of the plugin:<div class="informalexample"><pre class="programlisting">   &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.5.1&lt;/version&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;</pre></div></li><li class="listitem">Run the following <a id="id603" class="indexterm"/>Maven command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn release:prepare –DpushChanges=false</strong></span>
</pre></div><p>By default, changes made by the plugin are pushed to the repository. If you do not want that, set the <code class="literal">pushChanges</code> configuration option to <code class="literal">false</code>.</p></li><li class="listitem">Choose the default values when prompted.<div class="mediaobject"><img src="graphics/6124OS_11_06.jpg" alt="How to do it..."/></div><p>You could choose the default values for the release version, the SCM tag and new development version, or provide your values.</p></li><li class="listitem">Observe the output:<div class="mediaobject"><img src="graphics/6124OS_11_07.jpg" alt="How to do it..."/></div><p>Maven runs a <a id="id604" class="indexterm"/>number of commands that modify the pom file. Then, it checks in the changes into the repository.</p></li><li class="listitem">Now run the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mvn release:perform –Dgoals=package –DlocalCheckout=true</strong></span>
</pre></div><p>By default, the <code class="literal">perform</code> goal of the Maven Release plugin runs the <code class="literal">deploy</code> goal to deploy the project to the specified repository. If you do not have a remote repository to deploy to, or want to run a different goal as part of the release, you can specify it using the <code class="literal">goals</code> configuration. In the preceding case, we have set it to run the <code class="literal">package</code> goal.</p><p>Also, to do the release, Maven checks out the tag created by the <code class="literal">prepare</code> goal from the repository. If you want Maven to check out the local copy instead, you could do so by setting the <code class="literal">localCheckout</code> configuration to <code class="literal">true</code>.</p></li><li class="listitem">Observe the<a id="id605" class="indexterm"/> output:<div class="mediaobject"><img src="graphics/6124OS_11_08.jpg" alt="How to do it..."/></div></li><li class="listitem">Ensure that the<a id="id606" class="indexterm"/> release binaries are created in the <code class="literal">target/checkout/project-with-release/target</code> folder:<div class="mediaobject"><img src="graphics/6124OS_11_09.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec286"/>How it works...</h2></div></div></div><p>There are two steps to making a release—prepare and perform.</p><p>When the prepare goal of the Maven Release plugin is run, it does the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Checks there are no uncommitted changes</li><li class="listitem" style="list-style-type: disc">Checks that the project does not have any <code class="literal">SNAPSHOT</code> dependencies</li><li class="listitem" style="list-style-type: disc">Changes the version of the <code class="literal">SNAPSHOT</code> project; you will be prompted to confirm or override the default</li><li class="listitem" style="list-style-type: disc">Adds a <code class="literal">tag</code> element to the <code class="literal">scm</code> element and computes the value (by default,<code class="literal"> HEAD</code>)</li><li class="listitem" style="list-style-type: disc">Runs the <code class="literal">verify</code> goal to ensure that the changes do not break anything</li><li class="listitem" style="list-style-type: disc">Commits the modified pom to the SCM</li><li class="listitem" style="list-style-type: disc">Tags the code in SCM with a version name (you will be prompted to confirm or override the default):<div class="mediaobject"><img src="graphics/6124OS_11_10.jpg" alt="How it works..."/></div></li><li class="listitem" style="list-style-type: disc">Bumps the <a id="id607" class="indexterm"/>version in the pom to the new <code class="literal">SNAPSHOT</code> value (from <code class="literal">1.0-SNAPSHOT</code>; this would be <code class="literal">1.1-SNAPSHOT</code>); you will be prompted to confirm or override this</li><li class="listitem" style="list-style-type: disc">Commits the modified pom to SCM</li></ul></div><p>As you can see, once the goal is met, you will have an updated SCM with a tag with the release version and the <code class="literal">HEAD</code> with the next <code class="literal">SNAPSHOT</code> version. A <code class="literal">release.properties</code> file is also created. It contains information that is needed for the <code class="literal">perform</code> goal.</p><div class="mediaobject"><img src="graphics/6124OS_11_11.jpg" alt="How it works..."/></div><p>The second platform does as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The perform goal uses the information in <code class="literal">release.properties</code> to check out from the SCM tag that was created earlier</li><li class="listitem" style="list-style-type: disc">It then runs the specified goal on the checked-out project (by default, <code class="literal">deploy</code>)</li><li class="listitem" style="list-style-type: disc">This generates the release binaries</li></ul></div><p>Once the build is successful, <code class="literal">release.properties</code> and other backup files created by the Release plugin are removed.</p></div></div></body></html>