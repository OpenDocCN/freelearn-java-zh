<html><head></head><body><div id="sbo-rt-content"><div class="chapter" title="Chapter 7. Inspecting Spring Batch Jobs"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Inspecting Spring Batch Jobs</h1></div></div></div><p>In the previous chapter, we learned about enterprise integration, varieties of enterprise application integration, and the Spring Integration project to integrate Spring Batch applications with its message-driven approach. We also learned about launching batch jobs with Spring Integration and RESTful job processing techniques. Spring Batch job execution deals with huge data that changes time to time. This changing data might get corrupted at times and lead to failed job executions. It is important to keep a close eye on such failures, and failure reasons should be saved in a constructive manner for future tracking and fixing.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Batch job monitoring</li><li class="listitem" style="list-style-type: disc">Accessing execution data</li><li class="listitem" style="list-style-type: disc">Listeners</li><li class="listitem" style="list-style-type: disc">Web monitoring</li></ul></div><div class="section" title="Batch job monitoring"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec38"/>Batch job monitoring</h1></div></div></div><p>So far we have <a id="id365" class="indexterm"/>seen varieties of batch job configurations and executions <a id="id366" class="indexterm"/>handling data from diverse sources, processing it, and pushing the outcomes into another data store. Everything looks good as long as the jobs keep executing the way we make the configurations. The stability of an application can be figured by how strong and detailed the response of the application is to any problems with its surroundings, that is, the environment in which the application is running, the availability and accessibility of external systems, and the correctness of the data supplied to the application.</p><p>Applications should be able to generate clear tracking information on what is happening in and out of the application in terms of functionality, who is using it, how the performance is, and a detailed stack of issues/errors the application faces. Spring Batch addresses these parameters and generates a greater infrastructure to monitor the batch job processing and store this monitored information.</p><p>The application infrastructure should take care of identifying any such problems and also reporting to the <a id="id367" class="indexterm"/>respective departments through the preconfigured channels of communication. Spring Batch has a strong infrastructure to maintain the monitored job information in a database. Let us understand the database infrastructure and how each entity is related to each other.</p><p>The following is the <a id="id368" class="indexterm"/>schema diagram defined by Spring Batch:</p><div class="mediaobject"><img src="Images/3372OS_07_01.jpg" alt="Batch job monitoring" width="500" height="644"/></div><p>The preceding figure <a id="id369" class="indexterm"/>depicts the schema of the batch job that takes care of the job execution information. The significance of each of these entities is as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">BATCH_JOB_INSTANCE</code>: This maintains high-level information on the batch jobs, along <a id="id370" class="indexterm"/>with the instance of each job. It contains a unique identifier for different job instances created for the same job, with a <a id="id371" class="indexterm"/>different set of job parameters (<code class="literal">JOB_KEY</code>), along with the job name and version of each record.</li><li class="listitem" style="list-style-type: disc"><code class="literal">BATCH_JOB_PARAMS</code>: This maintains information related to each set of job parameters <a id="id372" class="indexterm"/>instance. It maintains the key/value pairs of job parameters to be passed to a job.</li><li class="listitem" style="list-style-type: disc"><code class="literal">BATCH_JOB_EXECUTION</code>: This maintains the job execution information for each instance <a id="id373" class="indexterm"/>of the job. It maintains individual records for each execution of the batch job by connecting with <code class="literal">BATCH_JOB_INSTANCE</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">BATCH_STEP_EXECUTION</code>: This maintains the step execution information for each <a id="id374" class="indexterm"/>step of a job instance. It connects with <code class="literal">BATCH_JOB_EXECUTION</code> to maintain the step execution information for each job execution instance.</li><li class="listitem" style="list-style-type: disc"><code class="literal">BATCH_JOB_EXECUTION_CONTEXT</code>: This is the information needed for each job execution instance. This is unique for each execution, so the same information as that of the <a id="id375" class="indexterm"/>previous run is considered for retry <a id="id376" class="indexterm"/>jobs. Hence, it connects with <code class="literal">BATCH_JOB_EXECUTION</code> to maintain an instance per execution.</li><li class="listitem" style="list-style-type: disc"><code class="literal">BATCH_STEP_EXECUTION_CONTEXT</code>: This is similar to <code class="literal">BATCH_JOB_EXECUTION_CONTEXT</code>, except that it maintains the context information for <a id="id377" class="indexterm"/>each of the step execution. Hence, it connects with <code class="literal">BATCH_STEP_EXECUTION</code> to maintain the unique <a id="id378" class="indexterm"/>instance with each step execution instance.</li></ul></div></div></div></div>



  
<div id="sbo-rt-content"><div class="section" title="Accessing execution data"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec39"/>Accessing execution data</h1></div></div></div><p>While Spring <a id="id379" class="indexterm"/>Batch saves all the monitoring and job information to the <a id="id380" class="indexterm"/>database, let's understand each of the administration components of Spring Batch, how they interact with each other, and their configurations.</p><div class="mediaobject"><img src="Images/3372OS_07_02.jpg" alt="Accessing execution data" width="600" height="185"/></div><div class="section" title="Database"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec45"/>Database</h2></div></div></div><p>The database <a id="id381" class="indexterm"/>saves job-related information and acts as a source to monitor the job execution information.</p><p>A database <a id="id382" class="indexterm"/>can be configured using the following syntax:</p><div class="informalexample"><pre class="programlisting">&lt;bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource"&gt; 
&lt;property name="driverClassName" value="${batch.jdbc.driver}"/&gt; 
&lt;property name="url" value="${batch.jdbc.url}"/&gt; 
&lt;property name="username" value="${batch.jdbc.user}"/&gt; 
&lt;property name="password" value="${batch.jdbc.password}"/&gt; 
&lt;/bean&gt;
&lt;bean id="transactionManager" 
class="org.springframework.jdbc.datasource.DataSourceTransactionManager" lazy-init="true"&gt; 
&lt;property name="dataSource" ref="dataSource"/&gt; 
&lt;/bean&gt;</pre></div><p>The values of <code class="literal">driverClassName</code>, <code class="literal">url</code>, <code class="literal">username</code>, and <code class="literal">password</code> can be specific to the database and a particular user connection to that database. <code class="literal">DataSourceTransactionManager</code> is the transaction manager here and it refers to the database with the <code class="literal">datasource</code> property.</p><div class="section" title="JobRepository"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec18"/>JobRepository</h3></div></div></div><p>The <code class="literal">org.springframework.batch.core.repository.JobRepository</code> interface is the central point of <a id="id383" class="indexterm"/>access for job-related information. It accesses the state and <a id="id384" class="indexterm"/>metadata of batch jobs from the database and supplies it to other resources.</p><p>The configuration <a id="id385" class="indexterm"/>for the <code class="literal">JobRepository</code> follows the ensuing syntax:</p><div class="informalexample"><pre class="programlisting">&lt;job-repository id="jobRepository" 
data-source="dataSource" transaction-manager="transactionManager" /&gt;</pre></div></div><div class="section" title="JobLauncher"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec19"/>JobLauncher</h3></div></div></div><p>The <code class="literal">org.springframework.batch.core.launch.JobLauncher</code> interface is responsible for job <a id="id386" class="indexterm"/>execution and also updates the changing job status <a id="id387" class="indexterm"/>in <code class="literal">JobRepository</code>.</p><p>The configuration for <code class="literal">JobLauncher</code> follows the following syntax:</p><div class="informalexample"><pre class="programlisting">&lt;job-repository id="jobRepository" 
data-source="dataSource" transaction-manager="transactionManager" /&gt;
&lt;bean id="taskExecutor" 
class="org.springframework.core.task.SimpleAsyncTaskExecutor"/&gt;
&lt;bean id="jobLauncher" 
class="org.springframework.batch.core.launch.support.SimpleJobLauncher"&gt; 
&lt;property name="jobRepository" ref="jobRepository"/&gt; 
&lt; property name="taskExecutor" ref="taskExecutor"/&gt; 
&lt;/bean&gt;</pre></div></div><div class="section" title="JobOperator"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec20"/>JobOperator</h3></div></div></div><p>The <code class="literal">org.springframework.batch.core.launch.JobOperator</code> interface acts as a controlling point for <a id="id388" class="indexterm"/>batch job processing. It sends start, stop, and restart signals to <a id="id389" class="indexterm"/>another administrator, namely, <code class="literal">JobLauncher</code> by accessing the job information from <code class="literal">JobExplorer</code>.</p><p>The configuration for <code class="literal">JobOperator</code> follows the following syntax:</p><div class="informalexample"><pre class="programlisting">&lt;bean id="jobOperator" 
class="org.springframework.batch.core.launch.support.SimpleJobOperator" 
prop:jobLauncher-ref="jobLauncher" prop:jobExplorer-ref="jobExplorer" 
prop:jobRepository-ref="jobRepository" prop:jobRegistry-ref="jobRegistry" /&gt;</pre></div></div><div class="section" title="JobExplorer"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec21"/>JobExplorer</h3></div></div></div><p>The <code class="literal">org.springframework.batch.core.explore.JobExplorer</code> interface reads the job-related <a id="id390" class="indexterm"/>information <a id="id391" class="indexterm"/>from the database and provides the information to other <a id="id392" class="indexterm"/>administrators, such as <code class="literal">JobOperator</code> in job execution, with read-only access.</p><p>The configuration <a id="id393" class="indexterm"/>for <code class="literal">JobExplorer</code> follows the ensuing syntax:</p><div class="informalexample"><pre class="programlisting">&lt;bean id="jobExplorer" 
class="org.springframework.batch.core.explore.support.JobExplorerFactoryBean" 
prop:dataSource-ref="dataSource" /&gt;</pre></div></div></div></div></div>



  
<div id="sbo-rt-content"><div class="section" title="Listeners"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec40"/>Listeners</h1></div></div></div><p>In the previous <a id="id394" class="indexterm"/>chapters, we discussed that listeners are the components that get <a id="id395" class="indexterm"/>triggered by the preconfigured events in an execution. We can use such listeners to trigger a particular event on the batch job and act as a monitoring tool for the corresponding problems. A listener can also be configured to report the corresponding department for a particular problem in execution.</p><div class="mediaobject"><img src="Images/3372OS_07_03.jpg" alt="Listeners" width="600" height="269"/></div><p>The following is a sample listener definition and configuration to monitor a batch job problem.</p><p>A listener class can be defined to execute before and after the execution of a job, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">public class JobMonitoringListener {
  @BeforeJob
  public void executeBeforeJob(JobExecution jobExecution) {
    //pre-run executions
  }
  @AfterJob
  public void executeAfterJob(JobExecution jobExecution) {
  if(jobExecution.getStatus() == BatchStatus.FAILED) { 
  /* Report the departments for a failed job execution status.
     The reporter can be a preconfigured mail-sender or an SMS
     sender or any other channel of communication.*/
      reporter.report(jobExecution);
    }
  }
}</pre></div><p>The configuration of a <a id="id396" class="indexterm"/>batch job with the monitoring listener can be as <a id="id397" class="indexterm"/>follows:</p><div class="informalexample"><pre class="programlisting">&lt;batch:job id="firstBatchJob"&gt;
  &lt;batch:step id="importEmployees"&gt;
  ..
  &lt;/batch:step&gt;
  &lt;batch:listeners&gt;
    &lt;batch:listener ref="jobMonitoringListener"/&gt; 
  &lt;/batch:listeners&gt;
&lt;/batch:job&gt;
&lt;bean id=" jobMonitoringListener" class="org.java.JobMonitoringListener"/&gt;</pre></div></div></div>



  
<div id="sbo-rt-content"><div class="section" title="Web monitoring"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec41"/>Web monitoring</h1></div></div></div><p>The Spring Batch job <a id="id398" class="indexterm"/>execution can be monitored and examined with the web interface provided by the open-source project of Spring, that is, <span class="strong"><strong>Spring Batch Admin</strong></span>. This is a simple web application built with the Spring MVC user interface to act as an admin <a id="id399" class="indexterm"/>console for the Spring Batch applications and systems. The main use cases developed in this project are inspecting jobs, launching jobs, inspecting the executions, and stopping the executions.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Refer to the <a id="id400" class="indexterm"/>Spring Batch Admin reference guide at <a class="ulink" href="http://docs.spring.io/spring-batch-admin/reference.html">http://docs.spring.io/spring-batch-admin/reference.html</a> for detailed information on installation and usage.</p></div></div></div></div>



  
<div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec42"/>Summary</h1></div></div></div><p>Through this chapter, we learned the importance of job execution monitoring and Spring Batch job monitoring infrastructure. We also learned how to access job execution information with the help of the administrators' configurations. In addition, we learned about monitoring and reporting batch job problems with the help of listeners. We finished this chapter with an understanding of the Spring Batch Administration project features and how it can help with batch job monitoring.</p><p>In the next chapter, we will learn in detail about the batch scaling model, parallel processing, and partitioning concepts.</p></div></div>



  </body></html>