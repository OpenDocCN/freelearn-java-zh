<html><head></head><body><div class="book" title="Chapter&#xA0;5.&#xA0;Conversations and Journeys" id="aid-1FLS41"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch05" class="calibre1"/>Chapter 5. Conversations and Journeys</h1></div></div></div><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="blockquote1" summary="Block quote"><tr class="calibre12"><td valign="top" class="calibre13"> </td><td valign="top" class="calibre13"><p class="calibre14"><span><em class="calibre15">"Success is liking yourself, liking what you do, and liking how you do it."</em></span></p></td><td valign="top" class="calibre13"> </td></tr><tr class="calibre12"><td valign="top" class="calibre13"> </td><td colspan="2" valign="top" class="calibre16">--<span><span><em class="calibre15">Maya Angelou</em></span></span></td></tr></table></div><p class="calibre7">In this chapter, we devote our attention to the JSF conversation scope. This scope defines the lifecycle of a managed backing bean that spans between the request and the session scope. This allows the data in the form to survive in a lifespan that sits between the request-scope and the session-scope. The conversation scope is also said to be contextual. This term is appropriated from the <span class="strong"><strong class="calibre8">Context and Dependency Injection</strong></span> (<span class="strong"><strong class="calibre8">CDI</strong></span>) specification, and it means that the life span of the beans marked with a conversation <a id="id528" class="calibre1"/>scope are treated as being part of a context. You can think of this as a dotted marker that the CDI container draws around the object instances to define them as a private group, which denotes a lifecycle. The CDI container does this job of gathering the object instances together as it associates one object bean with a dependency on another.</p><p class="calibre7">In CDI, Context<a id="id529" class="calibre1"/> represents the CDI container's ability to bind a group of object instances that are stateful components into well-defined and extendible lifecycles.</p><p class="calibre7">In CDI, Dependency Injection<a id="id530" class="calibre1"/> represents the CDI container's capability to inject components into an application with type safety in mind. The CDI container chooses, at runtime, the implementation of the Java interface that is to be injected.</p><p class="calibre7">JavaServer Faces integrates into the standard CDI scope, including the conversational scope. Examples of conversation include several types of contemporary digital customer journeys. You <a id="id531" class="calibre1"/>probably have seen this yourself whilst applying for a new job online, going through the shipping and delivery flow of an e-commerce website, or setting up a government resource or function like a tax assessment or return. In this chapter, we are going look at one example customer journey, where the developer or user is applying for an instant secured loan. You may have already seen these or actually have been fortunate, or unfortunate, to peruse a payday loan facility.</p><p class="calibre7">The conversation scope maintains a state with a client. The controller or POJO, which is demarcated with the conversation scope, and its component instances become part of its state.</p><p class="calibre7">The following <a id="id532" class="calibre1"/>diagram outlines the conversation scope around the managed bean controller that we will be studying in this chapter:</p><div class="mediaobject"><img src="../Images/image00396.jpeg" alt="Conversations and Journeys" class="calibre10"/><div class="caption"><p class="calibre24">An illustration of the several bean instances with different CDI scopes</p></div></div><p class="calibre11"> </p><p class="calibre7">The preceding diagram shows two different customers, which are logged into the enterprise application. Starting<a id="id533" class="calibre1"/> from left to right, we have the <span class="strong"><strong class="calibre8">UserProfile</strong></span> instances that capture the login information of the customer, which are stored in the CDI session scope. These beans are shared with only the particular customer associated with the <code class="email">javax.servlet.http.HttpSession</code> object.</p><p class="calibre7">Moving over<a id="id534" class="calibre1"/> to the right, we have an object graph of<a id="id535" class="calibre1"/> bean instances, the <span class="strong"><strong class="calibre8">LendingController</strong></span>, <span class="strong"><strong class="calibre8">ContactDetail</strong></span>, and <span class="strong"><strong class="calibre8">BankDetails</strong></span>, which<a id="id536" class="calibre1"/> are stored in the conversation scope.</p><p class="calibre7">At the<a id="id537" class="calibre1"/> bottom of the diagram, inside the application scope, we have the <a id="id538" class="calibre1"/>bean instances, <span class="strong"><strong class="calibre8">Utility</strong></span> and <span class="strong"><strong class="calibre8">DataHelperController</strong></span>. All web application users share the beans. The conversation beans are able to access the shared information in the current session scope and also in the application scope.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip21" class="calibre1"/>Tip</h3><p class="calibre7">For more information on CDI, please read the sister book, <span class="strong"><em class="calibre9">Java EE 7 Developer Handbook</em></span>, <span class="strong"><em class="calibre9">Packt Publishing</em></span>.</p></div><div class="book" title="Digital e-commerce applications"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch05lvl1sec43" class="calibre1"/>Digital e-commerce applications</h1></div></div></div><p class="calibre7">Java EE applications are well-suited to digital sites that maintain state. If the site maintains any<a id="id539" class="calibre1"/> sort state with the user in their customer journey, then the users are usually involved with conversations. UX testing has shown that, for many enterprise sites where lots of interactions occur, there are several conversations. To paraphrase, a fellow Java Champion, Antonio Gonclaves, who was a member of the Java EE 7 expert group, if your intention is to build digital web applications, then it must be able to handle complex flow management.</p><p class="calibre7">An instant loan is not quite in the same league of the products that fast start-ups and entrepreneurs effectively provided as an end-state solution to the global economic credit crunch. With the rise in competition from these new agile upstarts, many domestic household banks in several of the developed nations have had to quickly assemble an instant loan facility product. In this chapter, we will develop an instant secure loan facility. Our product is not a full solution, but it shows the way to deliver the initial prototype for a digital customer. We do not integrate with the financial services, whereas a commercial solution would need management information reporting as well as integration with the commercial banking infrastructure.</p><p class="calibre7">Let's move on to the conversational scope more extensively.</p></div></div>
<div class="book" title="Conversational scope" id="aid-1GKCM1"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch05lvl1sec44" class="calibre1"/>Conversational scope</h1></div></div></div><p class="calibre7">Conversational scope is defined by a lifecycle that spans many HTTP requests to the server. The<a id="id540" class="calibre1"/> developer determines when the scope begins and ends, and most importantly, it is associated with a user. The key annotation is defined by a CDI specification called <code class="email">@javax.enterprise.context.ConversationScoped</code>. When you apply this annotation to a controller or POJO, remember to ensure that you implement the marker interface, <code class="email">java.io.Serializable</code>.</p><p class="calibre7">CDI also defines an interface, <code class="email">javax.enterprise.context.Conversation</code> that represents the conversation interface. A conversation can be two distinct states of existence: transient and long-running. The transient state means that the conversation is a temporary state. When you annotate a bean with <code class="email">@ConversationScoped</code>, it will be in the transient state by default.</p><p class="calibre7">The developer controls when the conversation switches from the transient to the long-running state. The conversation, then, becomes active and it maintains the holds state of the HTTP user connection, which is usually associated with a particular web browser tab. Essentially, a conversation is a unit of work. A conversation is started and, eventually, ends.</p><p class="calibre7">The following is the definition of <code class="email">javax.enterprise.context.Conversation</code> interface:</p><div class="informalexample"><pre class="programlisting">public interface Conversation {
  void begin();
  void begin(String id);
  void end();
  String getId();
  long getTimeout();
  void setTimeout(long milliseconds);
  boolean isTransient();
}</pre></div><p class="calibre7">The methods, <code class="email">begin()</code> initiate a conversation. A conversational scope POJO is marked for long running storage by the CDI container. A conversation has an identifier; the other method <code class="email">begin(String id)</code> allows the developer to provide an explicit one.</p><p class="calibre7">The method <code class="email">end()</code> terminates a conversation, the CDI container effectively discards the contextual information associated with the POJO, and the state returns to transient. In order to find out if a conversation is transient, the call <code class="email">isTransient()</code> is used.</p><p class="calibre7">The following <a id="id541" class="calibre1"/>diagram illustrates the lifecycle of a CDI conversation scope bean:</p><div class="mediaobject"><img src="../Images/image00397.jpeg" alt="Conversational scope" class="calibre10"/></div><p class="calibre11"> </p><div class="book" title="Conversation timeout and serialization"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec46" class="calibre1"/>Conversation timeout and serialization</h2></div></div></div><p class="calibre7">As we discussed earlier, the lifespan of a conversation scope is beyond the request scope, but cannot <a id="id542" class="calibre1"/>survive beyond the session scope. The CDI container can timeout a conversation scope and terminate the contextual information in order to preserve<a id="id543" class="calibre1"/> or recover a resource. This is partially the reason that an annotated bean with <code class="email">@ConversationScoped</code> must be <code class="email">Serializable</code>. A smart CDI container and servlet container may transfer a conversation to disk or even to another running JVM instance, but it could never attempt this without serialization.</p><p class="calibre7">The application developer can retrieve the timeout and set it with the methods, <code class="email">getTimeout()</code> and <code class="email">setTimeout()</code>.</p><p class="calibre7">So now we know what are <code class="email">@ConversationScoped</code> and <code class="email">Conversation</code>. Let's put them to good use in our instant secure lending application.</p></div></div>
<div class="book" title="The conversation scope controller"><div class="book" id="aid-1HIT82"><div class="book"><div class="book"><h1 class="title"><a id="ch05lvl1sec45" class="calibre1"/>The conversation scope controller</h1></div></div></div><p class="calibre7">The heart of our <a id="id544" class="calibre1"/>digital customer journey is a managed bean called <code class="email">LendingController</code>. We will break it down gently into easier sections as we go through this chapter.</p><p class="calibre7">The initial <a id="id545" class="calibre1"/>implementation looks like this:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.control;
import uk.co.xenonique.digital.instant.boundary.ApplicantService;
import uk.co.xenonique.digital.instant.entity.Address;
import uk.co.xenonique.digital.instant.entity.Applicant;
import uk.co.xenonique.digital.instant.entity.ContactDetail;
import uk.co.xenonique.digital.instant.util.Utility;
// imports elided

@Named("lendingController")
@ConversationScoped
public class LendingController implements Serializable {
  @EJB ApplicantService applicantService;
  @Inject Conversation conversation;
  @Inject Utility utility;

  public final static int DEFAULT_LOAN_TERM = 24;
  public final static BigDecimal DEFAULT_LOAN_AMOUNT = new BigDecimal("7000");
  public final static BigDecimal DEFAULT_LOAN_RATE = new BigDecimal("5.50");

  private int dobDay;
  private int dobMonth;
  private String dobYear;
  private BigDecimal minimumLoanAmount = new BigDecimal("3000");
  private BigDecimal maximumLoanAmount = new BigDecimal("25000");
  private BigDecimal minimumLoanRate   = new BigDecimal("3.0");
  private BigDecimal maximumLoanRate   = new BigDecimal("12.0");

  private String currencySymbol = "£";

  private BigDecimal paymentMonthlyAmount = BigDecimal.ZERO;
  private BigDecimal totalPayable = BigDecimal.ZERO;
  private Applicant applicant;

  public LendingController() {
    applicant = new Applicant();
    applicant.setLoanAmount( DEFAULT_LOAN_AMOUNT);
    applicant.setLoanRate( DEFAULT_LOAN_RATE );
    applicant.setLoanTermMonths( DEFAULT_LOAN_TERM );
    applicant.setAddress(new Address());
    applicant.setContactDetail(new ContactDetail());
  }

  public void checkAndStart() {
    if ( conversation.isTransient()) {
        conversation.begin();
    }
    recalculatePMT();
  }

  public void checkAndEnd() {
    if (!conversation.isTransient()) {
        conversation.end();
    }
  }
  /* ... */
}</pre></div><p class="calibre7">This might<a id="id546" class="calibre1"/> appear a complicated controller on the first observation, however, there are two important items here. First, we annotate the <code class="email">LendingController</code> with <code class="email">@ConversationScoped</code> and second, we ask the CDI to inject a <code class="email">Conversation</code> instance into this bean. We also implement the <code class="email">Serializable</code> marker interface to allow the servlet container to have the freedom to persist and reload beans on the fly, if it so chooses and if the implementation supports this feature.</p><p class="calibre7">Pay particular attention to the helper methods, <code class="email">checkAndStart()</code> and <code class="email">checkAndEnd()</code>. The <code class="email">checkAndStart()</code> method starts a new long-running conversation if the current state is transient. The <code class="email">checkAndEnd()</code> method terminates a long-running conversation provided that the current Conversational instance is in the running state.</p><p class="calibre7">You can see that some elements of the previous contact detail application have made it into our instant lending application. This is by deliberate design.</p><p class="calibre7">The <code class="email">LendingController</code> bean contains an instance member of <code class="email">Applicant</code>, which is the domain master detail record. It is a JPA entity bean that stores the applicant's data. You have already seen the date-of-birth fields. The controller also has members related to the monthly payment amount and the total payable amount of the loan. It also contains the lower and upper limits for the loan amount and the rate, which are exposed as getters and setters.</p><p class="calibre7">Finally, the CDI injects a utility instance into <code class="email">LendingController</code>. This is an application scoped POJO, which neatly lets us avoid writing a static singleton. We shall see the details<a id="id547" class="calibre1"/> of the utility class later, but first we must side step into a design pattern.</p><div class="book" title="The Entity-Control-Boundary design pattern"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec47" class="calibre1"/>The Entity-Control-Boundary design pattern</h2></div></div></div><p class="calibre7">This instant lending application takes advantage of a particular design pattern called Entity-Control-Boundary. This is a pattern that separates the concerns and responsibilities for a group of objects in an application. The clue is in the imported package names for <code class="email">LendingController</code>.</p><p class="calibre7">To explain<a id="id548" class="calibre1"/> very briefly, the notion of entities represents the data model in a software application. The control <a id="id549" class="calibre1"/>elements are the components in the software application that manage the flow of information. The boundary elements belong to the application system, but lie on the periphery of the system.</p><p class="calibre7">You are quite correct in your assumption that this pattern resembles the Model-View-Controller, except that the ECB is applicable to the entire software system and the control element is more responsible than the controller and user interfaces.</p><p class="calibre7">In this application, I placed <code class="email">LendingController</code> in the control package, because the source code shows that it contains the majority of the business logic. Perhaps, for a proper production application, we could delegate our logic into another CDI bean or EJB. As a consultant once said to his client, <span class="strong"><em class="calibre9">it depends on the situation</em></span>.</p><p class="calibre7">Inside the entity package, there is no controversy; I added the <code class="email">Applicant</code>, <code class="email">ContactDetail</code>, and <code class="email">Address</code> classes. These are persistence capable objects. You have already seen the <code class="email">ContactDetail</code> entity bean in <a class="calibre1" title="Chapter 4. JSF Validation and AJAX" href="part0043.xhtml#aid-190861">Chapter 4</a>, <span class="strong"><em class="calibre9">JSF Validation and AJAX</em></span>.</p><p class="calibre7">I put the <code class="email">ApplicantService</code> EJB in the boundary package, because it lies on the periphery and it is responsible for data access.</p></div><div class="book" title="The customer journey"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec48" class="calibre1"/>The customer journey</h2></div></div></div><p class="calibre7">Let's delve back into <code class="email">LendingController</code> and reveal our customer journey. We assume that we have<a id="id550" class="calibre1"/> sat with creative designers and the UX team and come up with a design. The application is based on a series of linear web pages organized into a wizard. For the sake of this basic example, we only allow the consumer to progress to the next page when they successfully enter valid information for the current page.</p><p class="calibre7">The following are the topographical titles for each page:</p><div class="informalexample"><table border="1" class="blockquote1"><colgroup class="calibre18"><col class="calibre19"/><col class="calibre19"/><col class="calibre19"/></colgroup><thead class="calibre20"><tr class="calibre21"><th valign="bottom" class="calibre22">
<p class="calibre14">Step</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre14">Page</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre14">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">1</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Getting started</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Provide the customers with information about the eligibility criteria</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">2</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Your details</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">The customers enter their personal contact detail and date of birth</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">3</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Your rate</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">The customers selects their loan amount and term</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">4</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Your address</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">The customers enters their full home address and telephone numbers</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">5</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Confirm</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">The consumers agree to the legal terms of service and view the summary</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">6</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Completion</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">The consumers see an acknowledgement of their application form submission</p>
</td></tr></tbody></table></div><p class="calibre7">This is now <a id="id551" class="calibre1"/>quite simple to implement in the controller with the following extract:</p><div class="informalexample"><pre class="programlisting">@Named("lendingController")
@ConversationScoped
public class LendingController implements Serializable {
  /* ... */

  public String cancel() {
      checkAndEnd();
      return "index?faces-redirect=true";
  }

  public String jumpGettingStarted() {
      return "getting-started?faces-redirect=true";
  }

  public String doGettingStarted() {
      checkAndStart();
      return "your-details?faces-redirect=true";
  }

  public String doYourDetails() {
      checkAndStart();
      Calendar cal = Calendar.getInstance();
      cal.set(Calendar.DAY_OF_MONTH, dobDay);
      cal.set(Calendar.MONTH, dobMonth-1);
      int year = Integer.parseInt(dobYear);
      cal.set(Calendar.YEAR, year);
      applicant.getContactDetail().setDob(cal.getTime());
      return "your-rate?faces-redirect=true";
  }

  public String doYourRate() {
      checkAndStart();
      return "your-address?faces-redirect=true";
  }

  public String doYourAddress() {
      checkAndStart();
      return "confirm?faces-redirect=true";
  }

  public String doConfirm() {
      /* ... */
      return "completion?faces-redirect=true";
  }

  public String doCompletion() {
      /* ... */
      return "index?faces-redirect=true";
  }

  /* ... */
}</pre></div><p class="calibre7">The <code class="email">LendingController</code> bean has several action methods that correspond to the user requirements, namely <code class="email">doGettingStarted()</code>, <code class="email">doYourDetails()</code>, <code class="email">doYourRate()</code>, <code class="email">doYourAddress()</code>, <code class="email">doConfirm()</code>, and <code class="email">doCompletion()</code>. These action methods progress<a id="id552" class="calibre1"/> the customer to the next page view by simply returning the name. For most of these methods, apart from <code class="email">doCompletion()</code>, we ensure that the conversation is in a long-running state by calling <code class="email">checkAndStart()</code>. In the <code class="email">doCompletion()</code> and <code class="email">cancel()</code> methods, we invoke <code class="email">checkAndEnd()</code> to ensure that the conversation reverts to the transient state. The method <code class="email">doCompletion()</code> utilizes <code class="email">ApplicationService</code> to save the data, the <code class="email">Applicant</code> entity instance, to the underlying database.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip22" class="calibre1"/>Tip</h3><p class="calibre7">In the example code, we are cheating slightly by applying <code class="email">checkAndStart()</code> at the beginning of each action method. For production code, we should usually ensure that it is an error or a redirection if the user jumps into a bookmarkable URL that is supposed to have a conversation.</p></div><p class="calibre7">Let's examine the entities and fill in more of the blanks.</p></div><div class="book" title="Entity classes"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec49" class="calibre1"/>Entity classes</h2></div></div></div><p class="calibre7">The entity <code class="email">Applicant</code> is a master detail record. This is known as the core domain object. It stores the <a id="id553" class="calibre1"/>data for the customer's application for the instant secured loan. We capture the customer's loan information such as the contact details (<code class="email">ContactDetail</code>), the address (<code class="email">Address</code>), the telephone numbers (home, work, and mobile), and, most importantly, the financial details.</p><p class="calibre7">The <code class="email">Applicant</code> entity would be as follows:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.entity;
import javax.persistence.*;
import java.math.BigDecimal;
import java.util.Date;

@Entity
@Table(name="APPLICANT")
@NamedQueries({
  @NamedQuery(name="Applicant.findAll",
          query = "select a from Applicant a " +
                  "order by a.submitDate"),
  @NamedQuery(name="Applicant.findById",
          query = "select a from Applicant a where a.id = :id"),
})
public class Applicant {
  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private long id;

  @OneToOne(cascade = CascadeType.ALL)
  private ContactDetail  contactDetail;
  @OneToOne(cascade = CascadeType.ALL)
  private Address  address;

  private String workPhone;
  private String homePhone;
  private String mobileNumber;

  private BigDecimal loanAmount;
  private BigDecimal loanRate;
  private int loanTermMonths;
  private boolean termsAgreed;

  @Temporal(TemporalType.TIMESTAMP)
  private Date submitDate;

  public Applicant() { }

  // Getters and setters omitted ...
  // hashCode(), equals(), toString() elided
}</pre></div><p class="calibre7">The <code class="email">Applicant</code> entity stores the loan amount, rate, term, and also a submission date. It also contains<a id="id554" class="calibre1"/> the home, work, and mobile telephone numbers. An applicant has a one-to-one unidirectional relationship with both, the <code class="email">ContactDetail</code> and <code class="email">Address</code> entities.</p><p class="calibre7">For the financial properties such as <code class="email">loanRate</code> and <code class="email">loanAmount</code>, please note that we prefer to use <code class="email">BigDecimal</code> rather than the primitive floating-point type for monetary accuracy during calculations.</p><p class="calibre7">The way to explain a domain object to the stakeholder would be: a customer has a loan rate, a loan term, and must agree electronically to the legal conditions. With this information, the system can compute the loan and how much the customer pays back each month, and displays it at the time of applying for the loan.</p><p class="calibre7">You have already seen the <code class="email">ContactDetail</code> entity. It is exactly the same as before and only the package name has been refactored to entity. The following is the extract code of the <code class="email">Address</code> entity bean:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.entity;
import javax.persistence.*;

@Entity
@Table(name="ADDRESS")
@NamedQueries({
  @NamedQuery(name="Address.findAll",
    query = "select a from Address a "),
  @NamedQuery(name="Address.findById",
    query = "select a from Address a where a.id = :id"),
})
public class Address {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    @Column(name="ADDRESS", nullable = false,
            insertable = true, updatable = true,
            table = "ADDRESS")
    private long id;

    String houseOrFlatNumber;
    String street1;
    String street2;
    String townOrCity;
    String region;
    String areaCode;
    String country;

    // toString(), hashCode(), equalsTo() elided
    /* ... */
}</pre></div><p class="calibre7">The entity <code class="email">Address</code> represents the applicant's correspondence and legal personal address. There is <a id="id555" class="calibre1"/>nothing special to see here. It is a bog standard entity bean that you will see in e-commerce applications.</p><p class="calibre7">May I remind you that the source code for the examples are online and are a part of this book for your reference.</p></div><div class="book" title="Data service"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec50" class="calibre1"/>Data service</h2></div></div></div><p class="calibre7">How do we <a id="id556" class="calibre1"/>save the customer's input into persistence storage? Our application utilizes a stateful session EJB, and it provides methods to save and retrieve the <code class="email">Applicant</code> entity records.</p><p class="calibre7">The class <code class="email">ApplicantService</code> is as follows:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.boundary;
import uk.co.xenonique.digital.instant.entity.Applicant;
import javax.ejb.Stateful;
import javax.persistence.*;
import java.util.List;

@Stateful
public class ApplicantService {
  @PersistenceContext(unitName = "instantLendingDB",
    type = PersistenceContextType.EXTENDED)
  private EntityManager entityManager;

  public void add(Applicant applicant) {
    entityManager.persist(applicant);
  }
 
  /* ... */

  public List&lt;Applicant&gt; findAll() {
    Query query = entityManager.createNamedQuery(
        "Applicant.findAll");
    return query.getResultList();
  }

  public List&lt;Applicant&gt; findById(Integer id) {
    Query query = entityManager.createNamedQuery(
        "Applicant.findById").setParameter("id", id);
    return query.getResultList();
  }
}</pre></div><p class="calibre7">The <code class="email">add()</code> method <a id="id557" class="calibre1"/>inserts a new applicant into the database. The <code class="email">findAll()</code> and <code class="email">findById()</code> are not used in the instant loan example. These query methods are there for illustrative purposes only. Presumably, one requires access to the applicant data in another part of the full application.</p><p class="calibre7">We have covered the entity, control, and boundary of our application. It is time to examine the page views.</p></div></div>
<div class="book" title="Page views"><div class="book" id="aid-1IHDQ2"><div class="book"><div class="book"><h1 class="title"><a id="ch05lvl1sec46" class="calibre1"/>Page views</h1></div></div></div><p class="calibre7">The flow <a id="id558" class="calibre1"/>of control for the view is defined by the customer journey. Each page view represents a particular requirement that the business stakeholder wants to see. The index page view is a requirement, because the lender wants the customer to see a landing page. It is also a legal duty of compliance required by national government authorities. You will also notice that the customer journey maps to a linear flow, but not for all journeys.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note07" class="calibre1"/>Note</h3><p class="calibre7">The Payday loan scheme must follow compliance requirements. Refer to the websites of the UK Financial Conduct Authority (<a class="calibre1" href="https://goo.gl/NfbFbK">https://goo.gl/NfbFbK</a>) and the US Consumer Financial Protection Bureau (<a class="calibre1" href="http://goo.gl/3V9fxk">http://goo.gl/3V9fxk</a>).</p></div><p class="calibre7">The following table outlines the relationship between the controller actions and the view pages:</p><div class="informalexample"><table border="1" class="blockquote1"><colgroup class="calibre18"><col class="calibre19"/><col class="calibre19"/><col class="calibre19"/></colgroup><thead class="calibre20"><tr class="calibre21"><th valign="bottom" class="calibre22">
<p class="calibre14">View source</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre14">View target</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre14">Action method</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">index</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">getting-started</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">jumpGettingStarted()</code>
</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">getting-started</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">your-detail</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">doGettingStarted()</code>
</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">your-details</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">your-rate</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">doYourDetails()</code>
</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">your-rate</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">your-address</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">doYourRate()</code>
</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">your-address</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">confirm</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">doYourAddress()</code>
</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">confirm</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">completion</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">doConfirm()</code>
</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">completion</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">index</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">doCompletion()</code>
</p>
</td></tr></tbody></table></div><p class="calibre7">All the view<a id="id559" class="calibre1"/> pages are suffixed with the extension <code class="email">xthml</code> in the preceding table. It is quite clear there is a linear flow of work happening in the conversation. The conversation scope ideally begins when the customer enters the getting-started view through the <code class="email">jumpGettingStarted()</code> action method.</p><div class="book" title="An initial page view"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec51" class="calibre1"/>An initial page view</h2></div></div></div><p class="calibre7">Let's look at<a id="id560" class="calibre1"/> the initial <code class="email">index.xhtml</code> page view. This is the landing <a id="id561" class="calibre1"/>page of the loan application. The following is a screenshot of our loan application and the landing page:</p><div class="mediaobject"><img src="../Images/image00398.jpeg" alt="An initial page view" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The view<a id="id562" class="calibre1"/> for this page <code class="email">index.xhtml</code> is very straightforward. It<a id="id563" class="calibre1"/> features a basic link button component and features a Bootstrap carousel:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html ...&gt;
    &lt;ui:composition template="/basic_layout.xhtml"&gt;
      ...
      &lt;ui:define name="mainContent"&gt;
        &lt;h1&gt; JSF Instant Secure Lending&lt;/h1&gt;
        &lt;p&gt;
            Welcome to Duke Penny Loan where developers,
            designers and architect can secure
            an instant loan. &lt;em&gt;You move. We move.&lt;/em&gt;
        &lt;/p&gt;

        &lt;div class="content-wrapper   center-block"&gt;
          &lt;div id="carousel-example-generic" class="carousel slide"
                data-ride="carousel"  data-interval="10000"&gt;
            &lt;!-- Indicators --&gt;
            &lt;ol class="carousel-indicators"&gt;
                &lt;li data-target="#carousel-example-generic" data-slide-to="0" class="active"&gt;&lt;/li&gt;
                &lt;li data-target="#carousel-example-generic" data-slide-to="1"&gt;&lt;/li&gt;
                &lt;li data-target="#carousel-example-generic" data-slide-to="2"&gt;&lt;/li&gt;
                &lt;li data-target="#carousel-example-generic" data-slide-to="3"&gt;&lt;/li&gt;
            &lt;/ol&gt;
            ...
          &lt;/div&gt;
        &lt;/div&gt;&lt;!-- content-wrapper  --&gt;

        &lt;div class="content-wrapper"&gt;
          &lt;h:link styleClass="btn btn-primary btn-lg"
                  outcome="#{lendingController.jumpGettingStarted()}"&gt;
              Apply Now!
          &lt;/h:link&gt;
        &lt;/div&gt;

...
    &lt;/ui:define&gt; &lt;!--name="mainContent" --&gt;
  &lt;/ui:composition&gt;
&lt;/html&gt;</pre></div><p class="calibre7">The <code class="email">&lt;h:link&gt;</code> element is the most important feature of this view. The outcome of this custom<a id="id564" class="calibre1"/> tag references the <code class="email">jumpGettingStarted()</code> method in the <a id="id565" class="calibre1"/>controller, which begins a long-running conversation.</p><p class="calibre7">Even at this stage, before a conversation begins, we can deliver information to the customer. So, in a further section of the page view, we tell the customer about the minimum and maximum loan amounts and the rates using expression language.</p><p class="calibre7">The following is the code, which is also a part of the page view <code class="email">index.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">  &lt;div class="content-wrapper"&gt;
    &lt;p&gt;
      Apply for a Dukes Dollar loan. You borrow from
      &lt;b&gt;
        &lt;h:outputText value="#{lendingController.minimumLoanAmount}" &gt;
          &lt;f:convertNumber currencyCode="GBP" type="currency" /&gt;
        &lt;/h:outputText&gt;
      &lt;/b&gt;
        to
      &lt;b&gt;
        &lt;h:outputText value="#{lendingController.maximumLoanAmount}" &gt;
          &lt;f:convertNumber currencyCode="GBP" type="currency" /&gt;
        &lt;/h:outputText&gt;
      &lt;/b&gt;
        on a rate from
      &lt;b&gt;
        &lt;h:outputText value="#{lendingController.minimumLoanRate}" &gt;
          &lt;f:convertNumber pattern="0.00" /&gt;
        &lt;/h:outputText&gt;&amp;#37;
      &lt;/b&gt;
        to
      &lt;b&gt;
        &lt;h:outputText value="#{lendingController.maximumLoanRate}" &gt;
          &lt;f:convertNumber pattern="0.00" /&gt;
        &lt;/h:outputText&gt;&amp;#37;
      &lt;/b&gt;.
    &lt;/p&gt;
  &lt;/div&gt;</pre></div><p class="calibre7">This page<a id="id566" class="calibre1"/> makes use of the JSF core tag <code class="email">&lt;f:convertNumber&gt;</code> to<a id="id567" class="calibre1"/> format the floating numbers into monetary formats. The HTML entity character <code class="email">&amp;#37;</code> represents the percent character (<code class="email">%</code>). Remember, the view technology is strictly Facelets and not HTML5.</p></div><div class="book" title="Getting started page view"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec52" class="calibre1"/>Getting started page view</h2></div></div></div><p class="calibre7">The<a id="id568" class="calibre1"/> getting started view is even simpler. We present the<a id="id569" class="calibre1"/> customer with information regarding their eligibility to apply for a loan. The customer must be 18 years or over; we repeat how much they borrow and for how long.</p><p class="calibre7">The view is called <code class="email">getting-started.xhtml</code> and looks like the following screenshot:</p><div class="mediaobject"><img src="../Images/image00399.jpeg" alt="Getting started page view" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">There is a<a id="id570" class="calibre1"/> single JSF form with a button to move the <a id="id571" class="calibre1"/>customer to the next page view, <code class="email">your-details.xhtml</code>. There is no need to see the full source code for this view, because it is mainly mark-up HTML. However, we have another command link:</p><div class="informalexample"><pre class="programlisting">&lt;h:link styleClass="btn btn-primary btn-lg" outcome="#{lendingController.doGettingStarted()}"&gt;
  Next&lt;/h:link&gt;</pre></div></div><div class="book" title="Contact details page view"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec53" class="calibre1"/>Contact details page view</h2></div></div></div><p class="calibre7">The next <a id="id572" class="calibre1"/>view is the familiar contact details screen. We've subsumed it from the previous chapters into the instant secure loan example. We've <a id="id573" class="calibre1"/>also repurposed the JSF expression language to reference the controller and the nested properties.</p><p class="calibre7">The page-authoring code for the first name field is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;h:inputText class="form-control" label="First name"
   value="#{lendingController.applicant.contactDetail.firstName}"
   id="firstName" placeholder="First name"&gt;
    &lt;f:validateRequired/&gt;
    &lt;f:validateLength maximum="64" /&gt;
    &lt;f:ajax event="blur" render="firstNameError"/&gt;
&lt;/h:inputText&gt;</pre></div><p class="calibre7">The EL <code class="email">#{lendingController.applicant.contactDetail.firstName}</code> refers to the relevant nested entity bean property. We also retain the AJAX JSF validation features from <a class="calibre1" title="Chapter 4. JSF Validation and AJAX" href="part0043.xhtml#aid-190861">Chapter 4</a>, <span class="strong"><em class="calibre9">JSF Validation and AJAX</em></span> to provide a rich customer journey.</p><p class="calibre7">For this view, we use a JSF command button to submit the form:</p><div class="informalexample"><pre class="programlisting">&lt;h:commandButton styleClass="btn btn-primary"
                 action="#{lendingController.doYourDetails()}"
                 value="Submit" /&gt;
&amp;#160;
&amp;#160;
&lt;h:commandButton styleClass="btn btn-default"
                 action="#{lendingController.cancel()}"
                 immediate="true" value="Cancel"/&gt;</pre></div><p class="calibre7">We also have the obligatory cancel operation just in case the customer no longer wants to apply for the loan that day.</p><p class="calibre7">The following is a screenshot of the <code class="email">your-details.xhtml</code> view, which allows the customer to enter their contact details:</p><div class="mediaobject"><img src="../Images/image00400.jpeg" alt="Contact details page view" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Now it is<a id="id574" class="calibre1"/> time for something new. How about adding in<a id="id575" class="calibre1"/> some HTML5 goodness to the good old JavaServer Faces?</p></div><div class="book" title="Your rate page view"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec54" class="calibre1"/>Your rate page view</h2></div></div></div><p class="calibre7">The loan<a id="id576" class="calibre1"/> amount and rate page view relies on the HTML5 range <a id="id577" class="calibre1"/>control element, which, on most standard compliant browsers, is rendered as a horizontal slider. JSF has no built-in support for a range control; so for this view, we make use of the JSF HTML5 friendly support capability. The JSF specification allows us to write a markup that looks like a standard HTML component, but if we supply a special attribute, JSF treats it as a UI component. The pass-through ability works only with the markup that resembles the existing JSF core controls.</p><p class="calibre7">A picture is <a id="id578" class="calibre1"/>worth a thousand words, so let's take a look at the <a id="id579" class="calibre1"/>following screenshot of <code class="email">your-rate.xhtml</code>:</p><div class="mediaobject"><img src="../Images/image00401.jpeg" alt="Your rate page view" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The view uses AJAX partial updates and the HTML5 friendly markup facility. Let me show you the code for the form:</p><div class="informalexample"><pre class="programlisting">&lt;h:form id="yourRateForm"
  styleClass="form-horizontal"
    p:role="form"&gt;
  &lt;div class="form-group"&gt;
    &lt;h:outputLabel for="loanAmount"
      class="col-sm-3 control-label"&gt;
        Loan Amount&lt;/h:outputLabel&gt;
    &lt;div class="col-sm-9"&gt;
      &lt;input class="form-control" jsf:label="Loan Amount"
        jsf:value="#{lendingController.applicant.loanAmount}"
          type="range"
        min="#{lendingController.minimumLoanAmount}"
        max="#{lendingController.maximumLoanAmount}"
        step="250"
        id="loanAmount" &gt;
      &lt;f:validateRequired/&gt;
        &lt;f:ajax event="blur" render="loanAmountError"/&gt;
        &lt;f:ajax event="valueChange"
                listener="#{lendingController.recalculatePMT()}"
                render="paymentMonthlyOutput loanRateOutput  totalPayableOutput" /&gt;
      &lt;/input&gt;
      &lt;h:message id="loanAmountError"
                 for="loanAmount" styleClass="alert validation-error"/&gt;
    &lt;/div&gt;
  &lt;/div&gt;</pre></div><p class="calibre7">As with all <a id="id580" class="calibre1"/>JSF forms, we first declare a form called <code class="email">yourRateForm</code> and style it using Bootstrap CSS. Concentrating on the control element, you<a id="id581" class="calibre1"/> will notice that it is written as <code class="email">&lt;input&gt;</code> as not <code class="email">&lt;h:inputText&gt;</code>. This is because the JSF <code class="email">&lt;h:inputText&gt;</code> does not support the new HTML5 Range element. Ordinarily, the lack of access to a richer UI component would have been an issue for the instant secure lending.</p><p class="calibre7">The HTML5 Range Input element accepts a minimum, a maximum, and the current value. It also accepts a step size.</p><div class="book" title="HTML5 friendly support"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec24" class="calibre1"/>HTML5 friendly support</h3></div></div></div><p class="calibre7">JSF 2.2<a id="id582" class="calibre1"/> allows HTML5 friendly components with a new tag library URI for an XML namespace of <code class="email"/>. With the attributes <code class="email">jsf:id</code>, <code class="email">jsf:label</code>, and <code class="email">jsf:attribute</code>, HTML5 tags have a visibility within the JSF framework.</p><p class="calibre7">The full XML namespace for <code class="email">your-rate.xhtml</code> looks as follows:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html 
      
      
      
      
      
      
      &gt;</pre></div><p class="calibre7">We will <a id="id583" class="calibre1"/>discuss composite components later in the chapter. The HTML5 friendly tag library exposes a standard HTML input component to the JSF lifecycle. It is also easier for the creatives, not experienced in JSF or Java, to understand a page view. We do not have to worry any longer about the special name mangling that JSF applies to the view IDs; this means that component IDs are useful for both, HTML and JavaScript.</p></div><div class="book" title="Using AJAX for a partial update"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec25" class="calibre1"/>Using AJAX for a partial update</h3></div></div></div><p class="calibre7">In <a class="calibre1" title="Chapter 4. JSF Validation and AJAX" href="part0043.xhtml#aid-190861">Chapter 4</a>, <span class="strong"><em class="calibre9">JSF Validation and AJAX</em></span>, we learnt how to validate the form properties using Ajax. JSF allows the developers to perform a partial page update using the <code class="email">&lt;f:ajax&gt;</code> custom tag.</p><p class="calibre7">To enable a rich<a id="id584" class="calibre1"/> user example, whenever the customer changes the loan amount slider, we invoke the server side to recalculate the monthly payment amount. We achieve this by attaching an event listener to the change in value. The code for this would be as follows:</p><div class="informalexample"><pre class="programlisting">&lt;f:ajax event="valueChange"
   listener="#{lendingController.recalculatePMT()}"
   render="paymentMonthlyOutput  loanRateOutput   
           totalPayableOutput" /&gt;</pre></div><p class="calibre7">A new addition to the code is the render attribute, which specifies the unique ID of the JSF UI components that will be re-rendered on an AJAX response. In other words, we declaratively specify the components to be re-rendered on the completion of an AJAX behavior to JSF, and thus, obtain a partial update.</p></div><div class="book" title="Binding components"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec26" class="calibre1"/>Binding components</h3></div></div></div><p class="calibre7">Let's see the <a id="id585" class="calibre1"/>other components that the HTML5 Range element, the loan amount in this case, binds with.</p><p class="calibre7">Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">&lt;c:set var="loanAmountWidth" value="#{100.0 * (lendingController.applicant.loanAmount - lendingController.minimumLoanAmount) / (lendingController.maximumLoanAmount - lendingController.minimumLoanAmount)}" /&gt;

  &lt;div class="progress"&gt;
      &lt;div id="loanAmountProgress" class="progress-bar  progress-bar-success  progress-bar-striped"
           role="progressbar" aria-valuenow="#{lendingController.applicant.loanAmount}"
           aria-valuemin="#{lendingController.minimumLoanAmount}"
           aria-valuemax="#{lendingController.maximumLoanAmount}"
           style="width: ${loanAmountWidth}%;"&gt;
          #{lendingController.applicant.loanAmount}
      &lt;/div&gt;
  &lt;/div&gt;

  &lt;div class="content-wrapper"&gt;
    &lt;p id="loanAmountText" class="monetary-text"&gt;
        You would like to borrow
        &lt;b&gt; #{lendingController.currencySymbol}
        &lt;h:outputText value="#{lendingController.applicant.loanAmount}" &gt;
            &lt;f:convertNumber pattern="#0,000" /&gt;
        &lt;/h:outputText&gt; &lt;/b&gt;
    &lt;/p&gt;
  &lt;/div&gt;</pre></div><p class="calibre7">The progress<a id="id586" class="calibre1"/> markup is directly copied from the Bootstrap CSS component examples. We plugged in the value expressions to pull information from the <code class="email">LendingController</code> and the <code class="email">Applicant</code> instances.</p><p class="calibre7">Right at the top of the preceding code extract, we set the initial value of the progress bar with the  JSTL core tag <code class="email">&lt;c:set&gt;</code>.</p><div class="informalexample"><pre class="programlisting">&lt;c:set var="loanAmountWidth" value="#{100.0 *  (lendingController.applicant.loanAmount - lendingController.minimumLoanAmount) / (lendingController.maximumLoanAmount - lendingController.minimumLoanAmount)}" /&gt;</pre></div><p class="calibre7">This demonstrates that the unified expression language in EL 3.0 has the ability to retrieve the late bounded values in JSF to compute a result. The result is set in a page scope variable called <code class="email">loanAmountWide</code>. This variable is accessed later with <code class="email">$(loanAmountWidth)</code> and it sets the initial position value of the Bootstrap CSS progress bar component..</p><p class="calibre7">The HTML5 standard has no built-in support for displaying the value of an HTML5 Range element that works across all the top web browsers. At the time of writing, this feature was missing, and the W3C or WHATWG may tighten up this weakness in the HTML5 specification in the near future. Until then, we will use jQuery and JavaScript to fill the void.</p><p class="calibre7">If you <a id="id587" class="calibre1"/>noticed, the text is identified with <code class="email">loanAmountText</code> and the progress component is denoted by <code class="email">loanAmountProgress</code> in the preceding code. It is trivial to write the jQuery for binding the HTML5 Range elements to these fields.</p><p class="calibre7">We need a JavaScript module to achieve the binding. The complete code to <code class="email">/resources/app/main.js</code> is given as follows:</p><div class="informalexample"><pre class="programlisting">var instantLending = instantLending || {};

instantLending.Main = function()
{
  var init = function()
  {
    $(document).ready( function() {
      associateRangeToText(
        '#loanAmount', '#loanAmountProgress', '#loanAmountText',
        3000.0, 25000.0,
        function(value) {
            var valueNumber = parseFloat(value);
            return "You would like to borrow &lt;b&gt;£" +
                valueNumber.formatMoney(2, '.', ',') + "&lt;/b&gt;";
        });
    });
  };

  var associateRangeToText = function( rangeElementId,
    rangeProgressId, rangeTextId, minimumValue,
    maximumValue, convertor) {
    var valueElem = $(rangeElementId);
    var progressElem = $(rangeProgressId);
    var textElem = $(rangeTextId);
    valueElem.change( function() {
      var value = valueElem.val();
      progressElem.html(value);
      progressElem.attr("aria-valuenow", value);

      var percentage = 100.0 * ( value - minimumValue) /
        ( maximumValue - minimumValue );
      progressElem.css("width", percentage+"%");

      var monetaryText = convertor( value )
      textElem.html( monetaryText );
    });
  }

  var oPublic =
  {
    init: init,
    associateRangeToText: associateRangeToText
  };

  return oPublic;
}(jQuery);

instantLending.Main.init();</pre></div><p class="calibre7">The module <code class="email">instantLending.Main</code> defines a binding of an HTML Range element to two other <a id="id588" class="calibre1"/>components: a progress bar and a label text area. For a quick revision of the JavaScript module, refer to <a class="calibre1" title="Chapter 1. Digital Java EE 7" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="strong"><em class="calibre9">Digital Java EE 7</em></span>.</p><p class="calibre7">The module has an <code class="email">init()</code> function that sets up the binding using the jQuery document loading mechanism. It calls a function called <code class="email">associateRangeToText()</code>, which computes the percentage travelled for the progress bar and writes that value into the text element area. The function accepts the document ID for the relevant components: the range, progress, and text label components. It attaches an anonymous function to the range element; when the user changes the component, it updates the associated component.</p><p class="calibre7">The module <code class="email">main.js</code> also defines a helpful prototype method added to the JavaScript number type. The following code shows how it works:</p><div class="informalexample"><pre class="programlisting">// See http://stackoverflow.com/questions/149055/how-can-i-format-numbers-as-money-in-javascript
Number.prototype.formatMoney = function(c, d, t){
  var n = this,
      c = isNaN(c = Math.abs(c)) ? 2 : c,
      d = d == undefined ? "." : d,
      t = t == undefined ? "," : t,
      s = n &lt; 0 ? "-" : "",
      i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "",
      j = (j = i.length) &gt; 3 ? j % 3 : 0;
  return s + (j ? i.substr(0, j) + t : "") +
      i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) +
      (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
};</pre></div><p class="calibre7">The method <code class="email">formatMoney()</code> formats a floating-point value type to the monetary output as a String. This code has been contributed by Patrick Desjardins to Stack Overflow. The following code illustrates how to invoke this function:</p><div class="informalexample"><pre class="programlisting">var p = 128500.99
console.log(p.formatMoney(2, '.', ',') ) // 128,500.99</pre></div><p class="calibre7">The first<a id="id589" class="calibre1"/> parameter is the fixed fraction size, the second parameter determines the decimal symbol, and the third specifies the thousand-unit character.</p><p class="calibre7">With this module, we bound the HTML5 Range element to other elements in the page, thus demonstrating the HTML5 friendly support within JSF.</p></div><div class="book" title="Updating areas with AJAX partial updates"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec27" class="calibre1"/>Updating areas with AJAX partial updates</h3></div></div></div><p class="calibre7">How does JSF update an area of the page with an AJAX response? The developer specifies the <a id="id590" class="calibre1"/>UI components that are updated with the render attribute of the <code class="email">&lt;f:ajax&gt;</code> tag. In modern web design, which component can be treated as an HTML Layer element <code class="email">&lt;div&gt;</code> inside the standard JSF rendering kit? The answer for this is to use the <code class="email">&lt;h:panelGroup&gt;</code> JSF custom tag. We can supply this UI component with a unique identifier, and when the AJAX behavior completes, JSF renders this component.</p><p class="calibre7">The following is the code extract for the instant loan rate where the div element is identified by <code class="email">loanRateOutput</code>:</p><div class="informalexample"><pre class="programlisting">&lt;c:set var="loanRateWidth" value="#{100.0 * (lendingController.applicant.loanRate - lendingController.minimumLoanRate) / (lendingController.maximumLoanRate - lendingController.minimumLoanRate)}" /&gt;

&lt;h:panelGroup layout="block" id="loanRateOutput"&gt;
  &lt;div class="progress"&gt;
    &lt;div id="loanRateProgress" class="progress-bar  progress-bar-info progress-bar-striped"
      role="progressbar" aria-valuenow="#{lendingController.recalculateLoanRate()}"
         aria-valuemin="#{lendingController.minimumLoanRate}"
         aria-valuemax="#{lendingController.maximumLoanRate}"
         style="width: ${loanRateWidth}%;"&gt;
      #{lendingController.applicant.loanRate}
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="content-wrapper"&gt;
    &lt;p id="loanRateText" class="monetary-text"&gt;
      The tax rate will be
      &lt;b&gt; &lt;h:outputText value="#{lendingController.applicant.loanRate}" &gt;
        &lt;f:convertNumber pattern="0.000" /&gt;
      &lt;/h:outputText&gt;&amp;#37;&lt;/b&gt;
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/h:panelGroup&gt;</pre></div><p class="calibre7">The <code class="email">&lt;h:panelGroup&gt;</code> renders a div layer by default and thus contains the progress bar component and the text output content. The div is rendered after an invocation to the method <code class="email">recalculatePMT()</code> in <code class="email">LendingController</code>. Refer to the preceding sections for a reminder <a id="id591" class="calibre1"/>of this code.</p><p class="calibre7">The functions <code class="email">recalclulatePMT()</code> and <code class="email">recalculateLoanRate()</code> look as follows:</p><div class="informalexample"><pre class="programlisting">public BigDecimal recalculatePMT() {
  recalculateLoanRate();
  paymentMonthlyAmount = new BigDecimal(utility.calculateMonthlyPayment(
      applicant.getLoanAmount().doubleValue(),
      applicant.getLoanRate().doubleValue(),
      applicant.getLoanTermMonths()));

  totalPayable = paymentMonthlyAmount.multiply(
    new BigDecimal( applicant.getLoanTermMonths()));
  return paymentMonthlyAmount;
}

public BigDecimal recalculateLoanRate() {
  applicant.setLoanRate(
    utility.getTaxRate(applicant.getLoanAmount()));
  return applicant.getLoanRate();
}</pre></div><p class="calibre7">The function <code class="email">recalculatePMT()</code> uses the classic mathematical formula to evaluate the monthly payment amount for the loan based on the principal amount, length of the term and, of course, the rate.</p><p class="calibre7">The function <code class="email">recalculateLoanRate()</code> uses a utility, an application-scoped CDI bean, to work out the rate according to a table of rate limits that vary according to the loan account.</p><p class="calibre7">So let's recap. The JavaScript module <code class="email">instantLending::Main</code> updates on the client side. When the customer changes the loan amount then this module changes the progress bar component and the text content. Simultaneously, JSF invokes an AJAX request to the server side and invokes the action event listener, <code class="email">recalculatePMT()</code>. The framework eventually receives the AJAX response and then re-renders the loan rate, term control, and the summary <a id="id592" class="calibre1"/>area.</p><p class="calibre7">To complete the XHTML, let's inspect the remaining content on this page view, your-<code class="email">rate.xhtml</code>. The following is the content for the loan term, which is a drop-down component:</p><div class="informalexample"><pre class="programlisting">&lt;div class="form-group"&gt;
  &lt;h:outputLabel for="loanTerm" class="col-sm-3 control-label"&gt;
    Loan Term (Months)&lt;/h:outputLabel&gt;
  &lt;div class="col-sm-9"&gt;
    &lt;h:selectOneMenu class="form-control"
      label="Title" id="loanTerm"
         value="#{lendingController.applicant.loanTermMonths}"&gt;
      &lt;f:selectItem itemLabel="12 months" itemValue="12" /&gt;
      &lt;f:selectItem itemLabel="24 months" itemValue="24" /&gt;
      &lt;f:selectItem itemLabel="36 months" itemValue="36" /&gt;
      &lt;f:selectItem itemLabel="48 months" itemValue="48" /&gt;
      &lt;f:selectItem itemLabel="60 months" itemValue="60" /&gt;
      &lt;f:validateRequired/&gt;
      &lt;f:ajax event="blur" render="loanTermError"/&gt;
      &lt;f:ajax event="valueChange"
        listener="#{lendingController.recalculatePMT()}"
        render="paymentMonthlyOutput loanRateOutput 
          monthTermsOutput  totalPayableOutput" /&gt;
    &lt;/h:selectOneMenu&gt;
    &lt;h:message id="loanTermError"
      for="loanTerm" styleClass="alert validation-error"/&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p class="calibre7">The component also features a <code class="email">&lt;f:ajax&gt;</code> custom tag that invokes the recalculation event listener. Therefore, if the customer selects a different term for the loan, <code class="email">loanRateOutput</code> and <code class="email">paymentMonthlyOutput</code> also change along with the summary  due to a partial AJAX update.</p><p class="calibre7">Finally, let's see the content for the summary area:</p><div class="informalexample"><pre class="programlisting">&lt;div class="content-wrapper" &gt;
  &lt;div class="row"&gt;
    &lt;div class="col-md-12"&gt;
      &lt;p class="monetary-text-large"&gt;
        Your monthly payment is &lt;b&gt;
        #{lendingController.currencySymbol}&lt;h:outputText
          id="paymentMonthlyOutput"
          value="#{lendingController.recalculatePMT()}"&gt;
          &lt;f:convertNumber pattern="#0.00" /&gt;
        &lt;/h:outputText&gt;&lt;/b&gt;
      &lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="row"&gt;
    &lt;div class="col-md-6"&gt;
      &lt;p class="monetary-text"&gt;
        Loan term
        &lt;h:outputText id="monthTermsOutput"
        value="#{lendingController.applicant.loanTermMonths}"/&gt;
         months
      &lt;/p&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6"&gt;
      &lt;p class="monetary-text"&gt;
        Total payable
        #{lendingController.currencySymbol}&lt;h:outputText
          id="totalPayableOutput"
          value="#{lendingController.totalPayable}"&gt;
            &lt;f:convertNumber pattern="#0,000" /&gt;
        &lt;/h:outputText&gt;
      &lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p class="calibre7">In the <a id="id593" class="calibre1"/>preceding code extract, we use <code class="email">&lt;h:outputText&gt;</code> instead of <code class="email">&lt;h:panelGroup&gt;</code> to update only certain parts of the content using partial AJAX updates. A JSF output text element is a JSF UI component, so it works by asking for the AJAX behavior to be re-rendered.</p></div></div><div class="book" title="The address page view"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec55" class="calibre1"/>The address page view</h2></div></div></div><p class="calibre7">The address <a id="id594" class="calibre1"/>page view captures the customer's primary home <a id="id595" class="calibre1"/>address. This page also features an AJAX validation on the client side.</p><p class="calibre7">This code is so similar to the contact details form that we will leave out the code extract and the trees here. I will only show the first <code class="email">houseOrFlatNumber</code> fields in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;h:form id="yourAddressForm"
        styleClass="form-horizontal"
        p:role="form"&gt;
  &lt;div class="form-group"&gt;
    &lt;h:outputLabel for="houseOrFlatNumber"
      class="col-sm-3 control-label"&gt;
        House number&lt;/h:outputLabel&gt;
    &lt;div class="col-sm-9"&gt;
      &lt;h:inputText class="form-control"
        label="House or Flat Number"
          value="#{lendingController.applicant.address.houseOrFlatNumber}"
         id="houseOrFlatNumber" placeholder="First name"&gt;
        &lt;f:validateLength maximum="16" /&gt;
        &lt;f:ajax event="blur" render="houseOrFlatNumberError"/&gt;
      &lt;/h:inputText&gt;
      &lt;h:message id="houseOrFlatNumberError"
         for="houseOrFlatNumber"
         styleClass="alert validation-error"/&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  ...
&lt;/h:form&gt;</pre></div><p class="calibre7">The following is a screenshot of the <code class="email">your-address.xhtml</code> pageview.</p><div class="mediaobject"><img src="../Images/image00402.jpeg" alt="The address page view" class="calibre10"/></div><p class="calibre11"> </p></div><div class="book" title="The confirmation page view"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec56" class="calibre1"/>The confirmation page view</h2></div></div></div><p class="calibre7">The confirmation page view is where the customer sees all the details about their instant loan. In this <a id="id596" class="calibre1"/>view, they have a chance to read the terms and conditions of the contract. The customer must either select the checkbox to accept the <a id="id597" class="calibre1"/>agreement, or they can hit the cancel button to terminate the conversation. The cancel button invokes the <code class="email">cancel()</code> method in <code class="email">LendingController</code>, which, in turn, invokes <code class="email">checkAndEnd()</code>.</p><p class="calibre7">The only relevant code here is for the terms of agreement checkbox. The code extract is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;h:form id="yourConfirmForm"
  styleClass="form-horizontal" p:role="form"&gt; ...
  &lt;div class="form-group"&gt;
    &lt;h:outputLabel for="tocAgreed" class="col-sm-6 control-label"&gt;
      Do you agree with the &lt;em&gt;Terms of Conditions&lt;/em&gt;?
    &lt;/h:outputLabel&gt;
    &lt;div class="col-sm-6"&gt;
      &lt;h:selectBooleanCheckbox class="form-control"
         label="TOC Agreement" id="tocAgreed"
         value="#{lendingController.applicant.termsAgreed}"
      validator="#{lendingController.validateTermsOrConditions}" &gt;
          &lt;f:ajax event="blur" render="tocAgreedError"/&gt;
      &lt;/h:selectBooleanCheckbox&gt;
      &lt;h:message id="tocAgreedError"
         for="tocAgreed" styleClass="alert validation-error"/&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  ...
&lt;/h:form&gt;</pre></div><p class="calibre7">We use <code class="email">&lt;h:selectBooleanCheckBox&gt;</code> with immediate AJAX validation on the blur event. This ensures that the Boolean property is set to true on the server side. However, we must still verify on form submission, as we see in the action controller method:</p><div class="informalexample"><pre class="programlisting">  public String doConfirm() {
    if ( applicant.isTermsAgreed()) {
      throw new IllegalStateException(
        "terms of agreements not set to true");
    }
    recalculatePMT();
    applicant.setSubmitDate(new Date());
    applicantService.add(applicant);
    return "completion?faces-redirect=true";
  }</pre></div><p class="calibre7">Inside the <code class="email">doConfirm()</code> method, we recalculate the monthly payment term just to be sure. We check that the the applicant's data values have not changed, set the date of submission, and then we invoke the <code class="email">ApplicationService</code> to insert a new record into the database. After <a id="id598" class="calibre1"/>this method, the customer is said to have applied successfully.</p><p class="calibre7">We include a <a id="id599" class="calibre1"/>manual check on <code class="email">isTermsAgreed()</code>, because it is a legal requirement in the contract for the customer to accept the terms and conditions. It is probably controversial to raise an application error <code class="email">IllegalStateException</code> here. More likely, the developer would print a message to an error log, and also raise an exception. The servlet specification allows different exceptions to be trapped and sent to a certain error page. Therefore, if we created a custom runtime exception such as <code class="email">LegalTermsAgreementException</code>, we could responsibly handle such conditions.</p><p class="calibre7">In a production <a id="id600" class="calibre1"/>system, the end of this sequence would probably trigger an additional business process. For instance, the work message might be sent <a id="id601" class="calibre1"/>to another case working area using a messaging bus, JMS. In a modern digital application, the customer should expect an e-mail to be sent with the confirmation and the loan contract details. Of course, this is an additional exercise for the reader to deliver this requirement.</p><p class="calibre7">The following is a screenshot for the confirmation view, <code class="email">confirm.xhtml</code>:</p><div class="mediaobject"><img src="../Images/image00403.jpeg" alt="The confirmation page view" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Let's <a id="id602" class="calibre1"/>move<a id="id603" class="calibre1"/> to the final page view of completion.</p></div><div class="book" title="The completion page view"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec57" class="calibre1"/>The completion page view</h2></div></div></div><p class="calibre7">The complete<a id="id604" class="calibre1"/> stage is straightforward. The customer has submitted his application, so we only need to inform him or her about this and then the <a id="id605" class="calibre1"/>conversation ends. The following is the full code for the <code class="email">doCompletion()</code> method in <code class="email">LendingController</code>:</p><div class="informalexample"><pre class="programlisting">  public String doCompletion() {
    checkAndEnd();
    return "index?faces-redirect=true";
  }</pre></div><p class="calibre7">This method simply ends the conversation scope, because the user's digital customer journey is finished by then.</p><p class="calibre7">Now we have a complete flow, a digital customer journey. What is missing? We should add the steps to accept a valid bank account, a bank sorting code, IBAN number, and an integration into the national bank infrastructure! Of course, we would also need a certain level of financial capital, enough money to satisfy the regulators; in the United Kingdom, this would be the Financial Conduct Authority (<a class="calibre1" href="http://www.fca.org.uk/">http://www.fca.org.uk/</a>).</p><p class="calibre7">A screenshot of this page view, <code class="email">completion.xhtml</code>, is as follows:</p><div class="mediaobject"><img src="../Images/image00404.jpeg" alt="The completion page view" class="calibre10"/></div><p class="calibre11"> </p></div><div class="book" title="Utility classes"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec58" class="calibre1"/>Utility classes</h2></div></div></div><p class="calibre7">Often in applications, we refactor common methods and properties into a separate utility class, which has<a id="id606" class="calibre1"/> features so common that they do not make sense in <a id="id607" class="calibre1"/>any particular package domain. We often place these concepts inside static methods in a singleton. With Java EE, we can do much better than that. Since CDI supports application scope, we can simply move our commons methods into a POJO and make CDI inject the bean into dependent objects. It is the smart way to handle the data, the time and monthly payment term calculation in the <code class="email">LendingController</code> example.</p><p class="calibre7">The application<a id="id608" class="calibre1"/> scope bean <code class="email">DateTimeController</code> acts as a  helper<a id="id609" class="calibre1"/> for the page author views:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.control;
import javax.annotation.PostConstruct;
import javax.enterprise.context.ApplicationScoped;
import javax.inject.Named;
import java.io.Serializable;
import java.text.DateFormatSymbols;
import java.util.*;

@Named("dateHelperController")
@ApplicationScoped
public class DateHelperController implements Serializable {
  private List&lt;Integer&gt; daysOfTheMonth = new ArrayList&lt;&gt;();
  private Map&lt;String,Integer&gt; monthsOfTheYear
    = new LinkedHashMap&lt;&gt;();

  @PostConstruct
  public void init() {
    for (int d=1; d&lt;=31; ++d) { daysOfTheMonth.add(d); }
    DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
    for (int m=1; m&lt;=12; ++m) {
        monthsOfTheYear.put(symbols.getMonths()[m-1], m );
    }
  }

  public List&lt;Integer&gt; getDaysOfTheMonth() {
    return daysOfTheMonth;
  }
  public Map&lt;String,Integer&gt; getMonthsOfTheYear() {
    return monthsOfTheYear;
  }
}</pre></div><p class="calibre7">The <code class="email">DateHelperController</code> method is used in <code class="email">your-details.view</code>, and it generates the data for the drop-down day and month of the date-of-birth fields. This code was originally a part of the <code class="email">ContactDetailsController</code> method in <a class="calibre1" title="Chapter 4. JSF Validation and AJAX" href="part0043.xhtml#aid-190861">Chapter 4</a>, <span class="strong"><em class="calibre9">JSF Validation and AJAX</em></span>. It has been refactored for reuse.</p><p class="calibre7">There is an other POJO with an application scope and it is called Utility.</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.util;
import javax.enterprise.context.ApplicationScoped;
import java.io.Serializable;
import java.math.BigDecimal;
import java.util.*;

@ApplicationScoped
public class Utility implements Serializable {
  protected List&lt;LoanRateBounds&gt; bounds = Arrays.asList(
      new LoanRateBounds("0.0",       "4500.0",   "22.50"),
      new LoanRateBounds("4500.0",    "6000.0",   "9.79"),
      new LoanRateBounds("6000.0",    "9000.0",   "7.49"),
      new LoanRateBounds("9000.0",    "11500.0",  "4.49"),
      new LoanRateBounds("11500.0",   "15000.0",  "4.29"),
      new LoanRateBounds("15000.0",   "20000.0",  "5.79"),
      new LoanRateBounds("20000.0",   "25000.0",  "6.29"),
      new LoanRateBounds("30000.0",   "50000.0",  "6.99")
      );

  public BigDecimal getTaxRate( BigDecimal amount ) {
    for ( LoanRateBounds bound : bounds ) {
      if ( bound.getLower().compareTo(amount) &lt;= 0 &amp;&amp;
            bound.getUpper().compareTo(amount) &gt; 0 ) {
        return  bound.getRate();
      }
    }
    throw new IllegalArgumentException("no tax rate found in bounds");
  }

  public double calculateMonthlyPayment( double pv, double apr, int np ) {
    double ir = apr / 100 / 12;
    return (pv * ir) / (1 - Math.pow(1+ir, -np));
  }
}</pre></div><p class="calibre7">In the <a id="id610" class="calibre1"/>preceding code, the method <code class="email">calculateMonthlyPayment()</code> calculates the monthly payment amount. The arguments are <code class="email">pv</code> (that specifies the principal value), <code class="email">apr</code> (that specifies the annual percentage rate), and the <code class="email">np</code>, which <a id="id611" class="calibre1"/>stands for the notice period measured in months.</p><p class="calibre7">The method <code class="email">getTaxRate()</code> looks up the appropriate tax rate given the principal value, that is, the loan amount that the customer wants. The class <code class="email">LoanRateBounds</code> is a simple POJO, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.util;
import java.math.BigDecimal;

public class LoanRateBounds {
  private final BigDecimal lower;
  private final BigDecimal upper;
  private final BigDecimal rate;

  public LoanRateBounds(String lower, String upper, String rate) {
    this(new BigDecimal(lower), new BigDecimal(upper),
        new BigDecimal(rate));
  }

  public LoanRateBounds(final BigDecimal lower,
    final BigDecimal upper, final BigDecimal rate) {
      this.lower = lower;
      this.upper = upper;
      this.rate = rate;
  }

  // toString(), hashCode(), equals() and getters omitted
}</pre></div><p class="calibre7">This <code class="email">LoanRateBounds</code> POJO is <a id="id612" class="calibre1"/>an immutable object and is <a id="id613" class="calibre1"/>thread-safe.</p></div></div>
<div class="book" title="Composite custom components"><div class="book" id="aid-1JFUC2"><div class="book"><div class="book"><h1 class="title"><a id="ch05lvl1sec47" class="calibre1"/>Composite custom components</h1></div></div></div><p class="calibre7">JSF also features custom components that you, the developer, can write. In fact, the instant secure<a id="id614" class="calibre1"/> lending example uses one: the top header of each page view in the conversation. It is a hint that informs the customer where he or she is in the flow. I've called it the <code class="email">WorkerBannerComponent</code>.</p><p class="calibre7">In JSF, a custom component describes a reusable piece of page content that may insert into a Facelet view many times over. A custom component may or may not have a backing bean, and it may or may not group together a set of properties into a form. As mentioned in <a class="calibre1" title="Chapter 2. JavaServer Faces Lifecycle" href="part0025.xhtml#aid-NQU22">Chapter 2</a>, <span class="strong"><em class="calibre9">JavaServer Faces Lifecycle</em></span>, we can use custom components to build repeated page content that takes advantage of the latest HTML frameworks such as Bootstrap and that abstracts away the deeper details. Businesses can use custom components to establish a common structure for the page content and markup.</p><div class="book" title="Components with XHTML"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec59" class="calibre1"/>Components with XHTML</h2></div></div></div><p class="calibre7">The <code class="email">WorkerBannerComponent</code> is a backing bean for the logic of the display header, which identifies <a id="id615" class="calibre1"/>the section of the flow that the <a id="id616" class="calibre1"/>customer is active in. The code for the custom component is as follows:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.control;
import javax.faces.component.*;
import javax.faces.context.FacesContext;
import java.io.IOException;

@FacesComponent("workerBannerComponent")
public class WorkerBannerComponent extends UINamingContainer {
  private String gettingStartedActive;
  private String yourDetailsActive;
  private String yourRateActive;
  private String yourAddressActive;
  private String confirmActive;
  private String completedActive;

  @Override
  public void encodeAll(FacesContext context) throws IOException {
    if (context == null) {
        throw new NullPointerException("no faces context supplied");
    }
    String sectionName = (String)getAttributes().get("sectionName");
    gettingStartedActive = yourDetailsActive = yourRateActive = yourAddressActive = confirmActive = completedActive = "";

    if ( "gettingStarted".equalsIgnoreCase(sectionName)) {
        gettingStartedActive = "active";
    }
    else if ( "yourDetails".equalsIgnoreCase(sectionName)) {
        yourDetailsActive = "active";
    }
    else if ( "yourRate".equalsIgnoreCase(sectionName)) {
        yourRateActive = "active";
    }
    else if ( "yourAddress".equalsIgnoreCase(sectionName)) {
        yourAddressActive = "active";
    }
    else if ( "confirm".equalsIgnoreCase(sectionName)) {
        confirmActive = "active";
    }
    else if ( "completed".equalsIgnoreCase(sectionName)) {
        completedActive = "active";
    }
    super.encodeAll(context);
  }

  // Getters and setters omitted
}</pre></div><p class="calibre7">We apply the annotation <code class="email">@javax.faces.component.FacesComponent</code> to the POJO <code class="email">WorkerBannerComponent</code>. This annotation declares to the JSF that we have a custom component with the name <code class="email">workerBannerComponent</code>. The <code class="email">@FacesComponent</code> is expanded in JSF 2.2, so that we can write all the code for generating the output HTML in Java. Fortunately, we do not require the ability to create a custom component that also registers its own custom tag, because it is quite handy to control the markup in a lightweight <a id="id617" class="calibre1"/>editor like Sublime or VIM.</p><p class="calibre7">Our <code class="email">WorkerBannerComponent</code> extends <code class="email">javax.faces.component.UINamingContainer</code>, which is a custom component  supplied by JSF<a id="id618" class="calibre1"/> with the ability to add a unique identifier. In the JSF parlance, a naming container is a bucket for a component that has a unique name and which can also store the child components with the same characteristics.</p><p class="calibre7">The overridden method <code class="email">encodeAll()</code> is usually the place to render the output of a custom tag that provides its own markup. Here, we second the intent with the logic that decides which worker tab is active and which is not. Similar to the custom event handling in the previous chapter (<a class="calibre1" title="Chapter 4. JSF Validation and AJAX" href="part0043.xhtml#aid-190861">Chapter 4</a>, <span class="strong"><em class="calibre9">JSF Validation and AJAX</em></span>, <span class="strong"><em class="calibre9">Invoking an action event listener</em></span> section), we can interrogate the attributes in order to retrieve the parameters that are passed to our component from the page content.</p><p class="calibre7">Let's examine the page content for this component. The name of the file is <code class="email">worker-banner.xhtml</code>, and the extracted page content looks like the following:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html 
      
      
       &gt;
  &lt;cc:interface componentType="workerBannerComponent"&gt;
    &lt;cc:attribute name="sectionName" required="true"/&gt;
  &lt;/cc:interface&gt;

  &lt;cc:implementation&gt;
    &lt;div class="workflow-wrapper"&gt;
      &lt;div class="workflow-column"&gt;
        &lt;div class="workflow-title  #{cc.gettingStartedActive} pull-left" &gt;
            Getting Started
        &lt;/div&gt;
        &lt;div class="workflow-arrow-right #{cc.gettingStartedActive}  pull-left"&gt;&lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="workflow-column"&gt;
        &lt;div class="workflow-title  #{cc.yourDetailsActive} pull-left" &gt;
            Your Details
        &lt;/div&gt;
        &lt;div class="workflow-arrow-right  #{cc.yourDetailsActive} pull-left"&gt;&lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="workflow-column"&gt;
        &lt;div class="workflow-title  #{cc.yourRateActive} pull-left" &gt;
            Your Rate
        &lt;/div&gt;
        &lt;div class="workflow-arrow-right  #{cc.yourRateActive} pull-left"&gt;&lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="workflow-column"&gt;
        &lt;div class="workflow-title  #{cc.yourAddressActive} pull-left" &gt;
            Your Address
        &lt;/div&gt;
        &lt;div class="workflow-arrow-right  #{cc.yourAddressActive} pull-left"&gt;&lt;/div&gt;
      &lt;/div&gt;

      ...

      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/cc:implementation&gt;
&lt;/html&gt;</pre></div><p class="calibre7">In JSF, the custom composite component content must be placed into the special directory, <code class="email">/resources</code>. The full path for this content is <code class="email">/resources/components/workflow-banner.xhtml</code>. The composite components are registered<a id="id619" class="calibre1"/> under an XML namespace, namely <a class="calibre1" href="http://xmlns.jcp.org/jsf/composite">http://xmlns.jcp.org/jsf/composite</a>. A custom component requires an interface and an implementation. Facelets define two tags <code class="email">&lt;cc:interfaces&gt;</code> and <code class="email">&lt;cc:implementation&gt;</code>.</p><p class="calibre7">The library tag <code class="email">&lt;cc:interface&gt;</code> declares a composite component, and the attribute <code class="email">componentType</code> references the name with the Java component. Here, it refers to the <code class="email">WorkerBannerComponent</code>. The outer tag also encompasses a set of <code class="email">&lt;cc:attribute&gt;</code> tags that declare the attributes that a component accepts. In our component, we only accept a <code class="email">sectionName</code> attribute, which allows the page author to state where the customer is in their journey.</p><p class="calibre7">The tag <code class="email">&lt;cc:implementation&gt;</code> declares the actual implementation, which is the rendered output. The tag also places a specially named variable called <code class="email">cc</code>, which stands for composite <a id="id620" class="calibre1"/>component, into the JSF page scope. We<a id="id621" class="calibre1"/> can use it to access the properties in the custom composite component, and this special variable is only accessible inside the body content of the <code class="email">&lt;cc:implementation&gt;</code> tag. Therefore, the value expression <code class="email">#{cc.gettingStartedActive}</code> accesses the property called <code class="email">gettingStartedActive</code> in <code class="email">WorkerBannerComponent</code>. The logic ensures that only the named section will be highlighted as active through CSS. The logic is placed in a bean, because we need it to execute in the Render-Response phase of the JSF lifecycle rather than in the build time. JSF also adds another special variable into the page scope called component. This variable refers to the actual component being processed during the rendering phase.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip23" class="calibre1"/>Tip</h3><p class="calibre7">
<span class="strong"><strong class="calibre8">Why does JSTL not work?</strong></span>
</p><p class="calibre7">You might have thought that we could have dispensed with the server-side component and solved our banner problem with the good old <span class="strong"><strong class="calibre8">JavaServer Pages Tag Library</strong></span> (<span class="strong"><strong class="calibre8">JSTL</strong></span>). Unfortunately, this will fail to work, because JSF operates with lifecycles <a id="id622" class="calibre1"/>and therefore, the later binding of the frameworks makes working with the core JSTL tags such as <code class="email">&lt;c:if&gt;</code>, <code class="email">&lt;c:choose&gt;</code>, and <code class="email">&lt;c:set&gt;</code> unworkable. Besides, good software engineers know that best practice means separating the presentation mark-up from business logic.</p></div><p class="calibre7">Although not shown in this section, it is possible to access the supplied attributes on the custom component inside the <code class="email">&lt;cc:implementation&gt;</code> body content. The value expression <code class="email">cc.attrs</code> provides such access. So if we wanted to write a component to access the input attributes, then we could have retrieved the section name in the markup using <code class="email">#{cc.attrs.sectionName}</code>.</p><p class="calibre7">That is all there is to writing a composite component. In order to use it, we need to add an XML namespace, which is associated with the tag to the page that uses it. Let's see how to use it from the page content for <code class="email">your-rate.xhtml</code> from our instant secure loan application, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;html 
    
    
    
    
    
    
    &gt;

  &lt;ui:composition template="/basic_layout.xhtml"&gt;
    &lt;ui:define name="mainContent"&gt;
      &lt;xen:workflow-banner sectionName="yourRate"/&gt;
      ...         
      
&lt;/html&gt;</pre></div><p class="calibre7">The namespace is <a class="calibre1" href="http://xmlns.jcp.org/jsf/composite/components">http://xmlns.jcp.org/jsf/composite/components</a>, and it is identified by the name <span class="strong"><strong class="calibre8">xen</strong></span>. The special directory <code class="email">/resources/components</code> is significant, because JSF searches for the custom components at this location by default.</p><p class="calibre7">Now we can<a id="id623" class="calibre1"/> directly use the component by<a id="id624" class="calibre1"/> the element name <code class="email">&lt;xen:workflow-banner&gt;</code>. Under the counter, JSF knows that it has to look up a custom component definition called <code class="email">workflow-banner.xhtml</code>; it then associates the component type, <code class="email">WorkerBannerComponent</code>.</p><p class="calibre7">To recap, a composite component allows the JSF developers to create reusable dynamic content. A custom component uses an XHTML Facelet view and, usually, a backing bean or another action controller. A composite component may include other template views. There are no restrictions on the sort of markup as long as it is well formed and valid XHTML Facelets. The page author can use this composite component in many pages. Best of all, these composite components have the full support of the JSF action listeners, validators, and convertors.</p></div><div class="book" title="Composite components and custom components"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec60" class="calibre1"/>Composite components and custom components</h2></div></div></div><p class="calibre7">As mentioned in<a id="id625" class="calibre1"/> the preceding <a id="id626" class="calibre1"/>section, the JSF custom components make a distinction between the composite parent and the component in the render phase. Inside <code class="email">&lt;cc:implementation&gt;</code>, one can access the composite parent with the variable <code class="email">cc</code> and the actual processed component with the variable component.</p><p class="calibre7">An example of the distinction will make it abundantly clear. Let's create a custom composite component with just an XHTML markup. The path of the file, under the web root, is <code class="email">/resources/components/component-report.xhtml</code>.</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html 
  
   &gt;

  &lt;cc:interface/&gt; 
  
  &lt;cc:implementation&gt;
    &lt;div class="alert alert-info"&gt;
      &lt;h:outputText value="Own ID: #{component.id}, parent composite ID: #{cc.id}" /&gt;
      &lt;br/&gt;
      &lt;h:outputText value="Own ID: #{component.id}, parent composite ID: #{cc.id}" /&gt;
      &lt;br/&gt;
      &lt;h:outputText value="Own ID: #{component.id}, parent composite ID: #{cc.id}" /&gt;
    &lt;/div&gt;
  &lt;/cc:implementation&gt;
&lt;/html&gt;</pre></div><p class="calibre7">By default, JSF<a id="id627" class="calibre1"/> references the <a id="id628" class="calibre1"/>XHTML with the basename, component-report. This component just dumps the component and the composite ids to the page . The component is one of the three <code class="email">&lt;h:outputText&gt;</code> tags. The parent of these is the composite component itself. In fact, the component can be derived programmatically by invoking the static helper method, <code class="email">getCompositeComponentParent()</code>, on the abstract class, <code class="email">javax.faces.component.UIComponent</code>.</p><p class="calibre7">Let's inspect the page view that uses the composite component, <code class="email">/composite-demo.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html 
  
  
  
  &gt;

  &lt;ui:composition template="/basic_layout.xhtml"&gt;
    &lt;ui:define name="mainContent"&gt;
      &lt;h1&gt; Custom Composite Demonstations&lt;/h1&gt;

      &lt;xen:workflow-banner sectionName="gettingStarted"/&gt;
      &lt;pro:infoSec message="The definition of digital transformation" /&gt;
      &lt;xen:component-report/&gt;

      &lt;a class="btn btn-primary btn-lg"
        href="#{request.contextPath}/index.xhtml"&gt; Home &lt;/a&gt;

    &lt;/ui:define&gt; &lt;!--name="mainContent" --&gt;
  &lt;/ui:composition&gt;
&lt;/html&gt;</pre></div><p class="calibre7">The XHTML <a id="id629" class="calibre1"/>element <code class="email">&lt;xen:component-report&gt;</code> represents the custom component. It is defined with the namespace <a class="calibre1" href="http://xmlns.jcp.org/jsf/composite/components">http://xmlns.jcp.org/jsf/composite/components</a>, the same one as before.</p><p class="calibre7">The following is <a id="id630" class="calibre1"/>a screenshot of the page view illustrating the identifiers for the composite and component tags:</p><div class="mediaobject"><img src="../Images/image00405.jpeg" alt="Composite components and custom components" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">You can see the component ID changes per processing.</p></div><div class="book" title="Composite component with self-generating tag"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch05lvl2sec61" class="calibre1"/>Composite component with self-generating tag</h2></div></div></div><p class="calibre7">In JSF 2.2, <code class="email">@FacesComponent</code> has the ability to generate the custom tag without specifying <a id="id631" class="calibre1"/>any XML declaration. This<a id="id632" class="calibre1"/> feature is in contrast to the previous versions of the specification, where it was a lot harder to write maintainable and reusable custom components. JSF 2.2 adds three additional attributes, including the attribute <code class="email">createTag</code>.</p><p class="calibre7">The following table outlines the attributes for the <code class="email">@FacesComponent</code> annotation:</p><div class="informalexample"><table border="1" class="blockquote1"><colgroup class="calibre18"><col class="calibre19"/><col class="calibre19"/><col class="calibre19"/></colgroup><thead class="calibre20"><tr class="calibre21"><th valign="bottom" class="calibre22">
<p class="calibre14">Attribute</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre14">Type</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre14">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">value</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">String</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">The <a id="id633" class="indexterm"/>value of this expression is the name of the custom component. By default, it is the camel case of the POJO class with the first character in lowercase, like any Java identifier.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">createTag</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">Boolean</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">If true, then <a id="id634" class="indexterm"/>JSF creates a custom tag for this component.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">tagName</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">String</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Specifies<a id="id635" class="indexterm"/> the tag name for the custom component.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">namespace</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">
<code class="literal">String</code>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Specifies <a id="id636" class="indexterm"/>the namespace for the custom component. If none is given, the default is <a class="indexterm" href="http://xmlns.jcp.org/jsf/component">http://xmlns.jcp.org/jsf/component</a>.</p>
</td></tr></tbody></table></div><p class="calibre7">By way of example, we will write a basic security information custom tag, which is a custom<a id="id637" class="calibre1"/> component.</p><p class="calibre7">The <a id="id638" class="calibre1"/>following is the complete code for a <a id="id639" class="calibre1"/>custom component called <span class="strong"><strong class="calibre8">InfoSecurityComponent</strong></span>:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.instant.control;
import javax.faces.component.FacesComponent;
import javax.faces.component.UINamingContainer;
import javax.faces.context.FacesContext;
import javax.faces.context.ResponseWriter;
import java.io.IOException;
import java.security.Principal;

@FacesComponent(
  value="informationSecurity",
  namespace = "http:/www.xenonique.co.uk/jsf/instant/lending",
  tagName = "infoSec", createTag = true)
public class InfoSecurityComponent extends UINamingContainer {
  private String message;

  @Override
  public String getFamily() {
    return "instant.lending.custom.component";
  }

  @Override
  public Object saveState(FacesContext context) {
    Object values[] = new Object[2];
    values[0] = super.saveState(context);
    values[1] = message;
    return ((Object) (values));
  }

  @Override
  public void restoreState(FacesContext context, Object state) {
    Object values[] = (Object[]) state;
    super.restoreState(context, values[0]);
    message = (String) values[1];
  }

  public void encodeBegin(FacesContext context)
        throws IOException {
    ResponseWriter writer = context.getResponseWriter();
    writer.startElement("div", this);
    writer.writeAttribute("role", "alert", null );
    Principal principal = FacesContext.getCurrentInstance()
        .getExternalContext().getUserPrincipal();
    String name;
    if ( principal !=null ) {
      writer.writeAttribute("class","alert  alert-success",null);
      name = principal.getName();
    }
    else {
      writer.writeAttribute("class","alert  alert-danger",null);
      name = "unknown";
    }
    writer.write(
      String.format("[USER: &lt;strong&gt;%s&lt;/strong&gt;] - %s",
      name, message));
  }

  public void encodeEnd(FacesContext context)
          throws IOException {
    ResponseWriter writer = context.getResponseWriter();
    writer.endElement("div");
    writer.flush();
  }
  // Getter and setter omitted
}</pre></div><p class="calibre7">Once <a id="id640" class="calibre1"/>again, our <code class="email">InfoSecurityComponent</code> component extends the class <code class="email">UINamingContainer</code>, because this handles many useful JSF interfaces such as <code class="email">NamingContainer</code>, <code class="email">UniqueIdVendor</code>, <code class="email">StateHolder</code>, and <code class="email">FacesListener</code>. We annotate with <code class="email">@FacesComponent</code>, and this time, we supply the namespace, <code class="email">createTag</code>, and value tag.</p><p class="calibre7">The <code class="email">getFamily()</code> method specifies the collection that this component belongs to. It is helpful if you <a id="id641" class="calibre1"/>are creating a reusable library of components for distribution, and effectively aids the third-party programming tools.</p><p class="calibre7">The <code class="email">saveState()</code> and <code class="email">restoreState()</code> methods demonstrate how we persist the state of a component over multiple HTTP requests. The reason for the existence of <code class="email">StateHelpert</code> is the impedance between the JSF lifecycle and the stateless nature of HTTP. As you already know by now, JSF builds a dynamic graph of the component tree for a page. The state of this tree changes during the transition between the JSF phases. Saving the states allows JSF to preserve the information from the web form, when the user submitted the page. If there is a failure during conversion or validation, JSF can restore the state of the view.</p><p class="calibre7">In the <code class="email">saveState()</code> method, we create an <code class="email">Object[]</code> array of the necessary size and fill it with values. The first element of the array must be the saved context.</p><p class="calibre7">On the other hand, JSF invokes the <code class="email">loadState()</code> method with the object state, which is also an <code class="email">Object[]</code> array. We ignore the first element, because this is an irrelevant and, probably, a stale context from the previous request. We reassign the properties from the remaining elements of the array.</p><p class="calibre7">The methods <code class="email">encodeBegin()</code> and <code class="email">encodeEnd()</code> are where the real fun happens. These methods are designed for rendering the markup of the custom component, the tag's output. Because the custom component may embed other components, it is a good idea to split the rendered output. Here, we are using <code class="email">javax.faces.context.ResponseWriter</code> to build up the HTML output. The abstract class has methods called <code class="email">startElement()</code> and <code class="email">endElement()</code> to render the content at the beginning and at the end of the markup element respectively. The method <code class="email">writeAttribute()</code> handles the markup attributes of the element.</p><p class="calibre7">So <code class="email">InfoSecurityComponent</code> renders a div layer element with the Bootstrap CSS alert classes. It attempts to retrieve the name of the current Java EE security principal, if one has been defined, and displays that information to the customer.</p><p class="calibre7">When given the XHTML page view:</p><div class="informalexample"><pre class="programlisting">&lt;html 
    ...
    
    &gt;

...
    &lt;pro:infoSec message="Hello world component" /&gt;</pre></div><p class="calibre7">The <a id="id642" class="calibre1"/>output HTML should <a id="id643" class="calibre1"/>look like this:</p><div class="informalexample"><pre class="programlisting">&lt;div class="alert alert-success" role="alert"&gt;
  [USER: &lt;strong&gt;unknown&lt;/strong&gt;] - Hello world component
&lt;/div&gt;</pre></div><p class="calibre7">Note that <a id="id644" class="calibre1"/>the namespace in the<a id="id645" class="calibre1"/> XHTML matches the custom tag's annotation.</p><p class="calibre7">Take a look at the following screenshot of the view of <code class="email">your-rate.xhtml</code> running on an iOS Simulator. It demonstrates the responsive web design features of the application:</p><div class="mediaobject"><img src="../Images/image00406.jpeg" alt="Composite component with self-generating tag" class="calibre10"/></div><p class="calibre11"> </p></div></div>
<div class="book" title="Summary" id="aid-1KEEU1"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch05lvl1sec48" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">We made tremendous strides in this chapter towards a working application by examining a popular and contemporary business model. We looked at how conversational scope could help drive an instant secure lending application. Conversation scope allows us to easily write the customer journey and the wizard form that takes the user gradually through a process. Conversation scope ensures that data is stored over a lifecycle between the request and the session scopes.</p><p class="calibre7">We talked very briefly about a useful design pattern called Entity-Control-Boundary. It was revealed how this pattern is similar to the MVC pattern.</p><p class="calibre7">Along the way, we saw a JavaScript module that linked an HTML5 range component together with a Bootstrap CSS Progress element. We studied how JSF provides AJAX with partial updates of a view. We also learnt that we could replace static singleton classes with the CDI application-scoped POJOs.</p><p class="calibre7">Finally, we took a deep dive into custom composite components. We now know how to write a section banner component and even provide information about the Java EE security principal to a page view. JSF 2.2 is definitely a fun standard to play with. I think by now you agree that it fits the modern web architecture very well.</p><p class="calibre7">In the next chapter, we will look at Faces Flow.</p></div>
<div class="book" title="Exercises" id="aid-1LCVG1"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch05lvl1sec49" class="calibre1"/>Exercises</h1></div></div></div><div class="book"><ol class="orderedlist"><li class="listitem">Describe, in simple steps, the digital customer journey for change of address for your local bank. You might start with the identification step first. Don't be tempted to drill down deep into banking security; instead remain at the altitude of 30,000 features, and list or tabulate steps on what you might expect to see.</li><li class="listitem">At this stage of the study, you need to know how to persist data to a backing store. If you haven't done so already, revise your favorite persistence layer, be it JPA, Hibernate, Mongo DB, or something else. Do you know how to retrieve, save, amend, and remove entities from your persistence store?</li><li class="listitem">Copy and rename the blank application, and write a simple conversational scope bean that captures web comments like a guest book.</li><li class="listitem">Ensure that your backing bean uses <code class="email">@ConversationScoped</code>. What happens to the guest book before a conversation starts? Is the information retained? (A guest book in the early digital stage was a very simple web application that allowed an Internet user to write a comment on a web page. The list of comments would grow and grow until the machine restarted or crashed. Nowadays nobody would write such a professional application and deploy it on a website.)</li><li class="listitem">Open another browser and point it to the same guest book application. Do you see the same guest entries as before or afterwards?</li><li class="listitem">Let's return to the Hobby Book Club application that you have been building through the previous chapters. We will add to it now by allowing books to be reviewed as a conversation. We'll keep it simple with user stories:<div class="book"><ul class="itemizedlist1"><li class="listitem">As a reviewer, I want to be able to add my book reviews to the club's website</li><li class="listitem">As a reviewer, I want to see other people's reviews of the books including my own</li><li class="listitem">As a reviewer, I want to edit any reviews</li><li class="listitem">As a reviewer, I want to delete any reviews</li></ul></div></li><li class="listitem">Write a <code class="email">@ConversationScoped</code> backing bean that handles the customer journey of adding a book review, amending, and removing it. To break this task down to easier milestones, you might prefer to first store the data records using the basic Java collection, without persistence into memory. After building the functionality, you can use a real database.</li><li class="listitem">The Conversation scope is ideal for data-capture applications, especially where the user is entering information across several complex sections. Consider a business website that captures résumés (curriculum vitaes): CV Entry Application. Write the output of the customer journey, given the following sections:<div class="book"><ul class="itemizedlist1"><li class="listitem">Personal information (full name, qualification)</li><li class="listitem">Address (home address, e-mail, and phone numbers)</li><li class="listitem">Skills matrix (professional industry skills)</li><li class="listitem">Work experience (places of employment)</li><li class="listitem">Achievements (awards)</li><li class="listitem">Education (education)</li></ul></div></li><li class="listitem">Map out the customer journey for the CV Entry Application. Build a website project using <code class="email">@ConversationScoped</code> that captures this information. Apply the KISS (Keep It Simple Stupid) principle. You only need to demonstrate the conversation state across multiple pages and not build a complete professional application.</li><li class="listitem">In the CV Entry Application, have you taken care of tracking the user journey in the page views? How does the user know where he or she is in the process? Write a custom component that enables this UX feature.</li><li class="listitem">What is the difference between a custom component and a composite component? Do any of these component types require backing beans?</li><li class="listitem">In the CV Entry Application, there are probably other areas where content reuse can be applied. Write a composite component that captures the skill set entry. You probably require a collection: <code class="email">Collection&lt;SkillSet&gt;</code>, where the SkillSet entity has the properties: <code class="email">title (String)</code>, <code class="email">description (String)</code>, and <code class="email">years or months of experience (Integer)</code>. How did you organize the data structure so that the order of the skills presented remain exactly the same as the user entered them? Is this an embellishment for an advanced skill-set a CRUD by itself?</li></ol><div class="calibre25"/></div></div></body></html>