<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Publishing to a Maven Repository" id="aid-12AK81"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Publishing to a Maven Repository</h1></div></div></div><p>In the previous chapter, you learned how to use the <code class="literal">Upload</code> task to publish your project artifacts. In this chapter, you will learn more about the new and still-developing feature of publishing your artifacts to a Maven repository.</p><p>You will learn about the new publishing mechanism in Gradle. This feature is currently still under development, and that means the implementation might change in the future. But for now, this way of publishing artifacts will be the default.</p><div class="section" title="Defining publication"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec30"/>Defining publication</h1></div></div></div><p>We must add the <a id="id187" class="indexterm"/>
<code class="literal">maven-publish</code> plugin to our project to add the new publication feature of Gradle. The plugin allows us to define and deploy our project artifacts in the Maven format. This means our deployed project can be used by other developers and projects that support the Maven format. For example, other projects could use Gradle or Maven and define a dependency to our published artifacts.</p><p>The <code class="literal">maven-publish</code> plugin is based on a general <code class="literal">publishing</code> plugin. The <code class="literal">publishing</code> plugin adds a new <code class="literal">publishing</code> extension to our project. We can use a <code class="literal">publications</code> configuration block in our build script to configure the artifacts we want to publish and the repositories we want to deploy to. The <code class="literal">publications</code> extension has the <code class="literal">PublishingExtension</code> type in the <code class="literal">org.gradle.api.publish</code> package. The plugin also adds the general life cycle <code class="literal">publish</code> task to the project. Other tasks can be added as task dependencies to this task; thus, with a single <code class="literal">publish</code> task, all the publications in the project can be published.</p><p>The <code class="literal">maven-publish</code> plugins also add extra task rules to the project. There is a task to generate a Maven POM file for each publication in the project. The plugins also add a new task rule to publish each publication to the local Maven repository. Finally, a task rule is added based on a combination of the publication and the repository, to publish a publication to the specified repository.</p><p>Let's create an example build file and apply the <code class="literal">maven-publish</code> plugin to see the new task:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'</pre></div><p>Now, we will invoke the <code class="literal">tasks</code> task from the command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ gradle tasks</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Publishing tasks</strong></span>
<span class="strong"><strong>----------------</strong></span>
<span class="strong"><strong>publish - Publishes all publications produced by this project.</strong></span>
<span class="strong"><strong>publishToMavenLocal - Publishes all Maven publications produced by this project to the local Maven cache.</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>BUILD SUCCESSFUL</strong></span>

<span class="strong"><strong>Total time: 4.647 secs</strong></span>
</pre></div><p>We can see the <code class="literal">publish</code> <a id="id188" class="indexterm"/>and <code class="literal">publishToMavenLocal</code> tasks in the output. The dynamic task rules for publishing single publications to repositories are not shown.</p><p>To configure our publications, we must first add a <code class="literal">publishing</code> configuration block. Inside the block, we define the <code class="literal">publications</code> configuration block. In this block, we define a publication. A publication defines what needs to be published. The <code class="literal">maven-publish</code> plugin expects a publication to have the <code class="literal">MavenPublication</code> type found in the <code class="literal">org.gradle.api.publish.maven</code> package. Besides the artifacts that need to be published, we can also define details for the generated POM file.</p></div></div>
<div class="section" title="Defining publication artifacts" id="aid-1394Q1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec31"/>Defining publication artifacts</h1></div></div></div><p>Any publication we define must <a id="id189" class="indexterm"/>have a unique name in our project. We can add multiple publications with their own names inside a <code class="literal">publications</code> configuration block. To add an artifact, we can use the <code class="literal">artifact</code> method in the publication definition. We can also use the <code class="literal">artifacts</code> property to directly set all artifacts.</p><p>We can define artifacts with the <code class="literal">artifact</code> method in the following ways:</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Type</p>
</th><th valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td valign="top">
<p>
<code class="literal">AbstractArchiveTask</code>
</p>
</td><td valign="top">
<p>The information for the artifact is extracted from the archive task. The artifact is an instance of <code class="literal">PublishArtifact</code> in the <code class="literal">org.gradle.api.artifacts</code> package.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">File</code>
</p>
</td><td valign="top">
<p>The information for the artifact is extracted from the filename.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">Map</code>
</p>
</td><td valign="top">
<p>This is another way to define artifacts. The map must contain a <code class="literal">source</code> key referencing a file or archive task. The other properties we can use to further configure the artifact are <code class="literal">classifier</code> and <code class="literal">extension</code>.</p>
</td></tr></tbody></table></div></div>
<div class="section" title="Using archive task artifacts" id="aid-147LC1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Using archive task artifacts</h1></div></div></div><p>In the following example <a id="id190" class="indexterm"/>build file, we define a new publication <a id="id191" class="indexterm"/>with the name <code class="literal">publishJar</code>, and we define the output of the <code class="literal">jar</code> archive task as an artifact:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

// Configuration block for publishing
// artifacts from the project.
publishing {

  // Define publications with what
  // needs to be published.
  publications {

    // Name of this publication
    // is publishJar.
    publishJar(MavenPublication) {

      // Use output of jar task
      // as the artifact for
      // the publication.
      artifact jar

      // Alternatively we can use
      // a Map notation:
      // artifact source: jar
    }

  }
}</pre></div><p>Next, we will run the <code class="literal">tasks</code> task and, in the output, we will be able to see newly generated tasks for publishing this publication:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ gradle tasks</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Publishing tasks</strong></span>
<span class="strong"><strong>----------------</strong></span>
<span class="strong"><strong>generatePomFileForPublishJarPublication - Generates the Maven POM file for publication 'publishJar'.</strong></span>
<span class="strong"><strong>publish - Publishes all publications produced by this project.</strong></span>
<span class="strong"><strong>publishPublishJarPublicationToMavenLocal - Publishes Maven publication 'publishJar' to the local Maven repository.</strong></span>
<span class="strong"><strong>publishToMavenLocal - Publishes all Maven publications produced by this project to the local Maven cache.</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>BUILD SUCCESSFUL</strong></span>

<span class="strong"><strong>Total time: 4.215 secs</strong></span>
</pre></div><p>Notice the two extra tasks, <code class="literal">generatePomFileForPublishJarPublication</code> and <code class="literal">publishPublishJarPublicationToMavenLocal</code>. The name of the publication, <code class="literal">publishJar</code>, is used for the two tasks. Gradle uses the <code class="literal">generatePomFileFor&lt;publicationName&gt;Publication</code> pattern for a task to generate a POM for a publication. The <a id="id192" class="indexterm"/>task pattern to publish a publication to the local Maven repository is <code class="literal">publish&lt;publicationName&gt;PublicationToMavenLocal</code>. Later in this chapter, we will see how we can add other repositories. We cannot yet invoke the tasks because we also need to set the <a id="id193" class="indexterm"/>
<code class="literal">group</code> and <code class="literal">version</code> project properties, but we will cover this in the section about generating a POM file. We can now focus on defining the artifacts for a publication in this section.</p><p>We are not restricted to one artifact for a publication; we can add more by invoking the <code class="literal">artifact</code> method multiple times. Or, we can use the <code class="literal">artifacts</code> property to assign multiple artifacts. It is important that each artifact should have unique <code class="literal">classifier</code> and <code class="literal">extension</code> property values for a single publication. Gradle will check this before we can invoke any tasks, so we immediately get an error message when the artifacts don't have a unique combination of <code class="literal">classifier</code> and <code class="literal">extensions</code> property values.</p><p>In the following example build file, we add two extra artifacts to our publication with the <code class="literal">artifact</code> method:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

task sourcesJar(type: Jar) {
  from sourceSets.main.allJava
  classifier = 'sources'
}

task javadocJar(type: Jar) {
  from javadoc
}

publishing {

  publications {

    publishJar(MavenPublication) {

      artifact jar

      artifact sourcesJar

      artifact javadocJar {
        // Each artifact must have
        // a unique classifier.
        // We can set the classifier
        // via the task as in sourcesJar
        // or here in the artifact configuration.
        classifier = 'javadoc'
      }

      // Or with a Map notation we
      // can write:
      // artifact source: javadocJar, classifier: 'javadoc'

    }

  }
}</pre></div><p>Instead of using the <code class="literal">artifact</code> method, we can also use the <code class="literal">artifacts</code> property and assign multiple artifacts. Each of the artifacts we assign must have a unique combination of <code class="literal">classifier</code> and <code class="literal">extension</code> <a id="id194" class="indexterm"/>property values. In the next example build file, we will use the same artifacts as in the previous example but, this time, we <a id="id195" class="indexterm"/>will assign them to the <code class="literal">artifacts</code> property:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

task sourcesJar(type: Jar) {
  from sourceSets.main.allJava
  classifier = 'sources'
}

task javadocJar(type: Jar) {
  from javadoc
  classifier = 'javadoc'
}

publishing {

  publications {

    publishJar(MavenPublication) {

      // Use artifacts property to
      // define the artifacts.
      // The classifier for each of
      // these artifacts must be
      // unique.
      artifacts = [
        jar,
        sourcesJar,
        javaDocJar]

    }

  }
}</pre></div></div>
<div class="section" title="Using file artifacts" id="aid-1565U1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Using file artifacts</h1></div></div></div><p>Instead of an archive <a id="id196" class="indexterm"/>task, we can also use a file as an artifact. Gradle <a id="id197" class="indexterm"/>tries to extract the <code class="literal">extension</code> and <code class="literal">classifier</code> properties from the filename. We can also configure these properties ourselves when we add the file as a publication artifact.</p><p>In the following example build file, we use the <code class="literal">src/files/README</code> and <code class="literal">src/files/COPYRIGHT</code> files as publication artifacts:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'

publishing {
  publications {
    documentation(MavenPublication) {

      // Use file name as a publication artifact.
      artifact 'src/files/README'

      artifact('src/files/COPYRIGHT') {
        // Each file artifact must have a
        // unique classifier and extension.
        classifier = 'metaInformation'
      }

      // Alternative syntax is with
      // the Map notation:
      // artifact source: 'src/files/README'
      // artifact source: 'src/files/COPYRIGHT',
      //          extension: 'metaInformation'

    }
  }
}</pre></div></div>
<div class="section" title="Using software components" id="aid-164MG1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Using software components</h1></div></div></div><p>Besides the <code class="literal">artifact</code> method and the <code class="literal">artifacts</code> property, we can also use the <code class="literal">from</code> method inside a <code class="literal">publications</code> configuration block. We specify <code class="literal">SoftwareComponent</code> for Gradle as an argument to the <code class="literal">from</code> method. The <code class="literal">java</code> plugin adds <code class="literal">SoftwareComponent</code> with the <a id="id198" class="indexterm"/>name <code class="literal">java</code>, and it includes <a id="id199" class="indexterm"/>the <code class="literal">jar</code> artifact and all runtime dependencies. The <code class="literal">war</code> plugin adds the <code class="literal">war</code> artifact as <code class="literal">SoftwareComponent</code>. <code class="literal">SoftwareComponent</code> is a part of the Gradle build model that defines a piece of code that depends on other code or is a dependency for other code.</p><p>In the next example build file, we will apply the <code class="literal">war</code> plugin to our project, which will implicitly add the <code class="literal">java</code> plugin. We also define two publications, each using <code class="literal">SoftwareComponent</code> from both plugins. The following code shows this:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'war'


publishing {

  publications {

    // First publication with
    // the name javaJar, contains
    // the artifact created by the
    // jar task.
    javaJar(MavenPublication) {
      from components.java
    }

    // Second publication with
    // the name webWar, contains
    // the artifact created by
    // the war task.
    webWar(MavenPublication) {
      from components.web
    }

  }

}</pre></div></div>
<div class="section" title="Generating POM files" id="aid-173721"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Generating POM files</h1></div></div></div><p>An important part of a <a id="id200" class="indexterm"/>Maven publication is the POM file. We already saw that Gradle added a <code class="literal">generatePom&lt;publicationName&gt;</code> task to our project. Furthermore, we can define some properties of the POM file inside a publication configuration. Gradle also offers a hook to customize the generated POM file even further.</p><p>Gradle uses the project's <code class="literal">version</code>, <code class="literal">group</code>, and <code class="literal">name</code> properties in the generated POM file. We create a new example build file where we define the project properties so that they are included in the POM file. The following code shows this:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

// Defined project properties, that are
// used in the generated POM file.
// The name of the project is by default
// the directory name, but we can
// change it via a settings.gradle file
// and the rootProject.name property.
version = '2.1.RELEASE'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {
  publications {
    sample(MavenPublication) {
      from components.java
    }
  }
}</pre></div><p>Now we execute the <code class="literal">generatePomFileForSamplePublication</code> task. The <code class="literal">pom-default.xml</code> file is created in the <code class="literal">build/publications/sample</code> directory. If we open the file, we can see that the <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and <code class="literal">version</code> elements are filled with the values from our <a id="id201" class="indexterm"/>Gradle build file. This is shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" 
    &gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;book.gradle&lt;/groupId&gt;
  &lt;artifactId&gt;sample&lt;/artifactId&gt;
  &lt;version&gt;2.1.RELEASE&lt;/version&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
      &lt;version&gt;4.1.4.RELEASE&lt;/version&gt;
      &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/project&gt;</pre></div><p>We can override the values for <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and <code class="literal">version</code> inside a publication configuration. We use the <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and <code class="literal">version</code> properties to set values other than the default values taken from the project properties. In the next example build file, we will use these methods to set the values:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.DEVELOPMENT'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {
  publications {
    sample(MavenPublication) {
      groupId = 'book.sample.gradle'
      artifactId ='bookSample'
      version = '2.1'

      from components.java
    }
  }
}</pre></div><p>Upon executing the <code class="literal">generatePomFileForSamplePublication</code> task again, we can see the new values in the <a id="id202" class="indexterm"/>generated POM file. The following code shows this:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" 
    &gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;book.sample.gradle&lt;/groupId&gt;
  &lt;artifactId&gt;bookSample&lt;/artifactId&gt;
  &lt;version&gt;2.1&lt;/version&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
      &lt;version&gt;4.1.4.RELEASE&lt;/version&gt;
      &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/project&gt;</pre></div><p>You may already have noticed that the <code class="literal">generatePomFile&lt;publicationName&gt;Publication</code> task also added a <code class="literal">dependencies</code> element in the generated POM file. The dependencies of our project are added as runtime dependencies in the POM file. This happens because we use the <code class="literal">from</code> method with the <code class="literal">components.java</code> value inside our publication configuration. The Java software component not only adds the <code class="literal">jar</code> archive tasks as an artifact, but also turns the project dependencies in to Maven runtime dependencies. If we use an archive task to define an artifact, the <code class="literal">dependencies</code> element is not added to the POM file.</p><p>In the following example <a id="id203" class="indexterm"/>build file, we use the <code class="literal">artifact</code> method to define the publication:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

// Defined project properties, that are
// used in the generated POM file.
// The name of the project is by default
// the directory name, but we can
// change it via a settings.gradle file
// and the rootProject.name property.
version = '2.1.RELEASE'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {
  publications {
    sample(MavenPublication) {
      artifact jar
    }
  }
}</pre></div><p>When we run the <code class="literal">generatePomFileForSamplePublication</code> task from the command line, the POM file is generated. The contents of the POM file are now as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" 
    &gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;book.gradle&lt;/groupId&gt;
  &lt;artifactId&gt;sample&lt;/artifactId&gt;
  &lt;version&gt;2.1.RELEASE&lt;/version&gt;
&lt;/project&gt;</pre></div><p>In the next section, we will learn how we can customize the POM file using a hook. We can then, for example, also <a id="id204" class="indexterm"/>change the Maven dependency scope for our project dependencies.</p><div class="section" title="Customizing the POM file"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec36"/>Customizing the POM file</h2></div></div></div><p>To add some extra <a id="id205" class="indexterm"/>elements to the generated POM file, we must use the <code class="literal">pom</code> property that is a part of <code class="literal">MavenPublication</code>. This returns a <code class="literal">MavenPom</code> object, and we can invoke the <code class="literal">withXml</code> method from this object to add extra elements to the POM file. We will use a closure with the <code class="literal">withXml</code> method to access an <code class="literal">XmlProvider</code> object. With the <code class="literal">XmlProvider</code> object, we can get a reference to a DOM element with the <code class="literal">asElement</code> method, a Groovy node object with the <code class="literal">asNode</code> method, or the <code class="literal">StringBuilder</code> object with the <code class="literal">asString</code> method to extend the POM XML.</p><p>In the following example build file, we add the <code class="literal">organization</code> and <code class="literal">issueMangement</code> elements to the generated POM file:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.RELEASE'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {
  publications {
    sample(MavenPublication) {
      from components.java

      pom.withXml {

        asNode()
          .appendNode('organization')
          .with {
            appendNode('name', 'Gradle')
            appendNode('url', 'http://www.gradle.org')
        }

        asNode()
          .appendNode('issueManagement')
          .with {
            appendNode('system', 'Jenkins')
            appendNode('url', 'http://buildserver/')
          }
      }
    }
  }
}</pre></div><p>If we generate the <a id="id206" class="indexterm"/>POM file, we can see our newly created elements in the XML version. This is shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" &gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;book.gradle&lt;/groupId&gt;
  &lt;artifactId&gt;sample&lt;/artifactId&gt;
  &lt;version&gt;2.1.RELEASE&lt;/version&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
      &lt;version&gt;4.1.4.RELEASE&lt;/version&gt;
      &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
  &lt;organization&gt;
    &lt;name&gt;Gradle&lt;/name&gt;
    &lt;url&gt;http://www.gradle.org&lt;/url&gt;
  &lt;/organization&gt;
  &lt;issueManagement&gt;
    &lt;system&gt;Jenkins&lt;/system&gt;
    &lt;url&gt;http://buildserver/&lt;/url&gt;
  &lt;/issueManagement&gt;
&lt;/project&gt;</pre></div><p>In the previous section, we already learned that, if we use the <code class="literal">from</code> method with the <code class="literal">components.java</code> value, all project dependencies are added as runtime dependencies in the generated POM file. This might always not be what we want. Using the <code class="literal">withXml</code> method, not only can we add new elements, we can also change values.</p><p>Let's add a hook where we change the runtime scope for dependencies to compile the scope. In the next build file, we <a id="id207" class="indexterm"/>will implement this:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.RELEASE'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {
  publications {
    sample(MavenPublication) {
      from components.java

      pom.withXml {
        asNode()
          .dependencies
          .dependency
          .findAll { dependency -&gt;
            // Find all with scope runtime.
            // Could be more specific if we would
            // have more dependencies. For example
            // check group, name and version.
            dependency.scope.text() == 'runtime'
          }
          .each { dependency -&gt;
            // Set scope value to compile.
            dependency.scope*.value = 'compile'
          }
      }
    }
  }
}</pre></div><p>The generated POM file now has the following contents:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" &gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;book.gradle&lt;/groupId&gt;
  &lt;artifactId&gt;sample&lt;/artifactId&gt;
  &lt;version&gt;2.1.RELEASE&lt;/version&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
      &lt;version&gt;4.1.4.RELEASE&lt;/version&gt;
      &lt;scope&gt;compile&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/project&gt;</pre></div><p>Another solution would be to configure the publication, not with the <code class="literal">from</code> method but with the <code class="literal">artifact</code> method. Then, <code class="literal">dependencies</code> is not added to the POM file because Gradle cannot determine the <a id="id208" class="indexterm"/>dependencies for an artifact. Using the <code class="literal">withXml</code> method, we can add it ourselves based on the project dependencies.</p><p>In the following example build file, this solution is implemented:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.RELEASE'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {
  publications {
    sample(MavenPublication) {
      artifact jar

      pom.withXml {
        // Create dependencies element.
        def dependencies =
          asNode()
            .appendNode('dependencies')

        project
          .configurations['compile']
          .allDependencies
          ?.each { dependency -&gt;

            // Add a dependency element with
            // groupId, artifactId, version and scope,
            // to the dependencies element.
            dependencies.appendNode('dependency').with {
              appendNode('groupId', dependency.group)
              appendNode('artifactId', dependency.name)
              appendNode('version', dependency.version)
              appendNode('scope', 'compile')
            }

          }
      }
    }
  }
}</pre></div><p>When we invoke the <a id="id209" class="indexterm"/>
<code class="literal">generatePomFileForSamplePublication</code> task, we get the following POM file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" &gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;book.gradle&lt;/groupId&gt;
  &lt;artifactId&gt;sample&lt;/artifactId&gt;
  &lt;version&gt;2.1.RELEASE&lt;/version&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
      &lt;version&gt;4.1.4.RELEASE&lt;/version&gt;
      &lt;scope&gt;compile&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/project&gt;</pre></div></div></div>
<div class="section" title="Defining repositories"><div class="titlepage" id="aid-181NK2"><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Defining repositories</h1></div></div></div><p>We must configure a Maven <a id="id210" class="indexterm"/>repository to publish our configured publication. We can choose a local directory or a repository manager, such as Artifactory or Nexus. Gradle also adds support installing the publication to our local Maven repository.</p><div class="section" title="Publishing to the local Maven repository"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec37"/>Publishing to the local Maven repository</h2></div></div></div><p>Gradle already adds our local <a id="id211" class="indexterm"/>Maven repository as a destination for our publications. For each named publication, there is a <code class="literal">publish&lt;publicationName&gt;ToMavenLocal</code> task. Gradle also creates the <code class="literal">publishToMavenLocal</code> <a id="id212" class="indexterm"/>task, which will publish all publications to the local Maven repository.</p><p>We have the following example build file:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.DEVELOPMENT'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {

  publications {
    publishJar(MavenPublication) {
      artifactId = 'sample'

      from components.java
    }
  }

}</pre></div><p>From the command line, we will run the <code class="literal">publishToMavenLocal</code> task and see which tasks are executed:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ gradle publishToMavenLocal</strong></span>
<span class="strong"><strong>:generatePomFileForPublishJarPublication</strong></span>
<span class="strong"><strong>:compileJava</strong></span>
<span class="strong"><strong>:processResources UP-TO-DATE</strong></span>
<span class="strong"><strong>:classes</strong></span>
<span class="strong"><strong>:jar</strong></span>
<span class="strong"><strong>:publishPublishJarPublicationToMavenLocal</strong></span>
<span class="strong"><strong>:publishToMavenLocal</strong></span>

<span class="strong"><strong>BUILD SUCCESSFUL</strong></span>

<span class="strong"><strong>Total time: 5.135 secs</strong></span>
</pre></div><p>You may have noticed that first the publication artifact is created with the <code class="literal">jar</code> task and its task dependencies. Also, the POM file is generated, and our publication is copied to the <a id="id213" class="indexterm"/>local Maven repository via the <code class="literal">publishPublishJarPublicationToMavenLocal</code> task, which is a task dependency <a id="id214" class="indexterm"/>for <code class="literal">publishToMavenLocal</code>.</p><p>When we look at the local Maven repository directory, we see that our project artifact is published:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>/Users/mrhaki/.m2/repository/</strong></span>
<span class="strong"><strong>book</strong></span>
<span class="strong"><strong>└── gradle</strong></span>
<span class="strong"><strong>    └── sample</strong></span>
<span class="strong"><strong>        ├── 2.1.RELEASE</strong></span>
<span class="strong"><strong>        │   ├── sample-2.1.RELEASE.jar</strong></span>
<span class="strong"><strong>        │   └── sample-2.1.RELEASE.pom</strong></span>
<span class="strong"><strong>        └── maven-metadata-local.xml</strong></span>
</pre></div></div><div class="section" title="Publishing to the Maven repository"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Publishing to the Maven repository</h2></div></div></div><p>If we have our own <a id="id215" class="indexterm"/>company's Maven repository or a directory where we want to publish our publications, then we must add it to the <code class="literal">publishing</code> configuration block. Inside the block, we can add the <code class="literal">repositories</code> configuration block containing one or more named repositories. For the combination of each <a id="id216" class="indexterm"/>publication and repository, Gradle creates a task with the <code class="literal">publish&lt;publicationName&gt;To&lt;repositoryName&gt;Repository</code> name pattern.</p><p>Next, we will define a simple directory repository in the next example build file with the name <code class="literal">localRepo</code>:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.DEVELOPMENT'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {

  publications {
    publishJar(MavenPublication) {
      artifactId = 'sample'

      from components.java
    }
  }

  // Add a Maven repository for
  // the publications.
  repositories {
    maven {
      name = 'localRepo'
      url = "$buildDir/localRepo"
    }
  }
}</pre></div><p>First, we will run the <a id="id217" class="indexterm"/>
<code class="literal">tasks</code> task to see which task is <a id="id218" class="indexterm"/>added to the <code class="literal">Publishing tasks</code> group:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ gradle tasks</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Publishing tasks</strong></span>
<span class="strong"><strong>----------------</strong></span>
<span class="strong"><strong>generatePomFileForPublishJarPublication - Generates the Maven POM file for publication 'publishJar'.</strong></span>
<span class="strong"><strong>publish - Publishes all publications produced by this project.</strong></span>
<span class="strong"><strong>publishPublishJarPublicationToLocalRepoRepository - Publishes Maven publication 'publishJar' to Maven repository 'localRepo'.</strong></span>
<span class="strong"><strong>publishPublishJarPublicationToMavenLocal - Publishes Maven publication 'publishJar' to the local Maven repository.</strong></span>
<span class="strong"><strong>publishToMavenLocal - Publishes all Maven publications produced by this project to the local Maven cache.</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>BUILD SUCCESSFUL</strong></span>

<span class="strong"><strong>Total time: 4.514 secs</strong></span>
</pre></div><p>To publish our project's artifact, we can execute the <code class="literal">publishPublishJarPublicationToLocalRepoRepository</code> or <code class="literal">publish</code> task. The following output shows the tasks that are executed:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ gradle publish</strong></span>
<span class="strong"><strong>:generatePomFileForPublishJarPublication</strong></span>
<span class="strong"><strong>:compileJava</strong></span>
<span class="strong"><strong>:processResources UP-TO-DATE</strong></span>
<span class="strong"><strong>:classes</strong></span>
<span class="strong"><strong>:jar</strong></span>
<span class="strong"><strong>:publishPublishJarPublicationToLocalRepoRepository</strong></span>
<span class="strong"><strong>Uploading: book/gradle/sample/2.1.DEVELOPMENT/sample-2.1.DEVELOPMENT.jar to repository remote at file:/Users/mrhaki/Projects/book/sample/build/localRepo/</strong></span>
<span class="strong"><strong>Transferring 2K from remote</strong></span>
<span class="strong"><strong>Uploaded 2K</strong></span>
<span class="strong"><strong>:publish</strong></span>

<span class="strong"><strong>BUILD SUCCESSFUL</strong></span>

<span class="strong"><strong>Total time: 5.012 secs</strong></span>
</pre></div><p>Once the task is <a id="id219" class="indexterm"/>performed, we get the following files in the <a id="id220" class="indexterm"/>
<code class="literal">build/localRepo</code> directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>build/localRepo/</strong></span>
<span class="strong"><strong>└── book</strong></span>
<span class="strong"><strong>    └── gradle</strong></span>
<span class="strong"><strong>        └── sample</strong></span>
<span class="strong"><strong>            ├── 2.1.DEVELOPMENT</strong></span>
<span class="strong"><strong>            │   ├── sample-2.1.DEVELOPMENT.jar</strong></span>
<span class="strong"><strong>            │   ├── sample-2.1.DEVELOPMENT.jar.md5</strong></span>
<span class="strong"><strong>            │   ├── sample-2.1.DEVELOPMENT.jar.sha1</strong></span>
<span class="strong"><strong>            │   ├── sample-2.1.DEVELOPMENT.pom</strong></span>
<span class="strong"><strong>            │   ├── sample-2.1.DEVELOPMENT.pom.md5</strong></span>
<span class="strong"><strong>            │   └── sample-2.1.DEVELOPMENT.pom.sha1</strong></span>
<span class="strong"><strong>            ├── maven-metadata.xml</strong></span>
<span class="strong"><strong>            ├── maven-metadata.xml.md5</strong></span>
<span class="strong"><strong>            └── maven-metadata.xml.sha1</strong></span>
</pre></div></div><div class="section" title="Publishing to Artifactory"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>Publishing to Artifactory</h2></div></div></div><p>To publish our publications <a id="id221" class="indexterm"/>to an Artifactory repository with a Maven layout, we only have to configure the repository in the <code class="literal">publications.repositories</code> configuration block. We can set the <code class="literal">url</code> property, a <code class="literal">name</code>, and optional <a id="id222" class="indexterm"/>security credentials.</p><p>In the next example build file, we use an Artifactory repository to which we publish the publication:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.DEVELOPMENT'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {

  publications {
    publishJar(MavenPublication) {
      artifactId = 'sample'

      from components.java
    }
  }

  // Add a Artifactory repository for
  // the publications with Maven layout.
  repositories {
    maven {
      name = 'artifactory'
      url = "http://localhost:8081/artifactory/libs-release-local"

      // Username and password should be
      // saved outside build file in
      // real life, eg. in gradle.properties
      // or passed via command line as 
      // project properties. 
      credentials {
        username = 'user'
        password = 'passw0rd'
      }
    }
  }
}</pre></div><p>Gradle creates a new <code class="literal">publishPublishJarPublicationToArtifactoryRepository</code> task based on the <a id="id223" class="indexterm"/>publication name and the repository name. When we invoke the task, we can see that the publication is deployed to the Artifactory <a id="id224" class="indexterm"/>repository. The following code shows this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ gradle publishPublishJarPublicationToArtifactoryRepository</strong></span>
<span class="strong"><strong>:generatePomFileForPublishJarPublication</strong></span>
<span class="strong"><strong>:compileJava</strong></span>
<span class="strong"><strong>:processResources UP-TO-DATE</strong></span>
<span class="strong"><strong>:classes</strong></span>
<span class="strong"><strong>:jar</strong></span>
<span class="strong"><strong>:publishPublishJarPublicationToArtifactoryRepository</strong></span>
<span class="strong"><strong>Uploading: book/gradle/sample/2.1.DEVELOPMENT/sample-2.1.DEVELOPMENT.jar to repository remote at http://localhost:8081/artifactory/libs-release-local</strong></span>
<span class="strong"><strong>Transferring 2K from remote</strong></span>
<span class="strong"><strong>Uploaded 2K</strong></span>

<span class="strong"><strong>BUILD SUCCESSFUL</strong></span>

<span class="strong"><strong>Total time: 5.012 secs</strong></span>
</pre></div><p>When we open the Artifactory web application in a web browser, we can see that our project is now part of the repository, as shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00131.jpeg" alt="Publishing to Artifactory"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="Publishing to Nexus"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>Publishing to Nexus</h2></div></div></div><p>Another repository <a id="id225" class="indexterm"/>manager is Nexus. Publishing to a Nexus <a id="id226" class="indexterm"/>repository manager is not much different than publishing to Artifactory or a local directory. We only have to change the <code class="literal">url</code> property to reference the repository and set the optional security credentials.</p><p>In the following example build file, we use a Nexus repository manager:</p><div class="informalexample"><pre class="programlisting">apply plugin: 'maven-publish'
apply plugin: 'java'

version = '2.1.DEVELOPMENT'
group = 'book.gradle'

repositories {
  jcenter()
}

dependencies {
  compile 'org.springframework:spring-context:4.1.4.RELEASE'
}

publishing {

  publications {
    publishJar(MavenPublication) {
      artifactId = 'sample'

      from components.java
    }
  }

  // Add a Maven repository for
  // the publications.
  repositories {
    maven {
      name = 'nexus'
      url = "http://localhost:8081/nexus/content/repositories/releases"
      credentials {
        username = 'admin'
        password = 'admin123'
      }
    }
  }
}</pre></div><p>This time, the <a id="id227" class="indexterm"/>
<code class="literal">publishPublishJarPublicationToNexusRepository</code> task is created. The task is also added as a task <a id="id228" class="indexterm"/>dependency to the <code class="literal">publish</code> task. To accomplish this, use the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ gradle publishPublishJarPublicationToNexusRepository</strong></span>
<span class="strong"><strong>:generatePomFileForPublishJarPublication</strong></span>
<span class="strong"><strong>:compileJava</strong></span>
<span class="strong"><strong>:processResources UP-TO-DATE</strong></span>
<span class="strong"><strong>:classes</strong></span>
<span class="strong"><strong>:jar</strong></span>
<span class="strong"><strong>:publishPublishJarPublicationToNexusRepository</strong></span>
<span class="strong"><strong>Uploading: book/gradle/sample/2.1.DEVELOPMENT/sample-2.1.DEVELOPMENT.jar to repository remote at http://localhost:8081/nexus/content/repositories/releases</strong></span>
<span class="strong"><strong>Transferring 2K from remote</strong></span>
<span class="strong"><strong>Uploaded 2K</strong></span>

<span class="strong"><strong>BUILD SUCCESSFUL</strong></span>

<span class="strong"><strong>Total time: 5.012 secs</strong></span>
</pre></div><p>When we take a look with the Nexus web application inside the repository, we can see that our project is <a id="id229" class="indexterm"/>added to the repository, as shown in the <a id="id230" class="indexterm"/>following screenshot:</p><div class="mediaobject"><img src="../Images/image00132.jpeg" alt="Publishing to Nexus"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Summary" id="aid-190861"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Summary</h1></div></div></div><p>In this chapter, you learned how to use the new and developing <code class="literal">maven-publish</code> plugin. You saw how you can declare your publications with the <code class="literal">publications</code> configuration block. Gradle will automatically create new tasks based on what you declared as publications.</p><p>You also learned how to customize the POM file that is generated by the Gradle publishing tasks.</p><p>Finally, you saw how you can configure Maven repositories so you can deploy your publications to them. We configured a local directory, which could also be a network share, and showed you how to configure an Artifactory or Nexus repository manager.</p><p>In the next chapter, you will see how you can upload to Bintray.</p></div></body></html>