<html><head></head><body>
<div id="_idContainer060">
<h1 class="chapter-number" id="_idParaDest-273"><a id="_idTextAnchor272"/><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-274"><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.2.1">Adding Logging and Tracing to Services</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, you will learn about logging and tracing tools. </span><span class="koboSpan" id="kobo.3.2">We will use Spring Micrometer, Brave, the </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Elasticsearch, Logstash, and Kibana</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">ELK</span></strong><span class="koboSpan" id="kobo.7.1">) stack, and Zipkin. </span><span class="koboSpan" id="kobo.7.2">ELK and </span><a id="_idIndexMarker1056"/><span class="koboSpan" id="kobo.8.1">Zipkin will be used to implement </span><a id="_idIndexMarker1057"/><span class="koboSpan" id="kobo.9.1">the distributed logging and tracing of the request/response of API calls. </span><strong class="bold"><span class="koboSpan" id="kobo.10.1">Spring Micrometer</span></strong><span class="koboSpan" id="kobo.11.1"> with </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">Actuator</span></strong><span class="koboSpan" id="kobo.13.1"> will be used to inject tracing </span><a id="_idIndexMarker1058"/><span class="koboSpan" id="kobo.14.1">information into API calls. </span><span class="koboSpan" id="kobo.14.2">You will learn how to publish and analyze the logging and tracing of different requests and logs related </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">to responses.</span></span></p>
<p><span class="koboSpan" id="kobo.16.1">These aggregated logs will help you to troubleshoot web services. </span><span class="koboSpan" id="kobo.16.2">You will call one service (such as the gRPC client), which will then call another service (such as the gRPC server), and link them with a trace identifier. </span><span class="koboSpan" id="kobo.16.3">Then, using this trace identifier, you can search the centralized logs and debug the request flows. </span><span class="koboSpan" id="kobo.16.4">In this chapter, we will use this sample flow. </span><span class="koboSpan" id="kobo.16.5">However, the same tracing can be used when service calls require more internal calls. </span><span class="koboSpan" id="kobo.16.6">You will </span><a id="_idIndexMarker1059"/><span class="koboSpan" id="kobo.17.1">also use </span><strong class="bold"><span class="koboSpan" id="kobo.18.1">Zipkin</span></strong><span class="koboSpan" id="kobo.19.1"> to ascertain the performance of each </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">API call.</span></span></p>
<p><span class="koboSpan" id="kobo.21.1">Then, we will explore logging and monitoring tools, including the ELK stack and Zipkin, using Spring Micrometer. </span><span class="koboSpan" id="kobo.21.2">These tools (ELK and Zipkin) will then be used to implement the distributed logging and tracing of API requests and responses. </span><span class="koboSpan" id="kobo.21.3">Spring Micrometer will be used to inject the tracing information into API calls. </span><span class="koboSpan" id="kobo.21.4">You will learn how to publish and analyze the logging and tracing of different requests and logs related </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">to responses.</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">You will explore the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.25.1">Logging and tracing using the </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">ELK stack</span></span></li>
<li><span class="koboSpan" id="kobo.27.1">Implementing logging and tracing in the </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">gRPC code</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">Distributed tracing with Zipkin </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">and Micrometer</span></span></li>
</ul>
<h1 id="_idParaDest-275"><a id="_idTextAnchor274"/><span class="koboSpan" id="kobo.31.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.32.1">You will need the following to develop and execute the code in </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.34.1">Any </span><a id="_idIndexMarker1060"/><span class="koboSpan" id="kobo.35.1">Java IDE, such as NetBeans, IntelliJ, </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">or Eclipse</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.37.1">Java Development Kit</span></strong><span class="koboSpan" id="kobo.38.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.39.1">JDK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">) </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.41.1">17</span></strong></span></li>
<li><span class="koboSpan" id="kobo.42.1">An internet connection to clone the code and download the dependencies </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">and Gradle</span></span></li>
<li><span class="koboSpan" id="kobo.44.1">Insomnia/cURL (for </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">API testing)</span></span></li>
<li><span class="koboSpan" id="kobo.46.1">Docker and </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">Docker Compose</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.48.1">You can find the code used in this chapter </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12"><span class="No-Break"><span class="koboSpan" id="kobo.50.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.51.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.52.1">So, </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">let’s begin!</span></span></p>
<h1 id="_idParaDest-276"><a id="_idTextAnchor275"/><span class="koboSpan" id="kobo.54.1">Logging and tracing using the ELK stack</span></h1>
<p><span class="koboSpan" id="kobo.55.1">Today, products and services are divided into multiple small parts and executed as separate processes or deployed as separate services, rather than as a monolithic system. </span><span class="koboSpan" id="kobo.55.2">An API call may make several other internal API calls. </span><span class="koboSpan" id="kobo.55.3">Therefore, you need distributed </span><a id="_idIndexMarker1061"/><span class="koboSpan" id="kobo.56.1">and centralized logging to trace a request that spans multiple </span><a id="_idIndexMarker1062"/><span class="koboSpan" id="kobo.57.1">web services. </span><span class="koboSpan" id="kobo.57.2">This tracing can be done using the trace identifier (</span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">traceId</span></strong><span class="koboSpan" id="kobo.59.1">), which can also be referred to as a correlation identifier (</span><strong class="source-inline"><span class="koboSpan" id="kobo.60.1">correlationId</span></strong><span class="koboSpan" id="kobo.61.1">). </span><span class="koboSpan" id="kobo.61.2">This identifier is a collection of characters that forms a unique string, which is populated and assigned to an API call that requires multiple inter-service calls. </span><span class="koboSpan" id="kobo.61.3">Then, the same trace identifier is propagated to subsequent API calls for </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">tracking purposes.</span></span></p>
<p><span class="koboSpan" id="kobo.63.1">Errors and issues are imminent in the production system. </span><span class="koboSpan" id="kobo.63.2">You need to carry out debugging to ascertain the root cause. </span><span class="koboSpan" id="kobo.63.3">One of the key tools associated with debugging is logs. </span><span class="koboSpan" id="kobo.63.4">Logs can also give you warnings related to the system if the system is designed to do so. </span><span class="koboSpan" id="kobo.63.5">Logs also offer throughput, capacity, and monitoring of the health of the system. </span><span class="koboSpan" id="kobo.63.6">Therefore, you need an excellent logging platform and strategy that enables </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">effective debugging.</span></span></p>
<p><span class="koboSpan" id="kobo.65.1">There are different open source and enterprise tools available on the market for logging, including Splunk, Graylog, and the ELK stack. </span><span class="koboSpan" id="kobo.65.2">The ELK stack is the most popular of these, and you can </span><a id="_idIndexMarker1063"/><span class="koboSpan" id="kobo.66.1">use it for free if you are not going to provide ELK-based service </span><a id="_idIndexMarker1064"/><span class="koboSpan" id="kobo.67.1">as SaaS. </span><span class="koboSpan" id="kobo.67.2">We are going to use the ELK stack for logging throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.69.1">Let’s understand the ELK stack in the </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">next subsection.</span></span></p>
<h2 id="_idParaDest-277"><a id="_idTextAnchor276"/><span class="koboSpan" id="kobo.71.1">Understanding the ELK stack</span></h2>
<p><span class="koboSpan" id="kobo.72.1">The ELK stack comprises three components – Elasticsearch, Logstash, and Kibana. </span><span class="koboSpan" id="kobo.72.2">All three products </span><a id="_idIndexMarker1065"/><span class="koboSpan" id="kobo.73.1">are part of Elasticsearch B.V. </span><span class="koboSpan" id="kobo.73.2">(</span><a href="https://www.elastic.co/"><span class="koboSpan" id="kobo.74.1">https://www.elastic.co/</span></a><span class="koboSpan" id="kobo.75.1">). </span><span class="koboSpan" id="kobo.75.2">The ELK stack performs the aggregation, analysis, visualization, and monitoring of logs. </span><span class="koboSpan" id="kobo.75.3">The ELK stack provides a complete logging platform that allows you to analyze, visualize, and monitor all types of logs, including product and </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">system logs.</span></span></p>
<p><span class="koboSpan" id="kobo.77.1">You are going to use the following workflow to </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">publish logs:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer049">
<span class="koboSpan" id="kobo.79.1"><img alt="Figure 12.1 – Log flows in the ELK stack" src="image/Figure_12.01_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.80.1">Figure 12.1 – Log flows in the ELK stack</span></p>
<p><span class="koboSpan" id="kobo.81.1">Let’s understand </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">the diagram:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.83.1">Services/system logs are pushed to Logstash on the </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">TCP port</span></span></li>
<li><span class="koboSpan" id="kobo.85.1">Logstash pushes the logs to Elasticsearch </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">for indexing</span></span></li>
<li><span class="koboSpan" id="kobo.87.1">Kibana then uses the Elasticsearch index to query and visualize </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">the logs</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.89.1">In an ideal production system, you should use one more layer. </span><span class="koboSpan" id="kobo.89.2">A broker layer such as Redis, Kafka, or RabbitMQ should be placed between the service logs and Logstash. </span><span class="koboSpan" id="kobo.89.3">This prevents data loss and can handle the sudden spike in </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">input load.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.91.1">Tips for ELK stack configuration</span></p>
<p class="callout"><span class="koboSpan" id="kobo.92.1">The ELK stack is fully customizable and comes with a default configuration. </span><span class="koboSpan" id="kobo.92.2">However, if you are using an Elasticsearch cluster (more than one instance of Elasticsearch is deployed), it is better to use an odd number of Elasticsearch nodes (instances) to avoid the </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">split-brain problem.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.94.1">It is recommended to use the appropriate data type for all the fields (input in JSON format for the logs). </span><span class="koboSpan" id="kobo.94.2">This will allow you to perform logical checks and comparisons while querying the log data. </span><span class="koboSpan" id="kobo.94.3">For example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">http_status &lt; 400</span></strong><span class="koboSpan" id="kobo.96.1"> check would work only if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">http_status</span></strong><span class="koboSpan" id="kobo.98.1"> field type is a number and may fail if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">http_status</span></strong><span class="koboSpan" id="kobo.100.1"> field type is </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">a string.</span></span></p>
<p><span class="koboSpan" id="kobo.102.1">If you are </span><a id="_idIndexMarker1066"/><span class="koboSpan" id="kobo.103.1">already familiar with the ELK stack, you can skip this introduction and move on to the next section. </span><span class="koboSpan" id="kobo.103.2">Here, you’ll find a brief introduction to each of the tools in the </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">ELK stack.</span></span></p>
<h3><span class="koboSpan" id="kobo.105.1">Elasticsearch</span></h3>
<p><span class="koboSpan" id="kobo.106.1">Elasticsearch is one of the most popular enterprise full-text search engines. </span><span class="koboSpan" id="kobo.106.2">It is based on Apache Lucene and developed using Java. </span><span class="koboSpan" id="kobo.106.3">Elasticsearch is also a high-performance, full-featured </span><a id="_idIndexMarker1067"/><span class="koboSpan" id="kobo.107.1">text search engine library. </span><span class="koboSpan" id="kobo.107.2">Recent changes in the licensing terms have made it restricted open source software, which prevents you from offering </span><a id="_idIndexMarker1068"/><span class="koboSpan" id="kobo.108.1">Elasticsearch or the ELK stack as SaaS. </span><span class="koboSpan" id="kobo.108.2">It is distributable and supports multi-tenancy. </span><span class="koboSpan" id="kobo.108.3">A single Elasticsearch server stores multiple indexes (each index represents a database), and a single query can search the data of multiple indexes. </span><span class="koboSpan" id="kobo.108.4">It is a distributed search engine and </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">supports clustering.</span></span></p>
<p><span class="koboSpan" id="kobo.110.1">It is readily scalable and can provide near-real-time searches with a latency of one second. </span><span class="koboSpan" id="kobo.110.2">Elasticsearch APIs are extensive and very elaborate. </span><span class="koboSpan" id="kobo.110.3">Elasticsearch provides JSON-based schema-less storage and represents data models in JSON. </span><span class="koboSpan" id="kobo.110.4">Elasticsearch APIs use JSON documents for HTTP requests </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">and responses.</span></span></p>
<h3><span class="koboSpan" id="kobo.112.1">Logstash</span></h3>
<p><span class="koboSpan" id="kobo.113.1">Logstash is </span><a id="_idIndexMarker1069"/><span class="koboSpan" id="kobo.114.1">an open source data collection engine with real-time pipeline </span><a id="_idIndexMarker1070"/><span class="koboSpan" id="kobo.115.1">capabilities. </span><span class="koboSpan" id="kobo.115.2">It performs three major operations – it collects the data, filters the information, and outputs the processed information to data storage, in the same way as Elasticsearch does. </span><span class="koboSpan" id="kobo.115.3">It allows you to process any event data, such as logs from a variety of systems, because of its data </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">pipeline capabilities.</span></span></p>
<p><span class="koboSpan" id="kobo.117.1">Logstash runs </span><a id="_idIndexMarker1071"/><span class="koboSpan" id="kobo.118.1">as an agent that collects the data, parses it, filters it, and sends the </span><a id="_idIndexMarker1072"/><span class="koboSpan" id="kobo.119.1">output to a designated data store, such as Elasticsearch, or as simple standard output on </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">a console.</span></span></p>
<p><span class="koboSpan" id="kobo.121.1">On top of that, it has a rich set </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">of plugins.</span></span></p>
<h3><span class="koboSpan" id="kobo.123.1">Kibana</span></h3>
<p><span class="koboSpan" id="kobo.124.1">Kibana is an </span><a id="_idIndexMarker1073"/><span class="koboSpan" id="kobo.125.1">open source web application that is used for visualizing and performing information analytics. </span><span class="koboSpan" id="kobo.125.2">It interacts with Elasticsearch and provides easy </span><a id="_idIndexMarker1074"/><span class="koboSpan" id="kobo.126.1">integration with it. </span><span class="koboSpan" id="kobo.126.2">You can perform searching and display and interact with the information stored in </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">Elasticsearch indices.</span></span></p>
<p><span class="koboSpan" id="kobo.128.1">It is a browser-based web application that lets you perform advanced data analysis and visualize your data in a variety of charts, tables, and maps. </span><span class="koboSpan" id="kobo.128.2">Moreover, it is a zero-configuration application. </span><span class="koboSpan" id="kobo.128.3">Therefore, it does not require any coding or additional infrastructure </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">following installation.</span></span></p>
<p><span class="koboSpan" id="kobo.130.1">Next, let’s learn how to install the </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">ELK stack.</span></span></p>
<h1 id="_idParaDest-278"><a id="_idTextAnchor277"/><span class="koboSpan" id="kobo.132.1">Installing the ELK stack</span></h1>
<p><span class="koboSpan" id="kobo.133.1">You can use various methods to install the ELK stack, such as installing individual components </span><a id="_idIndexMarker1075"/><span class="koboSpan" id="kobo.134.1">as per the operating system, downloading the Docker images and running them individually, or executing the Docker images using Docker Compose, Docker Swarm, or Kubernetes. </span><span class="koboSpan" id="kobo.134.2">You are going to use Docker Compose in </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.136.1">Let’s understand the grammar of a Docker Compose file before we create the ELK stack Docker Compose file. </span><span class="koboSpan" id="kobo.136.2">A Docker Compose file is defined using YAML. </span><span class="koboSpan" id="kobo.136.3">The file contains four important </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">top-level keys:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">version</span></strong><span class="koboSpan" id="kobo.139.1">: This denotes </span><a id="_idIndexMarker1076"/><span class="koboSpan" id="kobo.140.1">the version of the Docker Compose file format. </span><span class="koboSpan" id="kobo.140.2">You can use the appropriate version based on the installed Docker Engine. </span><span class="koboSpan" id="kobo.140.3">You can check </span><a href="https://docs.docker.com/compose/compose-file/"><span class="koboSpan" id="kobo.141.1">https://docs.docker.com/compose/compose-file/</span></a><span class="koboSpan" id="kobo.142.1"> to ascertain the mapping between the Docker Compose file version and the Docker </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">Engine version.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">services</span></strong><span class="koboSpan" id="kobo.145.1">: This contains </span><a id="_idIndexMarker1077"/><span class="koboSpan" id="kobo.146.1">one or more service definitions. </span><span class="koboSpan" id="kobo.146.2">The service definition represents the service executed by the container and contains the container name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">container_name</span></strong><span class="koboSpan" id="kobo.148.1">), Docker image (</span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">image</span></strong><span class="koboSpan" id="kobo.150.1">), environment variables (</span><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">environment</span></strong><span class="koboSpan" id="kobo.152.1">), external and internal ports (</span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">port</span></strong><span class="koboSpan" id="kobo.154.1">), the command to be executed when running the container (</span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">command</span></strong><span class="koboSpan" id="kobo.156.1">), the network to be used for communicating with other services (</span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">networks</span></strong><span class="koboSpan" id="kobo.158.1">), mapping of the host filesystem with a running container (</span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">volume</span></strong><span class="koboSpan" id="kobo.160.1">), and the container to be executed once the dependent service has </span><span class="No-Break"><span class="koboSpan" id="kobo.161.1">started (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">depends_on</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">).</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">networks</span></strong><span class="koboSpan" id="kobo.165.1">: This represents the (top-level) named network that needs to be created to </span><a id="_idIndexMarker1078"/><span class="koboSpan" id="kobo.166.1">establish a communication channel among the defined services. </span><span class="koboSpan" id="kobo.166.2">Then, this network is used by the service to communicate based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">networks</span></strong><span class="koboSpan" id="kobo.168.1"> key of the defined service. </span><span class="koboSpan" id="kobo.168.2">The top-level network key contains the driver field, which can be </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">bridge</span></strong><span class="koboSpan" id="kobo.170.1"> for a single host and </span><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">overlay</span></strong><span class="koboSpan" id="kobo.172.1"> when used in Docker Swarm. </span><span class="koboSpan" id="kobo.172.2">We will </span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">use </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">bridge</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">volumes</span></strong><span class="koboSpan" id="kobo.177.1">: A top-level </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">volumes</span></strong><span class="koboSpan" id="kobo.179.1"> key is used to create the named volume that mounts the </span><a id="_idIndexMarker1079"/><span class="koboSpan" id="kobo.180.1">host path. </span><span class="koboSpan" id="kobo.180.2">Make sure to use it only if required by the multiple services; otherwise, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">volumes</span></strong><span class="koboSpan" id="kobo.182.1"> key inside the service definition, which would </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">be service-specific.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.184.1">Now, let’s create </span><a id="_idIndexMarker1080"/><span class="koboSpan" id="kobo.185.1">the Docker Compose file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">docker-compose.yaml</span></strong><span class="koboSpan" id="kobo.187.1">, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">Chapter12</span></strong><span class="koboSpan" id="kobo.189.1"> directory to define the ELK stack. </span><span class="koboSpan" id="kobo.189.2">Then, you can add the following code to </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">this file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.191.1">
version: "3.2"services:
  </span><strong class="bold"><span class="koboSpan" id="kobo.192.1">elasticsearch:</span></strong><span class="koboSpan" id="kobo.193.1">
    container_name: </span><strong class="bold"><span class="koboSpan" id="kobo.194.1">es-container</span></strong><span class="koboSpan" id="kobo.195.1">
    image: docker.elastic.co/elasticsearch/
        </span><strong class="bold"><span class="koboSpan" id="kobo.196.1">elasticsearch:8.7.0</span></strong><span class="koboSpan" id="kobo.197.1">
    environment:
      - xpack.security.enabled=false
      - "discovery.type=single-node"
    networks:
      - </span><strong class="bold"><span class="koboSpan" id="kobo.198.1">elk-net</span></strong><span class="koboSpan" id="kobo.199.1">
    ports:
      - </span><strong class="bold"><span class="koboSpan" id="kobo.200.1">19200:9200</span></strong></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/docker-compose.yaml"><span class="No-Break"><span class="koboSpan" id="kobo.201.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/docker-compose.yaml</span></span></a></p>
<p><span class="koboSpan" id="kobo.202.1">First, we defined the version of the Docker Compose file. </span><span class="koboSpan" id="kobo.202.2">Then, we created the </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">services</span></strong><span class="koboSpan" id="kobo.204.1"> key section, which contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">elasticsearch</span></strong><span class="koboSpan" id="kobo.206.1"> service. </span><span class="koboSpan" id="kobo.206.2">The service contains the </span><a id="_idIndexMarker1081"/><span class="koboSpan" id="kobo.207.1">container name, Docker image, environment variables, and network (because you want ELK components to communicate with one another). </span><span class="koboSpan" id="kobo.207.2">Finally, ports are defined in </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">external:internal</span></strong><span class="koboSpan" id="kobo.209.1"> format. </span><span class="koboSpan" id="kobo.209.2">You are going to use port </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">19200</span></strong><span class="koboSpan" id="kobo.211.1"> from the browser to access it. </span><span class="koboSpan" id="kobo.211.2">However, other services will use port </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">9200</span></strong><span class="koboSpan" id="kobo.213.1"> for communicating </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">with Elasticsearch.</span></span></p>
<p><span class="koboSpan" id="kobo.215.1">Similarly, you can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">logstash</span></strong><span class="koboSpan" id="kobo.217.1"> service next, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.219.1">
  logstash:    container_name: ls-container
    image: docker.elastic.co/logstash/logstash:8.7.0
    environment:
      - xpack.security.enabled=false
    command: logstash -e </span><strong class="bold"><span class="koboSpan" id="kobo.220.1">'input { tcp { port =&gt; 5001 codec</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.221.1">     =&gt;</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.222.1">"json" }} output { elasticsearch { hosts =&gt;</span></strong><span class="koboSpan" id="kobo.223.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.224.1">"elasticsearch:9200" index =&gt; "modern-api" }}'</span></strong><span class="koboSpan" id="kobo.225.1">
    networks:
      - elk-net
    </span><strong class="bold"><span class="koboSpan" id="kobo.226.1">depends_on</span></strong><span class="koboSpan" id="kobo.227.1">:
      - </span><strong class="bold"><span class="koboSpan" id="kobo.228.1">elasticsearch</span></strong><span class="koboSpan" id="kobo.229.1">
    ports:
      - </span><strong class="bold"><span class="koboSpan" id="kobo.230.1">5002:5001</span></strong></pre>
<p><span class="koboSpan" id="kobo.231.1">The Logstash </span><a id="_idIndexMarker1082"/><span class="koboSpan" id="kobo.232.1">configuration contains two extra </span><span class="No-Break"><span class="koboSpan" id="kobo.233.1">service keys:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.234.1">First, a command key that contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">logstash</span></strong><span class="koboSpan" id="kobo.236.1"> command with a given configuration (using </span><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">-e</span></strong><span class="koboSpan" id="kobo.238.1">). </span><span class="koboSpan" id="kobo.238.2">The Logstash configuration normally contains three </span><span class="No-Break"><span class="koboSpan" id="kobo.239.1">important parts:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">input</span></strong><span class="koboSpan" id="kobo.241.1">: Logstash input channels, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">tcp</span></strong><span class="koboSpan" id="kobo.243.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.244.1">File</span></strong><span class="koboSpan" id="kobo.245.1">. </span><span class="koboSpan" id="kobo.245.2">We are going to use a TCP input channel. </span><span class="koboSpan" id="kobo.245.3">This means that gRPC server and client services will push the logs in JSON format (a JSON-coded plugin is used) to </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1">logstash</span></strong><span class="koboSpan" id="kobo.247.1"> on </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">5001</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">.</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">filter</span></strong><span class="koboSpan" id="kobo.252.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">filter</span></strong><span class="koboSpan" id="kobo.254.1"> key contains various filter expressions using different means, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">grok</span></strong><span class="koboSpan" id="kobo.256.1">. </span><span class="koboSpan" id="kobo.256.2">You don’t want to filter anything from logs, so you should opt out of using </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">this key.</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">output</span></strong><span class="koboSpan" id="kobo.259.1">: Where to send the input data after filtering out the information. </span><span class="koboSpan" id="kobo.259.2">Here, we are using Elasticsearch. </span><span class="koboSpan" id="kobo.259.3">Logstash pushes the received log information to Elasticsearch on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">9200</span></strong><span class="koboSpan" id="kobo.261.1"> and uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">modern-api</span></strong><span class="koboSpan" id="kobo.263.1"> Elasticsearch index. </span><span class="koboSpan" id="kobo.263.2">This index is then used on Kibana for querying, analyzing, and visualizing </span><span class="No-Break"><span class="koboSpan" id="kobo.264.1">the logs.</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.265.1">A second key, </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">depends_on</span></strong><span class="koboSpan" id="kobo.267.1">, tells Docker Compose to start Elasticsearch before executing the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">logstash</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.269.1"> service.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.270.1">Next, let’s add the final service, </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">kibana</span></strong><span class="koboSpan" id="kobo.272.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.274.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.275.1">kibana</span></strong><span class="koboSpan" id="kobo.276.1">:      container_name: kb-container
      image: docker.elastic.co/kibana/kibana:8.7.0
      environment:
        - </span><strong class="bold"><span class="koboSpan" id="kobo.277.1">ELASTICSEARCH_HOSTS=http://es-container:9200</span></strong><span class="koboSpan" id="kobo.278.1">
      networks:
        - </span><strong class="bold"><span class="koboSpan" id="kobo.279.1">elk-net</span></strong><span class="koboSpan" id="kobo.280.1">
      depends_on:
        - </span><strong class="bold"><span class="koboSpan" id="kobo.281.1">elasticsearch</span></strong><span class="koboSpan" id="kobo.282.1">
     ports:
        - </span><strong class="bold"><span class="koboSpan" id="kobo.283.1">5600:5601</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.284.1">networks</span></strong><span class="koboSpan" id="kobo.285.1">:
  elk-net:
    </span><strong class="bold"><span class="koboSpan" id="kobo.286.1">driver: bridge</span></strong></pre>
<p><span class="koboSpan" id="kobo.287.1">The service’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">kibana</span></strong><span class="koboSpan" id="kobo.289.1"> definition is in line with other defined services. </span><span class="koboSpan" id="kobo.289.2">It uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">ELASTICSEARCH_HOSTS</span></strong><span class="koboSpan" id="kobo.291.1"> environment variable to connect </span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">to Elasticsearch.</span></span></p>
<p><span class="koboSpan" id="kobo.293.1">At the end of the Docker Compose file, you define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">elk-net</span></strong><span class="koboSpan" id="kobo.295.1"> network, which uses the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">bridge</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1"> driver.</span></span></p>
<p><span class="koboSpan" id="kobo.298.1">You are done </span><a id="_idIndexMarker1083"/><span class="koboSpan" id="kobo.299.1">with configuring the ELK stack Docker Compose file. </span><span class="koboSpan" id="kobo.299.2">Let’s now start Docker Compose using the following command. </span><span class="koboSpan" id="kobo.299.3">If you run this for the very first time, local images of Elasticsearch, Logstash, and Kibana will also be fetched. </span><span class="koboSpan" id="kobo.299.4">You can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">-f</span></strong><span class="koboSpan" id="kobo.301.1"> flag if you’ve used other filenames apart from </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">docker-compose.yaml</span></strong><span class="koboSpan" id="kobo.303.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.305.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.307.1">
$ docker-compose up –dCreating network "chapter12_elk-net" with driver "bridge"
Creating es-container ... </span><span class="koboSpan" id="kobo.307.2">done
Creating ls-container ... </span><span class="koboSpan" id="kobo.307.3">done
Creating kb-container ... </span><span class="koboSpan" id="kobo.307.4">done</span></pre>
<p><span class="koboSpan" id="kobo.308.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">-d</span></strong><span class="koboSpan" id="kobo.310.1"> option is used, which will start Docker Compose in the background. </span><span class="koboSpan" id="kobo.310.2">It starts the </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">es-container</span></strong><span class="koboSpan" id="kobo.312.1"> Elasticsearch container first based on dependencies (the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">depends_on</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.314.1"> key).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.315.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.316.1">Elasticsearch uses 2 GB of heap size by default. </span><span class="koboSpan" id="kobo.316.2">Docker also uses 2 GB of memory by default in some systems, such </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">as Mac.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.318.1">This may cause an error such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">error-137</span></strong><span class="koboSpan" id="kobo.320.1">. </span><span class="koboSpan" id="kobo.320.2">Therefore, you should increase the default Docker memory to at least 8 GB (more the better) and swap memory to at least 2 GB to avoid </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">such issues.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.322.1">Please refer to </span><a href="https://docs.docker.com/config/containers/resource_constraints/#memory"><span class="koboSpan" id="kobo.323.1">https://docs.docker.com/config/containers/resource_constraints/#memory</span></a><span class="koboSpan" id="kobo.324.1"> for Docker </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">memory configurations.</span></span></p>
<p><span class="koboSpan" id="kobo.326.1">You can see </span><a id="_idIndexMarker1084"/><span class="koboSpan" id="kobo.327.1">that Docker Compose first creates the network, and then creates the service containers and starts them. </span><span class="koboSpan" id="kobo.327.2">Once all the containers are up, you can hit the URL </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">http://localhost:19200/</span></strong><span class="koboSpan" id="kobo.329.1"> (which contains the external port defined for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">Elasticsearch</span></strong><span class="koboSpan" id="kobo.331.1"> service) in the browser to check whether the Elasticsearch instance is up </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">or not.</span></span></p>
<p><span class="koboSpan" id="kobo.333.1">Once you hit the URL, you may find the following type of JSON response if the Elasticsearch service </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">is up:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.335.1">
{  "name" : "1bfa291e20b2",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "Lua_MmozTS-grM0ZeJ5EBA",
  "version" : {
    "number" : "8.7.0",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" :
        "09520b59b6bc1057340b55750186466ea715e30e",
    "build_date" : "2023-03-27T16:31:09.816451435Z",
    "build_snapshot" : false,
    "lucene_version" : "9.5.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}</span></pre>
<p><span class="koboSpan" id="kobo.336.1">Next, let’s check </span><a id="_idIndexMarker1085"/><span class="koboSpan" id="kobo.337.1">the Kibana dashboard by hitting the URL </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">http://localhost:5600</span></strong><span class="koboSpan" id="kobo.339.1"> (which contains the external port defined for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">kibana</span></strong><span class="koboSpan" id="kobo.341.1"> service) in the browser. </span><span class="koboSpan" id="kobo.341.2">This should load the home page of Kibana, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer050">
<span class="koboSpan" id="kobo.343.1"><img alt="Figure 12.2 – Kibana home page" src="image/Figure_12.02_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.344.1">Figure 12.2 – Kibana home page</span></p>
<p><span class="koboSpan" id="kobo.345.1">You may be </span><a id="_idIndexMarker1086"/><span class="koboSpan" id="kobo.346.1">wondering how the logs can be viewed since you have used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">-d</span></strong><span class="koboSpan" id="kobo.348.1"> option. </span><span class="koboSpan" id="kobo.348.2">You can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">docker-compose logs [service name]</span></strong><span class="koboSpan" id="kobo.350.1"> command. </span><span class="koboSpan" id="kobo.350.2">If you don’t provide the service name, then it will show the logs of all the services. </span><span class="koboSpan" id="kobo.350.3">You can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">--tail</span></strong><span class="koboSpan" id="kobo.352.1"> flag to filter the number of lines. </span><span class="koboSpan" id="kobo.352.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">--tail="all"</span></strong><span class="koboSpan" id="kobo.354.1"> flag will show all </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">the lines:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.356.1">
// Don't use flag –t as it is a switch that turns on the timestamp$ docker-compose logs --tail="10" elasticsearch
$ docker-compose logs --tail="10" kibana</span></pre>
<p><span class="koboSpan" id="kobo.357.1">You can use </span><a id="_idIndexMarker1087"/><span class="koboSpan" id="kobo.358.1">the following command to stop </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">Docker Compose:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.360.1">
$ docker-compose downStopping ls-container ... </span><span class="koboSpan" id="kobo.360.2">done
Stopping kb-container ... </span><span class="koboSpan" id="kobo.360.3">done
Stopping es-container ... </span><span class="koboSpan" id="kobo.360.4">done
Removing ls-container ... </span><span class="koboSpan" id="kobo.360.5">done
Removing kb-container ... </span><span class="koboSpan" id="kobo.360.6">done
Removing es-container ... </span><span class="koboSpan" id="kobo.360.7">done
Removing network chapter12_elk-net</span></pre>
<p><span class="koboSpan" id="kobo.361.1">The output may vary a bit. </span><span class="koboSpan" id="kobo.361.2">However, it should stop and remove all the running containers. </span><span class="koboSpan" id="kobo.361.3">The command stops the containers according to the dependencies provided in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">docker-compose.yaml</span></strong><span class="koboSpan" id="kobo.363.1"> file based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">depends_on</span></strong><span class="koboSpan" id="kobo.365.1"> property and then removes them. </span><span class="koboSpan" id="kobo.365.2">Finally, it removes </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">the network.</span></span></p>
<p><span class="koboSpan" id="kobo.367.1">Next, let’s make the code changes to integrate the application with the </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">ELK stack.</span></span></p>
<h1 id="_idParaDest-279"><a id="_idTextAnchor278"/><span class="koboSpan" id="kobo.369.1">Implementing logging and tracing in the gRPC code</span></h1>
<p><span class="koboSpan" id="kobo.370.1">Logging and </span><a id="_idIndexMarker1088"/><span class="koboSpan" id="kobo.371.1">tracing go hand in hand. </span><span class="koboSpan" id="kobo.371.2">Logging in the </span><a id="_idIndexMarker1089"/><span class="koboSpan" id="kobo.372.1">application code is already taken care of by default. </span><span class="koboSpan" id="kobo.372.2">You use Logback for logging. </span><span class="koboSpan" id="kobo.372.3">Logs are either configured to display on the console or pushed to the filesystem. </span><span class="koboSpan" id="kobo.372.4">However, you also need to push the logs to the ELK stack for indexing and analysis. </span><span class="koboSpan" id="kobo.372.5">For this purpose, you make certain changes to the Logback configuration file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">logback-spring.xml</span></strong><span class="koboSpan" id="kobo.374.1">, to push the logs to Logstash. </span><span class="koboSpan" id="kobo.374.2">On top of that, these logs should also contain </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">tracking information.</span></span></p>
<p><span class="koboSpan" id="kobo.376.1">Correlation/trace identifiers should be populated and propagated in distributed transactions for tracing purposes. </span><span class="koboSpan" id="kobo.376.2">A distributed transaction refers to the main API call that internally calls other services to serve the request. </span><span class="koboSpan" id="kobo.376.3">Before Spring Boot 3, Spring provided distributed </span><a id="_idIndexMarker1090"/><span class="koboSpan" id="kobo.377.1">tracing support through the </span><strong class="bold"><span class="koboSpan" id="kobo.378.1">Spring Cloud Sleuth</span></strong><span class="koboSpan" id="kobo.379.1"> library; now, tracing support is provided by Spring Micrometer. </span><span class="koboSpan" id="kobo.379.2">It generates </span><a id="_idIndexMarker1091"/><span class="koboSpan" id="kobo.380.1">the trace ID along with the span identifier. </span><span class="koboSpan" id="kobo.380.2">The trace </span><a id="_idIndexMarker1092"/><span class="koboSpan" id="kobo.381.1">ID gets propagated to all the participant services during the distributed transaction. </span><span class="koboSpan" id="kobo.381.2">The span ID also participates in a distributed transaction. </span><span class="koboSpan" id="kobo.381.3">However, the scope of the span identifier belongs to its service (the one </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">it populates).</span></span></p>
<p><span class="koboSpan" id="kobo.383.1">As communicated earlier, you are going to use Zipkin; therefore, you’ll use Brave, a distributed tracing instrumentation library </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">by Zipkin.</span></span></p>
<p><span class="koboSpan" id="kobo.385.1">You can copy and enhance the code from </span><a href="B19349_11.xhtml#_idTextAnchor250"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.386.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.387.1">, </span><em class="italic"><span class="koboSpan" id="kobo.388.1">gRPC API Development and Testing</span></em><span class="koboSpan" id="kobo.389.1">, found at </span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11"><span class="koboSpan" id="kobo.390.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter11</span></a><span class="koboSpan" id="kobo.391.1">, to implement logging and tracing, or refer to this chapter’s code at </span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12"><span class="koboSpan" id="kobo.392.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12</span></a> <span class="No-Break"><span class="koboSpan" id="kobo.393.1">for changes.</span></span></p>
<p><span class="koboSpan" id="kobo.394.1">First, you’ll make the changes to the gRPC server code in the </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">following subsection.</span></span></p>
<h2 id="_idParaDest-280"><a id="_idTextAnchor279"/><span class="koboSpan" id="kobo.396.1">Changing the gRPC server code</span></h2>
<p><span class="koboSpan" id="kobo.397.1">To enable </span><a id="_idIndexMarker1093"/><span class="koboSpan" id="kobo.398.1">tracing and the publishing of logs to the ELK stack, you need to make the following code changes, as demonstrated in the </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.400.1">Add the following dependencies to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">build.gradle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.402.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.403.1">
implementation 'net.logstash.logback:    </span><strong class="bold"><span class="koboSpan" id="kobo.404.1">logstash-logback-encoder</span></strong><span class="koboSpan" id="kobo.405.1">:7.3'implementation 'io.micrometer:    </span><strong class="bold"><span class="koboSpan" id="kobo.406.1">micrometer-tracing-bridge-brave'</span></strong><span class="koboSpan" id="kobo.407.1">implementation 'org.springframework.boot:    </span><strong class="bold"><span class="koboSpan" id="kobo.408.1">spring-boot-starter-actuator</span></strong><span class="koboSpan" id="kobo.409.1">'</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/server/build.gradle%20"><span class="No-Break"><span class="koboSpan" id="kobo.410.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/server/build.gradle</span></span></a></p>
<p><span class="koboSpan" id="kobo.411.1">Here, you are </span><a id="_idIndexMarker1094"/><span class="koboSpan" id="kobo.412.1">adding the following </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">four dependencies:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.414.1">logstash-logback-encoder</span></strong><span class="koboSpan" id="kobo.415.1">: This library provides the Logback encoder, which publishes the logs to Logstash. </span><span class="koboSpan" id="kobo.415.2">This will be configured in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">spring-logback.xml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.417.1"> file.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.418.1">micrometer-tracing-bridge-brave</span></strong><span class="koboSpan" id="kobo.419.1">: This dependency takes care of managing the trace and span IDs. </span><span class="koboSpan" id="kobo.419.2">Micrometer Tracing Bridge Brave is an abstraction library for Zipkin Brave that publishes the collected tracing information to Zipkin </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">using Brave.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.421.1">spring-boot-starter-actuator</span></strong><span class="koboSpan" id="kobo.422.1">: You used this library earlier in </span><a href="B19349_09.xhtml#_idTextAnchor215"><em class="italic"><span class="koboSpan" id="kobo.423.1">Chapter 9</span></em></a><span class="koboSpan" id="kobo.424.1">, </span><em class="italic"><span class="koboSpan" id="kobo.425.1">Deployment of Web Services</span></em><span class="koboSpan" id="kobo.426.1">, to provide the health endpoint. </span><span class="koboSpan" id="kobo.426.2">It also provides metric endpoints. </span><span class="koboSpan" id="kobo.426.3">On top of that, it performs the metrics and </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">tracing autoconfiguration.</span></span></li>
</ul>
<ol>
<li value="2"><span class="koboSpan" id="kobo.428.1">Next, add/modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">spring-logback.xml</span></strong><span class="koboSpan" id="kobo.430.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">following content:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.432.1">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;configuration&gt;  &lt;springProperty scope="context"     name="applicationName" source="spring.application         .name"/&gt;  &lt;</span><strong class="bold"><span class="koboSpan" id="kobo.433.1">springProperty</span></strong><span class="koboSpan" id="kobo.434.1"> scope="context"     name="</span><strong class="bold"><span class="koboSpan" id="kobo.435.1">logstashDestination</span></strong><span class="koboSpan" id="kobo.436.1">"     source="</span><strong class="bold"><span class="koboSpan" id="kobo.437.1">logstash.destination</span></strong><span class="koboSpan" id="kobo.438.1">" /&gt;  &lt;property name="</span><strong class="bold"><span class="koboSpan" id="kobo.439.1">LOG_PATTERN</span></strong><span class="koboSpan" id="kobo.440.1">"    value="%d{yyyy-MM-dd HH:mm:ss.SSS}    %5p [${</span><strong class="bold"><span class="koboSpan" id="kobo.441.1">applicationName</span></strong><span class="koboSpan" id="kobo.442.1">},%X{</span><strong class="bold"><span class="koboSpan" id="kobo.443.1">traceId</span></strong><span class="koboSpan" id="kobo.444.1">:-},%X{</span><strong class="bold"><span class="koboSpan" id="kobo.445.1">spanId</span></strong><span class="koboSpan" id="kobo.446.1">:-}]    ${PID:-} --- [%15.15t] %-40.40logger{39} :       %msg%n"/&gt;  &lt;property name="LOG_FILE" value="${chapter12-grpc-   server.service.logging.file:-chapter12-grpc-server-   logs}"/&gt;  &lt;property name="LOG_DIR" value="${chapter12-grpc-   server.service.logging.path:-chapter12-grpc-server-   logs}"/&gt;  &lt;property name="SERVICE_ENV" value="${service.env:-   dev}"/&gt;  &lt;property name="LOG_BASE_PATH"   value="${LOG_DIR}/${SERVICE_ENV}"/&gt;  &lt;property name="MAX_FILE_SIZE" value="${chapter12.service.   logging.rolling.maxFileSize:-  100MB}"/&gt;&lt;!-- other configuration has been removed for brevity --&gt;</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/dev/Chapter12/server/src/main/resources/logback-spring.xml"><span class="No-Break"><span class="koboSpan" id="kobo.447.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/server/src/main/resources/logback-spring.xml</span></span></a></p>
<p><span class="koboSpan" id="kobo.448.1">Here, you have defined the properties. </span><span class="koboSpan" id="kobo.448.2">The values of two of them are taken from the Spring configuration file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.449.1">application.properties</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.450.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">application.yaml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.453.1">Let’s now </span><a id="_idIndexMarker1095"/><span class="koboSpan" id="kobo.454.1">add the Logstash encoder, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.456.1">
&lt;appender name="</span><strong class="bold"><span class="koboSpan" id="kobo.457.1">STASH</span></strong><span class="koboSpan" id="kobo.458.1">"   class="net.logstash.logback.appender
       .</span><strong class="bold"><span class="koboSpan" id="kobo.459.1">LogstashTcpSocketAppender</span></strong><span class="koboSpan" id="kobo.460.1">"&gt;
  &lt;destination&gt;</span><strong class="bold"><span class="koboSpan" id="kobo.461.1">${logstashDestination}</span></strong><span class="koboSpan" id="kobo.462.1">&lt;/destination&gt;
  &lt;encoder
  class="net.logstash.logback.encoder.LogstashEncoder" /&gt;
&lt;/appender&gt;
&lt;!-- other configuration has been removed for brevity --&gt;</span></pre>
<p><span class="koboSpan" id="kobo.463.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">STASH</span></strong><span class="koboSpan" id="kobo.465.1"> appender is defined and uses the TCP socket to push the logs to Logstash. </span><span class="koboSpan" id="kobo.465.2">It contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.466.1">destination</span></strong><span class="koboSpan" id="kobo.467.1"> element, which is used to assign Logstash’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.468.1">&lt;HOST&gt;:&lt;TCP Port&gt;</span></strong><span class="koboSpan" id="kobo.469.1"> value. </span><span class="koboSpan" id="kobo.469.2">Another element encoder contains the fully qualified class </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">name, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">LogstashEncoder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.473.1">Finally, you will add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">STASH</span></strong><span class="koboSpan" id="kobo.475.1"> appender to the root element, as </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">shown next:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.477.1">
&lt;!-- other configuration has been removed for brevity --&gt;&lt;root level="</span><strong class="bold"><span class="koboSpan" id="kobo.478.1">INFO</span></strong><span class="koboSpan" id="kobo.479.1">"&gt;
  &lt;appender-ref ref="STDOUT"/&gt;
  </span><strong class="bold"><span class="koboSpan" id="kobo.480.1">&lt;appender-ref ref="STASH"/&gt;</span></strong><span class="koboSpan" id="kobo.481.1">
  &lt;appender-ref ref="FILE"/&gt;
&lt;/root&gt;</span></pre>
<p><span class="koboSpan" id="kobo.482.1">The root level is set as </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">INFO</span></strong><span class="koboSpan" id="kobo.484.1"> because you want to simply print the </span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">information logs.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.486.1">Test configuration for Logstash</span></p>
<p class="callout"><span class="koboSpan" id="kobo.487.1">To disable the LOGSTASH (STASH) appender sending the logs to the Logstash instance, do </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">the following:</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.489.1">1. </span><span class="koboSpan" id="kobo.489.2">You may copy </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">logback-spring.xml</span></strong><span class="koboSpan" id="kobo.491.1"> into the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">test/resources</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.493.1"> directory.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.494.1">2. </span><span class="koboSpan" id="kobo.494.2">Rename </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">test/resources/logback-test.xml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.498.1">3. </span><span class="koboSpan" id="kobo.498.2">Remove the LOGSTASH (STASH) appender and its entry </span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">&lt;ROOT&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.502.1">Next, let’s </span><a id="_idIndexMarker1096"/><span class="koboSpan" id="kobo.503.1">add the Spring properties used in this </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">logback-spring.xml</span></strong><span class="koboSpan" id="kobo.505.1"> file to </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">application.properties</span></strong><span class="koboSpan" id="kobo.507.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">code block:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.509.1">spring.application.name=grpc-server</span></strong><span class="koboSpan" id="kobo.510.1">spring.main.web-application-type=nonegrpc.port=8080</span><strong class="bold"><span class="koboSpan" id="kobo.511.1">logstash.destination=localhost:5002</span></strong><span class="koboSpan" id="kobo.512.1">management.tracing.sampling.probability=1.0</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/server/src/main/resources/application.properties"><span class="No-Break"><span class="koboSpan" id="kobo.513.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/server/src/main/resources/application.properties</span></span></a></p>
<p><span class="koboSpan" id="kobo.514.1">Here, the Logstash destination host is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.515.1">localhost</span></strong><span class="koboSpan" id="kobo.516.1">. </span><span class="koboSpan" id="kobo.516.2">If you are running on a remote machine, change the host accordingly. </span><span class="koboSpan" id="kobo.516.3">The Logstash TCP port is set to the same as the Logstash external port set in the Docker </span><span class="No-Break"><span class="koboSpan" id="kobo.517.1">Composer file.</span></span></p>
<p><span class="koboSpan" id="kobo.518.1">Default probability sampling for tracing is only 10% of the actual requests. </span><span class="koboSpan" id="kobo.518.2">Therefore, we are setting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">management.tracing.sampling.probability</span></strong><span class="koboSpan" id="kobo.520.1"> property to </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">1.0</span></strong><span class="koboSpan" id="kobo.522.1">. </span><span class="koboSpan" id="kobo.522.2">Now, it collects tracing information for 100% of the requests. </span><span class="koboSpan" id="kobo.522.3">Therefore, every request will </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">be traced.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.524.1">The required </span><a id="_idIndexMarker1097"/><span class="koboSpan" id="kobo.525.1">dependencies and configurations are now set. </span><span class="koboSpan" id="kobo.525.2">You can add the tracing server interceptor to the gRPC server. </span><span class="koboSpan" id="kobo.525.3">(Note: you don’t need a tracing interceptor if you are using the RESTful web service as Spring’s autoconfiguration mechanism takes care </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">of this.)</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.527.1">First of all, let’s define a new bean in a configuration file, as </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">shown here:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.529.1">@Configuration</span></strong><span class="koboSpan" id="kobo.530.1">public class Config {
  </span><strong class="bold"><span class="koboSpan" id="kobo.531.1">@Bean</span></strong><span class="koboSpan" id="kobo.532.1">
  public ObservationGrpcServerInterceptor
         interceptor(ObservationRegistry registry) {
    return new
           ObservationGrpcServerInterceptor(registry);
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/dev/Chapter12/server/src/main/java/com/packt/modern/api/server/Config.java"><span class="No-Break"><span class="koboSpan" id="kobo.533.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/dev/Chapter12/server/src/main/java/com/packt/modern/api/server/Config.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.534.1">Here, you are creating an </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">ObservationGrpcServerInterceptor</span></strong><span class="koboSpan" id="kobo.536.1"> bean, which is required for creating the tracing server interceptor. </span><span class="koboSpan" id="kobo.536.2">Before Spring Boot 3, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">RpcTracing</span></strong><span class="koboSpan" id="kobo.538.1"> bean was provided by Spring Sleuth. </span><span class="koboSpan" id="kobo.538.2">Now, autoconfiguration of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">RpcTracing</span></strong><span class="koboSpan" id="kobo.540.1"> bean is not available because Spring Boot 3 supports Spring Micrometer over Sleuth. </span><span class="koboSpan" id="kobo.540.2">You’ll add this bean in the gRPC server as </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">an interceptor.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.542.1">Let’s modify </span><a id="_idIndexMarker1098"/><span class="koboSpan" id="kobo.543.1">the gRPC server Java file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">GrpcServer.java</span></strong><span class="koboSpan" id="kobo.545.1">) to add the tracing server interceptor to the gRPC server, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.547.1">
@Componentpublic class GrpcServer {  // code truncated for brevity  private final </span><strong class="bold"><span class="koboSpan" id="kobo.548.1">ObservationGrpcServerInterceptor</span></strong><strong class="bold"><span class="koboSpan" id="kobo.549.1">         oInterceptor</span></strong><span class="koboSpan" id="kobo.550.1">;  public GrpcServer(SourceService sourceService,      ChargeService chargeService,      ExceptionInterceptor      exceptionInterceptor,      </span><strong class="bold"><span class="koboSpan" id="kobo.551.1">ObservationGrpcServerInterceptor oInterceptor</span></strong><span class="koboSpan" id="kobo.552.1">) {    this.sourceService = sourceService;    this.chargeService = chargeService;    this.exceptionInterceptor = exceptionInterceptor;    </span><strong class="bold"><span class="koboSpan" id="kobo.553.1">this.oInterceptor = oInterceptor</span></strong><span class="koboSpan" id="kobo.554.1">;  }  public void start()throws IOException,      InterruptedException {    server = ServerBuilder.forPort(port)        .addService(sourceService)        .addService(chargeService)        .intercept(exceptionInterceptor)        </span><strong class="bold"><span class="koboSpan" id="kobo.555.1">.intercept(oInterceptor)</span></strong><span class="koboSpan" id="kobo.556.1">        .build().start();  // code truncated for brevity</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/server/src/main/java/com/packt/modern/api/server/GrpcServer.java%20"><span class="No-Break"><span class="koboSpan" id="kobo.557.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/server/src/main/java/com/packt/modern/api/server/GrpcServer.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.558.1">Here, you can see that the bean created in the configuration file in the previous step is injected using the constructor. </span><span class="koboSpan" id="kobo.558.2">Later, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">oInterceptor</span></strong><span class="koboSpan" id="kobo.560.1"> bean has been used to create the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">server interceptor.</span></span></p>
<p><span class="koboSpan" id="kobo.562.1">The changes </span><a id="_idIndexMarker1099"/><span class="koboSpan" id="kobo.563.1">required to enable log publishing to the ELK stack and tracing are made to the gRPC server. </span><span class="koboSpan" id="kobo.563.2">You can rebuild the gRPC server and run its </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">JAR</span></strong><span class="koboSpan" id="kobo.565.1"> file to see the changes in effect. </span><span class="koboSpan" id="kobo.565.2">Check the following command-line output for </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">the reference:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.567.1">
// Commands from Chapter12/server directory$ ./gradlew clean build
// You may want to up docker-compose before running the server
// to avoid Logstash connect errors.
</span><span class="koboSpan" id="kobo.567.2">$ java -jar build/libs/chapter12-server-0.0.1-SNAPSHOT.jar
// Logs truncated for brevity
2023-04-23 21:30:42.120      </span><strong class="bold"><span class="koboSpan" id="kobo.568.1">INFO [grpc-server,,]</span></strong><span class="koboSpan" id="kobo.569.1">     49296 --- [           main] com.packt.modern.api.server.GrpcServer   : gRPC server is starting on port: 8080.</span></pre>
<p><span class="koboSpan" id="kobo.570.1">You can see that the logs are following the pattern configured in </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">logback-spring.xml</span></strong><span class="koboSpan" id="kobo.572.1">. </span><span class="koboSpan" id="kobo.572.2">The log block printed after </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">INFO</span></strong><span class="koboSpan" id="kobo.574.1"> contains the application/service name, as well as the </span><a id="_idIndexMarker1100"/><span class="koboSpan" id="kobo.575.1">trace and span IDs. </span><span class="koboSpan" id="kobo.575.2">The highlighted line is showing a </span><em class="italic"><span class="koboSpan" id="kobo.576.1">blank</span></em><span class="koboSpan" id="kobo.577.1"> trace ID and span ID because no external call is made that involves the distributed transaction. </span><span class="koboSpan" id="kobo.577.2">The trace and span IDs only get added to logs if the distributed transaction (service-to-service communication) </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">is called.</span></span></p>
<p><span class="koboSpan" id="kobo.579.1">Similarly, you can add the logging and tracing implementation in the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">client next.</span></span></p>
<h2 id="_idParaDest-281"><a id="_idTextAnchor280"/><span class="koboSpan" id="kobo.581.1">Changing the gRPC client code</span></h2>
<p><span class="koboSpan" id="kobo.582.1">To enable </span><a id="_idIndexMarker1101"/><span class="koboSpan" id="kobo.583.1">tracing and the publishing of logs to the ELK stack, you need to make code changes in the gRPC client as well, which are very similar to the changes implemented in the gRPC server code. </span><span class="koboSpan" id="kobo.583.2">Refer to the following steps for </span><span class="No-Break"><span class="koboSpan" id="kobo.584.1">more information:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.585.1">Add the following dependencies to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">build.gradle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.587.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.588.1">
implementation 'net.logstash.logback:    </span><strong class="bold"><span class="koboSpan" id="kobo.589.1">logstash-logback-encoder</span></strong><span class="koboSpan" id="kobo.590.1">:7.3'implementation 'io.micrometer:</span><strong class="bold"><span class="koboSpan" id="kobo.591.1">micrometer-tracing-bridge-brave</span></strong><span class="koboSpan" id="kobo.592.1">'implementation 'org.springframework.boot:</span><strong class="bold"><span class="koboSpan" id="kobo.593.1">spring-boot-starter-actuator</span></strong><span class="koboSpan" id="kobo.594.1">'</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/build.gradle"><span class="No-Break"><span class="koboSpan" id="kobo.595.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/build.gradle</span></span></a></p>
<p><span class="koboSpan" id="kobo.596.1">These are the same dependencies you added to the </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">gRPC server.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.598.1">Next, you can add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">logback-spring.xml</span></strong><span class="koboSpan" id="kobo.600.1"> file in the same way you added it to the gRPC server code to configure the logging. </span><span class="koboSpan" id="kobo.600.2">Make sure to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">chapter12-grpc-client</span></strong><span class="koboSpan" id="kobo.602.1"> in place of </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">chapter12-grpc-server</span></strong><span class="koboSpan" id="kobo.604.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">XML file.</span></span></li>
<li><span class="koboSpan" id="kobo.606.1">Next, let’s add the following Spring properties to </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">application.properties</span></strong><span class="koboSpan" id="kobo.608.1">. </span><span class="koboSpan" id="kobo.608.2">A few of these properties are referred to in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">logback-spring.xml</span></strong><span class="koboSpan" id="kobo.610.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">as well:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.612.1">spring.application.name=grpc-client</span></strong><span class="koboSpan" id="kobo.613.1">server.port=8081grpc.server.host=localhostgrpc.server.port=8080</span><strong class="bold"><span class="koboSpan" id="kobo.614.1">logstash.destination=localhost:5002</span></strong><span class="koboSpan" id="kobo.615.1">management.tracing.sampling.probability=1.0</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/src/main/resources/application.properties"><span class="No-Break"><span class="koboSpan" id="kobo.616.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/src/main/resources/application.properties</span></span></a></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.617.1">The required </span><a id="_idIndexMarker1102"/><span class="koboSpan" id="kobo.618.1">dependencies and configurations are now set. </span><span class="koboSpan" id="kobo.618.2">Now, you can add tracing to the gRPC client. </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">ObservationGrpcClientInterceptor</span></strong><span class="koboSpan" id="kobo.620.1">, provided by the Micrometer library, provides the interceptor for the </span><span class="No-Break"><span class="koboSpan" id="kobo.621.1">gRPC client.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.622.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.623.1">You don’t need additional tracing changes if you are using the RESTful web service; Spring autoconfiguration takes care </span><span class="No-Break"><span class="koboSpan" id="kobo.624.1">of this.</span></span></p>
<p><span class="koboSpan" id="kobo.625.1">First of all, let’s define a new bean, </span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">ObservationGrpcClientInterceptor</span></strong><span class="koboSpan" id="kobo.627.1">, in a configuration file, as </span><span class="No-Break"><span class="koboSpan" id="kobo.628.1">shown next:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.629.1">@Configuration</span></strong><span class="koboSpan" id="kobo.630.1">public class Config {
 </span><strong class="bold"><span class="koboSpan" id="kobo.631.1">@Bean</span></strong><span class="koboSpan" id="kobo.632.1">
 public </span><strong class="bold"><span class="koboSpan" id="kobo.633.1">ObservationGrpcClientInterceptor</span></strong><span class="koboSpan" id="kobo.634.1"> interceptor
      (ObservationRegistry registry) {
   return new ObservationGrpcClientInterceptor
      (registry);
 }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/src/main/java/com/packt/modern/api/Config.java"><span class="No-Break"><span class="koboSpan" id="kobo.635.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/src/main/java/com/packt/modern/api/Config.java</span></span></a></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.636.1">Now, you can </span><a id="_idIndexMarker1103"/><span class="koboSpan" id="kobo.637.1">modify the gRPC client Java file to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">ObservationGrpcClientInterceptor</span></strong><span class="koboSpan" id="kobo.639.1"> interceptor to the </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">gRPC client:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.641.1">
@Componentpublic class GrpcClient {  @Autowired  private </span><strong class="bold"><span class="koboSpan" id="kobo.642.1">ObservationGrpcClientInterceptor</span></strong><span class="koboSpan" id="kobo.643.1">      </span><strong class="bold"><span class="koboSpan" id="kobo.644.1">observationGrpcClientInterceptor</span></strong><span class="koboSpan" id="kobo.645.1">;  // code truncated for brevity  public void start() {   channel = ManagedChannelBuilder.forAddress       (host, port)             </span><strong class="bold"><span class="koboSpan" id="kobo.646.1">.intercept(observationGrpcClientInterceptor)</span></strong><span class="koboSpan" id="kobo.647.1">    .usePlaintext().build();   sourceServiceStub = SourceServiceGrpc       .newBlockingStub(channel);   chargeServiceStub = ChargeServiceGrpc       .newBlockingStub(channel);  }  // code truncated for brevity</span></pre></li> </ol>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/src/main/java/com/packt/modern/api/client/GrpcClient.java"><span class="No-Break"><span class="koboSpan" id="kobo.648.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/dev/Chapter12/client/src/main/java/com/packt/modern/api/client/GrpcClient.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.649.1">Here, you can see that the bean created in the configuration file in the previous step is autowired. </span><span class="koboSpan" id="kobo.649.2">Later, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">observationGrpcClientInterceptor</span></strong><span class="koboSpan" id="kobo.651.1"> interceptor is added to </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">the client.</span></span></p>
<p><span class="koboSpan" id="kobo.653.1">The changes </span><a id="_idIndexMarker1104"/><span class="koboSpan" id="kobo.654.1">required to facilitate log publishing to the ELK stack and tracing are also done for the gRPC client. </span><span class="koboSpan" id="kobo.654.2">You can now rebuild the gRPC client and run its JAR file to see the changes in effect. </span><span class="koboSpan" id="kobo.654.3">Check the following command-line output </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">for reference:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.656.1">
// Commands from Chapter12/client directory$ </span><strong class="bold"><span class="koboSpan" id="kobo.657.1">./gradlew clean build</span></strong><span class="koboSpan" id="kobo.658.1">
// You may want to up docker-compose before running the server
// to avoid Logstash connect errors.
</span><span class="koboSpan" id="kobo.658.2">$ </span><strong class="bold"><span class="koboSpan" id="kobo.659.1">java -jar build/libs/chapter12-client-0.0.1-SNAPSHOT.jar</span></strong><span class="koboSpan" id="kobo.660.1">
// log truncated for brevity
2023-04-23 23:02:35.297      INFO [</span><strong class="bold"><span class="koboSpan" id="kobo.661.1">grpc-client</span></strong><span class="koboSpan" id="kobo.662.1">,,]     51746 --- [           main] com.packt.modern.api.ClientApp           : Started ClientApp in 3.955 seconds (process running for 4.611)
2023-04-23 23:02:35.674      INFO [</span><strong class="bold"><span class="koboSpan" id="kobo.663.1">grpc-client</span></strong><span class="koboSpan" id="kobo.664.1">,,]     51746 --- [           main] com.packt.modern.api.client.GrpcClient   : </span><strong class="bold"><span class="koboSpan" id="kobo.665.1">gRPC client connected to localhost:8080</span></strong></pre>
<p><span class="koboSpan" id="kobo.666.1">You can see that the logs follow the pattern configured in </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">logback-spring.xml</span></strong><span class="koboSpan" id="kobo.668.1">. </span><span class="koboSpan" id="kobo.668.2">The log block printed after </span><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">INFO</span></strong><span class="koboSpan" id="kobo.670.1"> contains the application/service name, trace ID, and span ID. </span><span class="koboSpan" id="kobo.670.2">The trace and span IDs are blank because they only get added to logs if distributed transactions (service-to-service communication) </span><span class="No-Break"><span class="koboSpan" id="kobo.671.1">are called.</span></span></p>
<p><span class="koboSpan" id="kobo.672.1">The changes </span><a id="_idIndexMarker1105"/><span class="koboSpan" id="kobo.673.1">required to enable log aggregation and distributed tracing in both the gRPC server and client services are </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">now complete.</span></span></p>
<p><span class="koboSpan" id="kobo.675.1">Next, you’ll test the changes and view the logs </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">in Kibana.</span></span></p>
<h2 id="_idParaDest-282"><a id="_idTextAnchor281"/><span class="koboSpan" id="kobo.677.1">Testing the logging and tracing changes</span></h2>
<p><span class="koboSpan" id="kobo.678.1">Before beginning testing, make sure that the ELK stack is up and running. </span><span class="koboSpan" id="kobo.678.2">Also, make sure </span><a id="_idIndexMarker1106"/><span class="koboSpan" id="kobo.679.1">that you first start the gRPC server and then the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">client service.</span></span></p>
<p><span class="koboSpan" id="kobo.681.1">You can </span><a id="_idIndexMarker1107"/><span class="koboSpan" id="kobo.682.1">add the appropriate log statements to your services for </span><span class="No-Break"><span class="koboSpan" id="kobo.683.1">verbose logs.</span></span></p>
<p><span class="koboSpan" id="kobo.684.1">Let’s run the following command in the new terminal window. </span><span class="koboSpan" id="kobo.684.2">This will call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.685.1">/charges</span></strong><span class="koboSpan" id="kobo.686.1"> REST endpoint in the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">client service:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.688.1">
$ curl http://localhost:8081/charges</span></pre> <p><span class="koboSpan" id="kobo.689.1">It should respond with the following </span><span class="No-Break"><span class="koboSpan" id="kobo.690.1">JSON output:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.691.1">
{  "charge": [{
    "id": "aibn4f45m49bojd3u0p16erbi5lnelui",
    "amount": 1000,
    "amountCaptured": 0,
    "amountRefunded": 0,
    "balanceTransactionId": "",
    "calculatedStatementDescriptor": "",
    "receiptEmail": "receipt@email.com",
output truncated for brevity
    "refunded": false,
    "refunds": [],
    "statementDescriptor": "Statement Descriptor",
    "status": "SUCCEEDED",
    "sourceId": "inccsjg6gogsvi4rlprdbvvfq2ft2e6c"
  }]
}</span></pre>
<p><span class="koboSpan" id="kobo.692.1">The </span><a id="_idIndexMarker1108"/><span class="koboSpan" id="kobo.693.1">previous </span><strong class="source-inline"><span class="koboSpan" id="kobo.694.1">curl</span></strong><span class="koboSpan" id="kobo.695.1"> command should generate </span><a id="_idIndexMarker1109"/><span class="koboSpan" id="kobo.696.1">logs like the following one in the </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">gRPC client:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.698.1">
2023-04-23 23:10:37.882      INFO [</span><strong class="bold"><span class="koboSpan" id="kobo.699.1">grpc-client</span></strong><span class="koboSpan" id="kobo.700.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.701.1">64456d940c51e3e2baec07f 7448beee6</span></strong><span class="koboSpan" id="kobo.702.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.703.1">baec07f7448beee6</span></strong><span class="koboSpan" id="kobo.704.1">]     51746 --- [nio-8081-exec-1] brave.Trac er                             : {"traceId":"64456d940c51e3e2baec07f 7448beee6","parentId":"baec07f7448beee6","id":"0645e686d86968b6","kind":"CLIENT","name":"com.packtpub.v1.ChargeService/RetrieveAll","timestamp":1682271636300866,"duration":1578184,"localEndpoint":{"serviceName":"unknown","ipv4":"192.168.1.2"},"tags":{"rpc.service":"com.packtpub.v1.ChargeService","rpc.method":"RetrieveAll"}}2023-04-23 23:10:37.886      INFO [</span><strong class="bold"><span class="koboSpan" id="kobo.705.1">grpc-client</span></strong><span class="koboSpan" id="kobo.706.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.707.1">64456d940c51e3e2baec07f 7448beee6</span></strong><span class="koboSpan" id="kobo.708.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.709.1">baec07f7448beee6</span></strong><span class="koboSpan" id="kobo.710.1">]     51746 --- [nio-8081-exec-1] c.p.m.api.controller.ChargeController    : Server response received in Json Format: charge {
  id: "iivpc3i9el2dso9s2s2rqf9j3s2pomlm"
  amount: 1000
  created: 1682265641
  currency: "USD"
  customerId: "ab1ab2ab3ab4ab5"
  description: "Charge Description"
  receiptEmail: receipt@email.com
  statementDescriptor: "Statement Descriptor"
  sourceId: "6ufgh93stkjod1ih2vhkmamj9l1m0hvv"
}</span></pre>
<p><span class="koboSpan" id="kobo.711.1">Here, the blocks </span><a id="_idIndexMarker1110"/><span class="koboSpan" id="kobo.712.1">highlighted the application name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.713.1">grpc-client</span></strong><span class="koboSpan" id="kobo.714.1">), trace ID (</span><strong class="source-inline"><span class="koboSpan" id="kobo.715.1">64456d940c51e3e2baec07f7448beee6</span></strong><span class="koboSpan" id="kobo.716.1">), and span </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">ID (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">baec07f7448beee6</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.720.1">The command </span><a id="_idIndexMarker1111"/><span class="koboSpan" id="kobo.721.1">should also generate the following logs in the </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">gRPC server:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.723.1">
2023-04-23 23:10:37.821      INFO [</span><strong class="bold"><span class="koboSpan" id="kobo.724.1">grpc-server</span></strong><span class="koboSpan" id="kobo.725.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.726.1">64456d940c51 e3e2baec07f7448beee6</span></strong><span class="koboSpan" id="kobo.727.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.728.1">182159d509ce0714</span></strong><span class="koboSpan" id="kobo.729.1">]     49296 --- [ault-executor-0] brave.Tracer                             : {"traceId":"</span><strong class="bold"><span class="koboSpan" id="kobo.730.1">64456d940c51e3e2baec07f7448beee6</span></strong><span class="koboSpan" id="kobo.731.1">","parentId":"0645e686d869 68b6","id":"182159d509ce0714","kind":"SERVER","name":"com.packtpub.v1 .ChargeService/RetrieveAll","timestamp":1682271637683829,"duration":127229,"localEndpoint":{"serviceName":"unknown","ipv4":"192.168.1.2"},"tags":{"rpc.service":"com.packtpub.v1.ChargeService","rpc.method":"RetrieveAll"}}</span></pre> <p><span class="koboSpan" id="kobo.732.1">Here, the blocks highlighted the application name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">grpc-server</span></strong><span class="koboSpan" id="kobo.734.1">), trace ID (</span><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">64456d940c51e3e2baec07f7448beee6</span></strong><span class="koboSpan" id="kobo.736.1">), and span ID (</span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">182159d509ce0714</span></strong><span class="koboSpan" id="kobo.738.1">). </span><span class="koboSpan" id="kobo.738.2">The trace ID is the same as what is displayed in the gRPC client logs. </span><span class="koboSpan" id="kobo.738.3">The span IDs are different from the gRPC client service because span IDs belong to their respective individual services. </span><span class="koboSpan" id="kobo.738.4">This is how the trace/correlational ID helps you trace the call for requests across different services because it will be propagated to all the services </span><span class="No-Break"><span class="koboSpan" id="kobo.739.1">it involves.</span></span></p>
<p><span class="koboSpan" id="kobo.740.1">Tracing this request was simple as the logs contain just a few lines and are scattered across only two services. </span><span class="koboSpan" id="kobo.740.2">What if you have a few gigabytes of logs scattered across various services? </span><span class="koboSpan" id="kobo.740.3">Then, you can make use of the ELK stack to search the log index using different query criteria. </span><span class="koboSpan" id="kobo.740.4">However, we are going to use the trace ID for </span><span class="No-Break"><span class="koboSpan" id="kobo.741.1">this purpose.</span></span></p>
<p><span class="koboSpan" id="kobo.742.1">First, open the Kibana home page in the browser (</span><a href="http://localhost:5600/"><span class="koboSpan" id="kobo.743.1">http://localhost:5600/</span></a><span class="koboSpan" id="kobo.744.1">). </span><span class="koboSpan" id="kobo.744.2">Then, click on the hamburger </span><a id="_idIndexMarker1112"/><span class="koboSpan" id="kobo.745.1">menu in the top-left corner, as shown in </span><a id="_idIndexMarker1113"/><span class="koboSpan" id="kobo.746.1">the following screenshot. </span><span class="koboSpan" id="kobo.746.2">After that, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.747.1">Discover</span></strong><span class="koboSpan" id="kobo.748.1"> option in the menu </span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">that appears:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer051">
<span class="koboSpan" id="kobo.750.1"><img alt="Figure 12.3 – Kibana hamburger menu" src="image/Figure_12.03_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.751.1">Figure 12.3 – Kibana hamburger menu</span></p>
<p><span class="koboSpan" id="kobo.752.1">This should open the </span><strong class="bold"><span class="koboSpan" id="kobo.753.1">Discover</span></strong><span class="koboSpan" id="kobo.754.1"> page, as shown in the following screenshot. </span><span class="koboSpan" id="kobo.754.2">If this your first time opening the page, you must create an index pattern that will filter out the indexes available </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">in Elasticsearch:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer052">
<span class="koboSpan" id="kobo.756.1"><img alt="Figure 12.4 – Kibana’s Discover page" src="image/Figure_12.04_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.757.1">Figure 12.4 – Kibana’s Discover page</span></p>
<p><span class="koboSpan" id="kobo.758.1">Next, click </span><a id="_idIndexMarker1114"/><span class="koboSpan" id="kobo.759.1">on the </span><strong class="bold"><span class="koboSpan" id="kobo.760.1">Create data view</span></strong><span class="koboSpan" id="kobo.761.1"> button, which </span><a id="_idIndexMarker1115"/><span class="koboSpan" id="kobo.762.1">opens the following page to define the index pattern. </span><span class="koboSpan" id="kobo.762.2">Here, you should enter the index name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">modern-api</span></strong><span class="koboSpan" id="kobo.764.1">) given in the Logstash configuration in the ELK stack’s Docker </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">Compose file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer053">
<span class="koboSpan" id="kobo.766.1"><img alt="Figure 12.5 – Kibana’s Create data view page" src="image/Figure_12.05_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.767.1">Figure 12.5 – Kibana’s Create data view page</span></p>
<p><span class="koboSpan" id="kobo.768.1">Here, you can </span><a id="_idIndexMarker1116"/><span class="koboSpan" id="kobo.769.1">also provide a name for the data view </span><a id="_idIndexMarker1117"/><span class="koboSpan" id="kobo.770.1">and an index pattern. </span><span class="koboSpan" id="kobo.770.2">You can keep the default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">@timestamp</span></strong><span class="koboSpan" id="kobo.772.1"> for </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.773.1">Timestamp field</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.775.1">Then, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.776.1">Save data view to Kibana</span></strong><span class="koboSpan" id="kobo.777.1"> button. </span><span class="koboSpan" id="kobo.777.2">This action will create the data view and may show the following view (if you have called the client’s REST APIs recently; otherwise, it will show no </span><span class="No-Break"><span class="koboSpan" id="kobo.778.1">data view):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer054">
<span class="koboSpan" id="kobo.779.1"><img alt="Figure 12.6 – Kibana’s saved data view page" src="image/Figure_12.06_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.780.1">Figure 12.6 – Kibana’s saved data view page</span></p>
<p><span class="koboSpan" id="kobo.781.1">You can </span><a id="_idIndexMarker1118"/><span class="koboSpan" id="kobo.782.1">add the filter query to the </span><strong class="bold"><span class="koboSpan" id="kobo.783.1">Search</span></strong><span class="koboSpan" id="kobo.784.1"> textbox </span><a id="_idIndexMarker1119"/><span class="koboSpan" id="kobo.785.1">and the </span><strong class="bold"><span class="koboSpan" id="kobo.786.1">Date/Duration</span></strong><span class="koboSpan" id="kobo.787.1"> menu at the top right of the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.788.1">Discover</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.789.1"> page.</span></span></p>
<p><span class="koboSpan" id="kobo.790.1">Query criteria </span><a id="_idIndexMarker1120"/><span class="koboSpan" id="kobo.791.1">can be input using the </span><strong class="bold"><span class="koboSpan" id="kobo.792.1">Kibana Query Language</span></strong><span class="koboSpan" id="kobo.793.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.794.1">KQL</span></strong><span class="koboSpan" id="kobo.795.1">), which allows you to add different comparator and logical operators. </span><span class="koboSpan" id="kobo.795.2">For more information, refer </span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">to </span></span><a href="https://www.elastic.co/guide/en/kibana/master/kuery-query.html"><span class="No-Break"><span class="koboSpan" id="kobo.797.1">https://www.elastic.co/guide/en/kibana/master/kuery-query.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.798.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer055">
<span class="koboSpan" id="kobo.799.1"><img alt="Figure 12.7 – Kibana’s Discover page – filtering" src="image/Figure_12.07_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.800.1">Figure 12.7 – Kibana’s Discover page – filtering</span></p>
<p><span class="koboSpan" id="kobo.801.1">As shown </span><a id="_idIndexMarker1121"/><span class="koboSpan" id="kobo.802.1">in the preceding figure, we have entered criteria (</span><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">traceId: 64457832c37c7ac9f957869d819bc0c6</span></strong><span class="koboSpan" id="kobo.804.1">) (</span><em class="italic"><span class="koboSpan" id="kobo.805.1">1</span></em><span class="koboSpan" id="kobo.806.1">) and kept the </span><strong class="bold"><span class="koboSpan" id="kobo.807.1">Duration</span></strong><span class="koboSpan" id="kobo.808.1"> field as its default (the last 15 minutes) (</span><em class="italic"><span class="koboSpan" id="kobo.809.1">2</span></em><span class="koboSpan" id="kobo.810.1">). </span><span class="koboSpan" id="kobo.810.2">The left-hand side also shows you </span><a id="_idIndexMarker1122"/><span class="koboSpan" id="kobo.811.1">how to select the Elasticsearch index and all the fields available in </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">it (</span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.813.1">3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.815.1">Once you press the </span><em class="italic"><span class="koboSpan" id="kobo.816.1">Enter</span></em><span class="koboSpan" id="kobo.817.1"> key or click on the refresh button after entering the criteria, the search displays the available logs from all the services. </span><span class="koboSpan" id="kobo.817.2">The searched values are highlighted in </span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">yellow (</span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.819.1">4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.821.1">You can also observe that the searched trace ID shows logs from both server and client </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1">services (</span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.823.1">5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.825.1">The searched </span><strong class="bold"><span class="koboSpan" id="kobo.826.1">Discovery</span></strong><span class="koboSpan" id="kobo.827.1"> page also shows the graph that shows the number of calls made during a particular period. </span><span class="koboSpan" id="kobo.827.2">You can generate more logs and reveal any errors, and then you can use different criteria to filter the results and </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">explore further.</span></span></p>
<p><span class="koboSpan" id="kobo.829.1">You can also save the searches and perform more operations, such as customizing the dashboard. </span><span class="koboSpan" id="kobo.829.2">Please refer to </span><a href="https://www.elastic.co/guide/en/kibana/master/index.html"><span class="koboSpan" id="kobo.830.1">https://www.elastic.co/guide/en/kibana/master/index.html</span></a><span class="koboSpan" id="kobo.831.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.832.1">more information.</span></span></p>
<p><span class="koboSpan" id="kobo.833.1">The ELK stack is good for log aggregation, filtering, and debugging using the trace ID and other fields. </span><span class="koboSpan" id="kobo.833.2">However, it </span><a id="_idIndexMarker1123"/><span class="koboSpan" id="kobo.834.1">can’t check the performance </span><a id="_idIndexMarker1124"/><span class="koboSpan" id="kobo.835.1">of API calls – the time taken by the call. </span><span class="koboSpan" id="kobo.835.2">This is especially important when you have a </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">microservice-based application.</span></span></p>
<p><span class="koboSpan" id="kobo.837.1">This is where </span><strong class="bold"><span class="koboSpan" id="kobo.838.1">Zipkin</span></strong><span class="koboSpan" id="kobo.839.1"> (also known as </span><strong class="bold"><span class="koboSpan" id="kobo.840.1">OpenZipkin</span></strong><span class="koboSpan" id="kobo.841.1">), along </span><a id="_idIndexMarker1125"/><span class="koboSpan" id="kobo.842.1">with Micrometer, </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">comes in.</span></span></p>
<h1 id="_idParaDest-283"><a id="_idTextAnchor282"/><span class="koboSpan" id="kobo.844.1">Distributed tracing with Zipkin and Micrometer</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.845.1">Spring Micrometer</span></strong><span class="koboSpan" id="kobo.846.1"> is a utility </span><a id="_idIndexMarker1126"/><span class="koboSpan" id="kobo.847.1">library that collects the metrics generated by the Spring Boot application. </span><span class="koboSpan" id="kobo.847.2">It provides vendor-neutral APIs that allow you </span><a id="_idIndexMarker1127"/><span class="koboSpan" id="kobo.848.1">to export the collected metrics to different </span><a id="_idIndexMarker1128"/><span class="koboSpan" id="kobo.849.1">systems, such as ELK. </span><span class="koboSpan" id="kobo.849.2">It collects different </span><a id="_idIndexMarker1129"/><span class="koboSpan" id="kobo.850.1">types of metrics. </span><span class="koboSpan" id="kobo.850.2">A few of them are </span><a id="_idIndexMarker1130"/><span class="No-Break"><span class="koboSpan" id="kobo.851.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.852.1">Metrics related to the JVM, CPU, </span><span class="No-Break"><span class="koboSpan" id="kobo.853.1">and cache</span></span></li>
<li><span class="koboSpan" id="kobo.854.1">Latencies in Spring MVC, WebFlux, and the </span><span class="No-Break"><span class="koboSpan" id="kobo.855.1">REST client</span></span></li>
<li><span class="koboSpan" id="kobo.856.1">Metrics related to Datasource </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">and HikariCP</span></span></li>
<li><span class="koboSpan" id="kobo.858.1">Uptime and </span><span class="No-Break"><span class="koboSpan" id="kobo.859.1">Tomcat usage</span></span></li>
<li><span class="koboSpan" id="kobo.860.1">Events logged </span><span class="No-Break"><span class="koboSpan" id="kobo.861.1">to Logback</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.862.1">Zipkin, along with Micrometer, helps you not only to trace transactions across multiple service invocations but also to capture the response time taken by each service involved in the distributed transaction. </span><span class="koboSpan" id="kobo.862.2">Zipkin also shows this information using nice graphs. </span><span class="koboSpan" id="kobo.862.3">It helps you to locate the performance bottlenecks and drill down into the specific API call that creates the latency issue. </span><span class="koboSpan" id="kobo.862.4">You can find out the total time taken by the main API call as well as its internal API </span><span class="No-Break"><span class="koboSpan" id="kobo.863.1">call time.</span></span></p>
<p><span class="koboSpan" id="kobo.864.1">Services developed with Spring Boot facilitate their integration with Zipkin. </span><span class="koboSpan" id="kobo.864.2">You just need to make two code changes – the addition of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">zipkin-reporter-brave</span></strong><span class="koboSpan" id="kobo.866.1"> dependency and the addition of the Zipkin </span><span class="No-Break"><span class="koboSpan" id="kobo.867.1">endpoint property.</span></span></p>
<p><span class="koboSpan" id="kobo.868.1">You can make these two changes to both the gRPC server and client, as </span><span class="No-Break"><span class="koboSpan" id="kobo.869.1">shown next:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.870.1">First, add the highlighted dependency to </span><strong class="source-inline"><span class="koboSpan" id="kobo.871.1">build.gradle</span></strong><span class="koboSpan" id="kobo.872.1"> (both the gRPC server and </span><span class="No-Break"><span class="koboSpan" id="kobo.873.1">client projects):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.874.1">
implementation 'net.logstash.logback:logstash-logback-                encoder:7.3'implementation 'io.micrometer:micrometer-tracing-    bridge-brave'implementation '</span><strong class="bold"><span class="koboSpan" id="kobo.875.1">io.zipkin.reporter2</span></strong><span class="koboSpan" id="kobo.876.1">:</span><strong class="bold"><span class="koboSpan" id="kobo.877.1">zipkin-reporter-</span></strong><strong class="bold"><span class="koboSpan" id="kobo.878.1">    brave'</span></strong><span class="koboSpan" id="kobo.879.1">implementation 'org.springframework.boot:    spring-boot-starter-actuator'</span></pre></li> <li><span class="koboSpan" id="kobo.880.1">Next, add </span><a id="_idIndexMarker1131"/><span class="koboSpan" id="kobo.881.1">the following properties to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">application.properties</span></strong><span class="koboSpan" id="kobo.883.1"> file (for both the gRPC server </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">and client):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.885.1">management.zipkin.tracing.endpoint=</span></strong><span class="koboSpan" id="kobo.886.1">                      </span><strong class="bold"><span class="koboSpan" id="kobo.887.1">http://localhost:9411/api/v2/spans</span></strong><span class="koboSpan" id="kobo.888.1">management.tracing.sampling.probability=1.0</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.889.1">The Zipkin </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">tracing.endpoint</span></strong><span class="koboSpan" id="kobo.891.1"> property points to the Zipkin </span><span class="No-Break"><span class="koboSpan" id="kobo.892.1">API endpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.893.1">You are </span><a id="_idIndexMarker1132"/><span class="koboSpan" id="kobo.894.1">done with the changes required in the </span><a id="_idIndexMarker1133"/><span class="koboSpan" id="kobo.895.1">code for publishing the tracing information </span><a id="_idIndexMarker1134"/><span class="koboSpan" id="kobo.896.1">to Zipkin. </span><span class="koboSpan" id="kobo.896.2">Rebuild both the server and client services after making </span><span class="No-Break"><span class="koboSpan" id="kobo.897.1">these changes.</span></span></p>
<p><span class="koboSpan" id="kobo.898.1">Now, let’s install and </span><span class="No-Break"><span class="koboSpan" id="kobo.899.1">start Zipkin.</span></span></p>
<p><span class="koboSpan" id="kobo.900.1">There are </span><a id="_idIndexMarker1135"/><span class="koboSpan" id="kobo.901.1">various ways to install and run Zipkin. </span><span class="koboSpan" id="kobo.901.2">Please refer to </span><a href="https://zipkin.io/pages/quickstart"><span class="koboSpan" id="kobo.902.1">https://zipkin.io/pages/quickstart</span></a><span class="koboSpan" id="kobo.903.1"> to find out about these options. </span><span class="koboSpan" id="kobo.903.2">You can add it in </span><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">docker-compose</span></strong><span class="koboSpan" id="kobo.905.1"> too. </span><span class="koboSpan" id="kobo.905.2">However, for development purposes, we are going to fetch the latest release as a self-contained executable JAR from </span><a href="https://search.maven.org/remote_content?g=io.zipkin&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec"><span class="koboSpan" id="kobo.906.1">https://search.maven.org/remote_content?g=io.zipkin&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec</span></a><span class="koboSpan" id="kobo.907.1"> and then start it using the following command (make sure to change the version in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">JAR</span></strong><span class="koboSpan" id="kobo.909.1"> file based on the </span><span class="No-Break"><span class="koboSpan" id="kobo.910.1">downloaded file):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.911.1">
$ java -jar zipkin-server-2.24.0-exec.jar</span></pre> <p><span class="koboSpan" id="kobo.912.1">The previous command, when executed, will start Zipkin with an in-memory database. </span><span class="koboSpan" id="kobo.912.2">For production purposes, it is recommended to use a persistence store, such </span><span class="No-Break"><span class="koboSpan" id="kobo.913.1">as Elasticsearch.</span></span></p>
<p><span class="koboSpan" id="kobo.914.1">It should start with the default port </span><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">9411</span></strong><span class="koboSpan" id="kobo.916.1"> at </span><strong class="source-inline"><span class="koboSpan" id="kobo.917.1">http://127.0.0.1:9411/</span></strong><span class="koboSpan" id="kobo.918.1"> if executed </span><span class="No-Break"><span class="koboSpan" id="kobo.919.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">localhost</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.921.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.922.1">Once the </span><a id="_idIndexMarker1136"/><span class="koboSpan" id="kobo.923.1">Zipkin server and the ELK stack are up and </span><a id="_idIndexMarker1137"/><span class="koboSpan" id="kobo.924.1">running, you can start both the gRPC server </span><a id="_idIndexMarker1138"/><span class="koboSpan" id="kobo.925.1">and client services and execute the </span><a id="_idIndexMarker1139"/><span class="No-Break"><span class="koboSpan" id="kobo.926.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.927.1">
$ curl http://localhost:8081/charges</span></pre> <p><span class="koboSpan" id="kobo.928.1">This command should print a log like the following log statement in the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">client service:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.930.1">
2023-04-24 11:35:10.313      INFO [grpc-client,64461c16391707ee95478f957f3ccb1d,95478f957f3ccb1d]     62484 --- [nio-8081-exec-2] c.p.m.api.controller.ChargeController    : CustomerId : ab1ab2ab3ab4ab5</span></pre> <p><span class="koboSpan" id="kobo.931.1">Keep the trace ID (</span><strong class="source-inline"><span class="koboSpan" id="kobo.932.1">64461c16391707ee95478f957f3ccb1d</span></strong><span class="koboSpan" id="kobo.933.1"> in the previous output) handy as you are going to use it in the Zipkin UI. </span><span class="koboSpan" id="kobo.933.2">Open the Zipkin home page by accessing </span><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">http://localhost:9411</span></strong><span class="koboSpan" id="kobo.935.1">. </span><span class="koboSpan" id="kobo.935.2">It will look </span><span class="No-Break"><span class="koboSpan" id="kobo.936.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer056">
<span class="koboSpan" id="kobo.937.1"><img alt="Figure 12.8 – Zipkin home page" src="image/Figure_12.08_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.938.1">Figure 12.8 – Zipkin home page</span></p>
<p><span class="koboSpan" id="kobo.939.1">You can </span><a id="_idIndexMarker1140"/><span class="koboSpan" id="kobo.940.1">observe that Zipkin also allows you to run queries. </span><span class="koboSpan" id="kobo.940.2">However, we’ll </span><a id="_idIndexMarker1141"/><span class="koboSpan" id="kobo.941.1">make use of the trace ID. </span><span class="koboSpan" id="kobo.941.2">Paste </span><a id="_idIndexMarker1142"/><span class="koboSpan" id="kobo.942.1">the copied trace ID in the </span><strong class="bold"><span class="koboSpan" id="kobo.943.1">Search by trace ID</span></strong><span class="koboSpan" id="kobo.944.1"> textbox </span><a id="_idIndexMarker1143"/><span class="koboSpan" id="kobo.945.1">in the top-right corner (highlighted in green) and then </span><span class="No-Break"><span class="koboSpan" id="kobo.946.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.947.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.948.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer057">
<span class="koboSpan" id="kobo.949.1"><img alt="Figure 12.9 – Zipkin search result page" src="image/Figure_12.09_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.950.1">Figure 12.9 – Zipkin search result page</span></p>
<p><span class="koboSpan" id="kobo.951.1">In the </span><a id="_idIndexMarker1144"/><span class="koboSpan" id="kobo.952.1">preceding figure, the Zipkin trace ID shows complete </span><a id="_idIndexMarker1145"/><span class="koboSpan" id="kobo.953.1">API call information at the top (</span><em class="italic"><span class="koboSpan" id="kobo.954.1">1</span></em><span class="koboSpan" id="kobo.955.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.956.1">2</span></em><span class="koboSpan" id="kobo.957.1">) if the </span><a id="_idIndexMarker1146"/><span class="koboSpan" id="kobo.958.1">trace ID is available. </span><span class="koboSpan" id="kobo.958.2">In the left-hand side </span><a id="_idIndexMarker1147"/><span class="koboSpan" id="kobo.959.1">section, it shows all the corresponding API calls with a hierarchy, which shows the individual call times in a graphical way (</span><em class="italic"><span class="koboSpan" id="kobo.960.1">3</span></em><span class="koboSpan" id="kobo.961.1">). </span><span class="koboSpan" id="kobo.961.2">These API call rows are selectable. </span><span class="koboSpan" id="kobo.961.3">Selected call details are displayed on the right-hand </span><span class="No-Break"><span class="koboSpan" id="kobo.962.1">side (</span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.963.1">4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.965.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.966.1">Annotation</span></strong><span class="koboSpan" id="kobo.967.1"> section on the right-hand side displays the individual call start and finish times, as shown in the following screenshot for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">grpc-server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.969.1"> call:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer058">
<span class="koboSpan" id="kobo.970.1"><img alt="Figure 12.10 – Annotation details" src="image/Figure_12.10_B19349.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.971.1">Figure 12.10 – Annotation details</span></p>
<p><span class="koboSpan" id="kobo.972.1">Time </span><a id="_idIndexMarker1148"/><span class="koboSpan" id="kobo.973.1">tracking at a granular level for each distributed </span><a id="_idIndexMarker1149"/><span class="koboSpan" id="kobo.974.1">API call allows you to identify the latency </span><a id="_idIndexMarker1150"/><span class="koboSpan" id="kobo.975.1">issues and relative time tracking for </span><a id="_idIndexMarker1151"/><span class="No-Break"><span class="koboSpan" id="kobo.976.1">performance tuning.</span></span></p>
<h1 id="_idParaDest-284"><a id="_idTextAnchor283"/><span class="koboSpan" id="kobo.977.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.978.1">In this chapter, you learned how the trace/correlation ID is important and how it can be set up using Micrometer with Brave. </span><span class="koboSpan" id="kobo.978.2">You can use these generated IDs to find the relevant logs and API call durations. </span><span class="koboSpan" id="kobo.978.3">You integrated the Spring Boot services with the ELK stack </span><span class="No-Break"><span class="koboSpan" id="kobo.979.1">and Zipkin.</span></span></p>
<p><span class="koboSpan" id="kobo.980.1">You also implemented extra code and configurations, which are required for enabling distributed tracing for </span><span class="No-Break"><span class="koboSpan" id="kobo.981.1">gRPC-based services.</span></span></p>
<p><span class="koboSpan" id="kobo.982.1">You acquired log aggregation and distributed tracing skills using Micrometer, Brave, the ELK stack, </span><span class="No-Break"><span class="koboSpan" id="kobo.983.1">and Zipkin.</span></span></p>
<p><span class="koboSpan" id="kobo.984.1">In the next chapter, you are going to learn about the fundamentals of </span><span class="No-Break"><span class="koboSpan" id="kobo.985.1">GraphQL APIs.</span></span></p>
<h1 id="_idParaDest-285"><a id="_idTextAnchor284"/><span class="koboSpan" id="kobo.986.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.987.1">What is the difference between the trace ID and </span><span class="No-Break"><span class="koboSpan" id="kobo.988.1">span ID?</span></span></li>
<li><span class="koboSpan" id="kobo.989.1">Should you use a broker between services that generate the logs and the ELK stack? </span><span class="koboSpan" id="kobo.989.2">If </span><span class="No-Break"><span class="koboSpan" id="kobo.990.1">yes, why?</span></span></li>
<li><span class="koboSpan" id="kobo.991.1">How does </span><span class="No-Break"><span class="koboSpan" id="kobo.992.1">Zipkin work?</span></span></li>
</ol>
<h1 id="_idParaDest-286"><a id="_idTextAnchor285"/><span class="koboSpan" id="kobo.993.1">Answers</span></h1>
<ol>
<li value="1"><span class="koboSpan" id="kobo.994.1">Trace IDs and span IDs are created when the distributed transaction is initiated. </span><span class="koboSpan" id="kobo.994.2">A trace ID is generated for the main API call by the receiving service using Spring Cloud Sleuth. </span><span class="koboSpan" id="kobo.994.3">A trace ID is generated only once for each distributed call. </span><span class="koboSpan" id="kobo.994.4">Span IDs are generated by all the services participating in the distributed transaction. </span><span class="koboSpan" id="kobo.994.5">A trace ID is a correlation ID that will be common across the service for a call that requires a distributed transaction. </span><span class="koboSpan" id="kobo.994.6">Each service will have its own span ID for each of the </span><span class="No-Break"><span class="koboSpan" id="kobo.995.1">API calls.</span></span></li>
<li><span class="koboSpan" id="kobo.996.1">Yes, a broker such as Kafka, RabbitMQ, or Redis allows robust persistence of logs and removes the risk of losing log data in unavoidable circumstances. </span><span class="koboSpan" id="kobo.996.2">It also performs better and can handle sudden spikes </span><span class="No-Break"><span class="koboSpan" id="kobo.997.1">of data.</span></span></li>
<li><span class="koboSpan" id="kobo.998.1">A tracer such as Micrometer with Brave or Spring Cloud Sleuth (</span><em class="italic"><span class="koboSpan" id="kobo.999.1">which performs instrumentation</span></em><span class="koboSpan" id="kobo.1000.1">) does two jobs – records the time and metadata of the call being performed, and propagates the trace IDs to other services participating in the distributed transaction. </span><span class="koboSpan" id="kobo.1000.2">Then, it pushes the tracing information to Zipkin using a </span><em class="italic"><span class="koboSpan" id="kobo.1001.1">reporter</span></em><span class="koboSpan" id="kobo.1002.1"> once the scan completes. </span><span class="koboSpan" id="kobo.1002.2">The reporter uses </span><em class="italic"><span class="koboSpan" id="kobo.1003.1">transport</span></em><span class="koboSpan" id="kobo.1004.1"> such as HTTP and Kafka to publish the data </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">in Zipkin.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.1006.1">The </span><em class="italic"><span class="koboSpan" id="kobo.1007.1">collector</span></em><span class="koboSpan" id="kobo.1008.1"> in Zipkin collects the data sent by the transporters from the running services and passes it to the storage layer. </span><span class="koboSpan" id="kobo.1008.2">The storage persists the data. </span><span class="koboSpan" id="kobo.1008.3">Persisted data is exposed by the Zipkin APIs. </span><span class="koboSpan" id="kobo.1008.4">The Zipkin UI calls these APIs to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.1009.1">information graphically:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.1010.1"><img alt="" src="image/Figure_12.11_B19349.jpg"/></span>
</div>
</div>
<h1 id="_idParaDest-287"><a id="_idTextAnchor286"/><span class="koboSpan" id="kobo.1011.1">Further reading</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.1012.1">Elasticsearch </span><span class="No-Break"><span class="koboSpan" id="kobo.1013.1">documentation: </span></span><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.1014.1">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</span></span></a></li>
<li><span class="koboSpan" id="kobo.1015.1">Kibana </span><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">documentation: </span></span><a href="https://www.elastic.co/guide/en/kibana/master/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.1017.1">https://www.elastic.co/guide/en/kibana/master/index.html</span></span></a></li>
<li><span class="koboSpan" id="kobo.1018.1">Kibana Query </span><span class="No-Break"><span class="koboSpan" id="kobo.1019.1">Language: </span></span><a href="https://www.elastic.co/guide/en/kibana/master/kuery-query.html"><span class="No-Break"><span class="koboSpan" id="kobo.1020.1">https://www.elastic.co/guide/en/kibana/master/kuery-query.html</span></span></a></li>
<li><span class="koboSpan" id="kobo.1021.1">Logstash </span><span class="No-Break"><span class="koboSpan" id="kobo.1022.1">documentation: </span></span><a href="https://www.elastic.co/guide/en/logstash/master/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.1023.1">https://www.elastic.co/guide/en/logstash/master/index.html</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1024.1">Elasticsearch 8.x Cookbook – Fifth </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1025.1">Edition</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1026.1">: </span></span><a href="https://www.packtpub.com/product/elasticsearch-8x-cookbook-fifth-edition/9781801079815"><span class="No-Break"><span class="koboSpan" id="kobo.1027.1">https://www.packtpub.com/product/elasticsearch-8x-cookbook-fifth-edition/9781801079815</span></span></a></li>
<li><span class="koboSpan" id="kobo.1028.1">Zipkin </span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1">documentation: </span></span><a href="https://zipkin.io/pages/quickstart"><span class="No-Break"><span class="koboSpan" id="kobo.1030.1">https://zipkin.io/pages/quickstart</span></span></a></li>
</ul>
</div>


<div class="Content" id="_idContainer061">
<h1 id="_idParaDest-288" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor287"/><span class="koboSpan" id="kobo.1.1">Part 4 – GraphQL</span></h1>
<p><span class="koboSpan" id="kobo.2.1">In this part, you will learn about GraphQL-based API development. </span><span class="koboSpan" id="kobo.2.2">After completing this section, you will know the in-depth fundamentals of GraphQL, be able to differentiate between REST, reactive, and gRPC APIs, in the context of GraphQL thoroughly, and understand when to use which API style. </span><span class="koboSpan" id="kobo.2.3">You will also learn how to design the GraphQL schema, which will be used to generate Java code. </span><span class="koboSpan" id="kobo.2.4">Finally, you will learn how to write data fetchers and loaders to resolve query fields to serve the GraphQL </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">API requests.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This part contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><a href="B19349_13.xhtml#_idTextAnchor288"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 13</span></em></a><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Getting Started with GraphQL</span></em></li>
<li><a href="B19349_14.xhtml#_idTextAnchor313"><em class="italic"><span class="koboSpan" id="kobo.9.1">Chapter 14</span></em></a><span class="koboSpan" id="kobo.10.1">, </span><em class="italic"><span class="koboSpan" id="kobo.11.1">GraphQL API Development and Testing</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer062">
</div>
</div>
<div>
<div class="Basic-Graphics-Frame" id="_idContainer063">
</div>
</div>
</body></html>