<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer124">
<h1 class="chapter-number" id="_idParaDest-341"><a id="_idTextAnchor512"/>16</h1>
<h1 id="_idParaDest-342"><a id="_idTextAnchor513"/>Migration to Spring Security 6</h1>
<p>In this final chapter, we will review information relating to common migration issues when moving from <strong class="bold">Spring Security 5.x</strong> to <strong class="bold">Spring Security 6.x</strong>. We’ll spend much more time discussing the differences between these two versions because this is what most users will struggle with, as the updates from <strong class="source-inline">Spring Security 5.x</strong> to <strong class="source-inline">Spring Security 6.x</strong> contain a lot of <span class="No-Break">non-passive refactoring.</span></p>
<p>At the end of the chapter, we will also highlight some of the new features that can be found in <strong class="source-inline">Spring Security 6.x</strong>. However, we do not explicitly cover changes from <strong class="source-inline">Spring Security 5.x</strong> to <strong class="source-inline">Spring Security 6.x</strong>. This is because by explaining the differences between this two versions, users should be able to update to <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x</strong></span><span class="No-Break">.</span></p>
<p>You may be planning to migrate an existing application to <strong class="source-inline">Spring Security 6.x </strong>or you may be trying to add functionality to a <strong class="source-inline">Spring Security 5.x</strong> application and are looking for guidance in the pages of this book. We’ll try to address both of your concerns in <span class="No-Break">this chapter.</span></p>
<p>First, we’ll run through the important differences between <strong class="source-inline">Spring Security 5.x </strong>and <strong class="source-inline">6.x</strong>—both in terms of features <span class="No-Break">and configuration.</span></p>
<p>Second, we’ll provide some guidance on mapping configuration or class name changes. This will better enable you to translate the examples in the book from <strong class="source-inline">Spring Security 6.x</strong> back to <strong class="source-inline">Spring Security 5.x</strong> (<span class="No-Break">where applicable).</span></p>
<p class="callout-heading">Important note</p>
<p class="callout"><strong class="source-inline">Spring Security 6.x</strong> mandates a migration to <strong class="bold">Spring Framework 6</strong> and <strong class="bold">Java 17</strong> <span class="No-Break">or greater.</span></p>
<p class="callout">Be aware that in many cases, migrating these other components may have a greater impact on your application than the upgrade of <span class="No-Break"><strong class="source-inline">Spring Security</strong></span><span class="No-Break">!</span></p>
<p><a id="_idTextAnchor514"/></p>
<p>During this chapter, we will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Reviewing important enhancements in <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x</strong></span><span class="No-Break">.</span></li>
<li>Understanding configuration changes required in your existing <span class="No-Break">Spring version.</span></li>
<li>Reviewing <strong class="source-inline">Spring Security 5.x</strong> applications when moving them to <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x</strong></span><span class="No-Break">.</span></li>
<li>Illustrating the overall movement of important classes and packages in <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x</strong></span><span class="No-Break">.</span></li>
<li>Highlighting some of the new features found in <strong class="source-inline">Spring Security 6.x</strong>. Once you have completed the review of this chapter, you will be in a good position to migrate an existing application from <strong class="source-inline">Spring Security 5.x</strong> to <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x</strong></span><span class="No-Break">.</span></li>
<li>Migrating from <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 5.x</strong></span><span class="No-Break">.</span></li>
</ul>
<p>This chapter’s code in action link is <span class="No-Break">here: </span><a href="https://packt.link/wD0Sk"><span class="No-Break">https://packt.link/wD0Sk</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-343"><a id="_idTextAnchor515"/>Exploit Protection</h1>
<p>In <strong class="source-inline">Spring Security 5.8</strong>, the <a id="_idIndexMarker1099"/>default <strong class="source-inline">CsrfTokenRequestHandler</strong> responsible for providing the <strong class="source-inline">CsrfToken</strong> to the application is <strong class="source-inline">CsrfTokenRequestAttributeHandler</strong>. The default setting for the field <strong class="source-inline">csrfRequestAttributeName</strong> is <strong class="source-inline">null</strong>, leading to the loading of the CSRF token on <span class="No-Break">every request.</span></p>
<p>Examples of situations where reading the session should be deemed unnecessary include endpoints explicitly marked with <strong class="source-inline">permitAll()</strong>, such as static assets, static HTML pages, and single-page applications hosted under the <span class="No-Break">same domain/server.</span></p>
<p>In <strong class="source-inline">Spring Security 6</strong>, <strong class="source-inline">csrfRequestAttributeName</strong> now defaults to <strong class="source-inline">_csrf</strong>. If you had configured the following solely for the purpose of transitioning to version 6.0, you can now safely <span class="No-Break">remove it:</span></p>
<pre class="source-code">
requestHandler.setCsrfRequestAttributeName("_csrf");</pre> <p>Now that we have explored how to define the <strong class="source-inline">CsrfToken</strong>, we will explore how to protect against <span class="No-Break">CSRF attacks.</span></p>
<h2 id="_idParaDest-344"><a id="_idTextAnchor516"/>Protecting against CSRF attacks</h2>
<p>In <strong class="source-inline">Spring Security 5.8</strong>, the <a id="_idIndexMarker1100"/>default <strong class="source-inline">CsrfTokenRequestHandler</strong> facilitating the availability of <strong class="source-inline">CsrfToken</strong> to the application is <strong class="source-inline">CsrfTokenRequestAttributeHandler</strong>. <strong class="source-inline">XorCsrfTokenRequestAttributeHandler</strong> was introduced to enable opting into <strong class="source-inline">CSRF </strong><span class="No-Break"><strong class="source-inline">attack support</strong></span><span class="No-Break">.</span></p>
<p>In Spring Security 6, <strong class="source-inline">XorCsrfTokenRequestAttributeHandler</strong> becomes the default <strong class="source-inline">CsrfTokenRequestHandler</strong> for providing the <strong class="source-inline">CsrfToken</strong>. If you had configured <strong class="source-inline">XorCsrfTokenRequestAttributeHandler</strong> solely for the purpose of transitioning to version 6.0, it can now be <span class="No-Break">safely removed.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">If you’ve set the <strong class="source-inline">csrfRequestAttributeName</strong> to <strong class="source-inline">null</strong> to exclude deferred tokens, or if you’ve established a <strong class="source-inline">CsrfTokenRequestHandler</strong> for any particular purpose, you can maintain the <span class="No-Break">current configuration.</span></p>
<h2 id="_idParaDest-345"><a id="_idTextAnchor517"/>CSRF attack with WebSocket support</h2>
<p>In <strong class="source-inline">Spring Security 5.8</strong>, the default <strong class="source-inline">ChannelInterceptor</strong> used to provide the <strong class="source-inline">CsrfToken</strong> with<a id="_idIndexMarker1101"/> WebSocket security is <strong class="source-inline">CsrfChannelInterceptor</strong>. <strong class="source-inline">XorCsrfChannelInterceptor</strong> was introduced to enable opting into <strong class="bold">CSRF </strong><span class="No-Break"><strong class="bold">attack support</strong></span><span class="No-Break">.</span></p>
<p>In <strong class="source-inline">Spring Security 6</strong>, <strong class="source-inline">XorCsrfChannelInterceptor</strong> becomes the default <strong class="source-inline">ChannelInterceptor</strong> for providing the <strong class="source-inline">CsrfToken</strong>. If you had configured <strong class="source-inline">XorCsrfChannelInterceptor</strong> solely for the purpose of transitioning to version 6.0, it can now be <span class="No-Break">safely removed.</span></p>
<p>After exploring how to protect against CSRF attacks, we will deep dive into configuration <span class="No-Break">migration options.</span></p>
<h1 id="_idParaDest-346"><a id="_idTextAnchor518"/>Configuration Migrations</h1>
<p>The subsequent sections pertain to alterations in configuring <strong class="source-inline">HttpSecurity</strong>, <strong class="source-inline">WebSecurity</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">AuthenticationManager</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-347"><a id="_idTextAnchor519"/>Adding @Configuration annotation to @Enable* annotations</h2>
<p>In <a id="_idIndexMarker1102"/>version 6.0, the <a id="_idIndexMarker1103"/>annotations <strong class="source-inline">@EnableWebSecurity</strong>, <strong class="source-inline">@EnableMethodSecurity</strong>, <strong class="source-inline">@EnableGlobalMethodSecurity</strong>, and <strong class="source-inline">@EnableGlobalAuthentication</strong> no longer <span class="No-Break">include </span><span class="No-Break"><strong class="source-inline">@Configuration</strong></span><span class="No-Break">.</span></p>
<p>For instance, <strong class="source-inline">@EnableWebSecurity</strong> will be <span class="No-Break">modified from:</span></p>
<pre class="source-code">
@EnableWebSecurity
public class SecurityConfig {
    // ...
}</pre> <p><span class="No-Break">to:</span></p>
<pre class="source-code">
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    // ...
}</pre> <p>To<a id="_idIndexMarker1104"/> adapt to this change, wherever<a id="_idIndexMarker1105"/> you utilize these annotations, you might need to <span class="No-Break">add </span><span class="No-Break"><strong class="source-inline">@Configuration</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-348"><a id="_idTextAnchor520"/>Using the new requestMatchers methods</h2>
<p>In <strong class="source-inline">Spring Security 5.8</strong>, the <a id="_idIndexMarker1106"/>methods <strong class="source-inline">antMatchers</strong>, <strong class="source-inline">mvcMatchers</strong>, and <strong class="source-inline">regexMatchers</strong> were deprecated in favor of the new <span class="No-Break"><strong class="source-inline">requestMatchers</strong></span><span class="No-Break"> methods.</span></p>
<p>The introduction of the new <strong class="source-inline">requestMatchers</strong> methods extended to <strong class="source-inline">authorizeHttpRequests</strong>, <strong class="source-inline">authorizeRequests</strong>, CSRF configuration, <strong class="source-inline">WebSecurityCustomizer</strong>, and other locations with specialized <strong class="source-inline">RequestMatcher</strong> methods. As of <strong class="source-inline">Spring Security 6</strong>, the deprecated methods have <span class="No-Break">been removed.</span></p>
<p>The new methods come with more secure defaults by automatically selecting the most suitable <strong class="source-inline">RequestMatcher</strong> implementation for <span class="No-Break">your application.</span></p>
<p>To provide a summary, <span class="No-Break">these methods:</span></p>
<ul>
<li>Opt for the <strong class="source-inline">MvcRequestMatcher</strong> implementation if your application includes Spring MVC in <span class="No-Break">the classpath.</span></li>
<li>Fall back to the <strong class="source-inline">AntPathRequestMatcher</strong> implementation, in the absence of Spring MVC, aligning their behavior with the Kotlin <span class="No-Break">equivalent methods.</span></li>
</ul>
<p>The following table should guide you in your <span class="No-Break">migration journey:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-10">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Security 5</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Security 6</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">antMatchers("/api/admin/**")</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">requestMatchers("/api/admin/**")</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">mvcMatchers("/admin/**")</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">requestMatchers("/admin/**")</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">mvcMatchers("/admin").servletPath("/path")</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">requestMatchers(mvcMatcherBuilder.pattern("/admin"))</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 16.1 – Migration to the new requestMatchers</p>
<p>If you encounter difficulties with the new <strong class="source-inline">requestMatchers</strong> methods, you have the option to revert to the <strong class="source-inline">RequestMatcher</strong> implementation you were previously using. For instance, if you prefer to continue using <strong class="source-inline">AntPathRequestMatcher</strong> and <strong class="source-inline">RegexRequestMatcher</strong> implementations, you can utilize the <strong class="source-inline">requestMatchers</strong> method that<a id="_idIndexMarker1107"/> accepts a <span class="No-Break"><strong class="source-inline">RequestMatcher</strong></span><span class="No-Break"> instance:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-7">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Security 5</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Security 6</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">antMatchers("/api/admin/**")</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">requestMatchers(antMatcher("/user/**"))</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 16.2 – Alternatives with the new requestMatchers</p>
<p class="callout-heading">Important note</p>
<p class="callout">Please note that the provided example utilizes static factory methods from <strong class="source-inline">AntPathRequestMatcher</strong> and <strong class="source-inline">RegexRequestMatcher</strong> to <span class="No-Break">enhance readability.</span></p>
<p>When you are employing the <strong class="source-inline">WebSecurityCustomizer</strong> interface, you can substitute the deprecated <span class="No-Break"><strong class="source-inline">antMatchers</strong></span><span class="No-Break"> methods:</span></p>
<pre class="source-code">
@Bean
public WebSecurityCustomizer webSecurityCustomizer() {
    return web -&gt; web.ignoring().antMatchers("/ignore1", "/ignore2");
}</pre> <p>with their corresponding <span class="No-Break"><strong class="source-inline">requestMatchers</strong></span><span class="No-Break"> alternatives:</span></p>
<pre class="source-code">
@Bean
public WebSecurityCustomizer webSecurityCustomizer() {
    return web -&gt; web.ignoring().requestMatchers("/ignore1", "/ignore2");
}</pre> <p>Similarly, if <a id="_idIndexMarker1108"/>you are customizing the <strong class="source-inline">CSRF</strong> configuration to exclude specific paths, you can substitute the deprecated methods with the <span class="No-Break"><strong class="source-inline">requestMatchers</strong></span><span class="No-Break"> counterparts.</span></p>
<h2 id="_idParaDest-349"><a id="_idTextAnchor521"/>Using the new securityMatchers methods</h2>
<p>In <strong class="source-inline">Spring Security 5.8</strong>, the <strong class="source-inline">antMatchers</strong>, <strong class="source-inline">mvcMatchers</strong>, and <strong class="source-inline">requestMatchers</strong> methods<a id="_idIndexMarker1109"/> in <strong class="source-inline">HttpSecurity</strong> underwent deprecation in favor of the new <span class="No-Break"><strong class="source-inline">securityMatchers</strong></span><span class="No-Break"> methods.</span></p>
<p>It’s important to note that these methods differ from the <strong class="source-inline">authorizeHttpRequests</strong> methods, which were deprecated in favor of the <strong class="source-inline">requestMatchers</strong> methods. However, the <strong class="source-inline">securityMatchers</strong> methods share similarities with the <strong class="source-inline">requestMatchers</strong> methods in that they automatically select the most suitable <strong class="source-inline">RequestMatcher</strong> implementation for <span class="No-Break">your application.</span></p>
<p>To elaborate, the <span class="No-Break">new methods:</span></p>
<ul>
<li>Opt for the <strong class="source-inline">MvcRequestMatcher</strong> implementation if your application includes Spring MVC in <span class="No-Break">the classpath.</span></li>
<li>Fall back to the <strong class="source-inline">AntPathRequestMatcher</strong> implementation, in the absence of Spring MVC, aligning their behavior with the Kotlin equivalent methods. The introduction of <strong class="source-inline">securityMatchers</strong> methods also serves to prevent confusion with the <strong class="source-inline">requestMatchers</strong> methods <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">authorizeHttpRequests</strong></span><span class="No-Break">.</span></li>
</ul>
<p>The following table <a id="_idIndexMarker1110"/>should guide you in your migration journey where <strong class="source-inline">http</strong> is of <span class="No-Break">type </span><span class="No-Break"><strong class="source-inline">HttpSecurity</strong></span><span class="No-Break">:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table003-4">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Security 5</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Security 6</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">http.antMatcher("/api/**")</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">http.securityMatcher("/api/**")</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">http.requestMatcher(new MyCustomRequestMatcher())</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">http.securityMatcher(new MyCustomRequestMatcher())</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">http</strong></span></p>
<p><strong class="source-inline" lang="en-US" xml:lang="en-US">.requestMatchers((matchers) -&gt; </strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">matchers</strong></span></p>
<p><strong class="source-inline" lang="en-US" xml:lang="en-US">.</strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">antMatchers("/api/**", "/app/**")</strong></span></p>
<p><strong class="source-inline" lang="en-US" xml:lang="en-US">.</strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">mvcMatchers("/admin/**")</strong></span></p>
<p><strong class="source-inline" lang="en-US" xml:lang="en-US">.</strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">requestMatchers(new MyCustomRequestMatcher()))</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline" lang="en-US" xml:lang="en-US">http.securityMatchers((matchers) -&gt; matchers.requestMatchers("/api/**", "/</strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">app/**", "/admin/**")</strong></span></p>
<p><strong class="source-inline" lang="en-US" xml:lang="en-US">.</strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">requestMatchers(new MyCustomRequestMatcher()))</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 16.3 – Migration to the new securityMatchers</p>
<p>If you encounter challenges with the automatic selection of <strong class="source-inline">RequestMatcher</strong> implementation by the <strong class="source-inline">securityMatchers</strong> methods, you have the option to manually choose the <strong class="source-inline">RequestMatcher</strong> <span class="No-Break">implementation yourself:</span></p>
<pre class="source-code">
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
          .securityMatchers(matchers -&gt; matchers
                .requestMatchers(antMatcher("/api/**"), antMatcher("/app/**"))
          );
    return http.build();
}</pre> <p>After exploring the new <strong class="source-inline">securityMatchers</strong> methods, we’ll now proceed to examine the process of replacing <strong class="source-inline">WebSecurityConfigurerAdapter</strong> in <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-350"><a id="_idTextAnchor522"/>Replacing the WebSecurityConfigurerAdapter class</h2>
<p>The <strong class="source-inline">WebSecurityConfigurerAdapter</strong> class <a id="_idIndexMarker1111"/>was deprecated and then removed in <strong class="source-inline">Spring Security 6.x</strong>. In the following sub-sections, we will explore the impacts of this <span class="No-Break">major change.</span></p>
<h3>Exposing a SecurityFilterChain Bean</h3>
<p>In <strong class="source-inline">Spring Security 5.4</strong>, a new feature<a id="_idIndexMarker1112"/> was introduced allowing the <a id="_idIndexMarker1113"/>publication of a <strong class="source-inline">SecurityFilterChain</strong> bean instead of extending <strong class="source-inline">WebSecurityConfigurerAdapter</strong>. However, in version 6.0, <strong class="source-inline">WebSecurityConfigurerAdapter</strong> has been removed. To accommodate this change, you can substitute <span class="No-Break">constructs resembling:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
       http
             .authorizeHttpRequests(authorize -&gt; authorize
                   .anyRequest().authenticated()
             )
             .httpBasic(withDefaults());
    }
}</pre> <p><span class="No-Break">with:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfiguration {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
       http
             .authorizeHttpRequests((authorize) -&gt; authorize
                   .anyRequest().authenticated()
             )
             .httpBasic(withDefaults());
       return http.build();
    }
}</pre> <h3>Exposing a WebSecurityCustomizer Bean</h3>
<p><strong class="source-inline">Spring Security 5.4</strong> introduced <strong class="source-inline">WebSecurityCustomizer</strong> as<a id="_idIndexMarker1114"/> a replacement<a id="_idIndexMarker1115"/> for <strong class="source-inline">configure(WebSecurity web)</strong> in <strong class="source-inline">WebSecurityConfigurerAdapter</strong>. To prepare for its removal, you can update code similar to <span class="No-Break">the following:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {
    @Override
    public void configure(WebSecurity web) {
       web.ignoring().antMatchers("/ignore1", "/ignore2");
    }
}</pre> <p><span class="No-Break">with:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfiguration {
    @Bean
    public WebSecurityCustomizer webSecurityCustomizer() {
       return (web) -&gt; web.ignoring().antMatchers("/ignore1", "/ignore2");
    }
}</pre> <h3>Exposing an AuthenticationManager Bean</h3>
<p>With the <a id="_idIndexMarker1116"/>removal<a id="_idIndexMarker1117"/> of <strong class="source-inline">WebSecurityConfigurerAdapter</strong>, the <strong class="source-inline">configure(AuthenticationManagerBuilder)</strong> method is <span class="No-Break">also eliminated.</span></p>
<h3>LDAP Authentication</h3>
<p>When <a id="_idIndexMarker1118"/>using <strong class="source-inline">auth.ldapAuthentication()</strong> for <strong class="bold">Lightweight Directory Access Protocol</strong> (<strong class="bold">LDAP</strong>) authentication<a id="_idIndexMarker1119"/> support, you <a id="_idIndexMarker1120"/>can <span class="No-Break">replace this:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
       auth
             .ldapAuthentication()
             .userDetailsContextMapper(new PersonContextMapper())
             .userDnPatterns("uid={0},ou=people")
             .contextSource()
             .port(0);
    }
}</pre> <p><span class="No-Break">with:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfiguration {
    @Bean
    public EmbeddedLdapServerContextSourceFactoryBean contextSourceFactoryBean() {
       EmbeddedLdapServerContextSourceFactoryBean contextSourceFactoryBean =
             EmbeddedLdapServerContextSourceFactoryBean.fromEmbeddedLdapServer();
       contextSourceFactoryBean.setPort(0);
       return contextSourceFactoryBean;
    }
    @Bean
    AuthenticationManager ldapAuthenticationManager(BaseLdapPathContextSource contextSource) {
       LdapBindAuthenticationManagerFactory factory =
             new LdapBindAuthenticationManagerFactory(contextSource);
       factory.setUserDnPatterns("uid={0},ou=people");
       factory.setUserDetailsContextMapper(new PersonContextMapper());
       return factory.createAuthenticationManager();
    }
}</pre> <h3>JDBC Authentication</h3>
<p>If you are currently<a id="_idIndexMarker1121"/> utilizing <strong class="source-inline">auth.jdbcAuthentication()</strong> for <strong class="bold">Java Database Connectivity</strong> (<strong class="bold">JDBC</strong>) authentication <a id="_idIndexMarker1122"/>support, you <a id="_idIndexMarker1123"/><span class="No-Break">can substitute:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    private final DataSource dataSource;
    public SecurityConfig(DataSource dataSource) {
       this.dataSource = dataSource;
    }
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
       UserDetails user = User.withDefaultPasswordEncoder()
             .username("user")
             .password("password")
             .roles("USER")
             .build();
       auth.jdbcAuthentication()
             .withDefaultSchema()
             .dataSource(this.dataSource)
             .withUser(user);
    }
}</pre> <p><span class="No-Break">with:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfig {
    private final DataSource dataSource;
    public SecurityConfig(DataSource dataSource) {
       this.dataSource = dataSource;
    }
    @Bean
    public UserDetailsManager users(DataSource dataSource) {
       UserDetails user = User.withDefaultPasswordEncoder()
             .username("user")
             .password("password")
             .roles("USER")
             .build();
       JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);
       users.createUser(user);
       return users;
    }
}</pre> <h3>In-Memory Authentication</h3>
<p>If you are currently <a id="_idIndexMarker1124"/>utilizing <strong class="source-inline">auth.inMemoryAuthentication()</strong> for <a id="_idIndexMarker1125"/>in-memory <strong class="source-inline">Authentication</strong> support, you <span class="No-Break">can replace:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
       UserDetails user = User.withDefaultPasswordEncoder()
             .username("user")
             .password("password")
             .roles("USER")
             .build();
       auth.inMemoryAuthentication()
             .withUser(user);
    }
}</pre> <p><span class="No-Break">with:</span></p>
<pre class="source-code">
@Configuration
public class SecurityConfig {
    @Bean
    public InMemoryUserDetailsManager userDetailsService() {
       UserDetails user = User.withDefaultPasswordEncoder()
             .username("user")
             .password("password")
             .roles("USER")
             .build();
       return new InMemoryUserDetailsManager(user);
    }
}</pre> <p>After exploring the impacts of <strong class="source-inline">WebSecurityConfigurerAdapter</strong> removal, we will delve into updates regarding <span class="No-Break">password encoding.</span></p>
<h2 id="_idParaDest-351"><a id="_idTextAnchor523"/>Password Encoding Updates</h2>
<p>In <strong class="source-inline">Spring Security 6.0</strong>, the minimum<a id="_idIndexMarker1126"/> requirements<a id="_idIndexMarker1127"/> for <a id="_idIndexMarker1128"/>password encoding<a id="_idIndexMarker1129"/> have been revised for <strong class="bold">PBKDF2</strong>, <strong class="bold">SCrypt</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="bold">Argon2</strong></span><span class="No-Break">.</span></p>
<p>If you use the <a id="_idIndexMarker1130"/>default password encoder, there’s no need to follow any preparatory steps, and you can skip <span class="No-Break">this section.</span></p>
<h3>Pbkdf2PasswordEncoder updates</h3>
<p>If <a id="_idIndexMarker1131"/>you are <a id="_idIndexMarker1132"/>using <strong class="source-inline">Pbkdf2PasswordEncoder</strong>, the constructors have been substituted with static factories that correspond to the <strong class="source-inline">Spring Security</strong> version relevant to the <span class="No-Break">provided settings:</span></p>
<pre class="source-code">
@Bean
PasswordEncoder passwordEncoder2() {
    return Pbkdf2PasswordEncoder.defaultsForSpringSecurity_v5_5();
}</pre> <p>And if you have custom settings, use the constructor that specifies <span class="No-Break">all settings:</span></p>
<pre class="source-code">
@Bean
PasswordEncoder passwordEncoder() {
    return new Pbkdf2PasswordEncoder("secret".getBytes(UTF_8), 16, 185000, 256);
}</pre> <h3>SCryptPasswordEncoder Updates</h3>
<p>If you are <a id="_idIndexMarker1133"/>employing <strong class="source-inline">SCryptPasswordEncoder</strong>, the constructors have been substituted with static factories that <a id="_idIndexMarker1134"/>correspond to the <strong class="source-inline">Spring Security</strong> version associated with the <span class="No-Break">provided settings.</span></p>
<p>Your initial step should be to modify the <span class="No-Break">deprecated constructor:</span></p>
<pre class="source-code">
@Bean
PasswordEncoder passwordEncoder() {
    return SCryptPasswordEncoder.defaultsForSpringSecurity_v4_1();
}</pre> <h3>Argon2PasswordEncoder Updates</h3>
<p>If you are<a id="_idIndexMarker1135"/> using <strong class="source-inline">Argon2PasswordEncoder</strong>, the<a id="_idIndexMarker1136"/> constructors have been substituted with static factories that correspond to the <strong class="source-inline">Spring Security</strong> version associated with the provided settings. <span class="No-Break">For example:</span></p>
<pre class="source-code">
@Bean
PasswordEncoder passwordEncoder() {
    return Argon2PasswordEncoder.defaultsForSpringSecurity_v5_2();
}</pre> <h3>Delegating PasswordEncoder usage</h3>
<p>If you<a id="_idIndexMarker1137"/> haven’t employed the <a id="_idIndexMarker1138"/>deprecated constructor, it’s essential to update your code to adhere to the latest standards. This entails configuring the <strong class="source-inline">DelegatingPasswordEncoder</strong> to identify passwords that adhere to current standards and update them to the latest ones. The following example using <strong class="source-inline">Pbkdf2PasswordEncoder</strong> can also be applied to <strong class="source-inline">SCryptPasswordEncoder</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">Argon2PasswordEncoder</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
@Bean
PasswordEncoder passwordEncoder() {
    String prefix = "pbkdf2@5.8";
    PasswordEncoder current = Pbkdf2PasswordEncoder.defaultsForSpringSecurity_v5_5();
    PasswordEncoder upgraded = Pbkdf2PasswordEncoder.defaultsForSpringSecurity_v5_8();
    DelegatingPasswordEncoder delegating = new DelegatingPasswordEncoder(prefix, Map.of(prefix, upgraded));
    delegating.setDefaultPasswordEncoderForMatches(current);
    return delegating;
}</pre> <h3>Abandoning Encryptors.queryableText</h3>
<p>The <a id="_idIndexMarker1139"/>use of <strong class="source-inline">Encryptors.queryableText(CharSequence,</strong> <strong class="source-inline">CharSequence) </strong>is considered unsafe as <a id="_idIndexMarker1140"/>identical input data will yield the same output (CVE-2020-5408 - <a href="https://github.com/advisories/GHSA-2ppp-9496-p23q"><span class="No-Break">https://github.com/advisories/GHSA-2ppp-9496-p23q</span></a><span class="No-Break">).e</span></p>
<p><strong class="source-inline">Spring Security 6.x</strong> no longer endorses data encryption through this method. To facilitate the upgrade, you must either re-encrypt the data using a supported mechanism or store it in a <span class="No-Break">decrypted form.</span></p>
<p>Following the examination of password encoding updates, we will delve into the details of session <span class="No-Break">management updates.</span></p>
<h2 id="_idParaDest-352"><a id="_idTextAnchor524"/>Session Management Updates</h2>
<p>In<a id="_idIndexMarker1141"/> the upcoming sections, we’ll thoroughly examine session management updates, encompassing the primary deprecations <span class="No-Break">and modifications.</span></p>
<h3>Requiring Explicit Saving of SecurityContextRepository</h3>
<p>In <strong class="source-inline">Spring Security 5</strong>, the default <a id="_idIndexMarker1142"/>process involves automatically saving the <strong class="source-inline">SecurityContext</strong> to the <strong class="source-inline">SecurityContextRepository</strong> through the <strong class="source-inline">SecurityContextPersistenceFilter</strong>. This saving occurs just before the <strong class="source-inline">HttpServletResponse</strong> is committed and right before the <strong class="source-inline">SecurityContextPersistenceFilter</strong>. However, this automatic persistence can catch users off guard, especially when performed just before the request completes (i.e., prior to committing the <strong class="source-inline">HttpServletResponse</strong>). It also introduces complexity in tracking the state to determine the necessity of saving, leading to unnecessary writes to the <strong class="source-inline">SecurityContextRepository</strong> (e.g., <strong class="source-inline">HttpSession</strong>) <span class="No-Break">at times.</span></p>
<p>With the advent of <strong class="source-inline">Spring Security 6</strong>, the default behavior has shifted. The <strong class="source-inline">SecurityContextHolderFilter</strong> will now solely read the <strong class="source-inline">SecurityContext</strong> from the <strong class="source-inline">SecurityContextRepository</strong> and populate it in the <strong class="source-inline">SecurityContextHolder</strong>. Users are now required to explicitly save the <strong class="source-inline">SecurityContext</strong> using the <strong class="source-inline">SecurityContextRepository</strong> if they wish for the <strong class="source-inline">SecurityContext</strong> to persist between requests. This modification eliminates ambiguity and enhances performance by mandating writes to the <strong class="source-inline">SecurityContextRepository</strong> (e.g., <strong class="source-inline">HttpSession</strong>) only <span class="No-Break">when necessary.</span></p>
<p>To opt into the <a id="_idIndexMarker1143"/>new <strong class="source-inline">Spring Security 6</strong> default, the following configuration can <span class="No-Break">be used:</span></p>
<pre class="source-code">
public SecurityFilterChain filterChain(HttpSecurity http) {
    http
          .securityContext((securityContext) -&gt; securityContext
                .requireExplicitSave(true)
          );
    return http.build();
}</pre> <p>When using the configuration, it is crucial that any code responsible for setting the <strong class="source-inline">SecurityContextHolder</strong> with a <strong class="source-inline">SecurityContext</strong> also ensures the saving of the <strong class="source-inline">SecurityContext</strong> to the <strong class="source-inline">SecurityContextRepository</strong> if persistence between requests <span class="No-Break">is required.</span></p>
<p>For example, the <span class="No-Break">following code:</span></p>
<pre class="source-code">
SecurityContextHolder.setContext(securityContext);</pre> <p>should be<a id="_idIndexMarker1144"/> <span class="No-Break">replaced with:</span></p>
<pre class="source-code">
SecurityContextHolder.setContext(securityContext);
securityContextRepository.saveContext(securityContext, httpServletRequest, httpServletResponse);</pre> <h3>Changing HttpSessionSecurityContextRepository to DelegatingSecurityContextRepository</h3>
<p>In <strong class="source-inline">Spring Security 5</strong>, the<a id="_idIndexMarker1145"/> default <strong class="source-inline">SecurityContextRepository</strong> <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">HttpSessionSecurityContextRepository</strong></span><span class="No-Break">.</span></p>
<p>In <strong class="source-inline">Spring Security 6</strong>, the default <strong class="source-inline">SecurityContextRepository</strong> is <strong class="source-inline">DelegatingSecurityContextRepository</strong>. To adopt the new <strong class="source-inline">Spring Security 6</strong> default, the following configuration can <span class="No-Break">be utilized:</span></p>
<pre class="source-code">
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
          // ...
          .securityContext((securityContext) -&gt; securityContext
                .securityContextRepository(new DelegatingSecurityContextRepository(
                      new RequestAttributeSecurityContextRepository(),
                      new HttpSessionSecurityContextRepository()
                ))
          );
    return http.build();
}</pre> <h3>Addressing SecurityContextRepository Deprecations</h3>
<p>In <strong class="source-inline">Spring Security 6</strong>, the following <a id="_idIndexMarker1146"/>method in the class <strong class="source-inline">SecurityContextRepository</strong> has <span class="No-Break">been deprecated:</span></p>
<pre class="source-code">
Supplier&lt;SecurityContext&gt; loadContext(HttpServletRequest request)</pre> <p>The method should be replaced with <span class="No-Break">the following:</span></p>
<pre class="source-code">
DeferredSecurityContext loadDeferredContext(HttpServletRequest request)</pre> <h3>Improving Querying of RequestCache</h3>
<p>In <strong class="source-inline">Spring Security 5</strong>, the<a id="_idIndexMarker1147"/> standard procedure involves querying the saved request with every incoming request. In a typical configuration, this implies that the <strong class="source-inline">HttpSession</strong> is consulted on each request to utilize <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">RequestCache</strong></span><span class="No-Break">.</span></p>
<p>In <strong class="source-inline">Spring Security 6</strong>, the new default is such that the <strong class="source-inline">RequestCache</strong> will only be interrogated for a cached request if the HTTP parameter <strong class="source-inline">continue</strong> is explicitly defined. This approach enables <strong class="source-inline">Spring Security</strong> to skip unnecessary reads of the <strong class="source-inline">HttpSession</strong> when working with <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">RequestCache</strong></span><span class="No-Break">.</span></p>
<h3>Requiring Explicit Invocation of SessionAuthenticationStrategy</h3>
<p>In <strong class="source-inline">Spring Security 5</strong>, the standard <a id="_idIndexMarker1148"/>configuration depends on the <strong class="source-inline">SessionManagementFilter</strong> to identify whether a user has recently authenticated and to trigger the <strong class="source-inline">SessionAuthenticationStrategy</strong>. However, this setup entails reading the <strong class="source-inline">HttpSession</strong> for every request in a <span class="No-Break">typical scenario.</span></p>
<p>In <strong class="source-inline">Spring Security 6</strong>, the new default is for authentication mechanisms to directly invoke the <strong class="source-inline">SessionAuthenticationStrategy</strong>. Consequently, there is no requirement to identify when authentication occurs, eliminating the need to read the <strong class="source-inline">HttpSession</strong> for <span class="No-Break">every request.</span></p>
<p>Following the investigation of session management updates, we will delve deeply into <span class="No-Break">authentication updates.</span></p>
<h2 id="_idParaDest-353"><a id="_idTextAnchor525"/>Authentication Updates</h2>
<p>We’ll<a id="_idIndexMarker1149"/> examine the main updates in authentication, including the adoption of <strong class="source-inline">SHA-256</strong> for <strong class="source-inline">Remember Me</strong> functionality and enhancements related <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">AuthenticationServiceExceptions</strong></span><span class="No-Break">.</span></p>
<h3>Utilizing SHA-256 for Remember Me</h3>
<p>The <strong class="source-inline">TokenBasedRememberMeServices</strong> implementation in <strong class="source-inline">Spring Security 6</strong> now <a id="_idIndexMarker1150"/>defaults to using <strong class="source-inline">SHA-256</strong> for <strong class="source-inline">Remember Me</strong> tokens, enhancing the default security stance. This change is motivated <a id="_idIndexMarker1151"/>by the recognition of <strong class="source-inline">MD5</strong> as a weak hashing <a id="_idIndexMarker1152"/>algorithm susceptible to collision attacks and modular <span class="No-Break">differential attacks.</span></p>
<p>The newly generated tokens include information about the algorithm used for token generation. This information is leveraged for matching purposes. If the algorithm name is absent, the <strong class="source-inline">matchingAlgorithm</strong> property is employed to verify the token. This design allows for a seamless transition from <strong class="source-inline">MD5</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">SHA-256</strong></span><span class="No-Break">.</span></p>
<p>The following code shows how you can enable <strong class="source-inline">Remember Me</strong> feature, with the <span class="No-Break">default implementation:</span></p>
<pre class="source-code">
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    SecurityFilterChain securityFilterChain(HttpSecurity http, RememberMeServices rememberMeServices) throws Exception {
       http
             // ...
             .rememberMe(remember -&gt; remember
                   .rememberMeServices(rememberMeServices)
             );
       return http.build();
    }
    @Bean
    RememberMeServices rememberMeServices(UserDetailsService userDetailsService) {
       return new TokenBasedRememberMeServices(myKey, userDetailsService);
    }
}</pre> <p>To <a id="_idIndexMarker1153"/>embrace the new <strong class="source-inline">Spring Security 6</strong> default<a id="_idIndexMarker1154"/> for encoding tokens while maintaining<a id="_idIndexMarker1155"/> compatibility with <strong class="source-inline">MD5</strong>-encoded tokens, you can set the <strong class="source-inline">encodingAlgorithm</strong> property to <strong class="source-inline">SHA-256</strong> and the <strong class="source-inline">matchingAlgorithm</strong> property <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">MD5</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    SecurityFilterChain securityFilterChain(HttpSecurity http, RememberMeServices rememberMeServices) throws Exception {
       http
             .rememberMe(remember -&gt; remember
                   .rememberMeServices(rememberMeServices)
             );
       return http.build();
    }
    @Bean
    RememberMeServices rememberMeServices(UserDetailsService userDetailsService) {
       RememberMeTokenAlgorithm encodingAlgorithm = RememberMeTokenAlgorithm.SHA256;
       TokenBasedRememberMeServices rememberMe = new TokenBasedRememberMeServices(myKey, userDetailsService, encodingAlgorithm);
       rememberMe.setMatchingAlgorithm(RememberMeTokenAlgorithm.MD5);
       return rememberMe;
    }
}</pre> <h3>Propagating AuthenticationServiceExceptions</h3>
<p>The <strong class="source-inline">AuthenticationFilter</strong> forwards <strong class="source-inline">AuthenticationServiceException </strong>to the <strong class="source-inline">AuthenticationEntryPoint</strong>. As <strong class="source-inline">AuthenticationServiceExceptions</strong> indicate a server-side error rather than a client-side <a id="_idIndexMarker1156"/>error, in version 6.0, this mechanism is <a id="_idIndexMarker1157"/>adjusted to propagate them to <span class="No-Break">the container.</span></p>
<p>Therefore, if you had previously enabled this behavior by setting <strong class="source-inline">rethrowAuthenticationServiceException</strong> to <strong class="source-inline">true</strong>, you can now eliminate it <span class="No-Break">as follows:</span></p>
<pre class="source-code">
AuthenticationFilter authenticationFilter = new AuthenticationFilter(...);
AuthenticationEntryPointFailureHandler handler = new AuthenticationEntryPointFailureHandler(...);
handler.setRethrowAuthenticationServiceException(true);
authenticationFilter.setAuthenticationFailureHandler(handler);</pre> <p>This<a id="_idIndexMarker1158"/> can be<a id="_idIndexMarker1159"/> <span class="No-Break">changed to:</span></p>
<pre class="source-code">
AuthenticationFilter authenticationFilter = new AuthenticationFilter(...);
AuthenticationEntryPointFailureHandler handler = new AuthenticationEntryPointFailureHandler(...);
authenticationFilter.setAuthenticationFailureHandler(handler);</pre> <p>Following the examination of authentication updates, we will delve deeply into <span class="No-Break">authorization updates.</span></p>
<h2 id="_idParaDest-354"><a id="_idTextAnchor526"/>Authorization Updates</h2>
<p>In <a id="_idIndexMarker1160"/>this section, we will explore several key enhancements in authorization management within <strong class="source-inline">Spring Security</strong>. We’ll begin by discussing how to utilize the <strong class="source-inline">AuthorizationManager</strong> for <strong class="source-inline">Method Security</strong>, enabling fine-grained control over method-level access. Next, we’ll delve into leveraging the <strong class="source-inline">AuthorizationManager</strong> for message security, facilitating secure communication over messaging protocols. Additionally, we’ll highlight some deprecations <span class="No-Break">like </span><span class="No-Break"><strong class="source-inline">AbstractSecurityWebSocketMessageBrokerConfigurer</strong></span><span class="No-Break">.</span></p>
<h3>Leveraging AuthorizationManager for Method Security</h3>
<p><strong class="bold">Method Security</strong> is now <a id="_idIndexMarker1161"/>streamlined <a id="_idIndexMarker1162"/>with the <strong class="source-inline">AuthorizationManager</strong> API and direct utilization of <span class="No-Break"><strong class="bold">Spring AOP</strong></span><span class="No-Break">.</span></p>
<p>In case you encounter challenges while implementing these adjustments, it’s essential to note that even though <strong class="source-inline">@EnableGlobalMethodSecurity</strong> is deprecated, it has not been removed in version 6.0. This ensures you have the option to opt out by continuing to use the <span class="No-Break">deprecated annotation.</span></p>
<h4>Replacing Global Method Security with Method Security</h4>
<p><strong class="source-inline">@EnableGlobalMethodSecurity</strong> and <strong class="source-inline">&lt;global-method-security&gt;</strong> are now deprecated in favor of <strong class="source-inline">@EnableMethodSecurity</strong> and <strong class="source-inline">&lt;method-security&gt;</strong>, respectively. The <a id="_idIndexMarker1163"/>updated annotation and XML element automatically activate Spring’s pre-post annotations and internally <span class="No-Break">utilize </span><span class="No-Break"><strong class="source-inline">AuthorizationManager</strong></span><span class="No-Break">.</span></p>
<h4>Changing the order value in @EnableTransactionManagement</h4>
<p><strong class="source-inline">@EnableTransactionManagement</strong> and <strong class="source-inline">@EnableGlobalMethodSecurity</strong> both have<a id="_idIndexMarker1164"/> the same order value, <strong class="source-inline">Integer.MAX_VALUE</strong>. As a result, their relative order in the Spring AOP <strong class="source-inline">Advisor</strong> chain <span class="No-Break">is undefined.</span></p>
<p>While this is generally acceptable, as most <strong class="bold">Method Security</strong> expressions don’t rely on an open transaction to function correctly, there were historical cases where it was necessary to ensure a specific order by setting their <span class="No-Break">order values.</span></p>
<p>On the contrary, <strong class="source-inline">@EnableMethodSecurity</strong> lacks an order value because it dispatches multiple interceptors. Unlike <strong class="source-inline">@EnableTransactionManagement</strong>, it cannot maintain backward compatibility, as it cannot position all interceptors within the same advisor <span class="No-Break">chain location.</span></p>
<p>Instead, the order values for the <strong class="source-inline">@EnableMethodSecurity</strong> interceptors are based on an offset of <strong class="source-inline">0</strong>. For example, the <strong class="source-inline">@PreFilter</strong> interceptor has an order of <strong class="source-inline">100</strong>, <strong class="source-inline">@PostAuthorize</strong> has an order of <strong class="source-inline">200</strong>, and <span class="No-Break">so forth.</span></p>
<p>If, after updating, you discover that your <strong class="source-inline">Method Security</strong> expressions are not functioning due to a lack of an open transaction, please modify your transaction annotation definition as <span class="No-Break">the following:</span></p>
<pre class="source-code">
@EnableTransactionManagement(order = 0)</pre> <h4>Using a Custom @Bean instead of subclassing DefaultMethodSecurityExpressionHandler</h4>
<p>For <a id="_idIndexMarker1165"/>performance optimization, a new method has been added to <strong class="source-inline">MethodSecurityExpressionHandler</strong> that accepts a <strong class="source-inline">Supplier&lt;Authentication&gt;</strong> instead of <span class="No-Break">an </span><span class="No-Break"><strong class="source-inline">Authentication</strong></span><span class="No-Break">.</span></p>
<p>This enhancement allows <strong class="source-inline">Spring Security</strong> to defer the <strong class="source-inline">Authentication</strong> lookup and is automatically utilized when employing <strong class="source-inline">@EnableMethodSecurity</strong> instead <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">@EnableGlobalMethodSecurity</strong></span><span class="No-Break">.</span></p>
<p>For instance, suppose<a id="_idIndexMarker1166"/> you aim for a customized evaluation of <strong class="source-inline">@PostAuthorize("hasAuthority('ADMIN')")</strong>. In such a case, you can create a custom <strong class="source-inline">@Bean</strong> as <span class="No-Break">demonstrated here:</span></p>
<pre class="source-code">
class MyAuthorizer {
    boolean isAdmin(MethodSecurityExpressionOperations root) {
       boolean decision = root.hasAuthority("ADMIN");
       // custom work ...
       return decision;
    }
}</pre> <p>Subsequently, reference it in the annotation <span class="No-Break">as follows:</span></p>
<pre class="source-code">
@PreAuthorize("@authz.isAdmin(#root)")</pre> <h4>Exposing a MethodSecurityExpressionHandler instead of a PermissionEvaluator</h4>
<p><strong class="source-inline">@EnableMethodSecurity</strong> does <a id="_idIndexMarker1167"/>not automatically detect a <strong class="source-inline">PermissionEvaluator</strong> to keep its <span class="No-Break">API straightforward.</span></p>
<p>If you have a custom <strong class="source-inline">PermissionEvaluator</strong> declared as a <strong class="source-inline">@Bean</strong>, please update <span class="No-Break">it from:</span></p>
<pre class="source-code">
@Bean
static PermissionEvaluator permissionEvaluator() {
    // ... your evaluator
}</pre> <p><span class="No-Break">to:</span></p>
<pre class="source-code">
@Bean
static MethodSecurityExpressionHandler expressionHandler() {
    var expressionHandler = new DefaultMethodSecurityExpressionHandler();
    expressionHandler.setPermissionEvaluator(myPermissionEvaluator);
    return expressionHandler;
}</pre> <h4>Substituting any custom AccessDecisionManagers in Method Security</h4>
<p>Your application<a id="_idIndexMarker1168"/> might feature a custom <strong class="source-inline">AccessDecisionManager</strong> or <strong class="source-inline">AccessDecisionVoter</strong> configuration. The approach to adaptation will vary depending on the specific purpose of each configuration. Continue reading to identify the most suitable adjustment for <span class="No-Break">your scenario.</span></p>
<h4>UnanimousBased use case</h4>
<p>If your application <a id="_idIndexMarker1169"/>utilizes <strong class="source-inline">UnanimousBased</strong> with the default voters, you probably won’t need to make any changes since unanimous-based is the default behavior <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">@EnableMethodSecurity</strong></span><span class="No-Break">.</span></p>
<p>Nevertheless, if you find that the default authorization managers are not suitable, you can utilize <strong class="source-inline">AuthorizationManagers.allOf</strong> to construct your <span class="No-Break">custom configuration.</span></p>
<h4>AffirmativeBased use case</h4>
<p>If your<a id="_idIndexMarker1170"/> application relies on <strong class="source-inline">AffirmativeBased</strong>, you can create an equivalent <strong class="source-inline">AuthorizationManager</strong> <span class="No-Break">as follows:</span></p>
<pre class="source-code">
AuthorizationManager&lt;MethodInvocation&gt; authorization = AuthorizationManagers.anyOf(
       // ... your list of authorization managers
)</pre> <h4>ConsensusBased use case</h4>
<p>For <strong class="source-inline">ConsensusBased</strong>, there is <a id="_idIndexMarker1171"/>no built-in equivalent provided by the framework. In this scenario, you should implement a composite <strong class="source-inline">AuthorizationManager</strong> that considers the set of delegate <span class="No-Break"><strong class="source-inline">AuthorizationManager</strong></span><span class="No-Break"> instances.</span></p>
<h4>AccessDecisionVoter use case</h4>
<p>You can either modify the<a id="_idIndexMarker1172"/> class to implement <strong class="source-inline">AuthorizationManager</strong> or create an adapter <span class="No-Break">as follows:</span></p>
<pre class="source-code">
public final class PreAuthorizeAuthorizationManagerAdapter implements AuthorizationManager&lt;MethodInvocation&gt; {
    private final SecurityMetadataSource metadata;
    private final AccessDecisionVoter voter;
    public PreAuthorizeAuthorizationManagerAdapter (MethodSecurityExpressionHandler expressionHandler) {
       ExpressionBasedAnnotationAttributeFactory attributeFactory =
             new ExpressionBasedAnnotationAttributeFactory(expressionHandler);
       this.metadata = new PrePostAnnotationSecurityMetadataSource(attributeFactory);
       ExpressionBasedPreInvocationAdvice expressionAdvice = new ExpressionBasedPreInvocationAdvice();
       expressionAdvice.setExpressionHandler(expressionHandler);
       this.voter = new PreInvocationAuthorizationAdviceVoter(expressionAdvice);
    }
    public AuthorizationDecision check(Supplier&lt;Authentication&gt; authentication, MethodInvocation invocation) {
       List&lt;ConfigAttribute&gt; attributes = this.metadata.getAttributes(invocation, AopUtils.getTargetClass(invocation.getThis()));
       int decision = this.voter.vote(authentication.get(), invocation, attributes);
       if (decision == ACCESS_GRANTED) {
          return new AuthorizationDecision(true);
       }
       if (decision == ACCESS_DENIED) {
          return new AuthorizationDecision(false);
       }
       return null; // abstain
    }
}</pre> <h4>AfterInvocationManager or AfterInvocationProvider use case</h4>
<p><strong class="source-inline">AfterInvocationManager</strong> and <strong class="source-inline">AfterInvocationProvider</strong> are responsible for making an authorization <a id="_idIndexMarker1173"/>decision regarding the result of an invocation. For<a id="_idIndexMarker1174"/> instance, in the context of method invocation, they determine the authorization of a method’s <span class="No-Break">return value.</span></p>
<p>In <strong class="source-inline">Spring Security 3.0</strong>, the decision-making process for authorization was standardized through the <strong class="source-inline">@PostAuthorize</strong> and <strong class="source-inline">@PostFilter</strong> annotations. <strong class="source-inline">@PostAuthorize</strong> is used to determine whether the entire return value is allowed to be returned. On the other hand, <strong class="source-inline">@PostFilter</strong> is employed to filter individual entries from a returned collection, array, <span class="No-Break">or stream.</span></p>
<p>These two annotations should fulfill most requirements, and there is encouragement to transition to one or both of them as <strong class="source-inline">AfterInvocationProvider</strong> and <strong class="source-inline">AfterInvocationManager</strong> are <span class="No-Break">now deprecated.</span></p>
<h4>RunAsManager use case</h4>
<p>At present, there is no <a id="_idIndexMarker1175"/>direct substitute for <strong class="source-inline">RunAsManager</strong>, although the possibility of introducing one is <span class="No-Break">under consideration.</span></p>
<p>However, if required, it is relatively simple to modify a <strong class="source-inline">RunAsManager</strong> to align with the <span class="No-Break"><strong class="source-inline">AuthorizationManager</strong></span><span class="No-Break"> API.</span></p>
<p>Here is some pseudocode to assist you in <span class="No-Break">getting started:</span></p>
<pre class="source-code">
public final class RunAsAuthorizationManagerAdapter&lt;T&gt; implements AuthorizationManager&lt;T&gt; {
    private final RunAsManager runAs = new RunAsManagerImpl();
    private final SecurityMetadataSource metadata;
    private final AuthorizationManager&lt;T&gt; authorization;
    // ... constructor
    public AuthorizationDecision check(Supplier&lt;Authentication&gt; authentication, T object) {
       Supplier&lt;Authentication&gt; wrapped = (auth) -&gt; {
          List&lt;ConfigAttribute&gt; attributes = this.metadata.getAttributes(object);
          return this.runAs.buildRunAs(auth, object, attributes);
       };
       return this.authorization.check(wrapped, object);
    }
}</pre> <h4>Verifying for AnnotationConfigurationException</h4>
<p><strong class="source-inline">@EnableMethodSecurity</strong> and <strong class="source-inline">&lt;method-security&gt;</strong> enable more stringent enforcement of <strong class="source-inline">Spring Security</strong>’s non-repeatable or otherwise incompatible annotations. If <a id="_idIndexMarker1176"/>you encounter <strong class="source-inline">AnnotationConfigurationException</strong> in your logs after transitioning to either, follow the instructions provided in the exception message to rectify your application’s <strong class="source-inline">Method Security</strong> <span class="No-Break">annotation usage.</span></p>
<h2 id="_idParaDest-355"><a id="_idTextAnchor527"/>Leveraging AuthorizationManager for Message Security</h2>
<p>Message<a id="_idIndexMarker1177"/> Security has <a id="_idIndexMarker1178"/>been enhanced with the <strong class="source-inline">AuthorizationManager</strong> API and direct utilization of <span class="No-Break">Spring AOP.</span></p>
<p>To configure the <strong class="source-inline">AuthorizationManager</strong> for Message Security, you will need to follow the <span class="No-Break">steps below:</span></p>
<ol>
<li>Ensure<a id="_idIndexMarker1179"/> all messages<a id="_idIndexMarker1180"/> have defined <span class="No-Break">authorization rules:</span><pre class="source-code">
@Override
protected void configureInbound(MessageSecurityMetadataSourceRegistry messages) {
    messages
          .simpTypeMatchers(CONNECT, DISCONNECT, UNSUBSCRIBE).permitAll()
          .simpDestMatchers("/user/queue/errors").permitAll()
          .simpDestMatchers("/admin/**").hasRole("ADMIN")
          .anyMessage().denyAll();
}</pre></li> <li>Add <strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">EnableWebSocketSecurity</strong></span><span class="No-Break"> annotation.</span></li>
<li>Utilize an instance <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">AuthorizationManager&lt;Message&lt;?&gt;&gt;</strong></span><span class="No-Break">:</span><pre class="source-code">
@Bean
AuthorizationManager&lt;Message&lt;?&gt;&gt; messageSecurity(MessageMatcherDelegatingAuthorizationManager.Builder messages) {
    messages
          .simpTypeMatchers(CONNECT, DISCONNECT, UNSUBSCRIBE).permitAll()
          .simpDestMatchers("/user/queue/errors").permitAll()
          .simpDestMatchers("/admin/**").hasRole("ADMIN")
          .anyMessage().denyAll();
    return messages.build();
}</pre></li> </ol>
<p>Now we’ve examined the <strong class="source-inline">AuthorizationManager</strong> configuration for Message Security, we’ll delve into the modifications associated <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">AbstractSecurityWebSocketMessageBrokerConfigurer</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-356"><a id="_idTextAnchor528"/>Deprecating AbstractSecurityWebSocketMessageBrokerConfigurer</h2>
<p>If you are<a id="_idIndexMarker1181"/> employing Java configuration, you can now directly <span class="No-Break">extend </span><span class="No-Break"><strong class="source-inline">WebSocketMessageBrokerConfigurer</strong></span><span class="No-Break">.</span></p>
<p>For instance, if your class is extending <strong class="source-inline">AbstractSecurityWebSocketMessageBrokerConfigurer</strong> is named <strong class="source-inline">WebSocketSecurityConfig</strong>, then replace it with <span class="No-Break">the following:</span></p>
<pre class="source-code">
@EnableWebSocketSecurity
@Configuration
public class WebSocketSecurityConfig implements WebSocketMessageBrokerConfigurer {
    // ...
}</pre> <p>Having clarified the reasons for discontinuing the implementation of <strong class="source-inline">AbstractSecurityWebSocketMessageBrokerConfigurer</strong>, let’s now delve into the utilization of <strong class="source-inline">AuthorizationManager</strong> for <span class="No-Break">request security.</span></p>
<h2 id="_idParaDest-357"><a id="_idTextAnchor529"/>Employing AuthorizationManager for Request Security</h2>
<p>HTTP<a id="_idIndexMarker1182"/> Request Security has been streamlined with the <strong class="source-inline">AuthorizationManager</strong> API. We will explain <strong class="source-inline">AuthorizationManager</strong> changes for security requests in <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x.</strong></span></p>
<h3>Ensure that all requests have well-defined authorization rules</h3>
<p>In <strong class="source-inline">Spring Security 5.8</strong> and earlier, requests without an authorization rule are allowed by <a id="_idIndexMarker1183"/>default. However, for a more robust security posture, the default approach is to deny by default in <strong class="source-inline">Spring Security 6.0</strong>. This means that any request lacking an explicit authorization rule will be denied <span class="No-Break">by default.</span></p>
<p>If you already have an <strong class="source-inline">anyRequest</strong> rule in place that meets your requirements, you can skip <span class="No-Break">this step:</span></p>
<pre class="source-code">
http
       .authorizeRequests((authorize) -&gt; authorize
             .filterSecurityInterceptorOncePerRequest(true)
             .mvcMatchers("/app/**").hasRole("APP")
             // ...
             .anyRequest().denyAll()
       )</pre> <p>If you have already transitioned to <strong class="source-inline">authorizeHttpRequests</strong>, the recommended modification remains <span class="No-Break">the same.</span></p>
<h3>Transitioning to AuthorizationManager</h3>
<p>To adopt <a id="_idIndexMarker1184"/>the use of <strong class="source-inline">AuthorizationManager</strong>, you can utilize <strong class="source-inline">authorizeHttpRequests</strong> for Java configuration or use <strong class="source-inline">use-authorization-manager</strong> for <span class="No-Break">XML configuration:</span></p>
<pre class="source-code">
http
       .authorizeHttpRequests((authorize) -&gt; authorize
             .shouldFilterAllDispatcherTypes(false)
             .mvcMatchers("/app/**").hasRole("APP")
             // ...
             .anyRequest().denyAll()
       )</pre> <h3>Migrating from hasIpAddress to access(AuthorizationManager)</h3>
<p>To migrate<a id="_idIndexMarker1185"/> from <strong class="source-inline">hasIpAddress</strong> to <span class="No-Break"><strong class="source-inline">access(AuthorizationManager)</strong></span><span class="No-Break">, use:</span></p>
<pre class="source-code">
IpAddressMatcher hasIpAddress = new IpAddressMatcher("127.0.0.1");
http
       .authorizeHttpRequests((authorize) -&gt; authorize
                   .requestMatchers("/app/**").access((authentication, context) -&gt;
                         new AuthorizationDecision(hasIpAddress.matches(context.getRequest()))
                               // ...
                               .anyRequest().denyAll()
             ))</pre> <p class="callout-heading">Important note</p>
<p class="callout">Securing by IP address is inherently delicate. Therefore, there are no intentions to transfer this support <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">authorizeHttpRequests</strong></span><span class="No-Break">.</span></p>
<h3>Transitioning SpEL expressions to AuthorizationManager</h3>
<p>When it <a id="_idIndexMarker1186"/>comes to authorization rules, Java is generally more straightforward to test and maintain than SpEL. Consequently, <strong class="source-inline">authorizeHttpRequests</strong> does not provide a method for declaring a String SpEL. Instead, you can create your own <strong class="source-inline">AuthorizationManager</strong> implementation or <span class="No-Break">utilize </span><span class="No-Break"><strong class="source-inline">WebExpressionAuthorizationManager</strong></span><span class="No-Break">.</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table004-3">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">SpEL</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">AuthorizationManager</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">WebExpressionAuthorizationManager</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">mvcMatchers("/complicated/**").access("hasRole</strong></span><strong class="source-inline" lang="en-US" xml:lang="en-US">
('ADMIN') || </strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">hasAuthority ('SCOPE_read')")</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">mvcMatchers("/complicated/**").access(anyOf(hasRole</strong></span><strong class="source-inline" lang="en-US" xml:lang="en-US">
("ADMIN"), </strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">hasAuthority ("SCOPE_read"))</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">mvcMatchers("/complicated/**").access</strong></span><strong class="source-inline" lang="en-US" xml:lang="en-US">
(</strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">new WebExpressionAuthorization</strong></span><strong class="source-inline" lang="en-US" xml:lang="en-US">
Manager("hasRole('ADMIN') || </strong><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">hasAuthority('SCOPE_read')"))</strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 16.4 – SpEL migration options</p>
<h3>Transitioning to filtering all dispatcher types</h3>
<p>In <strong class="source-inline">Spring Security 5.8</strong> and earlier, authorization is executed only once per request. Consequently, dispatcher<a id="_idIndexMarker1187"/> types like <strong class="source-inline">FORWARD</strong> and <strong class="source-inline">INCLUDE</strong> that run after <strong class="source-inline">REQUEST</strong> are not secured by default. It is advisable for <strong class="source-inline">Spring Security</strong> to secure all dispatcher types. Therefore, in version 6.0, <strong class="source-inline">Spring Security</strong> modifies this <span class="No-Break">default behavior.</span></p>
<p>To do this, you <span class="No-Break">should change:</span></p>
<pre class="source-code">
http
       .authorizeHttpRequests((authorize) -&gt; authorize
             .shouldFilterAllDispatcherTypes(false)
             .mvcMatchers("/app/**").hasRole("APP")
             // ...
             .anyRequest().denyAll()
       )</pre> <p><span class="No-Break">to:</span></p>
<pre class="source-code">
http
       .authorizeHttpRequests((authorize) -&gt; authorize
             .shouldFilterAllDispatcherTypes(true)
             .mvcMatchers("/app/**").hasRole("APP")
             // ...
             .anyRequest().denyAll()
       )</pre> <p><span class="No-Break">Then, set:</span></p>
<pre class="source-code">
spring.security.filter.dispatcher-types=request,async,error,forward,include</pre> <p>If you’re using the <strong class="source-inline">AbstractSecurityWebApplicationInitializer</strong>, it’s recommended to override the <strong class="source-inline">getSecurityDispatcherTypes</strong> method and return all<a id="_idIndexMarker1188"/> <span class="No-Break">dispatcher types:</span></p>
<pre class="source-code">
public class SecurityWebApplicationInitializer extends AbstractSecurityWebApplicationInitializer {
    @Override
    protected EnumSet&lt;DispatcherType&gt; getSecurityDispatcherTypes() {
       return EnumSet.of(DispatcherType.REQUEST, DispatcherType.ERROR, DispatcherType.ASYNC,
             DispatcherType.FORWARD, DispatcherType.INCLUDE);
    }
}</pre> <h4>Allowing FORWARD when employing Spring MVC</h4>
<p>When Spring MVC identifies a mapping between the view name and the actual views, it initiates a forward to the view. As demonstrated in the previous section, <strong class="source-inline">Spring Security 6.0</strong> will, by default, apply authorization to <span class="No-Break"><strong class="source-inline">FORWARD</strong></span><span class="No-Break"> requests.</span></p>
<h3>Substituting any custom filter-security AccessDecisionManager</h3>
<p>In this section, we <a id="_idIndexMarker1189"/>will explore the different use cases to substitute custom filter-security based <span class="No-Break">on </span><span class="No-Break"><strong class="source-inline">AccessDecisionManager</strong></span><span class="No-Break">.</span></p>
<h4>UnanimousBased use case</h4>
<p>If your application<a id="_idIndexMarker1190"/> relies on <strong class="source-inline">UnanimousBased</strong>, begin by adjusting or replacing any <strong class="source-inline">AccessDecisionVoter</strong> Subsequently, you can create an <strong class="source-inline">AuthorizationManager</strong> <span class="No-Break">as follows:</span></p>
<pre class="source-code">
@Bean
AuthorizationManager&lt;RequestAuthorizationContext&gt; requestAuthorization() {
    PolicyAuthorizationManager policy = ...;
    LocalAuthorizationManager local = ...;
    return AuthorizationManagers.allOf(policy, local);
}</pre> <p>Then, integrate it into the DSL <span class="No-Break">as follows:</span></p>
<pre class="source-code">
http
       .authorizeHttpRequests((authorize) -&gt; authorize.anyRequest().access(requestAuthorization))
// ...</pre> <h4>AffirmativeBased use case</h4>
<p>If your application<a id="_idIndexMarker1191"/> utilizes <strong class="source-inline">AffirmativeBased</strong>, you can create an equivalent <strong class="source-inline">AuthorizationManager</strong> <span class="No-Break">as follows:</span></p>
<pre class="source-code">
@Bean
AuthorizationManager&lt;RequestAuthorizationContext&gt; requestAuthorization() {
    PolicyAuthorizationManager policy = ...;
    LocalAuthorizationManager local = ...;
    return AuthorizationManagers.anyOf(policy, local);
}</pre> <p>Then, integrate it into the DSL <span class="No-Break">as follows:</span></p>
<pre class="source-code">
http
       .authorizeHttpRequests((authorize) -&gt; authorize.anyRequest().access(requestAuthorization))
// ...</pre> <h4>ConsensusBased use case</h4>
<p>If your application is<a id="_idIndexMarker1192"/> using <strong class="source-inline">ConsensusBased</strong>, there is no equivalent provided by the framework. In this case, you should implement a composite <strong class="source-inline">AuthorizationManager</strong> that considers the set of <span class="No-Break">delegate </span><span class="No-Break"><strong class="source-inline">AuthorizationManagers</strong></span><span class="No-Break">.</span></p>
<h4>Custom AccessDecisionVoter use case</h4>
<p>If your application is <a id="_idIndexMarker1193"/>using <strong class="source-inline">AccessDecisionVoter</strong>, you can either modify the class to implement <strong class="source-inline">AuthorizationManager</strong> or create an adapter. Without knowledge of the specific functionality of your custom voter, it’s challenging to provide a <span class="No-Break">generic solution.</span></p>
<p>However, here’s an<a id="_idIndexMarker1194"/> illustrative example of adapting <strong class="source-inline">SecurityMetadataSource</strong> and <strong class="source-inline">AccessDecisionVoter</strong> <span class="No-Break">for </span><span class="No-Break"><strong class="source-inline">anyRequest().authenticated()</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
public final class AnyRequestAuthenticatedAuthorizationManagerAdapter implements AuthorizationManager&lt;RequestAuthorizationContext&gt; {
    private final SecurityMetadataSource metadata;
    private final AccessDecisionVoter voter;
    public PreAuthorizeAuthorizationManagerAdapter(SecurityExpressionHandler expressionHandler) {
       Map&lt;RequestMatcher, List&lt;ConfigAttribute&gt;&gt; requestMap = Collections.singletonMap(
             AnyRequestMatcher.INSTANCE, Collections.singletonList(new SecurityConfig("authenticated")));
       this.metadata = new DefaultFilterInvocationSecurityMetadataSource(requestMap);
       WebExpressionVoter voter = new WebExpressionVoter();
       voter.setExpressionHandler(expressionHandler);
       this.voter = voter;
    }
    public AuthorizationDecision check(Supplier&lt;Authentication&gt; authentication, RequestAuthorizationContext context) {
       List&lt;ConfigAttribute&gt; attributes = this.metadata.getAttributes(context);
       int decision = this.voter.vote(authentication.get(), invocation, attributes);
       if (decision == ACCESS_GRANTED) {
          return new AuthorizationDecision(true);
       }
       if (decision == ACCESS_DENIED) {
          return new AuthorizationDecision(false);
       }
       return null; // abstain
    }
}</pre> <p>Having <a id="_idIndexMarker1195"/>elucidated the usage of <strong class="source-inline">AuthorizationManager</strong> for Request Security, let’s now delve into updates <span class="No-Break">regarding OAuth.</span></p>
<h2 id="_idParaDest-358"><a id="_idTextAnchor530"/>OAuth Updates</h2>
<p>In this section, we’ll delve into<a id="_idIndexMarker1196"/> OAuth updates, specifically focusing on changes related to altering default authorities in <strong class="source-inline">oauth2Login()</strong> and deprecations concerning <span class="No-Break">OAuth2 clients.</span></p>
<h3>Changing Default oauth2Login() Authorities</h3>
<p>In <strong class="source-inline">Spring Security 5</strong>, when a<a id="_idIndexMarker1197"/> user authenticates with an <strong class="bold">OAuth2</strong> or <strong class="bold">OpenID Connect 1.0</strong> provider <a id="_idIndexMarker1198"/>through <strong class="source-inline">oauth2Login()</strong>, the<a id="_idIndexMarker1199"/> default <strong class="source-inline">GrantedAuthority</strong> assigned to them <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">ROLE_USER</strong></span><span class="No-Break">.</span></p>
<p>In <strong class="source-inline">Spring Security 6</strong>, a user authenticating with an OAuth2 provider is assigned the default authority of <strong class="source-inline">OAUTH2_USER</strong>, while a user authenticating with an <strong class="source-inline">OpenID Connect 1.0</strong> provider is given the default authority of <strong class="source-inline">OIDC_USER</strong>. These default authorities provide a more distinct categorization for users based on whether they have authenticated with an <strong class="source-inline">OAuth2</strong> or <strong class="source-inline">OpenID Connect </strong><span class="No-Break"><strong class="source-inline">1.0</strong></span><span class="No-Break"> provider.</span></p>
<p>If your application relies on authorization rules or expressions such as <strong class="source-inline">hasRole("USER")</strong> or <strong class="source-inline">hasAuthority("ROLE_USER")</strong> to grant access based on specific authorities, be aware that the updated defaults in <strong class="source-inline">Spring Security 6</strong> will impact <span class="No-Break">your application.</span></p>
<p>To adopt the new <a id="_idIndexMarker1200"/>defaults in <strong class="source-inline">Spring Security 6</strong>, you can use the <span class="No-Break">following configuration:</span></p>
<pre class="source-code">
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
          // ...
          .oauth2Login(oauth2Login -&gt; oauth2Login
                .userInfoEndpoint(userInfo -&gt; userInfo
                      .userAuthoritiesMapper(grantedAuthoritiesMapper())
                )
          );
    return http.build();
}
private GrantedAuthoritiesMapper grantedAuthoritiesMapper() {
    return authorities -&gt; {
       Set&lt;GrantedAuthority&gt; mappedAuthorities = new HashSet&lt;&gt;();
       authorities.forEach(authority -&gt; {
          GrantedAuthority mappedAuthority;
          if (authority instanceof OidcUserAuthority) {
             OidcUserAuthority userAuthority = (OidcUserAuthority) authority;
             mappedAuthority = new OidcUserAuthority(
                   "OIDC_USER", userAuthority.getIdToken(), userAuthority.getUserInfo());
          } else if (authority instanceof OAuth2UserAuthority) {
             OAuth2UserAuthority userAuthority = (OAuth2UserAuthority) authority;
             mappedAuthority = new OAuth2UserAuthority(
                   "OAUTH2_USER", userAuthority.getAttributes());
          } else {
             mappedAuthority = authority;
          }
          mappedAuthorities.add(mappedAuthority);
       });
       return mappedAuthorities;
    };
}</pre> <h3>Handling deprecations for OAuth2 clients</h3>
<p>In <strong class="source-inline">Spring Security 6</strong>, obsolete <a id="_idIndexMarker1201"/>classes and methods have been eliminated from the OAuth2 client. The deprecated items are outlined as follows, along with their respective <span class="No-Break">direct replacements:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table005-2">
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Class</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Deprections list</strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ServletOAuth2 Authorized</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">ClientExchange FilterFunction</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">setAccessTokenExpiresSkew(…)</strong> can be replaced with <span class="No-Break">one of:</span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">ClientCr</strong></span><span class="No-Break"><strong class="source-inline">edentialsOAuth2Authorized ClientProvider#setClockSkew(…)</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">RefreshTokenOAuth2AuthorizedClient Provider#setClockSkew(…)</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">JwtBearerOAu</strong></span><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">th2Authorized ClientProvider#setClockSkew(…)</strong></span></li>
</ul>
<p>The <span class="No-Break">method </span><span class="No-Break"><strong class="source-inline">setClientCredentials</strong></span><strong class="source-inline">
TokenResponseClient(…)</strong> can be replaced with the <span class="No-Break">constructor </span><span class="No-Break"><strong class="source-inline">ServletOAuth2Authorized</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">ClientExchangeFilterFunction (OAuth2AuthorizedClientManager)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">OidcUserInfo</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">phoneNumberVerified(String)</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">phoneNumberVerified(Boolean)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">OAuth2Authorized ClientArgument}Resolver</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">setClientCredentialsTokenResponseClient(…)</strong> can be replaced with the <span class="No-Break">constructor </span><span class="No-Break"><strong class="source-inline">OAuth2AuthorizedClient</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">ArgumentResolver (OAuth2AuthorizedClientManager)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ClaimAccessor</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">containsClaim(…)</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">hasClaim(…)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">OidcClient InitiatedLogout</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">SuccessHandler</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">setPostLogoutRedirectUri(URI)</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">setPostLogoutRedirectUri(String)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">HttpSessionOAuth2 Authorization</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">RequestRepository</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">setAllowMultipleAuthorizationRequests(…)</strong> has no <span class="No-Break">direct replacement</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">AuthorizationRequest Repository</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline" lang="en-US" xml:lang="en-US">removeAuthorizationRequest(HttpServletRequest)</strong><span lang="en-US" xml:lang="en-US"> can be replaced with </span><span class="No-Break"><strong class="source-inline" lang="en-US" xml:lang="en-US">removeAuthorizationRequest(HttpServletRequest, HttpServletResponse)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ClientRegistration</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">getRedirectUriTemplate() </strong>can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">getRedirectUri()</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ClientRegistration .Builder</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The method <strong class="source-inline">redirectUriTemplate(…)</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">redirectUri(…)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">AbstractOAuth2 Authorization</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">GrantRequest</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The <span class="No-Break">constructor </span><span class="No-Break"><strong class="source-inline">AbstractOAuth2Authorization</strong></span><strong class="source-inline">
GrantRequest(AuthorizationGrantType)</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">AbstractOAuth2Authorization</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">GrantRequest(AuthorizationGrantType, ClientRegistration)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ClientAuthentication Method</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The static field <strong class="source-inline">BASIC</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">CLIENT_SECRET_BASIC</strong></span></p>
<p>The static field <strong class="source-inline">POST</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">CLIENT_SECRET_POST</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">OAuth2Access TokenResponse</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">HttpMessage Converter</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The field <strong class="source-inline">tokenResponseConverter</strong> has no <span class="No-Break">direct replacement</span></p>
<p>The method <strong class="source-inline">setTokenResponseConverter(…)</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">setAccessTokenResponseConverter(…)</strong></span></p>
<p>The field <strong class="source-inline">tokenResponseParametersConverter</strong> has no <span class="No-Break">direct replacement</span></p>
<p>The method <strong class="source-inline">setTokenResponseParametersConverter(…)</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">setAccessTokenResponse</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">ParametersConverter(…)</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">Nimbus AuthorizationCode</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">TokenResponseClient</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The <span class="No-Break">class </span><span class="No-Break"><strong class="source-inline">NimbusAuthorizationCode</strong></span><strong class="source-inline">
TokenResponseClient</strong> can be replaced <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">DefaultAuthorizationCode</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">TokenResponseClient</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">NimbusJwt DecoderJwkSupport</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The class <strong class="source-inline">NimbusJwtDecoderJwkSupport</strong> can be replaced with <strong class="source-inline">NimbusJwtDecoder</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">JwtDecoders</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">ImplicitGrant Configurer</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The class <strong class="source-inline">ImplicitGrantConfigurer</strong> has no <span class="No-Break">direct replacement</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">Authorization GrantType</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The static field <strong class="source-inline">IMPLICIT</strong> has no <span class="No-Break">direct replacement</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">OAuth2Authorization ResponseType</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The static field <strong class="source-inline">TOKEN</strong> has no <span class="No-Break">direct replacement</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">OAuth2Authorization Request</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The static method <strong class="source-inline">implicit()</strong> has no <span class="No-Break">direct replacement</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">JwtAuthentication Converter</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The <strong class="source-inline">extractAuthorities</strong> method will be deprecated and removed. Instead of extending <strong class="source-inline">JwtAuthenticationConverter</strong>, it is recommended to provide a custom granted authorities converter <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">JwtAuthenticationConverter#set</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">JwtGrantedAuthoritiesConverter</strong></span><span class="No-Break">.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 16.5 – List of OAuth2 deprecations</p>
<p class="callout-heading">Important note</p>
<p class="callout">The use of the implicit grant type is discouraged, and all associated support has been removed in <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6</strong></span><span class="No-Break">.</span></p>
<p>After <a id="_idIndexMarker1202"/>covering <strong class="source-inline">Spring Security 6</strong> OAuth updates, let’s now delve into updates <span class="No-Break">regarding SAML.</span></p>
<h2 id="_idParaDest-359"><a id="_idTextAnchor531"/>SAML Updates</h2>
<p><strong class="bold">Spring Security SAML Extensions</strong> deliver<a id="_idIndexMarker1203"/> support for service providers through a set of filters, which can be activated by manually adding each filter in the<a id="_idIndexMarker1204"/> correct sequence to various <strong class="source-inline">Spring Security</strong> <span class="No-Break">filter chains.</span></p>
<p>In the case of <strong class="source-inline">Spring Security</strong>’s SAML 2.0 service provider support, you can enable it using the <strong class="source-inline">Spring Security</strong> <strong class="source-inline">saml2Login</strong> and <strong class="source-inline">saml2Logout</strong> DSL methods. These methods automatically select the appropriate filters and position them in the relevant locations within the <span class="No-Break">filter chain.</span></p>
<p>In the following sections, we will explore the main <span class="No-Break">SAML updates.</span></p>
<h3>Moving to OpenSAML 4</h3>
<p><strong class="bold">OpenSAML 3</strong> has<a id="_idIndexMarker1205"/> reached the end of its life cycle. Consequently, <strong class="source-inline">Spring Security 6</strong> discontinues<a id="_idIndexMarker1206"/> support for <strong class="source-inline">OpenSAML 3</strong> and upgrades its baseline to <span class="No-Break"><strong class="source-inline">OpenSAML 4</strong></span><span class="No-Break">.</span></p>
<p>To<a id="_idIndexMarker1207"/> upgrade to <strong class="source-inline">Spring Security 6</strong>’s <strong class="source-inline">SAML</strong> support, you are required to use <strong class="bold">OpenSAML</strong>, version <strong class="source-inline">4.1.1</strong> <span class="No-Break">or later.</span></p>
<h3>Utilizing the OpenSaml4AuthenticationProvider</h3>
<p>To <a id="_idIndexMarker1208"/>simultaneously accommodate both <strong class="bold">OpenSAML 3</strong> and <strong class="bold">4</strong>, <strong class="source-inline">Spring Security</strong> introduced <strong class="source-inline">OpenSamlAuthenticationProvider</strong> and <strong class="source-inline">OpenSaml4AuthenticationProvider</strong>. However, with the removal of <strong class="bold">OpenSAML 3</strong> support in <strong class="source-inline">Spring Security 6</strong>, <strong class="source-inline">OpenSamlAuthenticationProvider</strong> has also <span class="No-Break">been discontinued.</span></p>
<p>It’s important to note that not all methods from <strong class="source-inline">OpenSamlAuthenticationProvider</strong> were directly transferred to <strong class="source-inline">OpenSaml4AuthenticationProvider</strong>. Consequently, some adjustments will be necessary to address the changes when implementing <span class="No-Break">the challenge.</span></p>
<h3>Avoiding use of SAML 2.0 Converter constructors</h3>
<p>In the initial <a id="_idIndexMarker1209"/>version of <strong class="source-inline">Spring Security</strong> SAML 2.0 support, the <strong class="source-inline">Saml2MetadataFilter</strong> and <strong class="source-inline">Saml2AuthenticationTokenConverter</strong> were initially equipped with constructors of the <strong class="source-inline">Converter</strong> type. This level of abstraction posed challenges in evolving the class, leading to the introduction of a dedicated interface, <strong class="source-inline">RelyingPartyRegistrationResolver</strong>, in a <span class="No-Break">subsequent release.</span></p>
<p>In version 6.0, the <strong class="source-inline">Converter</strong> constructors have been eliminated. To adapt to this change, modify classes that implement <strong class="source-inline">Converter&lt;HttpServletRequest</strong>,<strong class="source-inline"> RelyingPartyRegistration&gt;</strong> to instead <span class="No-Break">implement </span><span class="No-Break"><strong class="source-inline">RelyingPartyRegistrationResolver</strong></span><span class="No-Break">.</span></p>
<h3>Transitioning to utilizing Saml2AuthenticationRequestResolver</h3>
<p>In <strong class="source-inline">Spring Security 6</strong>, <strong class="source-inline">Saml2AuthenticationContextResolver</strong>, <strong class="source-inline">Saml2AuthenticationRequestFactory</strong>, and the associated <strong class="source-inline">Saml2WebSsoAuthenticationRequestFilter</strong> <span class="No-Break">are eliminated.</span></p>
<p>They are<a id="_idIndexMarker1210"/> replaced by <strong class="source-inline">Saml2AuthenticationRequestResolver</strong> and a new constructor in <strong class="source-inline">Saml2WebSsoAuthenticationRequestFilter</strong>. The revised interface removes an unnecessary transport object between <span class="No-Break">these classes.</span></p>
<p>While most applications won’t require significant changes, if you currently use or configure <strong class="source-inline">Saml2AuthenticationRequestContextResolver</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">Saml2Authentication</strong></span><strong class="source-inline">
RequestFactory</strong>, consider the following steps to transition <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">Saml2Authentication</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">RequestResolver</strong></span><span class="No-Break">.</span></p>
<h4>Replacing setAuthenticationRequestContextConverter</h4>
<p>Instead of <a id="_idIndexMarker1211"/>using <strong class="source-inline">setAuthenticationRequestContextConverter</strong>, you should move to <strong class="source-inline">setAuthnRequestCustomizer</strong> in <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6</strong></span><span class="No-Break">.</span></p>
<p>Furthermore, as <strong class="source-inline">setAuthnRequestCustomizer</strong> has direct access to the <strong class="source-inline">HttpServletRequest</strong>, there is no necessity for a <strong class="source-inline">Saml2AuthenticationRequestContextResolver</strong>. Simply utilize <strong class="source-inline">setAuthnRequestCustomizer</strong> to directly retrieve the required information from <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">HttpServletRequest</strong></span><span class="No-Break">.</span></p>
<h4>Replacing setProtocolBinding</h4>
<p>The following <a id="_idIndexMarker1212"/>implementation <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">setProtocolBinding</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
@Bean
Saml2AuthenticationRequestFactory authenticationRequestFactory() {
    OpenSaml4AuthenticationRequestFactory factory = new OpenSaml4AuthenticationRequestFactory();
    factory.setProtocolBinding("urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST")
    return factory;
}</pre> <p>can be<a id="_idIndexMarker1213"/> replaced <span class="No-Break">as follows:</span></p>
<pre class="source-code">
@Bean
Saml2AuthenticationRequestResolver authenticationRequestResolver() {
    OpenSaml4AuthenticationRequestResolver reaolver = new OpenSaml4AuthenticationRequestResolver(registrations);
    resolver.setAuthnRequestCustomizer((context) -&gt; context.getAuthnRequest()
          .setProtocolBinding("urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"));
    return resolver;
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">As <strong class="source-inline">Spring Security</strong> exclusively supports the <strong class="source-inline">POST</strong> binding for authentication, overriding the protocol binding at this juncture doesn’t yield <span class="No-Break">significant value.</span></p>
<h4>Utilizing the most recent constructor for Saml2AuthenticationToken</h4>
<p>Prior <a id="_idIndexMarker1214"/>to <strong class="source-inline">Spring Security 6</strong>, the <strong class="source-inline">Saml2AuthenticationToken</strong> constructor required multiple individual settings as parameters, posing challenges when adding new parameters. Recognizing that most of these settings were inherent to <strong class="source-inline">RelyingPartyRegistration</strong>, a more stable constructor was introduced. This new constructor allows the provision of a <strong class="source-inline">RelyingPartyRegistration</strong>, aligning more closely with the design <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">OAuth2LoginAuthenticationToken</strong></span><span class="No-Break">.</span></p>
<p>While most applications typically do not directly instantiate this class, as it is usually handled by <strong class="source-inline">Saml2WebSsoAuthenticationFilter</strong>, if your application does instantiate it, you <a id="_idIndexMarker1215"/>should update the constructor <span class="No-Break">as follows:</span></p>
<pre class="source-code">
new Saml2AuthenticationToken(saml2Response, registration)</pre> <h4>Leveraging the updated methods in RelyingPartyRegistration</h4>
<p>In the<a id="_idIndexMarker1216"/> initial version of <strong class="source-inline">Spring Security</strong>’s <strong class="bold">SAML</strong> support, there was some ambiguity regarding the interpretation of certain <strong class="source-inline">RelyingPartyRegistration</strong> methods and their functionalities. To address this issue and accommodate the introduction of additional capabilities to <strong class="source-inline">RelyingPartyRegistration</strong>, it became imperative to clarify the ambiguity by renaming the methods to align with the <span class="No-Break">specification language.</span></p>
<p>After examining the various configuration migration options from <strong class="source-inline">Spring Security 5.x</strong> to <strong class="source-inline">Spring Security 6.x</strong>, the subsequent section will demonstrate a practical example of migrating a JDBC application from <strong class="source-inline">Spring Security 5.x</strong> to <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 6.x</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-360"><a id="_idTextAnchor532"/>Applying the migration steps from Spring Security 5.x to Spring Security 6.x</h1>
<p>In this section, we’ll <a id="_idIndexMarker1217"/>delve into the process of migrating a sample application from <strong class="source-inline">Spring Security 5.x</strong> to <strong class="source-inline">Spring Security 6.x</strong>. This migration aims to ensure compatibility with the latest features, improvements, and security enhancements offered by the <span class="No-Break">newer version.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">The initial state of the application written in <strong class="source-inline">Spring Security 5.x</strong> is available in the <span class="No-Break">project </span><span class="No-Break"><strong class="source-inline">chapter16.00-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-361"><a id="_idTextAnchor533"/>Reviewing Application dependencies</h2>
<p>The following<a id="_idIndexMarker1218"/> snippet defines the initial dependencies needed for <strong class="source-inline">Spring </strong><span class="No-Break"><strong class="source-inline">Security 5.x</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
//build.gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '2.7.18'
    id 'io.spring.dependency-management' version '1.1.4'
}
...
dependencies {
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    // JPA / ORM / Hibernate:
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity5'
    // H2 db
    implementation 'com.h2database:h2'
    // webjars
    implementation 'org.webjars:webjars-locator:0.50'
    implementation 'org.webjars:bootstrap:5.3.2'
    //Tests
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}</pre> <p>In the<a id="_idIndexMarker1219"/> migrated version of <strong class="source-inline">build.gradle</strong>, we will upgrade <strong class="source-inline">Spring Security</strong> to <span class="No-Break">version 6.x:</span></p>
<pre class="source-code">
//build.gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.1
    id 'io.spring.dependency-management' version '1.1.4'
}
...
dependencies {
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    // JPA / ORM / Hibernate:
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'
    // H2 db
    implementation 'com.h2database:h2'
    // webjars
    implementation 'org.webjars:webjars-locator:0.50'
    implementation 'org.webjars:bootstrap:5.3.2'
    //Tests
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}</pre> <h2 id="_idParaDest-362"><a id="_idTextAnchor534"/>Migrating from the javax to jakarta namespace</h2>
<p>The <a id="_idIndexMarker1220"/>migration from the <strong class="source-inline">javax</strong> namespace to the <strong class="source-inline">jakarta</strong> namespace in <strong class="source-inline">Spring Security 6</strong> is primarily driven by changes in the <span class="No-Break">Java ecosystem.</span></p>
<p>This change is necessary due to the evolution of the Java <strong class="bold">Enterprise Edition</strong> (<strong class="bold">EE</strong>) specifications and the community-led Jakarta <span class="No-Break">EE effort.</span></p>
<h2 id="_idParaDest-363"><a id="_idTextAnchor535"/>Replacing WebSecurityConfigurerAdapter and exposing SecurityFilterChain Bean</h2>
<p>As<a id="_idIndexMarker1221"/> explained in the previous section, <strong class="source-inline">Spring Security 6</strong> introduces enhancements and refinements to streamline security configurations. One notable evolution in recent versions involves replacing the traditional <strong class="source-inline">WebSecurityConfigurerAdapter</strong> with a more flexible approach of exposing a <span class="No-Break"><strong class="source-inline">SecurityFilterChain</strong></span><span class="No-Break"> bean.</span></p>
<p>This paradigm shift provides developers with greater control and customization over their security configurations, facilitating finer-grained security setups tailored to specific <span class="No-Break">application requirements.</span></p>
<p>Before the migration, the <strong class="source-inline">SecurityConfig.java</strong> looks <span class="No-Break">like this:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Description("Configure HTTP Security")
    @Override
    protected void configure(final HttpSecurity http) throws Exception {
       http.authorizeRequests(authorizeRequests -&gt; authorizeRequests
             .antMatchers("/webjars/**").permitAll()
             .antMatchers("/css/**").permitAll()
             .antMatchers("/favicon.ico").permitAll()
             .antMatchers("/actuator/**").permitAll()
             .antMatchers("/signup/*").permitAll()
             .antMatchers("/").permitAll()
             .antMatchers("/login/*").permitAll()
             .antMatchers("/logout/*").permitAll()
             .antMatchers("/admin/h2/**").access("isFullyAuthenticated() and hasRole('ADMIN')")
             .antMatchers("/admin/*").hasRole("ADMIN")
             .antMatchers("/events/").hasRole("ADMIN")
             .antMatchers("/**").hasRole("USER")
       );
       // The default AccessDeniedException
       http.exceptionHandling(handler -&gt; handler
             .accessDeniedPage("/errors/403")
       );
       // Login Configuration
       http.formLogin(form -&gt; form
             .loginPage("/login/form")
             .loginProcessingUrl("/login")
             .failureUrl("/login/form?error")
             .usernameParameter("username") // redundant
             .passwordParameter("password") // redundant
             .defaultSuccessUrl("/default", true)
             .permitAll()
       );
       // Logout Configuration
       http.logout(form -&gt; form
             .logoutUrl("/logout")
             .logoutSuccessUrl("/login/form?logout")
             .permitAll()
       );
       // Allow anonymous users
       http.anonymous();
       // CSRF is enabled by default, with Java Config
       //NOSONAR
       http.csrf().disable();
       // Cross Origin Resource Sharing
       http.cors().disable();
       // HTTP Security Headers
       http.headers().disable();
       // Enable &lt;frameset&gt; in order to use H2 web console
       http.headers().frameOptions().disable();
    }
...
}</pre> <p>After the <a id="_idIndexMarker1222"/>migration, we remove <strong class="source-inline">WebSecurityConfigurerAdapter</strong> and expose a <strong class="source-inline">SecurityFilterChain</strong> bean <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
       http.authorizeHttpRequests( authz -&gt; authz
                   .requestMatchers("/webjars/**").permitAll()
                   .requestMatchers("/css/**").permitAll()
                   .requestMatchers("/favicon.ico").permitAll()
                   .requestMatchers("/").permitAll()
                   .requestMatchers("/login/*").permitAll()
                   .requestMatchers("/logout").permitAll()
                   .requestMatchers("/signup/*").permitAll()
                   .requestMatchers("/errors/**").permitAll()
                   // H2 console
                   .requestMatchers("/admin/h2/**")
                   .access(new WebExpressionAuthorizationManager("isFullyAuthenticated() and hasRole('ADMIN')"))
                   .requestMatchers("/events/").hasRole("ADMIN")
                   .requestMatchers("/**").hasRole("USER"))
             .exceptionHandling(exceptions -&gt; exceptions
                   .accessDeniedPage("/errors/403"))
             .formLogin(form -&gt; form
                   .loginPage("/login/form")
                   .loginProcessingUrl("/login")
                   .failureUrl("/login/form?error")
                   .usernameParameter("username")
                   .passwordParameter("password")
                   .defaultSuccessUrl("/default", true)
                   .permitAll())
             .logout(form -&gt; form
                   .logoutUrl("/logout")
                   .logoutSuccessUrl("/login/form?logout")
                   .permitAll())
             // CSRF is enabled by default, with Java Config
             .csrf(AbstractHttpConfigurer::disable);
       // For H2 Console
       http.headers(headers -&gt; headers.frameOptions(FrameOptionsConfig::disable));
       return http.build();
    }
...
}</pre> <p>As <strong class="source-inline">@EnableWebSecurity</strong> no longer <a id="_idIndexMarker1223"/>includes <strong class="source-inline">@Configuration</strong> in <strong class="source-inline">Spring Security 6.x</strong>, we declared both annotations in the migrated version <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">SecurityConfig.java</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">chapter16.01-calendar</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-364"><a id="_idTextAnchor536"/>Summary</h1>
<p>This chapter reviewed the major and minor changes that you will find when upgrading an existing <strong class="source-inline">Spring Security 5.x</strong> project to <strong class="source-inline">Spring Security 6.x</strong>. In this chapter, we have reviewed the significant enhancements to the framework that are likely to motivate an upgrade. We also examined upgrade requirements, dependencies, common types of code, and configuration changes that will prevent applications from working post-upgrade. We also covered the investigation (at a high level) of the overall code reorganization changes that the <strong class="source-inline">Spring Security</strong> authors made as part of code <span class="No-Break">base restructuring.</span></p>
<p>If this is the first chapter you’ve read, we hope that you return to the rest of the book and use this chapter as a guide to allow your upgrade to <strong class="source-inline">Spring Security 6.x</strong> to proceed as smoothly <span class="No-Break">as possible!</span></p>
</div>
</div></body></html>