<html><head></head><body>
<div class="IMG---Figure" id="_idContainer123">
<h1 class="chapter-number" id="_idParaDest-284"><a id="_idTextAnchor293"/><span class="koboSpan" id="kobo.1.1">14</span></h1>
<h1 id="_idParaDest-285"><a id="_idTextAnchor294"/><span class="koboSpan" id="kobo.2.1">Driving the Database Layer</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will implement a database adapter for one of our ports in the domain model, represented by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4.1">WordRepository</span></strong><span class="koboSpan" id="kobo.5.1"> interface. </span><span class="koboSpan" id="kobo.5.2">This will allow our domain model to fetch words to guess from a real database, in this case, using the popular open source database </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">Postgres</span></strong><span class="koboSpan" id="kobo.7.1">. </span><span class="koboSpan" id="kobo.7.2">We will test-drive both the database setup and the code that accesses the database. </span><span class="koboSpan" id="kobo.7.3">To help us do that, we will use a test framework that is designed to simplify writing database integration tests, </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">called </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.9.1">DBRider</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">By the end of the chapter, we will have written an integration test against a running database, implemented the </span><strong class="source-inline"><span class="koboSpan" id="kobo.12.1">fetchesWordByNumber()</span></strong><span class="koboSpan" id="kobo.13.1"> method from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.14.1">WordRepository</span></strong><span class="koboSpan" id="kobo.15.1"> interface, and used the </span><strong class="bold"><span class="koboSpan" id="kobo.16.1">JDBI</span></strong><span class="koboSpan" id="kobo.17.1"> database access library to help us. </span><span class="koboSpan" id="kobo.17.2">We will create a database user with permissions on a table storing words to guess. </span><span class="koboSpan" id="kobo.17.3">We will create that table, then write a SQL query that JDBI will use to retrieve the word we are looking for. </span><span class="koboSpan" id="kobo.17.4">We will use a named parameter SQL query to avoid some application security issues caused by </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">SQL injections.</span></span></p>
<p><span class="koboSpan" id="kobo.19.1">In this chapter, we’re going to cover the following </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">main topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.21.1">Creating a database </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">integration test</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Implementing the word </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">repository adapter</span></span></li>
</ul>
<h1 id="_idParaDest-286"><a id="_idTextAnchor295"/><span class="koboSpan" id="kobo.25.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.26.1">The final code for this chapter can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">at </span></span><a href="B18384_14.xhtml#_idTextAnchor302"><span class="No-Break"><span class="koboSpan" id="kobo.28.1">https://github.com/PacktPublishing/Test-Driven-Development-with-Java/tree/main/chapter14</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.29.1">.</span></span></p>
<h2 id="_idParaDest-287"><a id="_idTextAnchor296"/><span class="koboSpan" id="kobo.30.1">Installing the Postgres database</span></h2>
<p><span class="koboSpan" id="kobo.31.1">We will be using the </span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.32.1">Postgres database in this chapter, which needs installation. </span><span class="koboSpan" id="kobo.32.2">To install Postgres, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.34.1">Go to the following web </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">page: </span></span><a href="B18384_14.xhtml#_idTextAnchor301"><span class="No-Break"><span class="koboSpan" id="kobo.36.1">https://www.postgresql.org/download/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.37.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.38.1">Follow the installation instructions for your </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">operating system.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.40.1">The code has been tested with version 14.5. </span><span class="koboSpan" id="kobo.40.2">It is expected to work on </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">all versions.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">With the setup </span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.43.1">completed, let’s get started implementing our database code. </span><span class="koboSpan" id="kobo.43.2">In the next section, we will use the DBRider framework to create a database </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">integration test.</span></span></p>
<h1 id="_idParaDest-288"><a id="_idTextAnchor297"/><span class="koboSpan" id="kobo.45.1">Creating a database integration test</span></h1>
<p><span class="koboSpan" id="kobo.46.1">In this section, we will create the skeleton of a</span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.47.1"> database integration test using a test framework called DBRider. </span><span class="koboSpan" id="kobo.47.2">We will use this test to drive out the creation of a database table and database user. </span><span class="koboSpan" id="kobo.47.3">We will be working towards implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.48.1">WordRepository</span></strong><span class="koboSpan" id="kobo.49.1"> interface, which will access words stored in a </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">Postgres database.</span></span></p>
<p><span class="koboSpan" id="kobo.51.1">Previously, we created a domain model for our Wordz application, using hexagonal architecture to guide us. </span><span class="koboSpan" id="kobo.51.2">Instead of accessing a database directly, our domain model uses an abstraction, known as a </span><strong class="bold"><span class="koboSpan" id="kobo.52.1">port</span></strong><span class="koboSpan" id="kobo.53.1"> in hexagonal terminology. </span><span class="koboSpan" id="kobo.53.2">One such port is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.54.1">WordRepository</span></strong><span class="koboSpan" id="kobo.55.1"> interface, which represents stored words </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">for guessing.</span></span></p>
<p><span class="koboSpan" id="kobo.57.1">Ports must always be implemented by adapters in hexagonal architecture. </span><span class="koboSpan" id="kobo.57.2">An adapter for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">WordRepository</span></strong><span class="koboSpan" id="kobo.59.1"> interface will be a class that implements the interface, containing all the code needed to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">real database.</span></span></p>
<p><span class="koboSpan" id="kobo.61.1">To test-drive this adapter code, we will write an integration test, using a library that supports testing databases. </span><span class="koboSpan" id="kobo.61.2">The library is called DBRider, and is one of the dependencies listed in the project’s </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">gradle.build</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.63.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.64.1">
dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.2'
    testImplementation 'org.assertj:assertj-core:3.22.0'
    testImplementation 'org.mockito:mockito-core:4.8.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:4.8.0'
</span><strong class="bold"><span class="koboSpan" id="kobo.65.1">    </span></strong><strong class="bold"><span class="koboSpan" id="kobo.66.1">testImplementation 'com.github.database-rider:rider-core:1.33.0'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.67.1">    testImplementation 'com.github.database-rider:rider-junit5:1.33.0'</span></strong><span class="koboSpan" id="kobo.68.1">
    implementation 'org.postgresql:postgresql:42.5.0'
}</span></pre>
<p><span class="koboSpan" id="kobo.69.1">DBRider has an accompanying </span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.70.1">library called </span><strong class="bold"><span class="koboSpan" id="kobo.71.1">rider-junit5</span></strong><span class="koboSpan" id="kobo.72.1">, which integrates with </span><strong class="bold"><span class="koboSpan" id="kobo.73.1">JUnit5</span></strong><span class="koboSpan" id="kobo.74.1">. </span><span class="koboSpan" id="kobo.74.2">With this new</span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.75.1"> test tooling, we can start to write our test. </span><span class="koboSpan" id="kobo.75.2">The first thing to do is set up the test so that it uses DBRider to connect to our </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">Postgres database.</span></span></p>
<h2 id="_idParaDest-289"><a id="_idTextAnchor298"/><span class="koboSpan" id="kobo.77.1">Creating a database test with DBRider</span></h2>
<p><span class="koboSpan" id="kobo.78.1">Before we test-drive any</span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.79.1"> application code, we will need a test that is connected</span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.80.1"> to our Postgres database, running locally. </span><span class="koboSpan" id="kobo.80.2">We start in the usual way, by writing a JUnit5 </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">test class:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.82.1">Create a new test class file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.83.1">/test/</span></strong><span class="koboSpan" id="kobo.84.1"> directory in the new </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">com.wordz.adapters.db</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.86.1"> package:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer111">
<span class="koboSpan" id="kobo.87.1"><img alt="Figure 14.1 – Integration test" src="image/Figure_14.01_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.88.1">Figure 14.1 – Integration test</span></p>
<p><span class="koboSpan" id="kobo.89.1">The IDE will generate the empty test class </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">for us.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.91.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">@DBRider</span></strong><span class="koboSpan" id="kobo.93.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">@DBUnit</span></strong><span class="koboSpan" id="kobo.95.1"> annotations to the </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">test class:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.97.1">@DBRider</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.98.1">@DBUnit(caseSensitiveTableNames = true,</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.99.1">        caseInsensitiveStrategy= Orthography.LOWERCASE)</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.100.1">
public class WordRepositoryPostgresTest {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.101.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.102.1">The parameters</span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.103.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">@DBUnit</span></strong><span class="koboSpan" id="kobo.105.1"> annotation mitigate</span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.106.1"> some odd interactions between Postgres and the DBRider test framework to do with case sensitivity on table and </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">column names.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.108.1">We want to test that a word can be fetched. </span><span class="koboSpan" id="kobo.108.2">Add an empty </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">test method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.110.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.111.1">
    void </span><strong class="bold"><span class="koboSpan" id="kobo.112.1">fetchesWord()</span></strong><span class="koboSpan" id="kobo.113.1">  {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.114.1">
    }</span></pre></li>
<li><span class="koboSpan" id="kobo.115.1">Run the test. </span><span class="koboSpan" id="kobo.115.2">It </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">will fail:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer112">
<span class="koboSpan" id="kobo.117.1"><img alt="Figure 14.2 – DBRider cannot connect to the database" src="image/Figure_14.02_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.118.1">Figure 14.2 – DBRider cannot connect to the database</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.119.1">The next step to fixing this is to follow the DBRider documentation and add code that will be used by the DBRider framework. </span><span class="koboSpan" id="kobo.119.2">We add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">connectionHolder</span></strong><span class="koboSpan" id="kobo.121.1"> field and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">javax.sqlDataSource</span></strong><span class="koboSpan" id="kobo.123.1"> field to </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">support that:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.125.1">
@DBRider</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.126.1">
public class WordRepositoryPostgresTest {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.127.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.128.1">private DataSource dataSource;</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.129.1">    private final ConnectionHolder connectionHolder</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.130.1">                = () -&gt; dataSource.getConnection();</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.131.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.132.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">dataSource</span></strong><span class="koboSpan" id="kobo.134.1"> is the standard </span><strong class="bold"><span class="koboSpan" id="kobo.135.1">JDBC</span></strong><span class="koboSpan" id="kobo.136.1"> way of creating a connection to our Postgres database. </span><span class="koboSpan" id="kobo.136.2">We run</span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.137.1"> the test. </span><span class="koboSpan" id="kobo.137.2">It fails with a different </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">error </span></span><span class="No-Break"><a id="_idIndexMarker764"/></span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">message:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer113">
<span class="koboSpan" id="kobo.140.1"><img alt="Figure 14.3 – dataSource is null" src="image/Figure_14.03_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.141.1">Figure 14.3 – dataSource is null</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.142.1">We correct this by adding a </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">@BeforeEach</span></strong><span class="koboSpan" id="kobo.144.1"> method to set </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">up </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">dataSource</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.148.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.149.1">@BeforeEach</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.150.1">
    void </span><strong class="bold"><span class="koboSpan" id="kobo.151.1">setupConnection</span></strong><span class="koboSpan" id="kobo.152.1">() {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.153.1">
        var ds = new PGSimpleDataSource();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.154.1">
        ds.setServerNames(new String[]{"</span><strong class="bold"><span class="koboSpan" id="kobo.155.1">localhost</span></strong><span class="koboSpan" id="kobo.156.1">"});</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.157.1">
        ds.setDatabaseName("</span><strong class="bold"><span class="koboSpan" id="kobo.158.1">wordzdb</span></strong><span class="koboSpan" id="kobo.159.1">");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.160.1">
        ds.setCurrentSchema("</span><strong class="bold"><span class="koboSpan" id="kobo.161.1">public</span></strong><span class="koboSpan" id="kobo.162.1">");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.163.1">
        ds.setUser("</span><strong class="bold"><span class="koboSpan" id="kobo.164.1">ciuser</span></strong><span class="koboSpan" id="kobo.165.1">");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.166.1">
        ds.setPassword("</span><strong class="bold"><span class="koboSpan" id="kobo.167.1">cipassword</span></strong><span class="koboSpan" id="kobo.168.1">");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.169.1">
        this.dataSource = ds;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.170.1">
    }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.171.1">This specifies we want a user called </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">ciuser</span></strong><span class="koboSpan" id="kobo.173.1"> with the password </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">cipassword</span></strong><span class="koboSpan" id="kobo.175.1"> to connect to a database</span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.176.1"> called </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">wordzdb</span></strong><span class="koboSpan" id="kobo.178.1">, running on </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">localhost</span></strong><span class="koboSpan" id="kobo.180.1"> at the default port for </span><a id="_idIndexMarker766"/><span class="No-Break"><span class="koboSpan" id="kobo.181.1">Postgres (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">5432</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">).</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.184.1">Run the test and see </span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">it fail:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer114">
<span class="koboSpan" id="kobo.186.1"><img alt="Figure 14.4 – User does not exist" src="image/Figure_14.04_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.187.1">Figure 14.4 – User does not exist</span></p>
<p><span class="koboSpan" id="kobo.188.1">The error is caused because we do not have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">ciuser</span></strong><span class="koboSpan" id="kobo.190.1"> user known to our Postgres database yet. </span><span class="koboSpan" id="kobo.190.2">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">create one.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.192.1">Open a </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">psql</span></strong><span class="koboSpan" id="kobo.194.1"> terminal and create </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">the user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.196.1">create user ciuser with password 'cipassword';</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.197.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">test again:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer115">
<span class="koboSpan" id="kobo.199.1"><img alt="Figure 14.5 – Database not found" src="image/Figure_14.05_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.200.1">Figure 14.5 – Database not found</span></p>
<p><span class="koboSpan" id="kobo.201.1">It fails because the DBRider framework</span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.202.1"> is looking to connect our </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.203.1">new </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">ciuser</span></strong><span class="koboSpan" id="kobo.205.1"> user to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">wordzdb</span></strong><span class="koboSpan" id="kobo.207.1"> database. </span><span class="koboSpan" id="kobo.207.2">This database does </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">not exist.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.209.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">psql</span></strong><span class="koboSpan" id="kobo.211.1"> terminal, create </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">the database:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.213.1">create database wordzdb;</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.214.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">test again:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer116">
<span class="koboSpan" id="kobo.216.1"><img alt="Figure 14.6 – Test passes" src="image/Figure_14.06_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.217.1">Figure 14.6 – Test passes</span></p>
<p><span class="koboSpan" id="kobo.218.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">fetchesWord()</span></strong><span class="koboSpan" id="kobo.220.1"> test now passes. </span><span class="koboSpan" id="kobo.220.2">We recall that the test method itself is empty, but this means we have enough database set up to proceed with test-driving production code. </span><span class="koboSpan" id="kobo.220.3">We will return to database setup soon enough, but we will allow our test-driving to guide us. </span><span class="koboSpan" id="kobo.220.4">The next job is to add the missing Arrange, Act, and Assert code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">fetchesWord()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.222.1"> test.</span></span></p>
<h2 id="_idParaDest-290"><a id="_idTextAnchor299"/><span class="koboSpan" id="kobo.223.1">Driving out the production code</span></h2>
<p><span class="koboSpan" id="kobo.224.1">Our goal is to test-drive code to fetch a word from the database. </span><span class="koboSpan" id="kobo.224.2">We want that code to be in a class that implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">WordRepository</span></strong><span class="koboSpan" id="kobo.226.1"> interface, which we defined in the domain model. </span><span class="koboSpan" id="kobo.226.2">We will want to design enough of our database schema to support this. </span><span class="koboSpan" id="kobo.226.3">By starting to add code to the </span><em class="italic"><span class="koboSpan" id="kobo.227.1">Assert</span></em><span class="koboSpan" id="kobo.228.1"> step, we can</span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.229.1"> drive out an implementation quickly. </span><span class="koboSpan" id="kobo.229.2">This is a useful technique – writing the test by starting with the assert, so that we start with the desired outcome. </span><span class="koboSpan" id="kobo.229.3">We can then work backward to include everything necessary for </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">delivering it:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.231.1">Add the Assert step to our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">fetchesWord()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.233.1"> test:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.234.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.235.1">
    public void fetchesWord()  {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.236.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.237.1">String actual = "";</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.238.1">        assertThat(actual).isEqualTo("ARISE");</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.239.1">
    }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.240.1">We want to check that we can fetch the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">ARISE</span></strong><span class="koboSpan" id="kobo.242.1"> from the database. </span><span class="koboSpan" id="kobo.242.2">This test fails. </span><span class="koboSpan" id="kobo.242.3">We need to create a class to contain the </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">necessary code.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.244.1">We want our new adapter class to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">WordRepository</span></strong><span class="koboSpan" id="kobo.246.1"> interface, so we drive this out in the Arrange step of </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">our test:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.248.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.249.1">
    public void fetchesWord()  {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.250.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.251.1">WordRepository repository</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.252.1">                 = new WordRepositoryPostgres();</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.253.1">
        String actual = "";</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.254.1">
        assertThat(actual).isEqualTo("ARISE");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.255.1">
    }</span></pre></li>
<li><span class="koboSpan" id="kobo.256.1">We now let the IDE wizard do most of the work in creating our new adapter class. </span><span class="koboSpan" id="kobo.256.2">Let’s call it </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">WordRepositoryPostgres</span></strong><span class="koboSpan" id="kobo.258.1">, which links the two facts that the class implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">WordRepository</span></strong><span class="koboSpan" id="kobo.260.1"> interface and is also implementing access to a Postgres database. </span><span class="koboSpan" id="kobo.260.2">We use the </span><strong class="bold"><span class="koboSpan" id="kobo.261.1">New Class</span></strong><span class="koboSpan" id="kobo.262.1"> wizard and place it in a new </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">package, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">com.wordz.adapters.db</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer117">
<span class="koboSpan" id="kobo.266.1"><img alt="Figure 14.7 – New Class wizard" src="image/Figure_14.07_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.267.1">Figure 14.7 – New Class wizard</span></p>
<p><span class="koboSpan" id="kobo.268.1">This results in an</span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.269.1"> empty skeleton for </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">the class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.271.1">
package com.wordz.adapters.db;
import com.wordz.domain.WordRepository;
</span><strong class="bold"><span class="koboSpan" id="kobo.272.1">public class WordRepositoryPostgres implements</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.273.1">                                     WordRepository {</span></strong><span class="koboSpan" id="kobo.274.1">
}</span></pre>
<ol>
<li value="4"><span class="koboSpan" id="kobo.275.1">The IDE will auto-generate method stubs for </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">the interface:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.277.1">
public class WordRepositoryPostgres implements WordRepository {</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.278.1">    @Override</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.279.1">    public String fetchWordByNumber(int number) {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.280.1">        return null;</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.281.1">    }</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.282.1">    </span></strong><strong class="bold"><span class="koboSpan" id="kobo.283.1">@Override</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.284.1">    public int highestWordNumber() {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.285.1">        return 0;</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.286.1">    }</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.287.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.288.1">Returning to our test, we can</span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.289.1"> add the act line, which will call the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">fetchWordByNumber()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.291.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.292.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.293.1">
    public void fetchesWord()  {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.294.1">
        WordRepository repository</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.295.1">
                    = new WordRepositoryPostgres();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.296.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.297.1">String actual =</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.298.1">               repository.fetchWordByNumber(27);</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.299.1">
        assertThat(actual).isEqualTo("ARISE");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.300.1">
    }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.301.1">A word of explanation about the mysterious constant </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">27</span></strong><span class="koboSpan" id="kobo.303.1"> passed in to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">fetchWordByNumber()</span></strong><span class="koboSpan" id="kobo.305.1"> method. </span><span class="koboSpan" id="kobo.305.2">This is an </span><em class="italic"><span class="koboSpan" id="kobo.306.1">arbitrary</span></em><span class="koboSpan" id="kobo.307.1"> number used to identify a particular word. </span><span class="koboSpan" id="kobo.307.2">Its only hard requirement is that it must line up with the word number given in the stub test data, which we will see a little later in a JSON file. </span><span class="koboSpan" id="kobo.307.3">The actual value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">27</span></strong><span class="koboSpan" id="kobo.309.1"> is of no significance beyond lining up with the word number of the </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">stub data.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.311.1">Pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">dataSource</span></strong><span class="koboSpan" id="kobo.313.1"> in to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">WordRepositoryPostgres</span></strong><span class="koboSpan" id="kobo.315.1"> constructor so that our class has a way to</span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.316.1"> access </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">the database:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.318.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.319.1">
    public void fetchesWord()  {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.320.1">
        WordRepository repository</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.321.1">
              = new</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.322.1">
                WordRepositoryPostgres(</span><strong class="bold"><span class="koboSpan" id="kobo.323.1">dataSource</span></strong><span class="koboSpan" id="kobo.324.1">);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.325.1">
        String actual = adapter.fetchWordByNumber(27);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.326.1">
        assertThat(actual).isEqualTo("ARISE");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.327.1">
    }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.328.1">This drives out a change to </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">the constructor:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.330.1">
    public WordRepositoryPostgres(</span><strong class="bold"><span class="koboSpan" id="kobo.331.1">DataSource dataSource</span></strong><span class="koboSpan" id="kobo.332.1">){
        // Not implemented
    }</span></pre>
<ol>
<li value="7"><span class="koboSpan" id="kobo.333.1">The last bit of setup to do in our test is to populate the database with the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">ARISE</span></strong><span class="koboSpan" id="kobo.335.1">. </span><span class="koboSpan" id="kobo.335.2">We do this using a JSON file that the DBRider framework will apply to our database on </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">test startup:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.337.1">
{</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.338.1">
  "word": [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.339.1">
    {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.340.1">
      "word_number": 27,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.341.1">
      "word": "ARISE"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.342.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.343.1">
  ]</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.344.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.345.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">"word_number": 27</span></strong><span class="koboSpan" id="kobo.347.1"> code here corresponds to the value used in the </span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">test code.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.349.1">This file must be saved in a specific</span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.350.1"> location so that DBRider can find it. </span><span class="koboSpan" id="kobo.350.2">We call the file </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">wordTable.json</span></strong><span class="koboSpan" id="kobo.352.1"> and save it in the test directory, </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">/resources/adapters/data</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer118">
<span class="koboSpan" id="kobo.356.1"><img alt="Figure 14.8 – Location of wordTable.json" src="image/Figure_14.08_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.357.1">Figure 14.8 – Location of wordTable.json</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.358.1">The final step in setting up our failing test is to link the test data </span><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">wordTable.json</span></strong><span class="koboSpan" id="kobo.360.1"> file to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.361.1">fetchesWord()</span></strong><span class="koboSpan" id="kobo.362.1"> test method. </span><span class="koboSpan" id="kobo.362.2">We do this using the DBRider </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">@</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">DataSet</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.365.1"> annotation:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.366.1">
    @Test</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.367.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.368.1">@DataSet("adapters/data/wordTable.json")</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.369.1">
    public void fetchesWord()  {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.370.1">
        WordRepository repository</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.371.1">
            = new WordRepositoryPostgres(dataSource);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.372.1">
        String actual =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.373.1">
                    repository.fetchWordByNumber(27);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.374.1">
        assertThat(actual).isEqualTo("ARISE");</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.375.1">
    }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.376.1">The test now fails and is in a </span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.377.1">position where we can make it pass by writing the database access code. </span><span class="koboSpan" id="kobo.377.2">In the next section, we will use the popular library JDBI to implement database access in an adapter class for our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">WordRepository </span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">interface.</span></span></p>
<h1 id="_idParaDest-291"><a id="_idTextAnchor300"/><span class="koboSpan" id="kobo.380.1">Implementing the WordRepository adapter</span></h1>
<p><span class="koboSpan" id="kobo.381.1">In this section, we will use the </span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.382.1">popular database library JDBI to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">fetchWordByNumber()</span></strong><span class="koboSpan" id="kobo.384.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">interface WordRepository</span></strong><span class="koboSpan" id="kobo.386.1"> and make our failing integration </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">test pass.</span></span></p>
<p><span class="koboSpan" id="kobo.388.1">Hexagonal architectures were covered in </span><a href="B18384_09.xhtml#_idTextAnchor179"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.389.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.390.1">, </span><em class="italic"><span class="koboSpan" id="kobo.391.1">Hexagonal Architecture – Decoupling External Systems</span></em><span class="koboSpan" id="kobo.392.1">. </span><span class="koboSpan" id="kobo.392.2">An external system like a database is accessed through a port in the domain model. </span><span class="koboSpan" id="kobo.392.3">The code that is specific to that external system is contained in an adapter. </span><span class="koboSpan" id="kobo.392.4">Our failing test enables us to write the database access code to fetch a word </span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">to guess.</span></span></p>
<p><span class="koboSpan" id="kobo.394.1">A little bit of database</span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.395.1"> design thinking needs to be done before we begin writing code. </span><span class="koboSpan" id="kobo.395.2">For the task at hand, it is enough to note that we will store all available words to guess in a database table named </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">word</span></strong><span class="koboSpan" id="kobo.397.1">. </span><span class="koboSpan" id="kobo.397.2">This table will have two columns. </span><span class="koboSpan" id="kobo.397.3">There will be a primary key named </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">word_number</span></strong><span class="koboSpan" id="kobo.399.1"> and a five-letter word in a column </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">word</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.403.1">Let’s test-drive </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">this out:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.405.1">Run the test to reveal that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">word</span></strong><span class="koboSpan" id="kobo.407.1"> table does </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">not exist:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer119">
<span class="koboSpan" id="kobo.409.1"><img alt="Figure 14.9 – Table not found" src="image/Figure_14.09_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.410.1">Figure 14.9 – Table not found</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.411.1">Correct this by</span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.412.1"> creating a </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">word</span></strong><span class="koboSpan" id="kobo.414.1"> table in the database. </span><span class="koboSpan" id="kobo.414.2">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">psql</span></strong><span class="koboSpan" id="kobo.416.1"> console to run the SQL </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">create </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">table</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.419.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.420.1">create table word (word_number int primary key,</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.421.1">word char(5));</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.422.1">Run the test again. </span><span class="koboSpan" id="kobo.422.2">The</span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.423.1"> error changes to show our </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">ciuser</span></strong><span class="koboSpan" id="kobo.425.1"> user has </span><span class="No-Break"><span class="koboSpan" id="kobo.426.1">insufficient permissions:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer120">
<span class="koboSpan" id="kobo.427.1"><img alt="Figure 14.10 – Insufficient permissions" src="image/Figure_14.10_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.428.1">Figure 14.10 – Insufficient permissions</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.429.1">We correct this by running the SQL </span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">grant</span></strong><span class="koboSpan" id="kobo.431.1"> command in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">psql</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.433.1"> console:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.434.1">grant select, insert, update, delete on all tables in schema public to ciuser;</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.435.1">Run the test again. </span><span class="koboSpan" id="kobo.435.2">The error changes to show us that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">word</span></strong><span class="koboSpan" id="kobo.437.1"> has not been read from the </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">database table:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer121">
<span class="koboSpan" id="kobo.439.1"><img alt="Figure 14.11 – Word not found" src="image/Figure_14.11_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.440.1">Figure 14.11 – Word not found</span></p>
<h2 id="_idParaDest-292"><a id="_idTextAnchor301"/><span class="koboSpan" id="kobo.441.1">Accessing the database</span></h2>
<p><span class="koboSpan" id="kobo.442.1">Having set up the database</span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.443.1"> side of things, we can move on to adding the code that will access the database. </span><span class="koboSpan" id="kobo.443.2">The first step is to add the database library we will use. </span><span class="koboSpan" id="kobo.443.3">It is JDBI, and to use it, we must add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">jdbi3-core</span></strong><span class="koboSpan" id="kobo.445.1"> dependency to our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">gradle.build</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.447.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.448.1">
dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.2'
    testImplementation 'org.assertj:assertj-core:3.22.0'
    testImplementation 'org.mockito:mockito-core:4.8.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:4.8.0'
    testImplementation 'com.github.database-rider:rider-core:1.35.0'
    testImplementation 'com.github.database-rider:rider-junit5:1.35.0'
    implementation 'org.postgresql:postgresql:42.5.0'
    </span><strong class="bold"><span class="koboSpan" id="kobo.449.1">implementation 'org.jdbi:jdbi3-core:3.34.0'</span></strong><span class="koboSpan" id="kobo.450.1">
}</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.451.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.452.1">The code itself is as described in the JDBI documentation, found </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">here: </span></span><a href="B18384_14.xhtml#_idTextAnchor300"><span class="No-Break"><span class="koboSpan" id="kobo.454.1">https://jdbi.org/#_queries</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.455.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.456.1">Follow these steps to access</span><a id="_idIndexMarker780"/> <span class="No-Break"><span class="koboSpan" id="kobo.457.1">the database:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.458.1">First, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">jdbi</span></strong><span class="koboSpan" id="kobo.460.1"> object in the constructor of </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">our class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.462.1">
public class WordRepositoryPostgres</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.463.1">
                         implements WordRepository {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.464.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.465.1">private final Jdbi jdbi;</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.466.1">
    public WordRepositoryPostgres(DataSource</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.467.1">
                                      dataSource){</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.468.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.469.1">jdbi = Jdbi.create(dataSource);</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.470.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.471.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.472.1">This gives us access to the JDBI library. </span><span class="koboSpan" id="kobo.472.2">We have arranged it so that JDBI will access whatever </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">DataSource</span></strong><span class="koboSpan" id="kobo.474.1"> we pass into </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">our constructor.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.476.1">We add the JDBI code to send a SQL query to the database and fetch the word corresponding to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">wordNumber</span></strong><span class="koboSpan" id="kobo.478.1"> we provide as a method parameter. </span><span class="koboSpan" id="kobo.478.2">First, we add the SQL query we </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">will use:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.480.1">
   </span><strong class="bold"><span class="koboSpan" id="kobo.481.1">private static final String SQL_FETCH_WORD_BY_NUMBER</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.482.1">     = "select word from word where "</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.483.1">                      + "word_number=:wordNumber";</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.484.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">jdbi</span></strong><span class="koboSpan" id="kobo.486.1"> access code can be added to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">fetchWordByNumber()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.488.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.489.1">
@Override</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.490.1">
public String fetchWordByNumber(int wordNumber) {</span></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.491.1">    String word = jdbi.withHandle(handle -&gt; {</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.492.1">        var query =</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.493.1">         handle.createQuery(SQL_FETCH_WORD_BY_NUMBER);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.494.1">        query.bind("wordNumber", wordNumber);</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.495.1">        return query.mapTo(String.class).one();</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.496.1">    });</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.497.1">    return word;</span></strong></pre><pre class="source-code"><span class="koboSpan" id="kobo.498.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.499.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.500.1">test </span></span><span class="No-Break"><a id="_idIndexMarker781"/></span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">again:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer122">
<span class="koboSpan" id="kobo.502.1"><img alt="Figure 14.12 – Test passing" src="image/Figure_14.12_B18384.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.503.1">Figure 14.12 – Test passing</span></p>
<p><span class="koboSpan" id="kobo.504.1">Our integration test now passes. </span><span class="koboSpan" id="kobo.504.2">The adapter class has read the word from the database and </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">returned it.</span></span></p>
<h2 id="_idParaDest-293"><a id="_idTextAnchor302"/><span class="koboSpan" id="kobo.506.1">Implementing GameRepository</span></h2>
<p><span class="koboSpan" id="kobo.507.1">The same process is used to</span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.508.1"> test-drive the </span><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">highestWordNumber()</span></strong><span class="koboSpan" id="kobo.510.1"> method and to create adapters for the other database access code implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">GameRepository</span></strong><span class="koboSpan" id="kobo.512.1"> interface. </span><span class="koboSpan" id="kobo.512.2">The final code for these can be seen on GitHub with comments to explore some of the issues in database testing, such as how to avoid test failures caused by </span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">stored data.</span></span></p>
<p><span class="koboSpan" id="kobo.514.1">There is a manual step needed to test-drive the implementation code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.515.1">GameRepository</span></strong><span class="koboSpan" id="kobo.516.1"> interface. </span><span class="koboSpan" id="kobo.516.2">We must create a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">game</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.518.1"> table.</span></span></p>
<p><span class="koboSpan" id="kobo.519.1">In psql, type </span><span class="No-Break"><span class="koboSpan" id="kobo.520.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.521.1">
CREATE TABLE game (
    player_name character varying NOT NULL,
    word character(5),
    attempt_number integer DEFAULT 0,
    is_game_over boolean DEFAULT false
);</span></pre>
<h1 id="_idParaDest-294"><a id="_idTextAnchor303"/><span class="koboSpan" id="kobo.522.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.523.1">In this chapter, we have created an integration test for our database. </span><span class="koboSpan" id="kobo.523.2">We used that to test-drive the implementation of a database user, the database table, and the code needed to access our data. </span><span class="koboSpan" id="kobo.523.3">This code implemented the adapter for one of our ports in our hexagonal architecture. </span><span class="koboSpan" id="kobo.523.4">Along the way, we used some new tools. </span><span class="koboSpan" id="kobo.523.5">The DBRider database test framework simplified our test code. </span><span class="koboSpan" id="kobo.523.6">The JDBI database access library simplified our data </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">access code.</span></span></p>
<p><span class="koboSpan" id="kobo.525.1">In the next and final chapter, </span><a href="B18384_15.xhtml#_idTextAnchor306"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.526.1">Chapter 15</span></em></span></a><span class="koboSpan" id="kobo.527.1">, </span><em class="italic"><span class="koboSpan" id="kobo.528.1">Driving the Web Layer</span></em><span class="koboSpan" id="kobo.529.1">, we will add an HTTP interface to our application, turning it into a complete microservice. </span><span class="koboSpan" id="kobo.529.2">We will integrate all the components together, then play our first game of Wordz using the HTTP test </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">tool Postman.</span></span></p>
<h1 id="_idParaDest-295"><a id="_idTextAnchor304"/><span class="koboSpan" id="kobo.531.1">Questions and answers</span></h1>
<ol>
<li value="1"><span class="koboSpan" id="kobo.532.1">Should we automate the manual steps of creating </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">the database?</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.534.1">Yes. </span><span class="koboSpan" id="kobo.534.2">This is an important part of DevOps, where we developers are responsible for getting the code into production and keeping it running there. </span><span class="koboSpan" id="kobo.534.3">The key technique is </span><strong class="bold"><span class="koboSpan" id="kobo.535.1">Infrastructure as Code</span></strong><span class="koboSpan" id="kobo.536.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.537.1">IaC</span></strong><span class="koboSpan" id="kobo.538.1">), which means automating manual steps as code that we check in to the </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">main repository.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.540.1">What tools can help with automating </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">database creation?</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.542.1">Popular tools are </span><strong class="bold"><span class="koboSpan" id="kobo.543.1">Flyway</span></strong><span class="koboSpan" id="kobo.544.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.545.1">Liquibase</span></strong><span class="koboSpan" id="kobo.546.1">. </span><span class="koboSpan" id="kobo.546.2">Both allow us to write scripts that are run at application startup and will migrate the database schema from one version to the next. </span><span class="koboSpan" id="kobo.546.3">They assist in migrating data across schema changes where that is required. </span><span class="koboSpan" id="kobo.546.4">These are outside the scope of </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">this book.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.548.1">What tools can help with installing </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">the database?</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.550.1">Access to a running database server is part of platform engineering. </span><span class="koboSpan" id="kobo.550.2">For cloud-native designs that run on Amazon Web Service, Microsoft Azure, or Google Cloud Platform, use configuration scripting for that platform. </span><span class="koboSpan" id="kobo.550.3">One popular approach is to use Hashicorp’s </span><strong class="bold"><span class="koboSpan" id="kobo.551.1">Terraform</span></strong><span class="koboSpan" id="kobo.552.1">, which aims to be a cross-provider universal scripting language for cloud configuration. </span><span class="koboSpan" id="kobo.552.2">This is outside of the scope of </span><span class="No-Break"><span class="koboSpan" id="kobo.553.1">this book.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.554.1">How often should we run the </span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">integration tests?</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.556.1">Before every check-in to the repository. </span><span class="koboSpan" id="kobo.556.2">While unit tests are fast to run and should be run all the time, integration tests by nature are slower to execute. </span><span class="koboSpan" id="kobo.556.3">It is reasonable to run only unit tests while working on domain code. </span><span class="koboSpan" id="kobo.556.4">We must always ensure we haven’t broken anything unexpectedly. </span><span class="koboSpan" id="kobo.556.5">This is where running integration tests comes in. </span><span class="koboSpan" id="kobo.556.6">These reveal whether we have accidentally changed something that affects the adapter layer code, or whether something has changed regarding </span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">database layout.</span></span></p>
<h1 id="_idParaDest-296"><a id="_idTextAnchor305"/><span class="koboSpan" id="kobo.558.1">Further reading</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.559.1">Documentation for </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">DBRider: </span></span><a href="B18384_14.xhtml#_idTextAnchor299"><span class="No-Break"><span class="koboSpan" id="kobo.561.1">https://github.com/database-rider/database-rider</span></span></a></li>
<li><span class="koboSpan" id="kobo.562.1">JDBI </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">documentation: </span></span><a href="B18384_14.xhtml#_idTextAnchor298"><span class="No-Break"><span class="koboSpan" id="kobo.564.1">https://jdbi.org/#_introduction_to_jdbi_3</span></span></a></li>
<li><span class="koboSpan" id="kobo.565.1">Flyway is a library that allows us to store the SQL commands to create and modify our database schema as source code. </span><span class="koboSpan" id="kobo.565.2">This allows us to automate database </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">changes: </span></span><a href="B18384_14.xhtml#_idTextAnchor297"><span class="No-Break"><span class="koboSpan" id="kobo.567.1">https://flywaydb.org/</span></span></a></li>
<li><span class="koboSpan" id="kobo.568.1">As our application design grows, our database schema will need to change. </span><span class="koboSpan" id="kobo.568.2">This website and the accompanying books describe ways to do this while managing </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">risk: </span></span><a href="B18384_14.xhtml#_idTextAnchor296"><span class="No-Break"><span class="koboSpan" id="kobo.570.1">https://databaserefactoring.com/</span></span></a></li>
<li><span class="koboSpan" id="kobo.571.1">Hosting a Postgres database on Amazon Web Services using their RDS </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">service: </span></span><a href="B18384_14.xhtml#_idTextAnchor295"><span class="No-Break"><span class="koboSpan" id="kobo.573.1">https://aws.amazon.com/rds</span></span></a></li>
</ul>
</div>
</body></html>