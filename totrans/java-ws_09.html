<html><head></head><body>
		<div>
			<div class="Content" id="_idContainer079">
			</div>
		</div>
		<div class="Content" id="_idContainer080">
			<h1 id="_idParaDest-204"><a id="_idTextAnchor207"/>9. Working with HTTP</h1>
		</div>
		<div class="Content" id="_idContainer081">
			<p class="callout-heading">Overview</p>
			<p class="callout">In this chapter, we will examine the fundamentals of HTTP and create a program that connects to a specific web server and downloads data. We will begin with a study of HTTP request methods so that you can begin to practice making requests using Java's <strong class="source-inline">HttpUrlConnection</strong> class on your own. You will then learn to retrieve data using the GET and HEAD requests, and to send JSON-formatted data using the POST request. Towards the end of this chapter, you will learn to extract and parse HTML content using the open-source jsoup library, and explore the <strong class="source-inline">java.net.http</strong> module—a new HTTP class provided by Java 11—which supports both synchronous and asynchronous HTTP requests.</p>
			<h1 id="_idParaDest-205"><a id="_idTextAnchor208"/>Introduction</h1>
			<p>The <strong class="bold">Hypertext Transfer Protocol</strong> (<strong class="bold">HTTP</strong>) forms the base for the <strong class="bold">World Wide Web</strong> (<strong class="bold">WWW</strong>). Using HTTP's <strong class="bold">request-response protocol</strong>, a client, such as a web browser, can request data from a server. In the World Wide Web, a web browser requests content (HTML, JavaScript, images, and so on.), and then displays the results. In many cases, the content that is returned is fairly static.</p>
			<p>Java applications typically differ. In most cases with Java, you will send requests to specialized backend web services for gathering data or updating systems. In both cases, though, the Java coding remains the same.</p>
			<p>This chapter covers how to make HTTP requests from Java applications and parse the response data.</p>
			<h1 id="_idParaDest-206"><a id="_idTextAnchor209"/>Exploring HTTP</h1>
			<p>With HTTP, a client application sends a specially formatted request to a server and then awaits a response. Technically, HTTP is a stateless protocol. This means that the server is not required to maintain any state information related to the client. Each client request can be treated individually as a new operation. The server does not need to store client-specific information.</p>
			<p>Many servers do maintain some sort of state across multiple requests, though, such as when you make a purchase online, and the server needs to store the products you have selected; however, the basic protocol does not require this.</p>
			<p>HTTP is a textual protocol (with allowances for compression). An HTTP request includes the following parts:</p>
			<ul>
				<li>An operation (called a <strong class="bold">request method</strong>), a resource identifier for the operation, and optional parameters on a line.</li>
				<li>Request headers; one per line.</li>
				<li>An empty line.</li>
				<li>A message body, which is optional.</li>
				<li>Each line ends with two characters: a carriage return and a line feed character.</li>
			</ul>
			<p>HTTP uses the following two main concepts for identifying the resources that you are interested in:</p>
			<ul>
				<li>A resource identifier in the <strong class="bold">Universal Resource Identifier</strong> (<strong class="bold">URI</strong>) format identifies a resource on a server.</li>
				<li>A <strong class="bold">Universal Resource Locator</strong> (<strong class="bold">URL</strong>) includes a URI, along with the network protocol information, the server, and port number. URLs are what you type into the address bar of web browsers.</li>
			</ul>
			<p>Java includes classes for both concepts: <strong class="source-inline">java.net.URI</strong> and <strong class="source-inline">java.net.URL</strong>. </p>
			<p>For example, consider the following URL: <strong class="source-inline">http://example.com:80/</strong>.</p>
			<p>In this example, the <strong class="source-inline">http</strong> identifies the protocol. The server is <strong class="source-inline">example.com</strong>, and the port number is <strong class="source-inline">80</strong> (the default HTTP port number). The trailing/character identifies the resource on the server, in this case, the top-level or root resource.</p>
			<p>Most modern websites use the HTTPS protocol. This is a more secure version of HTTP because the data that is sent to and from the server is encrypted.</p>
			<p>For example, consider the following URL: <a href="https://www.packtpub.com/">https://www.packtpub.com/</a>.</p>
			<p>In this case, the protocol is <strong class="source-inline">https</strong> and the server is <strong class="source-inline">www.packtpub.com</strong>. The port defaults to <strong class="source-inline">443</strong> (the default port for HTTPS). As before, the trailing/character identifies the resource on the server.</p>
			<p>A URI can either have the full networking location or be relative to a server. The following are all valid URIs:</p>
			<ul>
				<li><strong class="source-inline">https://www.packtpub.com/tech/java</strong></li>
				<li><strong class="source-inline">http://www.example.com/docs/java.html</strong></li>
				<li><strong class="source-inline">/tech/java</strong></li>
				<li><strong class="source-inline">/docs/java.html</strong></li>
				<li><strong class="source-inline">file:///java.html</strong></li>
			</ul>
			<p>URL is an older term, and generally represents the full specification of a resource on the internet. That said, like URIs, you can have relative URLs as well, such as <strong class="source-inline">java.html</strong>. In most cases, people talk about URIs.</p>
			<p>In general, though, your Java applications will use the <strong class="source-inline">URL</strong> class to establish HTTP connections.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can read more about URIs at <a href="https://packt.live/32ATULO">https://packt.live/32ATULO</a> and URLs at <a href="https://packt.live/2JjIgNN">https://packt.live/2JjIgNN</a>.</p>
			<h2 id="_idParaDest-207"><a id="_idTextAnchor210"/>HTTP Request Methods</h2>
			<p>Each HTTP request starts with a request method, such as GET. The method names come from the early days of the World Wide Web. These methods include the following:</p>
			<ul>
				<li><strong class="source-inline">GET</strong>: This retrieves data from the server.</li>
				<li><strong class="source-inline">HEAD</strong>: This is like a GET request but just retrieves the header information and does not include the response body. </li>
				<li><strong class="source-inline">POST</strong>: This sends data to the server. Most HTML forms on web pages send the form data you fill in as a POST request.</li>
				<li><strong class="source-inline">PUT</strong>: This also sends data to the server. A PUT request is often used to modify a resource, replacing the contents of the existing resource.</li>
				<li><strong class="source-inline">DELETE</strong>: This requests the server to delete the given resource.</li>
				<li><strong class="source-inline">TRACE</strong>: This echoes back the request data that is received by the server. This can be useful for debugging.</li>
				<li><strong class="source-inline">OPTIONS</strong>: This lists the HTTP methods that the server supports for a given URL.<p class="callout-heading">Note</p><p class="callout">There are other HTTP methods as well, notably <strong class="source-inline">CONNECT</strong> and <strong class="source-inline">PATCH</strong>. The <strong class="source-inline">HttpUrlConnection</strong> class, described in this chapter, only supports the ones listed here.</p></li>
			</ul>
			<h2 id="_idParaDest-208"><a id="_idTextAnchor211"/>Representational State Transfer</h2>
			<p><strong class="bold">Representational State Transfer</strong> (<strong class="bold">REST</strong>) is a term that is used to describe web services that use HTTP as a transport protocol. You can think of this as HTTP with objects. With a RESTful web service, for example, a GET request normally returns an object, formatted in the <strong class="bold">JavaScript Object Notation</strong> (<strong class="bold">JSON</strong>). JSON provides a way to encode an object as text in a manner that is independent of the programming language used. JSON formats data as name-value pairs or arrays using JavaScript syntax:</p>
			<p class="source-code">{</p>
			<p class="source-code">    "animal": "dog",</p>
			<p class="source-code">    "name": "biff"</p>
			<p class="source-code">}</p>
			<p>In this example, the object has two properties: <strong class="source-inline">animal</strong> and <strong class="source-inline">name</strong>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Many RESTful web services send and receive data in JSON format. You can refer to <em class="italic">Chapter 19</em>,<em class="italic"> Reflection</em>, for more information on JSON.</p>
			<p>With web services, a <strong class="source-inline">POST</strong> request is typically used to create a new object, a <strong class="source-inline">PUT</strong> request is used to modify an existing object (by replacing it with the new data), and a <strong class="source-inline">DELETE</strong> request is used to delete an object. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">Some frameworks use different meanings for <strong class="source-inline">POST</strong> and <strong class="source-inline">PUT</strong> operations. The approach here is the approach that is used by the Spring Boot framework.</p>
			<p>You'll find that Java is used a lot to create RESTful web services as well as web service clients.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can read the HTTP specification at <a href="https://packt.live/2MxDcHz">https://packt.live/2MxDcHz</a> or read an overview of HTTP at <a href="https://packt.live/35MM1od">https://packt.live/35MM1od</a>. You can refer to <a href="https://packt.live/2MYvHbq">https://packt.live/2MYvHbq</a> for more information on REST web services. Additionally, you can refer to <a href="https://packt.live/2P2Qz3W">https://packt.live/2P2Qz3W</a> for more information on JSON.</p>
			<h2 id="_idParaDest-209"><a id="_idTextAnchor212"/>Request Headers</h2>
			<p>A request header is a name-value pair that provides some information to the server. For example, the <strong class="source-inline">User-Agent</strong> request header identifies the application running on behalf of the user, typically the web browser. Almost all <strong class="source-inline">User-Agent</strong> strings start with <strong class="source-inline">Mozilla/5.0</strong> for historical reasons and because some sites will not render properly without mentioning the now-ancient Mozilla web browser. Servers do use the <strong class="source-inline">User-Agent</strong> header to guide browser-specific rendering. For example, consider the following:</p>
			<p class="source-code">Mozilla/5.0 (iPhone; CPU iPhone OS 12_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Mobile/15E148 Safari/604.1</p>
			<p>This <strong class="source-inline">User-Agent</strong> setting identifies an iPhone browser. The <strong class="source-inline">Referer</strong> header (spelled incorrectly for historical reasons) identifies the web page you are coming from. The <strong class="source-inline">Accept</strong> header lists the format for the data you'd like, such as <strong class="source-inline">text/html</strong>. The <strong class="source-inline">Accept-Language</strong> header lists a language code, such as <strong class="source-inline">de</strong> for German (Deutsch) if you'd like the response to be in German.</p>
			<p>One important point about request headers is that each header can contain multiple values (which are comma separated), even if in most cases you will provide a single value.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can see a list of commonly used request headers at <a href="https://packt.live/2pFjIaH">https://packt.live/2pFjIaH</a>.</p>
			<p>HTTP response messages also contain headers. These response headers can tell your application information about the remote resources.</p>
			<p>Now that we've mentioned the highlights of HTTP, the next step is to start making network requests.</p>
			<h1 id="_idParaDest-210"><a id="_idTextAnchor213"/>Using HttpUrlConnection</h1>
			<p>The <strong class="source-inline">java.net.HttpUrlConnection</strong> class provides the main way to access HTTP resources from Java. To establish an HTTP connection, you can use code like the following:</p>
			<p class="source-code">String path = "http://example.com";</p>
			<p class="source-code">URL url = new URL(path);</p>
			<p class="source-code">HttpURLConnection connection = (HttpURLConnection) url.openConnection();</p>
			<p class="source-code">connection.setRequestMethod("HEAD");</p>
			<p>This code sets up a URL initialized with a link to example.com. The <strong class="source-inline">openConnection()</strong> method on the URL then returns <strong class="source-inline">HttpUrlConnection</strong>. Once you have <strong class="source-inline">HttpUrlConnection</strong>, you can set the HTTP method (<strong class="source-inline">HEAD</strong>, in this case). You can get data from the server, upload data to the server, and specify request headers.</p>
			<p>With <strong class="source-inline">HttpUrlConnection</strong>, you can call <strong class="source-inline">setRequestProperty()</strong> to specify a request header:</p>
			<p class="source-code">connection.setRequestProperty("User-Agent", "Mozilla/5.0");</p>
			<p>Each request generates a response, which may be successful or not. To check the response, get the response code:</p>
			<p class="source-code">int responseCode = connection.getResponseCode();</p>
			<p>A code of 200 is a success. There are other codes in the 200 range that also indicate a success, but with conditions, such as 204, which indicates success but with no content. Codes in the 300s indicate redirects. Codes in the 400s point to client errors, such as the dreaded 404 Not Found error, and codes in the 500s point to server errors.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can see a list of HTTP response codes at <a href="https://packt.live/2OP9Rtr">https://packt.live/2OP9Rtr</a>. These are also defined as constants in the <strong class="source-inline">HttpUrlConnection</strong> class.</p>
			<p>Each response typically comes with a message, such as <strong class="source-inline">OK</strong>. You can retrieve this message by calling <strong class="source-inline">getResponseMessage()</strong>:</p>
			<p class="source-code">System.out.println( connection.getResponseMessage() );</p>
			<p>To see the headers in the response, call <strong class="source-inline">getHeaderFields()</strong>. This method returns a map of headers, where the value is a list of strings:</p>
			<p class="source-code">Map&lt;String, List&lt;String&gt;&gt; headers = connection.getHeaderFields();</p>
			<p class="source-code">for (String key : headers.keySet()) {</p>
			<p class="source-code">    System.out.println("Key: " + key + " Value: " + headers.get(key));</p>
			<p class="source-code">}</p>
			<p class="callout-heading">Note</p>
			<p class="callout">With HTTP, each header can have multiple values, which is why the value in the map is a list.</p>
			<p>You can also retrieve headers one at a time. The next exercise puts all this together to show you how to write a short Java program that creates an <strong class="source-inline">HTTP</strong> <strong class="source-inline">HEAD</strong> request.</p>
			<h2 id="_idParaDest-211"><a id="_idTextAnchor214"/>Exercise 1: Creating a HEAD Request</h2>
			<p>This exercise will send a HEAD request to <strong class="source-inline">example.com</strong>, which is an official practice domain you can use for testing:</p>
			<ol>
				<li>Select <strong class="source-inline">New</strong> and then <strong class="source-inline">Project</strong> from the <strong class="source-inline">File</strong> menu in IntelliJ. </li>
				<li>Select <strong class="source-inline">Gradle</strong> for the type of project. Click <strong class="source-inline">Next</strong>.</li>
				<li>For the Group Id, enter <strong class="source-inline">com.packtpub.net</strong>.</li>
				<li>For the Artifact Id, enter <strong class="source-inline">chapter09</strong>.</li>
				<li>For the Version, enter <strong class="source-inline">1.0</strong>.</li>
				<li>Accept the default setting on the next pane. Click <strong class="source-inline">Next</strong>.</li>
				<li>Leave the project name as <strong class="source-inline">chapter09</strong>.</li>
				<li>Click <strong class="source-inline">Finish</strong>.</li>
				<li>Call up <strong class="source-inline">build.gradle</strong> in the IntelliJ text editor.</li>
				<li>Change <strong class="source-inline">sourceCompatibility</strong> so that it is 12:<p class="source-code">sourceCompatibility = 12</p></li>
				<li>In the <strong class="source-inline">src/main/java</strong> folder, create a new Java package.</li>
				<li>Enter <strong class="source-inline">com.packtpub.http</strong> as the package name.</li>
				<li>Right-click this package in the <strong class="source-inline">Project</strong> pane and create a new Java class named <strong class="source-inline">HeadRequest</strong>.</li>
				<li>Enter the following code:</li>
			</ol>
			<p class="source-code-heading">HeadRequest.java</p>
			<p class="source-code">1  package com.packtpub.http;</p>
			<p class="source-code">2  </p>
			<p class="source-code">3  import java.io.IOException;</p>
			<p class="source-code">4  import java.net.HttpURLConnection;</p>
			<p class="source-code">5  import java.net.MalformedURLException;</p>
			<p class="source-code">6  import java.net.URL;</p>
			<p class="source-code">7  import java.util.List;</p>
			<p class="source-code">8  import java.util.Map;</p>
			<p class="source-code">9  </p>
			<p class="source-code">10 public class HeadRequest {</p>
			<p class="source-code">11     public static void main(String[] args) {</p>
			<p class="source-code">12         String path = "http://example.com";</p>
			<p class="source-code-link"><a href="https://packt.live/2MuxxlC">https://packt.live/2MuxxlC</a></p>
			<p>When you run this program, you will see an output like the following:</p>
			<p class="source-code">Code: 200</p>
			<p class="source-code">OK</p>
			<p class="source-code">Accept-Ranges: [bytes]</p>
			<p class="source-code">null: [HTTP/1.1 200 OK]</p>
			<p class="source-code">X-Cache: [HIT]</p>
			<p class="source-code">Server: [ECS (sec/96DC)]</p>
			<p class="source-code">Etag: ["1541025663+gzip"]</p>
			<p class="source-code">Cache-Control: [max-age=604800]</p>
			<p class="source-code">Last-Modified: [Fri, 09 Aug 2013 23:54:35 GMT]</p>
			<p class="source-code">Expires: [Mon, 18 Mar 2019 20:41:30 GMT]</p>
			<p class="source-code">Content-Length: [1270]</p>
			<p class="source-code">Date: [Mon, 11 Mar 2019 20:41:30 GMT]</p>
			<p class="source-code">Content-Type: [text/html; charset=UTF-8]</p>
			<p>The code of <strong class="source-inline">200</strong> indicates our request was successful. You can then see the response headers. The square brackets in the output come from the default way that Java prints out lists.</p>
			<p>You should feel free to change the initial URL to a site other than <strong class="source-inline">example.com</strong>.</p>
			<h2 id="_idParaDest-212"><a id="_idTextAnchor215"/>Reading the Response Data with a GET Request</h2>
			<p>With a GET request, you will get <strong class="source-inline">InputStream</strong> from the connection to see the response. Call <strong class="source-inline">getInputStream()</strong> to get the data sent back by the server for the resource (URL) you requested. If the response code indicates an error, use <strong class="source-inline">getErrorStream()</strong> to retrieve information about the error, such as a Not Found page. If you expect textual data in the response, such as HTML, text, XML, etc., you can wrap <strong class="source-inline">InputStream</strong> in <strong class="source-inline">BufferedReader</strong>:</p>
			<p class="source-code">BufferedReader in = new BufferedReader(</p>
			<p class="source-code">        new InputStreamReader(connection.getInputStream())</p>
			<p class="source-code">    );</p>
			<p class="source-code">String line;</p>
			<p class="source-code">while ((line = in.readLine()) != null) {</p>
			<p class="source-code">    System.out.println(line);</p>
			<p class="source-code">}</p>
			<p class="source-code">in.close();</p>
			<h2 id="_idParaDest-213"><a id="_idTextAnchor216"/>Exercise 2: Creating a GET Request</h2>
			<p>This exercise prints out the HTML content from example.com. You can change the URL if you wish to and experiment with other web sites:</p>
			<ol>
				<li value="1">In IntelliJ's Project pane, right-click on the <strong class="source-inline">com.packtpub.http</strong> package. Select <strong class="source-inline">New</strong> and then <strong class="source-inline">Java</strong><strong class="bold"> </strong><strong class="source-inline">Class</strong>.</li>
				<li>Enter <strong class="source-inline">GetRequest</strong> as the name of the Java class.</li>
				<li>Enter the following code for <strong class="source-inline">GetRequest.java</strong>:<p class="source-code-heading">GetRequest.java</p><p class="source-code">1  package com.packtpub.http;</p><p class="source-code">2  </p><p class="source-code">3  import java.io.BufferedReader;</p><p class="source-code">4  import java.io.IOException;</p><p class="source-code">5  import java.io.InputStreamReader;</p><p class="source-code">6  import java.net.HttpURLConnection;</p><p class="source-code">7  import java.net.MalformedURLException;</p><p class="source-code">8  import java.net.URL;</p><p class="source-code">9  </p><p class="source-code">10 public class GetRequest {</p><p class="source-code">11     public static void main(String[] args) {</p><p class="source-code">12         String path = "http://example.com";</p><p class="source-code-link"><a href="https://packt.live/2oLZrjZ">https://packt.live/2oLZrjZ</a></p></li>
				<li>Run this program, and you will see the brief HTML content of <strong class="source-inline">example.com</strong>.</li>
			</ol>
			<p>Using this technique, we can write a program to print out the content of a web page using a GET request.</p>
			<h1 id="_idParaDest-214"><a id="_idTextAnchor217"/>Dealing with Slow Connections</h1>
			<p><strong class="source-inline">HttpUrlConnection</strong> offers two methods to help with slow connections:</p>
			<p class="source-code">connection.setConnectTimeout(6000);</p>
			<p class="source-code">connection.setReadTimeout(6000);</p>
			<p>Call <strong class="source-inline">setConnectTimeout()</strong> to adjust the timeout when establishing the network connection to the remote site. The value you give as input should be in milliseconds. Call <strong class="source-inline">setReadTimeout()</strong> to adjust the timeout when reading data on the input stream. Again, provide the new timeout input in milliseconds.</p>
			<h2 id="_idParaDest-215"><a id="_idTextAnchor218"/>Requesting Parameters</h2>
			<p>With many web services, you'll have to input parameters when making a request. HTTP parameters are encoded as name-value pairs. For example, consider the following:</p>
			<p class="source-code">String path = "http://example.com?name1=value1&amp;name2=value2";</p>
			<p>In this case, <strong class="source-inline">name1</strong> is the name of a parameter, and so is <strong class="source-inline">name2</strong>. The value of the <strong class="source-inline">name1</strong> parameter is <strong class="source-inline">value1</strong>, and the value of <strong class="source-inline">name2</strong> is <strong class="source-inline">value2</strong>. Parameters are separated by an ampersand character, <strong class="source-inline">&amp;</strong>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">If the parameter values are simple alphanumeric values, you can enter them as shown in the example. If not, you need to encode the parameter data using URL encoding. You can refer to the <strong class="source-inline">java.net.URLEncoder</strong> class for more details on this.</p>
			<h2 id="_idParaDest-216"><a id="_idTextAnchor219"/>Handling Redirects</h2>
			<p>In many cases, when you make an HTTP request to a server, the server will respond with a status indicating a redirect. This tells your application that the resource has moved to a new location, in other words; you should use a new URL.</p>
			<p><strong class="source-inline">HttpUrlConnection</strong> will automatically follow HTTP redirects. You can turn this off using the <strong class="source-inline">setInstanceFollowRedirects()</strong> method:</p>
			<p class="source-code">connection.setInstanceFollowRedirects(false);</p>
			<h1 id="_idParaDest-217"><a id="_idTextAnchor220"/>Creating HTTP POST Requests</h1>
			<p>POST (and PUT) requests send data to the server. For a POST request, you need to turn on the output mode of <strong class="source-inline">HttpUrlConnection</strong> and set the content type:</p>
			<p class="source-code">connection.setRequestMethod("POST");</p>
			<p class="source-code">connection.setRequestProperty("Content-Type", "application/json");</p>
			<p class="source-code">connection.setDoOutput(true);</p>
			<p>Next, to upload the data, here assumed to be a String, use code like the following:</p>
			<p class="source-code">DataOutputStream out =</p>
			<p class="source-code">        new DataOutputStream( connection.getOutputStream() );</p>
			<p class="source-code">out.writeBytes(content);</p>
			<p class="source-code">out.flush();</p>
			<p class="source-code">out.close();</p>
			<p>With web browsing, most POST requests send form data. From Java programs, however, you are more likely to upload JSON or XML data with POST and PUT requests. Once you upload the data, your program should read the response, especially to see whether the request was successful.</p>
			<h2 id="_idParaDest-218"><a id="_idTextAnchor221"/>Exercise 3: Sending JSON Data with POST Requests</h2>
			<p>In this exercise, we'll send a small JSON object to the <a href="https://packt.live/2oyJqxB">https://packt.live/2oyJqxB</a> test site. The site won't do anything with our data except echo it back, along with some <strong class="bold">metadata</strong> about the request:</p>
			<ol>
				<li value="1">In IntelliJ's Project pane, right-click on the <strong class="source-inline">com.packtpub.http</strong> package. Select <strong class="source-inline">New</strong> and then <strong class="source-inline">Java</strong> Class.</li>
				<li>Enter <strong class="source-inline">PostJson</strong> as the name of the Java class.</li>
				<li>Enter the following code for <strong class="source-inline">PostJson.java</strong>:<p class="source-code-heading">PostJson.java</p><p class="source-code">1  package com.packtpub.http;</p><p class="source-code">2  </p><p class="source-code">3  import java.io.BufferedReader;</p><p class="source-code">4  import java.io.DataOutputStream;</p><p class="source-code">5  import java.io.IOException;</p><p class="source-code">6  import java.io.InputStreamReader;</p><p class="source-code">7  import java.net.HttpURLConnection;</p><p class="source-code">8  import java.net.MalformedURLException;</p><p class="source-code">9  import java.net.URL;</p><p class="source-code">10 </p><p class="source-code">11 public class PostJson {</p><p class="source-code">12     public static void main(String[] args) {</p><p class="source-code">13         /*</p><p class="source-code">14         {</p><p class="source-code">15             "animal": "dog",</p><p class="source-code">16             "name": "biff"</p><p class="source-code">17         }</p><p class="source-code">18         */</p><p class="source-code-link"><a href="https://packt.live/2MYwuZW">https://packt.live/2MYwuZW</a></p></li>
				<li>Run this program, and you should see an output like the following:<p class="source-code">Code: 200</p><p class="source-code">{</p><p class="source-code">    "args": {}, </p><p class="source-code">    "data": "{ \"animal\": \"dog\", \"name\": \"biff\" }", </p><p class="source-code">    "files": {}, </p><p class="source-code">    "form": {}, </p><p class="source-code">    "headers": {</p><p class="source-code">        "Accept": "text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2", </p><p class="source-code">        "Content-Length": "35", </p><p class="source-code">        "Content-Type": "application/json", </p><p class="source-code">        "Host": "httpbin.org", </p><p class="source-code">        "User-Agent": "Java/11.0.2"</p><p class="source-code">    }, </p><p class="source-code">    "json": {</p><p class="source-code">        "animal": "dog", </p><p class="source-code">        "name": "biff"</p><p class="source-code">    }, </p><p class="source-code">    "origin": "46.244.28.23, 46.244.28.23", </p><p class="source-code">    "url": "https://httpbin.org/post"</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">The Apache <strong class="source-inline">HttpComponents</strong> library can help simplify your work with HTTP. For more information, you can refer to <a href="https://packt.live/2BqZbtq">https://packt.live/2BqZbtq</a>.</p></li>
			</ol>
			<h1 id="_idParaDest-219"><a id="_idTextAnchor222"/>Parsing HTML Data</h1>
			<p>An HTML document looks something like the following, but usually with a lot more content:</p>
			<p class="source-code">&lt;!doctype html&gt;</p>
			<p class="source-code">&lt;html lang="en"&gt;</p>
			<p class="source-code">    &lt;head&gt;</p>
			<p class="source-code">        &lt;title&gt;Example Document&lt;/title&gt;</p>
			<p class="source-code">    &lt;/head&gt;</p>
			<p class="source-code">    &lt;body&gt;</p>
			<p class="source-code">        &lt;p&gt;A man, a plan, a canal. Panama.&lt;/p&gt;</p>
			<p class="source-code">    &lt;/body&gt;</p>
			<p class="source-code">&lt;/html&gt;</p>
			<p>HTML structures a document into a tree-like format, as shown in this example by indentation. The <strong class="source-inline">&lt;head&gt;</strong> element appears inside the <strong class="source-inline">&lt;html&gt;</strong> element. The <strong class="source-inline">&lt;title&gt;</strong> element appears inside the <strong class="source-inline">&lt;head&gt;</strong> element. An HTML document can have many levels of hierarchy.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Most web browsers provide an option to view a page's source. Select that and you'll see the HTML for the page.</p>
			<p>When you run a GET request from a Java application, you need to parse the returned HTML data. Typically, you parse that data into a tree structure of objects. One of the handiest ways to do this is with the open-source jsoup library.</p>
			<p>jsoup provides methods to connect using HTTP, download the data, and parse that data into elements that reflect the hierarchy of HTML on the page.</p>
			<p>Using jsoup, the first step is to download a web page. To do so, you can use code like the following:</p>
			<p class="source-code">String path = "https://docs.oracle.com/en/java/javase/12/";</p>
			<p class="source-code">Document doc = Jsoup.connect(path).get();</p>
			<p>This code downloads the official Java 12 documentation start page, which contains a lot of links to specific Java documentation. The parsed HTML data gets placed into the <strong class="source-inline">Document</strong> object, which contains <strong class="source-inline">Element</strong> objects for each HTML element. This is purposely similar to Java's XML parsing API, which similarly parses XML documents into a tree structure of objects. Each element in the tree may have child elements. jsoup provides an API to access these child elements in a similar way to the Java XML parsing API.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can find a lot of useful documentation on the jsoup library at <a href="https://packt.live/2nZbmua">https://packt.live/2nZbmua</a>.</p>
			<p>On the Java 12 documentation page, you will see many links. In the underlying HTML, many of these links appear as follows:</p>
			<p class="source-code">&lt;ul class="topics"&gt;</p>
			<p class="source-code">  &lt;li&gt;</p>
			<p class="source-code">    &lt;a href="/en/java/javase/12/docs/api/overview-summary.html"&gt;API       Documentation &lt;/a&gt;</p>
			<p class="source-code">  &lt;/li&gt;</p>
			<p class="source-code">&lt;/ul&gt;<a id="_idTextAnchor223"/></p>
			<p>If we wanted to extract the URI link (<a href="https://packt.live/2VWd1x7">https://packt.live/2VWd1x7</a>, in this case) as well as the descriptive text (API Documentation), we would need to traverse the    to the <strong class="source-inline">LI</strong> list item tag, and then get the HTML link, which is held in an <strong class="source-inline">A</strong> tag, called an anchor.</p>
			<p>One of the handy features of jsoup is that you can use select elements from the HTML using a selector syntax that is similar to the one that is offered by CSS and the jQuery JavaScript library.</p>
			<p>To select all UL elements that have a CSS class of <strong class="source-inline">topic</strong>, you can use code like the following:</p>
			<p class="source-code">Elements topics = doc.select("ul.topics");</p>
			<p>Once you have the selected elements, you can iterate over each one, as follows:</p>
			<p class="source-code">for (Element topic : topics) {</p>
			<p class="source-code">    for (Element listItem : topic.children()) {</p>
			<p class="source-code">        for (Element link : listItem.children()) {</p>
			<p class="source-code">            String url = link.attr("href");</p>
			<p class="source-code">            String text = link.text();</p>
			<p class="source-code">            System.out.println(url + " " + text);</p>
			<p class="source-code">        }</p>
			<p class="source-code">    }</p>
			<p class="source-code">}</p>
			<p>This code starts at the <strong class="source-inline">UL</strong> level and goes down to the child elements under the <strong class="source-inline">UL</strong> tag, which would normally be <strong class="source-inline">LI</strong>, or list item, elements. Each <strong class="source-inline">LI</strong> element on the Java documentation page has one child—that is, an anchor tag with a link.</p>
			<p>We can then pull out the link itself, which is held in the <strong class="source-inline">href</strong> attribute. We can also extract the English descriptive text used for the link.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can find a lot more information about HTML at <a href="https://packt.live/2o54P1e">https://packt.live/2o54P1e</a> and <a href="https://packt.live/33L4akK">https://packt.live/33L4akK</a>.</p>
			<h2 id="_idParaDest-220"><a id="_idTextAnchor224"/>Exercise 4: Using jsoup to Extract Data from HTML</h2>
			<p>This exercise demonstrates how to use the jsoup API to extract link URIs and descriptive text from an HTML document. Use this as an example of how to parse other HTML documents in your projects.</p>
			<p>Go to <a href="https://packt.live/2MO4UOU">https://packt.live/2MO4UOU</a> in a web browser. You can see the official Java documentation.</p>
			<p>We are going to extract the links in the main part of the page under section headings such as <strong class="bold">Tools and Specifications</strong>.</p>
			<p>If you inspect the API Documentation link in the Specifications section, you will see the link to the documentation resides in a UL element with a CSS class name of <strong class="source-inline">topics</strong>. As shown previously, we can use the jsoup API to find all the UL elements with that CSS class name:</p>
			<ol>
				<li value="1">Edit the <strong class="source-inline">build.gradle</strong> file in IntelliJ.</li>
				<li>Add the following to the dependencies block:<p class="source-code">// jsoup HTML parser from https://jsoup.org/</p><p class="source-code">implementation 'org.jsoup:jsoup:1.11.3'</p></li>
				<li>Choose to Import Changes from the popup that appears after adding the new dependency.</li>
				<li>In IntelliJ's Project pane, right-click on the <strong class="source-inline">com.packtpub.http</strong> package. Select <strong class="source-inline">New</strong> and then <strong class="source-inline">Java Class</strong>.</li>
				<li>Enter <strong class="source-inline">JavaDocLinks</strong> as the name of the Java class.</li>
				<li>Enter the following code for <strong class="source-inline">JavaDocLinks.java</strong>:</li>
			</ol>
			<p class="source-code-heading">JavaDocLinks.java</p>
			<p class="source-code">1  package com.packtpub.http;</p>
			<p class="source-code">2  </p>
			<p class="source-code">3  import org.jsoup.Jsoup;</p>
			<p class="source-code">4  import org.jsoup.nodes.Document;</p>
			<p class="source-code">5  import org.jsoup.nodes.Element;</p>
			<p class="source-code">6  import org.jsoup.select.Elements;</p>
			<p class="source-code">7  </p>
			<p class="source-code">8  import java.io.IOException;</p>
			<p class="source-code">9  </p>
			<p class="source-code">10 public class JavaDocLinks {</p>
			<p class="source-code">11     public static void main(String[] args) {</p>
			<p class="source-code-link"><a href="https://packt.live/2nYnBXS">https://packt.live/2nYnBXS</a></p>
			<p>In this exercise, we used the <strong class="source-inline">jsoup</strong> API to download an HTML document. Once downloaded, we extracted the link URIs and descriptive text associated with each link. This provides a good overview of the <strong class="source-inline">jsoup</strong> API, so you can use it in your projects.</p>
			<h1 id="_idParaDest-221"><a id="_idTextAnchor225"/>Delving into the java.net.http Module</h1>
			<p>Java 11 adds a brand new <strong class="source-inline">HttpClient</strong> class in the new <strong class="source-inline">java.net.http</strong> module. The <strong class="source-inline">HttpClient</strong> class uses a modern <strong class="bold">builder pattern</strong> (also called a fluent API) to set up HTTP connections. It then uses a Reactive Streams model to support both synchronous and asynchronous requests.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can refer to <em class="italic">Chapter 16</em>, <em class="italic">Predicates and Other Functional Interfaces</em>, and <em class="italic">Chapter 17</em>, <em class="italic">Reactive Programming with Java Flow</em>, for more on Java's Stream API and Reactive Streams. See <a href="https://packt.live/32sdPfO">https://packt.live/32sdPfO</a> for an overview of the <strong class="source-inline">java.net.http</strong> package in the module.</p>
			<p>With the builder model, you can configure things such as timeouts and then call the <strong class="source-inline">build()</strong> method. The <strong class="source-inline">HttpClient</strong> class you get is immutable:</p>
			<p class="source-code">HttpClient client = HttpClient.newBuilder()</p>
			<p class="source-code">        .version(HttpClient.Version.HTTP_2)</p>
			<p class="source-code">        .followRedirects(HttpClient.Redirect.NORMAL)</p>
			<p class="source-code">        .connectTimeout(Duration.ofSeconds(30))</p>
			<p class="source-code">        .build();</p>
			<p>In this example, we specify the following:</p>
			<ul>
				<li>HTTP version 2.</li>
				<li>The client should follow redirects normally, except if the redirect is from the more secure HTTPS to the less secure HTTP. This is the default behavior for <strong class="source-inline">HttpClient.Redirect.NORMAL</strong>.</li>
				<li>The connect timeout will be 30 seconds.</li>
			</ul>
			<p>The <strong class="source-inline">HttpClient</strong> class can be used for multiple requests. The next step is to set up an HTTP request:</p>
			<p class="source-code">HttpRequest request = HttpRequest.newBuilder()</p>
			<p class="source-code">        .uri(URI.create("http://example.com/"))</p>
			<p class="source-code">        .timeout(Duration.ofSeconds(30))</p>
			<p class="source-code">        .header("Accept", "text/html")</p>
			<p class="source-code">        .build();</p>
			<p>With this request:</p>
			<ul>
				<li>The URL is <strong class="source-inline">http://example.com/</strong>.</li>
				<li>The timeout on reading is 30 seconds.</li>
				<li>We set the <strong class="source-inline">Accept</strong> header to request the <strong class="source-inline">text/html</strong> content.</li>
			</ul>
			<p>Once built, call <strong class="source-inline">send()</strong> on the client to send the request synchronously or call <strong class="source-inline">sendAsync()</strong> to send the request asynchronously. If you call <strong class="source-inline">send()</strong>, the call will block and your application will wait for the data to be returned. If you call <strong class="source-inline">sendAsync()</strong>, the call will return right away and your application can later check to see whether the data has arrived. Use <strong class="source-inline">sendAsync()</strong> if you want to process the data in a background thread. Refer to <em class="italic">Chapter 22</em>, <em class="italic">Concurrent Tasks</em> for more details on background threads and how to perform tasks concurrently:</p>
			<p class="source-code">HttpResponse&lt;String&gt; response = </p>
			<p class="source-code">        client.send(request, HttpResponse.BodyHandlers.ofString());</p>
			<p>In this example, the request body handler specifies that we want the contents back as a string.</p>
			<h2 id="_idParaDest-222"><a id="_idTextAnchor226"/>Exercise 5: Getting HTML Contents Using the java.net.http Module</h2>
			<p>In this exercise, we'll recreate <em class="italic">Exercise 2, Creating a GET Request</em> to get the contents of a web page. While it may seem like there is more code involved, this isn't necessarily the case. The <strong class="source-inline">java.net.http</strong> module can actually be quite flexible as you can introduce <strong class="bold">lambda</strong> expressions to handle the response. <em class="italic">Chapter 13</em>, <em class="italic">Functional Programming with Lambda Expressions</em> covers lambda expressions:</p>
			<ol>
				<li value="1">In IntelliJ's <strong class="source-inline">Project</strong> pane, right-click the <strong class="source-inline">com.packtpub.http</strong> package. Select <strong class="source-inline">New</strong> and then <strong class="source-inline">Java Class</strong>.</li>
				<li>Enter <strong class="source-inline">NetHttpClient</strong> as the name of the Java class.</li>
				<li>Enter the following code for <strong class="source-inline">NetHttpClient.java</strong>:</li>
			</ol>
			<p class="source-code-heading">NetHttpClient.java</p>
			<p class="source-code">1  package com.packtpub.http;</p>
			<p class="source-code">2  </p>
			<p class="source-code">3  import java.io.IOException;</p>
			<p class="source-code">4  import java.net.URI;</p>
			<p class="source-code">5  import java.net.http.HttpClient;</p>
			<p class="source-code">6  import java.net.http.HttpRequest;</p>
			<p class="source-code">7  import java.net.http.HttpResponse;</p>
			<p class="source-code">8  import java.time.Duration;</p>
			<p class="source-code">9  </p>
			<p class="source-code">10 public class NetHttpClient {</p>
			<p class="source-code">11     public static void main(String[] args) {</p>
			<p class="source-code">12 </p>
			<p class="source-code">13         HttpClient client = HttpClient.newBuilder()</p>
			<p class="source-code">14                 .version(HttpClient.Version.HTTP_2)</p>
			<p class="source-code">15                 .followRedirects(HttpClient.Redirect.NORMAL)</p>
			<p class="source-code">16                 .connectTimeout(Duration.ofSeconds(30))</p>
			<p class="source-code">17                 .build();</p>
			<p class="source-code-link"><a href="https://packt.live/2W33Ivy">https://packt.live/2W33Ivy</a></p>
			<p>When you run this program, you should see the same results as the <strong class="source-inline">GetRequest</strong> program created in <em class="italic">Exercise 2</em>, <em class="italic">Creating a GET Request</em>.</p>
			<h2 id="_idParaDest-223"><a id="_idTextAnchor227"/>Activity 1: Using the jsoup Library to Download Files from the Web</h2>
			<p>With this activity, you will download the Java titles available through Packt. Go to <a href="https://www.packtpub.com/tech/Java">https://www.packtpub.com/tech/Java</a> in a web browser. Notice all the Java titles that are available. The activity will be to write a program to print all those titles:</p>
			<ol>
				<li value="1">Using the <strong class="source-inline">jsoup</strong> library, access <a href="https://packt.live/2J5dlEv">https://packt.live/2J5dlEv</a>. </li>
				<li>Download the HTML content.</li>
				<li>Find all the <strong class="source-inline">DIV</strong> elements with a CSS class of <strong class="source-inline">book-block-title</strong> and print the text within <strong class="source-inline">DIV</strong>.</li>
				<li>When you run this, you should see the following output:<p class="source-code">Hands-On Data Structures &amp; Algorithms in Java 11 [Video]</p><p class="source-code">Java EE 8 Microservices</p><p class="source-code">Hands-On Object Oriented Programming with Java 11 [Video]</p><p class="source-code">Machine Learning in Java - Second Edition</p><p class="source-code">Java 11 Quick Start</p><p class="source-code">Object-oriented and Functional Programming with Java 8 [Integrated Course]</p><p class="source-code">Mastering Microservices with Java 9 - Second Edition</p><p class="source-code">Design Patterns and Best Practices in Java</p><p class="source-code">Java Interview Guide : 200+ Interview Questions and Answers [Video]</p><p class="source-code">Ultimate Java Development and Certification Guide [Video]</p><p class="source-code">Spring MVC For Beginners : Build Java Web App in 25 Steps [Video]</p><p class="source-code">Java EE 8 and Angular</p><p class="source-code">RESTful Java Web Services - Third Edition</p><p class="source-code">Java EE 8 Application Development</p><p class="source-code">Mastering Microservices with Java 9 - Second Edition</p><p class="callout-heading">Note</p><p class="callout">The output is truncated. </p><p class="callout">The solution for the activity can be found on page 557.</p></li>
			</ol>
			<h1 id="_idParaDest-224"><a id="_idTextAnchor228"/>Summary</h1>
			<p>This chapter introduces HTTP networking, which is often used to connect to RESTful web services from within Java applications. HTTP is a textual request-response protocol. A client sends a request to a server and then gets a response. Each HTTP request has a method; for instance, you would use the GET request to retrieve data, POST to send data, and so on. In Java applications, you will often send and receive text in JSON format.</p>
			<p>The <strong class="source-inline">HttpUrlConnection</strong> class provides the primary way to make HTTP requests. Your code writes to an output stream to send data, then reads the response from an input stream. The open-source jsoup library provides a convenient API to retrieve and parse HTML data. Starting with Java 11, you can use the <strong class="source-inline">java.net.http</strong> module for a more modern Reactive Streams approach to HTTP networking. In the next chapter, you'll learn about certificates and encryption—both commonly used with HTTP networking.</p>
		</div>
	</body></html>