<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer025">
<h1 class="chapter-number" id="_idParaDest-37"><a id="_idTextAnchor043"/>2</h1>
<h1 id="_idParaDest-38"><a id="_idTextAnchor044"/>Getting Started with Spring Security</h1>
<p>In this chapter, we’ll apply a minimal Spring Security configuration to start addressing our first finding—inadvertent privilege escalation due to a lack of URL protection and general authentication from the security audit discussed in <a href="B21757_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, <em class="italic">Anatomy of an Unsafe Application</em>. We will then build on the basic configuration to provide a customized experience for our users. This chapter is intended to get you up and running with Spring Security and to provide a foundation for any other security-related tasks you will need <span class="No-Break">to perform.</span></p>
<p>During the course of this chapter, we will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Implementing a basic level of security on the <strong class="bold">JBCP Calendar</strong> application, using the automatic configuration option in <span class="No-Break">Spring Security</span></li>
<li>Learning how to customize both the login and <span class="No-Break">logout experience</span></li>
<li>Configuring Spring Security to restrict access differently, depending on <span class="No-Break">the URL</span></li>
<li>Leveraging the expression-based access controls of <span class="No-Break">Spring Security</span></li>
<li>Conditionally displaying basic information about the logged-in user using the <strong class="bold">JavaServer Pages</strong> (<strong class="bold">JSP</strong>) library in <span class="No-Break">Spring Security</span></li>
<li>Determining the user’s default location after login, based on <span class="No-Break">their role</span></li>
</ul>
<p>In each chapter of the book, you are instructed to begin their exploration from a designated project <strong class="source-inline">chapterX.00-calendar</strong>, where <strong class="source-inline">X</strong> denotes the chapter number. During this chapter, the focus is on using an application built on Spring Security within the Spring Framework, excluding the use of <span class="No-Break">Spring Boot.</span></p>
<p>The primary goal is to help readers become acquainted with the integration of Spring Security in the context of the <span class="No-Break">Spring Framework.</span></p>
<p>From <a href="B21757_03.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Custom Authentication</em> onwards, the book shifts its emphasis to delve deeper into Spring Security, particularly in conjunction with the Spring <span class="No-Break">Boot framework.</span></p>
<p>This chapter’s code in action link is <span class="No-Break">here: </span><a href="https://packt.link/fZ96T"><span class="No-Break">https://packt.link/fZ96T</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-39"><a id="_idTextAnchor045"/>Hello Spring Security</h1>
<p>Although Spring Security<a id="_idIndexMarker069"/> can be extremely difficult to configure, the creators of the product have been thoughtful and have provided us with a very simple mechanism to enable much of the software’s functionality with a strong baseline. From this baseline, additional configuration will allow for a fine level of detailed control over the security behavior of <span class="No-Break">the application.</span></p>
<p>We’ll start with our unsecured calendar application from <a href="B21757_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, <em class="italic">Anatomy of an Unsafe Application</em>, and turn it into a site that’s secured with a rudimentary username and password authentication. This authentication serves merely to illustrate the steps involved in enabling Spring Security for our web application; you’ll see that there are some obvious<a id="_idTextAnchor046"/> flaws in this approach that will lead us to make further <span class="No-Break">configuration refinements.</span></p>
<h2 id="_idParaDest-40"><a id="_idTextAnchor047"/>Importing the sample application</h2>
<p>We <a id="_idIndexMarker070"/>encourage you to import the <strong class="source-inline">chapter02.00-calendar</strong> project into your <strong class="bold">Integrated Development Environments</strong> (<strong class="bold">IDEs</strong>) and <a id="_idIndexMarker071"/>follow along by obtaining the source code from this chapter, as described in the <em class="italic">Getting started with JBCP calendar sample code</em> section in the <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional </em><span class="No-Break"><em class="italic">Reference Material</em></span><span class="No-Break">.</span></p>
<p>For each chapter, you will find multiple revisions of the code that represent checkpoints within the book. This makes it easy to compare your work to the correct answers as you go. At the beginning of each chapter, we will import the first revision of that chapter as a starting point. For example, in this chapter, we start with <strong class="source-inline">chapter02.00-calendar</strong>, and the first checkpoint will be <strong class="source-inline">chapter02.01-calendar</strong>. In <a href="B21757_03.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Custom Authentication</em>, we will start with <strong class="source-inline">chapter03.00-calendar</strong>, and the first checkpoint will be <strong class="source-inline">chapter03.01-calendar</strong>. There are additional details in the <em class="italic">Getting started with JBCP calendar sample code</em> section in the <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional Reference Material</em>, so be sure to ref<a id="_idTextAnchor048"/>er to it <span class="No-Break">for detail<a id="_idTextAnchor049"/>s.</span></p>
<h2 id="_idParaDest-41"><a id="_idTextAnchor050"/>Updating your dependencies</h2>
<p>The first step is <a id="_idIndexMarker072"/>to update the project’s dependencies to include the necessary Spring Security JAR files. Update the <strong class="source-inline">build.gradle</strong> Gradle file (from the sample application you imported previously) to include the Spring Security JAR files that we will use in the following <span class="No-Break">few sections.</span></p>
<p class="callout-heading">Important n<a id="_idTextAnchor051"/>ote</p>
<p class="callout">Throughout the book, we will be demonstrating how to provide the required dependencies using Gradle. The <strong class="source-inline">build.gradle</strong> file is located in the root of the project and represents all that is needed to build the project (including the project’s dependencies). Remember that Gradle will download the transitive dependencies for each listed dependency. So, if you are using another mechanism to manage dependencies, ensure that you also include the transitive dependencies. When managing the dependencies manually, it is useful to know that the Spring Security reference includes a list of its transitive dependencies. A link to the Spring Security reference can be found in the <em class="italic">Supplementary materials</em> section in the <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional </em><span class="No-Break"><em class="italic">Reference Material</em></span><span class="No-Break">.</span></p>
<p>Let’s take a look at the following <span class="No-Break">code snippet:</span></p>
<pre class="source-code">
// build.gradle
dependencies {
    implementation 'org.springframework.security:spring-security-config'
    implementation 'org.springframework.security:spring-security-web'
    ...
}</pre> <p>This code provides the necessary dependencies for basic Spring Security features in a Spring Framework project. However, depending on your specific requirements, you might need to add additional configurations as we will explore in the <span class="No-Break">upcoming sections.</span></p>
<h3>Using Spring 6 and Spring Security 6</h3>
<p>Spring 6<a id="_idIndexMarker073"/> is used consistently. Our <a id="_idIndexMarker074"/>sample applications provide an example of the former option, which means that no additional work is required <span class="No-Break">by you.</span></p>
<p>In the following code, we present an example fragment of what is added to the <strong class="source-inline">build.gradle</strong> Gradle file to utilize the dependency management feature of Gradle; this ensures that the correct Spring version is used throughout the entire application. We are going to leverage the<a id="_idIndexMarker075"/> Spring <strong class="bold">Bill Of Materials</strong> (<strong class="bold">BOM</strong>) dependency, which will ensure that all the dependency versions imported by the BOM will work <span class="No-Break">together correctly:</span></p>
<pre class="source-code">
// build.gradle
dependencyManagement {
    imports {
       mavenBom 'org.springframework:spring-framework-bom:6.1.4'
       mavenBom 'org.springframework.security:spring-security-bom:6.2.2'
    }
}
dependencies {
    ...
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">If you are using IntelliJ IDEA, any time you update the <strong class="source-inline">build.gradle</strong> file, ensure you right-click on the project, navigate to <strong class="bold">Gradle</strong> | <strong class="bold">Reload Gradle Project…</strong>, and select <strong class="bold">OK</strong> to update all <span class="No-Break">the dependencies.</span></p>
<p>For more information about how Gradle handles transitive dependencies, as well as the BOM, refer to the Gradle documentation, which is listed in the <em class="italic">Supplementary mat<a id="_idTextAnchor052"/>erials</em> section, in the <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional </em><span class="No-Break"><em class="italic">Reference Material</em></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-42"><a id="_idTextAnchor053"/>Implementing a Spring Security configuration</h2>
<p>The next step in the<a id="_idIndexMarker076"/> configuration process is to create a Java configuration file representing all of the Spring Security components that are required to cover standard <span class="No-Break">web requests.</span></p>
<p>Create a new Java file in the <strong class="source-inline">src/main/java/com/packtpub/springsecurity/configuration/ </strong>directory with the name <strong class="source-inline">SecurityConfig.java</strong>, and the following content. Among other things, the following file demonstrates user login requirements for every page in our application, provides a login page, authenticates the user, and requires the logged-in user to be associated with a role called <strong class="source-inline">USER</strong> for every <span class="No-Break">URL element:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ SecurityConfig.java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public InMemoryUserDetailsManager userDetailsService() {
        UserDetails user = User.withDefaultPasswordEncoder()
                .username("user1@example.com")
                .password("user1")
                .roles("USER")
                .build();
        return new InMemoryUserDetailsManager(user);
    }
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .authorizeHttpRequests( authz -&gt; authz
                    .requestMatchers("/**").hasRole("USER")
                    .anyRequest().authenticated()
                )
                .formLogin(withDefaults())
                .csrf(AbstractHttpConfigurer::disable);
        // For H2 Console
        http.headers(headers -&gt; headers.frameOptions(FrameOptionsConfig::disable));
        return http.build();
    }
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">If you are using IntelliJ IDEA, you can easily review <strong class="source-inline">SecurityFilterChain</strong> by pressing <em class="italic">F3</em>. Remember that the next checkpoint (<strong class="source-inline">chapter02.01-calendar</strong>) has a working solution, so the file can be copied from there <span class="No-Break">as well.</span></p>
<p>This is the only Spring Security configuration required to get our web application secured with a minimal standard configuration. This style of configuration, using a Spring-security-specific Java configuration, is known<a id="_idIndexMarker077"/> as <span class="No-Break"><strong class="bold">Java Configuration</strong></span><span class="No-Break">.</span></p>
<p>Let’s take a <a id="_idIndexMarker078"/>minute to break this configuration apart so we can get a high-level idea of what is happening. In the <strong class="source-inline">filterChain (HttpSecurity)</strong> method, the <strong class="source-inline">HttpSecurity</strong> object creates a <strong class="source-inline">Servlet Filter</strong>, which ensures that the currently logged-in user is associated with the appropriate role. In this instance, the filter will ensure that the user is associated with <strong class="source-inline">ROLE_USER</strong>. It is important to understand that the name of the role is arbitrary. Later, we will create a user with <strong class="source-inline">ROLE_ADMIN</strong> and will allow this user to have access to additional URLs that our current user does not have <span class="No-Break">access to.</span></p>
<p>In the <strong class="source-inline">userDetailsService ()</strong> method, the <strong class="source-inline">InMemoryUserDetailsManager</strong> object is how Spring Security authenticates the user. In this instance, we utilize an in-memory data store to compare a username <span class="No-Break">and password.</span></p>
<p>Our example and explanation of what is happening are a bit contrived. An in-memory authentication store would not work in a production environment. However, it allows us to get things up and running quickly. We will incrementally improve our understanding of Spring Security as we update our application to use production quality security throughout <span class="No-Break">this book.</span></p>
<p class="callout-heading">Impor<a id="_idTextAnchor054"/>tant note</p>
<p class="callout">General support for <strong class="bold">Java Configuration</strong> was <a id="_idIndexMarker079"/>added to Spring Framework in Spring 3.1. Since Spring Security 3.2 release, there has been Spring Security Java Configuration support, which enables users to easily configure Spring Security without the use of any XML. If you are familiar with <a href="B21757_06.xhtml#_idTextAnchor180"><span class="No-Break"><em class="italic">Chapter 6</em></span></a>, <em class="italic">LDAP Directory Services</em>, and the Spring Security documentation, then you should find quite a few similarities <a id="_idTextAnchor055"/>between it and Security <strong class="bold">Java </strong><span class="No-Break"><strong class="bold">Configuration</strong></span><span class="No-Break"> support</span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-43"><a id="_idTextAnchor056"/>Updating your web configuration</h2>
<p>The next steps involve a <a id="_idIndexMarker080"/>series of updates to the <strong class="source-inline">WebAppInitializer.java</strong> file. Some of the steps have already been performed because the application was already using <strong class="bold">Spring MVC</strong>. However, we will go over these requirements to ensure that more fundamental Spring requirements are understood, if you are using Spring Security in an application <a id="_idTextAnchor057"/>that is <span class="No-Break">not Spring-enabled.</span></p>
<h3>The ContextLoaderListener class</h3>
<p>The <a id="_idIndexMarker081"/>first step of updating the <strong class="source-inline">WebAppInitializer.java</strong> file is to use<strong class="source-inline"> jakarta.servlet.ServletContainerInitializer</strong>, which is the preferred approach to Servlet 4.0+ initialization. Spring MVC provides the <strong class="source-inline">o.s.w.WebApplicationInitializer</strong> interface, which leverages this mechanism. In Spring MVC, the preferred approach is to extend <strong class="source-inline">o.s.w.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer</strong>. The <strong class="source-inline">WebApplicationInitializer</strong> class is <span class="No-Break">polymorphically </span><span class="No-Break"><strong class="source-inline">o.s.w.context.AbstractContext</strong></span><strong class="source-inline">
LoaderInitializer</strong> and uses the abstract <strong class="source-inline">createRootApplicationContext()</strong> method to create a root <strong class="source-inline">ApplicationContext</strong>, then delegates it to <strong class="source-inline">ContextLoaderListener</strong>, which is registered in the <strong class="source-inline">ServletContext</strong> instance, as shown in the following <span class="No-Break">code snippet:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/JavaConfig.java
@Configuration
@Import({ SecurityConfig.class, DataSourceConfig.class })
@ComponentScan(basePackages =
        {
                «com.packtpub.springsecurity.configuration»,
                «com.packtpub.springsecurity.dataaccess»,
                «com.packtpub.springsecurity.domain»,
                «com.packtpub.springsecurity.service»
        }
)
public class JavaConfig {}</pre> <p>The updated <a id="_idIndexMarker082"/>configuration will now load <strong class="source-inline">the SecurityConfig.class</strong> from the<a id="_idTextAnchor058"/> <strong class="source-inline">classpath</strong> of the <span class="No-Break"><strong class="source-inline">WAR</strong></span><span class="No-Break"> file.</span></p>
<h3>ContextLoaderListener versus DispatcherServlet</h3>
<p>The <strong class="source-inline">o.s.web.servlet.DispatcherServlet</strong> interface specifies configuration classes to <a id="_idIndexMarker083"/>be loaded on their own <a id="_idIndexMarker084"/>using the <span class="No-Break"><strong class="source-inline">getServletConfigClasses()</strong></span><span class="No-Break"> method:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/web/configuration/WebAppInitializer
public class WebAppInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {
    @Override
    protected Class&lt;?&gt;[] getRootConfigClasses() {
        return null;
    }
    @Override
    protected Class&lt;?&gt;[] getServletConfigClasses() {
        return new Class[] { JavaConfig.class, WebMvcConfig.class };
    }
...</pre> <p>The <strong class="source-inline">DispatcherServlet</strong> class generates an <strong class="source-inline">o.s.context.ApplicationContext</strong> within the Spring framework, functioning as a child of the root <span class="No-Break"><strong class="source-inline">ApplicationContext</strong></span><span class="No-Break"> interface.</span></p>
<p>Generally, components specific to Spring MVC are initialized within the <strong class="source-inline">ApplicationContext</strong> interface <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">DispatcherServlet</strong></span><span class="No-Break">.</span></p>
<p>On the other hand, the remaining components are loaded <span class="No-Break">through </span><span class="No-Break"><strong class="source-inline">ContextLoaderListener</strong></span><span class="No-Break">.</span></p>
<p>It’s crucial to <a id="_idIndexMarker085"/>understand that beans in a <a id="_idIndexMarker086"/>child <strong class="source-inline">ApplicationContext</strong>, like the ones generated by <strong class="source-inline">DispatcherServlet</strong>, can reference beans from the parent <strong class="source-inline">ApplicationContext</strong>, established <span class="No-Break">by </span><span class="No-Break"><strong class="source-inline">ContextLoaderListener</strong></span><span class="No-Break">.</span></p>
<p>However, the parent <strong class="source-inline">ApplicationContext</strong> interface cannot make references to beans within the <span class="No-Break">child </span><span class="No-Break"><strong class="source-inline">ApplicationContext</strong></span><span class="No-Break">.</span></p>
<p>This is illustrated in the following diagram, in <a id="_idIndexMarker087"/>which <strong class="bold">Child Beans</strong> can refer to <strong class="bold">Root Beans</strong>, but <strong class="bold">Root Beans</strong> cannot<a id="_idIndexMarker088"/> refer to <span class="No-Break"><strong class="bold">Child Beans</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer018">
<img alt="Figure 2.1 – ContextLoaderListener and DispatcherServlet relationships" height="804" src="image/B21757_02_1.jpg" width="1192"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.1 – ContextLoaderListener and DispatcherServlet relationships</p>
<p>As in most<a id="_idIndexMarker089"/> use cases of Spring Security, we <a id="_idIndexMarker090"/>do not need Spring Security to refer to any of the MVC-declared beans. Therefore, we have decided to have <strong class="source-inline">C<a id="_idTextAnchor059"/>ontextLoaderListener</strong> initialize all configurations of <span class="No-Break">Spring Security.</span></p>
<h3>The springSecurityFilterChain filter</h3>
<p>The next<a id="_idIndexMarker091"/> step is to configure <strong class="source-inline">springSecurityFilterChain</strong> to intercept all requests by creating an implementation of <strong class="source-inline">AbstractSecurityWebApplicationInitializer</strong>. It is critical for <strong class="source-inline">springSecurityFilterChain</strong> to be declared first, to ensure the request is secured before any other logic <span class="No-Break">is invoked.</span></p>
<p>The following diagram shows the role <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">SecurityFilterChain</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer019">
<img alt="Figure 2.2 – Role of SecurityFilterChain" height="508" src="image/B21757_02_2.jpg" width="686"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.2 – Role of SecurityFilterChain</p>
<p>To ensure <strong class="source-inline">springSecurityFilterChain</strong> gets loaded first, we can use <strong class="source-inline">@Order(1)</strong>, as shown in the <span class="No-Break">following configuration:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/web/configuration/SecurityWebAppInitializer
@Order(1)
public class SecurityWebAppInitializer
        extends AbstractSecurityWebApplicationInitializer {
    public SecurityWebAppInitializer() {
        super();
    }
}</pre> <p>The <strong class="source-inline">SecurityWebAppInitializer</strong> class will automatically register the <strong class="source-inline">springSecurityFilterChain</strong> filter for every <a id="_idIndexMarker092"/>URL in your application and will add <strong class="source-inline">ContextLoaderListener</strong>, which <span class="No-Break">loads </span><span class="No-Break"><strong class="source-inline">SecurityConfig</strong></span><span class="No-Break">.</span></p>
<h3>The DelegatingFilterProxy class</h3>
<p>The <strong class="source-inline">o.s.web.filter.DelegatingFilterProxy</strong> class <a id="_idIndexMarker093"/>is a <strong class="source-inline">Servlet Filter</strong> provided by Spring Web that will delegate all work to a Spring bean from the <strong class="source-inline">ApplicationContext</strong> root, which must implement <strong class="source-inline">jakarta.servlet.Filter</strong>. Since, by default, the bean is looked up by name, using the <strong class="source-inline">&lt;filter-name&gt;</strong> value, we must ensure we use <strong class="source-inline">springSecurityFilterChain</strong> as the value <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">&lt;filter-name&gt;</strong></span><span class="No-Break">.</span></p>
<p>Here is a diagram of how <strong class="source-inline">DelegatingFilterProxy</strong> fits into the <strong class="source-inline">Filter</strong> instances and <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">FilterChain</strong></span><span class="No-Break">.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer020">
<img alt="Figure 2.3 – Role of DelegatingFilterProxy" height="508" src="image/B21757_02_3.jpg" width="320"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.3 – Role of DelegatingFilterProxy</p>
<p>The pseudocode for how <strong class="source-inline">o.s.web.filter.DelegatingFilterProxy</strong> works for our <strong class="source-inline">web.xml</strong> file can be <a id="_idIndexMarker094"/>found in the following <span class="No-Break">code snippet:</span></p>
<pre class="source-code">
// DelegatingFilterProxy Pseudo Code
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {
    Filter delegate = getFilterBean(someBeanName);
    delegate.doFilter(request, response);
}</pre> <p>This code showcases the interaction of the Spring Security <strong class="source-inline">DelegatingFilterProxy</strong> within a <span class="No-Break"><strong class="bold">Servlet</strong></span><span class="No-Break">-based application.</span></p>
<h3>The FilterChainProxy class</h3>
<p>When <a id="_idIndexMarker095"/>working in conjunction with Spring Security,<strong class="source-inline"> o.s.web.filter.DelegatingFilterProxy</strong> will delegate to the <strong class="source-inline">o.s.s.web.FilterChainProxy</strong> interface of Spring Security. The <strong class="source-inline">FilterChainProxy</strong> class allows Spring Security to conditionally apply any number of <strong class="source-inline">Servlet Filters</strong> to the <strong class="source-inline">Servlet Request</strong>. We will learn more about each of the Spring Security filters, and their roles in ensuring that our application is properly secured, throughout the rest of <span class="No-Break">the book.</span></p>
<p>The following diagram shows the role <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">FilterChainProxy</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer021">
<img alt="Figure 2.4 – Role of DelegatingFilterProxy" height="508" src="image/B21757_02_4.jpg" width="656"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.4 – Role of DelegatingFilterProxy</p>
<p>The pseudocode for how <strong class="source-inline">FilterChainProxy</strong> works is <span class="No-Break">as follows:</span></p>
<pre class="source-code">
public class FilterChainProxy implements Filter { void doFilter(request, response, filterChain) {
// lookup all the Filters for this request
    List&lt;Filter&gt; delegates =   lookupDelegates(request,response)
// invoke each filter unless the delegate decided to stop
    for delegate in delegates { if continue processing
        delegate.doFilter(request,response,filterChain)
    }
// if all the filters decide it is ok allow the
// rest of the application to run if continue processing
    filterChain.doFilter(request,response) }
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">Due to the fact that both <strong class="source-inline">DelegatingFilterProxy</strong> and <strong class="source-inline">FilterChainProxy</strong> are the front doors to Spring Security when used in a web application, you would add a debug point whe<a id="_idTextAnchor060"/>n trying to figure out what <span class="No-Break">is happening.</span></p>
<h2 id="_idParaDest-44"><a id="_idTextAnchor061"/>Running a secured application</h2>
<p>If you have not already done so, restart the <a id="_idIndexMarker096"/>application and visit<strong class="source-inline"> http://localhost:8080/</strong>. You will be presented with the <span class="No-Break">following screen:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer022">
<img alt="Figure 2.5 – Login page" height="385" src="image/B21757_02_5.jpg" width="514"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.5 – Login page</p>
<p>Great job! We’ve <a id="_idIndexMarker097"/>implemented a basic layer of security in our application using Spring Security. At this point, you should be able to log in using <strong class="source-inline">user1@example.com</strong> as <strong class="bold">Username</strong> and <strong class="source-inline">user1</strong> as <strong class="bold">Password</strong>. You’ll see the calendar welcome page, which describes at a high level what to expect from the application in terms <span class="No-Break">of security.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look <span class="No-Break">like </span><span class="No-Break"><strong class="source-inline">chapter02.01-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-45"><a id="_idTextAnchor062"/>Common problems</h2>
<p>Many users have trouble with the initial implementation of Spring Security in their applications. A few common issues and suggestions are listed next. We want to ensure that you can run the example application and <span class="No-Break">follow along:</span></p>
<ul>
<li>Make sure you can build and deploy the application before putting Spring Security <span class="No-Break">in place.</span></li>
<li>Review some introductory samples and documentation on your servlet container <span class="No-Break">if needed.</span></li>
<li>It’s usually easiest to use an IDE, such as IntelliJ IDEA, to run your servlet container. Not only is deployment typically seamless, but the console log is also readily available to review for errors. You can also set breakpoints at strategic locations to be triggered by exceptions to better <span class="No-Break">diagnose errors.</span></li>
<li>Make sure the versions of Spring and Spring Security that you’re using match and that there aren’t any unexpected Spring JAR files remaining as part of your application. As previously mentioned, when using Gradle, it can be a good idea to declare the Spring dependencies in the dependency <span class="No-Break">management section.</span></li>
</ul>
<p>In this section, we’ve established a Hello Spring Security application. We initiated the process by importing a sample application, subsequently updating dependencies, configuring Spring Security, managing web configurations, and finally, tackling common problems that <span class="No-Break">may arise.</span></p>
<p>Moving forward, the following section will delve into the customization of the user <span class="No-Break">experience post-login.</span></p>
<h1 id="_idParaDest-46"><a id="_idTextAnchor063"/>A little bit of polish</h1>
<p>Stop at this point and think about what we’ve just built. You may have noticed some obvious issues that will require some additional work and knowledge of the Spring Security product before our application is production ready. Try to make a list of the changes that you think are required before this security implementation is ready to roll out on the <span class="No-Break">public-facing website.</span></p>
<p>Applying the Hello World Spring Security implementation was blindingly fast and has provided us with a login page, username, and password-based authentication, as well as the automatic interception of URLs in our calendar application. However, there are gaps between what the automatic configuration setup provides and what our end goal is, which are listed <span class="No-Break">as follows:</span></p>
<ul>
<li>While the login page is helpful, it’s completely generic and doesn’t look like the rest of our JBCP calendar application. We should add a login form that’s integrated with our application’s look <span class="No-Break">and feel.</span></li>
<li>There is no obvious way for a user to log out. We’ve locked down all pages in the application, including the <strong class="source-inline">Welcome</strong> page, which a potential user may want to browse anonymously. We’ll need to redefine the roles required to accommodate anonymous, authenticated, and <span class="No-Break">administrative users.</span></li>
<li>We do not display any contextual information to indicate to the user that they are authenticated. It would be nice to display a greeting similar to “<span class="No-Break">welcome </span><span class="No-Break"><strong class="source-inline">user1@example.com</strong></span><span class="No-Break">.”</span></li>
<li>We’ve had to hardcode the username, password, and role information of the user in the <strong class="source-inline">SecurityConfig</strong> configuration file. Recall this section of the <strong class="source-inline">userDetailsService()</strong> method <span class="No-Break">we added:</span></li>
</ul>
<pre class="source-code">
User.withDefaultPasswordEncoder()
        .username("user1@example.com")
        .password("user1")
        .roles("USER")
        .build();</pre> <ul>
<li>You can see that the username and password are right there in the file. It’s unlikely that we’d want to add a new declaration to the file for every user of the system! To address this, we’ll need to update the configuration with another <a id="_idTextAnchor064"/>type <span class="No-Break">of authentication.</span></li>
</ul>
<p>We’ll explore different authentication options throughout the first half of <span class="No-Break">the book.</span></p>
<h2 id="_idParaDest-47"><a id="_idTextAnchor065"/>Customizing login</h2>
<p>We’ve seen how Spring Security makes it <a id="_idIndexMarker098"/>very easy to get started. Now, let’s see how we can customize the login experience. In the following code snippet, we demonstrate the usage of some of the more common ways to customize login, but we encourage you to refer to the reference documentation of Spring Security, which includes the <a href="B21757_20.xhtml#_idTextAnchor642"><em class="italic">Appendix</em></a>, <em class="italic">Additional Reference Material</em>, with all of the <span class="No-Break">supported attributes.</span></p>
<p>Let’s take a look at the following steps to <span class="No-Break">customize login:</span></p>
<ol>
<li>First, update your <strong class="source-inline">SecurityConfig.java</strong> file <span class="No-Break">as follows:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
...
http
        .authorizeHttpRequests( authz -&gt; authz
                .requestMatchers("/**")
                .hasRole("USER")
        )
        .formLogin(form -&gt; form
                .loginPage("/login/form")
                .loginProcessingUrl("/login")
                .failureUrl("/login/form?error")
                .usernameParameter("username")
                .passwordParameter("password")
....</pre><p class="list-inset">Let’s take a look at the following methods depicted in the preceding <span class="No-Break">code snippet:</span></p><ul><li>The <strong class="source-inline">loginPage()</strong> method specifies where Spring Security will redirect the browser if a protected page is accessed and the user is not authenticated. If a login page is not specified, Spring Security will redirect the user to <strong class="source-inline">/spring_security_login</strong>. Then, <strong class="source-inline">o.s.s.web.filter.FilterChainProxy</strong> will choose <strong class="source-inline">o.s.s.web.authentication.ui.DefaultLoginPageGeneratingFilter</strong>, which renders the default login page as one of the delegates, since <strong class="source-inline">DefaultLoginPageGeneratingFilter</strong> is configured to process <strong class="source-inline">/spring_security_login</strong> by default. Since we have chosen to override the default URL, we are in charge of rendering the login page when the <strong class="source-inline">/login/form</strong> URL <a id="_idIndexMarker099"/><span class="No-Break">is requested.</span></li><li>The <strong class="source-inline">loginProcessingUrl()</strong> method defaults to <strong class="source-inline">/j_spring_security_check</strong> and specifies the URL that the login form (which should include the username and password) should be submitted to, using an HTTP post. When Spring Security processes this request, it will attempt to authenticate <span class="No-Break">the user.</span></li><li>The <strong class="source-inline">failureUrl()</strong> method specifies the page that Spring Security will redirect to if the username and password submitted to <strong class="source-inline">loginProcessingUrl()</strong> <span class="No-Break">are invalid.</span></li><li>The <strong class="source-inline">usernameParameter()</strong> and <strong class="source-inline">passwordParameter()</strong> methods default to <strong class="source-inline">j_username</strong> and <strong class="source-inline">j_password</strong> respectively, and specify the HTTP parameters that Spring Security will use to authenticate the user when processing the <span class="No-Break"><strong class="source-inline">loginProcessingUrl()</strong></span><span class="No-Break"> method.</span></li></ul></li> </ol>
<p class="callout-heading">Important note</p>
<p class="callout">It may be obvious, but if we only wanted to add a custom login page, we would only need to specify the <strong class="source-inline">loginPage()</strong> method. We would then create our login form using the default values for the remaining attributes. However, it is often good practice to override the values of anything visible to users, to prevent exposing that we are using Spring Security. Revealing what frameworks we are using is a type of information leakage, making it easier for attackers to determine potential holes in <span class="No-Break">our security.</span></p>
<ol>
<li value="2">The next step is to<a id="_idIndexMarker100"/> create a login page. We can use any technology we want to render the login page, as long as the login form produces the HTTP request that we specified with our Spring Security configuration when submitted. By ensuring the HTTP request conforms to our configuration, Spring Security can authenticate the request for us. Create the <strong class="source-inline">login.xhtml</strong> file, as shown in the following <span class="No-Break">code snippet:</span><pre class="source-code">
//src/main/webapp/WEB-INF/tempates/login.xhtml
&lt;div class="alert alert-danger" th:if="<strong class="bold">${param.error != null}</strong>"&gt;
    &lt;strong&gt;Failed to login.&lt;/strong&gt;
    &lt;span th:if<strong class="bold">="${session[SPRING_SECURITY_LAST_EXCEPTION] != null}</strong>"&gt;
        &lt;span th:text<strong class="bold">="${session[SPRING_SECURITY_LAST_EXCEPTION].message}"</strong>&gt;Invalid credentials&lt;/span&gt;
    &lt;/span&gt;
&lt;/div&gt;
&lt;div class="alert alert-success" th:if="<strong class="bold">${param.logout != null}</strong>"&gt;
    You have been logged out.
&lt;/div&gt;
&lt;fieldset&gt;
    &lt;legend&gt;Login Form&lt;/legend&gt;
    &lt;div class="mb-3"&gt;
        &lt;label class="form-label" for="username"&gt;Username&lt;/label&gt;
        &lt;input autofocus="autofocus" class="form-control" id="username"
               name="username"
               type="text"/&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label class="form-label" for="password"&gt;Password&lt;/label&gt;
        &lt;input class="form-control" id="password" name="password"
               type="password"/&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;input class="btn btn-primary" id="submit" name="submit" type="submit"
               value="Login"/&gt;
    &lt;/div&gt;</pre></li> </ol>
<p class="callout-heading">Important note</p>
<p class="callout">Remember that if you are having problems typing anything in the book, you can refer to the solution at the next checkpoint (<span class="No-Break"><strong class="source-inline">chapter02.02- calendar</strong></span><span class="No-Break">).</span></p>
<p>The following number <a id="_idIndexMarker101"/>of items are worth highlighting in the preceding <span class="No-Break"><strong class="source-inline">login.xhtml</strong></span><span class="No-Break"> file:</span></p>
<ul>
<li>The form action should be <strong class="source-inline">/login</strong>, to match the value provided for the <strong class="source-inline">loginProcessingUrl()</strong> method we specified. For security reasons, Spring Security only attempts to authenticate when using <strong class="source-inline">POST</strong> <span class="No-Break">by default.</span></li>
<li>We can use <strong class="source-inline">param.error</strong> to see whether there was a problem logging in, since the value of our <strong class="source-inline">failureUrl()</strong> method, <strong class="source-inline">/login/form?error</strong>, contains the <strong class="source-inline">HTTP</strong> <span class="No-Break">parameter error.</span></li>
<li>The session attribute, <strong class="source-inline">SPRING_SECURITY_LAST_EXCEPTION</strong>, contains the last <strong class="source-inline">o.s.s.core.AuthenticationException</strong> exception, which can be used to display the reason for a failed login. The error messages can be customized by leveraging Spring’s <span class="No-Break">internationalization support.</span></li>
<li>The input names for the <strong class="source-inline">username</strong> and <strong class="source-inline">password</strong> inputs are chosen to correspond to the values we specified for the <strong class="source-inline">usernameParameter()</strong> and <strong class="source-inline">passwordParameter()</strong> methods in our <span class="No-Break"><strong class="source-inline">SecurityConfig.java</strong></span><span class="No-Break"> configuration.</span></li>
</ul>
<p>3.	The last step is to make<a id="_idIndexMarker102"/> Spring MVC aware of our new URL. This can be done by adding the following method <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">WebMvcConfig</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/web/configuration/WebMvcConfig.java
@Configuration
@EnableWebMvc
public class WebMvcConfig implements WebMvcConfigurer {
...
    @Override
    public void addViewControllers(final ViewControllerRegistry registry) {
        registry.addViewController("/login/form")
              .setViewName("login");
    }
...
}</pre> <p>This code adds<a id="_idIndexMarker103"/> the custom <strong class="source-inline">login.xhtml</strong> login page and the related controller request mapping <span class="No-Break">URL: </span><span class="No-Break"><strong class="source-inline">/login/form</strong></span><span class="No-Break">.</span></p>
<h3>Configuring logout</h3>
<p>The <strong class="source-inline">HttpSecurity</strong> configuration <a id="_idIndexMarker104"/>of Spring Security automatically adds support for logging the user out. All that is needed is to create a link that points to<strong class="source-inline"> /j_spring_security_logout</strong>. However, we will demonstrate how to customize the URL used to log the user out by performing the <span class="No-Break">following steps:</span></p>
<ol>
<li>Update the Spring Security configuration <span class="No-Break">as follows:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ SecurityConfig.java
http
        .authorizeHttpRequests( authz -&gt; authz
              .requestMatchers("/**")
              .hasRole("USER")
        )
...
        ).logout(form -&gt; form
              .logoutUrl("/logout")
              .logoutSuccessUrl("/login?logout")
        )
....</pre></li> <li>You have to provide a link for the user to click on that will log them out. We will update the <strong class="source-inline">header.xhtml</strong> file so that the <strong class="source-inline">Logout</strong> link appears on <span class="No-Break">every page:</span><pre class="source-code">
//src/main/webapp/WEB-INF/templates/fragments/header.xhtml
&lt;div id="navbar" ...&gt;
       ...
    &lt;ul class="nav navbar-nav pull-right"&gt;
        &lt;li&gt;&lt;a id="navLogoutLink" th:href="@{/logout}"&gt; Logout&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
       ...
&lt;/div&gt;</pre></li> <li>The last step<a id="_idIndexMarker105"/> is to update the <strong class="source-inline">login.xhtml</strong> file to display a message indicating logout was successful when the <strong class="source-inline">logout</strong> parameter <span class="No-Break">is present:</span><pre class="source-code">
//src/main/webapp/WEB-INF/templates/login.xhtml
&lt;div th:if="${param.logout != null}" class="alert alert-success"&gt; You have been logged out.&lt;/div&gt;
&lt;label for="username"&gt;Username&lt;/label&gt;
       ...</pre></li> </ol>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look <span class="No-Break">like </span><span class="No-Break"><strong class="source-inline">chapter02.02-calendar</strong></span><span class="No-Break">.</span></p>
<h3>The page isn’t redirecting properly</h3>
<p>If you have not already, restart <a id="_idIndexMarker106"/>the application and visit <strong class="source-inline">http://localhost:8080</strong>; you will see an error, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer023">
<img alt="Figure 2.6 – Page not redirecting properly" height="454" src="image/B21757_02_6.jpg" width="515"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.6 – Page not redirecting properly</p>
<p>What went wrong? The problem is, since Spring Security is no longer rendering the login page, we must allow everyone (not just the <strong class="source-inline">USER</strong> role) to access the <strong class="bold">Login</strong> page. Without granting access to the <strong class="bold">Login</strong> page, the <span class="No-Break">following happens:</span></p>
<ol>
<li>We request<a id="_idIndexMarker107"/> the <strong class="bold">Welcome</strong> page in <span class="No-Break">the browser.</span></li>
<li>Spring Security sees that the <strong class="bold">Welcome</strong> page requires the <strong class="source-inline">USER</strong> role and that we are not authenticated, so it redirects the browser to the <span class="No-Break"><strong class="bold">Login</strong></span><span class="No-Break"> page.</span></li>
<li>The browser requests the <span class="No-Break"><strong class="bold">Login</strong></span><span class="No-Break"> page.</span></li>
<li>Spring Security sees that the <strong class="bold">Login</strong> page requires the <strong class="source-inline">USER</strong> role and that we are still not authenticated, so it redirects the browser to the <strong class="bold">Login</strong> <span class="No-Break">page again.</span></li>
<li>The browser requests the <strong class="bold">Login</strong> <span class="No-Break">page again.</span></li>
<li>Spring Security sees that the <strong class="bold">Login</strong> page requires the <strong class="source-inline">USER</strong> role, as shown in the <span class="No-Break">following diagram:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer024">
<img alt="Figure 2.7 – Login process with Spring Security" height="510" src="image/B21757_02_7.jpg" width="1530"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.7 – Login process with Spring Security</p>
<p>The process <a id="_idIndexMarker108"/>could just keep repeating indefinitely. Fortunately for us, Firefox realizes that there are too many redirects occurring, stops performing the redirect, and displays a very informative error message. In the next section, we wil<a id="_idTextAnchor066"/>l learn how to fix this error by configuring URLs differently, depending on the access that <span class="No-Break">they require.</span></p>
<h3>Basic role-based authorization</h3>
<p>We can expand on the Spring<a id="_idIndexMarker109"/> Security configuration from Hello Spring Security to vary the access controls by URL. In this section, you will find a configuration that allows more granular control over how resources can be accessed. In the configuration, Spring Security does the <span class="No-Break">following tasks:</span></p>
<p>It completely ignores any request that starts with <strong class="source-inline">/resources/</strong>. This is beneficial since our images, CSS, and JavaScript do not need to use <span class="No-Break">Spring Security.</span></p>
<p>It allows anonymous users to access the <strong class="bold">Welcome</strong>, <strong class="bold">Login</strong>, and <strong class="bold">Logout</strong> pages. It only allows administrators access to the <strong class="bold">All </strong><span class="No-Break"><strong class="bold">Events</strong></span><span class="No-Break"> page.</span></p>
<p>It adds an administrator that can access the <strong class="bold">All </strong><span class="No-Break"><strong class="bold">Events</strong></span><span class="No-Break"> page.</span></p>
<p>Take a look at the following <span class="No-Break">code snippet:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ SecurityConfig.java
...
http
        .authorizeHttpRequests( authz -&gt; authz
              .requestMatchers("/resources/**").permitAll()
              .requestMatchers("/webjars/**").permitAll()
              .requestMatchers("/").hasAnyRole("ANONYMOUS", "USER")
              .requestMatchers("/login/*").hasAnyRole("ANONYMOUS", "USER")
              .requestMatchers("/logout/*").hasAnyRole("ANONYMOUS", "USER")
              .requestMatchers("/admin/*").hasRole("ADMIN")
              .requestMatchers("/events/").hasRole("ADMIN")
              .requestMatchers("/**").hasRole("USER")
...
@Bean
public InMemoryUserDetailsManager userDetailsService() {
    UserDetails user = User.withDefaultPasswordEncoder()
          .username("user")
          .password("user")
          .roles("USER")
          .build();
    UserDetails admin = User.withDefaultPasswordEncoder()
          .username("admin")
          .password("admin")
          .roles("ADMIN")
          .build();
    UserDetails user1 = User.withDefaultPasswordEncoder()
          .username("user1@example.com")
          .password("user1")
          .roles("USER")
          .build();
    UserDetails admin1 = User.withDefaultPasswordEncoder()
          .username("admin1@example.com")
          .password("admin1")
          .roles("USER", "ADMIN")
          .build();
    return new InMemoryUserDetailsManager(user,admin, user1, admin1);
}</pre> <p class="callout-heading">Important note</p>
<p class="callout">Notice that we do not include the application’s context root, in the Spring Security configuration, because Spring Security takes care of the context root transparently for us. In this way, we do not need to update our configuration if we decide to deploy it to a different <span class="No-Break">context root.</span></p>
<p>In Spring Security 6, you <a id="_idIndexMarker110"/>can specify multiple <strong class="source-inline">requestMatchers</strong> entries using a builder pattern that allows you to have greater control over how security is applied to different portions of your application. The first <strong class="source-inline">RequestMatcher</strong> object states that Spring Security should ignore any URL that starts with <strong class="source-inline">/resources/</strong>, and the second <strong class="source-inline">RequestMatcher</strong> object states that any other request will be processed by it. There are a few important things to note about using multiple <strong class="source-inline">requestMatchers</strong> methods, <span class="No-Break">as follows:</span></p>
<ul>
<li>If no path attribute is specified, it is the equivalent of using a path of <strong class="source-inline">/**</strong>, which matches <span class="No-Break">all requests.</span></li>
<li>Each <strong class="source-inline">requestMatchers()</strong> method is considered in order, and only the first match is applied. So, the order in which they appear in your configuration file is important. The implication is that only the last <strong class="source-inline">requestMatchers()</strong> method can use a path that matches every request. If you do not follow this rule, Spring Security will produce an error. The following is invalid because the first matcher matches every request and will never get to the <span class="No-Break">second mapping:</span><pre class="source-code">
http.authorizeHttpRequests((authz) -&gt; authz
        .requestMatchers("/**").hasRole("USER")
        .requestMatchers(("/admin/*").hasRole("ADMIN"))</pre></li> <li>The default pattern is backed by <strong class="source-inline">o.s.s.web.util.AntPathRequestMatcher</strong>, which will compare the specified pattern to an <strong class="bold">Ant Pattern</strong> to determine whether it matches the <strong class="source-inline">servletPath</strong> and <strong class="source-inline">pathInfo</strong> methods <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">HttpServletRequest</strong></span><span class="No-Break">.</span></li>
<li>The <strong class="source-inline">RequestMatcher</strong> interface is used to determine whether a request matches a given rule. We use <strong class="source-inline">securityMatchers</strong> to determine whether <strong class="source-inline">a given HttpSecurity</strong> should be applied to a given request. In the same way, we can use <strong class="source-inline">requestMatchers</strong> to determine the authorization rules that we should apply to a <span class="No-Break">given request.</span></li>
<li>The path attribute on the <strong class="source-inline">requestMatchers()</strong> method further refines the filtering of the request and allows access control to be applied. You can see that the updated configuration allows different types of access, depending on the URL pattern. The <strong class="source-inline">ANONYMOUS</strong> role is of particular interest since we have not defined it anywhere in <strong class="source-inline">SecurityConfig.java</strong>. This is the default authority assigned to a user that is not logged in. The following line, from the updates to our <strong class="source-inline">SecurityConfig.java</strong> file, is what allows anonymous (unauthenticated) users and users with the <strong class="source-inline">USER</strong> role authority to access the <strong class="bold">Login</strong> page. We will<a id="_idIndexMarker111"/> cover access control options in more detail in the second half of <span class="No-Break">the book:</span><pre class="source-code">
.requestMatchers("/login/*").hasAnyRole("ANONYMOUS", "USER")</pre><p class="list-inset">When defining the <strong class="source-inline">requestMatchers()</strong> methods, there are several things to keep in mind, including <span class="No-Break">the following:</span></p><ul><li>Just as each <strong class="bold">http</strong> method is considered from top to bottom, so are the <strong class="source-inline">requestMatchers()</strong> methods. This means it is important to specify the most specific elements first. The following example illustrates a configuration that does not specify the more specific pattern first, which will result in warnings from Spring Security <span class="No-Break">at startup:</span><pre class="source-code">http.authorizeHttpRequests()
…
        // matches every request, so it will not continue
        .requestMatchers("/**").hasRole("USER")
        // below will never match
        .requestMatchers("/login/form").hasAnyRole("ANONYMOUS", "USER")</pre></li><li>It is important to note that if <strong class="source-inline">http.authorizeHttpRequests()</strong> can <span class="No-Break">have </span><span class="No-Break"><strong class="source-inline">anyRequest()</strong></span><span class="No-Break">,</span>
 there should be no child <strong class="source-inline">requestMatchers()</strong> method defined. This is because <strong class="source-inline">anyRequest()</strong> will match all requests that match this <strong class="source-inline">http.authorizeHttpRequests()</strong> tag. Defining a <strong class="source-inline">requestMatchers()</strong> child method with <strong class="source-inline">anyRequest()</strong> contradicts the <strong class="source-inline">requestMatchers()</strong> declaration. An<a id="_idIndexMarker112"/> example is <span class="No-Break">as follows:</span><pre class="source-code">http.authorizeHttpRequests((authz) -&gt; authz.anyRequest().permitAll())
// This matcher will never be executed
// and not produce an error.
       .requestMatchers("/admin/*").hasRole("ADMIN"))</pre></li><li>The path attribute of the <strong class="source-inline">requestMatchers()</strong> element is independent and is not aware of the <span class="No-Break"><strong class="source-inline">anyRequest()</strong></span><span class="No-Break"> method.</span></li></ul></li> </ul>
<p>If you have not done so already, restart the application and visit <strong class="source-inline">http://localhost:8080</strong>. Experiment with the application to see all the updates you have made, <span class="No-Break">as follows:</span></p>
<ol>
<li>Select a link that requires authentication and observes the new <span class="No-Break">login page.</span></li>
<li>Try typing an invalid <strong class="source-inline">username</strong>/<strong class="source-inline">password</strong> and view the <span class="No-Break">error message.</span></li>
<li>Try logging in as an admin (<strong class="source-inline">admin1@example.com/admin1</strong>), and view all of the events. Note that we are able to view all <span class="No-Break">the events.</span></li>
<li>Try logging out and view the logout <span class="No-Break">success message.</span></li>
<li>Try logging in as a regular user (<strong class="source-inline">user1@example.com/user1</strong>), and view all of the events. Note<a id="_idIndexMarker113"/> that we get an <strong class="bold">Access </strong><span class="No-Break"><strong class="bold">Denied</strong></span><span class="No-Break"> page.</span></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look <span class="No-Break">like </span><span class="No-Break"><strong class="source-inline">chapter02.03-calendar</strong></span><span class="No-Break">.</span></p>
<h3>Expression-based authorization</h3>
<p>You may have noticed that granting access<a id="_idIndexMarker114"/> to everyone was not nearly as concise as we may have liked. Fortunately, Spring Security can leverage <strong class="bold">Spring Expression Language</strong> (<strong class="bold">SpEL</strong>) to <a id="_idIndexMarker115"/>determine whether a user has authorization. In the following code snippet, you can see the updates when using <strong class="bold">SpEL</strong> with <span class="No-Break">Spring Security.</span></p>
<p>For Java configuration, <strong class="source-inline">WebExpressionAuthorizationManager</strong> is available to help use <span class="No-Break">legacy SpEL:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ SecurityConfig.java
http
        .authorizeHttpRequests( authz -&gt; authz
              .requestMatchers("/").access(new WebExpressionAuthorizationManager("hasAnyRole('ANONYMOUS', 'USER')"))
              .requestMatchers("/resources/**").permitAll()
              .requestMatchers("/webjars/**").permitAll()
              .requestMatchers("/login/*").access(new WebExpressionAuthorizationManager("hasAnyRole('ANONYMOUS', 'USER')"))
              .requestMatchers("/logout/*").access(new WebExpressionAuthorizationManager("hasAnyRole('ANONYMOUS', 'USER')"))
              .requestMatchers("/errors/**").permitAll()
              .requestMatchers("/admin/*").access(new WebExpressionAuthorizationManager("hasRole('ADMIN')"))
              .requestMatchers("/events/").access(new WebExpressionAuthorizationManager("hasRole('ADMIN')"))
              .requestMatchers("/**").access(new WebExpressionAuthorizationManager("hasRole('USER')"))
        )</pre> <p class="callout-heading">Important note</p>
<p class="callout">You may notice that the <strong class="source-inline">/events/</strong> security constraint is brittle. For example, the <strong class="source-inline">/events</strong> URL is not protected by Spring Security to restrict the <strong class="source-inline">ADMIN</strong> role. This demonstrates the need to ensure that we provide multiple layers of security. We will exploit this sort of weakness in <a href="B21757_11.xhtml#_idTextAnchor332"><span class="No-Break"><em class="italic">Chapter 11</em></span></a>, <em class="italic">Fine-Grained </em><span class="No-Break"><em class="italic">Access Control</em></span><span class="No-Break">.</span></p>
<p>Changing the <strong class="source-inline">access</strong> attribute <a id="_idIndexMarker116"/>from <strong class="source-inline">hasAnyRole('ANONYMOUS', 'USER')</strong> to <strong class="source-inline">permitAll()</strong> might not seem like much, but this only scratches the surface of the power of Spring Security’s expressions. We will go into much greater detail about access control and Spring expressions in the second half of the book. Go ahead and verify that the updates work by running <span class="No-Break">the application.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">It is recommended that you use type-safe authorization managers instead of SpEL. Your code should now look <span class="No-Break">like </span><span class="No-Break"><strong class="source-inline">chapter02.04-calendar</strong></span><span class="No-Break">.</span></p>
<h3>Conditionally displaying authentication information</h3>
<p>Currently, our application <a id="_idIndexMarker117"/>does not indicate whether we are logged in or not. It appears as though we are always logged in since the <strong class="bold">Logout</strong> link is always displayed. In this section, we will demonstrate how to display the authenticated user’s username and conditionally display portions of the page using <strong class="bold">Thymeleaf</strong>’s Spring<a id="_idIndexMarker118"/> Security tag library. We do so by performing the <span class="No-Break">following steps:</span></p>
<ol>
<li>Update your dependencies to include the <strong class="source-inline">thymeleaf-extras- springsecurity6</strong> JAR file. Since we are using Gradle, we will add a new dependency declaration in our <strong class="source-inline">build.gradle</strong> file, <span class="No-Break">as follows:</span><pre class="source-code">
//build.gradle
dependencies{
...
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6:3.1.2.RELEASE'
}</pre></li> <li>Next, we need to add <strong class="source-inline">SpringSecurityDialect</strong> to the Thymeleaf engine <span class="No-Break">as follows:</span><pre class="source-code">
//src/com/packtpub/springsecurity/web/configuration/ ThymeleafConfig.java
@Bean
public SpringTemplateEngine templateEngine(final ITemplateResolver templateResolver) {
    SpringTemplateEngine engine = new SpringTemplateEngine();
    engine.setTemplateResolver(templateResolver);
    engine.setAdditionalDialects(new HashSet&lt;&gt;() {{
        add(new LayoutDialect());
<strong class="bold">        add(new SpringSecurityDialect());</strong>
    }});
    return engine;
}</pre></li> <li>The <strong class="source-inline">sec:authorize</strong> attribute determines whether the user is authenticated with the <strong class="source-inline">isAuthenticated()</strong> value, displays the HTML node if the user is authenticated, and hides the node in the event that the user is not authenticated. The <strong class="source-inline">access</strong> attribute should be rather familiar from the <strong class="source-inline">requestMatchers().access()</strong> element. In fact, both components leverage the same <span class="No-Break">SpEL support.</span><p class="list-inset">There are <a id="_idIndexMarker119"/>attributes in the <strong class="bold">Thymeleaf</strong> tag libraries that do not use expressions. However, using <strong class="bold">SpEL</strong> is typically <a id="_idIndexMarker120"/>the preferred method since it is <span class="No-Break">more powerful.</span></p><p class="list-inset">The <strong class="source-inline">sec:authentication</strong> attribute will look up the current <strong class="source-inline">o.s.s.core.Authentication</strong> object. The <strong class="source-inline">property</strong> attribute will find the principal attribute of the <strong class="source-inline">o.s.s.core.Authentication</strong> object, which in this case is <strong class="source-inline">o.s.s.core.userdetails.UserDetails</strong>. It then obtains the <strong class="source-inline">UserDetails</strong> username property and renders it to the page. Don’t worry if the details of this are confusing. We are going to go over this in more detail in <a href="B21757_03.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <span class="No-Break"><em class="italic">Custom Authentication</em></span><span class="No-Break">.</span></p><p class="list-inset">Update the <strong class="source-inline">header.xhtml</strong> file to leverage the Spring Security tag library. You can find the updates <span class="No-Break">as follows:</span></p><pre class="source-code">
//src/main/webapp/WEB-INF/templates/fragments/header.xhtml
&lt;html  <strong class="bold"/>&gt;
&lt;body&gt;
…
                &lt;div id="navbar" class="collapse navbar-collapse"&gt;
…
                    &lt;ul class="nav navbar-nav pull-right" <strong class="bold">sec:authorize="isAuthenticated()"</strong>&gt;
                        &lt;li&gt;
                            &lt;p class="navbar-text"&gt;Welcome &lt;div class="navbar-text" th:text="<strong class="bold">${#authentication.name}"</strong>&gt;User&lt;/div&gt;&lt;/p&gt;
                        &lt;/li&gt;
                        &lt;li&gt;
                            <strong class="bold">&lt;a id="navLogoutLink" class="btn btn-default" role="button"  th:href="@{/logout}"&gt;Logout&lt;/a&gt;</strong>
                        &lt;/li&gt;
                        &lt;li&gt;&amp;nbsp;|&amp;nbsp;&lt;/li&gt;
                    &lt;/ul&gt;
                    &lt;ul class="nav navbar-nav pull-right" <strong class="bold">sec:authorize=" ! isAuthenticated()"</strong>&gt;
                        &lt;li&gt;&lt;a id="navLoginLink" class="btn btn-default" role="button" th:href="@{/login/form}"&gt;Login&lt;/a&gt;&lt;/li&gt;
                        &lt;li&gt;&amp;nbsp;|&amp;nbsp;&lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/nav&gt;
   &lt;/div&gt;
...</pre></li> </ol>
<p>If you haven’t done so already, restart the application to see the updates we have made. At this point, you may realize that we are still displaying links we do not have access to. For example, <strong class="source-inline">user1@example.com</strong> should not see a link to the <strong class="bold">All Events</strong> page. Rest assured, we’ll fix this when we cover the tags in greater detail in <a href="B21757_11.xhtml#_idTextAnchor332"><span class="No-Break"><em class="italic">Chapter 11</em></span></a>, <em class="italic">Fine-Grained </em><span class="No-Break"><em class="italic">Access Control</em></span><span class="No-Break">.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">chapter02.05-calendar</strong></span><span class="No-Break">.</span></p>
<h3>Customizing behavior after login</h3>
<p>We have already<a id="_idIndexMarker121"/> discussed how to customize a user’s experience during login, but sometimes it is necessary to customize the behavior after login. In this section, we will discuss how Spring Security behaves after login and will provide a simple mechanism to customize <span class="No-Break">this behavior.</span></p>
<p>In the default configuration, Spring Security has two different flows after successful authentication. The first scenario occurs if a user never visits a resource that requires authentication. In this instance, after a successful login attempt, the user will be sent to the <strong class="source-inline">defaultSuccessUrl()</strong> method chained to the <strong class="source-inline">formLogin()</strong> method. If left undefined, <strong class="source-inline">defaultSuccessUrl()</strong> will be the context root of <span class="No-Break">the application.</span></p>
<p>If a user requests a protected page before being authenticated, Spring Security will remember the last protected page that was accessed before authenticating, using o.s.s.web.savedrequest.RequestCache. Upon successful authentication, Spring Security will send the user to the last protected page that was accessed before authentication. For example, if an unauthenticated user requests the My Events page, they will be sent to the <span class="No-Break">Login page.</span></p>
<p>After successful authentication, they will be sent to the previously requested <strong class="bold">My </strong><span class="No-Break"><strong class="bold">Events</strong></span><span class="No-Break"> page.</span></p>
<p>A common requirement is to customize Spring Security to send the user to a different <strong class="source-inline">defaultSuccessUrl()</strong> method, depending on the user’s role. Let’s take a look at how this can be accomplished by performing the <span class="No-Break">following steps:</span></p>
<ol>
<li>The first step<a id="_idIndexMarker122"/> is to configure the <strong class="source-inline">defaultSuccessUrl()</strong> method chained after the <strong class="source-inline">formLogin()</strong> method. Go ahead and <span class="No-Break">update </span><span class="No-Break"><strong class="source-inline">SecurityConfig.java</strong></span><span class="No-Break">:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ SecurityConfig.java
.formLogin(form -&gt; form
       .loginPage("/login/form")
       .loginProcessingUrl("/login")
       .failureUrl("/login/form?error")
       .usernameParameter("username")
       .passwordParameter("password")
<strong class="bold">       .defaultSuccessUrl("/default")</strong>
       .permitAll()</pre></li> <li>The next step is to create a controller that processes <strong class="source-inline">/default</strong>. In the following code, you will find a sample Spring MVC controller, <strong class="source-inline">DefaultController</strong>, which demonstrates how to redirect administrators to the <strong class="bold">All Events</strong> page and other users to the <strong class="bold">Welcome</strong> page. Create a new file in the <span class="No-Break">following location:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/web/controllers/DefaultController.java
@Controller
public class DefaultController {
    @RequestMapping("/default")
    public String defaultAfterLogin(HttpServletRequest request) {
       if (request.isUserInRole("ADMIN")) {
          return "redirect:/events/";
       }
       return "redirect:/";
    }
}</pre></li> </ol>
<p class="callout-heading">Important note</p>
<p class="callout">In IntelliJ IDEA, you can press <em class="italic">Alt</em> + <em class="italic">Enter</em> to automatically add the <span class="No-Break">missing imports.</span></p>
<p class="list-inset">There are a few <a id="_idIndexMarker123"/>things to point out about <strong class="source-inline">DefaultController</strong> and how it works. The first is that Spring Security makes the <strong class="source-inline">HttpServletRequest</strong> parameter aware of the currently logged-in user. In this instance, we can inspect which role the user belongs to without relying on any of Spring <span class="No-Break">Security’s APIs.</span></p>
<p class="list-inset">This is good because if Spring Security’s APIs change or we decide we want to switch our security implementation, we have less code that needs to be updated. It should also be noted that while we implement this controller with a Spring MVC controller, our <strong class="source-inline">defaultSuccessUrl()</strong> method can be handled by any controller implementation (for example, Struts, a standard servlet, and so on) if <span class="No-Break">we desire.</span></p>
<ol>
<li value="3">If you wish to always go to the <strong class="source-inline">defaultSuccessUrl()</strong> method, you can leverage the second parameter to the <strong class="source-inline">defaultSuccessUrl()</strong> method, which is a <strong class="source-inline">Boolean</strong> for always use. We will not do this in our configuration, but you can see an example of it <span class="No-Break">as follows:</span><pre class="source-code">
<strong class="bold">.defaultSuccessUrl("/default", true)</strong></pre></li> <li>You are now ready to give it a try. Restart the application and go directly to the <strong class="bold">My Events</strong> page, then log in; you will see that you are on the <strong class="bold">My </strong><span class="No-Break"><strong class="bold">Events</strong></span><span class="No-Break"> page.</span></li>
<li>Next, log out and try logging in <span class="No-Break">as </span><span class="No-Break"><strong class="source-inline">user1@example.com</strong></span><span class="No-Break">.</span></li>
<li>You should <a id="_idIndexMarker124"/>be on the <strong class="bold">Welcome</strong> page. Log out and log in as <strong class="source-inline">admin1@example.com</strong>, and you will be sent to the <strong class="bold">All </strong><span class="No-Break"><strong class="bold">Events</strong></span><span class="No-Break"> page.</span></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">Your code should now look <span class="No-Break">like </span><span class="No-Break"><strong class="source-inline">chapter02.06-calendar</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-48"><a id="_idTextAnchor067"/>Summary</h1>
<p>In this chapter, we have applied a very basic Spring Security configuration. The main objective was to outline the steps and key concepts involved in implementing Spring Security in Spring 6 applications. To achieve this goal, we started by importing the sample application, then updating dependencies, configuring Spring Security, and managing web configurations, and in the end, we addressed <span class="No-Break">common issues.</span></p>
<p>Additionally, we explained how to customize the user’s login and logout experience and demonstrated how to display basic information based on roles and SpEL. We finished this chapter by customizing behavior <span class="No-Break">after login.</span></p>
<p>In the next chapter, we will discuss how authentication in Spring Security works and how we can customize it to <span class="No-Break">our needs.</span></p>
</div>
</div></body></html>