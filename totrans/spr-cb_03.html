<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Using Controllers and Views"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Using Controllers and Views</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Associating a route to a controller method</li><li class="listitem" style="list-style-type: disc">Using a JSP view</li><li class="listitem" style="list-style-type: disc">Passing attributes from a controller to a JSP view</li><li class="listitem" style="list-style-type: disc">Using dynamic route parameters in a controller method</li><li class="listitem" style="list-style-type: disc">Using a common prefix for the routes of a controller</li><li class="listitem" style="list-style-type: disc">Using a page template with Tiles</li><li class="listitem" style="list-style-type: disc">Executing some code before and after controllers using interceptors</li><li class="listitem" style="list-style-type: disc">Building multilingual pages</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Introduction</h1></div></div></div><p>A Spring web application uses a <span class="strong"><strong>MVC</strong></span> (<span class="strong"><strong>Model-View-Controller</strong></span>) architecture to process HTTP requests, as shown in the following image:</p><div class="mediaobject"><img src="graphics/5807OS_03_01.jpg" alt="Introduction"/></div><p>An HTTP request, identified by a route (for example, <code class="literal">/user/list</code>), executes a controller method. A <a id="id121" class="indexterm"/>view, usually a JSP file, is rendered afterwards and the resulting HTML is sent back as a response.</p><p>In this chapter, we will start by creating a controller and view. Then, you'll learn how to retrieve URL parameters from a controller method. We'll cover two standard ways to reduce code repetition with page templates and URL prefixes. We will finish with more advanced topics related to controllers and views: interceptors and internationalization.</p><p>The recipes in this chapter will work with a project similar to the one in the <span class="emphasis"><em>Creating a Spring web application</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Creating a Spring Application">Chapter 1</a>, <span class="emphasis"><em>Creating a Spring Application</em></span>, with a Spring configuration class annotated with <code class="literal">@EnableWebMvc</code> and scanning a Java package dedicated to controller classes:</p><div class="informalexample"><pre class="programlisting">@Configuration
@EnableWebMvc
@ComponentScan(basePackages = {"<span class="strong"><strong>com.springcookbook.controller</strong></span>"})
public class AppConfig {  
}</pre></div><p>This is the project structure:</p><div class="mediaobject"><img src="graphics/5807OS_03_04.jpg" alt="Introduction"/></div></div></div>
<div class="section" title="Associating a route to a controller method"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec24"/>Associating a route to a controller method</h1></div></div></div><p>In this recipe, you <a id="id122" class="indexterm"/>will learn how to define a<a id="id123" class="indexterm"/> controller method to be executed for a given route.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec46"/>How to do it…</h2></div></div></div><p>Here are the steps for creating a controller method for a given route:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a controller class in your controller package (for example, <code class="literal">com.springcookbook.controller</code>). This is a normal Java class annotated with <code class="literal">@Controller</code>:<div class="informalexample"><pre class="programlisting">@Controller
public class UserController {
...
}</pre></div></li><li class="listitem">Add a controller method. This is a standard Java method annotated with <code class="literal">@RequestMapping</code>, which takes the route as a parameter:<div class="informalexample"><pre class="programlisting">@RequestMapping("/user/list")
public void userList() {
...
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec47"/>How it works…</h2></div></div></div><p>A<a id="id124" class="indexterm"/> request with the <code class="literal">/user/list</code> route will <a id="id125" class="indexterm"/>execute the <code class="literal">userList()</code>method.</p></div></div>
<div class="section" title="Using a JSP view"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Using a JSP view</h1></div></div></div><p>In this recipe, you'll learn how to render and return a JSP view after the execution of a controller method.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec48"/>How to do it…</h2></div></div></div><p>Here<a id="id126" class="indexterm"/> are the steps to create a JSP view:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependency for JSTL in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
  &lt;artifactId&gt;<span class="strong"><strong>jstl</strong></span>&lt;/artifactId&gt;
  &lt;version&gt;1.2&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">Add a JSP view resolver to the Spring configuration class:<div class="informalexample"><pre class="programlisting">@Bean
public ViewResolver jspViewResolver(){
    InternalResourceViewResolver resolver = new InternalResourceViewResolver();
    resolver.setViewClass(<span class="strong"><strong>JstlView</strong></span>.class);
    resolver.setPrefix("<span class="strong"><strong>/WEB-INF/jsp/</strong></span>");
    resolver.setSuffix("<span class="strong"><strong>.jsp</strong></span>");
    return resolver;
}</pre></div></li><li class="listitem">Create a controller method:<div class="informalexample"><pre class="programlisting">@RequestMapping("/user/list")
public void userList() {
  ...
}</pre></div></li><li class="listitem">Create the <code class="literal">/WEB-INF/jsp/user/list.jsp</code> JSP:<div class="informalexample"><pre class="programlisting">&lt;html&gt;
&lt;body&gt;
  There are many users.
&lt;/body&gt;
&lt;/html&gt;</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec49"/>How it works…</h2></div></div></div><p>The <a id="id127" class="indexterm"/>controller method path is <code class="literal">/user/list</code>. Using the JSP view resolver, Spring will find and render the corresponding <code class="literal">/WEB-INF/jsp/user/list.jsp</code> JSP.</p><p>If the path had been <code class="literal">/user_list</code>, the corresponding JSP would have been <code class="literal">/WEB-INF/jsp/user_list.jsp</code>.</p><p>This is the current project structure:</p><div class="mediaobject"><img src="graphics/5807OS_03_05.jpg" alt="How it works…"/></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec50"/>There's more…</h2></div></div></div><p>It's possible<a id="id128" class="indexterm"/> to explicitly return a <code class="literal">String</code> object from the controller method, which Spring will use to find the JSP. In this example, <code class="literal">/WEB-INF/jsp/my_friends.jsp</code> will be used:</p><div class="informalexample"><pre class="programlisting">@RequestMapping("/user/list")
public String userList() {
  return "<span class="strong"><strong>my_friends</strong></span>";
}</pre></div><p>For more<a id="id129" class="indexterm"/> information about what can be done in a JSP file, refer to <a class="ulink" href="http://www.tutorialspoint.com/jsp/jsp_standard_tag_library.htm">http://www.tutorialspoint.com/jsp/jsp_standard_tag_library.htm</a>.</p><p>Thymeleaf, FreeMarker, and Velocity are popular view frameworks that provide an alternative <a id="id130" class="indexterm"/>to <a id="id131" class="indexterm"/>JSPs. FreeMarker and Velocity are <a id="id132" class="indexterm"/>supported by Spring by default. Thymeleaf provides its own view resolver.</p></div></div>
<div class="section" title="Passing attributes from a controller to a JSP view"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Passing attributes from a controller to a JSP view</h1></div></div></div><p>In this recipe, you'll learn how to set attributes in a controller method and use them in a JSP view.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec51"/>How to do it…</h2></div></div></div><p>Here are<a id="id133" class="indexterm"/> the steps to pass data from a <a id="id134" class="indexterm"/>controller to a view:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add<a id="id135" class="indexterm"/> a <code class="literal">Model</code> argument to the controller method:<div class="informalexample"><pre class="programlisting">  @RequestMapping("/user/list")
  public void userList(Model model) {
  ...</pre></div></li><li class="listitem">In the controller method, add attributes to the <code class="literal">Model</code> object:<div class="informalexample"><pre class="programlisting">model.addAttribute("nbUsers", 13);</pre></div></li><li class="listitem">Use the attributes in the JSP file:<div class="informalexample"><pre class="programlisting">&lt;p&gt;There are ${nbUsers} users&lt;/p&gt;</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec52"/>How it works…</h2></div></div></div><p>The <code class="literal">nbUsers</code> variable <a id="id136" class="indexterm"/>is set to <code class="literal">13</code> in <a id="id137" class="indexterm"/>the controller. In the JSP<a id="id138" class="indexterm"/> file, the <code class="literal">${nbUsers}</code> <span class="strong"><strong>EL</strong></span> (<span class="strong"><strong>Expression Language</strong></span>) element will be rendered to <code class="literal">13</code>, so that the following HTML will be<a id="id139" class="indexterm"/> returned:</p><div class="informalexample"><pre class="programlisting">&lt;p&gt;There are 13 users&lt;/p&gt;</pre></div></div></div>
<div class="section" title="Using dynamic route parameters in a controller method"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Using dynamic route parameters in a controller method</h1></div></div></div><p>Now we will define <a id="id140" class="indexterm"/>dynamic segments for a route <a id="id141" class="indexterm"/>and use them in the associated controller method. For example, we want the <code class="literal">/user/5/name</code> and <code class="literal">/user/6/email</code> routes to execute the same controller method with different arguments: <code class="literal">showUserField(5, "name")</code> and <code class="literal">showUserField(6, "email")</code>, respectively.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec53"/>How to do it…</h2></div></div></div><p>Use <code class="literal">{}</code> to enclose the dynamic route segments and <code class="literal">@PathVariable</code> to annotate the corresponding controller method arguments:</p><div class="informalexample"><pre class="programlisting">@RequestMapping("/user/{id}/{field}")
public void showUserField(@PathVariable("id") Long userId, @PathVariable("field") String field) {
...
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec54"/>How it works…</h2></div></div></div><p>A request for the <code class="literal">/user/5/email</code> route will execute the <code class="literal">showUserField(5,"email")</code> method. <code class="literal">@PathVariable("id") Long userId</code> casts the <code class="literal">id</code> route parameter to the <code class="literal">userId</code> method argument. Similarly, the <code class="literal">field</code> route parameter is passed as <code class="literal">String</code> to <code class="literal">showUserField()</code>.</p><p>An incorrect route such as <code class="literal">/user/test/email</code> (it's incorrect because the <code class="literal">test</code> substring cannot be converted to a <code class="literal">Long</code> object) will trigger a 400 server error with the message <span class="strong"><strong>The request sent by the client was syntactically incorrect.</strong></span></p></div></div>
<div class="section" title="Using a common prefix for the routes of a controller"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Using a common prefix for the routes of a controller</h1></div></div></div><p>In this recipe, we <a id="id142" class="indexterm"/>will define in one place a route prefix <a id="id143" class="indexterm"/>shared by all the routes of a controller. We will start the <a id="id144" class="indexterm"/>routes of the <code class="literal">UserController</code> controller with <code class="literal">/user</code>.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec55"/>How to do it…</h2></div></div></div><p>Here are the steps to set a route prefix:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add <code class="literal">@RequestMapping</code> with the common route prefix to the controller class:<div class="informalexample"><pre class="programlisting">@Controller
@RequestMapping("/user")
public class UserController {
...
}</pre></div></li><li class="listitem">Add <code class="literal">@RequestMapping</code> with the remainder of the route to the controller methods:<div class="informalexample"><pre class="programlisting">@RequestMapping("/list")
public void userList() {
  ...
}

@RequestMapping("/add")
public void addUser() {
  ...
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec56"/>How it works…</h2></div></div></div><p>A request for the <code class="literal">/user/add</code> route will execute the <code class="literal">addUser()</code>method. A request for the <code class="literal">/user/list</code> route will execute the <code class="literal">userList()</code>method.</p></div></div>
<div class="section" title="Using a page template with Tiles"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Using a page template with Tiles</h1></div></div></div><p>With a <a id="id145" class="indexterm"/>page template, avoid repeating the common <a id="id146" class="indexterm"/>elements of the pages (HTML head, header, footer, navigation, and so on) in every JSP.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec57"/>How to do it…</h2></div></div></div><p>Here are the steps to use Tiles:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Tiles Maven dependencies in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.tiles&lt;/groupId&gt;
  &lt;artifactId&gt;tiles-servlet&lt;/artifactId&gt;
  &lt;version&gt;3.0.5&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.apache.tiles&lt;/groupId&gt;
  &lt;artifactId&gt;tiles-jsp&lt;/artifactId&gt;
  &lt;version&gt;3.0.5&lt;/version&gt;
&lt;/dependency&gt; </pre></div></li><li class="listitem">In the<a id="id147" class="indexterm"/> Spring configuration class, remove <a id="id148" class="indexterm"/>the JSP view resolver (if it's there).</li><li class="listitem">Declare Tiles in the Spring configuration class:<div class="informalexample"><pre class="programlisting">// declare Tiles configuration file
@Bean
public TilesConfigurer tilesConfigurer() {
  TilesConfigurer tilesConfigurer = new TilesConfigurer();
  final String[] definitions = { "<span class="strong"><strong>/WEB-INF/tiles.xml</strong></span>" };
    tilesConfigurer.setDefinitions(definitions);
  return tilesConfigurer;
}

// declare Tiles as a view resolver
@Bean
public ViewResolver tilesViewResolver() {
  TilesViewResolver resolver = new <span class="strong"><strong>TilesViewResolver()</strong></span>;
  return resolver;
}</pre></div></li><li class="listitem">Create the <code class="literal">/WEB-INF/tiles.xml</code> Tiles configuration file:<div class="informalexample"><pre class="programlisting">&lt;tiles-definitions&gt;  
  
    &lt;definition name="template" template="/WEB-INF/jsp/templates/template.jsp" /&gt;

    &lt;definition name="*" extends="template"&gt;
        &lt;put-attribute name="body" value="/WEB-INF/jsp/{1}.jsp" /&gt;
    &lt;/definition&gt;

&lt;/tiles-definitions&gt;</pre></div></li><li class="listitem">Create the <code class="literal">/WEB-INF/jsp/templates/template.jsp</code> page template:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE HTML&gt;
&lt;%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles" %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Spring Cookbook&lt;/h1&gt;

    &lt;tiles:insertAttribute name="body" /&gt;    
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">In the <a id="id149" class="indexterm"/>controller methods, return the base name <a id="id150" class="indexterm"/>of a standard JSP file. For example, for <code class="literal">/jsp/home.jsp</code>:<div class="informalexample"><pre class="programlisting">...
return "home";</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec58"/>How it works…</h2></div></div></div><p>When the Spring configuration is loaded, Tiles is initialized using the declared <code class="literal">tiles.xml</code> configuration file.</p><div class="mediaobject"><img src="graphics/5807OS_03_02.jpg" alt="How it works…"/></div><p>When a request arrives, the controller method is executed and returns the <code class="literal">"home"</code> String, which matches the definition named <code class="literal">"*"</code> in <code class="literal">tiles.xml</code>. This definition will use the <code class="literal">template</code> definition and pass the <code class="literal">body</code> variable to it with the <code class="literal">/WEB-INF/jsp/home.jsp</code> value. In <code class="literal">template.jsp</code>, the <code class="literal">tiles:insertAttribute</code> tag will be replaced by the contents of <code class="literal">home.jsp</code>.</p><p>To summarize, the <code class="literal">home.jsp</code> file is integrated with <code class="literal">template.jsp</code> and the resulting HTML is sent as a response.</p><p>In <code class="literal">template.php</code>, make sure to include the following to be able to use Tiles tags such as <code class="literal">&lt;tiles:insertAttribute&gt;</code>:</p><div class="informalexample"><pre class="programlisting">&lt;%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles" %&gt;</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec59"/>There's more…</h2></div></div></div><p>Tiles can <a id="id151" class="indexterm"/>be used when JSP files are in subfolders <a id="id152" class="indexterm"/>and support multiple page templates. It's also possible to define repeated text in one place.</p><div class="section" title="Organizing the JSP with subfolders"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec27"/>Organizing the JSP with subfolders</h3></div></div></div><p>As the <a id="id153" class="indexterm"/>number of JSP files grows, you can maintain them by grouping them according to sections, using subfolders:</p><div class="informalexample"><pre class="programlisting">/jsp
 |- /user
 |   |- list.jsp
 |   |- add.jsp
 |- /article
 |   |- list.jsp
 |   |- add.jsp
 |- home.jsp</pre></div><p>In the controller method, return the folder with the <code class="literal">jsp</code> base name, for example, <code class="literal">user/list</code>.</p><p>In <code class="literal">tiles.xml</code>, add the definition:</p><div class="informalexample"><pre class="programlisting">&lt;definition name="*/*" extends="template"&gt;
    &lt;put-attribute name="body" value="/WEB-INF/jsp/{1}/{2}.jsp" /&gt;
&lt;/definition&gt;    </pre></div></div><div class="section" title="Using multiple page templates"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec28"/>Using multiple page templates</h3></div></div></div><p>To handle <a id="id154" class="indexterm"/>multiple templates, define a prefix for each template in <code class="literal">tiles.xml</code>. For example, we defined below a main template with the <code class="literal">main_ prefix</code> using the <code class="literal">template1.jsp</code> JSP and a secondary template with the <code class="literal">secondary_ prefix</code> using the <code class="literal">template2.jsp</code> JSP:</p><div class="informalexample"><pre class="programlisting">    &lt;definition name="template1" template="/WEB-INF/templates/template1.jsp" /&gt;
    &lt;definition name="template2" template="/WEB-INF/templates/template2.jsp" /&gt;

    &lt;definition name="main_*" extends="template1"&gt;
        &lt;put-attribute name="body" value="/WEB-INF/jsp/{1}.jsp" /&gt;
    &lt;/definition&gt;

    &lt;definition name="secondary_*" extends="template2"&gt;
        &lt;put-attribute name="body" value="/WEB-INF/jsp/{1}.jsp" /&gt;
    &lt;/definition&gt;</pre></div><p>In the <a id="id155" class="indexterm"/>controller method, for <code class="literal">home.jsp</code>, return <code class="literal">"main_home"</code> to use <code class="literal">template1</code> or <code class="literal">"secondary_home"</code> to use <code class="literal">template2</code>.</p></div><div class="section" title="Defining page titles only once using a text attribute"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec29"/>Defining page titles only once using a text attribute</h3></div></div></div><p>A title usually needs to appear twice in an HTML page: once in the <code class="literal">&lt;title&gt;</code> tag of the page <code class="literal">&lt;head&gt;</code> section and once in a <code class="literal">&lt;h1&gt;</code> tag of the page <code class="literal">&lt;body&gt;</code> section. Using Tiles, you can define it only once in an external <code class="literal">.properties</code> file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In <code class="literal">tiles.xml</code>, add a title attribute to the template definition:<div class="informalexample"><pre class="programlisting">&lt;definition name="*" extends="template"&gt;
  &lt;put-attribute name="<span class="strong"><strong>title</strong></span>" value="{1}.title" /&gt;
...</pre></div></li><li class="listitem">In <code class="literal">template.jsp</code>, get the title and use it:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE HTML&gt;
&lt;%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %&gt;
&lt;%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles" %&gt;

&lt;c:set var="<code class="literal">titleKey</code>"&gt;        
  &lt;tiles:getAsString name="<span class="strong"><strong>title</strong></span>" /&gt;
&lt;/c:set&gt;

&lt;html&gt;
&lt;head&gt;
   &lt;title&gt;&lt;spring:message code="${<span class="strong"><strong>titleKey</strong></span>}" /&gt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;&lt;spring:message code="${<span class="strong"><strong>titleKey</strong></span>}" /&gt;&lt;/h1&gt;
  ... </pre></div></li><li class="listitem">Create the <code class="literal">src/main/resources/messages.properties</code> file:<div class="informalexample"><pre class="programlisting">home.title=Home</pre></div></li></ol></div><p>To learn<a id="id156" class="indexterm"/> more about Tiles, go to <a class="ulink" href="https://tiles.apache.org/framework/tutorial/">https://tiles.apache.org/framework/tutorial/</a>.</p></div></div></div>
<div class="section" title="Executing some code before and after controllers using interceptors"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Executing some code before and after controllers using interceptors</h1></div></div></div><p>In this<a id="id157" class="indexterm"/> recipe, you'll learn how, with<a id="id158" class="indexterm"/> interceptors, we can execute some code across all controllers at different moments of a request workflow with the <code class="literal">preHandle()</code>, <code class="literal">postHandle()</code>, and <code class="literal">afterCompletion()</code> hooks:</p><div class="mediaobject"><img src="graphics/5807OS_03_03.jpg" alt="Executing some code before and after controllers using interceptors"/></div><p>Interceptors are used for authentication, logging, and profiling (among others).</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec60"/>How to do it…</h2></div></div></div><p>Here are<a id="id159" class="indexterm"/> the steps to create and register an<a id="id160" class="indexterm"/> interceptor:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a class extending <code class="literal">HandlerInterceptorAdapter</code>:<div class="informalexample"><pre class="programlisting">public class PerformanceInterceptor extends HandlerInterceptorAdapter {</pre></div></li><li class="listitem">Override the methods you want to use:<div class="informalexample"><pre class="programlisting">@Override
public boolean <span class="strong"><strong>preHandle</strong></span>(HttpServletRequest request,
    HttpServletResponse response, Object handler) throws Exception {
    …
  return true;
}

@Override
public void <span class="strong"><strong>postHandle</strong></span>(HttpServletRequest request,
    HttpServletResponse response, Object handler,
    ModelAndView modelAndView) throws Exception {
  ...
}

@Override
public void <span class="strong"><strong>afterCompletion</strong></span>(HttpServletRequest request,
    HttpServletResponse response, Object handler, Exception ex)
    throws Exception {
  ...
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Note that if <code class="literal">preHandle()</code> returns <code class="literal">false</code>, the request workflow will be stopped and the controller method won't be called.</p></div></div></li><li class="listitem">Make the Spring configuration class extend <code class="literal">WebMvcConfigurerAdapter</code> and annotate it with <code class="literal">@EnableWebMvc</code>:<div class="informalexample"><pre class="programlisting">@Configuration
@EnableWebMvc
public class AppConfig extends WebMvcConfigurerAdapter{
...</pre></div></li><li class="listitem">In the<a id="id161" class="indexterm"/> Spring configuration<a id="id162" class="indexterm"/> class, declare the interceptor as a bean and register it with the <code class="literal">addInterceptors()</code>method:<div class="informalexample"><pre class="programlisting">@Bean
public HandlerInterceptor performanceInterceptor() {
  PerformanceInterceptor interceptor;
  interceptor = new PerformanceInterceptor();
  return interceptor;
}

@Override
public void addInterceptors(InterceptorRegistry registry) {
  registry.addInterceptor(performanceInterceptor());
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec61"/>How it works…</h2></div></div></div><p>The interceptor methods are executed at the corresponding moments of the request workflow.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec62"/>There's more…</h2></div></div></div><p>To restrict the interceptor to specific URLs, add path patterns to the interceptor registration:</p><div class="informalexample"><pre class="programlisting">@Override
public void addInterceptors(InterceptorRegistry registry) {
  registry.addInterceptor(performanceInterceptor())
.addPathPatterns("/home", "/user/*");
}</pre></div><p>In this example, the interceptor methods will be executed for <code class="literal">/home</code>, <code class="literal">/user/list</code>, and /<code class="literal">user/add</code> but not for <code class="literal">/contact</code>.</p></div></div>
<div class="section" title="Building multilingual pages"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Building multilingual pages</h1></div></div></div><p>Next we will learn how to create a <a id="id163" class="indexterm"/>multilingual page (in English and French) using only one JSP, and display it in English by default, with a link to switch to French. We will then store the text outside the JSP, in both languages, in separate <code class="literal">.properties</code> files.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec63"/>How to do it…</h2></div></div></div><p>Here are the<a id="id164" class="indexterm"/> steps to build a bilingual JSP view:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the JSP:<div class="informalexample"><pre class="programlisting">&lt;%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %&gt;

&lt;html&gt;
&lt;body&gt;
  &lt;h1&gt;&lt;spring:message code="home.title" /&gt;&lt;/h1&gt;
  &lt;p&gt;&lt;spring:message code="home.intro" /&gt;&lt;/p&gt;

  &lt;p&gt;
    &lt;a href="?lang=en"&gt;English&lt;/a&gt; |
    &lt;a href="?lang=fr"&gt;French&lt;/a&gt;
  &lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Create the English <code class="literal">.properties</code> file <code class="literal">src/main/resources/messages.properties</code>:<div class="informalexample"><pre class="programlisting">home.title=Home
home.intro=This is a magnificent home page, isn't it?</pre></div></li><li class="listitem">Create the French <code class="literal">.properties</code> file <code class="literal">src/main/resources/messages_fr.properties</code>:<div class="informalexample"><pre class="programlisting">home.title=Accueil
home.intro=Splendide page d'accueil, non ?</pre></div></li><li class="listitem">In Spring configuration, declare the <code class="literal">.properties</code> files:<div class="informalexample"><pre class="programlisting">@Bean
public MessageSource messageSource() {
  ReloadableResourceBundleMessageSource messageSource = new ReloadableResourceBundleMessageSource();
  messageSource.setBasename("classpath:/messages");
  messageSource.setUseCodeAsDefaultMessage(true);
  return messageSource;
}</pre></div></li><li class="listitem">Make sure that the Spring configuration class extends <code class="literal">WebMvcConfigurerAdapter</code> and is annotated with <code class="literal">@EnableWebMvc</code>:<div class="informalexample"><pre class="programlisting">@Configuration
@EnableWebMvc
public class AppConfig extends WebMvcConfigurerAdapter{
... </pre></div></li><li class="listitem">Define a <code class="literal">LocaleChangeInterceptor</code> interceptor to allow the current language to be changed with a <code class="literal">lang</code> URL parameter. Register the interceptor:<div class="informalexample"><pre class="programlisting">@Bean
public HandlerInterceptor localeChangeInterceptor() {
  LocaleChangeInterceptor interceptor = new LocaleChangeInterceptor();
  interceptor.setParamName("lang");
  return interceptor;
}

@Override
public void addInterceptors(InterceptorRegistry registry) {
  registry.addInterceptor(localeChangeInterceptor()); }</pre></div></li><li class="listitem">Store the <a id="id165" class="indexterm"/>user language selection in a cookie and declare the default language:<div class="informalexample"><pre class="programlisting">@Bean
public LocaleResolver localeResolver() {
  CookieLocaleResolver localeResolver = new CookieLocaleResolver();
  localeResolver.setDefaultLocale(new Locale("en"));
  return localeResolver;
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec64"/>How it works…</h2></div></div></div><p>The following steps describe how the preceding code works:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">When a request comes in, Spring first checks whether it has a cookie value containing a language. If the answer is yes, it uses it as the current language; otherwise, it uses the default language. This behavior comes from the declaration of <code class="literal">CookieLocaleResolver</code> as the locale resolver.</li><li class="listitem">The <code class="literal">LocaleChangeInterceptor</code> then checks whether there's a <code class="literal">lang</code> parameter in the URL. If the answer is yes, it uses it as the current language (instead of the default or cookie language).</li><li class="listitem">When <code class="literal">home.jsp</code> is rendered, its text is fetched from the <code class="literal">.properties</code> file corresponding to the current language. If no text is found for a given message key, the key itself is displayed. This behavior comes from <code class="literal">messageSource.setUseCodeAsDefaultMessage(true)</code>.</li></ol></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec65"/>There's more…</h2></div></div></div><p>You may <a id="id166" class="indexterm"/>need to retrieve the current language name from a controller method. You may also need to have the page language in the URL instead of in a cookie.</p><div class="section" title="Getting the current language"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec30"/>Getting the current language</h3></div></div></div><p>To retrieve<a id="id167" class="indexterm"/> the current language from a controller or an interceptor, use the following code:</p><div class="informalexample"><pre class="programlisting">Locale locale = LocaleContextHolder.getLocale();
String lang = locale.getLanguage(); // fr
String language = locale.getDisplayLanguage(); // French
String language2 = locale.getDisplayLanguage(locale); // français</pre></div></div><div class="section" title="Using the language in the URL"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec31"/>Using the language in the URL</h3></div></div></div><p>Spring does not <a id="id168" class="indexterm"/>provide a convenient way to handle the language in the URL (for example, <code class="literal">/en/user/list</code>). Instead, it has to be done manually:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use an interceptor to retrieve the language from the URL and override the current language.</li><li class="listitem">Prefix the controller method mappings with the supported languages (so that Spring can retrieve it from the route with the language):<div class="informalexample"><pre class="programlisting">@Controller
@RequestMapping("{en|fr}/user/*")
public class UserController {
  @RequestMapping("list")
  public String userList(Model model) {
    ...
  }
}.</pre></div></li><li class="listitem">When generating an internal link, prefix it with the current language, assuming that <code class="literal">$lang</code> contains the current language:<div class="informalexample"><pre class="programlisting">&lt;spring:url value="/${lang}/home" var="home" /&gt;
&lt;a href="${home}"&gt;Home&lt;/a&gt;</pre></div></li></ol></div></div></div></div></body></html>