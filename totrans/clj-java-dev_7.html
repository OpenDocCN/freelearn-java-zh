<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;7.&#xA0;Macros in Clojure" id="1IHDQ1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07" class="calibre1"/>Chapter 7. Macros in Clojure</h1></div></div></div><p class="calibre7">In this chapter, we will get to know one of Clojure's most complicated facilities: macros. We will learn what they are for, how to write them, and how to use them. It can be a little challenging, but there is good news too. You should be aware of some tools from your knowledge of the Java language that can help you understand macros better. We will progress little by little with comparisons to other JVM languages, and in the end, we will write some macros and understand that we have been using them for a while.</p><p class="calibre7">We will learn about the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Understanding Lisp's foundational ideas</li><li class="listitem">Macros as code modification tools</li><li class="listitem">Modifying code in Groovy</li><li class="listitem">Writing your first macro</li><li class="listitem">Debugging your first macro</li><li class="listitem">Macros in the real world</li></ul></div></div>

<div class="book" title="Chapter&#xA0;7.&#xA0;Macros in Clojure" id="1IHDQ1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Lisp's foundational ideas"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch07lvl1sec47" class="calibre1"/>Lisp's foundational ideas</h1></div></div></div><p class="calibre7">Lisp is <a id="id250" class="calibre1"/>a very different beast from what you used to know. According to Paul Graham, there<a id="id251" class="calibre1"/> are nine ideas that make Lisp different (these ideas have existed since the late 1950s), and they are:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Conditionals (remember, we are talking 1950s–1960s)</li><li class="listitem" value="2">Functions as first-class citizens</li><li class="listitem" value="3">Recursion</li><li class="listitem" value="4">Dynamic typing</li><li class="listitem" value="5">Garbage collection</li><li class="listitem" value="6">Programs as sequences of expressions</li><li class="listitem" value="7">The symbol type</li><li class="listitem" value="8">Lisp's syntax</li><li class="listitem" value="9">The whole language is there all the time: at compilation, runtime—always!</li></ol><div class="calibre22"/></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note23" class="calibre1"/>Note</h3><p class="calibre7">If you can, read Paul Graham's essay <span class="strong"><em class="calibre9">Revenge of the Nerds</em></span> (<a class="calibre1" href="http://www.paulgraham.com/icad.html">http://www.paulgraham.com/icad.html</a>), where he talks about Lisp, what makes it different, and why the language is important.</p></div><p class="calibre7">These ideas <a id="id252" class="calibre1"/>have thrived even after the Lisp age; most of them are common nowadays (can you imagine a language without conditionals?). But the last couple of ideas are what makes us Lisp lovers love the syntax (we will fully understand what they mean through this chapter).</p><p class="calibre7">Common languages are trying to achieve the very same things now with a slightly different approach, and you, as a Java developer, have probably seen this.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Macros as code modification tools" id="1JFUC1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec48" class="calibre1"/>Macros as code modification tools</h1></div></div></div><p class="calibre7">One of<a id="id253" class="calibre1"/> the first and most common uses of macros is to be able to modify code; they work on the code level, as you will see. Why should we do that? Let's try to understand the problem with something that you are more familiar with—Java.</p></div>

<div class="book" title="Macros as code modification tools" id="1JFUC1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Modifying code in Java"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec46" class="calibre1"/>Modifying code in Java</h2></div></div></div><p class="calibre7">Have <a id="id254" class="calibre1"/>you ever used AspectJ or Spring AOP? Have you ever had problems with tools such as ASM or Javassist?</p><p class="calibre7">You have probably used code modification in Java. It is common in Java EE applications, just not explicit. (Have you ever thought about what the <code class="email">@Transactional</code> annotation does in Java EE or Spring applications?)</p><p class="calibre7">As developers, we try to automate everything we can, so how could we leave out our own devtools?</p><p class="calibre7">We have tried to create ways to modify the bytecode at runtime so that we don't have to remember to open and close resources, or so that we can decouple dependencies and get dependency injection.</p><p class="calibre7">If you use Spring, you probably know about the following use cases:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">@Transactional</code> annotation modifies the annotated method to ensure that your code is wrapped in a database transaction</li><li class="listitem">The <code class="email">@Autowired</code> annotation looks for the required bean and injects it into the annotated property or method</li><li class="listitem">The <code class="email">@Value</code> annotation looks for a configuration value and then injects it</li></ul></div><p class="calibre7">You could probably think of several other annotations that modify the way your classes work.</p><p class="calibre7">The important thing <a id="id255" class="calibre1"/>here is that you understand why we want to modify code, and you probably already know a few mechanisms for doing it, including AspectJ and Spring AOP.</p><p class="calibre7">Let's take a look at how it is done in the Java world; this is what an aspect in Java looks like:</p><div class="informalexample"><pre class="programlisting">package macros.java;

public aspect SampleJavaAspect {
pointcutanyOperation() : execution(public * *.*(..));

    Object around() : anyOperation() {
System.out.println("We are about to execute this " + thisJoinPointStaticPart.getSignature());
       Object ret = proceed();
       return ret;
    }
}</pre></div><p class="calibre7">Aspects have the advantage that you can modify any code you like without having to touch it. This also has its drawbacks since you could modify the code in ways the original author didn't expect and thus cause bugs.</p><p class="calibre7">Another drawback is that you have an extremely limited field of action; you can wrap your modifications around some code or execute something before or after.</p><p class="calibre7">The libraries that generate this code are extremely complex and they can either create a proxy around your objects or modify the bytecode, at runtime or compile time.</p><p class="calibre7">As you can imagine, there are lots of things that you must be aware of, and anything could go wrong. Hence, debugging could prove complicated.</p></div></div>

<div class="book" title="Macros as code modification tools" id="1JFUC1-f3eee9b8c89a4c399520b72f8d890ddc">
<div class="book" title="Modifying code in Groovy"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec47" class="calibre1"/>Modifying code in Groovy</h2></div></div></div><p class="calibre7">Groovy <a id="id256" class="calibre1"/>has gone further down the road and it provides us with more solutions and more macro-like features.</p><p class="calibre7">Since <a id="id257" class="calibre1"/>Groovy 1.8, we have got a lot of AST transformations. What does AST stand for? It stands for <a id="id258" class="calibre1"/>
<span class="strong"><strong class="calibre8">abstract syntax tree</strong></span>—sounds complicated, right?</p><p class="calibre7">Before explaining it all, let's check what some of them do.</p><div class="book" title="The @ToString annotation"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch07lvl3sec15" class="calibre1"/>The @ToString annotation</h3></div></div></div><p class="calibre7">The <code class="email">@ToString</code> annotation<a id="id259" class="calibre1"/> generates <a id="id260" class="calibre1"/>a simple <code class="email">toString</code> method that includes information about the class of the object and the value of its properties.</p></div><div class="book" title="The @TupleConstructor annotation"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch07lvl3sec16" class="calibre1"/>The @TupleConstructor annotation</h3></div></div></div><p class="calibre7">The <code class="email">@TupleConstructor</code> creates <a id="id261" class="calibre1"/>a <a id="id262" class="calibre1"/>constructor that is able to take all of the values of your class at once. Here is an example:</p><div class="informalexample"><pre class="programlisting">@TupleConstructor
class SampleData {
int size
  String color
boolean big
}

new SampleData(5, "red", false") // We didn't write this constructor</pre></div></div><div class="book" title="The @Slf4j annotation"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch07lvl3sec17" class="calibre1"/>The @Slf4j annotation</h3></div></div></div><p class="calibre7">The <code class="email">@Slf4j</code> annotation <a id="id263" class="calibre1"/>adds an instance <a id="id264" class="calibre1"/>of a logger, called log by default, to your class, so you can do this:</p><div class="informalexample"><pre class="programlisting">log.info'hello world'</pre></div><p class="calibre7">This can be done without having to manually declare the log instance, the class name, and so on. There are lots of other things that you can do with this type of annotation, but how do they work?</p><p class="calibre7">Now, what is AST and what does it have to do with Clojure macros? Come to think of it, it actually has a lot to do with them.</p><p class="calibre7">To answer that last question, you'll have to understand a little bit about how compilers work.</p><p class="calibre7">We all know that machines (your machine, the JVM, the Erlang BEAM machine) are not capable of understanding human code, so we need a process to convert whatever developers write into what machines understand.</p><p class="calibre7">One of the most important steps of the process is to create a syntax tree, something similar to the following figure:</p><div class="mediaobject"><img src="../images/00025.jpeg" alt="The @Slf4j annotation" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">This is a very simple example of the following expression:</p><div class="informalexample"><pre class="programlisting">3 + 5</pre></div><p class="calibre7">This <a id="id265" class="calibre1"/>tree is <a id="id266" class="calibre1"/>what we call the abstract syntax tree. Let's see the tree of something that's a bit more complicated, such as this piece of code:</p><div class="informalexample"><pre class="programlisting">if(a &gt; 120) {
  a = a / 5
} else {
  a = 1200 
}</pre></div><p class="calibre7">Thus, the tree will look like the following figure:</p><div class="mediaobject"><img src="../images/00026.jpeg" alt="The @Slf4j annotation" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">As you <a id="id267" class="calibre1"/>can see, the figure is still pretty straightforward, and you can probably understand how someone would execute code from a structure like this one.</p><p class="calibre7">Groovy's AST transformation is a way to meddle with such generated code.</p><p class="calibre7">As you<a id="id268" class="calibre1"/> can imagine, this is a much more powerful approach, but you are now messing with what the compiler generated; the probable downside to this is the complexity of the code.</p><p class="calibre7">Let's check, for instance, the code of the <code class="email">@Slf4j</code> AST. It should be pretty simple, right? It just adds a log property:</p><div class="informalexample"><pre class="programlisting">            private Expression transformMethodCallExpression(Expression exp) {
MethodCallExpressionmce = (MethodCallExpression) exp;
                if (!(mce.getObjectExpression() instanceofVariableExpression)) {
                    return exp;
                }
VariableExpressionvariableExpression = (VariableExpression) mce.getObjectExpression();
                if (!variableExpression.getName().equals(logFieldName)
                        || !(variableExpression.getAccessedVariable() instanceofDynamicVariable)) {
                    return exp;
                }
                String methodName = mce.getMethodAsString();
                if (methodName == null) return exp;
                if (usesSimpleMethodArgumentsOnly(mce)) return exp;

variableExpression.setAccessedVariable(logNode);

                if (!loggingStrategy.isLoggingMethod(methodName)) return exp;

                return loggingStrategy.wrapLoggingMethodCall(variableExpression, methodName, exp);
            }</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note24" class="calibre1"/>Note</h3><p class="calibre7">You can check the complete code at <a class="calibre1" href="https://github.com/groovy/groovy-core/blob/master/src/main/org/codehaus/groovy/transform/LogASTTransformation.java">https://github.com/groovy/groovy-core/blob/master/src/main/org/codehaus/groovy/transform/LogASTTransformation.java</a>, and it's also included with the code bundle of this chapter.</p></div><p class="calibre7">This <a id="id269" class="calibre1"/>doesn't look simple at all. It is just a fragment and still looks very complicated. What happens here is that you have to deal with the Java <a id="id270" class="calibre1"/>bytecode format and with compiler complications.</p><p class="calibre7">Here, we should remember point number 8<span class="strong"><em class="calibre9"> </em></span>that Paul Graham made about the syntax of Lisp.</p><p class="calibre7">Let's write our last code example in Clojure:</p><div class="informalexample"><pre class="programlisting">(if (&gt; a 120)
  (/ a 5)
  1200)</pre></div><p class="calibre7">There's something peculiar about this piece of code: it feels very similar to the AST! This is not a coincidence. Actually, in Clojure and Lisp, you are directly writing the AST. This is one of the features that make Lisp a very simple language; you directly write what the computer understands. This might help you understand a little more about why code is data and data is code.</p><p class="calibre7">Imagine if <a id="id271" class="calibre1"/>you <a id="id272" class="calibre1"/>could modify the AST the same way that you modify any other data structure in your programs. But you can, and that's what macros are for!</p></div></div></div>
<div class="book" title="Writing your first macro" id="1KEEU1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec49" class="calibre1"/>Writing your first macro</h1></div></div></div><p class="calibre7">Now<a id="id273" class="calibre1"/> that you have a clear understanding of how macros work and what they are for, let's start working with Clojure.</p><p class="calibre7">Let me present you with a challenge: write an <code class="email">unless</code> function in Clojure, something that works like this:</p><div class="informalexample"><pre class="programlisting">(def a 150)

(my-if (&gt; a 200)
  (println"Bigger than 200")
  (println"Smaller than 200"))</pre></div><p class="calibre7">Let's give it a first try; maybe with something like the following syntax:</p><div class="informalexample"><pre class="programlisting">(defn my-if [cond positive negative]
  (if cond
    positive
    negative))</pre></div><p class="calibre7">Do you know what would happen if you wrote this code and then ran it? If you test it, you will get the following result:</p><div class="informalexample"><pre class="programlisting">Bigger than 200
Smaller than 200
Nil</pre></div><p class="calibre7">What's happening here? Let's modify it a bit so that we get a value and we can understand what's happening. Let's define it a bit differently, and let's return a value so that we see something different:</p><div class="informalexample"><pre class="programlisting">      (def a 500)
(my-if (&gt; a 200)
  (do
    (println"Bigger than 200")
    :bigger)
  (do
    (println"Smaller than 200")
    :smaller))</pre></div><p class="calibre7">We will<a id="id274" class="calibre1"/> get the following output:</p><div class="informalexample"><pre class="programlisting">Bigger than 200
Smaller than 200
:bigger</pre></div><p class="calibre7">What's going on here?</p><p class="calibre7">When you pass parameters to a function, everything is evaluated before the actual code of the function runs, so over here, before the body of your function runs, you execute both of the <code class="email">println</code> methods. After that, the <code class="email">if</code> runs correctly and you get <code class="email">:bigger</code>, but we still got an output for the positive and negative cases of our <code class="email">if</code>. It looks like our code is not working!</p><p class="calibre7">How can we fix this? With our current tools, we probably need to write closures and change the <code class="email">my-if</code> code to accept functions as parameters:</p><div class="informalexample"><pre class="programlisting">(defn my-if [cond positive negative]
  (if cond
    (positive)
    (negative)))

      (def a 500)
(my-if (&gt; a 200)
  #(do
    (println"Bigger than 200")
    :bigger)
  #(do
    (println"Smaller than 200")
    :smaller))</pre></div><p class="calibre7">This works, but there are several disadvantages:</p><div class="book"><ul class="itemizedlist"><li class="listitem">There are a lot of constraints now for the code (both clauses should now be functions)</li><li class="listitem">It doesn't work for every single case</li><li class="listitem">It is very complicated</li></ul></div><p class="calibre7">In order to solve this problem, Clojure gives us macros. Let's have a look at how they work:</p><div class="informalexample"><pre class="programlisting">(defmacro my-if [test positive negative]
  (list 'if test positive negative))

(my-if (&gt; a 200)
  (do
    (println"Bigger than 200")
    :bigger)
  (do
    (println"Smaller than 200")
    :smaller))</pre></div><p class="calibre7">The output will be this:</p><div class="informalexample"><pre class="programlisting">;; Bigger than 200
;; :bigger</pre></div><p class="calibre7">This is <a id="id275" class="calibre1"/>great! It works, but what just happened? Why did we just use a macro and why did it work?</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note25" class="calibre1"/>Note</h3><p class="calibre7">Macros are not normal Clojure functions; they are supposed to generate code and should return a Clojure form. This means that they should return a list that we can use as normal Clojure code.</p></div><p class="calibre7">Macros return code that will be executed later. And here is where point number nine of Paul Graham's list comes into play: you have all of the language all the time.</p><p class="calibre7">In C++, you have a mechanism called a macro; when you use it, you have a very limited set of things that you can do compared to actual C++ code.</p><p class="calibre7">In Clojure, you can manipulate the Clojure code any way you want, and you can use the full language here too! Since Clojure code is data, manipulating the code is as easy as manipulating any other data structure.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note26" class="calibre1"/>Note</h3><p class="calibre7">Macros are run at compile time, which means that at the time of running the code, there is no trace of macros; every macro call is replaced with the generated code.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Debugging your first macro"><div class="book" id="1LCVG2-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec50" class="calibre1"/>Debugging your first macro</h1></div></div></div><p class="calibre7">Now, as<a id="id276" class="calibre1"/> you can imagine, since things can get complicated when using macros, there should be some way to debug them. We have two functions to accomplish that:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">macroexpand</code></li><li class="listitem"><code class="email">macroexpand-1</code></li></ul></div><p class="calibre7">The difference between them has to do with recursive macros. There is no rule telling you that you can't use a macro from a macro (the whole language is there all the time, remember?). If you wish to go all the way through any macro, you can use <code class="email">macroexpand</code>; if you wish to go a single step forward, you can use <code class="email">macroexpand-1</code>.</p><p class="calibre7">Both of them show you the code generated by a macro call; this is what happens when you compile<a id="id277" class="calibre1"/> your Clojure code.</p><p class="calibre7">Give this a try:</p><div class="informalexample"><pre class="programlisting">(macroexpand-1
'(my-if (&gt; a 200)
    (do
      (println"Bigger than 200")
      :bigger)
    (do
      (println"Smaller than 200")
      :smaller)))

;; (if (&gt; a 200) (do (println"Bigger than 200") :bigger) (do (println"Smaller than 200") :smaller))</pre></div><p class="calibre7">There is not much more to macros than this; you now understand them to a good level of detail.</p><p class="calibre7">There are, however, many common problems that you will come across and tools for solving them that you should know about. Let's have a look.</p></div>

<div class="book" title="Debugging your first macro">
<div class="book" title="Quote, syntax quote, and unquoting"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec48" class="calibre1"/>Quote, syntax quote, and unquoting</h2></div></div></div><p class="calibre7">As you can see, the <code class="email">my-if</code> macro uses a quote in it:</p><div class="informalexample"><pre class="programlisting">(defmacro my-if [test positive negative]
  (list 'if test positive negative))</pre></div><p class="calibre7">This <a id="id278" class="calibre1"/>happens because you need the <code class="email">if</code> symbol as the first element in the resulting form.</p><p class="calibre7">Quoting is very common in macros, since we need to build code instead of evaluating it on the fly.</p><p class="calibre7">There is another type of quoting very <a id="id279" class="calibre1"/>common in macros—syntax quoting—that makes it easier to write code similar to the final code you want to generate. Let's change the implementation of our macro to this:</p><div class="informalexample"><pre class="programlisting">(defmacro my-if [test positive negative]
  '(if test positive negative))



(macroexpand-1
'(my-if (&gt; a 200)
    (do
      (println"Bigger than 200")
      :bigger)
    (do
      (println"Smaller than 200")
      :smaller)))

;; (if clojure.core/test user/positive user/negative)</pre></div><p class="calibre7">Let's see <a id="id280" class="calibre1"/>what happens here. For one,<code class="email">(if test positive negative)</code> looks much more beautiful than the <code class="email">list</code> function we had before, but the code generated with <code class="email">macroexpand-1</code> looks pretty strange. What happened?</p><p class="calibre7">We just used a different form of quoting that allows us to quote full expressions. It does some interesting things. As you can see, it changes the parameters to fully qualified <code class="email">var</code> names (<code class="email">clojure.core/test</code>, <code class="email">user/positive</code>, <code class="email">user/negative</code>). This is something that you'll be grateful for in the future, but you don't need this for now.</p><p class="calibre7">What you need are the values of test, positive, and negative. How can you get them in this macro?</p><p class="calibre7">Using syntax quotes, you can ask for something to be evaluated inline with the unquote operator, like this:</p><div class="informalexample"><pre class="programlisting">(defmacro my-if [test positive negative]
(if ~test ~positive ~negative))</pre></div><p class="calibre7">Let's try our macro expansion again and see what we get:</p><div class="mediaobject"><img src="../images/00027.jpeg" alt="Quote, syntax quote, and unquoting" class="calibre10"/></div><p class="calibre11"> </p></div></div>

<div class="book" title="Debugging your first macro">
<div class="book" title="Unquote splicing"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec49" class="calibre1"/>Unquote splicing</h2></div></div></div><p class="calibre7">There <a id="id281" class="calibre1"/>are some other cases that become common in macros. Let's imagine we want to reimplement the <code class="email">&gt;</code> function as a macro and retain the ability to compare several numbers; what would that look like?</p><p class="calibre7">Maybe a first attempt could be something like this:</p><div class="informalexample"><pre class="programlisting">(defmacro&gt;-macro [&amp;params]
  '(&gt; ~params))

(macroexpand'(&gt;-macro 5 4 3))</pre></div><p class="calibre7">The output <a id="id282" class="calibre1"/>of the preceding code is as follows:</p><div class="mediaobject"><img src="../images/00028.jpeg" alt="Unquote splicing" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Do you see the problem here?</p><p class="calibre7">The problem is that we are trying to pass a list of values to <code class="email">clojure.core/&gt;</code> instead of passing the values themselves.</p><p class="calibre7">This is easily solved with something called <a id="id283" class="calibre1"/>
<span class="strong"><strong class="calibre8">unquote splicing</strong></span>. Unquote splicing takes a vector or list of parameters and expands it as if you had used the <code class="email">as</code> parameter on a function or macro.</p><p class="calibre7">It works like this:</p><div class="informalexample"><pre class="programlisting">(defmacro&gt;-macro [&amp;params]
  '(&gt; ~@params)) ;; In the end this works as if you had written
                 ;; (&gt; 5 4 3)

(macroexpand'(&gt;-macro 5 4 3))</pre></div><p class="calibre7">The output of the preceding code is as follows:</p><div class="mediaobject"><img src="../images/00029.jpeg" alt="Unquote splicing" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">You will <a id="id284" class="calibre1"/>use unquote splicing almost every time you have a variable number of arguments to a macro.</p></div></div>

<div class="book" title="Debugging your first macro">
<div class="book" title="gensym"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec50" class="calibre1"/>gensym</h2></div></div></div><p class="calibre7">Generating code<a id="id285" class="calibre1"/> can be troublesome, and we end up discovering common issues.</p><p class="calibre7">See if you can find the issue in the following code:</p><div class="informalexample"><pre class="programlisting">(def a-var"hello world")

(defmacro error-macro [&amp;params]
  '(let [a-var"bye world"]
     (println a-var)))

;; (macroexpand-1 '(error-macro))
;; (clojure.core/let [user/a-var user/"bye user/world"] (clojure.core/println user/a-var))</pre></div><p class="calibre7">This is a common issue when generating code. You overwrite another value, Clojure doesn't even let you run this, and it displays something like the following screenshot:</p><div class="mediaobject"><img src="../images/00030.jpeg" alt="gensym" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">But don't worry; there's another way in which you can make sure you are not messing with your environment, which is the <code class="email">gensym</code> function:</p><div class="informalexample"><pre class="programlisting">(defmacro error-macro [&amp;params]
  (let [a-var-name (gensym'a-var)]
    `(let [~a-var-name "bye world"]
       (println ~a-var-name))))</pre></div><p class="calibre7">The <a id="id286" class="calibre1"/>
<code class="email">gensym</code> function creates a new <code class="email">var-name</code> each time the macro is run, which guarantees that there is no other <code class="email">var-name</code> that it obscures. If you try the macro expansion now, you will get this:</p><div class="informalexample"><pre class="programlisting">(clojure.core/let [a-var922"bye world"] (clojure.core/println a-var922))</pre></div><p class="calibre7">The following screenshot is the result of the preceding code:</p><div class="mediaobject"><img src="../images/00031.jpeg" alt="gensym" class="calibre10"/></div><p class="calibre11"> </p></div></div>
<div class="book" title="Macros in the real world" id="1MBG21-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec51" class="calibre1"/>Macros in the real world</h1></div></div></div><p class="calibre7">Do you want to <a id="id287" class="calibre1"/>know when it is that macros are used extensively? Think about <code class="email">defn</code>; what's more, do this:</p><div class="informalexample"><pre class="programlisting">(macroexpand-1 '(defn sample [a] (println a)))

;; (def sample (clojure.core/fn ([a] (println a))))</pre></div><p class="calibre7">Did you know that <code class="email">defn</code> is a macro in <code class="email">clojure.core</code> that creates a function and binds it to a <code class="email">var</code> in the current namespace?</p><p class="calibre7">Clojure is filled with macros; if you want some samples, you can look at Clojure core, but what else can you do with macros?</p><p class="calibre7">Let's have a <a id="id288" class="calibre1"/>look at some interesting libraries:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">yesql</code>: The <a id="id289" class="calibre1"/><code class="email">yesql</code> library is a very interesting sample of code generation. It reads SQL code from a SQL file and generates the Clojure functions accordingly. Look for the <code class="email">defquery</code> and <code class="email">defqueries</code> macros in the <code class="email">yesql</code> project on GitHub; it can be very enlightening.</li><li class="listitem"><code class="email">core.async</code>: If you are familiar with the <code class="email">go</code> language and <code class="email">goroutines</code>, you would probably like to have that same functionality in the Clojure language. This isn't necessary since you could have provided them yourself! The <code class="email">core.async</code> library is<a id="id290" class="calibre1"/> just <code class="email">goroutines</code> for Clojure, and it is provided as a library (no obscure language change is needed). This shows a great example of the power of macros.</li><li class="listitem"><code class="email">core.typed</code>: With macros, you can even change the dynamic nature of Lisp. The <code class="email">core.typed</code> library is<a id="id291" class="calibre1"/> an effort that allows you to define type constraints for your Clojure code; macros are extensively used here to generate boilerplate code and checks. This is probably much more complex.</li></ul></div></div>
<div class="book" title="References" id="1NA0K1-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec52" class="calibre1"/>References</h1></div></div></div><p class="calibre7">If you need further references, you can look at the following list. There are entire books committed to the<a id="id292" class="calibre1"/> topic of macros. I recommend two in particular:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Mastering Clojure Macros (<a class="calibre1" href="https://pragprog.com/book/cjclojure/">https://pragprog.com/book/cjclojure/</a>).</li><li class="listitem">Let over <a id="id293" class="calibre1"/>Lambda (<a class="calibre1" href="http://letoverlambda.com/">http://letoverlambda.com/</a>).It talks about common Lisp, but the knowledge is very valuable.</li></ul></div></div>
<div class="book" title="Summary" id="1O8H61-f3eee9b8c89a4c399520b72f8d890ddc"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec53" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">You now understand the power of macros and have a very strong grasp of how they work, but we just touched the tip of the iceberg when it comes to macros.</p><p class="calibre7">In this chapter, we learned about the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Fundamentals of how macros work</li><li class="listitem">Modifying your code in Groovy</li><li class="listitem">The relation of macros to other tools in the Java world</li><li class="listitem">Writing your own macros</li></ul></div><p class="calibre7">I am sure you've enjoyed working with Clojure so far, and moving forward, I'd recommend you to keep reading and exploring this amazing language.</p></div></body></html>