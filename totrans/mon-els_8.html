<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Looking Forward"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Looking Forward</h1></div></div></div><p>This final chapter discusses the next major release of Elasticsearch, version 5.0, which is a significant upgrade over 2.3.2. It introduces a number of API enhancements, in addition to several performance and reliability updates. Many of these changes will, for better or for worse, affect your interaction with and monitoring of an Elasticsearch cluster.</p><p>The specific topics we'll discuss in this chapter include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Elasticsearch 5 overview</li><li class="listitem" style="list-style-type: disc">Upgrading to Elasticsearch 5</li><li class="listitem" style="list-style-type: disc">Monitoring Elasticsearch 5</li></ul></div><div class="section" title="Elasticsearch 5 overview"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec44"/>Elasticsearch 5 overview</h1></div></div></div><p>Elasticsearch 5 will <a id="id357" class="indexterm"/>follow Elasticsearch 2 as the next major software release. Although this may be chronologically jarring, Elastic.co purposefully jumped from version 2 to 5 to better synchronize the updated version of Elasticsearch with several other Elastic.co products, including Kibana, Logstash, Marvel (called <span class="strong"><strong>Monitoring</strong></span> in <a id="id358" class="indexterm"/>5.0), and more. This update will help ensure that all Elastic.co software running on a cluster is both compatible and up-to-date.</p><p>There are hundreds of new changes being introduced in version 5, but a few relevant highlights include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Compatibility between the Elasticsearch 2 API and Elasticsearch 5</li><li class="listitem" style="list-style-type: disc">Indices from Elasticsearch 2 can be migrated to version 5:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Indices from Elasticsearch 1 must first be migrated to version 2 before migrating them to version 5</li></ul></div></li><li class="listitem" style="list-style-type: disc">Marvel is renamed Monitoring</li><li class="listitem" style="list-style-type: disc">The Elasticsearch-Logstash-Kibana stack<a id="id359" class="indexterm"/> is renamed the <span class="strong"><strong>Elastic Stack</strong></span></li><li class="listitem" style="list-style-type: disc">The plugin API no longer supports site plugins, including plugins such as Elasticsearch-head, Bigdesk, and Kopf</li><li class="listitem" style="list-style-type: disc">The warmers API is removed in favor of eager field data loading and disk-based norms</li><li class="listitem" style="list-style-type: disc">Lucene version upgraded from 5 to 6</li><li class="listitem" style="list-style-type: disc">Several <a id="id360" class="indexterm"/>configuration changes, including removal of all system environment variables, such as <code class="literal">ES_HEAP</code>, in favor of Java VM command-line arguments</li><li class="listitem" style="list-style-type: disc"><code class="literal">text</code> and <code class="literal">keyword</code> mapping types deprecated in favor of <code class="literal">string</code> type</li><li class="listitem" style="list-style-type: disc"><code class="literal">bin/plugin</code> renamed to <code class="literal">bin/elasticsearch-plugin</code></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>Elasticsearch-head, Bigdesk, and Kopf have not yet been updated to be compatible with Elasticsearch 5. When they are upgraded, they will run as standalone applications, similar to Kibana.</p></div></div><div class="section" title="Performance and reliability"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec76"/>Performance and reliability</h2></div></div></div><p>Elasticsearch 5 introduces<a id="id361" class="indexterm"/> several performance and reliability improvements, including:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Indexing performance improved 15-20% for small documents</li><li class="listitem" style="list-style-type: disc">Lucene 6 improves search time by 25% and decreases disk space usage by 50% for numeric, date, and geospatial fields</li><li class="listitem" style="list-style-type: disc">The<code class="literal"> elasticsearch.yml</code> settings file is now strictly validated, meaning Elasticsearch won't start if there is a configuration error</li><li class="listitem" style="list-style-type: disc">If a production node (meaning a node that isn't bound to the <code class="literal">localhost</code> address) doesn't have enough file handles available, or doesn't have permission to lock the system's memory usage via the <code class="literal">mlockall</code> setting, it will throw an exception and won't start</li></ul></div></div><div class="section" title="Data loss"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec77"/>Data loss</h2></div></div></div><p>Elasticsearch 2 has a <a id="id362" class="indexterm"/>well-publicized, ongoing issue in which, in rare circumstances involving networking problems and a network partition, Elasticsearch can drop data during ingestion.</p><p>Writes made to Elasticsearch during the network partition will be confirmed, but not all will actually make it to the index. The Elasticsearch team has made a strong effort to address this problem, and many—but not all—instances of the bug are fixed in the new version. In consideration of this, contemplate the following when building an Elasticsearch-backed application in both version 2 and version 5:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Don't use Elasticsearch as a primary data store. Instead, use a database such as HBase, Cassandra, PostgreSQL, or another, depending on your data size and requirements.</li><li class="listitem" style="list-style-type: disc">Be sure to <a id="id363" class="indexterm"/>verify that the number of data records in your primary data store match those in Elasticsearch.</li><li class="listitem" style="list-style-type: disc">Have a plan to re-index data in the event of data loss.</li></ul></div><p>While data loss is <span class="emphasis"><em>very</em></span> unlikely, the potential impact is huge and it is important to have a plan of action in place.</p></div></div></div>
<div class="section" title="Upgrading to Elasticsearch 5.0"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec45"/>Upgrading to Elasticsearch 5.0</h1></div></div></div><p>Elasticsearch 5<a id="id364" class="indexterm"/> version will be released soon. It's a good idea to start testing your cluster's compatibility with the new version. To help with the upgrade process, Elastic.co <a id="id365" class="indexterm"/>offers a tool called the <span class="strong"><strong>Elasticsearch Migration Helper</strong></span>. Install this tool as an Elasticsearch 2.3 plugin:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>sudo /usr/share/elasticsearch/bin/plugin install https://github.com/elastic/elasticsearch-migration/releases/download/v2.0-alpha2/elasticsearch-migration-2.0-alpha2.zip</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>The Elasticsearch Migration Helper is only compatible with Elasticsearch 2.3.</p></div></div><p>After installing the plugin, open it in the browser by visiting <code class="literal">http://elasticsearch-node-01:9200/_plugin/elasticsearch-migration/</code>, as seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03798_08_01.jpg" alt="Upgrading to Elasticsearch 5.0"/><div class="caption"><p>Elasticsearch Migration Helper</p></div></div><p>The <span class="strong"><strong>Cluster Checkup</strong></span> diagnostic <a id="id366" class="indexterm"/>will display a report of the necessary updates before using Elasticsearch 5:</p><div class="mediaobject"><img src="graphics/B03798_08_02.jpg" alt="Upgrading to Elasticsearch 5.0"/><div class="caption"><p>Elasticsearch Migration Helper configuration check report</p></div></div><p>The <span class="strong"><strong>Cluster Checkup</strong></span> shows <a id="id367" class="indexterm"/>us that we'll have to remove some incompatible plugins before moving to Elasticsearch 5, including Elasticsearch-head, Kopf, and the Marvel Agent. We'll also have to update a few system and node configuration settings before upgrading.</p><p>After fixing all of these configuration issues, we can use the Elasticsearch Migration Helper to enable the deprecation log. This log file records anytime we call an Elasticsearch API method that will be deprecated or removed in version 5. </p><p>The following screenshot shows how to enable the deprecation log from the Elasticsearch Migration Helper:</p><div class="mediaobject"><img src="graphics/B03798_08_03.jpg" alt="Upgrading to Elasticsearch 5.0"/><div class="caption"><p>Click the Enable/Disable link to activate the deprecation log</p></div></div><p>Once the log is<a id="id368" class="indexterm"/> enabled, it can be found at:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>/var/log/elasticsearch/&lt;cluster_name&gt;_deprecation.log</strong></span>
</pre></div><div class="section" title="When to upgrade"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec78"/>When to upgrade</h2></div></div></div><p>After running the <a id="id369" class="indexterm"/>Elasticsearch Migration Helper and correcting all relevant errors and warnings, it's safe to upgrade to Elasticsearch 5 in a development environment. You can now test the application to ensure that everything works with the new version. Pay close attention to the deprecation log and note things that you'll need to fix.</p><p>Since this is such a major release, it may be worth delaying your production upgrade until a few months after the General Availability release. As with any new piece of software, there may be bugs with early versions of Elasticsearch 5 that will be fixed shortly after it is made generally available.</p></div></div>
<div class="section" title="Monitoring Elasticsearch 5"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec46"/>Monitoring Elasticsearch 5</h1></div></div></div><p>Elastic.co rebranded its <a id="id370" class="indexterm"/>suite of monitoring tools, including the Elasticsearch-Logstash-Kibana (ELK) stack, in Elasticsearch 5. Marvel is now renamed <span class="strong"><strong>Monitoring</strong></span> and comes bundled with some additional monitoring tools. The ELK stack is now just the <a id="id371" class="indexterm"/>
<span class="strong"><strong>Elastic Stack</strong></span>.</p><p>The Elasticsearch X-Pack is a premium suite of monitoring tools that Elastic.co charges an annual fee for running in production. The X-Pack consists of the following tools:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Monitoring</strong></span>: Previously <a id="id372" class="indexterm"/>Marvel</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Shield</strong></span>: Adds <a id="id373" class="indexterm"/>authentication, access control, and HTTPS support to Elasticsearch</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Watcher</strong></span>: Similar to Nagios, but<a id="id374" class="indexterm"/> with some Elasticsearch-specific features, such as sending email alerts if a query runs slow</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Graph</strong></span>: Network-graph <a id="id375" class="indexterm"/>data visualization tool</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Reporting</strong></span>: Generates<a id="id376" class="indexterm"/> PDF reports based on data in Kibana</li></ul></div><p>Kibana and Marvel also received an updated look and feel, as seen in the following screenshots:</p><div class="mediaobject"><img src="graphics/B03798_08_04.jpg" alt="Monitoring Elasticsearch 5"/><div class="caption"><p>Kibana updated look and feel</p></div></div><div class="mediaobject"><img src="graphics/B03798_08_05.jpg" alt="Monitoring Elasticsearch 5"/><div class="caption"><p>Marvel is now Monitoring with an updated look and feel</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec47"/>Summary</h1></div></div></div><p>This chapter examined the upcoming Elasticsearch 5 release, discussed upgrading to version 5, and touched on the new monitoring tools available in the Elasticsearch X-Pack. Some takeaways from this chapter include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Elasticsearch 5 has some big performance and reliability gains, but also some breaking changes to the API.</li><li class="listitem" style="list-style-type: disc">Elasticsearch-head, Bigdesk, and Kopf are not yet compatible with Elasticsearch 5.</li><li class="listitem" style="list-style-type: disc">Elasticsearch 5 is a major release, and upgrading from version 2 may not be a simple process. Be sure to run the Elasticsearch Migration Helper before upgrading.</li><li class="listitem" style="list-style-type: disc">The Elasticsearch X-Pack provides a suite of monitoring tools for Elasticsearch 5, but isn't free.</li></ul></div><p>Thanks for reading <span class="emphasis"><em>Monitoring Elasticsearch</em></span>. I hope you learned some new techniques for monitoring and troubleshooting an Elasticsearch cluster. If you take only one thing away from reading this book, I hope it is to be meticulous and to test at every step of the way when troubleshooting issues that pop up when working with Elasticsearch.</p><p>If you feel like giving back to the Elasticsearch community, please consider making contributions to the Elasticsearch-head, Bigdesk, or Kopf projects. These are all excellent open source tools that make the lives of everyone working with Elasticsearch easier. And, as mentioned in this chapter, they all need to be re-architected and updated to work with Elasticsearch 5.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>You can read more about the following topics here:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Elasticsearch-head: <a class="ulink" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></li><li class="listitem" style="list-style-type: disc">Bigdesk: <a class="ulink" href="https://github.com/lukas-vlcek/bigdesk">https://github.com/lukas-vlcek/bigdesk</a></li><li class="listitem" style="list-style-type: disc">Kopf: <a class="ulink" href="https://github.com/lmenezes/elasticsearch-kopf">https://github.com/lmenezes/elasticsearch-kopf</a></li></ul></div></div></div><p>Also, feel free to reach out to me on Twitter: <code class="literal">@dwnoble</code>.</p></div></body></html>