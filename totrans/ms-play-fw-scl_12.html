<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;Play in Production"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Play in Production</h1></div></div></div><p>Application deployment, configurations, and so on are slightly different in a production environment since it is affected by various factors, such as security, load/traffic (which is expected to handle), network issues, and so on. In this chapter, we will see how to get our Play application up and running in production. This chapter covers the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Deploying an application</li><li class="listitem" style="list-style-type: disc">Configuring for production</li><li class="listitem" style="list-style-type: disc">Enabling SSL</li><li class="listitem" style="list-style-type: disc">Using a load balancer</li></ul></div><div class="section" title="Deploying a Play application"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec76"/>Deploying a Play application</h1></div></div></div><p>A Play Framework <a id="id427" class="indexterm"/>provides commands to package and deploy Play applications in production.</p><p>The <code class="literal">run</code> command, which we used earlier, starts the application in <code class="literal">DEV</code> mode and watches the code for changes. When there is a change in the code, the application is recompiled and reloaded. Being watchful is handy during development, but is an unnecessary overhead in production. Also, the default error pages shown in <code class="literal">PROD</code> mode are different from the ones shown in <code class="literal">DEV</code> mode, that is, they have less information about the errors that are occurring (for security reasons).</p><p>Let's look at the different ways in which we can deploy an application in production.</p><div class="section" title="Using the start command"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec38"/>Using the start command</h2></div></div></div><p>To start an <a id="id428" class="indexterm"/>application in <code class="literal">PROD</code> mode, we can use the <code class="literal">start</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[PlayScala] $ start</strong></span>
<span class="strong"><strong>[info] Wrote /PlayScala/target/scala-2.10/playscala_2.10-1.0.pom</strong></span>

<span class="strong"><strong>(Starting server. Type Ctrl+D to exit logs, the server will remain in background)</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Play server process ID is 24353</strong></span>
<span class="strong"><strong>[info] play - Application started (Prod)</strong></span>
<span class="strong"><strong>[info] play - Listening for HTTP on /0:0:0:0:0:0:0:0:9000</strong></span>
</pre></div><p>The process ID can be used later to stop the application. By pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>, we do not lose the logs, since they are also captured in <code class="literal">logs/application.log</code> by default (that is, when there's been no change in the logger configuration).</p><p>The <code class="literal">start</code> command <a id="id429" class="indexterm"/>optionally accepts the port number at which the application should be deployed:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[PlayScala] $ start 9123</strong></span>
<span class="strong"><strong>[info] Wrote /PlayScala/target/scala-2.10/playscala_2.10-1.0.pom</strong></span>

<span class="strong"><strong>(Starting server. Type Ctrl+D to exit logs, the server will remain in background)</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>Play server process ID is 12502</strong></span>
<span class="strong"><strong>[info] play - Application started (Prod)</strong></span>
<span class="strong"><strong>[info] play - Listening for HTTP on /0:0:0:0:0:0:0:0:9123</strong></span>
</pre></div></div><div class="section" title="Using a distribution"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec39"/>Using a distribution</h2></div></div></div><p>Although the <code class="literal">start</code> <a id="id430" class="indexterm"/>command is good enough to deploy the application, in scenarios where a portable version of the application is required, it may not be sufficient. In this section, we will see how to build a standalone distribution of our application.</p><p>The Play Framework <a id="id431" class="indexterm"/>supports building a distribution of an application using the <code class="literal">sbt-native-packager</code> plugin (refer to <a class="ulink" href="http://www.scala-sbt.org/sbt-native-packager/">http://www.scala-sbt.org/sbt-native-packager/</a>). The plugin can be used to create the <code class="literal">.msi</code> (Windows), <code class="literal">.deb</code> (Debian), <code class="literal">.rpm</code> (Red Hat Package Manager), and <code class="literal">.zip</code> (universal) files, as well as the Docker images of our application. The plugin also supports defining settings for the package in the application's build file. Some of the settings are common while others are OS-specific. The common ones are shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Setting</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th><th style="text-align: left" valign="bottom">
<p>Default value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">packageName</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Name of the created output package without the extension</p>
</td><td style="text-align: left" valign="top">
<p>Project name transformed from mixed case and spaces to lowercase and dash-separated</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">packageDescription</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The description of the package</p>
</td><td style="text-align: left" valign="top">
<p>Project name</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">packageSummary</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Summary of the contents of a Linux package</p>
</td><td style="text-align: left" valign="top">
<p>Project name</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">executableScriptName</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Name of the executing script</p>
</td><td style="text-align: left" valign="top">
<p>Project name transformed from mixed case and spaces to lowercase and dash-separated</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">maintainer</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The name/e-mail address of a maintainer for the native package</p>
</td><td style="text-align: left" valign="top"> </td></tr></tbody></table></div><p>Now, let's see how we <a id="id432" class="indexterm"/>can build packages for different OSes and use them.</p><div class="section" title="Universal distribution"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec08"/>Universal distribution</h3></div></div></div><p>A universal <a id="id433" class="indexterm"/>distribution is compatible with all/most operating <a id="id434" class="indexterm"/>systems. The generated packages are located at <code class="literal">projectHome/target/universal</code>. We can use any of the following commands <a id="id435" class="indexterm"/>to create a package as required:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">universal:packageBin</code> – This command creates an <code class="literal">appname-appVersion.zip</code> file of the packaged application</li><li class="listitem" style="list-style-type: disc"><code class="literal">universal:packageZipTarball</code> – This command creates an <code class="literal">appname-appVersion.tgz</code> file of the packaged application</li><li class="listitem" style="list-style-type: disc"><code class="literal">universal:packageOsxDmg</code> – This command creates an <code class="literal">appname-appVersion.dmg</code> file of the packaged application (the command only works on OS X)</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note41"/>Note</h3><p>The <code class="literal">universal:packageZipTarball</code> command requires the <code class="literal">gzip</code>, <code class="literal">xz</code>, and <code class="literal">tar</code> command-line tools, while <code class="literal">universal:packageOsxDmg</code> requires OS X or systems installed with <code class="literal">hdiutil</code>.</p></div></div><p>To use the package built through these commands, extract the files and execute <code class="literal">bin/appname</code> for the Unix-based systems and <code class="literal">bin/appname.bat</code> for systems with Windows.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note42"/>Note</h3><p>In a Play application, we can use the <code class="literal">dist</code> command instead of <code class="literal">universal:packageBin</code>. The <code class="literal">dist</code> command deletes unnecessary intermediate files created while packaging the application using the <code class="literal">universal:packageBin</code> command.</p></div></div></div><div class="section" title="Debian distribution"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec09"/>Debian distribution</h3></div></div></div><p>We can create a distribution that can be installed on Debian-based systems using the <code class="literal">debian:packageBin</code> <a id="id436" class="indexterm"/>command. The <code class="literal">.deb</code> file is located at <code class="literal">projectHome/target</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note43"/>Note</h3><p>To build the <a id="id437" class="indexterm"/>Debian package, the value for <code class="literal">packageDescription</code> in the Debian setting should be set in the <code class="literal">build</code> file. Other Debian package settings can also be set in the <code class="literal">build</code> file.</p></div></div><p>After packaging, we can install the application using <code class="literal">dpkg-deb</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>projectHome$ sudo dpkg -i target/appname-appVersion.deb</strong></span>
</pre></div><p>Once it's installed, we can start the application by executing this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo appname</strong></span>
</pre></div></div><div class="section" title="The rpm distribution"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec10"/>The rpm distribution</h3></div></div></div><p>An <code class="literal">rpm</code> <a id="id438" class="indexterm"/>package of the application can be created using the <code class="literal">rpm:packageBin</code> command. Some of the settings available for the <code class="literal">rpm</code> package are shown in the <a id="id439" class="indexterm"/>following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Setting</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rpmVendor</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Name of the vendor for this <code class="literal">rpm</code> package</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rpmLicense</code>
</p>
</td><td style="text-align: left" valign="top">
<p>License of the code within the <code class="literal">rpm</code> package</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rpmUrl</code>
</p>
</td><td style="text-align: left" valign="top">
<p>URL to include in the <code class="literal">rpm</code> package</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rpmDescription</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Description of this <code class="literal">rpm</code> package</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rpmRelease</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Special release number for this <code class="literal">rpm</code> package</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note44"/>Note</h3><p>The values for <code class="literal">rpmVendor</code> in <code class="literal">rpm</code>, <code class="literal">packageSummary</code> in <code class="literal">rpm</code>, and <code class="literal">packageDescription</code> in <code class="literal">rpm</code> must be set in the <code class="literal">build</code> file to successfully create an <code class="literal">rpm</code> package of the application where <code class="literal">rpm</code> is the scope, for example the name in <code class="literal">rpm:= "SampleProject"</code>.</p></div></div><p>Once the <code class="literal">rpm</code> package is generated, we can install it using <code class="literal">yum</code> or an equivalent tool:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>projectHome$ sudo yum install target/appname-appVersion.rpm</strong></span>
</pre></div><p>After the installation is completed, we can start the application by executing this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo appname</strong></span>
</pre></div></div><div class="section" title="Windows distribution"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec11"/>Windows distribution</h3></div></div></div><p>A Windows installer <a id="id440" class="indexterm"/>of the application, <code class="literal">appname-appVersion.msi</code>, can <a id="id441" class="indexterm"/>be created using the <code class="literal">windows:packageBin</code> command. The file is located at <code class="literal">projectHome/target</code>.</p></div></div></div></div>
<div class="section" title="Configuring for production"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec77"/>Configuring for production</h1></div></div></div><p>The Play Framework understands that applications may require changes in configuration prior to deployment in production. To simplify deploying, the command to deploy the application also accepts application-level configurations as arguments:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[PlayScala] $ start -Dapplication.secret=S3CR3T</strong></span>
<span class="strong"><strong>[info] Wrote /PlayScala/target/scala-2.10/playscala_2.10-1.0.pom</strong></span>

<span class="strong"><strong>(Starting server. Type Ctrl+D to exit logs, the server will remain in background)</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Play server process ID is 14904</strong></span>
</pre></div><p>Let's change the application's HTTP port as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>#setting http port to 1234</strong></span>
<span class="strong"><strong>[PlayScala] $ start -Dhttp.port=1234</strong></span>
</pre></div><p>In some projects, the production and development configuration are maintained in two separate files. We could either pass one or more configurations or a different file altogether. There are three ways of specifying a configuration file explicitly. It can be achieved by using one of the following options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">config.resource</code>: This option is used when the file is within the class path (a file in <code class="literal">application/conf</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">config.file</code>: This option is used when the file is available on the local filesystem but not bundled with the application's resources</li><li class="listitem" style="list-style-type: disc"><code class="literal">config.url</code>: This option is used when the file is to be loaded from a URL</li></ul></div><p>Suppose our application uses <code class="literal">conf/application-prod.conf</code> in production, we can specify the file as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[PlayScala] $ start -Dconfig.resource=application-prod.conf</strong></span>
</pre></div><p>Similarly, we can also modify the logger configuration by replacing the <code class="literal">config</code> key with <code class="literal">logger</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[PlayScala] $ start -Dlogger.resource=logger-prod.xml</strong></span>
</pre></div><p>We can also configure the underlying Netty server by passing the settings as arguments and this not possible through <code class="literal">application.conf</code>. The following table lists some of the settings related to the server that can be configured in one or more ways.</p><p>The properties related to the address and port are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th><th style="text-align: left" valign="bottom">
<p>Default value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.address</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The address at which the application will be deployed</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">0.0.0.0</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.port</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The port at which the application will be available</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">9000</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">https.port</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <code class="literal">sslPort</code> port at which the application will be available</p>
</td><td style="text-align: left" valign="top"> </td></tr></tbody></table></div><p>The properties related to the <a id="id442" class="indexterm"/>HTTP requests (<code class="literal">HttpRequestDecoder</code>) are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th><th style="text-align: left" valign="bottom">
<p>Default value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.maxInitialLineLength</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The maximum length of the initial line (for example, <code class="literal">GET / HTTP/1.0</code>)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">4096</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.maxHeaderSize</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The maximum length of all the headers combined together</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">8192</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.maxChunkSize</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The maximum length of the body or each chunk of it. If the length of the body exceeds this value, the content will be split into chunks of this size or less (in case of the last one). If the request sends the chunked data and the length of a chunk exceeds this value, it will be split into smaller chunks.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">8192</code>
</p>
</td></tr></tbody></table></div><p>The properties related <a id="id443" class="indexterm"/>to the TCP socket options are <a id="id444" class="indexterm"/>shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th><th style="text-align: left" valign="bottom">
<p>Default</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.backlog</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The maximum size for queued incoming connections</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.reuseAddress</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Reuse address</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.receiveBufferSize</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The size of the socket that receives a buffer</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.sendBufferSize</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The size of the socket that sends a buffer</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.child.keepAlive</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Keeps connections alive</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">False</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.child.soLinger</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Lingers on closing if the data is present</p>
</td><td style="text-align: left" valign="top">
<p>Negative integer (disabled)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.tcpNoDelay</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Disables Nagle's algorithm. TCP/IP uses an algorithm known as Nagle's algorithm to coalesce short segments and improve network efficiency.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">False</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http.netty.option.trafficClass</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <span class="strong"><strong>Type of Service</strong></span> (<span class="strong"><strong>ToS</strong></span>) octet in the <a id="id445" class="indexterm"/>
<span class="strong"><strong>Internet Protocol</strong></span> (IP) <a id="id446" class="indexterm"/>header.</p>
</td><td style="text-align: left" valign="top">
<p>0</p>
</td></tr></tbody></table></div></div>
<div class="section" title="Enabling SSL"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec78"/>Enabling SSL</h1></div></div></div><p>There are two <a id="id447" class="indexterm"/>ways of enabling SSL for our application. We can either serve an HTTPS application by the providing the required configuration for it on start, or by proxying the requests through an SSL-enabled web server. In this section, we will see how the first option can be used and the latter will be covered in the next section.</p><p>We can choose to run both the HTTP and HTTPS versions or just opt for one of them using the <code class="literal">http.port</code> and <code class="literal">https.port</code> settings. By default, HTTPS is disabled and we can enable it by specifying <code class="literal">https.port</code> as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>#setting https port to 1234</strong></span>
<span class="strong"><strong>[PlayScala] $ start -Dhttps.port=1234</strong></span>

<span class="strong"><strong>#disabling http port and setting https port to 1234</strong></span>
<span class="strong"><strong>[PlayScala] $ start -Dhttp.port=disabled -Dhttps.port=1234</strong></span>
</pre></div><p>Play generates self-signed certificates if we do not provide them, and starts the application with SSL enabled in it. However, these certificates are unsuitable for an actual application and we need to specify the details of the key store using the following settings:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th><th style="text-align: left" valign="bottom">
<p>Default value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">https.keyStore</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The path to the key store containing a private key and certificate</p>
</td><td style="text-align: left" valign="top">
<p>This value is dynamically generated</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">https.keyStoreType</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The key store type</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>JavaKeyStore</strong></span> (<span class="strong"><strong>JKS</strong></span>)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">https.keyStorePassword</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The password</p>
</td><td style="text-align: left" valign="top">
<p>Blank password</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">https.keyStoreAlgorithm</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The key store algorithm</p>
</td><td style="text-align: left" valign="top">
<p>The platform's default algorithm</p>
</td></tr></tbody></table></div><p>In addition to this, we can also specify <code class="literal">SSLEngine</code> through the <code class="literal">play.http.sslengineprovider</code> setting. The prerequisite for this is that the custom <code class="literal">SSLEngine</code> should implement the <code class="literal">play.server.api.SSLEngineProvider</code> trait.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note45"/>Note</h3><p>It is recommended to use <a id="id448" class="indexterm"/>JDK 1.8 when a Play application with SSL enabled is running in production, since Play uses some of the features of JDK 1.8 to facilitate it. If using JDK 1.8 is not feasible, a reverse proxy with SSL <a id="id449" class="indexterm"/>enabled should be used instead. Refer to <a class="ulink" href="https://www.playframework.com/documentation/2.3.x/ConfiguringHttps">https://www.playframework.com/documentation/2.3.x/ConfiguringHttps</a> for more details.</p></div></div></div>
<div class="section" title="Using a load balancer"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec79"/>Using a load balancer</h1></div></div></div><p>Websites that deal with <a id="id450" class="indexterm"/>huge traffic generally use a technique called load balancing to improve the availability and responsiveness of applications. A load balancer distributes incoming traffic among multiple servers hosting same content. The distribution of load is determined by various scheduler algorithms.</p><p>In this section, we will see how to add a load balancer in front of our application servers (assuming that they are running on the IPs <code class="literal">127.0.0.1</code>, <code class="literal">127.0.0.2</code>, and <code class="literal">127.0.0.3</code> on the port <code class="literal">9000</code>) using different HTTP web servers.</p><div class="section" title="Apache HTTP"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec40"/>Apache HTTP</h2></div></div></div><p>The Apache HTTP <a id="id451" class="indexterm"/>server provides a secure, efficient, and extensible server that supports HTTP services. The Apache HTTP server can be used as a load balancer through its <code class="literal">mod_proxy</code> and <code class="literal">mod_proxy_balance</code> modules.</p><p>To use Apache HTTP as a load balancer, <code class="literal">mod_proxy</code> and <code class="literal">mod_proxy_balancer</code> have to be present in the server. To set up the load balancer, all we need to do is update <code class="literal">/etc/httpd/conf/httpd.conf</code>.</p><p>Let's update the configuration step by step:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Declare <code class="literal">VirtualHost</code>:<div class="informalexample"><pre class="programlisting">&lt;VirtualHost *:80&gt;
&lt;/VirtualHost&gt;</pre></div></li><li class="listitem">Disable the forward proxy for <code class="literal">VirtualHost</code> so that our server cannot be used for masking the identities of clients from the source servers:<div class="informalexample"><pre class="programlisting">ProxyRequests off</pre></div></li><li class="listitem">Instead of a document root, we should add a proxy with balancer identifier and <code class="literal">BalanceMembers</code>. Also, if we want to use the <span class="strong"><strong>round-robin</strong></span> strategy, we also need to set it as <code class="literal">lbmethod</code> (<span class="strong"><strong>load balancing method</strong></span>):<div class="informalexample"><pre class="programlisting">&lt;Proxy balancer://app&gt;
    BalancerMember http://127.0.0.1:9000
       BalancerMember http://127.0.0.2:9000
       BalancerMember http://127.0.0.3:9000
    ProxySet lbmethod=byrequests
&lt;/Proxy&gt;</pre></div></li><li class="listitem">Now, we need to add the access permissions for the proxy, which should be accessible to everyone:<div class="informalexample"><pre class="programlisting">                Order Deny,Allow
                Deny from none
                Allow from all</pre></div></li><li class="listitem">Finally, we need to map the proxy to the path that we want to load the application on the server to. This can be done with a single line:<div class="informalexample"><pre class="programlisting">ProxyPass / balancer://app/</pre></div></li></ol></div><p>The configuration that <a id="id452" class="indexterm"/>needs to be added to the Apache HTTP configuration file is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;VirtualHost *:80&gt;
        ProxyPreserveHost On
        ProxyRequests off
        &lt;Proxy balancer://app&gt;

                BalancerMember http://127.0.0.1:9000
                BalancerMember http://127.0.0.2:9000
                BalancerMember http://127.0.0.3:9000
                Order Deny,Allow
                Deny from none
                Allow from all

                ProxySet lbmethod=byrequests
        &lt;/Proxy&gt;
        ProxyPass / balancer://app/
&lt;/VirtualHost&gt;</pre></div><p>To enable SSL, we will need to add the following code to the <code class="literal">VirtualHost</code> definition:</p><div class="informalexample"><pre class="programlisting">SSLEngine on
SSLCertificateFile /path/to/domain.com.crt
SSLCertificateKeyFile /path/to/domain.com.key</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note46"/>Note</h3><p>This configuration has been tried on Apache/2.4.10 on July 31, 2014.</p></div></div><p>For more information on <a id="id453" class="indexterm"/>Apache HTTP's <code class="literal">mod_proxy</code> module, refer to <a class="ulink" href="http://httpd.apache.org/docs/2.2/mod/mod_proxy.html">http://httpd.apache.org/docs/2.2/mod/mod_proxy.html</a>.</p></div><div class="section" title="The nginx server"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec41"/>The nginx server</h2></div></div></div><p>The <span class="strong"><strong>nginx</strong></span> server <a id="id454" class="indexterm"/>is a high performance HTTP server and a reverse proxy as well. It is also an IMAP/POP3 proxy server. We can configure nginx to act as a load balancer using two modules—<code class="literal">proxy</code> and <code class="literal">upstream</code>. These two modules are part of the nginx core and are available by default.</p><p>The nginx configuration file, <code class="literal">nginx.conf</code>, is generally located at <code class="literal">/etc/nginx</code>. Let's update it to use nginx as a load balancer for our application step by step:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we need to define an <code class="literal">upstream</code> module for our cluster of application servers. The syntax is as follows:<div class="informalexample"><pre class="programlisting">upstream &lt;group&gt; {
&lt;loadBalancingMethod&gt;;
server &lt;server1&gt;;
server &lt;server2&gt;;
}</pre></div><p>The default load balancing method is round-robin. So, we need not specify it explicitly when we wish to use it. Now, for our application, the <code class="literal">upstream</code> module will be as follows:</p><div class="informalexample"><pre class="programlisting">upstream app {
    server 127.0.0.1:9000;
    server 127.0.0.2:9000;
    server 127.0.0.3:9000;
}</pre></div></li><li class="listitem">Now, all that we need to do is proxy all the requests. To do this, we must update the <code class="literal">server</code> module's location module:<div class="informalexample"><pre class="programlisting">server {
    listen       80 default_server;
    server_name  localhost;
    …
    location / {
        proxy_pass http://app;        
        proxy_set_header Host $host;
    }
}</pre></div></li></ol></div><p>The nginx server also supports proxying <span class="strong"><strong>WebSocket</strong></span>. To enable WebSocket connections, we need to add two headers to the <code class="literal">location</code> module. So, if our Play application uses WebSocket, we can define the <code class="literal">location</code> module as follows:</p><div class="informalexample"><pre class="programlisting">location / {
    proxy_pass http://app;
    proxy_set_header Host $host;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}</pre></div><p>To enable SSL, we <a id="id455" class="indexterm"/>need to add the following settings to the server definition:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>    ssl_certificate     /path/to/domain.com.crt;</strong></span>
<span class="strong"><strong>    ssl_certificate_key path/to/domain.com.key;</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note47"/>Note</h3><p>This configuration has <a id="id456" class="indexterm"/>been tested on nginx/1.4.7.</p><p>Refer to the nginx documentation at <a class="ulink" href="http://nginx.org/en/docs/http/load_balancing.html#nginx_load_balancing_configuration">http://nginx.org/en/docs/http/load_balancing.html#nginx_load_balancing_configuration</a> for more details.</p></div></div></div><div class="section" title="lighttpd"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec42"/>lighttpd</h2></div></div></div><p>The <code class="literal">lighttpd</code> <a id="id457" class="indexterm"/>server is a lightweight web server designed and optimized for high performance environments. All the utilities that may be required are available as modules and can be included as per our requirements. We can set <code class="literal">lighttpd</code> as a frontend server for our Play application using the <code class="literal">mod_proxy</code> module. We need to make a few configuration changes to achieve this. They are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Update the <code class="literal">lighttpd.conf</code> file (generally located at <code class="literal">/etc/lighttpd/</code>) to load additional modules.</li><li class="listitem">By default, loading modules is disabled. This can be enabled by uncommenting this line:<div class="informalexample"><pre class="programlisting">include "modules.conf"</pre></div></li><li class="listitem">Update <code class="literal">modules.conf</code> (located in the same directory as <code class="literal">lighttpd.conf</code>) to load the <code class="literal">mod_proxy</code> module.</li><li class="listitem">By default, only <code class="literal">mod_access</code> is enabled. Update <code class="literal">server.modules</code> to the following code:<div class="informalexample"><pre class="programlisting">server.modules = (
    "mod_access",
    "mod_proxy"
)</pre></div></li><li class="listitem">Now, enable loading the settings for <code class="literal">mod_proxy</code> by uncommenting this line:<div class="informalexample"><pre class="programlisting">include "conf.d/proxy.conf"</pre></div></li><li class="listitem">Update the <code class="literal">proxy.conf</code> file (generally located at <code class="literal">/etc/lighttpd/conf.d/</code>) with the server proxy configuration. The <code class="literal">q</code> module has only three settings:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">proxy.debug</code>: This setting enables/disables the log level</li><li class="listitem" style="list-style-type: disc"><code class="literal">proxy.balance</code>: This setting is a load balancing algorithm (round-robin, hash, and fair)</li><li class="listitem" style="list-style-type: disc"><code class="literal">proxy.server</code>: This setting is where requests are sent<p>The expected format of defining a <code class="literal">proxy.server</code> setting is as follows:</p><div class="informalexample"><pre class="programlisting">( &lt;extension&gt; =&gt;
    ( [ &lt;name&gt; =&gt; ]
    ( "host" =&gt; &lt;string&gt; ,
        "port" =&gt; &lt;integer&gt; ),
    ( "host" =&gt; &lt;string&gt; ,
        "port" =&gt; &lt;integer&gt; )
  ),
  &lt;extension&gt; =&gt; ...
)</pre></div></li></ul></div><p>The terms in this code are explained as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;extension&gt;</code>: This term is the file extension or prefix (if started with <code class="literal">"/"</code>); empty quotes, <code class="literal">""</code>, match all the requests</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;name&gt;</code>:This term is the optional name that shows up in the generated statistics of <code class="literal">mod_status</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">host</code>: This term is used to specify the IP address of the proxy server</li><li class="listitem" style="list-style-type: disc"><code class="literal">port</code>: This term is used to set the TCP port on its corresponding host (the default value is <code class="literal">80</code>)</li></ul></div></li><li class="listitem">Update the <a id="id458" class="indexterm"/>proxy settings as required:<div class="informalexample"><pre class="programlisting">server.modules += ( "mod_proxy" )
proxy.balance = "round-robin"
proxy.server = ( "" =&gt;
    ( "app" =&gt;
        (
            "host" =&gt; "127.0.0.1",
            "port" =&gt; 9000
        ),
        (
            "host" =&gt; "127.0.0.2",
            "port" =&gt; 9000
        ),
        (
            "host" =&gt; "127.0.0.3",
            "port" =&gt; 9000
       )
    )
)</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note48"/>Note</h3><p>This configuration <a id="id459" class="indexterm"/>has been tried on lighttpd/1.4.35 on March 12, 2014.</p><p>For more information on the <a id="id460" class="indexterm"/>configuration settings of <code class="literal">mod_proxy</code>, refer to <a class="ulink" href="http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs_ModProxy">http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs_ModProxy</a>.</p></div></div></li></ol></div></div><div class="section" title="High Availability Proxy"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec43"/>High Availability Proxy</h2></div></div></div><p>
<span class="strong"><strong>High Availability </strong></span><a id="id461" class="indexterm"/>
<span class="strong"><strong>Proxy</strong></span> (<span class="strong"><strong>HAProxy</strong></span>) offers high availability, load balancing, and proxying for TCP and HTTP-based applications. We can set HAProxy as a load balancer by updating the <code class="literal">haproxy.cfg</code> configuration file (it is generally located at <code class="literal">/etc/haproxy/</code>).</p><p>Let's make the required configuration changes step by step:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we need to define the backend cluster. The syntax for defining a backend is as follows:<div class="informalexample"><pre class="programlisting">backend &lt;name&gt;
balance    &lt;load balance method&gt;
server &lt;sname&gt; &lt;ip&gt;:&lt;port&gt;
server    &lt;sname&gt; &lt;ip&gt;:&lt;port&gt;</pre></div></li><li class="listitem">So, the backend for our application will be as follows:<div class="informalexample"><pre class="programlisting">backend app
    balance     roundrobin
    server  app1 127.0.0.1:9000
    server  app1 127.0.0.2:9000
    server  app1 127.0.0.3:9000</pre></div></li><li class="listitem">Now, we just need to point requests to the backend cluster. We can do this by updating the frontend section:<div class="informalexample"><pre class="programlisting">frontend  main *:80
default_backend             app</pre></div></li></ol></div><p>No additional configuration is required for an application using WebSockets.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note50"/>Note</h3><p>This configuration has been tried on HAProxy version 1.5.9 2014/11/25.</p></div></div></div></div>
<div class="section" title="Troubleshooting"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec80"/>Troubleshooting</h1></div></div></div><p>These are some corner <a id="id462" class="indexterm"/>cases you might encounter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We need to deploy our application on Tomcat. How can we package the application as WAR?<p>Although this is <a id="id463" class="indexterm"/>not supported by default in Play, we can use the <code class="literal">play2-war-plugin</code> module (refer to <a class="ulink" href="https://github.com/play2war/play2-war-plugin/">https://github.com/play2war/play2-war-plugin/</a>) to achieve this.</p></li><li class="listitem" style="list-style-type: disc">Is there a simpler way to deploy the application on PaaS?<p>Deploying Play applications on Heroku, Clever Cloud, Cloud Foundry and/or <a id="id464" class="indexterm"/>AppFog are documented at <a class="ulink" href="https://www.playframework.com/documentation/2.3.x/DeployingCloud">https://www.playframework.com/documentation/2.3.x/DeployingCloud</a>.</p></li></ul></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec81"/>Summary</h1></div></div></div><p>In this chapter, we saw how to deploy a Play application in production. While deploying it, we saw the different packaging options (such as <code class="literal">rpm</code>, <code class="literal">deb</code>, <code class="literal">zip</code>, <code class="literal">windows</code>, and so on) available by default. We also saw different configuration settings, such as the HTTP port, maximum size of the request header, and so on, which we can specify when starting the application in production. We also discussed how to send requests to the application using a reverse proxy.</p><p>In the next chapter, we will discuss how the Play plugins work, and how we can build custom Play plugins to meet different requirements.</p></div></body></html>