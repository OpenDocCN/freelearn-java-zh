<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer093">
<h1 class="chapter-number" id="_idParaDest-225"><a id="_idTextAnchor332"/>11</h1>
<h1 id="_idParaDest-226"><a id="_idTextAnchor333"/>Fine-Grained Access Control</h1>
<p>In this chapter, we will first examine two ways to implement fine-grained authorization—authorization that may affect portions of a page of the application. Next, we will look at Spring Security’s approach to securing the business tier through method annotation and the use of interface-based proxies to accomplish <strong class="bold">Aspect-Oriented</strong><strong class="bold"> Programming</strong> (<strong class="bold">AOP</strong>). Then, we will review an interesting capability of annotation-based security that allows for role-based filtering on collections of data. Lastly, we will look at how class-based proxies differ from <span class="No-Break">interface-based proxies.</span></p>
<p>During this chapter, we’ll cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Configuring and experimenting with different methods of performing in-page authorization checks on content, given the security context of a <span class="No-Break">user request</span></li>
<li>Performing configuration and code annotation to make caller preauthorization a key part of our application’s <span class="No-Break">business-tier security</span></li>
<li>Several alternative approaches to implement method-level security, and reviewing the pros and cons of <span class="No-Break">each type</span></li>
<li>Implementing data-based filters on collections and arrays using <span class="No-Break">method-level annotations</span></li>
<li>Implementing method-level security on our <strong class="source-inline">Spring MVC</strong> controllers to avoid configuring <strong class="source-inline">requestMatchers()</strong> methods and <strong class="source-inline">&lt;</strong><span class="No-Break"><strong class="source-inline">intercept-url&gt;</strong></span><span class="No-Break"> elements</span></li>
</ul>
<p>This chapter’s code in action link is <span class="No-Break">here: </span><a href="https://packt.link/Mxijd"><span class="No-Break">https://packt.link/Mxijd</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-227"><a id="_idTextAnchor334"/>Integrating Spring Expression Language (SpEL)</h1>
<p>Spring Security <a id="_idIndexMarker726"/>leverages <strong class="bold">Spring Expression Language</strong> (<strong class="bold">SpEL</strong>) integration in order to easily articulate various authorization requirements. If you recall, we have already looked at the use of SpEL in <a href="B21757_02.xhtml#_idTextAnchor043"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">Getting Started with Spring Security</em>, when we defined our <span class="No-Break"><strong class="source-inline">requestMatchers()</strong></span><span class="No-Break"> method:</span></p>
<pre class="source-code">
.requestMatchers("/events/").hasRole("ADMIN")</pre> <p>Spring Security provides an<strong class="source-inline"> o.s.s.access.expression.SecurityExpressionRoot</strong> object that provides the <a id="_idIndexMarker727"/>methods and objects available for use, in order to make an access control decision. For example, one of the methods available to use is <strong class="source-inline">hasRole</strong> method, which accepts a string. This corresponds to the value of the access attribute (in the preceding code snippet). In fact, there are a number of other expressions available, as shown in the <span class="No-Break">following table:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-6">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Expression</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">hasRole</strong></span><span class="No-Break">(</span><span class="No-Break"><strong class="source-inline">String role</strong></span><span class="No-Break">)</span></p>
<p><span class="No-Break"><strong class="source-inline">hasAuthority</strong></span><span class="No-Break">(</span><span class="No-Break"><strong class="source-inline">String role</strong></span><span class="No-Break">)</span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the current user has the <span class="No-Break">specified authority.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">hasAnyRole</strong>(<strong class="source-inline">String... role</strong>) <span class="No-Break"><strong class="source-inline">hasAnyAuthority</strong></span><span class="No-Break">(</span><span class="No-Break"><strong class="source-inline">String... authority</strong></span><span class="No-Break">)</span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the current user has any of the <span class="No-Break">specified authorities.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">authentication</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Obtains the current <strong class="source-inline">Authentication</strong> object from the <strong class="source-inline">SecurityContext</strong> interface returned by the <strong class="source-inline">getContext()</strong> method of the <span class="No-Break"><strong class="source-inline">SecurityContextHolder</strong></span><span class="No-Break"> class.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">permitAll</strong></span></p>
</td>
<td class="No-Table-Style">
<p>This request does not necessitate authorization and serves as a public endpoint. It’s essential to clarify that <strong class="source-inline">Authentication</strong> is never retrieved from the session in <span class="No-Break">this scenario.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">denyAll</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Under no circumstances is the request permitted; it’s important to emphasize that <strong class="source-inline">Authentication</strong> is never retrieved from the session in <span class="No-Break">this instance.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">isAnonymous()</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the current principal is anonymous (is <span class="No-Break">not authenticated).</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">isRememberMe()</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the current principal was authenticated using the <span class="No-Break">remember-me feature.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">isAuthenticated()</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the user is not an anonymous user (that is, they <span class="No-Break">are authenticated).</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">isFullyAuthenticated()</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the user is authenticated through a means other <span class="No-Break">than </span><span class="No-Break"><strong class="bold">remember-me</strong></span><span class="No-Break">.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">hasPermission</strong>(<strong class="source-inline">Object target</strong>, <span class="No-Break"><strong class="source-inline">Object permission</strong></span><span class="No-Break">)</span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the user has permission to access the specified object for the <span class="No-Break">given permission.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">hasPermission</strong>(<strong class="source-inline">String targetId</strong>, <strong class="source-inline">String targetType</strong>, <span class="No-Break"><strong class="source-inline">Object permission</strong></span><span class="No-Break">)</span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the user has permission to access the specified identifier for a given type <span class="No-Break">and permission.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 11.1 – Summary of the authorization rules</p>
<p>We have <a id="_idIndexMarker728"/>provided some examples of using these SpEL expressions in the following code snippet. Keep in mind that we will go into more detail throughout this and the <span class="No-Break">next chapter:</span></p>
<pre class="source-code">
// allow users with ROLE_ADMIN hasRole('ADMIN')
// allow users that do not have the ROLE_ADMIN
!hasRole('ADMIN')
// allow users that have ROLE_ADMIN or ROLE_ROOT and
// did not use the remember me feature to login
isFullyAuthenticated() and hasAnyRole('ADMIN','ROOT')
// allow if Authentication.getName() equals admin authentication.name == 'admin'</pre> <p>Go ahead and start up the JBCP calendar application. Visit <strong class="source-inline">https://localhost:8443</strong> and log in with the user <strong class="source-inline">user1@example.com</strong> and the password <strong class="source-inline">user1</strong>. You will observe that the <strong class="bold">My Events</strong> navigation menu item is displayed, and the <strong class="bold">All Events</strong> navigation menu item is displayed <span class="No-Break">as well.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.00-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-228"><a id="_idTextAnchor335"/>The WebSecurityExpressionRoot class</h2>
<p>The <strong class="source-inline">o.s.s.web.access.expression.WebSecurityExpressionRoot</strong> class makes a few <a id="_idIndexMarker729"/>additional properties available to us. These properties, along with the standard properties already mentioned, are made available in the access attribute of the <strong class="source-inline">requestMatchers()</strong> method and in the <strong class="source-inline">JSP/Thymeleaf access</strong> attribute of the <strong class="source-inline">&lt;sec:authorize&gt;</strong> tag, as we will <span class="No-Break">discuss shortly:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-4">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Expression</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">request</strong></span></p>
</td>
<td class="No-Table-Style">
<p>The current <span class="No-Break"><strong class="source-inline">HttpServletRequest</strong></span><span class="No-Break"> method.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">hasIpAddress</strong></span><span class="No-Break">(</span><span class="No-Break"><strong class="source-inline">String... ipAddress</strong></span><span class="No-Break">)</span></p>
</td>
<td class="No-Table-Style">
<p>Returns <strong class="source-inline">true</strong> if the current IP address matches the <strong class="source-inline">ipAddress</strong> value. This can be an exact IP address <a id="_idTextAnchor336"/>or the IP <span class="No-Break">address/network mask.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 11.2 – hasIpAddress usage with WebSecurityExpressionRoot</p>
<h2 id="_idParaDest-229"><a id="_idTextAnchor337"/>The MethodSecurityExpressionRoot class</h2>
<p>Method SpEL expressions<a id="_idIndexMarker730"/> also provide a few additional properties that can be used through the <span class="No-Break"><strong class="source-inline">o.s.s.access.expression.method.MethodSecurityExpressionRoot</strong></span><span class="No-Break"> class:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table003-2">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Expression</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">target</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Refers to this or the current object <span class="No-Break">being secured.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">returnObject</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Refers to the object returned by the <span class="No-Break">annotated method.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">filterObject</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Can be used on a collection or array in conjunction with <strong class="source-inline">@PreFilter</strong> or <strong class="source-inline">@PostFilter</strong>, to only include the elements that match the expression. The <strong class="source-inline">filterObject</strong> object represents the loop variable of the collection <span class="No-Break">or array.</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">#&lt;</strong><span class="No-Break"><strong class="source-inline">methodArg&gt;</strong></span></p>
</td>
<td class="No-Table-Style">
<p>Any argument to a method can be referenced by prefixing the argument name with <strong class="source-inline">#</strong>. For example, a method argument named <strong class="source-inline">id</strong> can be referred to <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">#id</strong></span><span class="No-Break">.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 11.3 – MethodSecurityExpressionRoot properties</p>
<p>If the description of these expressions appears a bit brief, don’t worry; we’ll work through a number of examples later in <span class="No-Break">this chapter.</span></p>
<p>We hope that you have a decent grasp of the power of Spring Security’s SpEL support. To learn more about <a id="_idIndexMarker731"/>SpEL, refer to the Spring reference documentation <span class="No-Break">at: </span><a href="https://docs.spring.io/spring-framework/reference/core/expressions.xhtml"><span class="No-Break">https://docs.spring.io/spring-framework/reference/core/expressions.xhtml</span></a><span class="No-Break">.</span><a id="_idTextAnchor338"/></p>
<h2 id="_idParaDest-230"><a id="_idTextAnchor339"/>Page-level authorization</h2>
<p><strong class="bold">Page-level authorization</strong> refers to<a id="_idIndexMarker732"/> the availability of application features based on the context of a particular user’s request. Unlike coarse-grained authorization that we explored in <a href="B21757_02.xhtml#_idTextAnchor043"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">Getting Started with Spring Security</em>, fine-grained authorization typically refers to the selective availability of the portions of a page, rather than restricting access to a page entirely. Most real-world applications will spend a considerable amount of time on the details of fine-grained <span class="No-Break">authorization planning.</span></p>
<p>Spring Security provides us with the following three methods of selective <span class="No-Break">display functionality:</span></p>
<ul>
<li><strong class="bold">Spring Security JSP</strong> tag libraries<a id="_idIndexMarker733"/> allow conditional access declarations to be placed within a page declaration itself, using the standard JSP tag <span class="No-Break">library syntax.</span></li>
<li><strong class="bold">Thymeleaf Spring Security</strong> tag libraries<a id="_idIndexMarker734"/> allow conditional access declarations to be placed within a page declaration itself, using the standard Thymeleaf tag <span class="No-Break">library syntax.</span></li>
<li>Checking user authorization in an MVC application’s controller layer allows the controller to make an access decision and bind the results of the decision to the model data provided to the view. This approach relies on standard JSTL conditional page rendering and data binding and is slightly more complicated than Spring Security tag libraries; however, it is more in line with the standard web application <a id="_idIndexMarker735"/>MVC <span class="No-Break">logical design.</span></li>
</ul>
<p>Any of these approaches are perfectly valid when developing fine-grained authorization models for a web application. Let’s explore how each approach is implemented throu<a id="_idTextAnchor340"/>gh a JBCP calendar <span class="No-Break">use case.</span></p>
<h1 id="_idParaDest-231"><a id="_idTextAnchor341"/>Conditional rendering with the Thymeleaf Spring Security tag library</h1>
<p>The<a id="_idIndexMarker736"/> most common<a id="_idIndexMarker737"/> functionality used in the Thymeleaf Spring Security tag library is to conditionally render portions of the page based on authorization rules. This is done with the <strong class="source-inline">&lt;sec:authorize*&gt;</strong> tag that functions similarly to the <strong class="source-inline">&lt;if&gt;</strong> tag in the core JSTL library, in that the tag’s body will render depending on the conditions provided in the tag attributes. We have already seen a very brief demonstration of how the Spring Securi<a id="_idTextAnchor342"/>ty tag library can be used to restrict the viewing of content if the user is not <span class="No-Break">logg<a id="_idTextAnchor343"/>ed in.</span></p>
<h2 id="_idParaDest-232"><a id="_idTextAnchor344"/>Conditional rendering based on URL access rules</h2>
<p>The <a id="_idIndexMarker738"/>Spring Security tag library provides functionality to render content based on the existing URL authorization rules that are already defined in the security configuration file. This is done via the use of the <span class="No-Break"><strong class="source-inline">authorizeHttpRequests()</strong></span><span class="No-Break"> method.</span></p>
<p>If there are multiple HTTP elements, the <strong class="source-inline">authorizeHttpRequests()</strong> method uses the currently matched HTTP <span class="No-Break">element’s rules.</span></p>
<p>For example, we could ensure that the <strong class="source-inline">All</strong> <strong class="source-inline">Events</strong> navigation menu item is displayed only when appropriate, that is, for users who are administrators—recall that the access rules we’ve previously defined are <span class="No-Break">as follows:</span></p>
<pre class="source-code">
.requestMatchers("/events/").hasRole("ADMIN")</pre> <p>Update the <strong class="source-inline">header.xhtml</strong> file to utilize this information and conditionally render the link to the <strong class="source-inline">All </strong><span class="No-Break"><strong class="source-inline">Events</strong></span><span class="No-Break"> page:</span></p>
<pre class="source-code">
//src/main/resources/templates/fragments/header.xhtml
&lt;!DOCTYPE html&gt;
&lt;html 
      &gt;
...
&lt;li sec:authorize-url="/events/"&gt;
    &lt;a id="navEventsLink" th:href="@{/events/}"&gt;All Events&lt;/a&gt;&lt;/li&gt;</pre> <p>This will ensure that the content of the tag is not displayed unless the user has sufficient privileges to access the stated URL. It is possible to further qualify the authorization check using the <strong class="source-inline">HTTP</strong> method, by including the method attribute before the URL, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
&lt;li sec:authorize-url="/events/"&gt;
    &lt;a id="navEventsLink" th:href="@{/events/}"&gt;All Events&lt;/a&gt;&lt;/li&gt;</pre> <p>Using the <strong class="source-inline">authorize-url</strong> attribute to define authorization checks on blocks of code is convenient because it abstracts the knowledge of the actual authorization checks from your pages and keeps it in your security <span class="No-Break">configuration file.</span></p>
<p>Be aware that the <strong class="source-inline">HTTP</strong> method should match the case specified in your security <strong class="source-inline">requestMatchers()</strong> method, otherwise they may not match as you expect. Also, note that the URL should always be relative to the web application context root (as your URL access <span class="No-Break">rules are).</span></p>
<p>For many <a id="_idIndexMarker739"/>purposes, the use of the <strong class="source-inline">&lt;sec&gt;</strong> tag’s <strong class="source-inline">authorize-url</strong> attribute will suffice to correctly display link- or action-related content only when the user is allowed to see it. Remember that the tag need not only surround a link; it could even surround a whole form if the user doesn’t have permission to <span class="No-Break">submit it.</span></p>
<h2 id="_idParaDest-233"><a id="_idTextAnchor345"/>Conditional rendering using SpEL</h2>
<p>An <a id="_idIndexMarker740"/>additional, more flexible method of controlling the display of <a id="_idIndexMarker741"/>JSP content is available when the <strong class="source-inline">&lt;sec&gt;</strong> tag is used in conjunction with a SpEL expression. Let’s review what we learned in <a href="B21757_02.xhtml#_idTextAnchor043"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">Getting Started with Spring Security</em>. We could hide the <strong class="source-inline">My Events</strong> link from any unauthenticated users by changing our <strong class="source-inline">header.xhtml</strong> file, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/resources/templates/fragments/header.xhtml
&lt;li sec:authorize="isAuthenticated()"&gt;
    &lt;a id="navMyEventsLink" th:href="@{/events/my}"&gt;My Events&lt;/a&gt;&lt;/li&gt;</pre> <p>The SpEL evaluation is performed by the same code behind the scenes as the expressions utilized in the <strong class="source-inline">requestMatchers()</strong> method access declaration rules (assuming the expressions have been configured). Hence, the same set of built-in functions and properties are accessible from the expressions built using the <strong class="source-inline">&lt;</strong><span class="No-Break"><strong class="source-inline">sec&gt;</strong></span><span class="No-Break"> tag.</span></p>
<p>Both of these methods of utilizing the <strong class="source-inline">&lt;sec&gt;</strong> tag provide powerful, fine-grained control over the display of page content based on security <span class="No-Break">authorization rules.</span></p>
<p>Go ahead and<a id="_idIndexMarker742"/> start up the JBCP calendar application. Visit <strong class="source-inline">https://localhost:8443</strong> and log in with the user <strong class="source-inline">user1@example.com</strong> and <a id="_idIndexMarker743"/>the password <strong class="source-inline">user1</strong>. You will observe that the <strong class="bold">My Events</strong> link is displayed, but the <strong class="bold">All Events</strong> navigation menu item is hidden (although it will still be present on the page). Log out and log in as the user <strong class="source-inline">admin1@example.com</strong> with the password <strong class="source-inline">admin1</strong>. Now both links <span class="No-Break">are visible.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.01-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor346"/>Using controller logic to conditionally render content</h2>
<p>In this section, we<a id="_idIndexMarker744"/> will demonstrate how we can use Java-based code to determine if we should render some content. We can choose to only show the <strong class="bold">Create Event</strong> link on the <strong class="bold">Welcome</strong> page to users who have a username that contains <strong class="source-inline">user</strong>. This will hide the <strong class="bold">Create Event</strong> link on the <strong class="bold">Welcome</strong> page from users who are not logged in <span class="No-Break">as administrators.</span></p>
<p>The welcome controller from the sample code for this chapter has been updated to populate the model with an attribute named <strong class="source-inline">showCreateLink</strong>, derived from the method name, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/web/controllers/WelcomeControll er.java
@ModelAttribute("showCreateLink")
public boolean showCreateLink(Authentication authentication) {
    // NOTE We could also get the Authentication from SecurityContextHolder.getContext().getAuthentication()
    return authentication != null &amp;&amp; authentication.getName().contains("user");
}</pre> <p>You may notice<a id="_idIndexMarker745"/> that Spring MVC can automatically obtain the <strong class="source-inline">Authentication</strong> object for us. This is because Spring Security maps our current <strong class="source-inline">Authentication</strong> object to the <strong class="source-inline">HttpServletRequest.getPrincipal()</strong> method. Since Spring MVC will automatically resolve any object of the <strong class="source-inline">java.security.Principal</strong> type to the value of <strong class="source-inline">HttpServletRequest.getPrincipal()</strong>, specifying <strong class="source-inline">Authentication</strong> as an argument to our controller is an easy way to access the current <strong class="source-inline">Authentication</strong> object. We could also decouple the code from Spring Security by specifying an argument of the <strong class="source-inline">Principal</strong> type instead. However, we chose <strong class="source-inline">Authentication</strong> in this scenario to help demonstrate how <span class="No-Break">everything connects.</span></p>
<p>If we were working in another framework that did not know how to do this, we could obtain the <strong class="source-inline">Authentication</strong> object using the <strong class="source-inline">SecurityContextHolder</strong> class, as we did in <a href="B21757_03.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Custom Authentication</em>. Also note that if we were not using Spring MVC, we could just set the <strong class="source-inline">HttpServletRequest</strong> attribute directly rather than populating it on the model. The attribute that we populated on the request would then be available to our JSP, just as it is when using a <strong class="source-inline">ModelAndView</strong> object with <span class="No-Break">Spring MVC.</span></p>
<p>Next, we will need to use the <strong class="source-inline">HttpServletRequest</strong> attribute in our <strong class="source-inline">index.xhtml</strong> file to determine if we should display the <strong class="source-inline">Create Event</strong> link. Update <strong class="source-inline">index.xhtml</strong>, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/resources/templates/fragments/header.xhtml
&lt;li th:if="${showCreateLink}" class="nav-item"&gt;&lt;a class="nav-link" id="navCreateEventLink"
                        th:href="@{/events/form}"&gt;Create Event&lt;/a&gt;</pre> <p>Now, start the <a id="_idIndexMarker746"/>application, log in using <strong class="source-inline">admin1@example.com</strong> as the username and <strong class="source-inline">admin1</strong> as the password, and visit the <strong class="bold">All Events</strong> page. You should no longer see the <strong class="bold">Create Events</strong> navigation menu item (although it will still be present on <span class="No-Break">the page).</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.02-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-235"><a id="_idTextAnchor347"/>The WebInvocationPrivilegeEvaluator class</h2>
<p>There may be<a id="_idIndexMarker747"/> times when an application will not be written using JSPs and will need to be able to determine access based upon a URL, as we did with <strong class="source-inline">&lt;... sec:authorize- url="/events/"&gt;</strong>. This can be done by using the <strong class="source-inline">o.s.s.web.access.WebInvocationPrivilegeEvaluator</strong> interface, which is the same interface that backs the JSP <span class="No-Break">tag library.</span></p>
<p>In the following code snippet, we demonstrate the use of <strong class="source-inline">WebInvocationPrivilegeEvaluator</strong> by populating our model with an attribute named <strong class="source-inline">showAdminLink</strong>. We are able to obtain <strong class="source-inline">WebInvocationPrivilegeEvaluator</strong> using the <strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">Autowired</strong></span><span class="No-Break"> annotation:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/web/controllers/WelcomeControll er.java
&lt;li th:if="${showAdminLink}" class="nav-item"&gt;&lt;a class="nav-link" id="navH2Link"
                        target="_blank"
                        th:href="@{/admin/h2}"&gt;H2&lt;/a&gt;&lt;/li&gt;</pre> <p>If the framework you are using is not being managed by Spring, <strong class="source-inline">@Autowire</strong> will not be able to provide you with <strong class="source-inline">WebInvocationPrivilegeEvaluator</strong>. Instead, you can use Spring’s <strong class="source-inline">org.springframework.web.context.WebApplicationContextUtils</strong> interface to obtain an instance of <strong class="source-inline">WebInvocationPrivilegeEvaluator</strong>, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
ApplicationContext context = WebApplicationContextUtils
       .getRequiredWebApplicationContext(servletContext);
WebInvocationPrivilegeEvaluator privEvaluator = context.getBean(WebInvocationPrivilegeEvaluator.class);</pre> <p>To try it out, go ahead and update <strong class="source-inline">index.xhtml</strong> to use the <strong class="source-inline">showAdminLink</strong> request attribute, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/resources/templates/index.xhtml
&lt;li th:if="${showAdminLink}"&gt;
    &lt;a class="link-warning" id="h2Link" target="_blank" th:href="@{admin/h2/}"&gt;H2
...
&lt;/li&gt;</pre> <p>Restart the <a id="_idIndexMarker748"/>application and view the <strong class="bold">Welcome</strong> page before you have logged in. The <strong class="bold">H2</strong> link should not be visible. Log in as <strong class="source-inline">admin1@example.com</strong>/<strong class="source-inline">admin1</strong>, and you should <span class="No-Break">see it.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.03-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-236"><a id="_idTextAnchor348"/>What is the best way to configure in-page authorization?</h2>
<p>In many <a id="_idIndexMarker749"/>cases, the use of the <strong class="source-inline">authorize-url</strong> attribute of the tag can appropriately isolate the code from changes in authorization rules. You should use the <strong class="source-inline">authorize-url</strong> attribute of the tag in the <span class="No-Break">following scenarios:</span></p>
<ul>
<li>The tag is preventing display functionality that can be clearly identified by a <span class="No-Break">single URL</span></li>
<li>The contents of the tag can be unambiguously isolated to a <span class="No-Break">single URL</span><p class="list-inset">Unfortunately, in a typical application, the likelihood that you will be able to use the <strong class="source-inline">authorize-url</strong> attribute of the tag frequently is somewhat low. The reality is that applications are usually much more complex than this and require more involved logic when deciding to render portions of <span class="No-Break">a page.</span></p></li>
</ul>
<p>It’s tempting to use the Thymeleaf Spring Security tag library to declare bits of rendered pages as off-limits based on security criteria in other methods. However, there are a number of reasons why (in many cases) this isn’t a great idea, <span class="No-Break">as follows:</span></p>
<ul>
<li>Complex<a id="_idIndexMarker750"/> conditions beyond role membership are not supported by the tag library. For example, if our application incorporated customized attributes on the <strong class="source-inline">UserDetails</strong> implementation, IP filters, geolocation, and so on, none of these would be supported by the standard <strong class="source-inline">&lt;</strong><span class="No-Break"><strong class="source-inline">sec&gt;</strong></span><span class="No-Break"> tag.</span></li>
<li>These could, however, conceivably be supported by the custom tags or using SpEL expressions. Even in this case, the page is more likely to be directly tied to business logic rather than what is <span class="No-Break">ty<a id="_idTextAnchor349"/>pically encouraged.</span></li>
<li>The <strong class="source-inline">&lt;sec&gt;</strong> tag must be referenced on every page that it’s used in. This leads to potential inconsistencies between the rulesets that are intended to be common, but may be spread across different physical pages. A good object-oriented system design would suggest that conditional rule evaluations be located in only one place, and logically referred to from where they should <span class="No-Break">be applied.</span></li>
<li>It is possible (and we illustrate this using our common header page) to encapsulate and reuse portions of pages to reduce the occurrence of this type of problem, but it is virtually impossible to eliminate in a <span class="No-Break">complex application.</span></li>
<li>There is no way to validate the correctness of rules stated at compile time. Whereas compile-time constants can be used in typical Java-based, object- oriented systems, the tag library requires (in typical use) hardcoded role names where a simple typo might go undetected for <span class="No-Break">some time.</span></li>
<li>To be fair, such typos could be caught easily by comprehensive functional tests on the running application, but they are far easier to test using a standard Java component unit <span class="No-Break">testing techniques.</span></li>
<li>We can see <a id="_idIndexMarker751"/>that, although the <em class="italic">template-based approach</em> for conditional content rendering is convenient, there are some <span class="No-Break">significant downsides.</span></li>
</ul>
<p>All of these issues can be solved by the use of code in controllers that can be used to push data into the application view model. Additionally, performing advanced authorization determinations in code allows for the benefits of reuse, compile-tim<a id="_idTextAnchor350"/>e checks, and proper logical separation of the model, view, <span class="No-Break">and controller.</span></p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor351"/>Method-level security</h2>
<p>Our primary focus up to this point in the book has been on securing the web-facing portion of the JBCP calendar application; however, in real-world planning of secured systems, equal attention<a id="_idIndexMarker752"/> should be paid to securing the service methods that allow users access to the most critical part of any <span class="No-Break">system—its data.</span></p>
<h3>Why we secure in layers?</h3>
<p>Let’s take a <a id="_idIndexMarker753"/>minute to see why it is important to secure our methods, even though we have already secured <span class="No-Break">our URLs.</span></p>
<ol>
<li>Start the JBCP calendar application up. Log in using <strong class="source-inline">user1@example.com</strong> as the username and <strong class="source-inline">user1</strong> as <span class="No-Break">the password.</span></li>
<li>Visit the <strong class="bold">All Events</strong> page <strong class="source-inline">https://localhost:8443/events/</strong>. You will see the custom <strong class="bold">Access </strong><span class="No-Break"><strong class="bold">Denied</strong></span><span class="No-Break"> page.</span></li>
<li>Now, add <strong class="source-inline">backdoor</strong> to the end of the URL in the browser so that the URL is now <strong class="source-inline">https://localhost:8443/events/backdoor</strong>. You will now see a response with the same data as the <strong class="bold">All Events</strong> page. This data should only be visible to an administrator, but we have bypassed it by finding a URL that was not <span class="No-Break">configured properly.</span></li>
<li>We can also view the details of an event that we do not own and are not invited to. Change <strong class="source-inline">backdoor</strong> with <strong class="source-inline">102</strong> so that the URL is now <strong class="source-inline">https://localhost:8443/events/102</strong>: You will now see an <strong class="bold">Vacation Event</strong> that is not listed on your <strong class="bold">My Events</strong> page. This should not be visible to us because we are not an administrator, and this is not <span class="No-Break">our event.</span></li>
</ol>
<p>As you can see, our URL rules are not quite strong enough to entirely secure our application. These exploits do not even need to take advantage of more complex problems, such as differences in how containers handle URL normalization. In short, there are often ways to bypass URL-based security. Let’s see how adding a security<a id="_idTextAnchor352"/> layer to our business tier can help with our new <span class="No-Break">s<a id="_idTextAnchor353"/>ecurity vulnerability.</span></p>
<h3>Securing the business tier</h3>
<p>Spring <a id="_idIndexMarker754"/>Security has the ability to add a layer of authorization (or authorization-based data pruning) to the invocation of any Spring-managed bean in your application. While many developers focus on web-tier security, business-tier security is arguably just as important, as a malicious user may be able to penetrate the security of your web tier or access services exposed through a non-UI frontend, such as a <span class="No-Break">web service.</span></p>
<p>Let’s examine the following logical diagram to see why we’re interested in applying a secondary layer <span class="No-Break">of security:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer092">
<img alt="Figure 11.1 – Logical application Layers" height="677" src="image/B21757_11_1.jpg" width="1114"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.1 – Logical application Layers</p>
<p>Spring Security has the following two main techniques for <span class="No-Break">securing methods:</span></p>
<ul>
<li><strong class="bold">Preauthorization</strong>: This<a id="_idIndexMarker755"/> technique ensures that<a id="_idIndexMarker756"/> certain constraints are satisfied prior to the execution of a method that is being allowed, for example, if a user has a particular <strong class="source-inline">GrantedAuthority</strong>, such as <strong class="source-inline">ROLE_ADMIN</strong>. Failure to satisfy the declared constraints means that the method call <span class="No-Break">will fail.</span></li>
<li><strong class="bold">Postauthorization</strong>: This technique<a id="_idIndexMarker757"/> ensures that the calling principal still satisfies <a id="_idIndexMarker758"/>declared constraints after the method returns. This is rarely used but can provide an extra layer of security around some complex, interconnected business <span class="No-Break">tier methods.</span></li>
</ul>
<p>The <a id="_idIndexMarker759"/>preauthorization and postauthorization techniques provide formalized support for what are generally called preconditions and postconditions in a classic, object-oriented design. Preconditions and postconditions allow a developer to declare through runtime checks that certain constraints around a method’s execution must always hold true. In the case of security preauthorization and postauthorization, the business tier developer makes a conscious decision about the security profile of particular methods by encoding expected runtime conditions as part of an interface or class API declaration. As you may imagine, this requires a great deal of forethought to avoid <span class="No-Break">unintended consequences!</span></p>
<h3>Adding the @PreAuthorize method annotation</h3>
<p>Our first design decision will be to<a id="_idIndexMarker760"/> augment method security at the business tier by ensuring that a user must be logged in as an <strong class="source-inline">ADMIN</strong> user before he/she is allowed to access the <strong class="source-inline">getEvents()</strong> method. This is done with a simple annotation added to the method in the service interface definition, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
import org.springframework.security.access.prepost.PreAuthorize;
...
public interface CalendarService {
...
    @PreAuthorize("hasRole('ADMIN')")
    List&lt;Event&gt; getEvents();
}</pre> <p>This is all that is<a id="_idIndexMarker761"/> required to ensure that anyone invoking our <strong class="source-inline">getEvents()</strong> method is an administrator. Spring Security will use a runtime AOP pointcut to <a id="_idIndexMarker762"/>execute <strong class="source-inline">BeforeAdvice</strong> on the method, and throw <strong class="source-inline">o.s.s.access.AccessDeniedException</strong> if the se<a id="_idTextAnchor354"/><a id="_idTextAnchor355"/>curity constraints <span class="No-Break">aren’t met.</span></p>
<h3>Instructing Spring Security to use method annotations</h3>
<p>We’ll also <a id="_idIndexMarker763"/>need to make a one-time change to <strong class="source-inline">SecurityConfig.java</strong>, where we’ve got the rest of our Spring Security configuration. Simply add the following annotation to the <span class="No-Break">class declaration:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/con<a id="_idTextAnchor356"/><a id="_idTextAnchor357"/>figuration/SecurityC onfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {</pre> <p>In the next section, let’s test the method <span class="No-Break">security validation.</span></p>
<h3>Validating method security</h3>
<p>Don’t <a id="_idIndexMarker764"/>believe it was that easy? Log in with <strong class="source-inline">user1@example.com</strong> as the username and <strong class="source-inline">user1</strong> as the password, and try accessing <strong class="source-inline">https://localhost:8443/events/backdoor</strong>. You should see the <strong class="bold">Access Denied</strong> <span class="No-Break">page now.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.04-calendar</strong></span><span class="No-Break">.</span></p>
<p>If you look at the <em class="italic">Tomcat console</em>, you’ll see a very long stack trace, starting with the <span class="No-Break">following output:</span></p>
<pre class="source-code">
org.springframework.security.access.AccessDeniedException: Access Denied
 at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization
 at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke
 at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed
 at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed
 at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept
 at com.packtpub.springsecurity.service.DefaultCalendarService$$SpringCGLIB$$0.getEvents
 at com.packtpub.springsecurity.web.controllers.EventsController.events</pre> <p>Based on the <strong class="bold">Access Denied</strong> page, and the stack trace clearly pointing to the <strong class="source-inline">getEvents</strong> method invocation, we can see that the user was appropriately denied access to the business method because it lacked the <strong class="source-inline">GrantedAuthority</strong> of <strong class="source-inline">ROLE_ADMIN</strong>. If you run the same with the username <strong class="source-inline">admin1@example.com</strong> and the password <strong class="source-inline">admin1</strong>, you <a id="_idIndexMarker765"/>will discover that access will <span class="No-Break">be granted.</span></p>
<p>Isn’t it amazing that with a simple declaration in our interfa<a id="_idTextAnchor358"/>ce, we’re able to ensure that the method in question is secure? But how does <span class="No-Break">AOP work?</span></p>
<h2 id="_idParaDest-238"><a id="_idTextAnchor359"/>Interface-based proxies</h2>
<p>In the given example from the previous <a id="_idIndexMarker766"/>section, Spring Security used an interface-based proxy to secure our <strong class="source-inline">getEvents</strong> method. Let’s take a look at the simplified pseudocode of what happened to understand how <span class="No-Break">this works:</span></p>
<pre class="source-code">
DefaultCalendarService originalService = context.getBean (CalendarService.class)
CalendarService secureService = new CalendarService() {
//… other methods just delegate to originalService ...
    public List&lt;Event&gt; getEvents() {
       if(!permitted(originalService.getEvents)) {
          throw AccessDeniedException()
       }
       return originalCalendarService.getEvents()
    }
};</pre> <p>You can see that Spring creates the original <strong class="source-inline">CalendarService</strong> just as it normally does. However, it instructs our code to use another implementation of <strong class="source-inline">CalendarService</strong> that performs a security check before returning the result of the original method. The secure implementation can be created with no prior knowledge of our interface because Spring uses Java’s <strong class="source-inline">java.lang.reflect.Proxy</strong> APIs to dynamically create new implementations of <span class="No-Break">the interface.</span></p>
<p>Note that the object returned is no longer an instance of <strong class="source-inline">DefaultCalendarService</strong>, since it is a new implementation of <strong class="source-inline">CalendarService</strong>, that is, it is an anonymous implementation of <strong class="source-inline">CalendarService</strong>. This means that we must program against an interface in order to use the secure implementation, otherwise, a <strong class="source-inline">ClassCastException</strong> exception <span class="No-Break">will occur.</span></p>
<p>To learn more about<a id="_idIndexMarker767"/> Spring AOP, refer to the Spring reference documentation <span class="No-Break">at </span><a href="https://docs.spring.io/spring-framework/reference/core/aop/proxying.xhtml#aop-understanding-aop-proxies"><span class="No-Break">https://docs.spring.io/spring-framework/reference/core/aop/proxying.xhtml#aop-understanding-aop-proxies</span></a><span class="No-Break">.</span></p>
<p>In addition to the <strong class="source-inline">@PreAuthorize</strong> annotation, there are several other ways of declaring security preauthorization requirements on methods. <a id="_idTextAnchor360"/>We can examine these different ways of securing methods and then evaluate their pros and cons in <span class="No-Break">different circumstances.</span></p>
<h1 id="_idParaDest-239"><a id="_idTextAnchor361"/>JSR-250 compliant standardized rules</h1>
<p><strong class="bold">JSR-250 Common Annotations</strong> for <a id="_idIndexMarker768"/>the Java platform defines a series of annotations, some that are security-related, which are intended to be portable across JSR-250 compliant runtime environments. The Spring Framework became compliant with JSR-250 as part of the Spring 2.x release, including the Spring <span class="No-Break">Security</span><span class="No-Break"><a id="_idIndexMarker769"/></span><span class="No-Break"> framework.</span></p>
<h2 id="_idParaDest-240"><a id="_idTextAnchor362"/>Gradle dependencies</h2>
<p>There are several optional <a id="_idIndexMarker770"/>dependencies that may be required, depending on what features you decide to use for example to enable the support of JSR 250 <strong class="source-inline">@RolesAllowed</strong> annotation. Many of these dependencies are commented as Spring Boot includes them already in the <span class="No-Break">starter parent.</span></p>
<p>You will find that our <strong class="source-inline">build.gradle</strong> file already includes the above <span class="No-Break">dependency (transitively):</span></p>
<pre class="source-code">
//build.gradle
// Required for JSR-250 based security:
// JSR-250 Annotations
implementation 'jakarta.annotation:jakarta.annotation-api:2.1.1'</pre> <p>While JSR-250 annotations are not as expressive as Spring native annotations, they have the benefit that the declarations they provide are compatible across implementing Jakarta EE application servers. Depending on your application’s needs and requirements for portability, you may decide that the trade-off of reduced specificity is worth the portability of <span class="No-Break">the code.</span></p>
<p>To implement the<a id="_idIndexMarker771"/> rule we specified in the first example, we make a few changes by performing the <span class="No-Break">following steps:</span></p>
<ol>
<li>First, we need to update our <strong class="source-inline">SecurityConfig</strong> file to use the <span class="No-Break">JSR-250 annotations:</span><pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/ SecurityConfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(jsr250Enabled = true)
public class SecurityConfig {</pre></li> <li>Lastly, the <strong class="source-inline">@PreAuthorize</strong> annotation needs to change to the <strong class="source-inline">@RolesAllowed</strong> annotation. As we might anticipate, the <strong class="source-inline">@RolesAllowed</strong> annotation does not support SpEL expressions, so we edit <strong class="source-inline">CalendarService</strong> <span class="No-Break">as follows:</span><pre class="source-code">
@RolesAllowed("ADMIN")
List&lt;Event&gt; getEvents();</pre></li> <li>Restart the application, log in as <strong class="source-inline">user1@example.com</strong>/<strong class="source-inline">user1</strong>, and try to access <strong class="source-inline">https://localhost:8443/events/backdoor</strong>. You should see <strong class="bold">the Access Denied</strong> <span class="No-Break">page again.</span></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.05-calendar</strong></span><span class="No-Break">.</span></p>
<p>Note that it’s also possible to provide a list of allowed <strong class="source-inline">GrantedAuthority</strong> names using the standard Java 5 String array <span class="No-Break">annotation syntax:</span></p>
<pre class="source-code">
@RolesAllowed({"ADMIN", "USER"})
List&lt;Event&gt; getEvents();</pre> <p>There are also two<a id="_idIndexMarker772"/> additional annotations specified by JSR-250, namely <strong class="source-inline">@PermitAll</strong> and <strong class="source-inline">@DenyAll</strong>, which function as you might expect, permitting and denying all requests to the method <span class="No-Break">in question.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Be aware that method-level security annotations can be applied at the class level as well! Method-level annotations, if supplied, will always override annotations specified at the class level. This can be helpful if your business needs to dictate the specification of security policies for an <span class="No-Break">entire class.</span></p>
<p class="callout">Take care to use this functionality in conjunction with good comments and coding standards, so that deve<a id="_idTextAnchor363"/>lopers are very clear about the security characteristics of the class and <span class="No-Break">its methods.</span></p>
<h2 id="_idParaDest-241"><a id="_idTextAnchor364"/>Method security using Spring’s @Secured annotation</h2>
<p>Spring itself<a id="_idIndexMarker773"/> provides a simpler annotation style that is similar to the JSR-250 <strong class="source-inline">@RolesAllowed</strong> annotation. The <strong class="source-inline">@Secured</strong> annotation is functionally and syntactically the same as <strong class="source-inline">@RolesAllowed</strong>. The only notable differences are that it does not require the external dependency, cannot be processed by other frameworks, and the processing of these annotations must be explicitly enabled with another attribute on the <strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">EnableMethodSecurity</strong></span><span class="No-Break"> annotation:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(jsr250Enabled = true)
public class SecurityConfig {}</pre> <p>As <strong class="source-inline">@Secured</strong> functions in the same way as the JSR standard <strong class="source-inline">@RolesAllowed</strong> annotation, there’s no<a id="_idIndexMarker774"/> real compelling reason to use it in new code, but you may run across it in older <span class="No-Break">Spring code.</span></p>
<h2 id="_idParaDest-242"><a id="_idTextAnchor365"/>Method security rules incorporating method parameters</h2>
<p>Logically, writing rules<a id="_idIndexMarker775"/> that refer to method parameters in their constraints seem sensible for certain types of operations. For example, it might make sense for us to restrict the <strong class="source-inline">findForUser(int userId)</strong> method to meet the <span class="No-Break">following constraints:</span></p>
<ul>
<li>The <strong class="source-inline">userId</strong> argument must be equal to the current <span class="No-Break">user’s ID</span></li>
<li>The user must be an administrator (in this case, it is valid for the user to see <span class="No-Break">any event)</span></li>
</ul>
<p>While it’s easy to see how we could alter the rule to restrict the method invocation only to administrators, it’s not clear how we would determine if the user were attempting to change their <span class="No-Break">own password.</span></p>
<p>Fortunately, SpEL binding, used by the Spring Security method annotations, supports more sophisticated expressions, including expressions that incorporate method parameters. You will also want to ensure that you have enabled pre- and post-annotations in the <strong class="source-inline">SecurityConfig</strong> file, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig { }
//Lastly, we can update our CalendarService interface as follows:
@PreAuthorize("hasRole('ROLE_ADMIN') or principal.id == #userId")
List&lt;Event&gt; findForUser(int userId);</pre> <p>You can see here that we’ve augmented the SpEL directive we used in the first exercise with a check against the ID of the principal and against the <strong class="source-inline">userId</strong> method parameter <strong class="source-inline">(#userId</strong>, the method parameter name, is prefixed with a <strong class="source-inline">#</strong> symbol). The fact that this powerful feature of method parameter binding is available should get your creative juices flowing and<a id="_idIndexMarker776"/> allow you to secure method invocations with a very p<a id="_idTextAnchor366"/>recise set of <span class="No-Break">logical rules.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Our principal is currently an instance of <strong class="source-inline">CalendarUser</strong> due to the custom authentication setup from <a href="B21757_03.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Custom Authentication</em>. This means that the principal has all of the properties that our <strong class="source-inline">CalendarUser</strong> application has on it. If we had not done this customization, only the properties of the <strong class="source-inline">UserDetails</strong> object would <span class="No-Break">be available.</span></p>
<p>SpEL variables are referenced with the hash (<strong class="source-inline">#</strong>) prefix. One important note is that in order for method argument names to be available at runtime, debugging symbol table information must be retained after compilation. Common methods to retain the debugging symbol table information are listed <span class="No-Break">as follows:</span></p>
<ol>
<li>If you are using the <strong class="source-inline">javac</strong> compiler, you will need to include the <strong class="source-inline">-g</strong> flag when building <span class="No-Break">your classes.</span></li>
<li>When using the <strong class="source-inline">&lt;javac&gt;</strong> task in Ant, add the <span class="No-Break">attribute </span><span class="No-Break"><strong class="source-inline">debug="true"</strong></span><span class="No-Break">.</span></li>
<li>In Gradle, ensure to add <strong class="source-inline">--debug</strong> when running the main method, or the <span class="No-Break"><strong class="source-inline">bootRun</strong></span><span class="No-Break"> task.</span></li>
<li>In Maven, ensure the <strong class="source-inline">maven.compiler.debug=true</strong> property (the default <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">true</strong></span><span class="No-Break">).</span></li>
<li>Consult your compiler, <strong class="bold">build tool</strong>, or IDE documentation for assistance on configuring this same setting in <span class="No-Break">your environment.</span></li>
<li>Start up your application and try logging in with <strong class="source-inline">user1@example.com</strong> as the username and <strong class="source-inline">user1</strong> as <span class="No-Break">the password.</span></li>
<li>On the <strong class="bold">Welcome</strong> page, request the <strong class="bold">My Events</strong>. (email=<strong class="source-inline">admin1@example.com</strong>) link to see an <strong class="bold">Access </strong><span class="No-Break"><strong class="bold">Denied</strong></span><span class="No-Break"> page.</span></li>
<li>Try again with <strong class="bold">My Events</strong> (<strong class="source-inline">email=user1@example.com</strong>) to see <span class="No-Break">it work.</span></li>
</ol>
<p>Note that the <a id="_idIndexMarker777"/>displayed user on the <strong class="bold">My Events</strong> page matches the currently logged-in user. Now, try the same steps and log in as <strong class="source-inline">admin1@example.com</strong>/<strong class="source-inline">admin1</strong>. You will be able to see both pages since you are logged in as a user with the <span class="No-Break"><strong class="source-inline">ROLE_ADMIN</strong></span><span class="No-Break"> permission.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.06-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-243"><a id="_idTextAnchor367"/>Method security rules incorporating returned values</h2>
<p>Just as we were<a id="_idIndexMarker778"/> able to leverage the parameters to the method, we can also leverage the returned value of the method call. Let’s update the <strong class="source-inline">getEvent</strong> method to meet the following constraints on the <span class="No-Break">returned value:</span></p>
<ul>
<li>The attendee’s ID must be the current <span class="No-Break">user’s ID</span></li>
<li>The owner’s ID must be the current <span class="No-Break">user’s ID</span></li>
<li>The user must be an administrator (in this case, it is valid for the user to see <span class="No-Break">any event)</span></li>
</ul>
<p>Add the following code to the <span class="No-Break"><strong class="source-inline">CalendarService</strong></span><span class="No-Break"> interface:</span></p>
<pre class="source-code">
@PostAuthorize("hasRole('ROLE_ADMIN') or " +
       "principal.id == returnObject.owner.id or " +
       "principal.id == returnObject.attendee.id")
Event getEvent(int eventId);</pre> <p>Now, try logging in with the username <strong class="source-inline">user1@example.com</strong> and the password <strong class="source-inline">user1</strong>. Next, try accessing the <strong class="bold">Vacation Event</strong> using the link on the <strong class="bold">Welcome</strong> page. You should now see the <strong class="bold">Access </strong><span class="No-Break"><strong class="bold">Denied</strong></span><span class="No-Break"> page.</span></p>
<p>If you log in using the <a id="_idIndexMarker779"/>username <strong class="source-inline">user2@example.com</strong> and the password <strong class="source-inline">user2</strong>, the <strong class="bold">Vacation Event</strong> will display as expected since <strong class="source-inline">user2@example.com</strong> is the attendee at the <span class="No-Break"><strong class="bold">Vacation Event</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.07-calendar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-244"><a id="_idTextAnchor368"/>Securing method data using role-based filtering</h2>
<p>The two final <a id="_idIndexMarker780"/>Spring Security-dependent annotations are <strong class="source-inline">@PreFilter</strong> and <strong class="source-inline">@PostFilter</strong>, which are used to apply security-based filtering rules to collections or arrays (with <strong class="source-inline">@PostFilter</strong> only). This type of functionality is referred to as security trimming or security pruning and involves using the security credentials of principal at runtime to selectively remove members from a set of objects. As you might expect, this filtering is performed using SpEL expression notation within the <span class="No-Break">annotation declaration.</span></p>
<p>We’ll work through an example with JBCP calendar, as we want to filter the <strong class="source-inline">getEvents</strong> method to only return the events that this user is allowed to see. In order to do this, we remove any existing security annotations and add the <strong class="source-inline">@PostFilter</strong> annotation to our <strong class="source-inline">CalendarService</strong> interface, <span class="No-Break">as follows:</span></p>
<pre class="source-code">
@PostAuthorize("hasRole('ROLE_ADMIN') or " +
       "principal.id == returnObject.owner.id or " +
       "principal.id == returnObject.attendee.id")
Event getEvent(int eventId);</pre> <p class="callout-heading">Important note</p>
<p class="callout">You should start with the code <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">chapter11.08-calendar</strong></span><span class="No-Break">.</span></p>
<p>Remove the <strong class="source-inline">requestMatchers()</strong> method, restricting access to <strong class="source-inline">/events/ URL</strong> so that we can test our annotation. Start up the application and view the <strong class="bold">All Events</strong> page when logged in with the username <strong class="source-inline">user1@example.com</strong> and password <strong class="source-inline">user1</strong>. You will observe that only the events that are associated with our user <span class="No-Break">are displayed.</span></p>
<p>With <strong class="source-inline">filterObject</strong> acting as the loop variable that refers to the current event, Spring Security will iterate over the <strong class="source-inline">List&lt;Event&gt;</strong> returned by our service and modify it to only contain the <strong class="source-inline">Event</strong> objects that match our <span class="No-Break">SpEL expression.</span></p>
<p>In general, the <strong class="source-inline">@PostFilter</strong> method behaves in the following way. For brevity, we refer to the collection as the method return value, but be aware that <strong class="source-inline">@PostFilter</strong> works with either collection or array method <span class="No-Break">return types.</span></p>
<p>The <strong class="source-inline">filterObject</strong> object is rebound to the SpEL context for each element in the collection. This means that if your method is returning a collection with 100 elements, the SpEL expression will be evaluated <span class="No-Break">for each.</span></p>
<p>The SpEL expression must return a Boolean value. If the expression evaluates to true, the object will remain in the collection, while if the expression evaluates to false, the object will <span class="No-Break">be removed.</span></p>
<p>In most cases, you’ll<a id="_idIndexMarker781"/> find that collection post filtering saves you from the complexity of writing boilerplate code that you would likely be writing anyway. Take care that you understand how <strong class="source-inline">@PostFilter</strong> works conceptually; unlike <strong class="source-inline">@PreAuthorize</strong>, <strong class="source-inline">@PostFilter</strong> specifies method behavior and not a precondition. Some object-oriented purists may argue that <strong class="source-inline">@PostFilter</strong> isn’t appropriate for inclusion as a method annotation, and such filtering should instead be handled through code in a <span class="No-Break">method implementation.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Be aware that the actual collection returned from your method will be modified! In some cases, this isn’t desirable behavior, so you should ensure that your method returns a collection that can be safely modified. This is especially important if the returned collection is an ORM-bound one, as post-filter modifications could inadvertently be persisted to the ORM <span class="No-Break">data store!</span></p>
<p>Spring Security also offers functionality to <a id="_idTextAnchor369"/>prefilter method parameters that are collections; let’s try implementing <span class="No-Break">that now.</span></p>
<h2 id="_idParaDest-245"><a id="_idTextAnchor370"/>Prefiltering collections with @PreFilter</h2>
<p>The <strong class="source-inline">@PreFilter</strong> annotation <a id="_idIndexMarker782"/>can be applied to a method to filter collection elements that are passed into a method based on the current security context. Functionally, once it has a reference to a collection, this annotation behaves exactly the same as the <strong class="source-inline">@PostFilter</strong> annotation, with a couple of exceptions, <span class="No-Break">as follows:</span></p>
<ul>
<li>The <strong class="source-inline">@PreFilter</strong> annotation supports only collection arguments and does not support <span class="No-Break">array arguments.</span></li>
<li>The <strong class="source-inline">@PreFilter</strong> annotation takes an additional, optional <strong class="source-inline">filterTarget</strong> attribute which is used to specifically identify the method parameter and filter it when the annotated method has more than <span class="No-Break">one argument.</span></li>
<li>As with <strong class="source-inline">@PostFilter</strong>, keep in mind that the original collection passed to the method is permanently modified. This may not be desirable behavior, so ensure that callers know that the collection’s security may be trimmed after the method <span class="No-Break">is invoked!</span></li>
</ul>
<p>Imagine if we had a <strong class="source-inline">save</strong> method that accepted a collection of event objects, and we wanted to only allow the saving of events that were owned by the currently logged-in user. We could do this <span class="No-Break">as follows:</span></p>
<pre class="source-code">
@PreFilter("principal.id == filterObject.owner.id")
void save(Set&lt;Event&gt; events);</pre> <p>Much like our <strong class="source-inline">@PostFilter</strong> method, this annotation causes Spring Security to iterate over each event with the loop variable <strong class="source-inline">filterObject</strong>. It then compares the current user’s ID against the event owner’s ID. If they match, the event is retained. If they do not match, the result <span class="No-Break">is discarded.</span></p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor371"/>Comparing method authorization types</h2>
<p>The <a id="_idIndexMarker783"/>following quick reference chart may assist you in selecting a type of method authorization check <span class="No-Break">to use:</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table004-1">
<colgroup>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">Method </strong><span class="No-Break"><strong class="bold">authorization type</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">Specified as</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold">JSR standard</strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold" lang="en-US" xml:lang="en-US">Allows </strong><span class="No-Break"><strong class="bold" lang="en-US" xml:lang="en-US">SpEL expressions</strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">PreAuthorize</strong></span><span class="No-Break">, </span><span class="No-Break"><strong class="source-inline">@PostAuthorize</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Annotation</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Yes</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">@RolesAllowed</strong>, <strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">PermitAll</strong></span><span class="No-Break">, </span><span class="No-Break"><strong class="source-inline">@DenyAll</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Annotation</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Yes</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">Secure</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">Annotation</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline">protect-pointcut</strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">XML</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No</span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break">No</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 11.4 – Method authorization types</p>
<p>Most Java consumers of Spring Security will probably opt to use the JSR-250 annotations for maximum compatibility and reuse their business classes (and relevant constraints) across an IT organization. Where needed, these basic declarations can be replaced with the annotations that tie the code to the Spring Security <span class="No-Break">implementation itself.</span></p>
<p>If you are using Spring Security in an environment that doesn’t support annotations, unfortunately, your choices are somewhat limited to method security enforcement. Even in this situation, the use of AOP provides a reasonably rich environment <a id="_idTextAnchor372"/>in which we can develop basic <span class="No-Break">security declarations.</span></p>
<h2 id="_idParaDest-247"><a id="_idTextAnchor373"/>Practical considerations for annotation-based security</h2>
<p>One<a id="_idIndexMarker784"/> thing to consider is that when returning a collection of real-world applications, there is likely to be some sort of paging. This means that our <strong class="source-inline">@PreFilter</strong> and <strong class="source-inline">@PostFilter</strong> annotations cannot be used as the sole means of selecting which objects to return. Instead, we need to ensure that our queries only select the data that the user is allowed <span class="No-Break">to access.</span></p>
<p>This <a id="_idIndexMarker785"/>means that the security annotations become redundant checks. However, it is important to remember our lesson at the beginning of this chapter; we want to secure layers in case one layer is able to <span class="No-Break">be bypassed.</span></p>
<h1 id="_idParaDest-248"><a id="_idTextAnchor374"/>Summary</h1>
<p>In this chapter, we have covered most of the remaining areas in standard Spring Security implementations that deal with authorization. We’ve learned enough to take a thorough pass through the JBCP calendar application and verify that proper authorization checks are in place in all tiers of the application, to ensure that malicious users cannot manipulate or access data to which they do not <span class="No-Break">have access.</span></p>
<p>We developed two techniques for micro-authorization, namely filtering out in-page content based on authorization or other security criteria using the Thymeleaf Spring Security tag library and Spring MVC controller data binding. We also explored several methods of securing business functions and data in the business tier of our application and supporting a rich, declarative security model that was tightly integrated with the code. We also learned how to secure our Spring MVC controllers and the differences between interface and class <span class="No-Break">proxy objects.</span></p>
<p>At this point, we’ve wrapped up coverage of much of the important Spring Security functionality that you’re likely to encounter in most standard, secure web application <span class="No-Break">development scenarios.</span></p>
<p>In the next chapter, we will discuss the ACL (domain object model) module of Spring Security. This will allow us to explicitly declare authorization, rather than relying on <span class="No-Break">existing data.</span></p>
</div>
</div></body></html>