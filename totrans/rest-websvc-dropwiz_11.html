<html><head></head><body><div class="appendix" title="Appendix&#xA0;A.&#xA0;Testing a Dropwizard Application"><div class="titlepage"><div><div><h1 class="title"><a id="appA"/>Appendix A. Testing a Dropwizard Application</h1></div></div></div><p>Our application is ready. However, if we respect its stability, we have to make sure that we at least have its most important aspects covered by unit tests. You are probably familiar with unit testing and JUnit, but Dropwizard takes this a little bit further.</p><p>The <code class="literal">dropwizard-testing</code> module includes everything you need, such as JUnit and FEST assertions, in order to create tests for your application, right from small unit tests to bigger, full-fledged tests.</p><div class="section" title="Creating a complete test for the application"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec29"/>Creating a complete test for the application</h1></div></div></div><p>Let's <a id="id255" class="indexterm"/>create a complete, fully automated integration<a id="id256" class="indexterm"/> test for our application. This test should start our application as we would normally do for a manual test, and perform some HTTP requests to the application's services which check how the application is responding.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec69"/>Getting ready</h2></div></div></div><p>When we first created our project using Maven in <a class="link" href="ch02.html" title="Chapter 2. Creating a Dropwizard Application">Chapter 2</a>, <span class="emphasis"><em>Creating a Dropwizard Application</em></span>, a JUnit dependency had been automatically added in our <code class="literal">pom.xml</code> file. We will replace it with Dropwizard's testing module, so let's remove it. Locate and delete the following dependency from the <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
&lt;groupId&gt;junit&lt;/groupId&gt;
&lt;artifactId&gt;junit&lt;/artifactId&gt;
&lt;version&gt;3.8.1&lt;/version&gt;
&lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre></div><p>We <a id="id257" class="indexterm"/>will need <a id="id258" class="indexterm"/>the <code class="literal">dropwizard-testing</code> and <code class="literal">hamcrest-all</code> modules, so include them both in your <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;dependency&gt;&lt;groupId&gt;io.dropwizard&lt;/groupId&gt;&lt;artifactId&gt;dropwizard-testing&lt;/artifactId&gt;&lt;version&gt;0.7.0-SNAPSHOT&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt;&lt;groupId&gt;org.hamcrest&lt;/groupId&gt;&lt;artifactId&gt;hamcrest-all&lt;/artifactId&gt;&lt;version&gt;1.3&lt;/version&gt;&lt;/dependency&gt;</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec70"/>How to do it…</h2></div></div></div><p>Your project already has a test folder. During the generation of the default artifact, Maven created both <code class="literal">src/main/java</code> (where our application's source code lies) and <code class="literal">src/test/java</code> as a placeholder for our unit tests. Let's see what we need to place there in order to build our tests:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new test class, <code class="literal">ApplicationTest</code>, within the <code class="literal">src/test/java/com/dwbook/phonebook</code> folder, extending the <code class="literal">ResourceTest</code> base class. This class needs to have two methods; <code class="literal">#setUp()</code>, in which we will prepare our mocked objects and add the required resources and providers to the memory inJersey server, and <code class="literal">#createAndRetrieveContact()</code>, where we will perform the actual test:<div class="informalexample"><pre class="programlisting">package com.dwbook.phonebook;

import static org.fest.assertions.api.Assertions.assertThat;

import javax.ws.rs.core.MediaType;

import org.junit.Before;
import org.junit.ClassRule;
import org.junit.Test;
import com.dwbook.phonebook.representations.Contact;
import com.sun.jersey.api.client.Client;
import com.sun.jersey.api.client.ClientResponse;
import com.sun.jersey.api.client.WebResource;
import com.sun.jersey.api.client.filter.HTTPBasicAuthFilter;

import io.dropwizard.testing.junit.DropwizardAppRule;

public class ApplicationTest {
  
  private Client client;
  
  private Contact contactForTest = new Contact(0, "Jane", "Doe", "+987654321");
  
    @ClassRule
    public static final DropwizardAppRule&lt;PhonebookConfiguration&gt; RULE =
            new DropwizardAppRule&lt;PhonebookConfiguration&gt;(App.class, "config.yaml");
    
    @Before
    public void setUp() {
      client = new Client();
        // Set the credentials to be used by the client
        client.addFilter(new HTTPBasicAuthFilter("wsuser", "wsp1"));
    }
    
    @Test
    public void createAndRetrieveContact() {
      // Create a new contact by performing the appropriate http request (POST)
        WebResource contactResource = client.resource("http://localhost:8080/contact");
    ClientResponse response = contactResource
      .type(MediaType.APPLICATION_JSON)
      .post(ClientResponse.class, contactForTest);
    // Check that the response has the appropriate response code (201)
        assertThat(response.getStatus()).isEqualTo(201);
        
        // Retrieve the newly created contact
        String newContactURL = response.getHeaders().get("Location").get(0);
        WebResource newContactResource = client.resource(newContactURL);
        Contact contact = newContactResource.get(Contact.class);
        // Check that it has the same properties as the initial one
        assertThat(contact.getFirstName()).isEqualTo(contactForTest.getFirstName());
        assertThat(contact.getLastName()).isEqualTo(contactForTest.getLastName());
        assertThat(contact.getPhone()).isEqualTo(contactForTest.getPhone());
    }
}</pre></div></li><li class="listitem">Our<a id="id259" class="indexterm"/> tests will run every time we<a id="id260" class="indexterm"/> issue the <code class="literal">mvn</code> package command, but they can also be executed on demand with the <code class="literal">test</code> command of <code class="literal">mvn</code>. For now, let's <a id="id261" class="indexterm"/>run the test on a clean application environment by issuing the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mvn clean test</strong></span>
</pre></div><p>You will see that Maven will clean our target directory, start the application, and then run our tests successfully.</p><div class="mediaobject"><img src="graphics/9530OS_App.A_01.jpg" alt="How to do it…"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec71"/>How it works…</h2></div></div></div><p>Firstly, we defined our test data; that is, a <code class="literal">Contact</code> instance that we intend to create.</p><p>We initialized a <code class="literal">DropwizardAppRule&lt;PhonebookConfiguration&gt;</code> instance, which is described as a JUnit rule for starting and stopping your application at the start and end of a test class, allowing the test framework to start the application as you would normally do in order to perform a manual test. For this, we need to specify not only the main class of our application, but also the configuration file to be used.</p><p>Within <a id="id262" class="indexterm"/>the <code class="literal">#setUp()</code> method, we instantiated a REST client to help us with the HTTP requests to our application and also applied the necessary HTTP basic authentication filter since our web services require authentication.</p><p>The <code class="literal">#createAndRetrieveContact()</code> method<a id="id263" class="indexterm"/> wraps<a id="id264" class="indexterm"/> the actual test. Using the REST client, we <a id="id265" class="indexterm"/>are performing an HTTP POST request in order to create a new contact. After such a request, we expect an HTTP response with the <code class="literal">code 201 – Created</code> response. We test whether the response code is the one we expected with the <code class="literal">assertThat()</code> and <code class="literal">isEqual()</code> helper methods, which are provided by the <span class="strong"><strong>Fixtures for Easy Software Testing</strong></span> (<span class="strong"><strong>FEST</strong></span>) libraries. As stated on the home page of the FEST project<a id="id266" class="indexterm"/> (<a class="ulink" href="http://code.google.com/ p/fest/">http://code.google.com/p/fest/</a>):</p><div class="blockquote"><blockquote class="blockquote"><p>"FEST<a id="id267" class="indexterm"/> is a collection of libraries, released under the Apache 2.0 license, whose mission is to simplify software testing. It is composed of various modules, which can be used with TestNG or JUnit."</p></blockquote></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec72"/>There's more…</h2></div></div></div><p>We just showcased the use of the Dropwizard testing module in order to perform an integration test by booting an actual server that is connected to an actual database. This module is not limited to integration testing though. It is backed by JUnit, and you are able to use it for smaller (but critical) to larger unit tests and also for testing the correct serialization/deserialization of entities.</p></div></div></div>
<div class="section" title="Adding health checks"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec30"/>Adding health checks</h1></div></div></div><p>A health check<a id="id268" class="indexterm"/> is a runtime test for our application. We are going to create a health check that tests the creation of new contacts using the Jersey client.</p><p>The health check results are accessible through the admin port of our application, which by default is 8081.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec73"/>How to do it…</h2></div></div></div><p>To add a health check perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new package called <code class="literal">com.dwbook.phonebook.health</code> and a class named <code class="literal">NewContactHealthCheck</code> in it:<div class="informalexample"><pre class="programlisting">import javax.ws.rs.core.MediaType;
import com.codahale.metrics.health.HealthCheck;
import com.dwbook.phonebook.representations.Contact;
import com.sun.jersey.api.client.*;

    public class NewContactHealthCheck extends HealthCheck {
      private final Client client;

      public NewContactHealthCheck(Client client) {
      super();
      this.client = client;
    }

    @Override
    protected Result check() throws Exception {
      WebResource contactResource = client
        .resource("http://localhost:8080/contact");
      ClientResponse response = contactResource.type(
        MediaType.APPLICATION_JSON).post(
          ClientResponse.class,
          new Contact(0, "Health Check First Name",
            "Health Check Last Name", "00000000"));
            if (response.getStatus() == 201) {
              return Result.healthy();
            } else {
              return Result.unhealthy("New Contact cannot be created!");
      }
    }
  }</pre></div></li><li class="listitem">Register<a id="id269" class="indexterm"/> the health check with the Dropwizard environment by using the <code class="literal">HealthCheckRegistry#register()</code> method within<a id="id270" class="indexterm"/> the <code class="literal">#run()</code> method of <a id="id271" class="indexterm"/>the <code class="literal">App</code> class. You will first need to import <code class="literal">com.dwbook.phonebook.health.NewContactHealthCheck</code>. The <code class="literal">HealthCheckRegistry</code> can be accessed <a id="id272" class="indexterm"/>using the <code class="literal">Environment#healthChecks()</code> method:<div class="informalexample"><pre class="programlisting">  // Add health checks
  e.healthChecks().register("New Contact health check", new NewContactHealthCheck(client));</pre></div></li><li class="listitem">After building and starting your application, navigate with your browser to <code class="literal">http://localhost:8081/healthcheck</code>:</li></ol></div><div class="mediaobject"><img src="graphics/9530OS_App.A_02.jpg" alt="How to do it…"/></div><p>The <a id="id273" class="indexterm"/>results of the defined health checks are presented in the JSON format. In case the custom health check we just created or any other health check fails, it will be flagged as <code class="literal">"healthy": false</code>, letting you know that your application faces runtime problems.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec74"/>How it works…</h2></div></div></div><p>We used exactly the same code used by our <code class="literal">client</code> class in order to create a health check; that is, a runtime test that confirms that the new contacts can be created by performing HTTP POST requests to the appropriate endpoint of the <code class="literal">ContactResource</code> class. This health check gives us the required confidence that our web service is functional.</p><p>All we need for the creation of a health check is a class that extends <code class="literal">HealthCheck</code> and implements <a id="id274" class="indexterm"/>the <code class="literal">#check()</code> method. In the class's constructor, we call the parent class's constructor specifying the name of our check—the one that will be used to identify our health check.</p><p>In the <code class="literal">#check()</code> method, we literally implement a check. We check that everything is as it should be. If so, we return <code class="literal">Result.healthy()</code>, else we return <code class="literal">Result.unhealthy()</code>, indicating that something is going wrong.</p></div></div></body></html>