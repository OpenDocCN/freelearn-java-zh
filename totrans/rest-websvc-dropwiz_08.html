<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;The Web Service Client"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. The Web Service Client</h1></div></div></div><p>We have our service ready and functional, but we need an interface to actually use it. Of course, by using a web browser, we are able to perform HTTP GET requests, but not more complex requests such as POST. We need to create an HTTP Client for that.</p><p>Also, in many cases, you may need to have your web services call other web services and then perform additional processing before returning information to the caller.</p><div class="section" title="Building a client for our application"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec24"/>Building a client for our application</h1></div></div></div><p>Dropwizard<a id="id192" class="indexterm"/> includes both Jersey and Apache HTTP <a id="id193" class="indexterm"/>clients. We will use the Jersey client to create a client for our web service.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec50"/>Getting ready</h2></div></div></div><p>Add the <code class="literal">dropwizard-client</code> module to the dependencies section of your <code class="literal">pom.xml</code> in order to add web service client support to our project:</p><div class="informalexample"><pre class="programlisting">&lt;dependency&gt;&lt;groupId&gt;io.dropwizard&lt;/groupId&gt;&lt;artifactId&gt;dropwizard-client&lt;/artifactId&gt;&lt;version&gt;0.7.0-SNAPSHOT&lt;/version&gt;&lt;/dependency&gt;</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec51"/>How to do it…</h2></div></div></div><p>We will create a new resource class that will listen for and accept HTTP GET requests from our web browser and then call the appropriate method of the <code class="literal">Contact</code> resource and render the response in a human-friendly format. Let's have a look at the steps required in order to achieve this:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">ClientResource</code> class in the <code class="literal">com.dwbook.phonebook.resources</code> package. Similar to the <code class="literal">ContactResource</code> class, we should first import the required <code class="literal">javax.ws.rs</code> annotations, the representation classes we are going to use, as well as the required Jersey client classes as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">  package com.dwbook.phonebook.resources;

  import javax.ws.rs.*;
  import javax.ws.rs.core.*;
  import com.dwbook.phonebook.representations.Contact;
  import com.sun.jersey.api.client.*;

  public class ClientResource { }</pre></div></li><li class="listitem">Set the <a id="id194" class="indexterm"/>context path of the client resource<a id="id195" class="indexterm"/> class to <code class="literal">/client/</code> to logically separate the URIs of client and service by adding the appropriate annotation to the newly created class:<div class="informalexample"><pre class="programlisting">  @Path("/client/") 
  public class ClientResource { }</pre></div></li><li class="listitem">Since our client is going to be used by humans, we need a human-friendly response type such as <code class="literal">text/plain</code>, so we will use <code class="literal">MediaType.TEXT_PLAIN</code>. Define it by adding the <code class="literal">@Produces</code> annotation to our <a id="id196" class="indexterm"/>class.<div class="informalexample"><pre class="programlisting">  @Produces(MediaType.TEXT_PLAIN)
  @Path("/client/")
  public class ClientResource { }</pre></div></li><li class="listitem">In order to perform calls to other web services (in this case, our service, the <code class="literal">ContactResource</code> class), we need to have a <code class="literal">Client</code> instance as a member of our resource class. This will be provided during initialization, so we need to have an appropriate constructor.<div class="informalexample"><pre class="programlisting">private Client client;
  public ClientResource(Client client) {
    this.client = client;
  }</pre></div></li><li class="listitem">Instantiate the client in our application's entry class, and also add the new resource to the <a id="id197" class="indexterm"/>environment by adding a couple of lines of code to the <code class="literal">App#run()</code> method. Of course, we first need to import <code class="literal">com.sun.jersey.api.client.Client</code>, <code class="literal">io.dropwizard.client.JerseyClientBuilder</code>, and the <code class="literal">com.dwbook.phonebook.resources.ClientResource</code> class we've just created.<div class="informalexample"><pre class="programlisting">  // build the client and add the resource to the environment
  final Client client = new JerseyClientBuilder(e).build("REST Client");
  e.jersey().register(new ClientResource(client));</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec52"/>How it works…</h2></div></div></div><p>We now have the client resource ready. This resource has a Jersey <code class="literal">Client</code> object as a member, which<a id="id198" class="indexterm"/> we can use to perform HTTP requests<a id="id199" class="indexterm"/> on specific URLs by building <code class="literal">WebResource </code>objects (using the <code class="literal">Client#resource()</code> method) and interacting with them.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec53"/>There's more…</h2></div></div></div><p>Most of the time, and generally in large-scale applications, the client is decoupled from the backend services, forming a separate application. Backend services usually perform more intensive and complex tasks, and it is generally a good practice to treat and scale them independently from the client.</p></div></div></div>
<div class="section" title="Interacting with our services"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec25"/>Interacting with our services</h1></div></div></div><p>We will <a id="id200" class="indexterm"/>proceed by adding the necessary methods to the <code class="literal">ClientResource</code> class, bound to the GET requests so they can be easily triggered with a browser. We need to add methods for creating, updating, deleting, and retrieving contacts, which we will trigger by performing appropriate HTTP requests.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec54"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add <a id="id201" class="indexterm"/>the <code class="literal">#showContact()</code> method to the <code class="literal">ClientResource</code> class, binding<a id="id202" class="indexterm"/> the query <code class="literal">String</code> parameter <code class="literal">id</code> as<a id="id203" class="indexterm"/> the input using the <code class="literal">@QueryParam</code> annotation.<div class="informalexample"><pre class="programlisting">  @GET
  @Path("showContact")
  public String showContact(@QueryParam("id") int id) {
    WebResource contactResource = client.resource("http://localhost:8080/contact/"+id);
    Contact c = contactResource.get(Contact.class);
    String output = "ID: "+ id 
        +"\nFirst name: " + c.getFirstName() 
        + "\nLast name: " + c.getLastName() 
        + "\nPhone: " + c.getPhone();
    return output;
  }</pre></div></li><li class="listitem">Create the <code class="literal">#newContact()</code> method. This method is going to accept the properties<a id="id204" class="indexterm"/> of a <code class="literal">Contact</code> object as parameters and will<a id="id205" class="indexterm"/> create a new contact by performing the appropriate HTTP request to the <code class="literal">ContactResource</code> service.<div class="informalexample"><pre class="programlisting">  @GET
  @Path("newContact")
  public Response newContact(@QueryParam("firstName") String firstName, @QueryParam("lastName") String lastName, @QueryParam("phone") String phone) {
    WebResource contactResource = client.resource("http://localhost:8080/contact");
    ClientResponse response = contactResource.type(MediaType.APPLICATION_JSON).post(ClientResponse.class, new Contact(0, firstName, lastName, phone));
    if (response.getStatus() == 201) {
      // Created
      return Response.status(302).entity("The contact was created successfully! The new contact can be found at " + response.getHeaders().getFirst("Location")).build();
    }
    else {
      // Other Status code, indicates an error
      return Response.status(422).entity(response.getEntity(String.class)).build();
    }
  }</pre></div></li><li class="listitem">The <code class="literal">#updateContact()</code> method<a id="id206" class="indexterm"/> for updating contacts will be quite similar to the previous one.<div class="informalexample"><pre class="programlisting">@GET
  @Path("updateContact")
  public Response updateContact(@QueryParam("id") int id, @QueryParam("firstName") String firstName, @QueryParam("lastName") String lastName, @QueryParam("phone") String phone) {
    WebResource contactResource = client.resource("http://localhost:8080/contact/" + id);
    ClientResponse response = contactResource.type(MediaType.APPLICATION_JSON).put(ClientResponse.class, new Contact(id, firstName, lastName, phone));
    if (response.getStatus() == 200) {
      // Created
      return Response.status(302).entity("The contact was updated successfully!").build();
    }
    else {
      // Other Status code, indicates an error
      return Response.status(422).entity(response.getEntity(String.class)).build();
    }
  }</pre></div></li><li class="listitem">In a similar way, let's add the method for deleting contacts, <code class="literal">#deleteContact()</code>.<div class="informalexample"><pre class="programlisting">@GET
  @Path("deleteContact")
  public Response deleteContact(@QueryParam("id") int id) {
    WebResource contactResource = client.resource("http://localhost:8080/contact/"+id);
    contactResource.delete();
    return Response.noContent().entity("Contact was deleted!").build();
  }</pre></div></li><li class="listitem">Now you <a id="id207" class="indexterm"/>may build and run the application in order to see what we've done up to this point.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec55"/>How it works…</h2></div></div></div><p>Point your browser at <code class="literal">http://localhost:8080/client/showContact?id=1</code>. The client will perform an HTTP GET request to <code class="literal">http://localhost:8080/contact/1</code>, parse the JSON representation of the contact, and produce a plain text summary of it.</p><div class="mediaobject"><img src="graphics/9530OS_08_01.jpg" alt="How it works…"/></div><p>In order to perform an HTTP request, we must first create a <code class="literal">WebResource</code> instance (since RESTful Web Services are all about resources and HTTP verbs) using the <code class="literal">#resource(String)</code> method<a id="id208" class="indexterm"/> of our client. Think of <code class="literal">WebResource</code> as a proxy for a specific web service endpoint.</p><p>The <code class="literal">#get()</code> method<a id="id209" class="indexterm"/> of the <code class="literal">WebResource</code> class takes the class that we will use to parse and map the response as a parameter, which will also be its return type.</p><p>For the<a id="id210" class="indexterm"/> HTTP POST request though, we use the generic HTTP response class, <code class="literal">ClientResponse</code>, which we can use to extract the status code of the response using<a id="id211" class="indexterm"/> the <code class="literal">#getStatus()</code> method. Also, we can extract its<a id="id212" class="indexterm"/> headers using the <code class="literal">#getHeaders()</code> method.</p><p>Note that for POST and PUT requests, we are also setting up the media type of the request data (<code class="literal">WebResource#type()</code>).</p><p>If you point your web browser at <code class="literal">http://localhost:8080/client/newContact?firstName=Jane&amp;lastName=Doe&amp;phone=98765432</code>, our client will post that data to <code class="literal">ClientResource</code>, which will create a new contact and return its location back to the client. The client will then show us the new contact's URL as seen in the following screenshot:</p><div class="mediaobject"><img src="graphics/9530OS_08_02.jpg" alt="How it works…"/></div><p>Similarly, we can update a contact using the client by requesting the appropriate URL. The URL <code class="literal">http://localhost:8080/client/updateContact?id=1&amp;firstName=Alex&amp;lastName=Updated&amp;phone=3210465</code> will trigger a PUT request to the contact service, which will eventually update the contact with <code class="literal">id</code> equal to 1.</p><p>As you may already be guessing, the URL <code class="literal">http://localhost:8080/client/deleteContact?id=1</code> will send the relevant HTTP DELETE request to contact service, deleting the contact identified by the given <code class="literal">id</code>.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec56"/>There's more…</h2></div></div></div><p>Note that in the case of validation errors during the creation of a new contact, these errors are communicated to the client. Our client checks the status code of the POST request, and if it is not equal to <code class="literal">201</code> (which indicates that the entity has been created), then it parses the response as a string and presents it to the user.</p><p>For <a id="id213" class="indexterm"/>example, navigate to <code class="literal">http://localhost:8080/client/newContact?firstName=J&amp;lastName=D&amp;phone=9</code>. Since we have set constraints indicating that the length of <code class="literal">firstName</code>, <code class="literal">lastName</code>, and <code class="literal">phone</code> shall be greater than 2, we will get validation errors as you can see in the following screenshot:</p><div class="mediaobject"><img src="graphics/9530OS_08_03.jpg" alt="There's more…"/></div></div></div></body></html>