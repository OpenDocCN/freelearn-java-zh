<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;9.&#xA0;Managing the Application Server"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09" class="calibre1"/>Chapter 9. Managing the Application Server</h1></div></div></div><p class="calibre8">So far, we have covered many Java Enterprise examples and deployed them on the application server. We will now dive headlong into the vast and varied ocean of instruments that are available to manage the application server. The purpose of this chapter is to teach you how to use these instruments to administer and monitor all the resources available on the application server.</p><p class="calibre8">Here is the list of topics we will cover in this chapter:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An<a id="id921" class="calibre1"/> introduction to the WildFly <span class="strong"><strong class="calibre9">Command-line Interface</strong></span> (<span class="strong"><strong class="calibre9">CLI</strong></span>)</li><li class="listitem">How to create scripts with the CLI</li><li class="listitem">How to programmatically manage your server resources using scripting languages and WildFly's client API</li><li class="listitem">How to enforce role-based security for administrators</li></ul></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Managing the Application Server">
<div class="book" title="Entering the WildFly CLI"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch09lvl1sec43" class="calibre1"/>Entering the WildFly CLI</h1></div></div></div><p class="calibre8">A CLI is <a id="id922" class="calibre1"/>a complete management tool that can be used to start and stop servers, deploy and undeploy applications, configure system resources, and perform other administrative tasks. Operations in it can be executed in an atomic way or in batch modes, allowing you to run multiple tasks as a group.</p></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Managing the Application Server">
<div class="book" title="Entering the WildFly CLI">
<div class="book" title="Launching the CLI"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec62" class="calibre1"/>Launching the CLI</h2></div></div></div><p class="calibre8">If you <a id="id923" class="calibre1"/>are using Windows, you can start the CLI by entering the following command from the <code class="email">JBOSS_HOME/bin</code> folder using the Command Prompt:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">jboss-cli.bat</strong></span>
</pre></div><p class="calibre8">Alternatively, enter the following command if you are using Linux:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">./jboss-cli.sh</strong></span>
</pre></div><p class="calibre8">Once the CLI has started, you can connect to the managed server instance using the <code class="email">connect</code> command, which<a id="id924" class="calibre1"/> by default connects to <code class="email">localhost</code> and <a id="id925" class="calibre1"/>the <code class="email">9990</code> port:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[disconnected /] connect</strong></span>
<span class="strong"><strong class="calibre9">[standalone@localhost:9990 /]</strong></span>
</pre></div><p class="calibre8">If you want to connect to another address or port, you can simply pass it to the <code class="email">connect</code> command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[disconnected /] connect 192.168.1.1</strong></span>
<span class="strong"><strong class="calibre9">[standalone@192.168.1.1:9990 /]</strong></span>
</pre></div><p class="calibre8">It is also possible to launch a CLI in the connected mode; this allows it to be connected automatically and to possibly specify the commands to be executed. For example, the following <code class="email">shell</code> command<a id="id926" class="calibre1"/> automatically connects to a WildFly instance and issues a <code class="email">shutdown</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">&gt; jboss-cli.bat --connect command=:shutdown</strong></span>
<span class="strong"><strong class="calibre9">{"outcome" =&gt; "success"}</strong></span>
</pre></div><p class="calibre8">CLI is <a id="id927" class="calibre1"/>especially useful for the automation of your software development process—<span class="strong"><strong class="calibre9">Continuous Integration</strong></span> (<span class="strong"><strong class="calibre9">CI</strong></span>) and production environment management systems can automatically control the life cycle of your application <a id="id928" class="calibre1"/>server<a id="id929" class="calibre1"/> with tools such as Chef (<a class="calibre1" href="https://www.getchef.com/">https://www.getchef.com/</a>) or Puppet (<a class="calibre1" href="http://puppetlabs.com/">http://puppetlabs.com/</a>). It might be handy if you would like to minimize the number of manual tasks that are required to be done to deploy an application.</p><div class="book" title="Connecting from remote hosts"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec53" class="calibre1"/>Connecting from remote hosts</h3></div></div></div><p class="calibre8">Starting<a id="id930" class="calibre1"/> from the 7.1.0 Beta release of the<a id="id931" class="calibre1"/> application server, security is enabled on AS management interfaces by default to prevent unauthorized remote access to the application server. Although local clients of the application server are still allowed to access management interfaces without any authentication, remote clients need to enter a username/password pair to access a CLI. Here's an example session that successfully connects to a remote host with the IP address <code class="email">10.13.2.255</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[disconnected /] connect 10.13.2.255</strong></span>
<span class="strong"><strong class="calibre9">Authenticating against security realm: ManagementRealm</strong></span>
<span class="strong"><strong class="calibre9">Username: administrator</strong></span>
<span class="strong"><strong class="calibre9">Password:</strong></span>
<span class="strong"><strong class="calibre9">[standalone@10.13.2.255:9990 /]</strong></span>
</pre></div><p class="calibre8">Please refer to <a class="calibre1" title="Chapter 2. Your First Java EE Application on WildFly" href="part0017_split_000.html#page">Chapter 2</a>, <span class="strong"><em class="calibre10">Your First Java EE Application on WildFly</em></span>, for more information about creating a user with the <code class="email">add-user.sh</code> shell command.</p></div><div class="book" title="Using a CLI in the graphical mode"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec54" class="calibre1"/>Using a CLI in the graphical mode</h3></div></div></div><p class="calibre8">An<a id="id932" class="calibre1"/> interesting option available for the command-line<a id="id933" class="calibre1"/> interface is the graphical mode, which can be activated by adding the <code class="email">--gui</code> parameter to the shell script:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">jboss-cli.bat --gui</strong></span>
</pre></div><p class="calibre8">Here's how CLI looks in the graphical mode:</p><div class="mediaobject"><img src="../images/00077.jpeg" alt="Using a CLI in the graphical mode" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">As described in the label, the resource will expand when you click on a folder; on the other hand, if you right-click on a node, you can fire an operation on it. The graphical mode could be useful to explore the possible configuration values or if you are not a big fan of console tools.</p><p class="calibre8">The next <a id="id934" class="calibre1"/>section discusses how to construct <a id="id935" class="calibre1"/>CLI commands, which can be executed either in the terminal mode or the graphical mode.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Managing the Application Server">
<div class="book" title="Entering the WildFly CLI">
<div class="book" title="Constructing CLI commands"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec63" class="calibre1"/>Constructing CLI commands</h2></div></div></div><p class="calibre8">All <a id="id936" class="calibre1"/>CLI operation requests allow you to have <a id="id937" class="calibre1"/>low-level interactions with the server management model. They provide a controlled way to edit the server configurations. An operation request consists of three parts:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An address that is prefixed with <code class="email">/</code></li><li class="listitem">An operation name that is prefixed with <code class="email">:</code></li><li class="listitem">An optional set of parameters contained within <code class="email">()</code></li></ul></div><div class="book" title="Determining the resource address"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec55" class="calibre1"/>Determining the resource address</h3></div></div></div><p class="calibre8">The<a id="id938" class="calibre1"/> server configuration<a id="id939" class="calibre1"/> is presented as a hierarchical tree of addressable resources. Each resource node offers a different set of operations. The address specifies the resource node on which to perform the operation. An address uses the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">/node-type=node-name</strong></span>
</pre></div><p class="calibre8">The notations are explained as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">node-type</code>: This<a id="id940" class="calibre1"/> is the resource node type. This maps to an element name in the server configuration.</li><li class="listitem"><code class="email">node-name</code>: This <a id="id941" class="calibre1"/>specifies the resource node name. This maps to the name attribute of the element in the server configuration.</li></ul></div><p class="calibre8">Separate each level of the resource tree with a slash (<code class="email">/</code>). So, for example, the following CLI expression identifies the ExampleDS data source registered in the data source subsystem:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">/subsystem=datasources/data-source=ExampleDS</strong></span>
</pre></div></div><div class="book" title="Performing operations on resources"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec56" class="calibre1"/>Performing operations on resources</h3></div></div></div><p class="calibre8">Once<a id="id942" class="calibre1"/> you have<a id="id943" class="calibre1"/> identified a resource, you can perform operations on the resource. An operation uses the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">:operation-name</strong></span>
</pre></div><p class="calibre8">So in the previous example, you can query the list of available resources for your nodes by adding <a id="id944" class="calibre1"/>the <code class="email">read-resource</code> command at the end of it:</p><div class="informalexample"><pre class="programlisting">/subsystem=datasources/:read-resource 
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "data-source" =&gt; {"ExampleDS" =&gt; undefined},
        "jdbc-driver" =&gt; {"h2" =&gt; undefined},
        "xa-data-source" =&gt; undefined
    }
}</pre></div><p class="calibre8">If you <a id="id945" class="calibre1"/>want to query for a specific attribute of your node, you can use the <code class="email">read-attribute</code> operation instead. For example, the following code shows how to read the enabled attribute from the data source:</p><div class="informalexample"><pre class="programlisting">/subsystem=datasources/data-source=ExampleDS/:read-attribute(name=enabled) 
{
    "outcome" =&gt; "success",
    "result" =&gt; false
}</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note43" class="calibre1"/>Note</h3><p class="calibre8">Apart from the operations on a specific resource, you can also perform a set of commands that are available on every path of your WildFly subsystem, such as <code class="email">cd</code> or <code class="email">ls</code> commands. These commands are pretty much equivalent to their Unix shell counterparts, and they allow you to navigate through the WildFly subsystems. Other important additions are the <code class="email">deploy</code> and <code class="email">undeploy</code> commands that, as you might guess, allow you to manage the deployment of applications. These key commands are discussed in the <span class="strong"><em class="calibre10">Deploying applications using the CLI</em></span> section of this chapter.</p></div><p class="calibre8">The CLI, however, is not just about querying attributes from the WildFly subsystems; you can also set attributes or create resources. For example, if you were to set the HTTP port of the HTTP connector, you will have to use the corresponding <code class="email">write</code> attribute on HTTP's socket binding interface, shown as follows:</p><div class="informalexample"><pre class="programlisting">/socket-binding-group=standard-sockets/socket-binding=http/:write-attribute(name=port,value=8080)
{
    "outcome" =&gt; "success","response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}</pre></div><p class="calibre8">Apart from the operations that we have seen so far, which can be performed on every resource of your subsystems, there can be special operations that can be performed exclusively<a id="id946" class="calibre1"/> on one <a id="id947" class="calibre1"/>resource. For example, within the naming <a id="id948" class="calibre1"/>subsystem, you will be able to issue a <code class="email">jndi-view</code> operation that will display the list of JNDI bindings, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">/subsystem=naming/:jndi-view
{
    "outcome" =&gt; "success",
    "result" =&gt; {"java: contexts" =&gt; {
        "java:" =&gt; {
            "TransactionManager" =&gt; {
                "class-name" =&gt; "com.arjuna.ats.jbossatx.jta.TransactionManagerDelegate","value" =&gt; "com.arjuna.ats.jbossatx.jta.TransactionManagerDelegate@afd978"
            },
     . . .
}</pre></div><div class="book" title="Using the tab completion helper"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch09lvl4sec10" class="calibre1"/>Using the tab completion helper</h4></div></div></div><p class="calibre8">Getting<a id="id949" class="calibre1"/> to know all the available commands <a id="id950" class="calibre1"/>in the CLI is a pretty hard task; this management interface includes an essential feature, the tab completion. Suppose the cursor is positioned at the beginning of an empty line; now if you type in <code class="email">/</code> and press the <span class="strong"><em class="calibre10">Tab</em></span> key, you will get the following list of all the available node types:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /
core-service           extension              socket-binding-group
deployment             interface              subsystem
deployment-overlay     path                   system-property</pre></div><p class="calibre8">After selecting the node type, you want to enter into the tree of resources, so type <code class="email">=</code> and press the <span class="strong"><em class="calibre10">Tab</em></span> key again. This will result in a list of all the following node names available for the chosen node type:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=
batch                jdr                  resource-adapters
datasources          jmx                  sar
deployment-scanner   jpa                  security
ee                   jsf                  threads
ejb3                 logging              transactions
infinispan           mail                 undertow
io                   naming               webservices
jaxrs                pojo                 weld
jca                  remoting</pre></div><p class="calibre8">After<a id="id951" class="calibre1"/> you have finished with the node path, adding<a id="id952" class="calibre1"/> a colon (<code class="email">:</code>) at the end of the node path and pressing the <span class="strong"><em class="calibre10">Tab</em></span> key will display all the available operation names for the selected node, which is shown as follows:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=deployment-scanner/scanner=default:
add                          read-resource
read-attribute              read-resource-description
read-children-names          remove
read-children-resources      resolve-path
read-children-types          undefine-attribute
read-operation-description   whoami
read-operation-names         write-attribute</pre></div><p class="calibre8">To see all the parameters of the <code class="email">add</code> operation (after the operation name), press the <span class="strong"><em class="calibre10">Tab</em></span> key:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=deployment-scanner/scanner=default:read-attribute(
include-defaults=   name=</pre></div><p class="calibre8">Choose the parameter you want and specify its value after <code class="email">=</code>:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /subsystem=deployment-scanner/scanner=default:read-attribute(name=
runtime-failure-causes-rollback   scan-enabled
relative-to                       scan-interval
path                              auto-deploy-zipped
auto-deploy-exploded              deployment-timeout
auto-deploy-xml</pre></div><p class="calibre8">Finally, when all the parameters have been specified, add <code class="email">)</code> and press <span class="strong"><em class="calibre10">Enter</em></span> to issue the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[standalone@localhost:9990 /] /subsystem=deployment-</strong></span>
<span class="strong"><strong class="calibre9">scanner/scanner=default:read-attribute(name=scan-enabled)</strong></span>
<span class="strong"><strong class="calibre9">{</strong></span>
<span class="strong"><strong class="calibre9">    "outcome" =&gt; "success",</strong></span>
<span class="strong"><strong class="calibre9">    "result" =&gt; true</strong></span>
<span class="strong"><strong class="calibre9">}</strong></span>
</pre></div></div></div></div></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Managing the Application Server">
<div class="book" title="Entering the WildFly CLI">
<div class="book" title="Deploying applications using the CLI"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch09lvl2sec64" class="calibre1"/>Deploying applications using the CLI</h2></div></div></div><p class="calibre8">Deploying <a id="id953" class="calibre1"/>an application (in the standalone mode) can<a id="id954" class="calibre1"/> be easily performed by copying the application's archives into the <code class="email">deployment</code> folder of your server distribution. That's a pretty handy option; however, we would like to stress the advantage of using a CLI, which offers a wide choice of additional options when deploying and also provides the opportunity to deploy applications remotely.</p><p class="calibre8">All it takes to deploy an application's archive is a connection to the management instance, either local or remote, and by issuing of the <code class="email">deploy</code> shell command. When used without arguments, the <a id="id955" class="calibre1"/>
<code class="email">deploy</code> command provides a list of applications that are currently deployed, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[disconnected /] connect</strong></span>
<span class="strong"><strong class="calibre9">[standalone@localhost:9990 /] deploy ExampleApp.war</strong></span>
</pre></div><p class="calibre8">If you feed a resource archive such as a <code class="email">WAR</code> file to the shell, it will deploy it on the standalone server right away, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[standalone@localhost:9990 /] deploy ../MyApp.war </strong></span>
</pre></div><p class="calibre8">By default, a CLI uses the <code class="email">JBOSS_HOME/bin</code> file as a source for your deployment archives. You can, however, use absolute paths when specifying the location of your archives; the CLI expansion facility (using the <span class="strong"><em class="calibre10">Tab</em></span> key) makes this option fairly simple:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[standalone@localhost:9990 /] deploy c:\deployments\MyApp.war</strong></span>
</pre></div><p class="calibre8">Redeploying the application requires an additional flag to be added to the <code class="email">deploy</code> command. Use the <code class="email">-f</code> argument to force the application's redeployment:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[standalone@localhost:9990 /] deploy -f ../MyApp.war</strong></span>
</pre></div><p class="calibre8">Undeploying the application can be done through the <code class="email">undeploy</code> command, which takes the application that is deployed as an argument. This is shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[standalone@localhost:9990 /] undeploy MyApp.war</strong></span>
</pre></div><p class="calibre8">By checking the WildFly configuration file (for example, <code class="email">standalone.xml</code> or <code class="email">domain.xml</code>), you will notice that the deployment element for your application has been removed.</p><div class="book" title="Deploying applications to a WildFly domain"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec57" class="calibre1"/>Deploying applications to a WildFly domain</h3></div></div></div><p class="calibre8">When <a id="id956" class="calibre1"/>you are deploying an application<a id="id957" class="calibre1"/> using the domain mode, you will have to specify to which server group the deployment is associated with. The CLI lets you choose between the following two options:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Deploy to all server groups</li><li class="listitem">Deploy to a single server group</li></ul></div><p class="calibre8">We <a id="id958" class="calibre1"/>will discuss <a id="id959" class="calibre1"/>these choices in two separate sections.</p></div><div class="book" title="Deploying to all server groups"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec58" class="calibre1"/>Deploying to all server groups</h3></div></div></div><p class="calibre8">If this <a id="id960" class="calibre1"/>option is chosen, the application <a id="id961" class="calibre1"/>will be deployed to all the available server groups. The <code class="email">--all-server-groups</code> flag can<a id="id962" class="calibre1"/> be used for this purpose. For example, refer to the following code:</p><div class="informalexample"><pre class="programlisting">[domain@localhost:9990 /] deploy ../application.ear --all-server-groups</pre></div><p class="calibre8">If, on the other hand, you want to undeploy an application from all the server groups that belong to a domain, you will have to issue the <code class="email">undeploy</code> command as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[domain@localhost:9990 /] undeploy application.ear --all-relevant-server-groups</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note44" class="calibre1"/>Note</h3><p class="calibre8">You <a id="id963" class="calibre1"/>might have noticed that the <code class="email">undeploy</code> command uses the <code class="email">--all-relevant-server</code>-group instead of the <code class="email">--all-server-</code> group. The reason for this difference is that the deployment might not be enabled on all the server groups; therefore, by using this option, you will actually undeploy it from all the server groups in which the deployment is enabled.</p></div></div><div class="book" title="Deploying to a single server group"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec59" class="calibre1"/>Deploying to a single server group</h3></div></div></div><p class="calibre8">The <a id="id964" class="calibre1"/>other option lets you perform a selective<a id="id965" class="calibre1"/> deployment of your application only on the server groups you indicate:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[domain@localhost:9990 /] deploy application.ear --server-groups=main-server-group</strong></span>
</pre></div><p class="calibre8">You are not limited to a single server group, and you can separate multiple server groups with a comma (<code class="email">,</code>). For example, refer to the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[domain@localhost:9990 /] deploy application.ear --server-groups=main-server-group,other-server-group</strong></span>
<span class="strong"><strong class="calibre9">Successfully deployed application.ear</strong></span>
</pre></div><p class="calibre8">The tab completion feature will help you to complete the value for the list of <code class="email">--server-groups</code> selected for deployment.</p><p class="calibre8">Now, suppose we want to undeploy the application from just one server group. In this case, there can be two possible outcomes. If the application is available just on that server group, you will successfully complete the undeployment as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[domain@localhost:9990 /] undeploy wflyproject.war --server-groups=main-server-group</strong></span>
</pre></div><p class="calibre8">On the other hand, if your application is available on other server groups, the following error will be returned by the CLI:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">Undeploy failed: {"domain-failure-description" =&gt; {"Composite operation failed and was rolled back. Steps that failed:" =&gt; {"Operation step-3" =&gt; "Cannot remove deployment wflyproject.war from the domain as it is still used by server groups [other-server-group]"}}}</strong></span>
</pre></div><p class="calibre8">It seems<a id="id966" class="calibre1"/> that something went wrong. As <a id="id967" class="calibre1"/>a matter of fact, when you are removing an application from a server group, the domain controller will verify that any other server group will not refer to the application; otherwise, the previous command will fail.</p><p class="calibre8">You can, however, instruct the domain controller to undeploy the application without deleting the content as well. This is shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">[domain@localhost:9990 /] undeploy application.ear --server-groups=main-server-group --keep-content</strong></span>
</pre></div></div></div></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Managing the Application Server">
<div class="book" title="Entering the WildFly CLI">
<div class="book" title="Creating CLI scripts"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch09lvl2sec65" class="calibre1"/>Creating CLI scripts</h2></div></div></div><p class="calibre8">As a<a id="id968" class="calibre1"/> program developer, you might be interested<a id="id969" class="calibre1"/> to know that a CLI can execute commands in a non-interactive way by adding them to a file, just as a shell script. In order to execute the script, you can launch the CLI with the <code class="email">--file</code> parameter as in the following example (for Windows):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">jboss-cli.bat --file=test.cli</strong></span>
</pre></div><p class="calibre8">The equivalent command for Unix users will be as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">./jboss-cli.sh --file=test.cli</strong></span>
</pre></div><p class="calibre8">In the next section, we will look at some useful scripts that can be added to your administrator toolbox.</p><div class="book" title="Deploying an application to several WildFly nodes"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec60" class="calibre1"/>Deploying an application to several WildFly nodes</h3></div></div></div><p class="calibre8">The <a id="id970" class="calibre1"/>earlier JBoss AS <a id="id971" class="calibre1"/>releases used to ship with a <code class="email">farm</code> folder, which<a id="id972" class="calibre1"/> would trigger a deployment to all the nodes that are part of a JBoss cluster. This option is not included anymore with JBoss AS7 and WildFly, but resurrecting a farm deployment is just a matter of following a few CLI instructions.</p><p class="calibre8">In the following example, we are deploying an application to the default server address (<code class="email">127.0.0.1</code> and port <code class="email">9990</code>) and to another server instance that is bound to the same address but to port <code class="email">10190</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">connect</strong></span>
<span class="strong"><strong class="calibre9">deploy /usr/data/example.war</strong></span>
<span class="strong"><strong class="calibre9">connect 127.0.0.1:10190</strong></span>
<span class="strong"><strong class="calibre9">deploy /usr/data/example.war</strong></span>
</pre></div></div><div class="book" title="Restarting servers in a domain"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec61" class="calibre1"/>Restarting servers in a domain</h3></div></div></div><p class="calibre8">A<a id="id973" class="calibre1"/> common requirement for the domain administrator<a id="id974" class="calibre1"/> is to restart the application server nodes, for <a id="id975" class="calibre1"/>example, when some server libraries are updated. CLI provides a handy shortcut to stop and start all the servers that are part of a server group:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">connect</strong></span>
<span class="strong"><strong class="calibre9">/server-group=main-server-group:start-servers</strong></span>
<span class="strong"><strong class="calibre9">/server-group=main-server-group:stop-servers</strong></span>
</pre></div><p class="calibre8">If you prefer a more granular approach, you can start the single server nodes as shown in the following example, which shows how you can apply conditional execution logic in your CLI scripts:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">connect</strong></span>
<span class="strong"><strong class="calibre9">if (result == "STARTED") of /host=master/server-config=server-one:read-attribute(name=status)</strong></span>
<span class="strong"><strong class="calibre9">/host=master/server-config=server-one:stop</strong></span>
<span class="strong"><strong class="calibre9">end-if</strong></span>

<span class="strong"><strong class="calibre9">if (result == "STARTED") of /host=master/server-config=server-two:read-attribute(name=status)</strong></span>
<span class="strong"><strong class="calibre9">/host=master/server-config=server-two:stop</strong></span>
<span class="strong"><strong class="calibre9">end-if</strong></span>
<span class="strong"><strong class="calibre9">/host=master/server-config=server-one:start</strong></span>

<span class="strong"><strong class="calibre9">/host=master/server-config=server-two:start</strong></span>
</pre></div><p class="calibre8">In the <code class="email">if end-if</code> part of the code, we are checking for the server's status attribute. If the status is <span class="strong"><strong class="calibre9">STARTED</strong></span>, the application servers are stopped and then restarted.</p></div><div class="book" title="Installing a data source as a module"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec62" class="calibre1"/>Installing a data source as a module</h3></div></div></div><p class="calibre8">In <a id="id976" class="calibre1"/>WildFly, you<a id="id977" class="calibre1"/> can use the <code class="email">module</code> command in order to install a new module. We already did something similar in <a class="calibre1" title="Chapter 5. Combining Persistence with CDI" href="part0030_split_000.html#page">Chapter 5</a>, <span class="strong"><em class="calibre10">Combining Persistence with CDI</em></span>. Now, you can fully automate a data source creation as shown in the following example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">connect</strong></span>

<span class="strong"><strong class="calibre9">module add --name=org.postgresql --resources= postgresql-9.3-1101.jdbc41.jar  --dependencies=javax.api,javax.transaction.api</strong></span>

<span class="strong"><strong class="calibre9">/subsystem=datasources/jdbc-driver=postgresql:add(driver-module-name=org.postgresql,driver-name=postgresql,driver-class-name=org.postgresql.Driver)</strong></span>

<span class="strong"><strong class="calibre9">/subsystem=datasources/data-source=PostgreSQLDS:add(jndi-name=java:jboss/datasources/PostgreSQLDS , driver-name=postgresql, connection-url=jdbc:postgresql://localhost:5432/ticketsystem,user-name=jboss,password=jboss)</strong></span>
</pre></div><p class="calibre8">The first line of the script, after the connection, installs a new module named <code class="email">org.postgresql</code> in your server modules' directory, including the PostgreSQL JDBC driver and the required dependencies.</p><p class="calibre8">The second line installs the JDBC driver for the <code class="email">org.postgresql</code> module into the <code class="email">datasources/jdbc-driver</code> subsystem.</p><p class="calibre8">Finally, a data source is added to <code class="email">jndi java:jboss/datasources/PostgreSQLDS</code> with the required URL and credentials.</p></div><div class="book" title="Adding JMS resources"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec63" class="calibre1"/>Adding JMS resources</h3></div></div></div><p class="calibre8">Adding<a id="id978" class="calibre1"/> a new JMS destination is quite easy since it does<a id="id979" class="calibre1"/> not require a lengthy set of commands. However, it is sometimes your application that needs to set up lots of JMS destinations in order to work, so why not create a script for it too? The following is a tiny script that adds a JMS queue to the server configuration:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">connect</strong></span>
<span class="strong"><strong class="calibre9">jms-queue add  --queue-address=queue1 --entries=queues/queue1 </strong></span>
</pre></div><p class="calibre8">The following is the corresponding script you can use to create a JMS topic:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">connect</strong></span>
<span class="strong"><strong class="calibre9">jms-topic add  --topic-address=topic1 --entries=topics/topic1</strong></span>
</pre></div></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using advanced languages to create powerful CLI scripts"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec44" class="calibre1"/>Using advanced languages to create powerful CLI scripts</h1></div></div></div><p class="calibre8">So<a id="id980" class="calibre1"/> far, we have learned<a id="id981" class="calibre1"/> how to write CLI shell commands to manage the application server's resources. This approach has the advantage that you can easily access every server resource easily and quickly, thanks to the built-in autocompletion feature. If, on the other hand, you want to perform some sophisticated logic around your commands, then you need to find some other alternatives.</p><p class="calibre8">If you are a shell guru, you might easily resort to some bash scripting in order to capture the output of the CLI and use the rich set of Unix/Linux tools to perform some administrative actions.</p><p class="calibre8">Supplying a short overview of the bash functionalities might be an amusing exercise; however, if we do this, we would move away from the scope of this book. We will instead document some built-in functionalities such as the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">In the first section, we will show how to use a CLI remote client API from within a Python script</li><li class="listitem">In the next section, we will use the raw management API to execute CLI commands from within Java applications</li></ul></div><p class="calibre8">There are multiple use cases in which the JBoss CLI scripts could be useful. A script could be used to configure a developer's machine, a test environment, or as an initial configuration for production. In many cases, the configuration needed to start a full-blown enterprise application may be nontrivial; you might need to use a specific port configuration to cluster tests or your own security domain. You might also need your continuous integration server to do this for you. Besides this, it's better to have an automatic configuration script than set up the configuration manually every time, which is just a waste of time and a potential source of bugs.</p></div>

<div class="book" title="Using advanced languages to create powerful CLI scripts">
<div class="book" title="Using scripting languages to wrap CLI execution"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec66" class="calibre1"/>Using scripting languages to wrap CLI execution</h2></div></div></div><p class="calibre8">JBoss<a id="id982" class="calibre1"/> AS 7 has<a id="id983" class="calibre1"/> introduced a new CLI remote <a id="id984" class="calibre1"/>API that acts as a facade for the CLI public API. The core class that acts as a bridge between these two APIs is the <code class="email">scriptsupport.CLI</code> class that is contained in the <code class="email">JBOSS_HOME/bin/client/jboss-cli-client.jar</code> file.</p><p class="calibre8">Thanks to this API, you can execute CLI commands using lots of different languages such as Jython, Groovy, or JavaScript. Since Jython is also the de facto management standard for other application servers, such as Oracle, WebLogic, and WebSphere, we will use it to perform some basic management tasks.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note45" class="calibre1"/>Note</h3><p class="calibre8">Jython is an implementation of Python for JVM. Jython is extremely useful because it provides the productivity features of a mature scripting language while running on a JVM. Unlike a Python program, a Jython program can run in any environment that supports a JVM.</p></div><p class="calibre8">Jython is invoked using the <code class="email">jython</code> script, which is a short script that invokes your local JVM, running the Java class file, <code class="email">org.python.util.jython</code>.</p><p class="calibre8">The first <a id="id985" class="calibre1"/>thing you need to do in order to get started is download the Jython installer from <a class="calibre1" href="http://www.jython.org/downloads.html">http://www.jython.org/downloads.html</a>.</p><p class="calibre8">Run<a id="id986" class="calibre1"/> the installer<a id="id987" class="calibre1"/> with the following <a id="id988" class="calibre1"/>command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">java -jar jython-installer-2.5.3.jar</strong></span>
</pre></div><p class="calibre8">Next, add the <code class="email">JYTHON_HOME/bin</code> folder (for example, <code class="email">C:\jython2.5.3\bin</code>) to the system path and add the <code class="email">jboss-cli-client.jar</code> file to the system, <code class="email">CLASSPATH</code>. For example, in Windows, use the given command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">set JYTHON_HOME= C:\jython2.5.3</strong></span>
<span class="strong"><strong class="calibre9">set PATH=%PATH%;%JYTHON_HOME%\bin</strong></span>

<span class="strong"><strong class="calibre9">set CLASSPATH=%CLASSPATH%;%JBOSS_HOME%\bin\client\jboss-cli-client.jar;.</strong></span>
</pre></div><p class="calibre8">Here's the same command for Linux:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">export PATH=$PATH:/usr/data/jython2.5.3/bin</strong></span>
<span class="strong"><strong class="calibre9">export CLASSPATH=$CLASSPATH$:%JBOSS_HOME%/bin/client/jboss-cli-client.jar</strong></span>
</pre></div><p class="calibre8">Ok, now we will create our first script that will basically return the JNDI view of our application server.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note46" class="calibre1"/>Note</h3><p class="calibre8">Be aware that Jython, just like Python, uses indentation to determine the code structure instead of using braces or keywords. Therefore, do not use them randomly. An IDE might help you with this—for Python you can use, for example, Vim <a id="id989" class="calibre1"/>with python-mode (<a class="calibre1" href="https://github.com/klen/python-mode">https://github.com/klen/python-mode</a>) or Eclipse<a id="id990" class="calibre1"/> with the PyDev extension (<a class="calibre1" href="http://pydev.org/">http://pydev.org/</a>).</p></div><p class="calibre8">Create a file named <code class="email">script.py</code> containing the following code:</p><div class="informalexample"><pre class="programlisting">from org.jboss.as.cli.scriptsupport import CLI

cli = CLI.newInstance()
cli.connect()

cli.cmd("cd /subsystem=naming")

result = cli.cmd(":jndi-view")
response = result.getResponse()

print 'JNDI VIEW ======================= '
print response
cli.disconnect()</pre></div><p class="calibre8">Now <a id="id991" class="calibre1"/>execute the <a id="id992" class="calibre1"/>script with the following code:</p><div class="informalexample"><pre class="programlisting">jython script.py</pre></div><p class="calibre8">As you can see, the code is very self-explanatory; we are importing the <code class="email">org.jboss.as.cli.scriptsupport.CLI</code> class, which is used to send commands and read the <a id="id993" class="calibre1"/>response. Then, we are connecting to the local WildFly instance and issuing a <code class="email">:jndi-view</code> command.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note47" class="calibre1"/>Note</h3><p class="calibre8">The <code class="email">connect</code> command<a id="id994" class="calibre1"/> can be used to connect to a remote WildFly host as well by adding the following parameters: <code class="email">connect (String controllerHost, int controllerPort, String username, String password)</code>.</p></div><p class="calibre8">The response variable is <code class="email">org.jboss.dmr.ModelNode</code>. This can be further inspected as shown in the following example, which goes in to some depth about platform MBeans, to get some memory statistics:</p><div class="informalexample"><pre class="programlisting">from org.jboss.as.cli.scriptsupport import CLI

cli = CLI.newInstance()
cli.connect()

cli.cmd("cd /core-service=platform-mbean/type=memory/")

result = cli.cmd(":read-resource(recursive=false,proxies=false,include-runtime=true,include-defaults=true)")

response = result.getResponse()
enabled = response.get("result").get("heap-memory-usage")

used = enabled.get("used").asInt()

if used &gt; 512000000:
    print "Over 1/2 Gb Memory usage "
else:
    print 'Low usage!'

cli.disconnect()</pre></div><p class="calibre8">In the previous example, we tracked the resources contained in <code class="email">/core-service=platform-mbean/type=memory</code>. The available resources are, however, child resources of the two kinds of available heap memory areas (<code class="email">heap-memory-usage</code> and <code class="email">non-heap-memory-usage</code>), as shown by the following code:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] /core-service=platform-mbean/type=memory:read-resource(recursive=false,proxies=false,include-runtime=true,include-defaults=true)
{
    "outcome" =&gt; "success","result" =&gt; {
        "heap-memory-usage" =&gt; {"init" =&gt; 67108864L,"used" =&gt; 59572256L,"committed" =&gt; 170852352L,"max" =&gt; 477233152L},
        "non-heap-memory-usage" =&gt; {
            "init" =&gt; 24313856L,"used" =&gt; 90491328L,"committed" =&gt; 90701824L,"max" =&gt; 369098752L},
        "object-pending-finalization-count" =&gt; 0,"verbose" =&gt; false
    }
}</pre></div><p class="calibre8">Using<a id="id995" class="calibre1"/> just the <code class="email">get</code> command <a id="id996" class="calibre1"/>of the <code class="email">ModelNode</code> object, you <a id="id997" class="calibre1"/>can refer to the child resources of the memory type and reach all the single attributes. Once you have got the attributes, it's easy to cast them to an integer using the <code class="email">asInt()</code> function of the <code class="email">ModelNode</code> object and use the cool Python constructs to alert your administrator.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using the raw management API to manage the application server"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec45" class="calibre1"/>Using the raw management API to manage the application server</h1></div></div></div><p class="calibre8">If <a id="id998" class="calibre1"/>you don't feel like learning a scripting language to manage the application server, you can still use the raw management API from within your Java classes. Don't be influenced by the fact that we left this option as the last one; in fact, using the native management API is not difficult at all since it is based on very few classes and has little compile-time and runtime dependencies on the WildFly API.</p><p class="calibre8">For this reason, you can use the management API as well from any Java EE application by simply adding the following dependencies to the <code class="email">META-INF/MANIFEST.MF</code> file of your application:</p><div class="informalexample"><pre class="programlisting">Dependencies: org.jboss-as-controller-client,org.jboss.dmr</pre></div><p class="calibre8">The core API named <span class="strong"><strong class="calibre9">detyped management API</strong></span> is quite simple; the primary class is <code class="email">org.jboss.dmr.ModelNode</code>, which we already mentioned in the Jython section. A <code class="email">ModelNode</code> class is essentially just a wrapper around a value; the value is typically a basic JDK type that can be retrieved using the <code class="email">getType()</code> method of <code class="email">ModelNode</code>.</p><p class="calibre8">In addition to the <code class="email">jboss-dmr</code> API, the other module that is used to connect to the management API is <code class="email">jboss-as-controller-client</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note48" class="calibre1"/>Note</h3><p class="calibre8">You don't need to download any of these libraries since both of these modules are included in the application server since release 7.</p></div></div>

<div class="book" title="Using the raw management API to manage the application server">
<div class="book" title="Reading management model descriptions via the raw management API"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec67" class="calibre1"/>Reading management model descriptions via the raw management API</h2></div></div></div><p class="calibre8">Using<a id="id999" class="calibre1"/> the <span class="strong"><strong class="calibre9">detyped management API</strong></span> is<a id="id1000" class="calibre1"/> not too different from its scripting language counterpart; at first, you need to create a management client that can connect to your target process's native management socket (which can be an individual standalone mode server, or in a domain mode environment, the domain controller):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">ModelControllerClient client = ModelControllerClient.Factory.create(InetAddress.getByName("localhost"), 9990);</strong></span>
</pre></div><p class="calibre8">Next, you need to create an operation request object using the <code class="email">org.jboss.dmr.ModelNode</code> class, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">final ModelNode operation = new ModelNode();</strong></span>
<span class="strong"><strong class="calibre9">operation.get("operation").set("jndi-view");</strong></span>

<span class="strong"><strong class="calibre9">final ModelNode address = operation.get("address");</strong></span>
<span class="strong"><strong class="calibre9">address.add("subsystem", "naming");</strong></span>

<span class="strong"><strong class="calibre9">operation.get("recursive").set(true);</strong></span>
<span class="strong"><strong class="calibre9">operation.get("operations").set(true);</strong></span>

<span class="strong"><strong class="calibre9">final ModelNode returnVal = client.execute(operation);</strong></span>
<span class="strong"><strong class="calibre9">logger.info(returnVal.get("result").toString());</strong></span>
</pre></div><p class="calibre8">As you can see, <code class="email">ModelNode</code> objects can be chained in order to reach an operation (in the example, the JNDI view), which is available on a node path (in our case, the naming subsystem).</p><p class="calibre8">Once you have added the <code class="email">ModelNode</code> attributes, you can issue the <code class="email">execute</code> commands on your node, which will in turn return <code class="email">ModelNode</code> where the result of the operation will be stored.</p><p class="calibre8">In <a id="id1001" class="calibre1"/>the samples, you can find a<a id="id1002" class="calibre1"/> fully working project containing these management examples.</p><div class="book" title="Creating your resource watches using the detyped API"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch09lvl3sec64" class="calibre1"/>Creating your resource watches using the detyped API</h3></div></div></div><p class="calibre8">Now<a id="id1003" class="calibre1"/> that you <a id="id1004" class="calibre1"/>have learned the basics of the <span class="strong"><strong class="calibre9">detyped </strong></span><a id="id1005" class="calibre1"/>
<span class="strong"><strong class="calibre9">management API</strong></span>, we will illustrate a concrete example; our goal will be to monitor a server resource (the number of active JDBC connections for a data source) using an EJB. You can use this pattern to create your own server watches that can be integrated with your application environment. This is shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">package com.packtpub.wflydevelopment.chapter9;

import org.jboss.as.controller.client.ModelControllerClient;
import org.jboss.dmr.ModelNode;

import javax.ejb.Schedule;
import javax.ejb.Stateless;
import java.io.Closeable;
import java.net.InetAddress;
import java.util.logging.Level;
import java.util.logging.Logger;

@Stateless
public class WatchMyDB {

    private final static Logger logger = Logger.getLogger(WatchMyDB.class.getName());

    @Schedule(dayOfWeek = "*", hour = "*", minute = "*", second =
            "*/30", year = "*", persistent = false)
    public void backgroundProcessing() {
        ModelControllerClient client = null;
        try {
            client = ModelControllerClient.Factory.create(InetAddress.getByName("localhost"), 9990);
            final ModelNode operation = new ModelNode();
            operation.get("operation").set("read-resource");
            operation.get("include-runtime").set(true);
            final ModelNode address = operation.get("address");
            address.add("subsystem", "datasources");
            address.add("data-source", "ExampleDS");
            address.add("statistics", "pool");
            final ModelNode returnVal = client.execute(operation);

            final ModelNode node2 = returnVal.get("result");
            final String stringActiveCount = node2.get("ActiveCount").asString();

            if (stringActiveCount.equals("undefined")) {
                return; // Connection unused
            }
            int activeCount = Integer.parseInt(stringActiveCount);

            if (activeCount &gt; 50) {
                alertAdministrator();
            }
        } catch (Exception exc) {
            logger.log(Level.SEVERE, "Exception !", exc);
        } finally {
            safeClose(client);
        }
    }

    public void safeClose(final Closeable closeable) {
        if (closeable != null) {
            try {
                closeable.close();
            } catch (Exception e) {
                logger.log(Level.SEVERE, "Exception closing the client! ", e);
            }
        }
    }

    private void alertAdministrator() {
        // Implement it !
    }
}</pre></div><p class="calibre8">We will not rehash the basic concepts about EJB Timers, which have been discussed in <a class="calibre1" title="Chapter 3. Introducing Java EE 7 – EJBs" href="part0023_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Introducing Java EE 7 – EJBs</em></span>. We suggest that you have a look at the highlighted section of the code, which shows how you can chain your <code class="email">ModelNode</code> objects in order to reach the attribute that we are going to monitor (the <code class="email">activeCount</code> attribute of the <code class="email">ExampleDS</code> datasource).</p><p class="calibre8">Once<a id="id1006" class="calibre1"/> you have<a id="id1007" class="calibre1"/> the value of the <code class="email">activeCount</code> attribute, we<a id="id1008" class="calibre1"/> leave it to your imagination to envision all the possible actions you can undertake!</p><p class="calibre8">It is worth noting that there are additional means of monitoring WildFly. One of them is using <a id="id1009" class="calibre1"/>the <code class="email">hawt.io</code> plugin for JBoss (<a class="calibre1" href="http://hawt.io/plugins/jboss/">http://hawt.io/plugins/jboss/</a>). We already tried this for ActiveMQ when we were developing<a id="id1010" class="calibre1"/> MessageBeans. Another tool is Jolokia (<a class="calibre1" href="http://www.jolokia.org/">http://www.jolokia.org/</a>), which exposes JMX beans over HTTP. So, if you are not into writing your own monitors, there are other options worth exploring.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Role-based security"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec46" class="calibre1"/>Role-based security</h1></div></div></div><p class="calibre8">In JBoss 7, a logged-in administrator has unlimited power over every configuration aspect<a id="id1011" class="calibre1"/> of a running server. This could be a problem in a production environment when multiple users have access to the server to do different tasks. One user could only be interested in deploying new applications, another should only be able to restart the server, and there could be one who should not be able to change anything (for example, a monitoring agent sending data about the execution of an application).</p><p class="calibre8">To support these kinds of requirements, WildFly brings two access control strategies:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Simple, which<a id="id1012" class="calibre1"/> is the all-or-nothing approach known from JBoss AS 7 and EAP in versions earlier than 6.2 (every authenticated administrator has full access to the application server). This is the default strategy.</li><li class="listitem">Role based access control (RBAC), which allows you to assign administrative users to specific management roles.</li></ul></div><p class="calibre8">Let's navigate to <code class="email">http://localhost:8080/console</code> and log in with our administrator password. The upper menu contains a tab named <span class="strong"><strong class="calibre9">Administration</strong></span>. This is used to configure the access control mechanism. Once you click on it (you should see a message box informing you that RBAC is not yet enabled), we will see three subtabs: <span class="strong"><strong class="calibre9">Users</strong></span>, <span class="strong"><strong class="calibre9">Groups</strong></span>, and <span class="strong"><strong class="calibre9">Roles</strong></span>. Let's take a closer look at each of these objects.</p><p class="calibre8">Users are defined using the <code class="email">add-user.bat</code> (<code class="email">.sh</code>) scripts in the <code class="email">JBOSS_HOME/bin</code> directory. We have already defined one before the first time we accessed the JBoss console. The created user, however, requires some additional information in order to determine his or her security level. The easiest way to achieve this is to organize them into groups. The assignment can be done via the user creation scripts or by the <code class="email">mgmt-groups.properties</code> files in the WildFly's configuration directory. Another way to do this is to<a id="id1013" class="calibre1"/> define a security realm connected to an external source (an LDAP server for instance). We will talk more about security realms in the next chapter. For now, you can create a user assigned to a group named <code class="email">TestGroup</code>.</p><p class="calibre8">A group is mapped to a set of security roles to provide specific permissions. For example, we can create user groups for developers and junior administrators and map them to a subset of desired roles. A user can be part of multiple groups, so there is also a possibility to exclude a role for a specific group so that no other group could grant it.</p><p class="calibre8">Finally, we have roles that cover multiple areas of the server's functionality. Every role has a set of permissions assigned and some of them are additionally constrained (for instance, to allow you to configure modifications in only specific subsystems such as data sources). A list <a id="id1014" class="calibre1"/>of built-in roles is available in the following table:</p><div class="informalexample"><table border="1" class="calibre17"><colgroup class="calibre18"><col class="calibre19"/><col class="calibre19"/><col class="calibre19"/></colgroup><thead class="calibre20"><tr class="calibre21"><th valign="bottom" class="calibre22">
<p class="calibre23">Role</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre23">Permissions</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre23">Sensitive data (passwords and auditing)</p>
</th></tr></thead><tbody class="calibre24"><tr class="calibre21"><td valign="top" class="calibre25">
<p class="calibre23"><code class="literal">Monitor</code></p>
</td><td valign="top" class="calibre25">
<p class="calibre23">Read-only access to<a id="id1015" class="indexterm"/> configuration and runtime state.</p>
</td><td valign="top" class="calibre25">
<p class="calibre23">No access.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre25">
<p class="calibre23"><code class="literal">Operator</code></p>
</td><td valign="top" class="calibre25">
<p class="calibre23">All permissions <a id="id1016" class="indexterm"/>of <span><strong class="calibre26">Monitor</strong></span>. This role can restart the server, control JMS destination, and database connection pools. It cannot modify the configuration.</p>
</td><td valign="top" class="calibre25">
<p class="calibre23">No access.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre25">
<p class="calibre23"><code class="literal">Maintainer</code></p>
</td><td valign="top" class="calibre25">
<p class="calibre23">All permissions <a id="id1017" class="indexterm"/>of <span><strong class="calibre26">Operator</strong></span>. This role can modify the configuration (including deploying new applications).</p>
</td><td valign="top" class="calibre25">
<p class="calibre23">No access.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre25">
<p class="calibre23"><code class="literal">Deployer</code></p>
</td><td valign="top" class="calibre25">
<p class="calibre23">All permissions<a id="id1018" class="indexterm"/> of <span><strong class="calibre26">Maintainer</strong></span>, but with restrictions on deploying new applications (cannot change the configuration of the server).</p>
</td><td valign="top" class="calibre25">
<p class="calibre23">No access.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre25">
<p class="calibre23"><code class="literal">Administrator</code></p>
</td><td valign="top" class="calibre25">
<p class="calibre23">All permissions <a id="id1019" class="indexterm"/>of <span><strong class="calibre26">Maintainer</strong></span>.</p>
</td><td valign="top" class="calibre25">
<p class="calibre23">Read/write access. No access to the audit system.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre25">
<p class="calibre23"><code class="literal">Auditor</code></p>
</td><td valign="top" class="calibre25">
<p class="calibre23">All permissions<a id="id1020" class="indexterm"/> of <span><strong class="calibre26">Monitor</strong></span>.</p>
</td><td valign="top" class="calibre25">
<p class="calibre23">Read-only access. Full access to the auditing system.</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre25">
<p class="calibre23"><code class="literal">Super User</code></p>
</td><td valign="top" class="calibre25">
<p class="calibre23">Everything is <a id="id1021" class="indexterm"/>permitted. The administrator known from JBoss AS 7 and the simple strategy in WildFly. Also, this is the default role for a local user (connecting from a localhost).</p>
</td><td valign="top" class="calibre25">
<p class="calibre23">Full access.</p>
</td></tr></tbody></table></div><p class="calibre8">Besides<a id="id1022" class="calibre1"/> relying on the group-role mapping mechanism, you have another option to assign users to roles. You can use the <span class="strong"><strong class="calibre9">Administration/Users</strong></span> screen in the admin console to directly assign a user to a role (be sure to select <span class="strong"><strong class="calibre9">Include</strong></span> as the type). Assign the <code class="email">SuperUser</code> role now to your current user using the <span class="strong"><strong class="calibre9">Add</strong></span> button. Additionally, you can use <span class="strong"><strong class="calibre9">Administration/Groups</strong></span> to add our newly created <code class="email">TestGroup</code> to, for instance, the <code class="email">Monitor</code> role.</p><p class="calibre8">Our configuration is now in place; try and check it out. To switch to the RBAC strategy, we will need to issue the following command using the CLI interface:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">/core-service=management/access=authorization:write-attribute(name=provider, value=rbac)</strong></span>
</pre></div><p class="calibre8">Reload the server and log in to the web console again using the account you designed as <code class="email">SuperUser</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note49" class="calibre1"/>Note</h3><p class="calibre8">We are testing the web console, but the RBAC mechanism also works for the CLI. Note that the CLI will allow you to access it from <code class="email">localhost</code> as long as you have the <code class="email">$local</code> user allowed in your security realm:</p><div class="informalexample"><pre class="programlisting">  &lt;security-realm name="ManagementRealm"&gt;
    &lt;authentication&gt;
<span class="strong"><strong class="calibre9">     &lt;local default-user="$local" allowed-users="*"/&gt;</strong></span>
     &lt;properties path="mgmt-users.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/authentication&gt;
    &lt;authorization map-groups-to-roles="false"&gt;
     &lt;properties path="mgmt-groups.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/authorization&gt;
 &lt;/security-realm&gt;</pre></div><p class="calibre8">If you wish to disable it, simply remove this line.</p></div><p class="calibre8">If you are <a id="id1023" class="calibre1"/>wondering what your current role is, you can click on <span class="strong"><strong class="calibre9">Username</strong></span> in the upper-right corner of the screen. You should see a bit of information about the currently logged-in administrator in the following screenshot:</p><div class="mediaobject"><img src="../images/00078.jpeg" alt="Role-based security" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">In the<a id="id1024" class="calibre1"/> preceding screenshot, we can see that the user root is logged in as a <code class="email">SuperUser</code> role. Besides having the possibility to do everything with the application server, the <code class="email">SuperUser</code> role has one additional feature. It can impersonate other roles using <span class="strong"><strong class="calibre9">Run as…</strong></span>, which can be useful if you want to check what are the limitations of another role. Feel free to check them out right now. For instance, as a <code class="email">Monitor</code>, you should not be able to alter any settings in the admin console.</p><p class="calibre8">You can also relogin with the user you've created earlier, which is assigned to <code class="email">TestGroup</code>. It should have the <span class="strong"><strong class="calibre9">Monitor</strong></span> role shown in the upper-right corner of the screen.</p></div>

<div class="book" title="Role-based security">
<div class="book" title="Auditing administrative operations"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec68" class="calibre1"/>Auditing administrative operations</h2></div></div></div><p class="calibre8">WildFly<a id="id1025" class="calibre1"/> introduces an audit-log <a id="id1026" class="calibre1"/>feature that allows the administrators to track the configuration changes made on the server. The feature is initially disabled but can be useful in some scenarios, so let's take a short look at it.</p><p class="calibre8">The <a id="id1027" class="calibre1"/>audit-log configuration consists of three parts:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Formatter</strong></span>: This <a id="id1028" class="calibre1"/>formats the log output. By default, it's based on JSON.</li><li class="listitem"><span class="strong"><strong class="calibre9">Handler</strong></span>: This <a id="id1029" class="calibre1"/>handles the output. By default, it is a file-based handler, but it is possible to use a TCP or UDP to send the logs to a remote server.</li><li class="listitem"><span class="strong"><strong class="calibre9">Logger</strong></span>: This<a id="id1030" class="calibre1"/> controls the login process.</li></ul></div><p class="calibre8">Detailed <a id="id1031" class="calibre1"/>configuration can be found in the official WildFly documentation at <a class="calibre1" href="https://docs.jboss.org/author/display/WFLY8/Audit+logging">https://docs.jboss.org/author/display/WFLY8/Audit+logging</a>.</p><p class="calibre8">The<a id="id1032" class="calibre1"/> audit log is disabled by default. To <a id="id1033" class="calibre1"/>enable it, we must issue the following CLI command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">/core-service=management/access=audit/logger=audit-log:write-attribute(name=enabled, value=true)</strong></span>
</pre></div><p class="calibre8">Now you can try to do any administrative action using the web console (for instance, disabling a data source). After this, you should find a trace of it in <code class="email">JBOSS_HOME/standalone/data/audit-log.log</code> (along with information about switching the audit logging on).</p></div></div>
<div class="book" title="Patching a running instance"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec47" class="calibre1"/>Patching a running instance</h1></div></div></div><p class="calibre8">The<a id="id1034" class="calibre1"/> newest version of the JBoss Application Server comes with a patching utility that allows you to automatically update parts of the server with newer versions. Currently, the patching is done using a CLI. Any patch can be reverted, and the administrator is able to track the history of patches.</p><p class="calibre8">A patch can be applied by simply calling the <code class="email">patch apply &lt;file path&gt; (without -)</code> command. A complementary command is <code class="email">patch rollback --patch-id = id</code>, a patch-rollback command. To obtain information about the installed patches, simply call <code class="email">patch info</code>. Patches are distributed by teams responsible for specific WildFly subsystems. Visit their websites if you need a patch for a specific module.</p></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec48" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">In this chapter, we covered the application server's management API from a developer's perspective, which will enable you to write your own scripts to monitor the health of your application server.</p><p class="calibre8">The most effective tool for monitoring the application server is the command-line interface. However, if you want to spice it up with some typical programming logic, you can resort to some other alternatives such as scripting languages or the raw management API.</p><p class="calibre8">We also explored some of the new, advanced features that were introduced with WildFly. You now know how to restrict access to your management console and how to audit the changes done to the configuration.</p><p class="calibre8">We have now completed our review of management. In the next chapter, we are going to discuss clustering, which is the environment where critical applications are deployed.</p></div></body></html>