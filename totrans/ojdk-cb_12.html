<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;Working with Future Technologies"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Working with Future Technologies</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Building OpenJDK 9 on Mac OS X using Clang</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 9 on Windows using MSYS</li><li class="listitem" style="list-style-type: disc">Running and testing the early access preview of OpenJDK 9</li><li class="listitem" style="list-style-type: disc">Using Jigsaw</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 9 with Graal</li><li class="listitem" style="list-style-type: disc">Building OpenJDK 9 with Sumatra</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec93"/>Introduction</h1></div></div></div><p>Java is often criticized because of some degree of conservatism, where major language changes are concerned. However, the recent Java 8 release has done a lot to relieve the worry that Java will remain conservative and frozen in time.</p><p>However, there are more changes coming. Java 9 is believed to support some long-awaited features that will possibly take it to a completely new market and level of programming.</p><p>In the past, annotations support and generics have caused a revolution in Java programming. The way of thinking was changed, and, while nothing completely new was added to the way Java operates in the low-level design, the high-level design and programming techniques were undoubtedly changed. The result was, for example, a rise in annotation-based frameworks and simpler programming as a whole.</p><p>Java 8 has been released with lambda expressions support, type annotations, and parameter reflection for public use. But it was possible to use it since late 2012, at least. It was possible to have all this functionality, to write programs with all these features, to have fun with testing new technologies, well before the official release date. Some enterprise developers consider modern Java as unstable and slightly unpredictable even after the release. However, each programmer, who was interested in the new technologies' testing and support and who contributes to it, was able to test and try OpenJDK 8 when it was at development stage.</p><p>What is the situation with OpenJDK 9 early access previews were released immediately after the Java 8 release. So we can now try OpenJDK 9. Of course, it is still unstable and doesn't even pass some regression tests, but it is going to change.</p><p>What are the main <a id="id578" class="indexterm"/>differences between OpenJDK 8 and 9?</p><p>There are three main features:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The First is the long awaited elimination of type erasure. With new refined generics, it will be possible to determine which type is used in a collection or map, or a tuple—on every generic reference. For all Java programmers this is going to be a major relief.</li><li class="listitem" style="list-style-type: disc">The second feature is intended to bring the Java platform a new ally—the whole might of a GPU will now be in the hands of a programmer, using only standard features without a scrap of native code. It will be explained further in this chapter.</li><li class="listitem" style="list-style-type: disc">And a third one is Graal, the project that exposes Java VM APIs to the end user. It is a great breakthrough since it is possible to change the way Java operates on the fly.</li></ul></div><p>There is more to be done; Java 9 will also contain less GC types without a drop in performance.</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip22"/>Tip</h3><p>Be aware, underscore (_) will not be a legal identifier name in Java 9, so prepare your code in time. Find more details at <a class="ulink" href="http://openjdk.java.net/jeps/213">http://openjdk.java.net/jeps/213</a>.</p></div></div><p>Also, for those who work with money transactions and financial analytics, there is another Java 9 feature—JSR 354, the Money API. It will implement the ISO-4217 standard currencies along with some additional ones. Currency arithmetics will also be introduced.</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip23"/>Tip</h3><p>To test the<a id="id579" class="indexterm"/> Java Money API, build the source code from <a class="ulink" href="https://github.com/JavaMoney/jsr354-api">https://github.com/JavaMoney/jsr354-api</a>. However, this is a Maven project that meets the JSR requirements, and is not a part of the OpenJDK project.</p></div></div></div></div>
<div class="section" title="Building OpenJDK 9 on Mac OS X using Clang"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec94"/>Building OpenJDK 9 on Mac OS X using Clang</h1></div></div></div><p>At the<a id="id580" class="indexterm"/> time of writing, the OpenJDK 9 project was still quite similar to OpenJDK 8. So most of the information about building OpenJDK 9 can be found in <a class="link" href="ch04.html" title="Chapter 4. Building OpenJDK 8">Chapter 4</a>, <span class="emphasis"><em>Building OpenJDK 8</em></span>.</p><p>One point that <a id="id581" class="indexterm"/>differentiates OpenJDK 9 from OpenJDK 8 is<a id="id582" class="indexterm"/> the usage of the Clang compiler on Mac OS X. Starting with Xcode Version 5, Clang became the official compiler on Mac OS X instead of GCC. There were plans to use it as an official compiler for OpenJDK 8 on Mac OS X but that switch was postponed to OpenJDK 9.</p><p>In this recipe, we will build the current codebase of OpenJDK 9 using Xcode 5 and the Clang compiler.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec299"/>Getting ready</h2></div></div></div><p>For this recipe, we will need a clean Mac OS X 10.8 Mountain Lion or 10.9 Mavericks running with Mercurial source control tools installed.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec300"/>How to do it...</h2></div></div></div><p>The following procedure will help us to build OpenJDK 9:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download <a id="id583" class="indexterm"/>Xcode 5 from <a class="ulink" href="https://developer.apple.com/xcode/">https://developer.apple.com/xcode/</a> (an Apple developer's account is required, registration is free) and install it.</li><li class="listitem">Download the Command Line Tools for the corresponding minor version of Xcode using the same download link mentioned previously, and install it.</li><li class="listitem">Run the following command from the terminal to set up the Command Line Tools:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer/</strong></span>
</pre></div></li><li class="listitem">Install JDK 8—Oracle distribution, or prebuilt OpenJDK binaries may be used.</li><li class="listitem">Obtain the source code from the Mercurial repository:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>hg checkout http://hg.openjdk.java.net/jdk9/jdk9/</strong></span>
<span class="strong"><strong>bash ./get_source.sh</strong></span>
</pre></div></li><li class="listitem">Run the autotools configuration script:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./configure –-with-boot-jdk=path/to/jdk8</strong></span>
</pre></div></li><li class="listitem">Start the build:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make all 2&gt;&amp;1</strong></span>
</pre></div></li><li class="listitem">The built binaries will be put into the following directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>build/macosx-x86_64-normal-server-release/images/j2sdk-image</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec301"/>How it works...</h2></div></div></div><p>Xcode 5 uses the <a id="id584" class="indexterm"/>Clang compiler by default and OpenJDK 9 already has all the<a id="id585" class="indexterm"/> adjustments required for switching compiler from GCC to Clang.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec302"/>There's more...</h2></div></div></div><p>With the older<a id="id586" class="indexterm"/> versions of OpenJDK 9, the installation of the X11 server may be required. The X11 server can be installer from the <span class="emphasis"><em>XQuartz</em></span> project.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec303"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Building OpenJDK 8 on Mac OS X recipe from <a class="link" href="ch04.html" title="Chapter 4. Building OpenJDK 8">Chapter 4</a>, <span class="emphasis"><em>Building OpenJDK 8</em></span></li></ul></div></div></div>
<div class="section" title="Building OpenJDK 9 on Windows using MSYS"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec95"/>Building OpenJDK 9 on Windows using MSYS</h1></div></div></div><p>The <a id="id587" class="indexterm"/>Windows operating system has a long<a id="id588" class="indexterm"/> history of different tools providing a Unix-like environment. Tools such as Microsoft POSIX subsystem, Interix, Windows Services for UNIX, MKS Toolkit, Cygwin, MinGW/MSYS, and so on, existed during the various periods of Windows history and provided different levels of Unix compliance.</p><p>The three<a id="id589" class="indexterm"/> latter tools are most relevant to OpenJDK builds. MKS Toolkit was used for internal builds in Sun Microsystems because it provided better speed than Cygwin. Support for MKS Toolkit was discontinued with OpenJDK 7. Cygwin, that we described in detail in <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span>, was used as the main and only tool to build OpenJDK 7 and 8.</p><p>MSYS (short form for minimal system) is <a id="id590" class="indexterm"/>a part of the MinGW (Minimalist GNU for Windows) project. The MinGW project was started as a fork of Cygwin with the goal to provide closer integration with Windows API for the cost of lower level Unix support. MinGW-based applications are standalone native Windows applications and do not require the <code class="literal">cygwin.dll</code> library. Among other things, this can bring better speed for some applications using Windows API through MinGW instead of emulated Unix calls (like fork) through Cygwin. Applications should be changed accordingly, though.</p><p>The MSYS project provides a minimalistic shell environment and also provides first-class support for running GNU Autoconf based builds. Actually running Autoconf's configure scripts efficiently was one of the goals of MSYS. In some cases, the configure scripts can be extremely slow in Cygwin because of extensive use of new processes spawning.</p><p>Due to better speed in OpenJDK builds, MSYS support was restored in OpenJDK 9 as a second supported environment along with Cygwin.</p><p>In this recipe, we<a id="id591" class="indexterm"/> will build OpenJDK 9 on Windows 7 using MSYS instead of Cygwin. At the time of writing, OpenJDK 9<a id="id592" class="indexterm"/> was still in development and we have used the latest available source code.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec304"/>Getting ready</h2></div></div></div><p>For this recipe, we will need Windows 7 (32- or 64-bit) running.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec305"/>How to do it...</h2></div></div></div><p>The following<a id="id593" class="indexterm"/> procedure will help us to build OpenJDK 9:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download Microsoft .NET Framework 4 from the Microsoft website and install it.</li><li class="listitem">Download Microsoft Windows SDK for Windows 7 (the <code class="literal">GRMSDKX_EN_DVD.iso</code> file) from the Microsoft website and install it to the default location. The .NET Development and Common Utilities components are not required.</li><li class="listitem">Download Visual Studio 2010 Express and install it (C++ variant) to the default location.</li><li class="listitem">Download and install Microsoft DirectX 9.0 SDK (Summer 2004) to the default installation path. Note that this distribution is not available on the Microsoft website anymore. It may be downloaded elsewhere online, the file details are as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>name: dxsdk_sum2004.exe</strong></span>
<span class="strong"><strong>size: 239008008 bytes</strong></span>
<span class="strong"><strong>sha1sum: 73d875b97591f48707c38ec0dbc63982ff45c661</strong></span>
</pre></div></li><li class="listitem">Download the prebuilt FreeType libraries from the <code class="literal">openjdk-unofficial-builds</code> GitHub project (directory <code class="literal">7_64</code>) and put the binaries into the <code class="literal">c:\freetype\lib</code> directory and the header files into the <code class="literal">c:\freetype\include</code> directory.</li><li class="listitem">Install the OpenJDK 8 binaries or Oracle Java 8 into <code class="literal">c:\jdk8</code>.</li><li class="listitem">Download and install the Mercurial SCM tool from the <a class="ulink" href="http://mercurial.selenic.com">mercurial.selenic.com</a> website.</li><li class="listitem">Clone the current development forest of OpenJDK 9 to the <code class="literal">C:\openjdk</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>hg clone http://hg.openjdk.java.net/jdk9/jdk9/</strong></span>
</pre></div></li><li class="listitem">Download the <code class="literal">mingw-get</code> utility (<code class="literal">mingw-get-setup.exe</code>) from <a class="ulink" href="http://mingw.org/">http://mingw.org/</a> and install it to the <code class="literal">C:\MinGW</code> path.</li><li class="listitem">Run the <code class="literal">cmd.exe</code> shell and navigate to the directory.</li><li class="listitem">Run the<a id="id594" class="indexterm"/> following command to revert the installed version of MSYS from the latest one to 1.0.17:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mingw-get install --reinstall --recursive msys-core=1.0.17-1</strong></span>
</pre></div></li><li class="listitem">Run<a id="id595" class="indexterm"/> the following commands to install all required MSYS packages:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mingw-get install msys-zip</strong></span>
<span class="strong"><strong>mingw-get install msys-unzip</strong></span>
<span class="strong"><strong>mingw-get install msys-diffutils</strong></span>
<span class="strong"><strong>mingw-get install msys-file</strong></span>
<span class="strong"><strong>mingw-get install msys-mktemp</strong></span>
<span class="strong"><strong>mingw-get install msys-tar</strong></span>
<span class="strong"><strong>mingw-get install msys-xargs</strong></span>
<span class="strong"><strong>mingw-get install msys-findutils</strong></span>
<span class="strong"><strong>mingw-get install msys-make</strong></span>
</pre></div></li><li class="listitem">Run the<a id="id596" class="indexterm"/> MSYS shell using the <code class="literal">C:\MinGW\msys\1.0\msys.bat</code> file.</li><li class="listitem">Navigate to the <code class="literal">c/openjdk</code> directory and download the source code for all OpenJDK subrepositories with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bash ./get_source.sh</strong></span>
</pre></div></li><li class="listitem">Add a path for the JDK 8 binaries in the <code class="literal">PATH</code> variable:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>export PATH=/c/jdk8/bin:$PATH</strong></span>
</pre></div></li><li class="listitem">Change the filesystem permissions for all source files:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod -R 777 .</strong></span>
</pre></div></li><li class="listitem">Run the configure script specifying path to the FreeType binaries:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./configure --with-freetype=/c/freetype</strong></span>
</pre></div></li><li class="listitem">Start the build process writing the output to the screen and logfile simultaneously:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make | tee make.log</strong></span>
</pre></div></li><li class="listitem">Wait for the build to finish.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec306"/>How it works...</h2></div></div></div><p>At the time of writing, OpenJDK 9 code uses the same toolchain as OpenJDK 8, so the environment setup is similar.</p><p>We use <a id="id597" class="indexterm"/>Version 1.0.17 of MSYS because the regression related<a id="id598" class="indexterm"/> to multicores support appeared in the 1.0.18 Version. This regression is not fixed at the time of writing but will most likely be fixed in the following versions.</p><p>The <code class="literal">mingw-get</code> utility is<a id="id599" class="indexterm"/> a package manager that allows us to install or update the required MSYS packages.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec307"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Installing Cygwin for Windows builds</em></span> recipe from <a class="link" href="ch02.html" title="Chapter 2. Building OpenJDK 6">Chapter 2</a>, <span class="emphasis"><em>Building OpenJDK 6</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building OpenJDK 8 on Windows 7 SP1</em></span> recipe from <a class="link" href="ch04.html" title="Chapter 4. Building OpenJDK 8">Chapter 4</a>, <span class="emphasis"><em>Building OpenJDK 8</em></span></li><li class="listitem" style="list-style-type: disc">The OpenJDK bug related to the restoration of MSYS support in OpenJDK 9 at <a class="ulink" href="https://bugs.openjdk.java.net/browse/JDK-8022177">https://bugs.openjdk.java.net/browse/JDK-8022177</a></li><li class="listitem" style="list-style-type: disc">The OpenJDK mailing list thread about the regression in MSYS 1.0.18 at <a class="ulink" href="http://mail.openjdk.java.net/pipermail/build-dev/2014-August/012917.html">http://mail.openjdk.java.net/pipermail/build-dev/2014-August/012917.html</a></li><li class="listitem" style="list-style-type: disc">The MSYS website at <a class="ulink" href="http://www.mingw.org/wiki/msys">http://www.mingw.org/wiki/msys</a></li><li class="listitem" style="list-style-type: disc">Information about Windows service for Unix at <a class="ulink" href="http://technet.microsoft.com/en-us/library/bb496506.aspx">http://technet.microsoft.com/en-us/library/bb496506.aspx</a></li><li class="listitem" style="list-style-type: disc">The MKS Toolkit website at <a class="ulink" href="http://mkssoftware.com/">http://mkssoftware.com/</a></li><li class="listitem" style="list-style-type: disc">The Cygwin website at <a class="ulink" href="http://cygwin.com/">http://cygwin.com/</a></li></ul></div></div></div>
<div class="section" title="Running and testing the early access preview of OpenJDK 9"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec96"/>Running and testing the early access preview of OpenJDK 9</h1></div></div></div><p>We will get<a id="id600" class="indexterm"/> the newest OpenJDK code available and will test for feature availability. Don't hesitate to try new features, they may be available in the newer releases. Since the OpenJDK 9 release, it will remain the fastest way to give OpenJDK 9 a test. Hopefully, upon the release, the same thing will work for OpenJDK 10.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec308"/>Getting ready</h2></div></div></div><p>You will need an Internet connection. Aside from that, nothing is needed.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec309"/>How to do it...</h2></div></div></div><p>We will download, unpack, and run the latest publicly available full OpenJDK build:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the page <a class="ulink" href="https://jdk9.java.net/">https://jdk9.java.net/</a>.</li><li class="listitem">Download the early access preview, as shown:<div class="mediaobject"><img src="graphics/8405OT_12_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Run an installer.</li><li class="listitem">You<a id="id601" class="indexterm"/> can find out how to install OpenJDK from an archive in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with OpenJDK">Chapter 1</a>, <span class="emphasis"><em>Getting Started with OpenJDK</em></span> of this book.</li></ol></div><p>Test <a id="id602" class="indexterm"/>some interesting features that are already included in the early access JDK. Look at the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>        DatagramSocket socket = new DatagramSocket(4445);</strong></span>
<span class="strong"><strong>        System.out.println(socket.supportedOptions());</strong></span>
</pre></div><p>When executed, you may expect it to return the following string, or something similar:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[SO_SNDBUF, SO_RCVBUF, SO_REUSEADDR, IP_TOS]</strong></span>
</pre></div><p>Although there are some minor improvements and a lot of bug fixes, there are not yet any major changes in the early access preview.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec310"/>How it works...</h2></div></div></div><p>In the source repository on <a class="ulink" href="http://hg.openjdk.java.net/jdk9/jdk9">http://hg.openjdk.java.net/jdk9/jdk9</a>, there are tags, such as <code class="literal">jdk9-b&lt;build number&gt;</code>, which are automatically built into the early access releases. Although there are no nightly builds, you can always build them from source, if you have lots of time and a machine that's powerful enough to start with.</p><p>Don't forget to<a id="id603" class="indexterm"/> update your once installed releases—there will be really major and exciting changes, including those explained next. Sooner or later, developers will come out with Java 9 full, and then there will be time to test it before it becomes production ready.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec311"/>There's more...</h2></div></div></div><p>You can also<a id="id604" class="indexterm"/> build OpenJDK 9 from source:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Clone the source code repository <code class="literal">hg</code> clone at <a class="ulink" href="http://hg.openjdk.java.net/jdk9/jdk9">http://hg.openjdk.java.net/jdk9/jdk9</a></li><li class="listitem">Get the source code of the OpenJDK subprojects:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod 755 ./get_source.sh &amp;&amp; ./get_source.sh</strong></span>
<span class="strong"><strong>cd jigsaw</strong></span>
</pre></div></li><li class="listitem">Then configure the OpenJDK instance to be built:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod 755 ./configure.sh &amp;&amp; ./configure.sh</strong></span>
</pre></div></li><li class="listitem">And, finally, do the build itself:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Make</strong></span>
</pre></div></li><li class="listitem">The final strings of your output will look like this:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>-------------------------</strong></span>
<span class="strong"><strong>Finished building OpenJDK for target 'default'</strong></span>
</pre></div></li></ol></div></div></div>
<div class="section" title="Using Jigsaw"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec97"/>Using Jigsaw</h1></div></div></div><p>Jigsaw is <a id="id605" class="indexterm"/>the brand-new modular system for Java. It brings to mind some existing products, such as Maven or Gradle, but its most interesting feature is the possibility of the modularization of the JDK itself. Jigsaw will allow, upon its full completion, to modularize even some features that was thought as unseparable, such as HotSpot binaries.</p><p>Jigsaw incorporates<a id="id606" class="indexterm"/> proposals about the Java modular system. Modularity means scalability—from small, embedded devices that need only basic functionality and have poor performance, to full-scale data centers with dozens of machines. Some of these goals have already been reached—but Jigsaw presents a universal way to resolve dependencies on all platforms, starting from Java itself.</p><p>Several JEPs are part of Jigsaw:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>JEP 200</strong></span>: This<a id="id607" class="indexterm"/> makes the JDK itself modular</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>JEP 201</strong></span>: This <a id="id608" class="indexterm"/>makes the source code modular</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>JEP 220</strong></span>: This<a id="id609" class="indexterm"/> makes the runtime Java images modular, so they can be loaded in parts</li></ul></div><p>Some information about the progress of the JEPs are found at the following JIRA links:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://bugs.openjdk.java.net/browse/JDK-8051619">https://bugs.openjdk.java.net/browse/JDK-8051619</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://bugs.openjdk.java.net/browse/JDK-8051618">https://bugs.openjdk.java.net/browse/JDK-8051618</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://bugs.openjdk.java.net/browse/JDK-8061971">https://bugs.openjdk.java.net/browse/JDK-8061971</a></li></ul></div><p>Also, the core of Jigsaw is JSR 376—the Java platform Module System.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec312"/>Getting ready</h2></div></div></div><p>You will need Internet access. Also, some experience with Maven, or similar software is desired. Any knowledge about how the build systems work from the inside will be appreciated.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec313"/>How to do it...</h2></div></div></div><p>The following procedure will teach <a id="id610" class="indexterm"/>you how to build Jigsaw-enabled Java:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, let's clone a source repo <code class="literal">hg</code> clone from <a class="ulink" href="http://hg.openjdk.java.net/jigsaw/jigsaw">http://hg.openjdk.java.net/jigsaw/jigsaw</a>.</li><li class="listitem">Then, let's get the source code of the OpenJDK subprojects:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod 755 ./get_source.sh &amp;&amp; ./get_source.sh</strong></span>
<span class="strong"><strong>cd jigsaw</strong></span>
</pre></div></li><li class="listitem">Then configure the OpenJDK instance to be built:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod 755 ./configure &amp;&amp; ./configure</strong></span>
</pre></div></li><li class="listitem">And, finally, do the build itself:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make all</strong></span>
<span class="strong"><strong>-------------------------</strong></span>
<span class="strong"><strong>Finished building OpenJDK for target 'default'</strong></span>
</pre></div></li></ol></div><p>Congratulations, you've built Jigsaw-enabled Java.</p><p>Now, we will do some tests:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's consider the simple <span class="emphasis"><em>helloworld1</em></span> program:<div class="informalexample"><pre class="programlisting">package me.dsmd.jigsawsample
import me.dsmd.helloworldstrings.Strings
public class Main{
  public void main(String [] args){
    System.out.println(Strings.helloworld1());
  }
}</pre></div></li><li class="listitem">It has one class, which is imported from a yet nonexistent package.</li><li class="listitem">Let's create it.<div class="informalexample"><pre class="programlisting">package me.dsmd.helloworldstrings
public class Strings{
  public String helloworld1(){
    return "Hello World";
  }
}</pre></div></li></ol></div><p>Now, we will <a id="id611" class="indexterm"/>try to link it using Jigsaw.</p><p>Jigsaw stores the module declaration in the file named <code class="literal">module-info.java</code>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's create it for those two packages as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>module  me.dsmd.jigsawsample @ 1.0{</strong></span>
<span class="strong"><strong>  requires me.dsmd.helloworldstrings</strong></span>
<span class="strong"><strong>  class me.dsmd.jigsawsample.Main</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>module  me.dsmd.helloworldstrings @ 0.1 {</strong></span>
<span class="strong"><strong>  class me.dsmd.helloworldstrings.Strings</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>These files are to be placed in the root directory of a package.</p></li><li class="listitem">Let's consider a situation when all those modules are placed in the same directory named <code class="literal">src</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>.</strong></span>
<span class="strong"><strong>├── modules</strong></span>
<span class="strong"><strong>└── src</strong></span>
<span class="strong"><strong>    ├── me.dsmd.helloworldstrings</strong></span>
<span class="strong"><strong>    │   ├── me</strong></span>
<span class="strong"><strong>    │   │   └── dsmd</strong></span>
<span class="strong"><strong>    │   │       └── helloworldstrings</strong></span>
<span class="strong"><strong>    │   │           └── Strings.java</strong></span>
<span class="strong"><strong>    │   └── module-info.java</strong></span>
<span class="strong"><strong>    └── me.dsmd.jigsawsample</strong></span>
<span class="strong"><strong>        ├── me</strong></span>
<span class="strong"><strong>        │   └── dsmd</strong></span>
<span class="strong"><strong>        │       └── jigsawsample</strong></span>
<span class="strong"><strong>        │           └── Main.java</strong></span>
<span class="strong"><strong>        └── module-info.java</strong></span>
</pre></div></li><li class="listitem">Then, let's compile them with <code class="literal">javac</code> from your jigsaw build:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>javac -verbose -d modules -modulepath modules -sourcepath \ `find src -name '*.java'`</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec314"/>How it works...</h2></div></div></div><p>Jigsaw is a <a id="id612" class="indexterm"/>modular system that gives Java its very own build system. Similar systems were spawned in the Java world long ago, but they lacked the core support. They were never able to bring the modular support advantages to Java's own features. Of course, there are some downsides as well. The <span class="emphasis"><em>Write once, run everywhere</em></span> slogan is not so applicable as it was before.</p><p>We use the newly built OpenJDK commands to create, install, and export modules. Those commands are still under heavy development, but the specification is already written so, hopefully, nothing will significantly change before the production-access release.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec315"/>There's more...</h2></div></div></div><p>You also can install a<a id="id613" class="indexterm"/> module as a library. To do so, run the following command:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To create a module library:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ jmod -L lib1 create   </strong></span>
</pre></div><p>This creates a module library <code class="literal">lib1</code>.</p></li><li class="listitem" style="list-style-type: disc">To install some modules to the library:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ jmod -L lib1 install modules module1 module2</strong></span>
</pre></div><p>This will install your modules under the system parent in the library <code class="literal">lib1</code>.</p></li></ul></div><p>Currently, there is no way to remove the module from the library. Maybe, there will not be any in the release either. For now, the simplest way to remove a module from the library is to delete it physically from the repository:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>rm -rf lib1/module1</strong></span>
</pre></div><p>Also, you can run a module, if it contains a standard entry point:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>java -L lib1 -m module1</strong></span>
</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip24"/>Tip</h3><p>The new <code class="literal">-m</code> option is also contained only in the Jigsaw-enabled Java command. As of now (June 2014) it is not contained in any public early access preview.</p></div></div><p>As a next feature, you can export a module as a file by performing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>jpkg -m modules/module1 jmod module1</strong></span>
</pre></div><p>The <code class="literal">module1@&lt;module version&gt;.jmod</code> file will be created. It will contain the exported, ready-to-use module.</p></div></div>
<div class="section" title="Building OpenJDK 9 with Graal"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec98"/>Building OpenJDK 9 with Graal</h1></div></div></div><p>As described in the project page, Graal is:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>A quest for the JVM to leverage its own J.</em></span></p></blockquote></div><p>Upon<a id="id614" class="indexterm"/> completion of this project, JVM functions will be exposed <a id="id615" class="indexterm"/>via Java APIs, so the end user will be able to have access to the most low-level manipulation. It will be possible to write a Java compiler in Java, for example. Now, we will try to give it a test.</p><p>There is also <span class="strong"><strong>Truffle</strong></span>, a<a id="id616" class="indexterm"/> framework that allows you to build your own language using Graal VM. It builds upon a notion of an<a id="id617" class="indexterm"/> <span class="strong"><strong>abstract syntax tree</strong></span> (<span class="strong"><strong>AST</strong></span>), and the process, in fact, is really simple. To have a better look, see the following link:</p><p><a class="ulink" href="https://cesquivias.github.io/blog/2014/10/13/writing-a-language-in-truffle-part-1-a-simple-slow-interpreter/">https://cesquivias.github.io/blog/2014/10/13/writing-a-language-in-truffle-part-1-a-simple-slow-interpreter/</a></p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec316"/>Getting ready</h2></div></div></div><p>You will need an Internet connection. Also, it's recommended to read the chapters about building OpenJDK.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec317"/>How to do it...</h2></div></div></div><p>Have a look at the following procedure to build OpenJDK with Graal:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, clone a source repository:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>hg clone http://hg.openjdk.java.net/graal/graal</strong></span>
<span class="strong"><strong>cd graal</strong></span>
<span class="strong"><strong>export EXTRA_JAVA_HOMES=/usr/lib/jvm/java-1.7.0-openjdk</strong></span>
<span class="strong"><strong>./mx.sh build</strong></span>
</pre></div></li><li class="listitem">Enter a selection value, upon which <code class="literal">vm graal</code> will be built. Unfortunately, it will not be built without modification against the OpenJDK 9-ea preview:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./mx.sh build</strong></span>
<span class="strong"><strong>[1] /usr/lib/jvm/java-1.7.0-openjdk</strong></span>
<span class="strong"><strong>[2] /usr/lib/jvm/java-1.6.0-openjdk-amd64</strong></span>
<span class="strong"><strong>[3] /usr/lib/jvm/java-6-oracle</strong></span>
<span class="strong"><strong>[4] /usr/lib/jvm/jdk1.9.0</strong></span>
<span class="strong"><strong>[5] /usr/lib/jvm/java-7-oracle</strong></span>
<span class="strong"><strong>[6] /usr/lib/jvm/java-8-oracle</strong></span>
<span class="strong"><strong>[7] /usr/lib/jvm/java-6-openjdk-amd64</strong></span>
<span class="strong"><strong>[8] /usr/lib/jvm/java-7-openjdk-amd64</strong></span>
<span class="strong"><strong>[9] /usr/lib/jvm/java-1.7.0-openjdk-amd64</strong></span>
<span class="strong"><strong>[10] &lt;other&gt;</strong></span>
</pre></div></li><li class="listitem">Then<a id="id618" class="indexterm"/> choose which VM will be executed. There<a id="id619" class="indexterm"/> are two types of VM. In a nutshell, <code class="literal">server vm</code> will use the default hotspot compilation, using Graal itself only for explicit Graal API calls, while <code class="literal">graal VM</code> will compile everything through Graal. The first option is much more suitable for production VMs, while the second is favorable for testing purposes.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Please select the VM to be executed from the following:</strong></span>
<span class="strong"><strong>[1] server - Normal compilation is performed with a tiered system (C1</strong></span>
<span class="strong"><strong>    + C2), Truffle compilation is performed with Graal. Use this for</strong></span>
<span class="strong"><strong>    optimal Truffle performance.</strong></span>
<span class="strong"><strong>[2] graal - Normal compilation is performed with a tiered system (C1 +</strong></span>
<span class="strong"><strong>    Graal), Truffle compilation is performed with Graal.</strong></span>
</pre></div></li><li class="listitem">Then, make a cup of tea, the process may take several dozen minutes.</li><li class="listitem">Then, if you want to initialize your IDE project , run <code class="literal">./mx.sh ideinit</code>.</li><li class="listitem">Then, open your favorite IDE and open a resulting project. It will be shown here with IntelliJ Idea:<div class="mediaobject"><img src="graphics/8405OT_12_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Explore various tests.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec318"/>How it works...</h2></div></div></div><p>The Graal <a id="id620" class="indexterm"/>enabled <a id="id621" class="indexterm"/>VM will expose Java APIs to the end user.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec319"/>There's more...</h2></div></div></div><p>In <a class="link" href="ch08.html" title="Chapter 8. Hacking OpenJDK">Chapter 8</a>, <span class="emphasis"><em>Hacking OpenJDK</em></span>, we added new intrinsics to the HotSpot, using the crc32 calculation as an example. In the Graal project, there is a similar test, which tests the compiled substitution of the <code class="literal">CRC32#updateByteBuffer</code> method. It is contained in the <code class="literal">com.oracle.graal.hotspot.jdk8.test</code> package. Run it, and enjoy the performance change.</p></div></div>
<div class="section" title="Building OpenJDK 9 with Sumatra"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec99"/>Building OpenJDK 9 with Sumatra</h1></div></div></div><p>For a <a id="id622" class="indexterm"/>long time, Java was considered as a primarily backend tool, due<a id="id623" class="indexterm"/> to its cross-platform vectoring. Only J2ME was capable of achieving long-term superiority in the mobile segment. But now it's going to change. Project Sumatra has the aim of delivering GPU-calculation standards to the Java guys.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec320"/>Getting ready</h2></div></div></div><p>You will probably need a GPU that supports CUDA and OpenGL, or a HSAIL simulator running (because on-board GPUs do not support native GPU languages).</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec321"/>How to do it...</h2></div></div></div><p>Sumatra developers<a id="id624" class="indexterm"/> are making wide use of the Graal project, described earlier. The build consists of <a id="id625" class="indexterm"/>two stages. Firstly, the Sumatra JDK is built, like a normal OpenJDK build, as shown:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make</strong></span>
<span class="strong"><strong>Building OpenJDK for target 'default' in configuration 'linux-x86_64-normal-server-release'</strong></span>

<span class="strong"><strong>## Starting langtools</strong></span>
<span class="strong"><strong>## Finished langtools (build time 00:00:03)</strong></span>

<span class="strong"><strong>## Starting hotspot</strong></span>
<span class="strong"><strong>## Finished hotspot (build time 00:00:01)</strong></span>

<span class="strong"><strong>## Starting corba</strong></span>
<span class="strong"><strong>## Finished corba (build time 00:00:00)</strong></span>

<span class="strong"><strong>## Starting jaxp</strong></span>
<span class="strong"><strong>## Finished jaxp (build time 00:00:01)</strong></span>

<span class="strong"><strong>## Starting jaxws</strong></span>
<span class="strong"><strong>## Finished jaxws (build time 00:00:02)</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>## Starting jdk</strong></span>
<span class="strong"><strong>## Finished jdk (build time 00:00:21)</strong></span>

<span class="strong"><strong>----- Build times -------</strong></span>
<span class="strong"><strong>Start 2014-07-06 00:17:24</strong></span>
<span class="strong"><strong>End   2014-07-06 00:17:52</strong></span>
<span class="strong"><strong>00:00:00 corba</strong></span>
<span class="strong"><strong>00:00:01 hotspot</strong></span>
<span class="strong"><strong>00:00:01 jaxp</strong></span>
<span class="strong"><strong>00:00:02 jaxws</strong></span>
<span class="strong"><strong>00:00:21 jdk</strong></span>
<span class="strong"><strong>00:00:03 langtools</strong></span>
<span class="strong"><strong>00:00:28 TOTAL</strong></span>
<span class="strong"><strong>-------------------------</strong></span>
<span class="strong"><strong>Finished building OpenJDK for target 'default'</strong></span>
</pre></div><p>The second stage consists of building a Graal JDK on top of the Sumatra JDK. It may be tricky, but hopefully it will work:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Clone a repository <code class="literal">hg</code> clone <a class="ulink" href="http://hg.openjdk.java.net/sumatra/sumatra-dev/">http://hg.openjdk.java.net/sumatra/sumatra-dev/</a>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod 755 configure &amp;&amp; ./configure</strong></span>
</pre></div></li><li class="listitem">Get the source code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod 755 get_source.sh &amp;&amp; ./get_source.sh</strong></span>
</pre></div></li><li class="listitem">Then make the source code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>make</strong></span>
</pre></div></li><li class="listitem">Export <code class="literal">JAVA_HOME</code> to the newly built OpenJDK instance:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>export JAVA_HOME=&lt;path-to-sumatra-dev&gt;/build/linux-&lt;your-arch&gt;-normal-server-release/images/j2sdk-image</strong></span>
</pre></div></li><li class="listitem">Build the HSAIL-enabled grail:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>/mx.sh --vmbuild product --vm server build</strong></span>
</pre></div></li></ol></div><p>Congratulations! You <a id="id626" class="indexterm"/>have a Sumatra-enabled VM.</p><p>Let's do a little <a id="id627" class="indexterm"/>test. Consider a code from an official sample:</p><div class="informalexample"><pre class="programlisting">package simple;

import java.util.stream.IntStream;

public class Simple {

    public static void main(String[] args) {
        final int length = 8;
        int[] ina = new int[length];
        int[] inb = new int[length];
        int[] out = new int[length];

        // Initialize the input arrays - this is offloadable
        IntStream.range(0, length).parallel().forEach(p -&gt; {
            ina[p] = 1;
            inb[p] = 2;
        });

        // Sum each pair of elements into out[] - this is offloadable
        IntStream.range(0, length).parallel().forEach(p -&gt; {
            out[p] = ina[p] + inb[p];
        });

        // Print results - this is not offloadable since it is
        // calling native code etc.
        IntStream.range(0, length).forEach(p -&gt; {
            System.out.println(out[p] + ", " + ina[p] + ", " + inb[p]);
        });
    }
}</pre></div><p>It contains two <a id="id628" class="indexterm"/>off-loadable lambdas. We will try to make them run in parallel, using the <code class="literal">HSA</code> API.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, set <code class="literal">JAVA_HOME</code> to the Graal JDK:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>export JAVA_HOME=/path/to/graal/jdk1.8.0-internal/product/</strong></span>
</pre></div></li><li class="listitem">Then clone the <code class="literal">OKRA HSA</code> interface:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git clone https://github.com/HSAFoundation/Okra-Interface-to-HSA-Device.git</strong></span>
</pre></div></li><li class="listitem">Make it runnable:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>export PATH=$PATH:/path/to/okra/dist/bin</strong></span>
<span class="strong"><strong>export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/path/to/okra/dist/bin</strong></span>
</pre></div></li><li class="listitem">Run <a id="id629" class="indexterm"/>the example with and without offloading.</li><li class="listitem">You will get the following code in your terminal:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$JAVA_HOME/bin/java -server -esa -XX:+TraceGPUInteraction -Dcom.amd.sumatra.offload.immediate=true -G:Log=CodeGen  simple.Simple</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>[HSAIL] library is libokra_x86_64.so</strong></span>
<span class="strong"><strong>[GPU] registered initialization of Okra (total initialized: 2)</strong></span>
<span class="strong"><strong>[CUDA] Ptx::get_execute_kernel_from_vm_address</strong></span>
<span class="strong"><strong>[thread:1] scope:</strong></span>
<span class="strong"><strong>  [thread:1] scope: GraalCompiler</strong></span>
<span class="strong"><strong>    [thread:1] scope: GraalCompiler.CodeGen</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    version 0:95: $full : $large;    </strong></span>
<span class="strong"><strong>// static method HotSpotMethod&lt;Simple.lambda$main$0(int[], int[], int)&gt;    </strong></span>
<span class="strong"><strong>kernel &amp;run (    </strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg0,</strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg1</strong></span>
<span class="strong"><strong>    ) {</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d0, [%_arg0];</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d1, [%_arg1];</strong></span>
<span class="strong"><strong>    workitemabsid_u32 $s0, 0;</strong></span>
<span class="strong"><strong>                                       </strong></span>
<span class="strong"><strong>@L0:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d1, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L1;</strong></span>
<span class="strong"><strong>@L2:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d1 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L8;</strong></span>
<span class="strong"><strong>@L3:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d0, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L4;</strong></span>
<span class="strong"><strong>@L5:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d0 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L7;</strong></span>
<span class="strong"><strong>@L6:</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d2, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d2, $d2, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d0, $d0, $d2;</strong></span>
<span class="strong"><strong>    st_global_s32 1, [$d0 + 16];</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d0, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d0, $d0, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d1, $d1, $d0;</strong></span>
<span class="strong"><strong>    st_global_s32 2, [$d1 + 16];</strong></span>
<span class="strong"><strong>    ret;</strong></span>
<span class="strong"><strong>@L1:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -6155;</strong></span>
<span class="strong"><strong>@L9:</strong></span>
<span class="strong"><strong>    ret;</strong></span>
<span class="strong"><strong>@L4:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -4363;</strong></span>
<span class="strong"><strong>    brn @L9;</strong></span>
<span class="strong"><strong>@L8:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -6683;</strong></span>
<span class="strong"><strong>    brn @L9;</strong></span>
<span class="strong"><strong>@L7:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -4891;</strong></span>
<span class="strong"><strong>    brn @L9;</strong></span>
<span class="strong"><strong>};    </strong></span>

<span class="strong"><strong>[HSAIL] heap=0x00007f4c9801de38</strong></span>
<span class="strong"><strong>[HSAIL] base=0x05a00000, capacity=209190912</strong></span>
<span class="strong"><strong>External method:simple.Simple.lambda$main$0([I[II)V</strong></span>
<span class="strong"><strong>installCode0: ExternalCompilationResult</strong></span>
<span class="strong"><strong>[HSAIL] sig:([I[II)V  args length=2, _parameter_count=3</strong></span>
<span class="strong"><strong>[HSAIL] static method</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=0, 0x82b20888, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=1, 0x82b208b8, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::not pushing trailing int</strong></span>
<span class="strong"><strong>  [thread:1] scope: GraalCompiler</strong></span>
<span class="strong"><strong>    [thread:1] scope: GraalCompiler.CodeGen</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    version 0:95: $full : $large;    </strong></span>
<span class="strong"><strong>// static method HotSpotMethod&lt;Simple.lambda$main$1(int[], int[], int[], int)&gt;    </strong></span>
<span class="strong"><strong>kernel &amp;run (    </strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg0,</strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg1,</strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg2</strong></span>
<span class="strong"><strong>    ) {</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d0, [%_arg0];</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d1, [%_arg1];</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d2, [%_arg2];</strong></span>
<span class="strong"><strong>    workitemabsid_u32 $s0, 0;</strong></span>
<span class="strong"><strong>                                       </strong></span>
<span class="strong"><strong>@L0:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d0, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L1;</strong></span>
<span class="strong"><strong>@L2:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d0 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L12;</strong></span>
<span class="strong"><strong>@L3:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d2, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L4;</strong></span>
<span class="strong"><strong>@L5:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d2 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L11;</strong></span>
<span class="strong"><strong>@L6:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d1, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L7;</strong></span>
<span class="strong"><strong>@L8:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d1 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L10;</strong></span>
<span class="strong"><strong>@L9:</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d3, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d3, $d3, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d1, $d1, $d3;</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d1 + 16];</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d1, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d1, $d1, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d2, $d2, $d1;</strong></span>
<span class="strong"><strong>    ld_global_s32 $s2, [$d2 + 16];</strong></span>
<span class="strong"><strong>    add_s32 $s2, $s2, $s1;</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d1, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d1, $d1, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d0, $d0, $d1;</strong></span>
<span class="strong"><strong>    st_global_s32 $s2, [$d0 + 16];</strong></span>
<span class="strong"><strong>    ret;</strong></span>
<span class="strong"><strong>@L1:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -7691;</strong></span>
<span class="strong"><strong>@L13:</strong></span>
<span class="strong"><strong>    ret;</strong></span>
<span class="strong"><strong>@L4:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -6411;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L10:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -5403;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L7:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -4875;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L12:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -8219;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L11:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -6939;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>};    </strong></span>
<span class="strong"><strong>[HSAIL] heap=0x00007f4c9801de38</strong></span>
<span class="strong"><strong>[HSAIL] base=0x05a00000, capacity=209190912</strong></span>
<span class="strong"><strong>External method:simple.Simple.lambda$main$1([I[I[II)V</strong></span>
<span class="strong"><strong>installCode0: ExternalCompilationResult</strong></span>
<span class="strong"><strong>[HSAIL] sig:([I[I[II)V  args length=3, _parameter_count=4</strong></span>
<span class="strong"><strong>[HSAIL] static method</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=0, 0x82b208f8, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=1, 0x82b20888, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=2, 0x82b208b8, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::not pushing trailing int</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
<span class="strong"><strong>3, 1, 2</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec322"/>How it works...</h2></div></div></div><p>Sumatra<a id="id630" class="indexterm"/> runs on top of the Graal project. Since all operations with GPU are implemented on the VM level, Sumatra uses Graal to gain access to them. Sumatra features are at the heavy development stage, and they are subject to various unpredictable changes.</p><p>But the end user can use some of them, even now, to gain a new level of Java productivity at the expense of some compatibility and standardization.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec323"/>There's more...</h2></div></div></div><p>In the Graal suite, there<a id="id631" class="indexterm"/> is a possibility to test the Sumatra HSAIL feature.</p><p>To do so, run the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./mx.sh --vm server unittest -XX:+TraceGPUInteraction -XX:+GPUOffload -G:Log=CodeGen hsail.test.IntAddTest</strong></span>
</pre></div><p>The output should look like the following (for Linux Mint 15, or for other distributions\OS, results may slightly differ):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong> [HSAIL] library is libokra_x86_64.so</strong></span>
<span class="strong"><strong>[HSAIL] using _OKRA_SIM_LIB_PATH_=/tmp/okraresource.dir_2488167353114811077/libokra_x86_64.so</strong></span>
<span class="strong"><strong>[GPU] registered initialization of Okra (total initialized: 2)</strong></span>
<span class="strong"><strong>[CUDA] Ptx::get_execute_kernel_from_vm_address</strong></span>
<span class="strong"><strong>JUnit version 4.8</strong></span>
<span class="strong"><strong>.[thread:1] scope:</strong></span>
<span class="strong"><strong>  [thread:1] scope: GraalCompiler</strong></span>
<span class="strong"><strong>    [thread:1] scope: GraalCompiler.CodeGen</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    Nothing to do here</strong></span>
<span class="strong"><strong>    version 0:95: $full : $large;</strong></span>
<span class="strong"><strong>// static method HotSpotMethod&lt;IntAddTest.run(int[], int[], int[], int)&gt;</strong></span>
<span class="strong"><strong>kernel &amp;run (</strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg0,</strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg1,</strong></span>
<span class="strong"><strong>    align 8 kernarg_u64 %_arg2</strong></span>
<span class="strong"><strong>    ) {</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d0, [%_arg0];</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d1, [%_arg1];</strong></span>
<span class="strong"><strong>    ld_kernarg_u64  $d2, [%_arg2];</strong></span>
<span class="strong"><strong>    workitemabsid_u32 $s0, 0;</strong></span>
<span class="strong"><strong>@L0:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d0, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L1;</strong></span>
<span class="strong"><strong>@L2:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d0 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L12;</strong></span>
<span class="strong"><strong>@L3:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d2, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L4;</strong></span>
<span class="strong"><strong>@L5:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d2 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L11;</strong></span>
<span class="strong"><strong>@L6:</strong></span>
<span class="strong"><strong>    cmp_eq_b1_u64 $c0, $d1, 0; // null test</strong></span>
<span class="strong"><strong>    cbr $c0, @L7;</strong></span>
<span class="strong"><strong>@L8:</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d1 + 12];</strong></span>
<span class="strong"><strong>    cmp_ge_b1_u32 $c0, $s0, $s1;</strong></span>
<span class="strong"><strong>    cbr $c0, @L10;</strong></span>
<span class="strong"><strong>@L9:</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d3, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d3, $d3, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d1, $d1, $d3;</strong></span>
<span class="strong"><strong>    ld_global_s32 $s1, [$d1 + 16];</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d1, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d1, $d1, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d2, $d2, $d1;</strong></span>
<span class="strong"><strong>    ld_global_s32 $s2, [$d2 + 16];</strong></span>
<span class="strong"><strong>    add_s32 $s2, $s2, $s1;</strong></span>
<span class="strong"><strong>    cvt_s64_s32 $d1, $s0;</strong></span>
<span class="strong"><strong>    mul_s64 $d1, $d1, 4;</strong></span>
<span class="strong"><strong>    add_u64 $d0, $d0, $d1;</strong></span>
<span class="strong"><strong>    st_global_s32 $s2, [$d0 + 16];</strong></span>
<span class="strong"><strong>    ret;</strong></span>
<span class="strong"><strong>@L1:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -7691;</strong></span>
<span class="strong"><strong>@L13:</strong></span>
<span class="strong"><strong>    ret;</strong></span>
<span class="strong"><strong>@L4:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -6411;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L10:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -5403;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L7:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -4875;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L12:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -8219;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>@L11:</strong></span>
<span class="strong"><strong>    mov_b32 $s0, -6939;</strong></span>
<span class="strong"><strong>    brn @L13;</strong></span>
<span class="strong"><strong>};</strong></span>

<span class="strong"><strong>[HSAIL] heap=0x00007f95b8019cc0</strong></span>
<span class="strong"><strong>[HSAIL] base=0x05a00000, capacity=210763776</strong></span>
<span class="strong"><strong>External method:com.oracle.graal.compiler.hsail.test.IntAddTest.run([I[I[II)V</strong></span>
<span class="strong"><strong>installCode0: ExternalCompilationResult</strong></span>
<span class="strong"><strong>[HSAIL] sig:([I[I[II)V args length=3, _parameter_count=4</strong></span>
<span class="strong"><strong>[HSAIL] static method</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=0, 0x82b21970, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=1, 0x82b477f0, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::do_array, _index=2, 0x82b479e0, is a [I</strong></span>
<span class="strong"><strong>[HSAIL] HSAILKernelArguments::not pushing trailing int</strong></span>

<span class="strong"><strong>Time: 0.153</strong></span>

<span class="strong"><strong>OK (1 test)</strong></span>
</pre></div><p>The completion <a id="id632" class="indexterm"/>of this test will mean that the HSAIL functions are working OK, so the cutting-edge Java already benefits from your GPU.</p></div></div></body></html>