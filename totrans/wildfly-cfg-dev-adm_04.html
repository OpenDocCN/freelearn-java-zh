<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;The Undertow Web Server"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. The Undertow Web Server</h1></div></div></div><p>In this chapter, we are going to look at how to configure Undertow, the web server shipped with WildFly 8. This will complete our overview of the standalone server configuration.</p><p>We will then look at the structure of a typical enterprise application by creating, packaging, and deploying a sample Java EE 7 project. It will include JavaServer Faces components, Enterprise JavaBeans, and CDI, and will also use the<a id="id436" class="indexterm"/> <span class="strong"><strong>Java Persistence API</strong></span> (<span class="strong"><strong>JPA</strong></span>). This will give you a feel of working with a complete Java EE 7 application.</p><p>By the end of this chapter, you will have learned about:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The architecture of Undertow</li><li class="listitem" style="list-style-type: disc">The Undertow host configuration</li><li class="listitem" style="list-style-type: disc">Serving static content</li><li class="listitem" style="list-style-type: disc">The servlet container configuration</li><li class="listitem" style="list-style-type: disc">The JSP configuration</li><li class="listitem" style="list-style-type: disc">Configuration of session cookies</li><li class="listitem" style="list-style-type: disc">How to create a simple web application</li></ul></div><div class="section" title="An overview of Undertow"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec19"/>An overview of Undertow</h1></div></div></div><p>Those <a id="id437" class="indexterm"/>of you who have worked with previous versions of WildFly will know that historically, JBoss has always included Tomcat, or a fork of Tomcat (named JBoss Web), as the application server's web container.</p><p>The decision to replace JBoss Web came about as a new web container was required, one that supports new Java EE 7 requirements, such as web sockets and an HTTP upgrade. It was also decided that the new web server should be lightweight and flexible, and have better performance. The resulting server is super responsive, can scale to over a million connections, and has exceptional throughput.</p><div class="section" title="The Undertow architecture"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec49"/>The Undertow architecture</h2></div></div></div><p>Undertow <a id="id438" class="indexterm"/>is written in Java and based on the<a id="id439" class="indexterm"/> <span class="strong"><strong>Non-blocking Input/Output</strong></span> API (often referred<a id="id440" class="indexterm"/> to as <span class="strong"><strong>New Input/Output</strong></span> or just <a id="id441" class="indexterm"/>
<span class="strong"><strong>NIO</strong></span>). With a composition-based architecture and built using a fluent builder API, Undertow can be easily configured, giving you as much or as little functionality as you need. By chaining handlers together, you can build anything from a simple HTTP handler to a full Java EE 3.1 container.</p><p>There are three core parts that make up the Undertow server:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>XNIO worker instances</strong></span>: These <a id="id442" class="indexterm"/>instances form a thin abstraction layer over Java NIO, providing a channel API, management of IO and worker threads, and SSL support.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Listeners</strong></span>: These<a id="id443" class="indexterm"/> handle incoming connections and the underlying protocol.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Handlers</strong></span>: These <a id="id444" class="indexterm"/>are chained together to provide the main functionality for Undertow. They define how incoming requests are handled.</li></ul></div><p>The following diagram <a id="id445" class="indexterm"/>shows how these components fit together to create the web server, and demonstrates how the handlers are chained together:</p><div class="mediaobject"><img src="graphics/6232OS_04_01.jpg" alt="The Undertow architecture"/></div></div><div class="section" title="Configuring Undertow"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec50"/>Configuring Undertow</h2></div></div></div><p>In this section, we <a id="id446" class="indexterm"/>are going to look at how to configure the different components of Undertow. Undertow is configured within the Undertow subsystem found in the <code class="literal">standalone.xml</code> file. Here's an extract from the Undertow subsystem:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;buffer-cache name="default"/&gt;
    &lt;server name="default-server"&gt;
        &lt;http-listener name="default" socket-binding="http"/&gt;
        &lt;host name="default-host" alias="localhost"&gt;
            &lt;location name="/" handler="welcome-content"/&gt;
            &lt;filter-ref name="server-header"/&gt;
            &lt;filter-ref name="x-powered-by-header"/&gt;
        &lt;/host&gt;
    &lt;/server&gt;
    &lt;servlet-container name="default"&gt;
        &lt;jsp-config/&gt;
    &lt;/servlet-container&gt;
    &lt;handlers&gt;
        &lt;file name="welcome-content" path="${jboss.home.dir}/welcome-content"/&gt;
    &lt;/handlers&gt;
    ...
&lt;/subsystem&gt;</pre></div><p>The majority<a id="id447" class="indexterm"/> of the Undertow web server is configured within the <code class="literal">server</code> and <code class="literal">servlet-container</code> elements, both of which we are going to look at next.</p></div><div class="section" title="Configuring the server"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec51"/>Configuring the server</h2></div></div></div><p>Within the <a id="id448" class="indexterm"/>
<code class="literal">server</code> element, you<a id="id449" class="indexterm"/> can configure hosts and listeners. The attributes to configure your main<a id="id450" class="indexterm"/> server<a id="id451" class="indexterm"/> instance are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Name</p>
</th><th style="text-align: left" valign="bottom">
<p>Meaning</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">default-host</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the virtual host to be used if a request has a no host header</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">servlet-container</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the servlet container to be used, as configured in the <code class="literal">servlet-container</code> element</p>
</td></tr></tbody></table></div><div class="section" title="Configuring the listener"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec31"/>Configuring the listener</h3></div></div></div><p>As we <a id="id452" class="indexterm"/>stated earlier, Undertow is made up of listeners and handlers. The listeners are configured within the <code class="literal">server</code> element, as highlighted in the following code. The default configuration in the <code class="literal">standalone.xml</code> file has just a single connector defined, which is the HTTP connector:</p><div class="informalexample"><pre class="programlisting">&lt;server name="default-server"&gt;
    <span class="strong"><strong>&lt;http-listener name="default" socket-binding="http"/&gt;</strong></span>
    &lt;host name="default-host" alias="localhost"&gt;
        &lt;location name="/" handler="welcome-content"/&gt;
        &lt;filter-ref name="server-header"/&gt;
        &lt;filter-ref name="x-powered-by-header"/&gt;
    &lt;/host&gt;
&lt;/server&gt;</pre></div><p>Notice that the <code class="literal">socket-binding</code> attribute<a id="id453" class="indexterm"/> points to a configuration defined in the <code class="literal">socket-binding-group</code> section:</p><div class="informalexample"><pre class="programlisting">&lt;socket-binding-group name="standard-sockets" default-interface="public"&gt;
    &lt;socket-binding name="<span class="strong"><strong>http</strong></span>" port="8080"/&gt;
&lt;/socket-binding-group&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>WildFly also supports AJP and HTTPS connection protocols; we will cover these in detail in <a class="link" href="ch09.html" title="Chapter 9. Load-balancing Web Applications">Chapter 9</a>, <span class="emphasis"><em>Load-balancing Web Applications</em></span> and <a class="link" href="ch10.html" title="Chapter 10. Securing WildFly">Chapter 10</a>, <span class="emphasis"><em>Securing WildFly</em></span>, respectively.</p></div></div><p>There are a lot <a id="id454" class="indexterm"/>of options when it comes to the configuration of the listener. The attributes for the HTTP listener element are outlined as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Default value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">allow-encoded-slash</code>
</p>
</td><td style="text-align: left" valign="top">
<p>When <a id="id455" class="indexterm"/>set to true, this property allows the server to decode percent-encoded slash characters (%2F). Only enable this option if you have a legacy application that requires it, as it can have security implications due to different servers interpreting the slash differently.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">false</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">always-set-keep-alive</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id456" class="indexterm"/>property determines whether the <code class="literal">Connection: keep-alive</code> header should be added to all responses, even if not required by spec.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">true</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">buffer-pipelined-data</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id457" class="indexterm"/>property determines whether responses to HTTP pipelined requests should be buffered and sent out in a single write. This can improve performance if the HTTP pipelining is in use and responses are small.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">true</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">buffer-pool</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id458" class="indexterm"/>property references a buffer pool as defined in the I/O subsystem, which is used internally to read and write requests. In general, these should be at least 8 KB, unless you are in a memory-constrained environment.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">default</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">certificate-forwarding</code>
</p>
</td><td style="text-align: left" valign="top">
<p>If this<a id="id459" class="indexterm"/> property is enabled, then the listener will take the certificate from the <code class="literal">SSL_CLIENT_CERT</code> attribute. This property should only be enabled if the client is behind a proxy and the proxy is configured to always set these headers.</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">decode-url</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id460" class="indexterm"/>property determines whether the URL should be decoded. If this property is set to <code class="literal">false</code>, the percent-encoded characters in the URL will be left as is.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">true</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">enabled</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id461" class="indexterm"/>property states whether this listener is enabled</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">true</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-cookies</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id462" class="indexterm"/> property defines the maximum number of cookies allowed. If a client sends more cookies than this value, the connection will be closed. This exists to prevent DOS attacks based on hash collision.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">200</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-header-size</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id463" class="indexterm"/> property defines the maximum allowed HTTP header block size in bytes. Any request header with a value greater than this will be closed.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">5120</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-headers</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id464" class="indexterm"/>property defines the maximum number of headers allowed. It exists to prevent DOS attacks based on hash collision.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">200</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-parameters</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id465" class="indexterm"/> property defines the maximum number of query or path parameters allowed. If more parameters are sent, the connection will be closed. It exists to prevent DOS attacks based on hash collision.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">1000</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-post-size</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id466" class="indexterm"/>property defines the maximum size allowed for incoming post requests.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">0</code> (unlimited)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id467" class="indexterm"/>property defines the name given to the listener.</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">proxy-address-forwarding</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id468" class="indexterm"/> property enables <code class="literal">x-forwarded-host</code> and similar headers and sets a remote IP address and hostname.</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">redirect-socket</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id469" class="indexterm"/>property, when enabled, automatically redirects a request to the specified socket binding port if the listener supports non-SSL requests and a request is received for which a matching security constraint requires SSL transport.</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">socket-binding</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id470" class="indexterm"/> property determines the address and port the listener listens on.</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">url-charset</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id471" class="indexterm"/>property defines the charset to decode the URL to.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">UTF-8</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">worker</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id472" class="indexterm"/>property references an XNIO worker as defined in the IO subsystem. The worker that is in use controls the IO and blocking thread pool.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">default</code>
</p>
</td></tr></tbody></table></div></div><div class="section" title="Configuring the host"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec32"/>Configuring the host</h3></div></div></div><p>The <a id="id473" class="indexterm"/>host configuration within the <code class="literal">server</code> element corresponds to a<a id="id474" class="indexterm"/> virtual host and is nested directly under the <code class="literal">server</code> element, as shown in the following code. Virtual hosts allow you to group web applications according to the DNS names by which a machine running WildFly is known.</p><div class="informalexample"><pre class="programlisting">&lt;server name="default-server"&gt;
    ...
    <span class="strong"><strong>&lt;host name="default-host" alias="localhost"&gt;</strong></span>
        &lt;location name="/" handler="welcome-content"/&gt;
        &lt;filter-ref name="server-header"/&gt;
        &lt;filter-ref name="x-powered-by-header"/&gt;
    &lt;/host&gt;
&lt;/server&gt;</pre></div><p>The elements nested within the host are explained here:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">location</code>: This <a id="id475" class="indexterm"/>element <a id="id476" class="indexterm"/>defines the URL path to the content, such as <code class="literal">welcome-content</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">access-log</code>: This <a id="id477" class="indexterm"/>element <a id="id478" class="indexterm"/>allows you to configure the location and format of the access log.</li><li class="listitem" style="list-style-type: disc"><code class="literal">filter-ref</code>: This<a id="id479" class="indexterm"/> element defines the filters that are applied to the current host.</li><li class="listitem" style="list-style-type: disc"><code class="literal">single-sign-on</code>: This <a id="id480" class="indexterm"/>element <a id="id481" class="indexterm"/>allows you to configure the cookies to use for authentication.</li></ul></div><p>The access log <a id="id482" class="indexterm"/>can be fully configured by changing the default attributes, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;access-log directory="${jboss.server.log.dir}" pattern="common" prefix="access_log" rotate="true" suffix=".log" worker="default"/&gt;</pre></div><p>The <a id="id483" class="indexterm"/>
<code class="literal">filter-ref</code> element states the filters applied by referencing the name of the filters defined in the <code class="literal">filters</code> element, as shown in the following highlighted code:</p><div class="informalexample"><pre class="programlisting">&lt;server name="default-server"&gt;
    &lt;host name="default-host" alias="localhost"&gt;
        &lt;location name="/" handler="welcome-content"/&gt;
        &lt;filter-ref name="<span class="strong"><strong>server-header</strong></span>"/&gt;
        &lt;filter-ref name="<span class="strong"><strong>x-powered-by-header</strong></span>"/&gt;
    &lt;/host&gt;
&lt;/server&gt;
&lt;filters&gt;
    &lt;response-header name="<span class="strong"><strong>server-header</strong></span>" header-name="Server" header-value="Wildfly 8"/&gt;
    &lt;response-header name="<span class="strong"><strong>x-powered-by-header</strong></span>" header-name="X-Powered-By" header-value="Undertow 1"/&gt;
&lt;/filters&gt;</pre></div></div><div class="section" title="Serving static content"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec33"/>Serving static content</h3></div></div></div><p>You may <a id="id484" class="indexterm"/>not want to deploy all your static content with your application. These may be images, PDF documents, or other types of files. You can configure Undertow to look for these files on the local filesystem. This example shows you how to do this by adding a file handler and location to the Undertow subsystem:</p><div class="informalexample"><pre class="programlisting">&lt;server name="default-server"&gt;
    &lt;http-listener name="default" socket-binding="http"/&gt;
    &lt;host name="default-host" alias="localhost"&gt;
        &lt;location name="/" handler="welcome-content"/&gt;
        <span class="strong"><strong>&lt;location name="/img" handler="images"/&gt;</strong></span>
    &lt;/host&gt;
&lt;/server&gt;
&lt;handlers&gt;
    &lt;file name="welcome-content" path="${jboss.home.dir}/welcome-content" directory-listing="true"/&gt;
    <span class="strong"><strong>&lt;file name="images" path="/var/images" directory-listing="true"/&gt;</strong></span>
&lt;/handlers&gt;</pre></div><p>With this additional configuration, any request for resources to <code class="literal">www.yourdomain.com/contextroot/img</code> will be redirected to the filesystem on your hard disk.</p></div></div><div class="section" title="Configuring the servlet container"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec52"/>Configuring the servlet container</h2></div></div></div><p>An <a id="id485" class="indexterm"/>instance <a id="id486" class="indexterm"/>of a servlet container is defined within a single <code class="literal">servlet-container</code> element. You can have more than one <code class="literal">servlet-container</code> element if you wish to have multiple <a id="id487" class="indexterm"/>servlet containers; however, for most setups, a single instance will suffice. The default configuration in <code class="literal">standalone.xml</code> is shown as follows:</p><div class="informalexample"><pre class="programlisting">&lt;servlet-container name="default"&gt;
    &lt;jsp-config/&gt;
&lt;/servlet-container&gt;</pre></div><p>An explanation of the attributes available for the <code class="literal">servlet-container</code> are detailed in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Default value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">allow-non-standard-wrappers</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id488" class="indexterm"/>property relaxes the servlet specification, which requires applications to only wrap the request/response with wrapper classes that extend the <code class="literal">ServletRequestWrapper</code> and <code class="literal">ServletResponseWrapper</code> classes.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">false</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">default-buffer-cache</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id489" class="indexterm"/>is the buffer cache used to cache static resources in the default servlet.</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">default-encoding</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id490" class="indexterm"/> is the default encoding for the requests and responses.</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">eager-filter-initialization</code>
</p>
</td><td style="text-align: left" valign="top">
<p>By <a id="id491" class="indexterm"/>setting this property to <code class="literal">true</code>, the init method of filters defined in your <code class="literal">web.xml</code> file are called upon the first request, and not on server startup.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">false</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ignore-flush</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id492" class="indexterm"/>ignores flushes on the servlet output stream.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">false</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">stack-trace-on-error</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id493" class="indexterm"/>available options for this property are <code class="literal">all</code>, <code class="literal">none</code>, or <code class="literal">local-only</code>. The <code class="literal">all</code> value will display all traces (should not be used in a production environment), while <code class="literal">none</code> means stack traces are not shown, and <code class="literal">local-only</code> means only requests from local addresses are shown and there are no headers to indicate that the request has been proxied. This feature uses the Undertow error page rather than the default error page specified in <code class="literal">web.xml</code>.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">local-only</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">use-listener-encoding</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id494" class="indexterm"/> uses the default encoding used by the listener that received the request.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">false</code>
</p>
</td></tr></tbody></table></div><p>Several child<a id="id495" class="indexterm"/> elements can be added to the <code class="literal">servlet-container</code> element, which will allow you to configure your JSPs, session cookies, and persistent sessions.</p><div class="section" title="Configuring JSP"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec34"/>Configuring JSP</h3></div></div></div><p>The <a id="id496" class="indexterm"/>JSP element is provided in the default configuration. As no additional attributes are added, the default configuration is applied, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;jsp-config 
check-interval="0" 
development="false" 
disabled="false" 
display-source-fragment="true" 
dump-smap="false" 
error-on-use-bean-invalid-class-attribute="false" 
generate-strings-as-char-arrays="false" 
java-encoding="UTF8" 
keep-generated="true" 
mapped-file="true" 
modification-test-interval="4" 
recompile-on-fail="false" 
smap="true" 
source-vm="1.6" 
tag-pooling="true" 
target-vm="1.6" 
trim-spaces="false" 
x-powered-by="true"/&gt;</pre></div></div><div class="section" title="Configuring the session cookie"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec35"/>Configuring the session cookie</h3></div></div></div><p>You <a id="id497" class="indexterm"/>will probably be interested in configuring the Undertow session cookie. By default, there is no configuration text included in the <code class="literal">standalone.xml</code> file, so you will need to add it as a child element of the <code class="literal">servlet-container</code> configuration:</p><div class="informalexample"><pre class="programlisting">&lt;servlet-container name="default"&gt;
    &lt;jsp-config/&gt;
    <span class="strong"><strong>&lt;session-cookie name="default" domain="yourdomain.com" http-only="true" max-age="60" secure="true"/&gt;</strong></span>
&lt;/servlet-container&gt;</pre></div><p>The possible attributes for the <code class="literal">session-cookie</code> element<a id="id498" class="indexterm"/> are shown in the following table. If you do not set these values explicitly, no value will be set, as there are no defaults:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Default value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id499" class="indexterm"/> property defines the name of a cookie</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">domain</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id500" class="indexterm"/>property defines the cookie domain</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">comment</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id501" class="indexterm"/> property defines the cookie comment</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">http-only</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id502" class="indexterm"/> property determines whether the cookie is HTTP-only</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">true</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">secure</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id503" class="indexterm"/>property determines whether the cookie is marked as secure</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">true</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max-age</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id504" class="indexterm"/> property defines the maximum age of a cookie (in minutes)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">0</code> (infinite)</p>
</td></tr></tbody></table></div></div><div class="section" title="Saving the session state"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec36"/>Saving the session state</h3></div></div></div><p>Saving sessions <a id="id505" class="indexterm"/>allows session data to be stored when the server is restarted or the application is redeployed. To enable this, you need to add the <code class="literal">persistent-sessions</code> element to the configuration file, as shown in the following code. This property should be used in your development environment rather than in production.</p><div class="informalexample"><pre class="programlisting">&lt;servlet-container name="default"&gt;
    &lt;jsp-config/&gt;
    <span class="strong"><strong>&lt;persistent-sessions path="/session" relative-to="${jboss.server.tmp.dir}"/&gt;</strong></span>
&lt;/servlet-container&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>If you do not specify the <code class="literal">path</code> variable, then the session will only be persistent across redeploys and not across server restarts.</p></div></div></div></div><div class="section" title="Configuring the buffer cache"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec53"/>Configuring the buffer cache</h2></div></div></div><p>The <a id="id506" class="indexterm"/>buffer cache<a id="id507" class="indexterm"/> is used to cache content, for example, static files. A buffer cache<a id="id508" class="indexterm"/> consists of one or more regions, and each region is split into smaller buffers. Here's an example configuration of the <a id="id509" class="indexterm"/>
<code class="literal">buffer-cache</code> element:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;buffer-cache name="default" buffer-size="1024" buffers-per-region="2048" max-regions="10" /&gt;
    ...
&lt;/subsystem&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip18"/>Tip</h3><p>The total cache size can be calculated by multiplying the buffer size by the buffers per region and the maximum number of regions. In our example, it would be:</p><p>
<span class="emphasis"><em>1024 bytes * 2048 * 10 = 20971520 bytes</em></span>
</p></div></div></div></div></div>
<div class="section" title="Creating and deploying a web application"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec20"/>Creating and deploying a web application</h1></div></div></div><p>As you can <a id="id510" class="indexterm"/>see, the application server provides a relatively straightforward way to configure the web container. In order to build and deploy a web application, it would be good for you to learn how to organize an application along with its specific configuration files.</p><p>WildFly 8 is a Java EE 7 compliant application server and thus, can be used to deploy a wide range of web applications. One way of building a web application is to use the <a id="id511" class="indexterm"/>
<span class="strong"><strong>JavaServer Faces</strong></span> (<span class="strong"><strong>JSF</strong></span>) technology, which is an evolution of the JSP technology. It is also part of Enterprise Java, meaning that WildFly supports it out of the box. WildFly 8 supports the JSF release 2.2 using the Mojarra implementation.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>The purpose of this example is to show you how to create, configure, and deploy a Java EE 7 application on WildFly 8. If you want to learn more about the various Java EE 7 technologies, you should check out the many <a id="id512" class="indexterm"/>Java EE 7 examples created by Arun Gupta, which have been configured specifically for WildFly. The GitHub URL is <a class="ulink" href="https://github.com/javaee-samples/javaee7-samples">https://github.com/javaee-samples/javaee7-samples</a>.</p></div></div><p>Next, we are <a id="id513" class="indexterm"/>going to create a simple application. The purpose of this is to demonstrate how to configure each of the various enterprise components found within a typical enterprise application.</p></div>
<div class="section" title="Creating a new Maven web project"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec21"/>Creating a new Maven web project</h1></div></div></div><p>There <a id="id514" class="indexterm"/>are several ways in which you can create a web application project using Eclipse. Since Maven is the de facto build tool, it makes sense to use the Maven project structure in this example.</p><p>Let's start by creating the project file structure. Go to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Maven Project</strong></span>, select <span class="strong"><strong>skip archetype selection</strong></span>, create a simple project, and proceed to the next page. Then, complete the artifact details as shown in the following screenshot, ensuring that you select <span class="strong"><strong>war</strong></span> as the packaging:</p><div class="mediaobject"><img src="graphics/6232OS_04_02.jpg" alt="Creating a new Maven web project"/></div><p>After <a id="id515" class="indexterm"/>clicking on <span class="strong"><strong>Finish</strong></span>, Eclipse will generate a default folder structure for your application:</p><div class="mediaobject"><img src="graphics/6232OS_04_03.jpg" alt="Creating a new Maven web project"/></div><p>We are going to use JSF to create the view. Configuring the JSF 2.2 web application requires <a id="id516" class="indexterm"/>very little effort. You can achieve this with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a file called <code class="literal">web.xml</code> and place it in the <code class="literal">WEB-INF</code> folder of your application.</li><li class="listitem">Add the <code class="literal">FacesServlet</code> to your <code class="literal">web.xml</code> file and specify what kind of URL patterns will be directed to it.</li><li class="listitem">Create a <code class="literal">faces-config.xml</code> file and place it in the <code class="literal">WEB-INF</code> folder.</li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note27"/>Note</h3><p>The <code class="literal">FacesServlet</code> is a servlet that manages the request processing life cycle for web applications that are utilizing JavaServer Faces to construct the user interface.</p></div></div><p>Here's the <a id="id517" class="indexterm"/>complete <code class="literal">web.xml</code> file. You can see that we specified the URL patterns that the <code class="literal">FacesServlet</code> will process:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd" id="WebApp_ID" version="3.1"&gt;
  &lt;display-name&gt;Java EE 7 - WildFly 8&lt;/display-name&gt;
  &lt;welcome-file-list&gt;
    &lt;welcome-file&gt;index.xhtml&lt;/welcome-file&gt;
  &lt;/welcome-file-list&gt;
  &lt;context-param&gt;
    &lt;param-name&gt;
      com.sun.faces.enableRestoreView11Compatibility
    &lt;/param-name&gt;
    &lt;param-value&gt;true&lt;/param-value&gt;
  &lt;/context-param&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;Faces Servlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;javax.faces.webapp.FacesServlet&lt;/servlet-class&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;Faces Servlet&lt;/servlet-name&gt;
    <span class="strong"><strong>&lt;url-pattern&gt;*.xhtml&lt;/url-pattern&gt;</strong></span>
  &lt;/servlet-mapping&gt;
  &lt;context-param&gt;
    &lt;param-name&gt;javax.servlet.jsp.jstl.fmt.localizationContext&lt;/param-name&gt;
    &lt;param-value&gt;resources.application&lt;/param-value&gt;
  &lt;/context-param&gt;
  &lt;listener&gt;
    &lt;listener-class&gt;com.sun.faces.config.ConfigureListener&lt;/listener-class&gt;
  &lt;/listener&gt;
&lt;/web-app&gt;</pre></div><p>Next, you <a id="id518" class="indexterm"/>see a minimal JSF configuration file named <code class="literal">faces-config.xml</code>, which will be placed in the <code class="literal">WEB-INF</code> folder of your application. This file declares the JSF release that we are going to use, which in our case, is 2.2:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;faces-config   xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-facesconfig_2_2.xsd" version="2.2"&gt;
&lt;/faces-config&gt;</pre></div><p>Eclipse can create these configuration files for you. To do this, you will need to activate the <a id="id519" class="indexterm"/>
<span class="strong"><strong>JavaServer</strong></span> <span class="strong"><strong>Faces</strong></span> <span class="strong"><strong>Facets</strong></span>. Right-click on your project and select <span class="strong"><strong>Project</strong></span> <span class="strong"><strong>Properties</strong></span>. Here, you will find a set of configuration options that can be automatically added to your project under the <span class="strong"><strong>Project</strong></span> <span class="strong"><strong>Facets</strong></span> option. You may need to modify the files to ensure that the correct namespaces are used, and update the content of the <code class="literal">web.xml</code> file.</p><p>Next, we will need to add the project dependencies to the Maven configuration file, the <a id="id520" class="indexterm"/>
<code class="literal">pom.xml</code> file. Maven will then download and manage all your dependencies for you upon a project build. The complete content of <code class="literal">pom.xml</code> is shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;project  
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.packtpub&lt;/groupId&gt;
    &lt;artifactId&gt;chapter4&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;
    &lt;description&gt;Simple Java EE 7 example using WildFly&lt;/description&gt;

    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;JBoss Repository&lt;/id&gt;
            &lt;url&gt;https://repository.jboss.org/nexus/content/groups/public/&lt;/url&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.spec&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-javaee-7.0&lt;/artifactId&gt;
            &lt;version&gt;1.0.1.Final&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;!-- build plugins removed for brevity --&gt;
&lt;/project&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip19"/>Tip</h3><p>You will notice that the JBoss Nexus repository is being used rather than Maven Central. This is because since Java EE 6, JBoss has hosted its own EE API. The motivation for this was the <a id="id521" class="indexterm"/>unimplemented methods in Java EE 6. To understand the full motivation, navigate to <a class="ulink" href="https://developer.jboss.org/blogs/donnamishelly/2011/04/29/jboss-java-ee-api-specs-project">https://developer.jboss.org/blogs/donnamishelly/2011/04/29/jboss-java-ee-api-specs-project</a>. I would recommend that you use the version hosted by JBoss, as it is identical to the code shipped with WildFly.</p></div></div><div class="section" title="Adding JSF components"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec54"/>Adding JSF components</h2></div></div></div><p>For the<a id="id522" class="indexterm"/> purpose of learning how to package a<a id="id523" class="indexterm"/> Java EE 7 application, we will show you how to combine JSF components, such as JSF views with Enterprise components like CDI and EJBs.</p><p>In this example, we will create a simple caching system that uses an EJB singleton to handle the cache in memory. Then, we show you how to persist data to a database. Let's start by adding a page named <code class="literal">index.xhtml</code> to your dynamic web project:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html 
    
    &gt;

&lt;h:head&gt;
    &lt;link href="main.css" rel="stylesheet" type="text/css" /&gt;
&lt;/h:head&gt;
&lt;h:body&gt;
    &lt;h2&gt;JSF 2 example on WildFly 8&lt;/h2&gt;
    &lt;h:form id="jsfexample"&gt;
        &lt;h:messages /&gt;
        &lt;h:panelGrid columns="2" styleClass="default"&gt;
            &lt;h:outputText value="Enter key:" /&gt;
            &lt;h:inputText value="#{manager.key}" /&gt;

            &lt;h:outputText value="Enter value:" /&gt;
            &lt;h:inputText value="#{manager.value}" /&gt;

            &lt;h:commandButton actionListener="#{manager.save}"
                styleClass="buttons" value="Save key/value" /&gt;
            &lt;h:commandButton actionListener="#{manager.clear}"
                styleClass="buttons" value="Clear cache" /&gt;
        &lt;/h:panelGrid&gt;

        &lt;h:dataTable value="#{manager.cacheList}" var="item"
            styleClass="table" headerClass="table-header"
            rowClasses="table-odd-row,table-even-row"&gt;
            &lt;h:column&gt;
                &lt;f:facet name="header"&gt;Key&lt;/f:facet&gt;
                &lt;h:outputText value="#{item.key}" /&gt;
            &lt;/h:column&gt;
            &lt;h:column&gt;
                &lt;f:facet name="header"&gt;Value&lt;/f:facet&gt;
                &lt;h:outputText value="#{item.value}" /&gt;
            &lt;/h:column&gt;
        &lt;/h:dataTable&gt;
    &lt;/h:form&gt;
&lt;/h:body&gt;
&lt;/html&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>To learn about JSF, please <a id="id524" class="indexterm"/>refer to the online tutorial at <a class="ulink" href="http://docs.oracle.com/javaee/7/tutorial/doc/jsf-intro.htm">http://docs.oracle.com/javaee/7/tutorial/doc/jsf-intro.htm</a>.</p></div></div><p>The <a id="id525" class="indexterm"/>following <a id="id526" class="indexterm"/>code references a backing bean named <code class="literal">manager</code>, which is used to store and retrieve key/value pairs. Backing beans are simple Java classes which are used as models for UI components. You will also notice the <code class="literal">@RequestScoped</code> annotation in the <code class="literal">PropertyManager</code> class.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip20"/>Tip</h3><p>When defining the scope of a backing bean, you should only use the <code class="literal">javax.faces.bean.RequestScoped</code> annotation if you are not using CDI, which is highly unlikely. Instead, you should use the annotations found in the <code class="literal">javax.enterprise.context.*</code> package, which is part of the Context and Dependency Injection framework.</p></div></div><p>Now, let's <a id="id527" class="indexterm"/>see how to code the <code class="literal">PropertyManager</code> managed <a id="id528" class="indexterm"/>bean:</p><div class="informalexample"><pre class="programlisting">package com.packtpub.chapter4.bean;
import java.util.List;
import javax.ejb.EJB;
import javax.enterprise.context.RequestScoped;
import javax.faces.application.FacesMessage;
import javax.faces.context.FacesContext;
import javax.faces.event.ActionEvent;
import javax.inject.Named;
import org.jboss.logging.Logger;
import com.packtpub.chapter4.ejb.SingletonBean;
import com.packtpub.chapter4.entity.Property;

@Named("manager") 
@RequestScoped 
public class PropertyManager { 

    private Logger logger = Logger.getLogger(getClass());
    
    @EJB 
    private SingletonBean ejb;
    private String key;
    private String value;

    public void save(ActionEvent e) { 
        try { 
            ejb.save(key, value);
            FacesContext.getCurrentInstance().addMessage( 
                    null, 
                    new FacesMessage(FacesMessage.SEVERITY_INFO, 
                            "Property Saved!", null));
        } catch (Exception ex) { 
            logger.error("Error saving property", ex);
            FacesContext.getCurrentInstance().addMessage( 
                    null, 
                    new FacesMessage(FacesMessage.SEVERITY_ERROR, 
                            "Error Saving!", ex.getMessage()));
        }
    }
    public void clear(ActionEvent e) { 
        logger.info("Called clear");
        ejb.deleteAll();
    }
    public List&lt;Property&gt; getCacheList() { 
        return ejb.getProperties();
    }
// getters and setters removed for brevity
}</pre></div><p>The most <a id="id529" class="indexterm"/>important part of this class is the<a id="id530" class="indexterm"/> <code class="literal">@Named</code> annotation. Annotating the class with <code class="literal">@Named</code> allows this class <a id="id531" class="indexterm"/>to be picked up as a CDI managed bean. The name passed into the annotation defines how this bean can be referenced via the Expression Language (EL). Next, the <code class="literal">@EJB</code> annotation<a id="id532" class="indexterm"/> is used to inject the <code class="literal">SingletonBean</code> into the class.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>You can find out more about <a id="id533" class="indexterm"/>JSF managed beans at the Java EE tutorial here: <a class="ulink" href="http://docs.oracle.com/javaee/7/tutorial/doc/jsf-develop.htm">http://docs.oracle.com/javaee/7/tutorial/doc/jsf-develop.htm</a>.</p></div></div></div><div class="section" title="Adding the EJB layer"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec55"/>Adding the EJB layer</h2></div></div></div><p>The <code class="literal">SingletonBean</code><a id="id534" class="indexterm"/> is an EJB, which<a id="id535" class="indexterm"/> is<a id="id536" class="indexterm"/> marked with the special <code class="literal">@javax.ejb.Singleton</code> annotation. A class with such an annotation is guaranteed to be instantiated only once per application, and exists for the life cycle of the application. In the Java EE context, singleton beans are primarily used to store application-wide shared data. Now, we need to create a new class named <code class="literal">SingletonBean</code>. The aim of this class will be to save and retrieve key/value pairs:</p><div class="informalexample"><pre class="programlisting">package com.packtpub.chapter4.ejb;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.PostConstruct;
import javax.ejb.LocalBean;
import javax.ejb.Remote;
import javax.ejb.Singleton;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.persistence.TypedQuery;

import com.packtpub.chapter4.entity.Property;

@Singleton
@LocalBean
public class SingletonBean {

    private List&lt;Property&gt; cache = new ArrayList&lt;&gt;();

    @PostConstruct
    public void initCache() {
        this.cache = queryCache();
        if (cache == null) {
            cache = new ArrayList&lt;Property&gt;();
        }
    }

    public void deleteAll() {
        this.cache.clear();
    }

    public void save(String key, String value) {
        Property property = new Property(key, value);
        this.cache.add(property);
    }

    public List&lt;Property&gt; getProperties() {
        return cache;
    }
}</pre></div><p>The last<a id="id537" class="indexterm"/> class <a id="id538" class="indexterm"/>we need to add is <code class="literal">Property</code>, which is a plain <code class="literal">JavaBean</code> class:</p><div class="informalexample"><pre class="programlisting">package com.packtpub.chapter4.entity;

public class Property {
    private String key;
    private String value;
    // GETTERS &amp; SETTERS omitted for brevity 
}</pre></div><p>Once you reach this point, you should have a project containing the items<a id="id539" class="indexterm"/> shown in the following <a id="id540" class="indexterm"/>screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_04_05.jpg" alt="Adding the EJB layer"/></div></div><div class="section" title="Choosing the web context of the application"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec56"/>Choosing the web context of the application</h2></div></div></div><p>By default, a <a id="id541" class="indexterm"/>web application inherits the web context <a id="id542" class="indexterm"/>name from the archive name, which is deployed on the application server. Maven uses the artifact ID, followed by the version to name the archive. So, in our example, if we deploy an archive named <code class="literal">chapter4-0.0.1-SNAPSHOT.war</code>, it will be accessible using the web context name <code class="literal">chapter4-0.0.1-SNAPSHOT</code>, as shown by the following image:</p><div class="mediaobject"><img src="graphics/6232OS_04_06.jpg" alt="Choosing the web context of the application"/></div><p>The context name can be modified to something more meaningful. The simplest way to achieve this (without changing the archive name) is by <a id="id543" class="indexterm"/>adding a <code class="literal">jboss-web.xml</code> file to the <code class="literal">WEB-INF</code> folder of your project:</p><div class="mediaobject"><img src="graphics/6232OS_04_07.jpg" alt="Choosing the web context of the application"/></div><p>The content <a id="id544" class="indexterm"/>of this file will include the custom web context, as specified by the <code class="literal">context-root</code> element:</p><div class="informalexample"><pre class="programlisting">&lt;jboss-web&gt;
  &lt;context-root&gt;chapter4&lt;/context-root&gt;
&lt;/jboss-web&gt;</pre></div></div><div class="section" title="Deploying the web application"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec57"/>Deploying the web application</h2></div></div></div><p>Once <a id="id545" class="indexterm"/>you are happy with your settings, you can deploy and verify your application. If you are deploying your application from within Eclipse, just right-click on the WildFly Runtime Server and choose the <span class="strong"><strong>Add</strong></span> <span class="strong"><strong>and</strong></span> <span class="strong"><strong>Remove</strong></span> option (assuming you installed the WildFly runtime as shown in <a class="link" href="ch01.html" title="Chapter 1. Installing WildFly">Chapter 1</a>, <span class="emphasis"><em>Installing WildFly</em></span>). Next, add the web project to the list of deployed projects.</p><p>You can then deploy the application by right-clicking on the project and choosing <span class="strong"><strong>Full</strong></span> <span class="strong"><strong>Publish</strong></span>:</p><div class="mediaobject"><img src="graphics/6232OS_04_08.jpg" alt="Deploying the web application"/></div><p>After publishing your application, you will notice that Eclipse will copy your web application archive (<code class="literal">chapter4-0.0.1-SNAPSHOT.war</code>) to the server. It will also create a file named <code class="literal">chapter4-0.0.1-SNAPSHOT.war.dodeploy</code>. As you will learn in <a class="link" href="ch06.html" title="Chapter 6. Application Structure and Deployment">Chapter 6</a>, <span class="emphasis"><em>Application Structure and Deployment</em></span>, expanded archives, by default, require a marker file in WildFly to trigger the deployment. Eclipse is aware of this and creates the file for you.</p><p>Upon successful <a id="id546" class="indexterm"/>deployment, the <code class="literal">chapter4-0.0.1-SNAPSHOT.war.dodeploy</code> file will be replaced by a <code class="literal">chapter4-0.0.1-SNAPSHOT.war.deployed</code> marker file, which indicates that you have successfully deployed the web application. You can verify that your application works correctly by pointing to the <code class="literal">index.xhtml</code> page at <code class="literal">http://localhost:8080/chapter4/index.xhtml</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_04_09.jpg" alt="Deploying the web application"/></div><div class="section" title="Deploying a web application to the root context"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec37"/>Deploying a web application to the root context</h3></div></div></div><p>In our example, we<a id="id547" class="indexterm"/> have shown how to deploy the web application to a custom context using <code class="literal">jboss-web.xml</code>. One particular case of web context is the <code class="literal">root</code> context. This typically resolves to <code class="literal">http://localhost:8080</code> and is used to provide some welcome context by the web server. By default, WildFly has a root context that is mapped in the <code class="literal">JBOSS_HOME/welcome-content</code> folder. You can, however, override it by deploying one of your applications to the <code class="literal">root</code> context. This requires two simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, you need to remove the following line from your Undertow subsystem:<div class="informalexample"><pre class="programlisting">&lt;location name="/" handler="welcome-content"/&gt;</pre></div></li><li class="listitem">Then, in your application, add a <code class="literal">jboss-web.xml</code> file that contains the <code class="literal">root</code> context for your application:<div class="informalexample"><pre class="programlisting">&lt;jboss-web&gt;
    &lt;context-root&gt;/&lt;/context-root&gt;
&lt;/jboss-web&gt;</pre></div></li></ol></div></div></div><div class="section" title="Adding a remote EJB client"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec58"/>Adding a remote EJB client</h2></div></div></div><p>Before adding <a id="id548" class="indexterm"/>any code for the remote EJB client, we<a id="id549" class="indexterm"/> need to add two dependencies to <code class="literal">pom.xml</code>. This ensures that our code will compile and run without errors:</p><div class="informalexample"><pre class="programlisting">&lt;!-- this is required for a security --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.jboss.sasl&lt;/groupId&gt;
    &lt;artifactId&gt;jboss-sasl&lt;/artifactId&gt;
    &lt;version&gt;1.0.4.Final&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
&lt;!-- this is required for the RemoteEJBClient.java to compile --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.jboss&lt;/groupId&gt;
    &lt;artifactId&gt;jboss-ejb-client&lt;/artifactId&gt;
    &lt;version&gt;2.0.2.Final&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;</pre></div><p>In order to test our application with a remote client, we need to create a remote interface to the EJB:</p><div class="informalexample"><pre class="programlisting">package com.packtpub.chapter4.ejb;

import java.util.List;
import com.packtpub.chapter4.entity.Property;

public interface SingletonBeanRemote {
    public void deleteAll();
    public void save(String key, String value);
    public List&lt;Property&gt; getProperties();
}</pre></div><p>The concrete <a id="id550" class="indexterm"/>implementation of this interface is the <a id="id551" class="indexterm"/>
<code class="literal">SingletonBeanRemoteImpl</code> class, which has the same Java method implementations as the <code class="literal">SingletonBean</code> class that we showed in the earlier section:</p><div class="informalexample"><pre class="programlisting">@Singleton
@LocalBean
<span class="strong"><strong>@Remote(SingletonBeanRemote.class)</strong></span>
public class  SingletonBean implements SingletonBeanRemote  {
// Bean class unchanged
}</pre></div><p>EJB remote<a id="id552" class="indexterm"/> invocation happens through the <a id="id553" class="indexterm"/>
<span class="strong"><strong>Remoting</strong></span> framework, which uses <a id="id554" class="indexterm"/>
<span class="strong"><strong>Simple</strong></span> <span class="strong"><strong>Authentication</strong></span> <span class="strong"><strong>and</strong></span> <span class="strong"><strong>Security</strong></span> <span class="strong"><strong>Layer</strong></span> (<span class="strong"><strong>SASL</strong></span>) for client-server authentication. You need to explicitly set the security provider by adding the following specification to the test client:</p><div class="informalexample"><pre class="programlisting">static {
  Security.addProvider(new JBossSaslProvider());
}</pre></div><p>The next part is quite tricky. We need to determine the <span class="strong"><strong>Java Naming and Directory Interface</strong></span> (<span class="strong"><strong>JNDI</strong></span>) name <a id="id555" class="indexterm"/>of the EJB, for which we will need to look up the remote EJB. The JNDI name varies depending on whether the EJB is stateful or stateless. The following table outlines the syntax for both SLSBs and SFSBs:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>EJB type</p>
</th><th style="text-align: left" valign="bottom">
<p>JNDI syntax</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Stateless <a id="id556" class="indexterm"/>EJB</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">ejb:&lt;app-name&gt;/&lt;module-name&gt;/&lt;distinct-name&gt;/&lt;bean-name&gt;!&lt;fully-qualified-classname-of-the-remote-interface&gt;</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Stateful EJB<a id="id557" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">ejb:&lt;app-name&gt;/&lt;module-name&gt;/&lt;distinct-name&gt;/&lt;bean-name&gt;!&lt;fully-qualified-classname-of-the-remote-interface&gt;?stateful</code>
</p>
</td></tr></tbody></table></div><p>The following table bisects each of these properties:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Parameter</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">app-name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id558" class="indexterm"/>is the application name and is used in the event that the application has been deployed as an Enterprise archive. It typically corresponds to the Enterprise archive name without <code class="literal">.ear</code>. Since we packed our application in a web archive, this parameter will not be used.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">module-name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id559" class="indexterm"/>is the module within which the EJBs are contained. Since we deployed the application in a file named <code class="literal">chapter4-0.0.1-SNAPSHOT.war</code>, it corresponds to <code class="literal">chapter4-0.0.1-SNAPSHOT</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">distinct-name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is an<a id="id560" class="indexterm"/> optional name that can be assigned to distinguish between different EJB implementations. It's not used in our example.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">bean-name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is <a id="id561" class="indexterm"/>the EJB name, which, by default, is the class name of the bean implementation class, in our case, <code class="literal">SingletonBeanRemoteImpl</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">fully-qualified-classname-of-the-remote-interface</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id562" class="indexterm"/>obviously corresponds to the fully qualified class name of the interface you are looking up, in our case, <code class="literal">com.packtpub.chapter4.ejb.SingletonBeanRemote</code>.</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>Please notice that stateful EJBs require an additional <code class="literal">?stateful</code> parameter to be added to the JNDI lookup name.</p></div></div><p>With<a id="id563" class="indexterm"/> this <a id="id564" class="indexterm"/>information on the JNDI namespace, you will be ready to understand the client code:</p><div class="informalexample"><pre class="programlisting">package com.packtpub.chapter4.client;

import java.security.Security;
import java.util.*;
import javax.naming.*;
import org.jboss.ejb.client.*;
import org.jboss.sasl.JBossSaslProvider;
import com.packtpub.chapter4.ejb.SingletonBean;
import com.packtpub.chapter4.ejb.SingletonBeanRemote;
import com.packtpub.chapter4.entity.Property;

public class RemoteEJBClient { 
    static { 
        Security.addProvider(new JBossSaslProvider());
    }
    public static void main(String[] args) throws Exception { 
        testRemoteEJB();
    }
    private static void testRemoteEJB() throws NamingException { 
        final SingletonBeanRemote ejb = lookupEJB();
        ejb.save("entry", "value");
        List&lt;Property&gt; list = ejb.getProperties();
        System.out.println(list);
    }
    private static SingletonBeanRemote lookupEJB() throws NamingException { 

        Properties clientProperties = new Properties();
        clientProperties.put("endpoint.name", "client-endpoint");
        clientProperties.put("remote.connections", "default");
        clientProperties.put("remote.connection.default.port", "8080");
        clientProperties.put("remote.connection.default.host", "localhost");
        clientProperties.put("remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED", "false");
        clientProperties.put("remote.connection.default.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS", "false");

        EJBClientConfiguration ejbClientConfiguration = new PropertiesBasedEJBClientConfiguration(clientProperties);
        ContextSelector&lt;EJBClientContext&gt; ejbContextSelector = new ConfigBasedEJBClientContextSelector(ejbClientConfiguration);

        EJBClientContext.setSelector(ejbContextSelector);

        <span class="strong"><strong>final Hashtable&lt;String, String&gt; jndiProperties = </strong></span>          <span class="strong"><strong>new Hashtable&lt;&gt;();</strong></span>
        <span class="strong"><strong>jndiProperties.put(Context.URL_PKG_PREFIXES,</strong></span> <span class="strong"><strong>"org.jboss.ejb.client.naming");</strong></span>
        <span class="strong"><strong>final Context context = new InitialContext(jndiProperties);</strong></span>
        final String appName = "";
        final String moduleName = "chapter4-webapp-example-0.0.1-SNAPSHOT";
        final String distinctName = "";

        final String beanName = SingletonBean.class.getSimpleName();
        final String viewClassName = SingletonBeanRemote.class.getName();
        return (SingletonBeanRemote) context.lookup("ejb:" + appName + "/" + moduleName + "/" + distinctName + "/" + beanName + "!" + viewClassName);
    }
}</pre></div><p>As you can see, the <a id="id565" class="indexterm"/>major complexity of the remote EJB client code is related to the JNDI lookup section. You might have noticed that in the highlighted section, we initialized the JNDI context with a property named <code class="literal">Context.URL_PKG_PREFIXES</code> to specify the list of package prefixes<a id="id566" class="indexterm"/> to be used when loading URL context factories. In our case, we set it to <code class="literal">org.jboss.ejb.client.naming</code> so that the JNDI API knows which classes are in charge of handling the <code class="literal">ejb:</code> namespace.</p><div class="section" title="Configuring the client using a properties file"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec38"/>Configuring the client using a properties file</h3></div></div></div><p>Finally, you<a id="id567" class="indexterm"/> might<a id="id568" class="indexterm"/> wonder how the client actually knows the server location where the remote EJBs are hosted. This can be solved by adding the following client-side property file named <code class="literal">jboss-ejb-client.properties</code> to the client classpath:</p><div class="informalexample"><pre class="programlisting">remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false
remote.connections=default
remote.connection.default.host=localhost
remote.connection.default.port = 8080
remote.connection.default.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false</pre></div><p>Within this file, you can specify a set of properties prefixed by <code class="literal">remote.connectionprovider.create.options</code>, which will be used during the remote connection. In our example, we just set the <code class="literal">org.xnio.Options.SSL_ENABLED</code> property to <code class="literal">false</code>, which means that a clear text transmission will be used to connect the client and server.</p><p>The <code class="literal">remote.connections</code> property<a id="id569" class="indexterm"/> is used to specify a set of one or more connections that map to an EJB receiver. In our case, there is a single remote connection named <code class="literal">default</code>, which maps to the <code class="literal">localhost</code> and the remoting port <code class="literal">8080</code>.</p><p>Finally, we need to specify that an SASL anonymous connection will be used; otherwise, without an authentication, our connection will be refused.</p></div><div class="section" title="Configuring the client programmatically"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec39"/>Configuring the client programmatically</h3></div></div></div><p>Another <a id="id570" class="indexterm"/>way to configure the client's connection properties is to configure them programmatically. Here, we create a <code class="literal">Properties</code> object and populate it with the same key/value <a id="id571" class="indexterm"/>pairs that are in the <code class="literal">jboss-ejb-client.properties</code> configuration file. The important parts of the code are highlighted in bold:</p><div class="informalexample"><pre class="programlisting">private static SingletonBeanRemote lookupEJB() throws NamingException {
    <span class="strong"><strong>Properties clientProperties = new Properties();</strong></span>
    <span class="strong"><strong>clientProperties.put("endpoint.name", "client-endpoint");</strong></span>
    <span class="strong"><strong>clientProperties.put("remote.connections", "default");</strong></span>
    <span class="strong"><strong>clientProperties.put("remote.connection.default.port",</strong></span> <span class="strong"><strong>"8080");</strong></span>
    <span class="strong"><strong>clientProperties.put("remote.connection.default.host",</strong></span> <span class="strong"><strong>"localhost");</strong></span>
    <span class="strong"><strong>clientProperties.put("remote.connectionprovider.</strong></span>
<span class="strong"><strong>create.options.org.xnio.Options.SSL_ENABLED", "false");</strong></span>
    <span class="strong"><strong>clientProperties.put("remote.connection.default.</strong></span>
<span class="strong"><strong>connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS",</strong></span> <span class="strong"><strong>"false");</strong></span>

    <span class="strong"><strong>EJBClientConfiguration ejbClientConfiguration =</strong></span> <span class="strong"><strong>new PropertiesBasedEJBClientConfiguration(clientProperties);</strong></span>
        <span class="strong"><strong>ContextSelector&lt;EJBClientContext&gt; ejbContextSelector =</strong></span> <span class="strong"><strong>new ConfigBasedEJBClientContextSelector(ejbClientConfiguration);</strong></span>

    <span class="strong"><strong>EJBClientContext.setSelector(ejbContextSelector);</strong></span>

    final Hashtable&lt;String, String&gt; jndiProperties = new Hashtable&lt;&gt;();
    jndiProperties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
    final Context context = new InitialContext(jndiProperties);
    final String appName = "";
    final String moduleName = "chapter4-webapp-example-0.0.1-SNAPSHOT";
    final String distinctName = "";

    final String beanName = SingletonBean.class.getSimpleName();
    final String viewClassName = SingletonBeanRemote.class.getName();
    return (SingletonBeanRemote) context.lookup("ejb:" + appName + "/" + moduleName + "/" + distinctName + "/" + beanName + "!" + viewClassName);
    }</pre></div></div></div><div class="section" title="Configuring data persistence"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec59"/>Configuring data persistence</h2></div></div></div><p>We will <a id="id572" class="indexterm"/>now further enhance our application by <a id="id573" class="indexterm"/>storing the key/value pairs in a relational database instead of keeping them in memory. To do this, we will need to create a <a id="id574" class="indexterm"/>
<span class="strong"><strong>persistence</strong></span> <span class="strong"><strong>context</strong></span>. Again, let me remind you that its purpose is not to teach the theory behind data persistence, but rather to show how to configure it within your applications.</p><p>The persistence subsystem is included, by default, within all server configurations:</p><div class="informalexample"><pre class="programlisting">&lt;extension module="org.jboss.as.jpa"/&gt;
&lt;subsystem &gt;&lt;/subsystem&gt;</pre></div><p>The JPA module is not loaded by default in the application server. However, as soon as the application server detects that your application has <code class="literal">persistence.xml</code> or persistence annotations, the JPA module will be automatically started.</p><p>So, let's add <a id="id575" class="indexterm"/>the JPA<code class="literal"> persistence.xml</code> configuration file to our project, which will reference the data source used to map our entities to the database:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence 
    
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/persistence/persistence_2_1.xsd"
    version="2.1"&gt;
    &lt;persistence-unit name="persistenceUnit" transaction-type="JTA"&gt;
        &lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;
        &lt;jta-data-source&gt;java:jboss/datasources/MySqlDS&lt;/jta-data-source&gt;  
        &lt;properties&gt;
            &lt;property name="hibernate.dialect" value="org.hibernate.dialect.MySQLDialect" /&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</pre></div><p>The key attributes of this file are the persistence unit's <code class="literal">name</code>, which will identify its unique name, and the <code class="literal">jta-data-source</code>, which must match a valid datasource definition. In the earlier chapter, we defined this datasource bound to a MySQL database.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>The <code class="literal">persistence.xml</code> file<a id="id576" class="indexterm"/> can specify either a JTA datasource or a non-JTA datasource. Within a Java EE environment, you have to use a JTA datasource (even when reading data without an active transaction).</p></div></div><p>Finally, the <code class="literal">properties</code> element <a id="id577" class="indexterm"/>can contain any configuration property for the underlying persistence provider. Since WildFly uses Hibernate as the EJB persistence provider, you can pass any Hibernate options here.</p><p>Once created, this file needs to be placed in the <code class="literal">META-INF</code> folder of your <code class="literal">source/main/resources</code> folder, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6232OS_04_10.jpg" alt="Configuring data persistence"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>
<span class="strong"><strong>The real path of the persistence.xml file</strong></span>
</p><p>Please note that the content of the <code class="literal">Eclipse src/main/resources</code> directory will be placed in the <code class="literal">WEB-INF/classes</code> directory of your web application when Maven builds it.</p></div></div></div><div class="section" title="Using a default datasource for the JPA subsystem"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec60"/>Using a default datasource for the JPA subsystem</h2></div></div></div><p>In this <a id="id578" class="indexterm"/>example, we are referencing <a id="id579" class="indexterm"/>the datasource from within the <code class="literal">persistence.xml</code> file, thus following a canonical approach well-known to many developers.</p><p>You can, however, choose a default datasource for all your JPA applications by adding the <code class="literal">default-datasource</code> element into the JPA subsystem:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
  &lt;jpa default-datasource="java:jboss/datasources/MySqlDS"/&gt;
&lt;/subsystem&gt;</pre></div><p>This way, all JPA <a id="id580" class="indexterm"/>applications that haven't defined the <code class="literal">jta-data-source</code> element in <code class="literal">persistence.xml</code> will use the default datasource configured in the main server configuration file.</p></div><div class="section" title="Configuring entities"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec61"/>Configuring entities</h2></div></div></div><p>Once <a id="id581" class="indexterm"/>your persistence configuration is defined, the only change <a id="id582" class="indexterm"/>we need to make in our application is to add the <code class="literal">javax.persistence</code> annotations to our entity class. The <code class="literal">@Entity</code> annotation<a id="id583" class="indexterm"/> means that the class will be registered as a JPA entity:</p><div class="informalexample"><pre class="programlisting">package com.packtpub.chapter4.entity;
import java.io.Serializable;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Property implements Serializable {
    @Id
    @Column(name = "id")
    private String key;
    @Column(name = "value")
    private String value;
    //getters and setters omitted for brevity
}</pre></div><p>Our session bean needs to be changed, as well. Instead of reading and writing to the in-memory cache, we will write to both the cache and the database, and read only from the in-memory cache. When the application is restarted, the in-memory cache will be populated with data queried from the database. Although this is nothing fancy, for the sake of this demonstration, it is just fine:</p><div class="informalexample"><pre class="programlisting">import java.util.ArrayList;
import java.util.List;
import javax.annotation.PostConstruct;
import javax.ejb.Singleton;
import javax.persistence.*;
import com.packtpub.chapter4.entity.Property;

@Singleton
public class  SingletonBean   {
  private  List&lt;Property&gt; cache;
  @PersistenceContext(unitName = "persistenceUnit")
  private EntityManager em;

  @PostConstruct
  public void initCache(){
    <span class="strong"><strong>this.cache = queryCache();</strong></span>
    if (cache == null) cache = new ArrayList&lt;Property&gt;();
  }

  public void delete(){
    <span class="strong"><strong>Query query = em.createQuery("delete FROM </strong></span>
<span class="strong"><strong>com.packtpub.chapter4.entity.Property");</strong></span>
    <span class="strong"><strong>query.executeUpdate();</strong></span>
    this.cache.clear();
  }

  public void put(String key,String value){
    Property p = new Property();
    p.setKey(key);
    p.setValue(value);
    <span class="strong"><strong>em.persist(p);</strong></span>
    this.cache.add(p);
  }


package com.packtpub.chapter4.ejb;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.PostConstruct;
import javax.ejb.LocalBean;
import javax.ejb.Remote;
import javax.ejb.Singleton;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.persistence.TypedQuery;

import com.packtpub.chapter4.entity.Property;

@Singleton 
@LocalBean 
public class SingletonBean { 

    private List&lt;Property&gt; cache = new ArrayList&lt;&gt;();

    @<span class="strong"><strong>PersistenceContext(unitName = "persistenceUnit")</strong></span>
    <span class="strong"><strong>private EntityManager em;</strong></span>

    @PostConstruct 
    public void initCache() { 
        <span class="strong"><strong>this.cache = queryCache();</strong></span>
        if (cache == null) { 
            cache = new ArrayList&lt;Property&gt;();
        }
    }

    public void deleteAll() { 
        <span class="strong"><strong>Query query = em.createQuery("DELETE FROM Property");</strong></span>
        <span class="strong"><strong>query.executeUpdate();</strong></span>
    }

    public void save(String key, String value) { 
        Property property = new Property(key, value);
        <span class="strong"><strong>em.persist(property);</strong></span>
        this.cache.add(property);
    }

    private List&lt;Property&gt; queryCache() { 
        TypedQuery&lt;Property&gt; query = em.createQuery("FROM Property", Property.class);
        List&lt;Property&gt; list = query.getResultList();
        return list;
    }

    public List&lt;Property&gt; getProperties() { 
        return cache;
    }
}</pre></div><p>Sections <a id="id584" class="indexterm"/>of the preceding code have been highlighted to show you where the code has been modified to use data persistence. The most <a id="id585" class="indexterm"/>relevant section is the <code class="literal">@javax.persistence.PersistenceContext</code> annotation, which references a JPA context defined in the <code class="literal">persistence.xml</code> file.</p><p>Once deployed, this application will persist data to your MySQL database.</p></div><div class="section" title="Configuring persistence in other application archives"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec62"/>Configuring persistence in other application archives</h2></div></div></div><p>In our <a id="id586" class="indexterm"/>example, we <a id="id587" class="indexterm"/>created a Java EE 7 application that is made of web components and EJBs using a single web application archive. This is absolutely fine and expected, as Java EE allows the mixing and matching of frontend components and server-side components within a single web archive.</p><p>You can, however, deploy an application where the web layer is separated from the business service layer. For example, suppose you were to deploy your entities in a separate JAR file; the correct place for the <code class="literal">persistence.xml</code> file would be beneath the <code class="literal">META-INF</code> folder of your JAR archive.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note33"/>Note</h3><p>To confirm, if you are placing your JPA entities inside a WAR file, the <code class="literal">persistence.xml</code> file should be placed in the <code class="literal">WEB-INF/classes/META-INF</code> folder. If you package your JPA entities within a JAR file inside a web application, you should place the <code class="literal">persistence.xml</code> file in the <code class="literal">META-INF</code> folder.</p></div></div><p>Technically speaking, if you have multiple JAR files in your application, you can deploy the <code class="literal">persistence.xml</code> file in a single archive and refer to the persistence unit using the <code class="literal">jarName#unitName</code> notation. For example, this application's persistence unit could be referenced from another JAR file using the following annotation:</p><div class="informalexample"><pre class="programlisting">@PersistenceContext(unitName="wildflyapp.jar#unitName")</pre></div></div><div class="section" title="Switching to a different provider"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec63"/>Switching to a different provider</h2></div></div></div><p>By<a id="id588" class="indexterm"/> default, WildFly 8.1 uses Hibernate 4.3.5 as a persistence provider. The Hibernate JARs are included under the <code class="literal">modules</code> folder in the <code class="literal">org.hibernate</code> path. If, however, your application requires a different version of Hibernate, such as 3.5, you can still bundle the JARs into your application by adding the dependency to your <code class="literal">pom.xml</code> file and setting the scope to <code class="literal">runtime</code>:</p><div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;
    &lt;version&gt;3.5.0-Final&lt;/version&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</pre></div><p>Besides this, you need to set the <code class="literal">jboss.as.jpa.providerModule</code> property to <code class="literal">hibernate3-bundled</code> in your <code class="literal">persistence.xml</code> configuration file. The JPA deployer will detect the presence of a different version of the persistence provider and activate that version:</p><div class="informalexample"><pre class="programlisting">&lt;persistence-unit&gt;
    &lt;properties&gt;
        &lt;property name="jboss.as.jpa.providerModule" value="hibernate3-bundled" /&gt;
    &lt;/properties&gt;
&lt;/persistence-unit&gt;</pre></div><div class="section" title="Using Jipijapa"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec40"/>Using Jipijapa</h3></div></div></div><p>You can<a id="id589" class="indexterm"/> also use the Jipijapa project to simplify switching to a different JPA provider. If you use Jipijapa, you will need to ensure that your persistence provider is included as a runtime dependency in your <code class="literal">pom.xml</code> file, and you will also need to include the correct Jipijapa integration JAR file. To use Hibernate 3, you will need to add the following dependency in <code class="literal">pom.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.jipijapa&lt;/groupId&gt;
  &lt;artifactId&gt;jipijapa-hibernate3&lt;/artifactId&gt;
  &lt;version&gt;1.0.1.Final&lt;/version&gt;
&lt;/dependency&gt;</pre></div><p>With Jipijapa, you can easily switch to a different version of Hibernate, or to a different ORM provider such as EclipseLink or OpenJPA. For more details on using the Jipijapa project, you <a id="id590" class="indexterm"/>can refer to the WildFly docs at <a class="ulink" href="https://docs.jboss.org/author/display/WFLY8/JPA+Reference+Guide#JPAReferenceGuide-BackgroundontheJipijapaproject">https://docs.jboss.org/author/display/WFLY8/JPA+Reference+Guide#JPAReferenceGuide-BackgroundontheJipijapaproject</a>.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec22"/>Summary</h1></div></div></div><p>In this chapter, we discussed the Undertow subsystem configuration, which is found within the main configuration file. </p><p>The Undertow server configuration is broken into two main parts: server configuration, which is used to configure static resources, such as HTML pages, images, listeners, and hosts, and the servlet container configuration, which is used to configure dynamic resources such as JSPs.</p><p>We then went through an example application that demonstrated how to package and deploy a Java EE 7 web module on the application server.</p><p>Then, we discussed the JPA subsystem and showed you how to add data persistence to the initial example. We outlined the correct location of the <code class="literal">persistence.xml</code> file, which is required to be placed in the <code class="literal">WEB-INF/classes/META-INF</code> folder of your web application or in the <code class="literal">META-INF</code> folder of your JAR file.</p><p>Having completed the application server standalone configuration, we will now move on to the next chapter and look at how to configure application server domains.</p></div></body></html>