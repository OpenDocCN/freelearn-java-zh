<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Querying a Database"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Querying a Database</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Connecting to a database</li><li class="listitem" style="list-style-type: disc">Creating a DAO class</li><li class="listitem" style="list-style-type: disc">Calling a DAO method from a controller class</li><li class="listitem" style="list-style-type: disc">Saving an object</li><li class="listitem" style="list-style-type: disc">Retrieving an object</li><li class="listitem" style="list-style-type: disc">Retrieving a list of objects</li><li class="listitem" style="list-style-type: disc">Retrieving a list of objects with their dependencies</li><li class="listitem" style="list-style-type: disc">Updating an object</li><li class="listitem" style="list-style-type: disc">Deleting an object</li><li class="listitem" style="list-style-type: disc">Finding the number of results for an SQL query</li><li class="listitem" style="list-style-type: disc">Saving a list of objects at once</li><li class="listitem" style="list-style-type: disc">Reverting incomplete database modifications using transactions</li><li class="listitem" style="list-style-type: disc">Using Hibernate for powerful object persistence and querying</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Introduction</h1></div></div></div><p><span class="strong"><strong>JDBC</strong></span> (<span class="strong"><strong>Java Database Connectivity</strong></span>) and <span class="strong"><strong>Hibernate</strong></span> are the two most commonly used technologies to <a id="id169" class="indexterm"/>query a database from a Spring application.</p><p>For small projects<a id="id170" class="indexterm"/> and simple data models, JDBC is straightforward; you write your SQL queries yourself and Spring provides helpers to convert the query results into objects.</p><p>For complex data models, with several relationships between classes, Hibernate is easier; you deal with a standard Java framework (still using JDBC behind the scenes) that will generate the SQL queries for you.</p><p>This chapter focuses on JDBC because Spring doesn't change the normal way of using Hibernate. The integration of Hibernate with Spring, however, is covered in the <span class="emphasis"><em>Using Hibernate for powerful object persistence and querying</em></span> recipe.</p></div></div>
<div class="section" title="Connecting to a database"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Connecting to a database</h1></div></div></div><p>In this recipe, we will connect to a MySQL or PostgreSQL database from a Spring application. To connect to another database system, go to <a class="ulink" href="http://www.oxygenxml.com/database_drivers.html">http://www.oxygenxml.com/database_drivers.html</a> to find the relevant dependencies, driver<a id="id171" class="indexterm"/> class, and URL type.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec66"/>Getting ready</h2></div></div></div><p>You need<a id="id172" class="indexterm"/> a MySQL or PostgreSQL database up and running.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec67"/>How to do it…</h2></div></div></div><p>Here are the steps to connect from a Spring application to an existing database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependency for Spring JDBC in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework&lt;/groupId&gt;
  &lt;artifactId&gt;<span class="strong"><strong>spring-jdbc</strong></span>&lt;/artifactId&gt;
  &lt;version&gt;4.1.6.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">If you're using MySQL, add its Maven dependency in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;mysql&lt;/groupId&gt;
  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;version&gt;5.1.35&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">If you're using PostgreSQL, add its Maven dependency in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;postgresql&lt;/groupId&gt;
  &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
  &lt;version&gt;9.1-901-1.jdbc4&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li></ol></div><p>In the Spring configuration, add a <code class="literal">DataSource</code> bean with the database connection details.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If you're using MySQL:<div class="informalexample"><pre class="programlisting">@Bean
public DataSource dataSource() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        
        dataSource.setDriverClassName("<span class="strong"><strong>com.mysql.jdbc.Driver</strong></span>");
        dataSource.setUrl("jdbc:<span class="strong"><strong>mysql</strong></span>://localhost:3306/<span class="strong"><strong>db1</strong></span>");
        dataSource.setUsername("<span class="strong"><strong>user1</strong></span>");
        dataSource.setPassword("<span class="strong"><strong>pass1</strong></span>");
         
        return dataSource;
}</pre></div></li><li class="listitem">If you're<a id="id173" class="indexterm"/> using PostgreSQL:<div class="informalexample"><pre class="programlisting">@Bean
public DataSource dataSource() {
    DriverManagerDataSource dataSource = new DriverManagerDataSource();
    
    dataSource.setDriverClassName("<span class="strong"><strong>org.postgresql.Driver</strong></span>");
    dataSource.setUrl("jdbc:<span class="strong"><strong>postgresql</strong></span>://localhost:5432/<span class="strong"><strong>db1</strong></span>");
    dataSource.setUsername("<span class="strong"><strong>user1</strong></span>");
    dataSource.setPassword("<span class="strong"><strong>pass1</strong></span>");
     
    return dataSource;
}</pre></div></li><li class="listitem">In the Spring configuration, add a <code class="literal">JdbcTemplate </code>bean, taking <code class="literal">DataSource</code> as an argument:<div class="informalexample"><pre class="programlisting">@Bean
public JdbcTemplate jdbcTemplate(DataSource dataSource) {
  return new JdbcTemplate(dataSource);
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec68"/>How it works…</h2></div></div></div><p>A connection (a <code class="literal">Datasource</code> object) to a database named <code class="literal">db1</code> on the <code class="literal">3306</code> port (MySQL) or the <code class="literal">5432</code> port (PostgreSQL) using the <code class="literal">user1</code> user is created.</p><p>The <code class="literal">JdbcTemplate</code> bean is a Spring object that provides convenient methods to query a database using JDBC. It uses the previously defined <code class="literal">DataSource</code> bean. We will use the <code class="literal">JdbcTemplate</code> bean from our DAO classes.</p></div></div>
<div class="section" title="Creating a DAO class"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Creating a DAO class</h1></div></div></div><p>In this recipe, we will create a <span class="strong"><strong>DAO</strong></span> (<span class="strong"><strong>data access object</strong></span>) class. A DAO class provides methods to save and retrieve objects from the database. It can be used from a controller, for example:</p><div class="mediaobject"><img src="graphics/5807OS_04_01.jpg" alt="Creating a DAO class"/></div><p>The controller calls the <code class="literal">findUsers()</code> method from <code class="literal">UserDAO</code>, which takes care of getting the results from the database (using the <code class="literal">JdbcTemplate</code> bean defined in the previous recipe).</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec69"/>How to do it…</h2></div></div></div><p>Here are the steps to create a DAO class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a class annotated with <code class="literal">@Repository</code>:<div class="informalexample"><pre class="programlisting">@Repository
public class UserDAO {</pre></div></li><li class="listitem">Add an autowired <code class="literal">JdbcTemplate</code> field to it:<div class="informalexample"><pre class="programlisting">@Autowired
private JdbcTemplate jdbcTemplate;</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec70"/>How it works…</h2></div></div></div><p><code class="literal">@Repository</code> allows the <code class="literal">UserDAO</code> class to be automatically discovered and instantiated as a<a id="id174" class="indexterm"/> bean.</p><p>The <code class="literal">JdbcTemplate</code> field will be initialized automatically by Spring via dependency injection with the <code class="literal">JdbcTemplate</code> bean defined in the previous recipe.</p></div></div>
<div class="section" title="Calling a DAO method from a controller class"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Calling a DAO method from a controller class</h1></div></div></div><p>In this recipe, we'll see how to call a DAO method from a controller class.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec71"/>Getting ready</h2></div></div></div><p>We will use <a id="id175" class="indexterm"/>the DAO class defined in the previous<a id="id176" class="indexterm"/> recipe and pretend that it has an <code class="literal">add(User)</code> method. In the following recipes, we will write actual DAO methods.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec72"/>How to do it…</h2></div></div></div><p>Here are the steps to use a DAO method from a controller class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In your controller class, add the DAO as an <code class="literal">@Autowired</code> field:<div class="informalexample"><pre class="programlisting">@Controller
public class UserController {
  <span class="strong"><strong>@Autowired</strong></span>
<span class="strong"><strong>  private UserDAO userDAO;</strong></span>
</pre></div></li><li class="listitem">Use the DAO in any controller method:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>userDAO</strong></span>.add(user);</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec73"/>How it works…</h2></div></div></div><p>Because of <code class="literal">@Autowired</code>, the <code class="literal">userDAO</code> field will be automatically initialized by Spring using dependency injection.</p></div></div>
<div class="section" title="Saving an object"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Saving an object</h1></div></div></div><p>In this recipe, we <a id="id177" class="indexterm"/>will create a DAO method to save an object in the database; a row <a id="id178" class="indexterm"/>will be added to the corresponding database table, for example:</p><div class="mediaobject"><img src="graphics/5807OS_04_02.jpg" alt="Saving an object"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec74"/>Getting ready</h2></div></div></div><p>You need to have a model class, for example:</p><div class="informalexample"><pre class="programlisting">public class User {
  private Long id;
  private String firstName;
  private Integer age;</pre></div><p>You need to have a matching database table, for example:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `user` (
  `id` int(11) AUTO_INCREMENT,
  `first_name` text,
  `age` int(11),
  PRIMARY KEY (`id`)
)</pre></div><p>You need to<a id="id179" class="indexterm"/> have a DAO class with a <code class="literal">JdbcTemplate</code> attribute (Refer to<a id="id180" class="indexterm"/> the <span class="emphasis"><em>Creating a DAO class</em></span> recipe)</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec75"/>How to do it…</h2></div></div></div><p>Define an SQL insert query with question marks as placeholders for the actual row values. Use the <code class="literal">update()</code> method to execute the query using the actual values from the object:</p><div class="informalexample"><pre class="programlisting">public void add(User user) {
  String sql = "insert into user (first_name, age) values (?, ?)";
  <span class="strong"><strong>jdbcTemplate.update(</strong></span>sql, user.getFirstName(), user.getAge());
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec76"/>How it works…</h2></div></div></div><p>The <code class="literal">jdbcTemplate</code> object takes care of the JDBC boilerplate code; opening and closing a connection to the database and handling the exceptions. The <code class="literal">update()</code> method takes the SQL query and the actual values that will replace the question marks in the SQL query.</p></div></div>
<div class="section" title="Retrieving an object"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Retrieving an object</h1></div></div></div><p>In this recipe, we create a DAO method to retrieve a database row, which we will use to create an object.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec77"/>How to do it…</h2></div></div></div><p>Use an SQL select query and create an object from the result using <code class="literal">RowMapper</code>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the DAO class, add an inline class implementing <code class="literal">RowMapper</code>. This class defines how to generate a <code class="literal">User</code> object from a database row:<div class="informalexample"><pre class="programlisting">private class UserMapper implements RowMapper&lt;User&gt; {
  public User mapRow(ResultSet row, int rowNum) throws SQLException {
    User user = new User();

    user.setId(row.getLong("id"));
    user.setFirstName(row.getString("first_name"));
    user.setAge(row.getInt("age"));
    
    return user;
  }
}</pre></div></li><li class="listitem">Add a DAO method which will perform an SQL <code class="literal">select</code>  query and use a <code class="literal">UserMapper</code> object to generate a <code class="literal">User</code> object:<div class="informalexample"><pre class="programlisting">public User findById(Long id) {
  String sql = "select * from user where id=?";
  User user = jdbcTemplate.queryForObject(sql, new Object[]{id}, new UserMapper());
  return user;
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec78"/>How it works…</h2></div></div></div><p>The <code class="literal">queryForObject()</code> method uses <code class="literal">the</code> <code class="literal">UserMapper</code> object to generate a <code class="literal">User</code> object from the resulting <a id="id181" class="indexterm"/>database row.</p><p>In this <a id="id182" class="indexterm"/>example, we retrieve a user from its ID, which is the second argument of <code class="literal">queryForObject()</code>, as an element of an array.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec79"/>There's more…</h2></div></div></div><p>If the database column names match the names of the object attributes, there's no need to define a custom <code class="literal">RowMapper</code> interface, just use a <code class="literal">ParameterizedBeanPropertyRowMapper</code> class:</p><div class="informalexample"><pre class="programlisting">public User findById(Long id) {
  String sql = "select * from user where id=?";
  User user = jdbcTemplate.queryForObject(sql, new Object[]{id}, ParameterizedBeanPropertyRowMapper.newInstance(User.class));
  return user;
}</pre></div></div></div>
<div class="section" title="Retrieving a list of objects"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Retrieving a list of objects</h1></div></div></div><p>In this recipe, we <a id="id183" class="indexterm"/>will add a DAO method to retrieve database rows<a id="id184" class="indexterm"/> and create a list of objects from them.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec80"/>How to do it…</h2></div></div></div><p>Perform an SQL <code class="literal">select</code> query and generate a list of objects from the result using <code class="literal">RowMapper</code>:</p><div class="informalexample"><pre class="programlisting">public List&lt;User&gt; findAll() {
  String sql = "select * from user";
  List&lt;User&gt; userList = jdbcTemplate.query(sql, ParameterizedBeanPropertyRowMapper.newInstance(User.class));
  return userList;
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec81"/>How it works…</h2></div></div></div><p>The <code class="literal">query()</code> method <a id="id185" class="indexterm"/>uses <code class="literal">RowMapper</code> to generate objects from the<a id="id186" class="indexterm"/> returned database rows.</p><p>We used a <code class="literal">ParameterizedBeanPropertyRowMapper</code> class assuming that the database table columns match the object attributes; however, as in the previous recipe, a custom <code class="literal">RowMapper</code> interface can be used.</p></div></div>
<div class="section" title="Retrieving a list of objects with their dependencies"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec39"/>Retrieving a list of objects with their dependencies</h1></div></div></div><p>In this recipe, we will add a DAO method to generate, from an SQL query joining several tables, a list <a id="id187" class="indexterm"/>of objects with their <a id="id188" class="indexterm"/>dependencies. We will retrieve a list of <code class="literal">User</code> objects along with their <code class="literal">Post</code> objects (blog posts written by these users).</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec82"/>Getting ready</h2></div></div></div><p>You need to have model classes related to each other. In this example, a user has many posts:</p><div class="informalexample"><pre class="programlisting">public class User {
  private Long id;
  private String firstName;
  private Integer age;
  private LinkedList&lt;Post&gt; posts = new LinkedList&lt;Post&gt;();

public class Post {
  private long id;
  private String title;
  private Date date;
  private User user;</pre></div><p>You need to have corresponding database tables, for example:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `user` (
  `id` int(11) AUTO_INCREMENT,
  `first_name` text,
  `age` int(11),
  PRIMARY KEY (`id`)
)

CREATE TABLE `post` (
  `id` int(11) AUTO_INCREMENT,
  `title` text,
  `date` datetime,
  `user_id` int(11),
  PRIMARY KEY (`id`),
  CONSTRAINT `user_id` FOREIGN KEY (`id`) REFERENCES `user` (`id`)
)</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec83"/>How to do it…</h2></div></div></div><p>Use an <a id="id189" class="indexterm"/>SQL <code class="literal">select</code> query and generate<a id="id190" class="indexterm"/> a list of objects from the result using a class implementing <code class="literal">ResultSetExtractor</code>, which goes through the whole list of rows before returning the list of objects:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a DAO method performing an SQL <code class="literal">select</code> statement with <code class="literal">left join</code> and using <code class="literal">ResultSetExtractor</code> to generate a list of objects:<div class="informalexample"><pre class="programlisting">public List&lt;User&gt; findAll() {
  String sql = "select u.id, u.first_name, u.age, p.id as p_id, p.title as p_title, p.date as p_date from user u left join post p on p.user_id = u.id order by u.id asc, p.date desc";
  return jdbcTemplate.query(sql, new UserWithPosts());
}</pre></div></li><li class="listitem">Add an inline class implementing <code class="literal">ResultSetExtractor</code>:<div class="informalexample"><pre class="programlisting">private class UserWithPosts implements ResultSetExtractor&lt;List&lt;User&gt;&gt; {

  public List&lt;User&gt; extractData(ResultSet rs) throws SQLException,
      DataAccessException {
    
    Map&lt;Long, User&gt; userMap = new ConcurrentHashMap&lt;Long, User&gt;();
    User u = null;
    while (rs.next()) {
      // user already in map?
      Long id = rs.getLong("id");
      u = userMap.get(id);

      // if not, add it
      if(u == null) {
        u = new User();
        u.setId(id);
        u.setFirstName(rs.getString("first_name"));
        u.setAge(rs.getInt("age"));
        userMap.put(id, u);
      }
      
      // create post if there's one
      Long postId = rs.getLong("p_id");
      if (postId &gt; 0) {
        System.out.println("add post id=" + postId);
        Post p = new Post();
        p.setId(postId);
        p.setTitle(rs.getString("p_title"));
        p.setDate(rs.getDate("p_date"));
        p.setUser(u);
        u.getPosts().add(p);
      }
    }
    
    return new LinkedList&lt;User&gt;(userMap.values());
  }
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec84"/>How it works…</h2></div></div></div><p>Because<a id="id191" class="indexterm"/> of <code class="literal">left join</code>, we obtain a<a id="id192" class="indexterm"/> list of rows from the database with sometimes the same user, but representing different posts. Each row cannot be processed independently or we would end up creating the same user multiple times. So, we use <code class="literal">ResultSetExtractor</code>, which allows us to go through the list of rows.</p><p>We use a map of <code class="literal">User</code> objects to track whether the <code class="literal">User</code> for the current row has already been created.</p><p>In the SQL <a id="id193" class="indexterm"/>query, we explicitly listed the<a id="id194" class="indexterm"/> column names to ensure that they will have different names in the resulting rows. Otherwise, <code class="literal">Post id</code> could be confused with <code class="literal">User id</code>, for example.</p></div></div>
<div class="section" title="Updating an object"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec40"/>Updating an object</h1></div></div></div><p>In this recipe, we <a id="id195" class="indexterm"/>will add a DAO method to update an existing row in the <a id="id196" class="indexterm"/>database with an object's fields.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec85"/>How to do it…</h2></div></div></div><p>Use an SQL <code class="literal">update</code> query and execute it using the <code class="literal">update()</code> method:</p><div class="informalexample"><pre class="programlisting">public void update(User user) {
  String sql = "update user set first_name=?, age=? where id=?";
  jdbcTemplate.update(sql, user.getFirstName(), user.getAge(), user.getId());
}</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec86"/>There's more…</h2></div></div></div><p>It's convenient to also have a <code class="literal">save()</code> method that will create the database row if it doesn't exist:</p><div class="informalexample"><pre class="programlisting">public void save(User user) {
  if (user.getId() == null) {
    add(user);
  }
  else {
    update(user);
  }
}</pre></div></div></div>
<div class="section" title="Deleting an object"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec41"/>Deleting an object</h1></div></div></div><p>In this recipe, we <a id="id197" class="indexterm"/>will add a DAO method to delete an existing row from the database.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec87"/>How to do it…</h2></div></div></div><p>Use an SQL <code class="literal">delete</code> query and execute it using the <code class="literal">update()</code> method:</p><div class="informalexample"><pre class="programlisting">public void delete(User user) {
  String sql = "delete from user where id=?";
  getJdbcTemplate().update(sql, user.getId());
}</pre></div></div></div>
<div class="section" title="Finding the number of results for an SQL query"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec42"/>Finding the number of results for an SQL query</h1></div></div></div><p>In this recipe, we will add a DAO method to quickly get the number of results for an SQL query<a id="id198" class="indexterm"/> without actually loading the rows in the<a id="id199" class="indexterm"/> memory.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec88"/>How to do it…</h2></div></div></div><p>Use an SQL <code class="literal">count(*)</code> function and get the value directly using the <code class="literal">queryForObject()</code> method with a second argument specifying <code class="literal">Long</code> as the returned type:</p><div class="informalexample"><pre class="programlisting">public long countMinorUsers() {
  String sql = "select count(*) from age &lt; 18";
  return jdbcTemplate.queryForObject(sql, Long.class);
}</pre></div></div></div>
<div class="section" title="Saving a list of objects at once"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec43"/>Saving a list of objects at once</h1></div></div></div><p>In this recipe, we <a id="id200" class="indexterm"/>will add a DAO method to save a list of objects<a id="id201" class="indexterm"/> to the database efficiently.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec89"/>How to do it…</h2></div></div></div><p>Use the <code class="literal">batchUpdate()</code> method that takes an SQL <code class="literal">insert</code> query and a list of values as parameters:</p><div class="informalexample"><pre class="programlisting">public void add(List&lt;User&gt; userList) {
  String sql = "insert into user (first_name, age) values (?, ?)";
  
  List&lt;Object[]&gt; userRows = new ArrayList&lt;Object[]&gt;();
  for (User user : userList) {
        userRows.add(new Object[] {user.getFirstName(), user.getAge()});
  }
  
   jdbcTemplate.batchUpdate(sql, userRows);
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec90"/>How it works…</h2></div></div></div><p>A list of SQL<a id="id202" class="indexterm"/> <code class="literal">insert</code> queries will be generated from the SQL <code class="literal">insert</code> query string and <a id="id203" class="indexterm"/>the list of values. They will be sent to the database and committed all at once.</p></div></div>
<div class="section" title="Reverting incomplete database modifications using transactions"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec44"/>Reverting incomplete database modifications using transactions</h1></div></div></div><p>Some database modifications involve several SQL queries, for example, inserting an object with attributes spread across several tables. If one of the queries fails, we would want to undo any<a id="id204" class="indexterm"/> previous <a id="id205" class="indexterm"/>ones that were successful.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec91"/>How to do it…</h2></div></div></div><p>Here are the steps to make DAO methods transactional:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add <code class="literal">@EnableTransactionManagement</code> to the Spring configuration class:<div class="informalexample"><pre class="programlisting">@Configuration
@EnableWebMvc
<span class="strong"><strong>@EnableTransactionManagement</strong></span>
@ComponentScan(basePackages = {"com.spring_cookbook.controllers", "com.spring_cookbook.dao"})
public class AppConfig {
…</pre></div></li><li class="listitem">Add a <code class="literal">DataSourceTransactionManager</code> bean to the Spring configuration:<div class="informalexample"><pre class="programlisting">@Bean
public <span class="strong"><strong>DataSourceTransactionManager</strong></span> transactionManager() {
    DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
  transactionManager.setDataSource(dataSource());
  return transactionManager;
}</pre></div></li><li class="listitem">Annotate the DAO class with <code class="literal">@Transactional</code>:<div class="informalexample"><pre class="programlisting">@Repository
<span class="strong"><strong>@Transactional</strong></span>
public class UserDAO {
…</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec92"/>How it works…</h2></div></div></div><p><code class="literal">@Transactional</code> will enclose each DAO method in a <code class="literal">BEGIN…COMMIT</code> SQL block. So if there's an <a id="id206" class="indexterm"/>error (a runtime<a id="id207" class="indexterm"/> exception), any modification made by the DAO method to the database will be rolled back.</p></div></div>
<div class="section" title="Using Hibernate for powerful object persistence and querying"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec45"/>Using Hibernate for powerful object persistence and querying</h1></div></div></div><p>In this recipe, you<a id="id208" class="indexterm"/> will learn how to use Hibernate with<a id="id209" class="indexterm"/> Spring. We'll use a MySQL database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec93"/>Getting ready</h2></div></div></div><p>In this recipe, we'll use a MySQL database with the <code class="literal">user</code> table:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE user (
  id int NOT NULL AUTO_INCREMENT,
  first_name text,
  age int DEFAULT NULL,
  PRIMARY KEY (id)
);</pre></div><p>We'll use this corresponding JPA-annotated domain class:</p><div class="informalexample"><pre class="programlisting">@Entity
@Table(name = "user")
public class User {

  @Id
  @GeneratedValue
  private Long id;
  
  @Column(name = "first_name")
  private String firstName;
  
  private Integer age;
  
  // getters and setters.. </pre></div><p>For more<a id="id210" class="indexterm"/> information about the <span class="strong"><strong>Java Persistence API</strong></span> (<span class="strong"><strong>JPA</strong></span>), go to: <a class="ulink" href="http://docs.oracle.com/javaee/6/tutorial/doc/bnbpz.html">http://docs.oracle.com/javaee/6/tutorial/doc/bnbpz.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec94"/>How to do it…</h2></div></div></div><p>Here are<a id="id211" class="indexterm"/> the steps to integrate Hibernate with <a id="id212" class="indexterm"/>Spring:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the Maven dependencies for Spring ORM, Hibernate, and the JDBC driver for MySQL in <code class="literal">pom.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework&lt;/groupId&gt;
  &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;
  &lt;version&gt;4.1.6.RELEASE&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;mysql&lt;/groupId&gt;
  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;version&gt;5.1.35&lt;/version&gt;
&lt;/dependency&gt;  

&lt;dependency&gt;
  &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
  &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;
  &lt;version&gt;4.3.8.Final&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">Add <code class="literal">@EnableTransactionManagement</code> to the Spring configuration class:<div class="informalexample"><pre class="programlisting">@Configuration
@EnableWebMvc
<span class="strong"><strong>@EnableTransactionManagement</strong></span>
@ComponentScan(basePackages = {"com.spring_cookbook.controllers", "com.spring_cookbook.dao"})
public class AppConfig {
…</pre></div></li><li class="listitem"> In the Spring configuration, add a <code class="literal">dataSource</code> bean with the database connection details:<div class="informalexample"><pre class="programlisting">@Bean
public DataSource dataSource() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        
        dataSource.setDriverClassName("com.mysql.jdbc.Driver");
        dataSource.setUrl("jdbc:mysql://localhost:3306/db1");
        dataSource.setUsername("user1");
        dataSource.setPassword("pass1");
         
        return dataSource;
}</pre></div></li><li class="listitem">In the<a id="id213" class="indexterm"/> Spring configuration class, add a <code class="literal">sessionFactory</code> bean method taking a <code class="literal">Datasource</code> object as an argument. In this bean method, we tell Hibernate to generate SQL code specific to MySQL and declare our <code class="literal">User</code>  class:<div class="informalexample"><pre class="programlisting">@Bean
public SessionFactory sessionFactory(<span class="strong"><strong>DataSource dataSource</strong></span>) {
  LocalSessionFactoryBuilder sessionBuilder = new LocalSessionFactoryBuilder(dataSource);
  Properties props = new Properties();
  props.put("hibernate.dialect", "org.hibernate.dialect.<span class="strong"><strong>MySQLDialect</strong></span>");
  props.put("hibernate.show_sql", "true");
  sessionBuilder.addProperties(props);
  
  sessionBuilder.addAnnotatedClass(<span class="strong"><strong>User.class</strong></span>);
  
  return sessionBuilder.buildSessionFactory();
}</pre></div></li><li class="listitem">In the Spring configuration class, add a <code class="literal">HibernateTransactionManager</code> bean:<div class="informalexample"><pre class="programlisting">@Bean
public HibernateTransactionManager transactionManager(SessionFactory sessionFactory) {
  return new HibernateTransactionManager(sessionFactory);
}</pre></div></li><li class="listitem">Add the <code class="literal">SessionFactory</code> bean to your DAO classes using dependency injection:<div class="informalexample"><pre class="programlisting">@Autowired
SessionFactory sessionFactory;</pre></div></li><li class="listitem">Use this <code class="literal">SessionFactory</code> bean to control Hibernate as usual, for example, this is a DAO method which will add a <code class="literal">User</code> object into the database:<div class="informalexample"><pre class="programlisting">@Transactional
public void add(User user) {
  sessionFactory.getCurrentSession().saveOrUpdate(user);
}</pre></div></li></ol></div></div></div></body></html>