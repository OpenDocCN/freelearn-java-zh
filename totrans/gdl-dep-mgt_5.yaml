- en: Chapter 5. Publishing to a Maven Repository
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, you learned how to use the `Upload` task to publish
    your project artifacts. In this chapter, you will learn more about the new and
    still-developing feature of publishing your artifacts to a Maven repository.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: You will learn about the new publishing mechanism in Gradle. This feature is
    currently still under development, and that means the implementation might change
    in the future. But for now, this way of publishing artifacts will be the default.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Defining publication
  id: totrans-3
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We must add the `maven-publish` plugin to our project to add the new publication
    feature of Gradle. The plugin allows us to define and deploy our project artifacts
    in the Maven format. This means our deployed project can be used by other developers
    and projects that support the Maven format. For example, other projects could
    use Gradle or Maven and define a dependency to our published artifacts.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
- en: The `maven-publish` plugin is based on a general `publishing` plugin. The `publishing`
    plugin adds a new `publishing` extension to our project. We can use a `publications`
    configuration block in our build script to configure the artifacts we want to
    publish and the repositories we want to deploy to. The `publications` extension
    has the `PublishingExtension` type in the `org.gradle.api.publish` package. The
    plugin also adds the general life cycle `publish` task to the project. Other tasks
    can be added as task dependencies to this task; thus, with a single `publish`
    task, all the publications in the project can be published.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
- en: The `maven-publish` plugins also add extra task rules to the project. There
    is a task to generate a Maven POM file for each publication in the project. The
    plugins also add a new task rule to publish each publication to the local Maven
    repository. Finally, a task rule is added based on a combination of the publication
    and the repository, to publish a publication to the specified repository.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s create an example build file and apply the `maven-publish` plugin to
    see the new task:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-8
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Now, we will invoke the `tasks` task from the command line:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-10
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: We can see the `publish` and `publishToMavenLocal` tasks in the output. The
    dynamic task rules for publishing single publications to repositories are not
    shown.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: To configure our publications, we must first add a `publishing` configuration
    block. Inside the block, we define the `publications` configuration block. In
    this block, we define a publication. A publication defines what needs to be published.
    The `maven-publish` plugin expects a publication to have the `MavenPublication`
    type found in the `org.gradle.api.publish.maven` package. Besides the artifacts
    that need to be published, we can also define details for the generated POM file.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: Defining publication artifacts
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Any publication we define must have a unique name in our project. We can add
    multiple publications with their own names inside a `publications` configuration
    block. To add an artifact, we can use the `artifact` method in the publication
    definition. We can also use the `artifacts` property to directly set all artifacts.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: 'We can define artifacts with the `artifact` method in the following ways:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: '| Type | Description |'
  id: totrans-16
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  id: totrans-17
  prefs: []
  type: TYPE_TB
- en: '| `AbstractArchiveTask` | The information for the artifact is extracted from
    the archive task. The artifact is an instance of `PublishArtifact` in the `org.gradle.api.artifacts`
    package. |'
  id: totrans-18
  prefs: []
  type: TYPE_TB
- en: '| `File` | The information for the artifact is extracted from the filename.
    |'
  id: totrans-19
  prefs: []
  type: TYPE_TB
- en: '| `Map` | This is another way to define artifacts. The map must contain a `source`
    key referencing a file or archive task. The other properties we can use to further
    configure the artifact are `classifier` and `extension`. |'
  id: totrans-20
  prefs: []
  type: TYPE_TB
- en: Using archive task artifacts
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In the following example build file, we define a new publication with the name
    `publishJar`, and we define the output of the `jar` archive task as an artifact:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Next, we will run the `tasks` task and, in the output, we will be able to see
    newly generated tasks for publishing this publication:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Notice the two extra tasks, `generatePomFileForPublishJarPublication` and `publishPublishJarPublicationToMavenLocal`.
    The name of the publication, `publishJar`, is used for the two tasks. Gradle uses
    the `generatePomFileFor<publicationName>Publication` pattern for a task to generate
    a POM for a publication. The task pattern to publish a publication to the local
    Maven repository is `publish<publicationName>PublicationToMavenLocal`. Later in
    this chapter, we will see how we can add other repositories. We cannot yet invoke
    the tasks because we also need to set the `group` and `version` project properties,
    but we will cover this in the section about generating a POM file. We can now
    focus on defining the artifacts for a publication in this section.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: We are not restricted to one artifact for a publication; we can add more by
    invoking the `artifact` method multiple times. Or, we can use the `artifacts`
    property to assign multiple artifacts. It is important that each artifact should
    have unique `classifier` and `extension` property values for a single publication.
    Gradle will check this before we can invoke any tasks, so we immediately get an
    error message when the artifacts don't have a unique combination of `classifier`
    and `extensions` property values.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example build file, we add two extra artifacts to our publication
    with the `artifact` method:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Instead of using the `artifact` method, we can also use the `artifacts` property
    and assign multiple artifacts. Each of the artifacts we assign must have a unique
    combination of `classifier` and `extension` property values. In the next example
    build file, we will use the same artifacts as in the previous example but, this
    time, we will assign them to the `artifacts` property:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Using file artifacts
  id: totrans-32
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Instead of an archive task, we can also use a file as an artifact. Gradle tries
    to extract the `extension` and `classifier` properties from the filename. We can
    also configure these properties ourselves when we add the file as a publication
    artifact.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example build file, we use the `src/files/README` and `src/files/COPYRIGHT`
    files as publication artifacts:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Using software components
  id: totrans-36
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Besides the `artifact` method and the `artifacts` property, we can also use
    the `from` method inside a `publications` configuration block. We specify `SoftwareComponent`
    for Gradle as an argument to the `from` method. The `java` plugin adds `SoftwareComponent`
    with the name `java`, and it includes the `jar` artifact and all runtime dependencies.
    The `war` plugin adds the `war` artifact as `SoftwareComponent`. `SoftwareComponent`
    is a part of the Gradle build model that defines a piece of code that depends
    on other code or is a dependency for other code.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: 'In the next example build file, we will apply the `war` plugin to our project,
    which will implicitly add the `java` plugin. We also define two publications,
    each using `SoftwareComponent` from both plugins. The following code shows this:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Generating POM files
  id: totrans-40
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: An important part of a Maven publication is the POM file. We already saw that
    Gradle added a `generatePom<publicationName>` task to our project. Furthermore,
    we can define some properties of the POM file inside a publication configuration.
    Gradle also offers a hook to customize the generated POM file even further.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: 'Gradle uses the project''s `version`, `group`, and `name` properties in the
    generated POM file. We create a new example build file where we define the project
    properties so that they are included in the POM file. The following code shows
    this:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Now we execute the `generatePomFileForSamplePublication` task. The `pom-default.xml`
    file is created in the `build/publications/sample` directory. If we open the file,
    we can see that the `groupId`, `artifactId`, and `version` elements are filled
    with the values from our Gradle build file. This is shown in the following code:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'We can override the values for `groupId`, `artifactId`, and `version` inside
    a publication configuration. We use the `groupId`, `artifactId`, and `version`
    properties to set values other than the default values taken from the project
    properties. In the next example build file, we will use these methods to set the
    values:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Upon executing the `generatePomFileForSamplePublication` task again, we can
    see the new values in the generated POM file. The following code shows this:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: You may already have noticed that the `generatePomFile<publicationName>Publication`
    task also added a `dependencies` element in the generated POM file. The dependencies
    of our project are added as runtime dependencies in the POM file. This happens
    because we use the `from` method with the `components.java` value inside our publication
    configuration. The Java software component not only adds the `jar` archive tasks
    as an artifact, but also turns the project dependencies in to Maven runtime dependencies.
    If we use an archive task to define an artifact, the `dependencies` element is
    not added to the POM file.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example build file, we use the `artifact` method to define
    the publication:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'When we run the `generatePomFileForSamplePublication` task from the command
    line, the POM file is generated. The contents of the POM file are now as follows:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: In the next section, we will learn how we can customize the POM file using a
    hook. We can then, for example, also change the Maven dependency scope for our
    project dependencies.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: Customizing the POM file
  id: totrans-56
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To add some extra elements to the generated POM file, we must use the `pom`
    property that is a part of `MavenPublication`. This returns a `MavenPom` object,
    and we can invoke the `withXml` method from this object to add extra elements
    to the POM file. We will use a closure with the `withXml` method to access an
    `XmlProvider` object. With the `XmlProvider` object, we can get a reference to
    a DOM element with the `asElement` method, a Groovy node object with the `asNode`
    method, or the `StringBuilder` object with the `asString` method to extend the
    POM XML.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example build file, we add the `organization` and `issueMangement`
    elements to the generated POM file:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'If we generate the POM file, we can see our newly created elements in the XML
    version. This is shown in the following code:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: In the previous section, we already learned that, if we use the `from` method
    with the `components.java` value, all project dependencies are added as runtime
    dependencies in the generated POM file. This might always not be what we want.
    Using the `withXml` method, not only can we add new elements, we can also change
    values.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s add a hook where we change the runtime scope for dependencies to compile
    the scope. In the next build file, we will implement this:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'The generated POM file now has the following contents:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Another solution would be to configure the publication, not with the `from`
    method but with the `artifact` method. Then, `dependencies` is not added to the
    POM file because Gradle cannot determine the dependencies for an artifact. Using
    the `withXml` method, we can add it ourselves based on the project dependencies.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example build file, this solution is implemented:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'When we invoke the `generatePomFileForSamplePublication` task, we get the following
    POM file:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Defining repositories
  id: totrans-72
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We must configure a Maven repository to publish our configured publication.
    We can choose a local directory or a repository manager, such as Artifactory or
    Nexus. Gradle also adds support installing the publication to our local Maven
    repository.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
- en: Publishing to the local Maven repository
  id: totrans-74
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Gradle already adds our local Maven repository as a destination for our publications.
    For each named publication, there is a `publish<publicationName>ToMavenLocal`
    task. Gradle also creates the `publishToMavenLocal` task, which will publish all
    publications to the local Maven repository.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: 'We have the following example build file:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'From the command line, we will run the `publishToMavenLocal` task and see which
    tasks are executed:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: You may have noticed that first the publication artifact is created with the
    `jar` task and its task dependencies. Also, the POM file is generated, and our
    publication is copied to the local Maven repository via the `publishPublishJarPublicationToMavenLocal`
    task, which is a task dependency for `publishToMavenLocal`.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: 'When we look at the local Maven repository directory, we see that our project
    artifact is published:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Publishing to the Maven repository
  id: totrans-83
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If we have our own company's Maven repository or a directory where we want to
    publish our publications, then we must add it to the `publishing` configuration
    block. Inside the block, we can add the `repositories` configuration block containing
    one or more named repositories. For the combination of each publication and repository,
    Gradle creates a task with the `publish<publicationName>To<repositoryName>Repository`
    name pattern.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we will define a simple directory repository in the next example build
    file with the name `localRepo`:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'First, we will run the `tasks` task to see which task is added to the `Publishing
    tasks` group:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'To publish our project''s artifact, we can execute the `publishPublishJarPublicationToLocalRepoRepository`
    or `publish` task. The following output shows the tasks that are executed:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Once the task is performed, we get the following files in the `build/localRepo`
    directory:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Publishing to Artifactory
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To publish our publications to an Artifactory repository with a Maven layout,
    we only have to configure the repository in the `publications.repositories` configuration
    block. We can set the `url` property, a `name`, and optional security credentials.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
- en: 'In the next example build file, we use an Artifactory repository to which we
    publish the publication:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Gradle creates a new `publishPublishJarPublicationToArtifactoryRepository`
    task based on the publication name and the repository name. When we invoke the
    task, we can see that the publication is deployed to the Artifactory repository.
    The following code shows this:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'When we open the Artifactory web application in a web browser, we can see that
    our project is now part of the repository, as shown in the following screenshot:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
- en: '![Publishing to Artifactory](img/image00131.jpeg)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
- en: Publishing to Nexus
  id: totrans-101
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Another repository manager is Nexus. Publishing to a Nexus repository manager
    is not much different than publishing to Artifactory or a local directory. We
    only have to change the `url` property to reference the repository and set the
    optional security credentials.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个仓库管理器是 Nexus。将发布物发布到 Nexus 仓库管理器与发布到 Artifactory 或本地目录并没有太大的区别。我们只需要更改 `url`
    属性以引用仓库，并设置可选的安全凭据。
- en: 'In the following example build file, we use a Nexus repository manager:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例构建文件中，我们使用 Nexus 仓库管理器：
- en: '[PRE29]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'This time, the `publishPublishJarPublicationToNexusRepository` task is created.
    The task is also added as a task dependency to the `publish` task. To accomplish
    this, use the following code:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 这次，创建了 `publishPublishJarPublicationToNexusRepository` 任务。该任务也被添加为 `publish`
    任务的依赖任务。为了完成这个任务，请使用以下代码：
- en: '[PRE30]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'When we take a look with the Nexus web application inside the repository, we
    can see that our project is added to the repository, as shown in the following
    screenshot:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们在仓库内部查看 Nexus 网络应用程序时，我们可以看到我们的项目被添加到了仓库中，如下面的截图所示：
- en: '![Publishing to Nexus](img/image00132.jpeg)'
  id: totrans-108
  prefs: []
  type: TYPE_IMG
  zh: '![发布到 Nexus](img/image00132.jpeg)'
- en: Summary
  id: totrans-109
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, you learned how to use the new and developing `maven-publish`
    plugin. You saw how you can declare your publications with the `publications`
    configuration block. Gradle will automatically create new tasks based on what
    you declared as publications.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你学习了如何使用新的和正在发展的 `maven-publish` 插件。你看到了如何使用 `publications` 配置块声明你的发布物。Gradle
    将会根据你声明的发布物自动创建新的任务。
- en: You also learned how to customize the POM file that is generated by the Gradle
    publishing tasks.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 你还学习了如何自定义 Gradle 发布任务生成的 POM 文件。
- en: Finally, you saw how you can configure Maven repositories so you can deploy
    your publications to them. We configured a local directory, which could also be
    a network share, and showed you how to configure an Artifactory or Nexus repository
    manager.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你看到了如何配置 Maven 仓库，以便你可以将你的发布物部署到它们。我们配置了一个本地目录，这也可以是一个网络共享，并展示了如何配置 Artifactory
    或 Nexus 仓库管理器。
- en: In the next chapter, you will see how you can upload to Bintray.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，你将看到如何上传到 Bintray。
