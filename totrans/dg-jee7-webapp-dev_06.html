<html><head></head><body><div class="book" title="Chapter&#xA0;6.&#xA0;JSF Flows and Finesse" id="aid-1MBG21"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch06" class="calibre1"/>Chapter 6. JSF Flows and Finesse</h1></div></div></div><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="blockquote1" summary="Block quote"><tr class="calibre12"><td valign="top" class="calibre13"> </td><td valign="top" class="calibre13"><p class="calibre14"><span><em class="calibre15">"I've had a chance to fly a lot of different airplanes, but it was nothing like the shuttle ride."</em></span></p></td><td valign="top" class="calibre13"> </td></tr><tr class="calibre12"><td valign="top" class="calibre13"> </td><td colspan="2" valign="top" class="calibre16">--<span><span><em class="calibre15">Commander Chris Hadfield</em></span></span></td></tr></table></div><p class="calibre7">This chapter is about Faces Flow, a new feature in JSF 2.2. The idea of flows stems from the concepts of workflows and business process management. A workflow is often an orchestrated and a repeatable sequence of business activities performed in order to do a unit of achievable work efficiently. The unit of work can involve transformation of state, processing of data, and/or provision of a service or information.</p><p class="calibre7">The checkout process in many web e-commerce applications is a good example of a workflow as it appears to the user. When you buy a product from Amazon, the site takes you to a separate area of the website for entering details. Behind the scenes, Amazon will gracefully move you from the micro service, which is responsible for handling products in the electronic and photography section, to the micro service that is the first step in the checkout workflow. You log in to your account or create a new one, and then you decide on the shipping address. Next, you pay with your credit or debit card, and Amazon will challenge you with an invoice address. Finally, you can choose how you want your products to be delivered. You can choose to group items together and also select express or regular delivery. Amazon is a complicated workflow to replicate; however, JSF allows the digital developer to build up from the fundamental simple flows.</p><p class="calibre7">Workflows also appear in rich user client applications for people who use desktop computers, especially in the government and financial services industry. You may have witnessed workflow-like applications that are case working systems, trading systems, and warehouse systems. The idea is essentially the same, which is to guide the employee through separate steps in a business process from start to finish.</p><p class="calibre7">In JSF 2.2, Faces Flow provides the basic programming API to create a behavior and user experience that resembles the workflow in general applications. Open source frameworks such as Apache MyFaces CODI (Orchestration module), Spring Web Flow, and the proprietary <a id="id646" class="calibre1"/>Oracle <span class="strong"><strong class="calibre8">Application Development Framework</strong></span> (<span class="strong"><strong class="calibre8">ADF</strong></span>) inspired the design of Faces Flow.</p><div class="book" title="What is Faces Flow?"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec50" class="calibre1"/>What is Faces Flow?</h1></div></div></div><p class="calibre7">Faces Flow is the encapsulation of backing beans having a special scope with the related pages into a <a id="id647" class="calibre1"/>module. A Faces Flow is a module with a single, well-defined entry point and one or more exit points. The application developer determines how a Faces Flow is comprised and how it would function. In other words, Faces Flow is a low-level API, whereas other frameworks, with BPM in particular, feature higher-level configurations and macro-level processes.</p><div class="book"><ul class="itemizedlist"><li class="listitem">A JSF Faces Flow is modular in execution; a flow can invoke another flow in a nested fashion.</li><li class="listitem">Faces Flow can pass parameters to another nested flow and the nested flow can also return data through a special map property called the Flow Scope.</li><li class="listitem">Application developers can package a flow with the corresponding pages into a module, which may be distributed to a third-party developer.</li><li class="listitem">There is a brand new scope called <code class="email">FlowScoped</code>, which denotes whether a POJO is a flow-scoped bean. The annotation for this is <code class="email">@javax.faces.flow.FlowScoped</code>. A flow-scoped bean is compatible with CDI; so you can use the familiar Java EE annotations and order inject references to other beans and EJB elements.</li><li class="listitem">You can write action-controller methods and handle the logic inside the flow-scoped beans as you would with <code class="email">@RequestScoped</code>, <code class="email">@ConversationScoped</code>, <code class="email">@SessionScoped</code>, and <code class="email">@ApplicationScoped</code> beans.</li></ul></div></div></div>
<div class="book" title="Flow definitions and lifecycle" id="aid-1NA0K1"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec51" class="calibre1"/>Flow definitions and lifecycle</h1></div></div></div><p class="calibre7">Faces Flows use the <code class="email">@FlowScoped</code> beans where the user can enter a single page, which is known as the <a id="id648" class="calibre1"/>start page. After entering the flow, the user can navigate the pages, which are associated with the flow. The user can exit the flow at predefined points. A <a id="id649" class="calibre1"/>flow can invoke a nested flow.</p><p class="calibre7">The lifecycle of the <code class="email">@FlowScoped</code> beans is greater than the <code class="email">@ViewScoped</code> beans, but shorter than that of <code class="email">@SessionScoped</code>. Therefore, we can compare flow scoped beans to their conversational brethren. A <code class="email">@ConversationalScoped</code> bean maintains a state for all the views and web page tabs in a browser. Like their conversation mates, the <code class="email">@FlowScoped</code> beans survive multiple requests; in fact, they are even better, because they have different instances for multiple windows in a session. The flow-scoped bean is not shared between browser tabs.</p><p class="calibre7">As the user enters and leaves the flows in the application, Faces Flows has a dedicated CDI scope, which the JSF framework implementation uses to activate and passivate the data of the bean.</p><p class="calibre7">As soon as the user leaves a flow, that instance is susceptible to garbage collection by the JVM. Therefore, in comparison to <code class="email">@SessionScoped</code> and <code class="email">@ConversationalScoped</code> beans, flows<a id="id650" class="calibre1"/> tend to have lower memory demands.</p><p class="calibre7">The following<a id="id651" class="calibre1"/> diagram illustrates the scope of a Faces Flow.</p><div class="mediaobject"><img src="../Images/image00407.jpeg" alt="Flow definitions and lifecycle" class="calibre10"/></div><p class="calibre11"> </p></div>
<div class="book" title="Simple Implicit Faces Flows"><div class="book" id="aid-1O8H62"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec52" class="calibre1"/>Simple Implicit Faces Flows</h1></div></div></div><p class="calibre7">It is relatively straightforward to create an Implicit Faces Flow with just a folder name, an empty XML configuration, and some Facelet pages. A <code class="email">flow</code> is a folder name in your web application, preferably at the root directory. We start with the basic flow in the directory of the same <a id="id652" class="calibre1"/>name called <code class="email">digitalFlow</code>. Your flow must match the name of the folder.</p><p class="calibre7">In order to define an implicit flow, we create an empty XML file with the common basename and a suffix: <code class="email">digitalFlow/digitalFlow-flow.xhtml</code>.</p><p class="calibre7">We now create a start page in the folder with the common basename. This file is a Facelet view page called <code class="email">digitalFlow/digitalFlow.xhtml</code>.</p><p class="calibre7">We can create other pages in the flow inside the folder, and they can have any name we like. We might have <code class="email">digitalFlow/digitalFlow1.xhtml</code>, <code class="email">digitalFlow/checkout.xhtml</code>, or <code class="email">digitalFlow/song.xhtml</code>. Only the defined flow <code class="email">digitalFlow</code> can ever access these pages. If an outside call does attempt to access any of these pages, the JSF implementation will report an error.</p><p class="calibre7">In order to exit the<a id="id653" class="calibre1"/> implicit flow, we must provide a special page, <code class="email">/digitalFlow-return.xhtml</code>, in the root folder of the web application, which means that the file is located outside of the folder.</p><div class="book" title="Implicit navigation"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec62" class="calibre1"/>Implicit navigation</h2></div></div></div><p class="calibre7">Let's put this knowledge to good use with our first Faces Flow navigation example. In the source code, the <a id="id654" class="calibre1"/>project is called <code class="email">jsf-implicit-simple-flow</code>. It is helpful to examine the file layout for this project, which is as follows:</p><p class="calibre7">
<code class="email">src/main/java</code>
</p><p class="calibre7">
<code class="email">src/main/webapp</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/WEB-INF/classes/META-INF</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/index.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/assets/</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/resources/</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/basic-layout.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/view-expired.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/digitalFlow/</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/digitalFlow/digitalFlow.xml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/digitalFlow/digitalFlow.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/digitalFlow/digitalFlow-p2.xthml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/digitalFlow/digitalFlow-p2.xthml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/digitalFlow/digitalFlow-p4.xthml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/digitalFlow-return.xhtml</code>
</p><p class="calibre7">As you study the preceding layout, you notice that the project has a standard home page called <code class="email">index.xhtml</code>, as we would expect. It has a <code class="email">digitalFlow</code> folder, which is the special area of the website dedicated for this Faces Flow. Inside this directory, there are a bunch of Facelet files and a configuration. The start page is called <code class="email">digitalFlow.xhtml</code>, and there is an empty XML file reserved for a flow definition, <code class="email">digitalFlow.xml</code>.</p><p class="calibre7">By now you are already aware of the purpose of the assets and resources folders, but the we will come back to the <code class="email">view-expired.xhtml</code> file shortly. How do we ensure that our folder structure is treated as a Faces Flow?</p></div><div class="book" title="A Flow scoped bean"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec63" class="calibre1"/>A Flow scoped bean</h2></div></div></div><p class="calibre7">With the annotation <code class="email">@javax.faces.flow.FlowScoped</code>, we define a POJO as a flow scoped bean. The <a id="id655" class="calibre1"/>following is the code for our first Faces Flow, which is a backing bean:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.flows.control;
import javax.faces.flow.FlowScoped;
import javax.inject.Named;
import java.io.Serializable;

@Named
@FlowScoped("digitalFlow")
public class DigitalFlow implements Serializable {
    public String debugClassName() {
        return this.getClass().getSimpleName();
    }

    public String gotoPage1() {
        return "digitalFlow.xhtml";
    }

    public String gotoPage2() {
        return "digitalFlow-p2.xhtml";
    }

    public String gotoPage3() {
        return "digitalFlow-p3.xhtml";
    }

    public String gotoPage4() {
        return "digitalFlow-p4.xhtml";
    }

    public String gotoEndFlow() {
        return "/digitalFlow-return.xhtml";
    }
}</pre></div><p class="calibre7">The simple controller class, <code class="email">DigitalFlow</code>, has action methods such as <code class="email">gotoPage1()</code> and <code class="email">gotoPage2()</code> to move the user to the appropriate page in the flow. The method <code class="email">gotoEndFlow()</code> navigates to the return Facelet view that JSF detects in order to exit the flow.</p><p class="calibre7">The annotation of <code class="email">@FlowScoped</code> requires a single String value parameter, which in this case matches the name of the folder <code class="email">digitalFlow</code>. We shall now move to the views.</p></div><div class="book" title="Facelet views"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec64" class="calibre1"/>Facelet views</h2></div></div></div><p class="calibre7">We use flow-scoped beans in the Facelet views just as we use any other CDI scoped bean. The<a id="id656" class="calibre1"/> following is an extract of the home page, <code class="email">index.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html 
      
      
      
       &gt;

  &lt;ui:composition template="/basic_layout.xhtml"&gt;
    &lt;ui:define name="mainContent"&gt;
      &lt;h1&gt; JSF Implicit Simple Flow&lt;/h1&gt;

      &lt;p&gt;
        Welcome to a simple Faces Flow...
      &lt;/p&gt;

      &lt;div class="content-wrapper"&gt;
        &lt;h:form&gt;
          &lt;h:commandButton styleClass="btn btn-primary btn-lg"
            action="digitalFlow" value="Enter Digital Flow" /&gt;
        &lt;/h:form&gt;
      &lt;/div&gt;

      &lt;!-- ... --&gt;

    &lt;/ui:define&gt; &lt;!--name="mainContent" --&gt;
  &lt;/ui:composition&gt;
&lt;/html&gt;</pre></div><p class="calibre7">In the preceding view, the <code class="email">&lt;h:commandButton&gt;</code> defines an action with the name of the flow, <code class="email">digitalFlow</code>. Invoking this action causes JSF to enter the Faces Flow, which matches the corresponding annotated name of the backing bean.</p><p class="calibre7">JSF recognizes that a flow has implicit navigation, because the XML Flow Definition file <code class="email">digitalFlow.xml</code> is empty. This file must exist; otherwise, the implementation reports an error. You do not need the start or end tags inside the file either.</p><p class="calibre7">When a user invokes the button, JSF instantiates a flow scoped bean before it is forwarded to the start page. The following is an extract from the start page of the flow <code class="email">digitalFlow.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;html  ...&gt;
&lt;ui:composition template="/basic_layout.xhtml&gt;
  &lt;ui:define name="mainContent"&gt;
    &lt;!-- ... --&gt;
    &lt;div class="content-wrapper"&gt;
      &lt;h1&gt;Page &lt;code&gt;digitalFlow.xhtml&lt;/code&gt;&lt;/h1&gt;
      &lt;p&gt;View is part of a flow scope? &lt;code&gt;
      #{null != facesContext.application.flowHandler.currentFlow}
      &lt;/code&gt;.&lt;/p&gt;

      &lt;table class="table table-bordered table-striped"&gt;
          &lt;tr&gt;
              &lt;th&gt;Expression&lt;/th&gt;
              &lt;th&gt;Value&lt;/th&gt;
          &lt;/tr&gt;
          &lt;tr&gt;
              &lt;td&gt;digitalFlow.debugClassName()&lt;/td&gt;
              &lt;td&gt;#{digitalFlow.debugClassName()}&lt;/td&gt;
          &lt;/tr&gt;
      &lt;/table&gt;

      &lt;h:form prependId="false"&gt;
        &lt;h:commandButton id="nextBtn1"
          styleClass="btn btn-primary btn-lg"
          value="Next Direct" action="digitalFlow-2" /&gt;
        &amp;#160;
        &lt;h:commandButton id="nextBtn2"
          styleClass="btn btn-primary btn-lg"
          value="Next Via Bean" action="#{digitalFlow.gotoPage2()}" /&gt;
        &amp;#160;
        &lt;h:commandButton id="exitFlowBtn1"
          styleClass="btn btn-primary btn-lg"
          value="Exit Direct" action="/digitalFlow-return" /&gt;
        &amp;#160;
        &lt;h:commandButton id="exitFlowBtn2"
          styleClass="btn btn-primary btn-lg"
          value="Exit Via Bean" action="#{digitalFlow.gotoEndFlow()}" /&gt;
        &amp;#160;
      &lt;/h:form&gt;
    &lt;/div&gt;

  &lt;/ui:define&gt; &lt;!--name="mainContent" --&gt;
&lt;/ui:composition&gt;
&lt;/html&gt;</pre></div><p class="calibre7">The view demonstrates the invocation of the flow scoped bean with the familiar Expression Language as well as direct page-to-page navigation. To allow the user to move to the second page in the flow, we have two command buttons. The command button with the attribute action and value <code class="email">digitalFlow-2</code> is page navigation direct without validation of any form input whatsoever. The command button with the attribute action and the expression language value, <code class="email">#{digitalFlow.gotoPage2()}</code> is an invocation<a id="id657" class="calibre1"/> to the flow scoped bean's method, which means that the entire JSF lifecycle is executed.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip24" class="calibre1"/>Tip</h3><p class="calibre7">See <a class="calibre1" title="Chapter 2. JavaServer Faces Lifecycle" href="part0025.xhtml#aid-NQU22">Chapter 2</a>, <span class="strong"><em class="calibre9">JavaServer Faces Lifecycle</em></span>, if you have forgotten the different phases in the lifecycle.</p></div><p class="calibre7">In this view, we also generate the output, <code class="email">#{digitalFlow.debugClassName()}</code>, in order to illustrate that we can invoke arbitrary methods in a flow-scoped bean.</p><p class="calibre7">Let me also draw your attention to the expression language that establishes if a view is a part of the flow or not through the following practical content:</p><div class="informalexample"><pre class="programlisting">#{null != facesContext.application.flowHandler.currentFlow}</pre></div><p class="calibre7">This is functionally equivalent to the following Java statement:</p><div class="informalexample"><pre class="programlisting">null == FacesContext.getCurrentInstance().getApplication()
   .getFlowHandler().getCurrentFlow()</pre></div><p class="calibre7">The other pages, <code class="email">digitalFlow-p2.xhtml</code> and <code class="email">digitalFlow-p3.xhtml</code>, are very similar, because they just add the command buttons to navigate back to the previous views. You can see the full code as part of the book's source distribution.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip25" class="calibre1"/>Tip</h3><p class="calibre7">In digital work, we often provide well-known identifiers (IDs) to certain HTML elements, especially form controls. This helps when we are writing testing scripts for <a id="id658" class="calibre1"/>web automation testing, especially with the Selenium Web Driver framework (<a class="calibre1" href="http://www.seleniumhq.org/">http://www.seleniumhq.org/</a>).</p></div><p class="calibre7">We shall jump to the final view, <code class="email">digitalFlow-p4.xhtml</code> and just extract the form element for study:</p><div class="informalexample"><pre class="programlisting">&lt;h:form prependId="false"&gt;
  &lt;h:commandButton id="prevBtn1"
  styleClass="btn btn-primary btn-lg"
  value="Prev Direct" action="digitalFlow-p3" /&gt;
  &amp;#160;
  &lt;h:commandButton id="prevBtn2"
  styleClass="btn btn-primary btn-lg"
  value="Prev Via Bean" action="#{digitalFlow.gotoPage3()}" /&gt;
  &amp;#160;
  &lt;h:commandButton id="exitFlowBtn1"
  styleClass="btn btn-primary btn-lg"
  value="Exit Direct" action="/digitalFlow-return" /&gt;
  &amp;#160;
  &lt;h:commandButton id="exitFlowBtn2"
  styleClass="btn btn-primary btn-lg"
  value="Exit Via Bean" action="#{digitalFlow.gotoEndFlow()}" /&gt;
  &amp;#160;
&lt;/h:form&gt;</pre></div><p class="calibre7">As we can<a id="id659" class="calibre1"/> see, the preceding content illustrates how to navigate directly and through the <code class="email">DigitalFlow</code> backing bean. In order to exit the flow in an implicit navigation, the user must trigger an event that takes the JSF framework to the <code class="email">/digitalFlow-return.xhtml</code> view, which causes the flow to finish. Directly navigating to the return mode avoids validation, and any data inside the form input elements is lost. If we want to validate the form input elements as a form request, we must invoke a method in the action controller, the backing bean.</p><p class="calibre7">And that is implicit navigation in JSF Faces Flow.</p><p class="calibre7">It really is that easy, so let's see some screenshots of this simple flow starting with the home page <code class="email">/index.html</code>:</p><div class="mediaobject"><img src="../Images/image00408.jpeg" alt="Facelet views" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The start page <code class="email">digital-flow.xhtml</code> for <code class="email">DigitalFlow</code> appears like the following screenshot:</p><div class="mediaobject"><img src="../Images/image00409.jpeg" alt="Facelet views" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">After <a id="id660" class="calibre1"/>exiting the flow, the user sees the view <code class="email">/digitalFlow-return.xhtml</code>. The following is a screenshot of this view:</p><div class="mediaobject"><img src="../Images/image00410.jpeg" alt="Facelet views" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">If we<a id="id661" class="calibre1"/> attempt to access a Facelet view directly through a known URI <code class="email">/digitalFlow/digitalFlow.xhtml</code> before entering the flow, the view would be like the following screenshot:</p><div class="mediaobject"><img src="../Images/image00411.jpeg" alt="Facelet views" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">With GlassFish 4.1, we receive an HTTP Response Code of 500, which is an internal server <a id="id662" class="calibre1"/>error. Moreover, the CDI container raises an exception that there is no active flow scope.</p></div></div>
<div class="book" title="Handling view expired" id="aid-1P71O1"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec53" class="calibre1"/>Handling view expired</h1></div></div></div><p class="calibre7">I promised you that<a id="id663" class="calibre1"/> we would add some finesse to our digital application. If you've worked with JSF for a while, you probably have your fair share of stack traces with <code class="email">javax.faces.application.ViewExpiredException</code> as the root cause. This is one of the most notorious exceptions. You could increase the HTTP Session lifetime in order to compensate for an out-of-date request, but how long is break away from the computer for an average person? Meanwhile, the objects would persist in the memory. There is a better way and that is by using the Web XML deployment descriptor.</p><p class="calibre7">Inside the applications <code class="email">web.xml</code> file, we need to trigger a redirection to a more pleasant error page. The following is an extract of the XML file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app  ...&gt;
  &lt;!-- ... --&gt;
  &lt;error-page&gt;
    &lt;exception-type&gt;
    javax.faces.application.ViewExpiredException
    &lt;/exception-type&gt;
    &lt;location&gt;/view-expired.xhtml&lt;/location&gt;
  &lt;/error-page&gt;
  &lt;!-- ... --&gt;
&lt;/web-app&gt;</pre></div><p class="calibre7">The <code class="email">&lt;error-page&gt;</code> element specifies an association between an exception type and a page view. Whenever JSF encounters the exception type <code class="email">ViewExpiredException</code>, it will progress the response action to the page view <code class="email">/view-expired.xhtml</code>. The circumstance of this behavior is illustrated in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00412.jpeg" alt="Handling view expired" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">I am sure you'll<a id="id664" class="calibre1"/> agree that our public customer will enjoy this improved and dedicated page view rather than being puzzled with a stack trace.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip26" class="calibre1"/>Tip</h3><p class="calibre7">Flow scoped beans depend on CDI and, therefore, they require a Java EE 7 environment which dictates a CDI 1.1 container such as JBoss Weld. You must also use <code class="email">@Named</code> and not the older style <code class="email">@ManagedBean</code> annotation. If you don't use WildFly 8 or GlassFish 4, then before you dive into the code, please check your container's implementation support for the latest JSF and CDI specifications.</p></div><div class="book" title="A comparison with conversational scoped beans"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec65" class="calibre1"/>A comparison with conversational scoped beans</h2></div></div></div><p class="calibre7">If you recall, while using <code class="email">@ConversationScoped</code> beans, we had to explicitly demarcate the state <a id="id665" class="calibre1"/>of the conversation. We <a id="id666" class="calibre1"/>injected the <code class="email">Conversation</code> instance and from there, at specific points in the digital customer journey, called the <code class="email">begin()</code> and <code class="email">end()</code> methods. With <code class="email">@FlowScoped</code> CDI beans, the scope is automatically started and finished at defined points.</p></div><div class="book" title="Capturing the lifecycle of flow scoped beans"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec66" class="calibre1"/>Capturing the lifecycle of flow scoped beans</h2></div></div></div><p class="calibre7">Since the <a id="id667" class="calibre1"/>CDI container manages the<a id="id668" class="calibre1"/> flow scoped beans, they can participate normally in the contextual lifecycle. We can annotate a method with <code class="email">@PostConstruct</code> in <a id="id669" class="calibre1"/>order to initialize the bean, acquire a <a id="id670" class="calibre1"/>database resource, or compute cacheable data. Likewise, when the flow goes out of scope, we can annotate a method with <code class="email">@PreDestroy</code>.</p></div></div>
<div class="book" title="Declarative and nested flows"><div class="book" id="aid-1Q5IA2"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec54" class="calibre1"/>Declarative and nested flows</h1></div></div></div><p class="calibre7">Up to now, we have<a id="id671" class="calibre1"/> seen the implicit flow in action. Implicit flow is very <a id="id672" class="calibre1"/>straightforward for the simplest flow, which performs like a basic web wizard where the user is able to navigate linearly, going forward and backward. It can also use random access to navigate to pages.</p><p class="calibre7">If we want to take Faces Flow further, then we must delve into the XML flow definition, but first let us define some terms.</p><div class="book" title="The flow node terminology"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec67" class="calibre1"/>The flow node terminology</h2></div></div></div><p class="calibre7">The<a id="id673" class="calibre1"/> fundamental technology being inspired by workflow and BPM, the Faces Flow specification declares different types of nodes which are given in the following table:</p><div class="informalexample"><table border="1" class="blockquote1"><colgroup class="calibre18"><col class="calibre19"/><col class="calibre19"/></colgroup><thead class="calibre20"><tr class="calibre21"><th valign="bottom" class="calibre22">
<p class="calibre14">Node Type Name</p>
</th><th valign="bottom" class="calibre22">
<p class="calibre14">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<span><strong class="calibre26">View</strong></span>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Represents any type of application JSF view</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<span><strong class="calibre26">Method Call</strong></span>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Represents <a id="id674" class="indexterm"/>a method invocation in the flow graph through <span><strong class="calibre26">Expression Language</strong></span> (<span><strong class="calibre26">EL</strong></span>)</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<span><strong class="calibre26">Flow Call</strong></span>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Represents an invocation of another flow with outbound (call) and (return) inbound parameters</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<span><strong class="calibre26">Flow Return</strong></span>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Represents a return to the calling flow</p>
</td></tr><tr class="calibre21"><td valign="top" class="calibre13">
<p class="calibre14">
<span><strong class="calibre26">Switch</strong></span>
</p>
</td><td valign="top" class="calibre13">
<p class="calibre14">Represents navigation selection through logic determined by EL</p>
</td></tr></tbody></table></div><p class="calibre7">The following is an illustration of two flows that represent a shopping cart business process. The outside flow invokes the nested flow, which handles the delivery method.</p><div class="mediaobject"><img src="../Images/image00413.jpeg" alt="The flow node terminology" class="calibre10"/></div><p class="calibre11"> </p></div><div class="book" title="An XML flow definition description file"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec68" class="calibre1"/>An XML flow definition description file</h2></div></div></div><p class="calibre7">Given that <code class="email">&lt;&lt;Flowname&gt;&gt;</code> is a folder name in the web application, the flow description filename<a id="id675" class="calibre1"/> matches the pattern, <code class="email">&lt;&lt;Flowname&gt;&gt;/&lt;&lt;Flowname&gt;&gt;.xml</code>. The content of this descriptor file declares to JSF certain <a id="id676" class="calibre1"/>characteristics of the flow. It may define an alternative start page, define a set of return outcomes, and map certain outcomes to specific pages. The descriptor can also define the conditional Boolean logic that maps the outcomes to particular pages.</p><p class="calibre7">The following is an example of an XML flow definition file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;faces-config version="2.2"
  
  
  xsi:schemaLocation="
  http://xmlns.jcp.org/xml/ns/javaee
  http://xmlns.jcp.org/xml/ns/javaee/web-facesconfig_2_2.xsd"&gt;
  &lt;flow-definition id="flow-id"&gt;
  
    &lt;start-node&gt;startPage&lt;/start-node&gt;
    &lt;view id="startPage"&gt;
      &lt;vdl-document&gt;/flowname/start.xhtml&lt;/vdl-document&gt;
    &lt;/view&gt;

    &lt;view id="inside-flow-id-1"&gt; &lt;vdl-document&gt;
      /flowname/inside-flow-id-1.xhtml &lt;/vdl-document&gt;
    &lt;/view&gt;
    &lt;view id="inside-flow-id-2"&gt; &lt;vdl-document&gt;
      /flowname/inside-flow-id-2.xhtml &lt;/vdl-document&gt;
    &lt;/view&gt;

    &lt;flow-return id="return-from-flow-id-1"&gt;
      &lt;from-outcome&gt;/outside-page-1&lt;/from-outcome&gt;
    &lt;/flow-return&gt;
    &lt;flow-return id="return-from-flow-id-2"&gt;
      &lt;from-outcome&gt;/outside-page-21&lt;/from-outcome&gt;
    &lt;/flow-return&gt;

  &lt;/flow-definition&gt;
&lt;/faces-config&gt;</pre></div><p class="calibre7">The root<a id="id677" class="calibre1"/> element must be a <code class="email">&lt;faces-config&gt;</code> tag <a id="id678" class="calibre1"/>with the appropriate XML namespaces. You might be surprised by this choice of root element. This is because a flow definition can be defined globally, across the application, by setting the flow definition in the <code class="email">/WEB-INF/faces-config.xml</code> file. However, this practice is an advanced use case and not recommended for modular development.</p><div class="book" title="A flow definition tag"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec28" class="calibre1"/>A flow definition tag</h3></div></div></div><p class="calibre7">The <code class="email">&lt;flow-definition&gt;</code> element establishes the Faces Flow with the defined flow ID. The value <a id="id679" class="calibre1"/>of  the identifier must <a id="id680" class="calibre1"/>match the value for the <code class="email">@FlowScoped</code> bean. This element contains a collection of tags to establish the start page, views, flow returns, or the conditional switch statement.</p></div><div class="book" title="A mandatory flow return tag"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec29" class="calibre1"/>A mandatory flow return tag</h3></div></div></div><p class="calibre7">A Faces Flow<a id="id681" class="calibre1"/> must have at least one return <a id="id682" class="calibre1"/>outcome. The <code class="email">&lt;flow-return&gt;</code> element establishes a flow return node with an ID. It must contain a <code class="email">&lt;flow-outcome&gt;</code> element whose body content specifies the Facelet view.</p></div><div class="book" title="A view page tag"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec30" class="calibre1"/>A view page tag</h3></div></div></div><p class="calibre7">A flow may <a id="id683" class="calibre1"/>optionally define a set of View Nodes (pages) that are useful for direct navigation from one view to another, within<a id="id684" class="calibre1"/> the scope. The element <code class="email">&lt;view&gt;</code> tag establishes a view description language node through the element <code class="email">&lt;vdl-document&gt;</code>. A view requires an identifier. The body content of this tag simply references a Facelet view. Therefore, the view ID does not necessarily have be the same name as the Facelet view.</p></div><div class="book" title="An optional start page tag"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec31" class="calibre1"/>An optional start page tag</h3></div></div></div><p class="calibre7">The developer <a id="id685" class="calibre1"/>can override the<a id="id686" class="calibre1"/> name of the default start page and provide an alternative view. The body content of the element <code class="email">&lt;start-node&gt;</code> specifies the view ID and, therefore, references an appropriate flow, a View Node.</p></div><div class="book" title="Switch, conditional, and case tags"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec32" class="calibre1"/>Switch, conditional, and case tags</h3></div></div></div><p class="calibre7">The flow definition<a id="id687" class="calibre1"/> offers the developer the<a id="id688" class="calibre1"/> capability to define conditional<a id="id689" class="calibre1"/> logic through an element tag called <code class="email">&lt;switch&gt;</code>. This is the highest of the low-level features in the XML. The <code class="email">&lt;switch&gt;</code> tag <a id="id690" class="calibre1"/>specifies a Switch Node, which is very similar to the use <a id="id691" class="calibre1"/>of<a id="id692" class="calibre1"/> the <code class="email">&lt;if&gt;</code> tags within a <code class="email">&lt;navigation-case&gt;</code> in the <code class="email">/WEB-INF/faces-config.xml</code> file, obviously for non-flow navigation. The switch allows a single outcome in the flow to map more than one Facelet view by evaluating an EL expression with conditional logic.</p><p class="calibre7">The following is an extended version of the XML flow definition example file:</p><div class="informalexample"><pre class="programlisting">&lt;faces-config version="2.2" ...&gt;
  &lt;flow-definition id="flow-id"&gt;
    ...
    &lt;switch id="customerPaymentTab"&gt;
      &lt;case&gt;
        &lt;if&gt;
          #{controller.paymentType == 'CreditCard'}
        &lt;/if&gt;
        &lt;from-outcome&gt;creditcard&lt;/from-outcome&gt;
      &lt;/case&gt;
      &lt;case&gt;
        &lt;if&gt;
          #{controller.paymentType == 'DebitCard'}
        &lt;/if&gt;
        &lt;from-outcome&gt;debitcard&lt;/from-outcome&gt;
      &lt;/case&gt;
      &lt;case&gt;
        &lt;if&gt;
          #{controller.paymentType == 'PayPal'}
        &lt;/if&gt;
        &lt;from-outcome&gt;PayPal&lt;/from-outcome&gt;
      &lt;/case&gt;
      &lt;default-outcome&gt;bacs-direct&lt;/default-outcome&gt;
    &lt;/switch&gt;
    ...
  &lt;/flow-definition&gt;
&lt;/faces-config&gt;</pre></div><p class="calibre7">The <code class="email">&lt;switch&gt;</code> tag contains a number of <code class="email">&lt;case&gt;</code> elements and a single <code class="email">&lt;default-outcome&gt;</code> element. Each <code class="email">&lt;case&gt;</code> element contains a single <code class="email">&lt;if&gt;</code> and <code class="email">&lt;from-outcome&gt;</code> elements. The body<a id="id693" class="calibre1"/> content of the <code class="email">&lt;if&gt;</code> defines a <a id="id694" class="calibre1"/>conditional logic EL. The <code class="email">&lt;from-outcome&gt;</code> maps to the final Facelet view or it references the identifier of<a id="id695" class="calibre1"/> a View Node. It is a very good idea to a have a default outcome for a Switch Node. The body content of a <code class="email">&lt;default-outcome&gt;</code> establishes this outcome when none of the case conditions happen to evaluate to true.</p><p class="calibre7">In the example, we <a id="id696" class="calibre1"/>have<a id="id697" class="calibre1"/> an imaginary payment controller <a id="id698" class="calibre1"/>used in a checkout process on an e-commerce website. When the flow encounters an outcome <code class="email">customerPaymentTab</code>, which is the identifier for the Switch Node, JSF processes each of the case conditional logics in order. If one of those condition tests evaluates to true, then JSF chooses that outcome as the result of the switch. Let's say the <code class="email">#{controller.paymentType == 'DebitCard' }</code> is true, then debit card is the chosen view. If none of the tests evaluates to true, then the resulting view is <code class="email">bacs-direct</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip27" class="calibre1"/>Tip</h3><p class="calibre7">But shouldn't all logic be defined in a controller instead of a Switch Node? The answer is controversial either way, and it depends. If you are building an application with a complex graph of Faces Flows as a library developer, one can argue for this flexibility for external configurators. If you are building simple applications, then maybe following the practice of YAGNI (You Aren't Going to Need it) will benefit in a minimum viable product.</p></div><p class="calibre7">This covers all that we need to know about the basic flow definition file. Let's move on to the nested declarative flow now.</p></div></div><div class="book" title="A nested flow example"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec69" class="calibre1"/>A nested flow example</h2></div></div></div><p class="calibre7">It's time to see <a id="id699" class="calibre1"/>a practical example of Faces Flow with nested declarative flow definitions. Our application is simple. It allows the customer to record carbon footprint data. So first let's define a data record:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.flows.entity;
import javax.persistence.*;
import java.io.Serializable;

@Entity
@Table(name = "CARBON_FOOTPRINT")
@NamedQueries({
  @NamedQuery(name="CarbonFootprint.findAll",
    query = "select c from CarbonFootprint c "),
  @NamedQuery(name="CarbonFootprint.findById",
    query = "select c from CarbonFootprint c where c.id = :id"),
})
public class CarbonFootprint implements Serializable {
  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private long id;

  private String applicationId;
  private String industryOrSector;
  // KWh (main source)
  private double electricity;
  // KWh (main source)
  private double naturalGas;
  // Litres (travel commute costs)
  private double diesel;
  // Litres (travel commute costs)
  private double petrol;

  public CarbonFootprint() { }
 
  // hashCode(), equals() and toString()
  // Getters and setters omited
}</pre></div><p class="calibre7">The <code class="email">CarbonFootprint</code> is a JPA entity bean, which declares a set of properties to store the customer's carbon footprint data. The user can supply their industry or sector, the amount of electricity, natural gas, diesel, and petrol they consume over a time period. The record also has an <code class="email">applicationId</code> value, which we shall make use of.</p><p class="calibre7">Let's view the file layout for this project:</p><p class="calibre7">
<code class="email">src/main/java</code>
</p><p class="calibre7">
<code class="email">src/main/webapp</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/WEB-INF/classes/META-INF</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/index.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/assets/</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/resources/</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/basic-layout.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/view-expired.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/section-flow/</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/section-flow/section-flow.xml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/section-flow/section-flow.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/section-flow/section-flow-1a.xthml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/section-flow/section-flow-1b.xthml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/section-flow/section-flow-1c.xthml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/footprint-flow/</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/footprint-flow/footprint-flow.xml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/footprint-flow/footprint-flow.xhtml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/footprint-flow/footprint-flow-1a.xml</code>
</p><p class="calibre7">
<code class="email">src/main/webapp/endflow.xhtml</code>
</p><p class="calibre7">The project is <a id="id700" class="calibre1"/>called <code class="email">jsf-declarative-flows</code> and is available as a part of the book's source code. There are two flows: <code class="email">section-flow</code> and <code class="email">digital-flow</code>. The section flow captures the industry information in this made-up example. The footprint flow captures the energy consumption data. Both flows share a customer detail record, the <code class="email">CarbonFootprint</code> entity object, which you will see later in the backing beans.</p><div class="book" title="XML flow definitions"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec33" class="calibre1"/>XML flow definitions</h3></div></div></div><p class="calibre7">The following is<a id="id701" class="calibre1"/> the XML flow definition for the Sector flow, <code class="email">sector-flow/sector-flow.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;faces-config version="2.2" ...&gt;
  &lt;flow-definition id="sector-flow"&gt;
    &lt;flow-return id="goHome"&gt;
      &lt;from-outcome&gt;/index&lt;/from-outcome&gt;
    &lt;/flow-return&gt;
    &lt;flow-return id="endFlow"&gt;
      &lt;from-outcome&gt;#{sectorFlow.gotoEndFlow()}&lt;/from-outcome&gt;
    &lt;/flow-return&gt;

    &lt;flow-call id="callFootprintFlow"&gt;
      &lt;flow-reference&gt;
        &lt;flow-id&gt;footprint-flow&lt;/flow-id&gt;
      &lt;/flow-reference&gt;
      &lt;outbound-parameter&gt;
        &lt;name&gt;param1FromSectorFlow&lt;/name&gt;
        &lt;value&gt;param1 sectorFlow value&lt;/value&gt;
      &lt;/outbound-parameter&gt;
      &lt;outbound-parameter&gt;
        &lt;name&gt;param2FromSectorFlow&lt;/name&gt;
        &lt;value&gt;param2 sectorFlow value&lt;/value&gt;
      &lt;/outbound-parameter&gt;
      &lt;outbound-parameter&gt;
        &lt;name&gt;param3FromSectorFlow&lt;/name&gt;
        &lt;value&gt;#{sectorFlow.footprint}&lt;/value&gt;
      &lt;/outbound-parameter&gt;
      &lt;outbound-parameter&gt;
        &lt;name&gt;param4FromSectorFlow&lt;/name&gt;
        &lt;value&gt;#{sectorFlow.footprint.applicationId}&lt;/value&gt;
      &lt;/outbound-parameter&gt;
    &lt;/flow-call&gt;
  &lt;/flow-definition&gt;
&lt;/faces-config&gt;</pre></div><p class="calibre7">The identifier for this flow is sector-flow, which matches the folder name. It also establishes the <code class="email">@FlowScoped</code> value for the backing bean, the action controller, as we shall see later.</p><p class="calibre7">There are two <a id="id702" class="calibre1"/>Flow Return nodes, namely <code class="email">goHome</code> and <code class="email">endFlow</code>. The <code class="email">goHome</code> has direct navigation to the home page, whereas <code class="email">endFlow</code> invokes an action on the bean through the EL value, <code class="email">#{sectorFlow.gotoEndFlow()}</code>. This technique is particularly useful to ensure that a customer has entered correct and validated data before allowing them to complete their digital journey.</p><p class="calibre7">The new node <code class="email">callFootprintFlow</code> represents a nested flow invocation. The element <code class="email">&lt;flow-call&gt;</code> defines a Flow Call node. It must have a <code class="email">&lt;flow-reference&gt;</code> tag element with a nested tag, <code class="email">&lt;flow-id&gt;</code>. The body content of the latter defines the identifier of the target flow.</p><p class="calibre7">The <code class="email">&lt;outbound-parameter&gt;</code> elements specify how the parameters and value pairs are passed to the target flow. Each parameter requires a <code class="email">&lt;name&gt;</code> and a <code class="email">&lt;value&gt;</code> element. The name of the outgoing parameter in the calling flow must match the name of the incoming parameter in the invoked flow.</p><p class="calibre7">The <code class="email">param1FromSectorFlow</code> and <code class="email">param2FromSectorFlow</code> demonstrate how to pass the literal String values from one flow to another. If you are passing numeric values, then you have to encode and decode these values yourself in the target flow. The parameters <code class="email">param3FromSectorFlow</code> and <code class="email">param4FromSectorFlow</code> also illustrate how EL can be used. Note how we can easily pass the entity record <code class="email">#{sectorFlow.footprint}</code> from the Sector Flow to the Footprint Flow. We can also pass an individual property as we have done in the final parameter: <code class="email">#{sectorFlow.footprint.applicationId}</code>.</p><p class="calibre7">The following is the XML flow definition for the Footprint Flow <code class="email">footprint-flow/footprint-flow.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;faces-config version="2.2" ...&gt;
  &lt;flow-definition id="footprint-flow"&gt;
    &lt;flow-return id="goHome"&gt;
      &lt;from-outcome&gt;/index&lt;/from-outcome&gt;
    &lt;/flow-return&gt;
    &lt;flow-return id="exitFromFootprintFlow"&gt;
      &lt;from-outcome&gt;#{footprintFlow.exitFromFootprintFlow}&lt;/from-outcome&gt;
    &lt;/flow-return&gt;
    &lt;flow-return id="exitToSectionFlow"&gt;
      &lt;from-outcome&gt;/section-flow&lt;/from-outcome&gt;
    &lt;/flow-return&gt;

    &lt;inbound-parameter&gt;
      &lt;name&gt;param1FromSectorFlow&lt;/name&gt;
      &lt;value&gt;#{flowScope.param1Value}&lt;/value&gt;
    &lt;/inbound-parameter&gt;
    &lt;inbound-parameter&gt;
      &lt;name&gt;param2FromSectorFlow&lt;/name&gt;
      &lt;value&gt;#{flowScope.param2Value}&lt;/value&gt;
    &lt;/inbound-parameter&gt;
    &lt;inbound-parameter&gt;
      &lt;name&gt;param3FromSectorFlow&lt;/name&gt;
      &lt;value&gt;#{flowScope.param3Value}&lt;/value&gt;
    &lt;/inbound-parameter&gt;
    &lt;inbound-parameter&gt;
      &lt;name&gt;param4FromSectorFlow&lt;/name&gt;
      &lt;value&gt;#{flowScope.param4Value}&lt;/value&gt;
    &lt;/inbound-parameter&gt;

  &lt;/flow-definition&gt;
&lt;/faces-config&gt;</pre></div><p class="calibre7">This flow is <a id="id703" class="calibre1"/>identified by the name <code class="email">footprint-flow.xml</code>. It has a set of return flow nodes. The <code class="email">goHome</code> node actually exits the flows to the calling home, despite the view document value <code class="email">/index</code> value. You might think this behavior as odd. However, JSF is correct, because the current flow Footprint is a nested flow and it drives the flow pointer to the state of the calling flow sector. The nodes <code class="email">exitFromFootprintFlow</code> and <code class="email">exitToSectionFlow</code> represent different navigation strategies, indirect and direct respectively.</p><p class="calibre7">The set of <code class="email">&lt;inbound-parameter&gt;</code> elements specify the incoming parameter to the flow. The names of the parameters are extremely important, because they must match those in the corresponding <code class="email">&lt;outbound-parameter&gt;</code> element in the calling flow. The values define the EL object reference, which say where these values are written. In other words, the passing of parameters in Faces Flow behaves like a mapped property name transfer.</p><p class="calibre7">Let's analyze the third parameter from <code class="email">sector-flow.xml</code>. It sends a value of the entity record instance <code class="email">CarbonFootprint</code> to the nested Footprint Flow:</p><div class="informalexample"><pre class="programlisting">&lt;outbound-parameter&gt;
  &lt;name&gt;param3FromSectorFlow&lt;/name&gt;
  &lt;value&gt;#{sectorFlow.footprint}&lt;/value&gt;
&lt;/outbound-parameter&gt;</pre></div><p class="calibre7">Inside <code class="email">footprint-flow.xml</code>, the inbound parameter name matches the incoming parameter name:</p><div class="informalexample"><pre class="programlisting">&lt;inbound-parameter&gt;
  &lt;name&gt;param3FromSectorFlow&lt;/name&gt;
  &lt;value&gt;#{flowScope.param3Value}&lt;/value&gt;
&lt;/inbound-parameter&gt;</pre></div><p class="calibre7">The EL specifies the location where JSF sets the value of the parameter to the property of the object. In<a id="id704" class="calibre1"/> this case, the <code class="email">flowScope</code> map collection has a key and a value set. We can use any existing object that has a lifespan greater or equal to the flow lifecycle. We tend to use the <code class="email">flowScope</code>, because it is designed to pass parameters between Face Flows. Because we can reference properties in objects, we also have the ability to return information from the nested flows. The calling flow may retrieve the value after the nested flow ends.</p><p class="calibre7">Now that we understand the nested flows from the XML perspective, we can look at the Java source code.</p></div><div class="book" title="Flow beans"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec34" class="calibre1"/>Flow beans</h3></div></div></div><p class="calibre7">The <code class="email">sector-flow</code> backing<a id="id705" class="calibre1"/> bean looks as follows:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.flows.control;
import uk.co.xenonique.digital.flows.boundary.*;
import uk.co.xenonique.digital.flows.entity.*;
import uk.co.xenonique.digital.flows.utils.UtilityHelper;
// ...
@Named
@FlowScoped("sector-flow")
public class SectorFlow implements Serializable {
  @Inject UtilityHelper utilityHelper;
  @Inject CarbonFootprintService service;

  private CarbonFootprint footprint
   = new CarbonFootprint();

  public SectorFlow() {}

  @PostConstruct
  public void initialize() {
    footprint.setApplicationId(
      utilityHelper.getNextApplicationId());
  }

  public String gotoEndFlow() {
    return "/endflow.xhtml";
  }

  public String debugClassName() {
    return this.getClass().getSimpleName();
  }

  public String saveFootprintRecord() {
    service.add(footprint);
    return "sector-flow-1c.xhtml";
  }

  // Getters and setters ...
}</pre></div><p class="calibre7">The class <code class="email">SectorFlow</code> is annotated with <code class="email">@FlowScoped</code>, and the value matches the flow definition <a id="id706" class="calibre1"/>XML file. We annotate a method <code class="email">initialize()</code> with <code class="email">@PostConstruct</code> in order to set a random application ID in the entity record. Note that we cannot put this logic inside a normal Java constructor here, because our bean is given life through the CDI container.</p><p class="calibre7">We inject a couple of instances into <code class="email">SectorFlow</code>. The <code class="email">UtilityHelper</code> is an <code class="email">@ApplicationScoped</code> CDI POJO class that generates a random application identifier. There is a stateful EJB <code class="email">CarbonFootprintService</code> that handles the JPA persistence.</p><p class="calibre7">The <code class="email">gotoEndflow()</code> method is a navigation end to exit the flow. The method, <code class="email">saveFootprintRecord()</code> uses the data service to store the <code class="email">CarbonFootprint</code> entity into a database.</p><p class="calibre7">That completes the inner flow, that is, <code class="email">SectorFlow</code>; the code for the nested backing bean <code class="email">FootprintFlow</code> is as follows:</p><div class="informalexample"><pre class="programlisting">@Named
@FlowScoped("footprint-flow")
public class FootprintFlow implements Serializable {
  private CarbonFootprint footprint;
  public FootprintFlow() { }

  @PostConstruct
  public void initialize() {}
    Map&lt;Object,Object&gt; flowMap =
      FacesContext.getCurrentInstance()
        .getApplication().getFlowHandler()
        .getCurrentFlowScope();
    footprint = (CarbonFootprint) flowMap.get("param3Value");
  }

  public String exitFromFootprintFlow() {
    return "/endflow.xhtml";
  }

  public String gotoPage1() {
    return "footprint-flow";
  }

  public String gotoPage2() {
    return "footprint-flow-1a";
  }

  public String debugClassName() {
    return this.getClass().getSimpleName();
  }

  // Getters and setters ...
}</pre></div><p class="calibre7">We repeat the<a id="id707" class="calibre1"/> same trick as before; we annotate the <code class="email">FootprintFlow</code> class with <code class="email">@PostConstruct</code>. In the <code class="email">initialize()</code> method, we retrieve the object from the flow scope programmatically through the <code class="email">FacesContext</code> instance. Note that the parameter name <code class="email">param3Value</code> must agree with the value inside the XML definition. The value in the flow scope happens to be the <code class="email">CarbonFootprint</code> entity.</p><p class="calibre7">You must be wondering why we go to the trouble of retrieving an entity from a scope and setting it as a bean property? It is just an example, and allows the page content designer to use a consistent markup in the pages. The EL <code class="email">#{footprintFlow.footprint.diesel}</code> is more comprehensible than <code class="email">#{flowScope.param3Value.diesel}</code>.</p><p class="calibre7">We shall now move on to the markup.</p></div><div class="book" title="Page views"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec35" class="calibre1"/>Page views</h3></div></div></div><p class="calibre7">The<a id="id708" class="calibre1"/> content markup for page views is familiar to us by now. Let's study <code class="email">sector-flow/sector-flow.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;h1&gt;Page &lt;code&gt;sector-flow.xhtml&lt;/code&gt;&lt;/h1&gt;
...
&lt;table class="table table-bordered table-striped"&gt;
  &lt;tr&gt;
    &lt;th&gt;Expression&lt;/th&gt;
    &lt;th&gt;Value&lt;/th&gt;
  &lt;/tr&gt;
  ...
  &lt;tr&gt;
    &lt;td&gt;sectorFlow.footprint.applicationId&lt;/td&gt;
    &lt;td&gt;#{sectorFlow.footprint.applicationId}&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;sectorFlow.footprint&lt;/td&gt;
    &lt;td&gt;#{sectorFlow.footprint}&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;h:form prependId="false"&gt;
  &lt;div class="form-group"&gt;
    &lt;label jsf:for="exampleInputEmail1"&gt;
    Email address&lt;/label&gt;
    &lt;input type="email" class="form-control"
      jsf:id="exampleInputEmail1" placeholder="Enter email"
      jsf:value="#{flowScope.email}"/&gt;
  &lt;/div&gt;
  &lt;div class="form-group"&gt;
    &lt;h:outputLabel for="industryOrSector"&gt;Industry or Sector&lt;/h:outputLabel&gt;
    &lt;h:inputText type="text" class="form-control" id="industryOrSector"
       placeholder="Your industry sector"
       value="#{sectorFlow.footprint.industryOrSector}"/&gt;
  &lt;/div&gt;

  &lt;h:commandButton id="nextBtn" styleClass="btn btn-primary btn-lg" value="Next" action="sector-flow-1a" /&gt;
  &amp;#160;
  &lt;h:commandButton id="exitFlowBtn" styleClass="btn btn-primary btn-lg" value="Exit Flow" action="endFlow" /&gt;
  &amp;#160;
  &lt;h:commandButton id="homeBtn" styleClass="btn btn-primary btn-lg" value="Home" action="goHome" /&gt;
  &amp;#160;
  &lt;h:commandButton id="callFootPrintFlowBtn" styleClass="btn btn-primary btn-lg" value="Call Footprint" action="callFootprintFlow" /&gt;
  &amp;#160;
  &lt;h:commandButton id="saveBtn" styleClass="btn btn-primary btn-lg" value="Save Record" action="#{sectorFlow.saveFootprintRecord()}" /&gt;
  &amp;#160;
&lt;/h:form&gt;</pre></div><p class="calibre7">The view <a id="id709" class="calibre1"/>uses a mix of HTML5 friendly markup and the standard JSF tags. The input text field, <code class="email">exampleInputEmail1</code> and its associated label remind us about the HTML5 friendly markup. This input control is associated with the flow scope map collection, namely <code class="email">#{flowScope.email}</code>. The answer is yes, we are allowed to write this, but we had better store the data value somewhere in the application!</p><p class="calibre7">The input element <code class="email">industryOrSector</code> shows us the JSF standard tags and it is directly associated with the <code class="email">CarbonFootprint</code> entity record.</p><p class="calibre7">Let me draw your attention to the command button <code class="email">saveBtn</code> that invokes the action method <code class="email">saveFootprintRecord()</code> in the backing bean. Finally, there is a dedicated command button identified by <code class="email">callFootPrintFlowBtn</code>, which invokes the nested flows. The action <code class="email">callFootprintFlow</code> matches the node in the XML flow definition file for <code class="email">sector-flow.xml</code> exactly.</p><p class="calibre7">There is a <code class="email">nextBtn</code> command button that directly navigates to the next view in the flow. The <code class="email">homeBtn</code> command button exits the flow and returns  the home page.</p><p class="calibre7">The rest of the view shows debuggable output in an HTML Bootstrap style table. The <code class="email">prependId=false</code> on the JSF <code class="email">&lt;h:form&gt;</code> element informs JSF to avoid sugaring the property HTML identifiers for the controls.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note08" class="calibre1"/>Note</h3><p class="calibre7">The JSF Form <code class="email">prependId</code> specifies whether or not the <code class="email">&lt;h:form&gt;</code> should prepend its ID to its descendant's ID during the <code class="email">clientId</code> generation process. The flag becomes relevant when importing or inserting composite components that are forms in an outer form. This value defaults to true.</p></div><p class="calibre7">The following is a screenshot of the start page <code class="email">sector-flow/sector-flow.xhtml</code>:</p><div class="mediaobject"><img src="../Images/image00414.jpeg" alt="Page views" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">In the source<a id="id710" class="calibre1"/> code, we dumped out a set of debuggable values using EL. The project is called <code class="email">jsf-declarative-form</code> in the book's source code. You will find a cleaned-out professional version without debuggable output, which is called <code class="email">jsf-declarative-form-pro</code>.</p><p class="calibre7">The following is a screenshot of the nested flow, <code class="email">footprint-flow-1a.xhtml</code>. After navigating to the start page, we hit the <span class="strong"><strong class="calibre8">Next</strong></span> button, entered some data into the form, and save it.</p><div class="mediaobject"><img src="../Images/image00415.jpeg" alt="Page views" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Going <a id="id711" class="calibre1"/>back to <code class="email">SectorFlow</code>, when we invoke the <code class="email">SaveBtn</code> command button, JSF invokes the <code class="email">saveFootprintRecord()</code> method. The record is saved to the database and  the view <code class="email">sector-flow-1c.xthml</code> is displayed as seen in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00416.jpeg" alt="Page views" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The only <a id="id712" class="calibre1"/>parts that remain are the source code for the injected POJO, <code class="email">UtilityHelper</code> and the EJB, <code class="email">CarbonFootprintService</code>. Unfortunately, we cannot show all the listings in this book.</p></div></div></div>
<div class="book" title="A real-world example"><div class="book" id="aid-1R42S2"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec55" class="calibre1"/>A real-world example</h1></div></div></div><p class="calibre7">To wrap up Faces Flows, let's look at adding features to our application. We want our JSF application to have quality and finesse. In the book's source code, you will find these examples under<a id="id713" class="calibre1"/> the projects <code class="email">jsf-product-flow</code> and <code class="email">jsf-product-flow-s2</code>. The first project demonstrates the prototypical design of the concepts. The second project illustrates the improved and cleaned-up digital design with enough quality to present to a business stakeholder.</p><div class="book" title="Ensure the application populates the database"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec70" class="calibre1"/>Ensure the application populates the database</h2></div></div></div><p class="calibre7">Often, we develop applications that operate against a UAT database for testing. We write code that <a id="id714" class="calibre1"/>populates the database with test information, which does not go into production. In a lot of cases, we want to bootstrap our application just to check that the correct schema has been introduced.</p><p class="calibre7">Our first thought would be to create an <code class="email">@ApplicationScoped</code> POJO with an annotation <code class="email">@PostConstruct</code>, and this would solve our bootstrap issue. We can write a <code class="email">DataPopulator</code> class with the sole purpose to create data inside a development application. Although we have a firm-wide application instance, we cannot ensure that our bean is<a id="id715" class="calibre1"/> invoked after the startup of the web application.</p><p class="calibre7">With Java EE, we can use <code class="email">@javax.ejb.Startup</code> and <code class="email">@javax.ejb.Singleton</code> to start an EJB. The <code class="email">@Startup</code> annotation ensures that the EJB container initializes the bean after the application is deployed. The <code class="email">@Singleton</code> annotations denotes the session bean that guarantees that there is, at the most, one instance in the application.</p><p class="calibre7">The following is the code for the <code class="email">DataPopulator</code> bean:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.product.utils;
import javax.annotation.PostConstruct;
import javax.ejb.Singleton;
import javax.ejb.Startup;
import javax.inject.Inject;

@Singleton
@Startup
public class DataPopulator {
  @Inject ExtendedPersistenceLoaderBean loaderBean;

  @PostConstruct
  public void populate() {
    loaderBean.loadData();
  }
}</pre></div><p class="calibre7">So, in order to populate the application with data, we delegate another bean. The <code class="email">ExtendedPersistenceLoaderBean</code> is a CDI bean with a new CDI 1.1 transactional scope. The code for this delegate is as follows:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.product.utils;
import uk.co.xenonique.digital.product.boundary.*;
import uk.co.xenonique.digital.product.entity.*;
import uk.co.xenonique.digital.product.entity.*;
import javax.annotation.*;
import javax.ejb.*;
import javax.inject.Inject;
import java.io.Serializable;
import java.util.*;

@TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
@javax.transaction.TransactionScoped
public class ExtendedPersistenceLoaderBean implements Serializable {
  public static final String DEFAULT = "digital";

  @Inject
  UserProfileService service;

  @PostConstruct
  public void init() { /* ... */ }

  @PreDestroy
  public void destroy() { /* ... */ }

  public void loadData() {
    UserRole userRole = new UserRole("user");
    UserRole managerRole = new UserRole("manager");

    List&lt;UserProfile&gt; users = Arrays.asList(
      new UserProfile("user@products.com", DEFAULT, userRole),
      new UserProfile("test@products.com", DEFAULT, userRole),
      new UserProfile("admin@products.com", DEFAULT, managerRole),
    );

    for (UserProfile user: users) {
      service.add(user);
    }
  }
}</pre></div><p class="calibre7">We annotate<a id="id716" class="calibre1"/> the <code class="email">DataPopulator</code> bean with <code class="email">@TransactionScoped</code>. Whenever we invoke a method on the <code class="email">@TranscationScoped</code> bean, the method, the CDI container, will activate a transaction or have one created. A single transaction will be shared amongst many methods on the same bean or shared between other <code class="email">@TranscactionScoped</code> beans that may be called. In other words, the transaction context is passed around participating components without requiring the developer to add explicit method arguments to pass around <code class="email">javax.transaction.TransactionContext</code> instances.</p><p class="calibre7">Going back, we've added another special annotation to our <code class="email">DataPopulator</code> bean.</p><p class="calibre7">As soon as any method is invoked on this bean, the thread context becomes associated with a brand new transaction, because we annotated the class with <code class="email">@TransactionAttribute</code> and pass in an attribute value <code class="email">TranscationAttributeType.NEW</code>. This forces the container to create a new transaction, regardless of if there is one existing already. The lifecycle of the transaction scope is the duration of the call to the <code class="email">loadData()</code>. The method simply creates a couple of <code class="email">UserRole</code> entities in the database, and then it creates user accounts for the login with the <code class="email">UserProfile</code> entities.</p><p class="calibre7">Finally, the <code class="email">init()</code> and <code class="email">destroy()</code> methods just print the debug information to the console, and<a id="id717" class="calibre1"/> the details are not shown in the extract.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip28" class="calibre1"/>Tip</h3><p class="calibre7">Even though CDI 1.1 defines a <code class="email">@javax.inject.Singleton</code> annotation for CDI beans, this exact launch of a CDI bean is not defined in the specification, because this specification is missing in <code class="email">@javax.inject.Startup</code>. Therefore, we must rely on the EJB singleton startup bean. We probably have to wait until CDI 2.0 and Java EE 8 to see this annotation.</p></div><p class="calibre7">Now that we have user profiles and roles, how do we secure a JSF application?</p></div><div class="book" title="Securing page views and flows"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec71" class="calibre1"/>Securing page views and flows</h2></div></div></div><p class="calibre7">If you want to<a id="id718" class="calibre1"/> stay with the standard Java EE libraries, then <a id="id719" class="calibre1"/>the specification has the Container Managed Authentication feature. In order to take advantage of this feature, you extend the web deployment descriptor file, <code class="email">web.xml</code>, and add a security constraint to your application.</p><p class="calibre7">The following is an example of security constraints inside a <code class="email">web.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;public&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/products/*&lt;/url-pattern&gt;
    &lt;url-pattern&gt;/cart/*&lt;/url-pattern&gt;
    &lt;url-pattern&gt;/checkout/*&lt;/url-pattern&gt;
    &lt;url-pattern&gt;/promotions/*&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;role-name&gt;*&lt;/role-name&gt;
  &lt;/auth-constraint&gt;
  &lt;user-data-constraint&gt;
    &lt;transport-guarantee&gt;NONE&lt;/transport-guarantee&gt;
  &lt;/user-data-constraint&gt;
&lt;/security-constraint&gt;

&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;admin&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/admin/*&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;role-name&gt;admin&lt;/role-name&gt;
  &lt;/auth-constraint&gt;
  &lt;user-data-constraint&gt;
    &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
  &lt;/user-data-constraint&gt;
&lt;/security-constraint&gt;</pre></div><p class="calibre7">The first security <a id="id720" class="calibre1"/>constraint restricts the products, carts, checkout, and promotion pages of this website to any user. Note the wildcard given <a id="id721" class="calibre1"/>as the role name. The second security constraint restricts the admin pages of this website only to users with an admin role.</p><p class="calibre7">The <code class="email">&lt;user-data-constraint&gt;</code> element declares whether the page view is accessible with HTTP or HTTPS. It specifies the level of security required. The acceptable values are <code class="email">NONE</code>, <code class="email">INTEGRAL</code>, and <code class="email">CONFIDENTIAL</code>. Setting the transport guarantee to <code class="email">CONFIDENTIAL</code> informs the application server that these pages and resources are only accessible over SSL. The value of <code class="email">INTEGRAL</code> is important in communication when the data sent over the wire from the client or the server should not be changed in any way.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip29" class="calibre1"/>Tip</h3><p class="calibre7">Tip Java EE 8 Security—a word on the future TODO (note for me to check on updates <a id="id722" class="calibre1"/>and progress. See <a class="calibre1" href="https://javaee8.zeef.com/arjan.tijms">https://javaee8.zeef.com/arjan.tijms</a>). There are not too many alternatives to<a id="id723" class="calibre1"/> the standard Java EE security. The other choices are Apache Shiro (<a class="calibre1" href="http://shiro.apache.org/">http://shiro.apache.org/</a>) or Spring Security (formerly Acegi). It is hoped that Java EE 8 will include a revamp concept and perhaps a separate specification.</p></div><p class="calibre7">Whilst the standard mechanism is fast and easy to add, it is application-server specific. The mechanism applies only to coarse grain resources, and there are no annotations that we can apply to CDI beans. Java EE security requires the configuration of Security Realms, which defines the roles of groups of users. In order to secure a website with fine- grain permission, we have to add multiple roles, which can lead to high complexity.</p><p class="calibre7">It is possible to define our own custom security for JSF and the web applications. The advantage of this approach is that we have fine-grained control and it works across the containers. On the other hand, if we ignore the Java EE security standard features, then any home-baked security implementation is unlikely to have been sufficiently proven secure in the wild. Such a component will fail basic penetration testing. At best, custom security works if the requirements are straightforward and there are few demands on complex permissions.</p><p class="calibre7">In order to create custom security, we shall define a unique <code class="email">javax.servlet.ServletFilter</code>, which protects the access to certain areas of our website. The <code class="email">LoginAuthenticationFilter</code> is defined as follows:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.product.security;
import uk.co.xenonique.digital.product.control.LoginController;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.*;
import java.io.IOException;

@WebFilter(urlPatterns={"/protected/*", "/simple/*"})
public class LoginAuthenticationFilter implements Filter {
  private FilterConfig config;

  public void doFilter(ServletRequest req,
    ServletResponse resp, FilterChain chain)
    throws IOException, ServletException
  {
    final HttpServletRequest request =
      (HttpServletRequest)req;
    final HttpServletResponse response =
      (HttpServletResponse)resp;
    if (request.getSession().getAttribute(
      LoginController.LOGIN_KEY) == null) {
      response.sendRedirect(
      request.getContextPath()+LoginController.LOGIN_VIEW);
    } else {
      chain.doFilter(req, resp);
    }
  }

  public void init(FilterConfig config)
  throws ServletException {
    this.config = config;
  }

  public void destroy() {
      config = null;
  }
}</pre></div><p class="calibre7">We annotate <a id="id724" class="calibre1"/>the class with <code class="email">@WebFilter</code> with the <a id="id725" class="calibre1"/>URL resources that we want to protect. If a user attempts to access a page under the <code class="email">/protected/*</code> and <code class="email">/simple/*</code> folder, then the filter, <code class="email">LoginAuthenticationFilter</code> is triggered. The servlet container invokes the <code class="email">doFilter()</code> method and we check if an HTTP session attribute is defined or not. If the key <code class="email">LoginController.LOGIN_KEY</code> does exist, the user is logged into the site, otherwise, the user is redirected to the login page view.</p><p class="calibre7">Let's move<a id="id726" class="calibre1"/> to the backing bean <code class="email">LoginController</code>, which <a id="id727" class="calibre1"/>allows a user to log into the website:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.product.control;
// imports elided...

@Named("loginController") @RequestScoped
public class LoginController {
  public final static String LOGIN_KEY="LOGIN_USERNAME";
  public final static String LOGIN_VIEW="/login.xhtml";

  private String username;
  private String password;

  @Inject UserProfileService userProfileService;

  public boolean isLoggedIn() {
    return FacesContext.getCurrentInstance()
      .getExternalContext().getSessionMap()
      .get(LOGIN_KEY) != null;
  }

  public String login() {
      List&lt;UserProfile&gt; users =
        userProfileService.findById(username);
      if ( users.isEmpty()) {
        throw new IllegalArgumentException("unknown user");
      }
      if ( !users.get(0).getPassword().equals(password)) {
        throw new IllegalArgumentException("invalid password");
      }

      FacesContext.getCurrentInstance().getExternalContext()
        .getSessionMap().put(LOGIN_KEY, username);
      return "/protected/index?faces-redirect=true";
  }

  public String logout() {
    FacesContext.getCurrentInstance().getExternalContext()
      .getSessionMap().remove(LOGIN_KEY);
    return "/index?faces-redirect=true";
  }

  // Getters and setter omitted ...
}</pre></div><p class="calibre7">The <code class="email">LoginController</code> backing bean accepts two form-based parameters: the username and a password. It relies on the injected <code class="email">UserProfileService</code> to find a <code class="email">UserProfile</code> record by the<a id="id728" class="calibre1"/> username. Inside the <code class="email">login()</code> method, a<a id="id729" class="calibre1"/> user is allowed to log in if the password parameter matches the entity record. The method adds the username to the HTTP session under the key, <code class="email">LOGIN_KEY</code>.</p><p class="calibre7">There are a couple of helpful methods. The <code class="email">logout()</code> method removes the login key from the HTTP session key. The <code class="email">isLoggedIn()</code> method checks if a user has logged in or not.</p><p class="calibre7">The servlet filter only handles the direct navigation resources, servlets, filters, and paths. We need another protector for the JSF views, because <code class="email">LoginAuthenticationFilter</code> is not enough.</p><p class="calibre7">The following is the code for a backing bean controller called <code class="email">LoginViewAuthenticator</code>:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.product.security;
import javax.faces.application.NavigationHandler;
// other imports elided...

@Named("loginViewAuthenticator") @ApplicationScoped
public class LoginViewAuthenticator {
  // ...

  public void check() {
    FacesContext facesContext = FacesContext.getCurrentInstance();
    HttpSession session = (HttpSession)
      facesContext.getExternalContext().getSession(true);
    String currentUser = (String)session.getAttribute(
      LoginController.LOGIN_KEY);
    if (currentUser == null || currentUser.length() == 0) {
      NavigationHandler navigationHandler =
        facesContext.getApplication().getNavigationHandler();
      navigationHandler.handleNavigation(
        facesContext, null, LoginController.LOGIN_VIEW);
    }
  }
}</pre></div><p class="calibre7">The class <code class="email">LoginViewAuthenticator</code> has a <code class="email">check()</code> method that performs a check. We retrieve the known key <code class="email">LOGIN_KEY</code> from the HTTP session. Note that we can access parts of the Java Servlet API through a chained call to the <code class="email">getExternalContext()</code> method on <code class="email">FacesContext</code>. We retrieve the <code class="email">HttpSession</code> instance or create one and then check for the<a id="id730" class="calibre1"/> associated value. If the user is not logged in, then <a id="id731" class="calibre1"/>we change the destination of the current <code class="email">NavigationHandler</code>. The navigation handler in JSF is an implementation-defined type that carries the target outcome string during a Faces request-and-response interaction.</p><p class="calibre7">We use <code class="email">LoginViewAuthenticator</code> in a page view to restrict access:</p><div class="informalexample"><pre class="programlisting">&lt;ui:composition template="/basic_layout.xhtml"&gt;
  &lt;ui:define name="mainContent"&gt;
    &lt;f:metadata&gt;
      &lt;f:event type="preRenderView"
       listener="#{loginViewAuthenticator.check}" /&gt;
    &lt;/f:metadata&gt;

    &lt;div class="login-username-box  pull-right"&gt;
      &lt;b&gt;#{sessionScope['LOGIN_USERNAME']}&lt;/b&gt;
    &lt;/div&gt;
    &lt;h1&gt; JSF Protected View &lt;/h1&gt;

    &lt;!-- ... --&gt;
&lt;/ui:composition&gt;</pre></div><p class="calibre7">For the page <code class="email">view /protected/index.html</code>, we insert a pre-render view event using the <code class="email">&lt;f:metadata&gt;</code> section. The <code class="email">&lt;f:event&gt;</code> element invokes the <code class="email">check()</code> method of the <code class="email">LoginViewAuthenticator</code> bean.</p><p class="calibre7">In the project, we also secured the Faces Flow by adding the same stanza to the page view <code class="email">/simple.xhtml</code>. This view is the start page and, therefore, adding the pre-render view event here effectively restricts access to the flow. The <code class="email">LoginViewAuthenticator</code> bean ensures that unknown website users are redirected to the <code class="email">/login.xhtml</code> view.</p></div></div>
<div class="book" title="Resource Library Contracts"><div class="book" id="aid-1S2JE2"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec56" class="calibre1"/>Resource Library Contracts</h1></div></div></div><p class="calibre7">JSF 2.2, as a part of Java EE 7, introduced the ability to theme and style websites under a facility known <a id="id732" class="calibre1"/>as the Resource Library Contracts. The idea of contracts is about reusing Facelets dynamically at runtime. It is possible now with contracts to switch between resources without having to redeploy an application. Contracts can also be declared statically for pages that match a URL pattern.</p><p class="calibre7">The specification reserves a specially named folder called <code class="email">/contracts</code> as the parent folder for the Resource Library Contracts. This folder is the default one. If you already have a folder named as this view, then you will have to refactor by name, unfortunately.</p><p class="calibre7">There is another default location, <code class="email">META-INF/contracts</code>, on the classpath for JARs. This location allows the resource library contracts to be packaged as JAR for distribution to the third-party customers.</p><p class="calibre7">Inside the <code class="email">/contracts</code> folder, a developer can define named contracts (or themes). You can only create folders inside the location folder <code class="email">/contract</code> or (<code class="email">/META-INF/contracts</code>), and each folder represents a named contract. In the specification, a contract has a declared template. Each contract may define resources such as images, CSS, JavaScript files, and other content files.</p><p class="calibre7">There is a <a id="id733" class="calibre1"/>project called <code class="email">jsf-resource-library-contracts</code> in the book's source distribution, and in there you will see the following files laid out:</p><div class="informalexample"><pre class="programlisting">/src/main/webapp/contracts/
/src/main/webapp/contracts/default/
/src/main/webapp/contracts/default/template.xhtml
/src/main/webapp/contracts/default/styles/app.css
/src/main/webapp/contracts/default/images/
/src/main/webapp/contracts/victoria/
/src/main/webapp/contracts/victoria/template.xhtml
/src/main/webapp/contracts/victoria/styles/app.css
/src/main/webapp/contracts/victoria/images/</pre></div><p class="calibre7">There are two Resource Library Contracts: <code class="email">default</code> and <code class="email">victoria</code>. These folders share the same resources although they do not have to. The two <code class="email">template.xhtml</code> files are UI composition files that lay out the page view. The two <code class="email">app.css</code> files are CSS.</p><p class="calibre7">A resource contract must have at least one UI composition template, which is called a declared template in the specification. In each contract folder, the file <code class="email">template.xhtml</code> is a declared template. Inside each template file that the specification mentions, any <code class="email">&lt;ui:insert&gt;</code> tags are known as declared insertion points. The term declared resources means the collection of images, CSS and JavaScript, and other resources.</p><p class="calibre7">Inside the <code class="email">default/template.xhtml</code> file, we have an important link to the reference styles sheet:</p><div class="informalexample"><pre class="programlisting">&lt;h:head&gt;
  &lt;!-- ...--&gt;
  &lt;link href="#{request.contextPath}/contracts/default/
    styles/app.css" rel="stylesheet"/&gt;
&lt;/h:head&gt;</pre></div><p class="calibre7">Likewise, in the <code class="email">victoria/template.xhtml</code>, we have a link to the alternative style sheet:</p><div class="informalexample"><pre class="programlisting">&lt;link href="#{request.contextPath}/contracts/victoria/
    styles/app.css" rel="stylesheet"/&gt;</pre></div><p class="calibre7">In each resource contract, we can vary the properties of shared CSS selectors in the CSS files in order to produce alternate themes. The following is an extract of <code class="email">default/styles/app.css</code>:</p><div class="informalexample"><pre class="programlisting">.fashion-headline {
    color: #ff4227;
    font-family: Consolas;
    font-style: italic;
    font-size: 22pt;
    margin: 30px 10px;
    padding: 15px 25px;
    border: 2px solid #8b200c;
    border-radius: 15px;
}</pre></div><p class="calibre7">And this is similar to <code class="email">victoria/styles/app.css</code>:</p><div class="informalexample"><pre class="programlisting">.fashion-headline {
    color: #22ff1e;
    font-family: Verdana, sans-serif;
    font-weight: bold;
    font-size: 20pt;
    margin: 30px 10px;
    padding: 15px 25px;
    border: 2px solid #31238b;
    border-radius: 15px;
}</pre></div><p class="calibre7">There is a<a id="id734" class="calibre1"/> difference of color, font family, size, and style.</p><p class="calibre7">In order to configure the resource contracts in static usage from the matching URL pattern, we declare the titles in the Faces configuration file, <code class="email">faces-config.xml</code>. JSF 2.2 introduces a new <code class="email">&lt;resource-library-contracts&gt;</code> element. Each contract is associated with a name and one or more URL patterns.</p><div class="book" title="Static Resource Library Contract references"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec72" class="calibre1"/>Static Resource Library Contract references</h2></div></div></div><p class="calibre7">In our <a id="id735" class="calibre1"/>example<a id="id736" class="calibre1"/> project, we should have a Faces configuration file that has the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;faces-config ... version="2.2"&gt;
  &lt;application&gt;
    &lt;resource-library-contracts&gt;
      &lt;contract-mapping&gt;
        &lt;url-pattern&gt;/corporate/*&lt;/url-pattern&gt;
        &lt;contracts&gt;victoria&lt;/contracts&gt;
      &lt;/contract-mapping&gt;

      &lt;contract-mapping&gt;
        &lt;url-pattern&gt;*&lt;/url-pattern&gt;
        &lt;contracts&gt;default&lt;/contracts&gt;
      &lt;/contract-mapping&gt;
    &lt;/resource-library-contracts&gt;
  &lt;/application&gt;
&lt;/faces-config&gt;</pre></div><p class="calibre7">The <code class="email">&lt;contract-mapping&gt;</code> element defines two contracts: <code class="email">default</code> and <code class="email">victoria</code>. The order of the<a id="id737" class="calibre1"/> contracts is important for processing. For the entire website, the <code class="email">default</code> contract is <a id="id738" class="calibre1"/>active whereas the <code class="email">victoria</code> contract is active only for the page view underneath the <code class="email">/corporate/ URL</code>. A contract mapping may have more than one URL pattern.</p><p class="calibre7">We can write a page view to trigger this contract statically. The following is an extract of the page view, <code class="email">/corporate/index.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html... &gt;
  &lt;f:view &gt;
    &lt;ui:composition template="/template.xhtml"&gt;
      &lt;ui:define name="mainContent"&gt;
        &lt;!-- ... --&gt;
        &lt;p&gt;This is &lt;code&gt;/corporate/index.xhtml&lt;/code&gt;&lt;/p&gt;

        &lt;p class="fashion-headline"&gt;
        This is a fashion statement!&lt;/p&gt;

        &lt;a class="btn btn-info"
          href="#{request.contextPath}/index.xhtml"&gt;Go Home&lt;/a&gt;
        &lt;!-- ... --&gt;
      &lt;/ui:define&gt; &lt;!--name="mainContent" --&gt;
    &lt;/ui:composition&gt;
  &lt;/f:view&gt;
&lt;/html&gt;</pre></div><p class="calibre7">Based on the previous resource library contract definitions in <code class="email">faces-config.xml</code>, the paragraph with the CSS class, fashion-headline should be green in color. Notice how JSF searches for and finds the <code class="email">/template.xhtml</code> references, which lie in the corporate folder. So defining Resources Library Contracts that can be switched statically is a good feature to have,  but what if we wanted to change the contract on the fly? We can achieve this goal and we'll learn how in the next section.</p></div><div class="book" title="Dynamic Resource Library Contract references"><div class="book"><div class="book"><div class="book"><h2 class="title1"><a id="ch06lvl2sec73" class="calibre1"/>Dynamic Resource Library Contract references</h2></div></div></div><p class="calibre7">If you <a id="id739" class="calibre1"/>surround the<a id="id740" class="calibre1"/> UI composition with static reference with an <code class="email">f:view</code> element, as we did in the page view, then we can add another new attribute called contracts. This attribute accepts a String expression that references a resource contract by name.</p><p class="calibre7">The following is an extract of this home page view <code class="email">/index.xhtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html ...&gt;
  &lt;f:view contracts="#{fashionSelector.theme}"&gt;
    &lt;ui:composition template="/template.xhtml"&gt;
      &lt;ui:define name="mainContent"&gt;
        &lt;!-- ... --&gt;
        &lt;p&gt; This is &lt;code&gt;/index.xhtml&lt;/code&gt;. &lt;/p&gt;

        &lt;p class="fashion-headline"&gt;
          This is a fashion statement!&lt;/p&gt;

        &lt;!-- ... --&gt;
        &lt;div class="content-wrapper"&gt;
          &lt;h:form&gt;
            &lt;div class="form-group"&gt;
              &lt;label for="theme"&gt;Disabled select menu&lt;/label&gt;
              &lt;h:selectOneRadio id="theme"
                value="#{fashionSelector.theme}"
                styleClass="form-control peter-radio-box"
                required="true" layout="lineDirection"&gt;
              &lt;f:selectItem itemValue="default" itemLabel="Default"/&gt;
              &lt;f:selectItem itemValue="victoria" itemLabel="Victoria"/&gt;
              &lt;/h:selectOneRadio&gt;
            &lt;/div&gt;
            &lt;h:commandButton styleClass="btn btn-primary"
              action="#{fashionSelector.changeTheme()}"
              value="Change Theme" /&gt;
          &lt;/h:form&gt;
        &lt;/div&gt;
      &lt;/ui:define&gt; &lt;!--name="mainContent" --&gt;
    &lt;/ui:composition&gt;
  &lt;/f:view&gt;
&lt;/html&gt;</pre></div><p class="calibre7">The <code class="email">#{fashionSelector.theme}</code> controller references a getter for a backing bean, which <a id="id741" class="calibre1"/>we will see<a id="id742" class="calibre1"/> in a moment. The value of the expression sets the chosen resource library contract. We make use of the CSS paragraph in order to visually see the contract template in action. In order to change the contract, we employ a form with the radio selection element. The <code class="email">&lt;f:selectItem&gt;</code> tag defines the contract name.</p><p class="calibre7">Our backing bean <code class="email">FashionSelector</code> is a controller with one action method:</p><div class="informalexample"><pre class="programlisting">package uk.co.xenonique.digital.flows.control;
import javax.enterprise.context.SessionScoped;
import javax.inject.Named;
import java.io.Serializable;

@Named
@SessionScoped
public class FashionSelector implements Serializable {
  private String theme = "default";

  public String changeTheme() {
    return "/index?faces-redirect=true";
  }

  // Getters and setters omitted
}</pre></div><p class="calibre7">We annotate the controller as a <code class="email">@SessionScoped</code> bean in order to preserve the contract change across the many request-response cycles.</p><p class="calibre7">The resource library contracts also happily function with Faces Flows. The technique of using either static URL patterns or the dynamic selector of the template equals the flows. In the book's source, you will find more demonstrations and source code. In fact, the page view <code class="email">/digitalFlow/digitalFlow.xhtml</code> looks exactly as follows:</p><div class="informalexample"><pre class="programlisting">&lt;html ...&gt;
  &lt;f:view contracts="#{fashionSelector.theme}"&gt;
    &lt;ui:composition template="/template.xhtml"&gt;
    ... &lt;/u:compoition&gt;
  &lt;/f:view&gt;
&lt;/html&gt;</pre></div><p class="calibre7">As you can see, in principle, there is no difference at all.</p></div></div>
<div class="book" title="Advice for flows" id="aid-1T1401"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec57" class="calibre1"/>Advice for flows</h1></div></div></div><p class="calibre7">Faces Flows are a very useful feature in JSF 2.2, because they allow developers and designers to put together components that achieve customer (or user centric) goals. They also allow an architect to define groups of page views and controllers into specific business defined components. If the designer is careful, they can be linked together efficiently and decoupled from dependencies in meaningful strategies. The following points should<a id="id743" class="calibre1"/> be kept in mind while using Faces Flows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Start small</strong></span>: Design a Faces Flow that achieves one responsibility and one goal. Don't try to build the entire process in a single flow.</li><li class="listitem"><span class="strong"><strong class="calibre8">Pass entities and meaning types</strong></span>: Implement Faces Flows that accept data entities and transfer objects.</li><li class="listitem"><span class="strong"><strong class="calibre8">Compose flows together</strong></span>: Group together common flows that achieve a similar goal. In a checkout process, you may have a flow dedicated to the shipping address and a flow responsible for payments. These two flows can be invoked by a master flow that handles the entire process.</li><li class="listitem"><span class="strong"><strong class="calibre8">Encapsulate flows</strong></span>: Encapsulate your flow as much as possible, so that it is self-sufficient.</li><li class="listitem"><span class="strong"><strong class="calibre8">Persist your user's data</strong></span>: when a customer completes a task, ensure that user data is saved at the determined exit points.</li></ul></div><p class="calibre7">Resist the temptation of building the perfect workflow. Instead, I recommend that you design Faces Flow with change at the back of your mind.</p><p class="calibre7">In modern digital teams building websites and applications, the most important person is the UX designer. Often, after several rounds of user-centric testing, you might find the page design and information architecture of the site changing and going back and forth over weeks or even months. By building small, goal-oriented Faces Flow components, you will protect the developer team from the constant changes driven by the UX design team. Design your flows not for reuse, but for replacement.</p></div>
<div class="book" title="Summary" id="aid-1TVKI1"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec58" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">In this chapter, we examined the poster child of the JSF 2.2 release: Faces Flows. We learned about flow definitions and lifecycles. We covered ground with implicit navigation and created POJO using the <code class="email">@FlowScoped</code> scope. We drilled down into the terminology of flow processes and we studied declarative and nested flows. We saw how we can pass parameters from one flow to another through invocation.</p><p class="calibre7">We also learned how to add finesse to our digital application by handling expired views. Then we added security around page views and Resource Library Contracts to our new abilities. We understood how contracts allow the developer to add themes and styles to our JSF application. Another thing that we learned is that the Resource Library Contracts may be driven by static declaration or controlled by backing beans.</p><p class="calibre7">In the next chapter, we will step away from JSF and delve into JavaScript programming and library framework.</p></div>
<div class="book" title="Exercises" id="aid-1UU541"><div class="book"><div class="book"><div class="book"><h1 class="title"><a id="ch06lvl1sec59" class="calibre1"/>Exercises</h1></div></div></div><div class="book"><ol class="orderedlist"><li class="listitem">Verify that flow-scoped beans are unique with multiple web browsers and tab frames. Modify the <code class="email">debugClassName()</code> method in the first flow class, <code class="email">DigitalFlow</code> to report the value of <code class="email">java.lang.System.identityHashCode()</code> as well as the class name. What is the result?</li><li class="listitem">Everyone practically knows how to make a simple breakfast of scrambled eggs; write down the steps for doing so. What processes do you need? What inputs do you need? We know the results of the tasks; are there other outputs?</li><li class="listitem">Develop a simple Faces Flow application that takes contact details from a user. Think of the number of properties that you will need. Do you need all of them? (Hint: Name, address, e-mail, and telephone number will do for now.)</li><li class="listitem">Take the contact details Faces Flow application from the previous question and now persist that entity record data to a database.</li><li class="listitem">Now split the contact detail single flow application into separate flows. Set up the address part as a nested flow. (Hint: You can pass the entity record from one flow to another.)</li><li class="listitem">In the contact details application, how can we allow the customer to retrieve entities? Develop the Faces application so that he or she can save the data temporarily. (Hint: maybe the customer requires a temporary application ID, so add one to the contact details entity.)</li><li class="listitem">At this point, we will take the contact application and copy it to a new project. We will rebrand the project as <code class="email">welcome-new-bank-customer</code>. In the retail banking industry, this business process is called <code class="email">on-boarding</code>. You will need one or two nested flows. One flow accepts the person's work status: their salary, their job title, and, obviously, an occupation. If you feel confident, perhaps you can add a work address as another flow, and if you feel even stronger, add the national insurance number and tax records. With a more complicated project, consider, what would happen if it were possible to re-order the flows? How well is your design encapsulated? Can the developers easily rearrange the flows to fit the UX challenges?</li><li class="listitem">Given the contact details/banking onboarding application up to now, you should have many database records of contacts. Write another Faces Flow in the same web application that allows a trusted member of staff, a case worker, to amend and delete customer records. In a real business, such an employee sits behind the system and approves each onboarding application request one by one. You will need to write the HTTP login form for security and protect the non-public page views.</li></ol><div class="calibre25"/></div></div></body></html>