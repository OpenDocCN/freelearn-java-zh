<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><div id="_idContainer132" class="Basic-Text-Frame">
    <h1 class="chapterNumber">5</h1>
    <h1 id="_idParaDest-140" class="chapterTitle">Adding an API Description Using OpenAPI</h1>
    <p class="normal">The value of an API, such as a RESTful service, depends to a large extent on how easy it is to consume. Good and easily accessible documentation is an important part of whether an API is useful. In this chapter, we will learn how we can use the <strong class="keyWord">OpenAPI Specification</strong> to<a id="_idIndexMarker312"/> document APIs that we can make externally accessible from a microservice landscape.</p>
    <p class="normal">As we mentioned in <em class="chapterRef">Chapter 2</em>, <em class="italic">Introduction to Spring Boot</em>, the OpenAPI Specification, previously known as the Swagger specification, is one of the most commonly used specifications when it comes to documenting RESTful services. Many of the leading API gateways have native support for the OpenAPI Specification. We will learn how to use the open source project <strong class="keyWord">springdoc-openapi</strong> to<a id="_idIndexMarker313"/> produce such documentation. We will also learn how to embed an <a id="_idIndexMarker314"/>API documentation viewer, <strong class="keyWord">Swagger UI viewer</strong>, which can be used both to inspect the API documentation and also to make requests to the API.</p>
    <p class="normal">By the end of this chapter, we will have OpenAPI-based API documentation for the external API that’s exposed by the <code class="inlineCode">product-composite-service</code> microservice. The microservice will also expose a Swagger UI viewer that we can use to both visualize and test the API.</p>
    <p class="normal">The following topics will be covered in this chapter:</p>
    <ul>
      <li class="bulletList">Introduction to using springdoc-openapi</li>
      <li class="bulletList">Adding springdoc-openapi to the source code</li>
      <li class="bulletList">Building and starting the microservice landscape</li>
      <li class="bulletList">Trying out the OpenAPI documentation</li>
    </ul>
    <h1 id="_idParaDest-141" class="heading-1">Technical requirements</h1>
    <p class="normal">For instructions on how to install the tools used in this book and how to access the source code for this book, refer to:</p>
    <ul>
      <li class="bulletList"><em class="chapterRef">Chapter 21 </em>installation instructions for mac OS</li>
      <li class="bulletList"><em class="chapterRef">Chapter 22 </em>installation instructions for Microsoft Windows with WSL 2 and Ubuntu</li>
    </ul>
    <p class="normal">The code examples in this chapter all come from the source code in <code class="inlineCode">$BOOK_HOME/Chapter05</code>.</p>
    <p class="normal">If you want to view the changes that were applied to the source code in this chapter, that is, see what it took to create OpenAPI-based API documentation using springdoc-openapi, you can compare it with the source code for <em class="chapterRef">Chapter 4</em>, <em class="italic">Deploying Our Microservices Using Docker</em>. You can use your favorite <code class="inlineCode">diff</code> tool and compare the two folders, that is, <code class="inlineCode">$BOOK_HOME/Chapter04</code> and <code class="inlineCode">$BOOK_HOME/Chapter05</code>.</p>
    <h1 id="_idParaDest-142" class="heading-1">Introduction to using springdoc-openapi</h1>
    <p class="normal">Using <a id="_idIndexMarker315"/>springdoc-openapi makes it possible to keep the documentation of the API together with the source code that implements the API. With springdoc-openapi, you can create the API documentation on the fly at runtime by inspecting Java annotations in the code. To me, this is an important feature. If the API documentation is maintained in a separate life cycle from the Java source code, they will diverge from each other over time. In many cases, this will happen sooner than expected (based on my own experience).</p>
    <div class="packt_tip">
      <p class="normal">Before springdoc-openapi was created, another<a id="_idIndexMarker316"/> open source project, <strong class="keyWord">SpringFox</strong> (<a href="http://springfox.github.io/springfox/"><span class="url">http://springfox.github.io/springfox/</span></a>), provided similar features. Over recent years, the SpringFox project has not been actively maintained and, as a reaction to that, the springdoc-openapi project was created. A migration guide for SpringFox users can be found at <a href="https://springdoc.org/#migrating-from-springfox"><span class="url">https://springdoc.org/#migrating-from-springfox</span></a>.</p>
    </div>
    <p class="normal">As always, it is important to separate the interface of a component from its implementation. In terms of documenting a RESTful API, we should add the API documentation <a id="_idIndexMarker317"/>to the Java interface that describes the API, and not to the Java class that implements the API. To simplify updating the textual parts of the API documentation (for example, longer descriptions), we can place the descriptions in property files instead of in the Java code directly.</p>
    <p class="normal">Added to creating the API specification on the fly, springdoc-openapi also comes with an embedded API viewer called Swagger UI. We will configure the <code class="inlineCode">product-composite-service</code> service to expose Swagger UI for its API.</p>
    <div class="note">
      <p class="normal">Even though Swagger UI is very useful during development and test phases, it is typically not exposed in public for APIs in a production environment, for security reasons. In many cases, APIs are exposed publicly using an API gateway. Today, most API gateway products support exposing API documentation based on an OpenAPI document. So instead of exposing Swagger UI, the API’s OpenAPI documentation (generated by springdoc-openapi) is exported to an API Gateway that can publish the API documentation in a secure way.</p>
      <p class="normal">If APIs are expected to be consumed by third-party developers, a developer portal can be set up containing documentation and tools, used for self-registration, for example. Swagger UI can be used in a developer portal to allow developers to learn about the API by reading the documentation and also trying out the APIs using a test instance.</p>
      <p class="normal">In <em class="chapterRef">Chapter 11</em>, <em class="italic">Securing Access to APIs</em>, we will learn how to lock down access to APIs using OAuth 2.1. We will also learn how to configure the Swagger UI component to acquire OAuth 2.1 access tokens and use them when the user tries out the APIs through Swagger UI.</p>
    </div>
    <p class="normal">The following screenshot is an example of <a id="_idIndexMarker318"/>what Swagger UI looks like:</p>
    <figure class="mediaobject"><img src="../Images/B19825_05_01.png" alt="Graphical user interface, application  Description automatically generated" width="878" height="678"/></figure>
    <p class="packt_figref">Figure 5.1: Swagger UI example</p>
    <div class="packt_tip">
      <p class="normal">Some, for now, unimportant parts of the screenshot have been replaced by “<strong class="keyWord">…</strong>” in the preceding figure. We will get back to these details later on in this chapter.</p>
    </div>
    <p class="normal">To enable<a id="_idIndexMarker319"/> springdoc-openapi to create the API documentation, we need to add some dependencies to our build files and add some annotations to the Java interfaces that define the RESTful services. As mentioned above, we will also place the descriptive parts of the API documentation in a property file.</p>
    <div class="packt_tip">
      <p class="normal">If parts of the documentation have been placed in property files to simplify updating the API documentation, it is important that the property files are handled in the same life cycle and under the same version control as the source code. Otherwise, there is a risk that they will start to diverge from the implementation, that is, become out of date.</p>
    </div>
    <p class="normal">With <a id="_idIndexMarker320"/>springdoc-openapi introduced, let’s see how we can start using it by making the required changes in the source code.</p>
    <h1 id="_idParaDest-143" class="heading-1">Adding springdoc-openapi to the source code</h1>
    <p class="normal">To add <a id="_idIndexMarker321"/>OpenAPI-based documentation regarding the external API that’s exposed by the <code class="inlineCode">product-composite-service</code> microservice, we need to change the source code in two projects:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">product-composite-service</code>: Here, we will set up a configuration of springdoc-openapi in the Java application class, <code class="inlineCode">ProductCompositeServiceApplication</code>, and add some general information pertaining to the API.</li>
      <li class="bulletList"><code class="inlineCode">api</code>: Here, we will add annotations to the Java interface, <code class="inlineCode">ProductCompositeService</code>, describing each RESTful service and its operations. At this stage, we only have one RESTful service with one operation, accepting HTTP GET requests to <code class="inlineCode">/product-composite/{productId}</code>, which is used for requesting composite information regarding a specific product.</li>
    </ul>
    <p class="normal">The actual texts that are used to describe the API operation will be placed in the default property file, <code class="inlineCode">application.yml</code>, in the <code class="inlineCode">product-composite-service</code> project.</p>
    <p class="normal">Before we can start using springdoc-openapi, we need to add it as a dependency in the Gradle build files. So, let’s start with that!</p>
    <h2 id="_idParaDest-144" class="heading-2">Adding dependencies to the Gradle build files</h2>
    <p class="normal">The<a id="_idIndexMarker322"/> springdoc-openapi project is divided <a id="_idIndexMarker323"/>into a number of modules. For the <code class="inlineCode">api</code> project, we only need the module that contains the annotations we will use to document the API. We can add it to the <code class="inlineCode">api</code> project’s build file, <code class="inlineCode">build.gradle</code>, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">implementation <span class="hljs-string">'org.springdoc:springdoc-openapi-starter-common:2.0.2'</span>
</code></pre>
    <p class="normal">The <code class="inlineCode">product-composite-service</code> project requires a more fully featured module that <a id="_idIndexMarker324"/>contains both<a id="_idIndexMarker325"/> the Swagger UI viewer and support for Spring WebFlux. We can add the dependency to the build file, <code class="inlineCode">build.gradle</code>, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">implementation <span class="hljs-string">'org.springdoc:springdoc-openapi-starter-webflux-ui:2.0.2'</span>
</code></pre>
    <p class="normal">That is all the dependencies that need to be added; now for the configuration.</p>
    <h2 id="_idParaDest-145" class="heading-2">Adding OpenAPI configuration and general API documentation to the ProductCompositeService</h2>
    <p class="normal">To <a id="_idIndexMarker326"/>enable springdoc-openapi in the <code class="inlineCode">product-composite-service</code> microservice, we <a id="_idIndexMarker327"/>have to add some configuration. To keep the <a id="_idIndexMarker328"/>source code compact, we will<a id="_idIndexMarker329"/> add it directly to the application class, <code class="inlineCode">ProductCompositeServiceApplication.java</code>.</p>
    <div class="packt_tip">
      <p class="normal">If you prefer, you can place the configuration of springdoc-openapi in a separate Spring configuration class.</p>
    </div>
    <p class="normal">First, we need to define a Spring bean that returns an <code class="inlineCode">OpenAPI</code> bean. The source code looks like this:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OpenAPI <span class="hljs-title">getOpenApiDocumentation</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> <span class="code-highlight"><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">OpenAPI</strong><strong class="hljs-slc">()</strong></span>
    .info(<span class="hljs-keyword">new</span> <span class="hljs-title">Info</span>().title(apiTitle)
      .description(apiDescription)
      .version(apiVersion)
      .contact(<span class="hljs-keyword">new</span> <span class="hljs-title">Contact</span>()
        .name(apiContactName)
        .url(apiContactUrl)
        .email(apiContactEmail))
      .termsOfService(apiTermsOfService)
      .license(<span class="hljs-keyword">new</span> <span class="hljs-title">License</span>()
        .name(apiLicense)
        .url(apiLicenseUrl)))
    .externalDocs(<span class="hljs-keyword">new</span> <span class="hljs-title">ExternalDocumentation</span>()
      .description(apiExternalDocDesc)
      .url(apiExternalDocUrl));
}
</code></pre>
    <p class="normal">From the <a id="_idIndexMarker330"/>preceding code, we can see that the configuration contains general <a id="_idIndexMarker331"/>descriptive information about the API, such as:</p>
    <ul>
      <li class="bulletList">The name, description, version, and contact information for the API</li>
      <li class="bulletList">Terms of usage and license information</li>
      <li class="bulletList">Links to external information regarding the API, if any</li>
    </ul>
    <p class="normal">The <code class="inlineCode">api</code> variables <a id="_idIndexMarker332"/>that are <a id="_idIndexMarker333"/>used to configure the <code class="inlineCode">OpenAPI</code> bean are initialized from the property file using Spring <code class="inlineCode">@Value</code> annotations. These are as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">  <span class="hljs-meta">@Value("${api.common.version}")</span>         String apiVersion;
  <span class="hljs-meta">@Value("${api.common.title}")</span>           String apiTitle;
  <span class="hljs-meta">@Value("${api.common.description}")</span>     String apiDescription;
  <span class="hljs-meta">@Value("${api.common.termsOfService}")</span>  String apiTermsOfService;
  <span class="hljs-meta">@Value("${api.common.license}")</span>         String apiLicense;
  <span class="hljs-meta">@Value("${api.common.licenseUrl}")</span>      String apiLicenseUrl;
  <span class="hljs-meta">@Value("${api.common.externalDocDesc}")</span> String apiExternalDocDesc;
  <span class="hljs-meta">@Value("${api.common.externalDocUrl}")</span>  String apiExternalDocUrl;
  <span class="hljs-meta">@Value("${api.common.contact.name}")</span>    String apiContactName;
  <span class="hljs-meta">@Value("${api.common.contact.url}")</span>     String apiContactUrl;
  <span class="hljs-meta">@Value("${api.common.contact.email}")</span>   String apiContactEmail;
</code></pre>
    <p class="normal">The actual values are set in the property file, <code class="inlineCode">application.yml</code>, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">api:</span>
  <span class="hljs-attr">common:</span>
    <span class="hljs-attr">version:</span> <span class="hljs-number">1.0.0</span>
    <span class="hljs-attr">title:</span> <span class="hljs-string">Sample</span> <span class="hljs-string">API</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">Description</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">API...</span>
    <span class="hljs-attr">termsOfService:</span> <span class="hljs-string">MY</span> <span class="hljs-string">TERMS</span> <span class="hljs-string">OF</span> <span class="hljs-string">SERVICE</span>
    <span class="hljs-attr">license:</span> <span class="hljs-string">MY</span> <span class="hljs-string">LICENSE</span>
    <span class="hljs-attr">licenseUrl:</span> <span class="hljs-string">MY</span> <span class="hljs-string">LICENSE</span> <span class="hljs-string">URL</span>
    <span class="hljs-attr">externalDocDesc:</span> <span class="hljs-string">MY</span> <span class="hljs-string">WIKI</span> <span class="hljs-string">PAGE</span>
    <span class="hljs-attr">externalDocUrl:</span> <span class="hljs-string">MY</span> <span class="hljs-string">WIKI</span> <span class="hljs-string">URL</span>
    <span class="hljs-attr">contact:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">NAME</span> <span class="hljs-string">OF</span> <span class="hljs-string">CONTACT</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">URL</span> <span class="hljs-string">TO</span> <span class="hljs-string">CONTACT</span>
      <span class="hljs-attr">email:</span> <span class="hljs-string">contact@mail.com</span>
</code></pre>
    <p class="normal">The <a id="_idIndexMarker334"/>property file also contains some configuration for springdoc-openapi:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">springdoc:</span>
  <span class="hljs-attr">swagger-ui.path:</span> <span class="hljs-string">/openapi/swagger-ui.html</span>
  <span class="hljs-attr">api-docs.path:</span> <span class="hljs-string">/openapi/v3/api-docs</span>
  <span class="hljs-attr">packagesToScan:</span> <span class="hljs-string">se.magnus.microservices.composite.product</span>
  <span class="hljs-attr">pathsToMatch:</span> <span class="hljs-string">/**</span>
</code></pre>
    <p class="normal">The <a id="_idIndexMarker335"/>configuration parameters have the following purposes:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">springdoc.swagger-ui.path</code> and <code class="inlineCode">springdoc.api-docs.path</code> are used to specify that <a id="_idIndexMarker336"/>the URLs <a id="_idIndexMarker337"/>used by the embedded Swagger UI viewer are available under the path <code class="inlineCode">/openapi</code>. Later on in this book, when we add different types of edge servers in front and address security challenges, this will simplify the configuration of the edge servers used. Refer to the following chapters for more information:<ul>
          <li class="bulletList"><em class="chapterRef">Chapter 10</em>, <em class="italic">Using Spring Cloud Gateway to Hide Microservices behind an Edge Server</em></li>
          <li class="bulletList"><em class="chapterRef">Chapter 11</em>, <em class="italic">Securing Access to APIs</em></li>
          <li class="bulletList"><em class="chapterRef">Chapter 17</em>, <em class="italic">Implementing Kubernetes Features to Simplify the System Landscape</em>, the <em class="italic">Replacing the Spring Cloud Gateway</em> section</li>
          <li class="bulletList"><em class="chapterRef">Chapter 18</em>, <em class="italic">Using a Service Mesh to Improve Observability and Management</em>, the <em class="italic">Replacing Kubernetes Ingress controller with Istio Ingress Gateway</em> section</li>
        </ul>
      </li>
      <li class="bulletList"><code class="inlineCode">springdoc.packagesToScan</code> and <code class="inlineCode">springdoc.pathsToMatch</code> control where in the code base springdoc-openapi will search for annotations. The narrower the scope we can give springdoc-openapi, the faster the scan will be performed.</li>
    </ul>
    <p class="normal">For details, refer <a id="_idIndexMarker338"/>to the <a id="_idIndexMarker339"/>application class <code class="inlineCode">ProductCompositeServiceApplication.java</code> and the <code class="inlineCode">application.yml</code> property file in the <code class="inlineCode">product-composite-service</code> project. We can now proceed to see how to add API-specific documentation to the Java interface <code class="inlineCode">ProductCompositeService.java</code> in the <code class="inlineCode">api</code> project.</p>
    <h2 id="_idParaDest-146" class="heading-2">Adding API-specific documentation to the ProductCompositeService interface</h2>
    <p class="normal">To <a id="_idIndexMarker340"/>document the actual API and its RESTful operations, we will add an <code class="inlineCode">@Tag</code> annotation to the Java interface declaration in <code class="inlineCode">ProductCompositeService.java</code> in the <code class="inlineCode">api</code> project. For each RESTful operation in the API, we<a id="_idIndexMarker341"/> will add an <code class="inlineCode">@Operation</code> annotation, along with <code class="inlineCode">@ApiResponse</code> annotations on the corresponding Java method, to describe the operation and its expected responses. We will describe both successful and error responses.</p>
    <p class="normal">As well as reading these annotations at runtime, springdoc-openapi will also inspect Spring annotations, such as the <code class="inlineCode">@GetMapping</code> annotation, to understand what input arguments the operation takes and what the response will look like if a successful response is produced. To understand the structure of potential error responses, springdoc-openapi will look for <code class="inlineCode">@RestControllerAdvice</code> and <code class="inlineCode">@ExceptionHandler</code> annotations. In <em class="chapterRef">Chapter 3</em>, <em class="italic">Creating a Set of Cooperating Microservices</em>, we added a utility class, <code class="inlineCode">GlobalControllerExceptionHandler.java</code>, in the <code class="inlineCode">util</code> project.</p>
    <p class="normal">This class is annotated with <code class="inlineCode">@RestControllerAdvice</code>. See the <em class="italic">The global REST controller exception handler</em> section for details. The exception handler takes care of <code class="inlineCode">404</code> (<code class="inlineCode">NOT_FOUND</code>) and <code class="inlineCode">422</code> (<code class="inlineCode">UNPROCESSABLE_ENTITY</code>) errors. To allow springdoc-openapi to also correctly document <code class="inlineCode">400</code> (<code class="inlineCode">BAD_REQUEST</code>) errors that Spring WebFlux generates when it discovers incorrect input arguments in a request, we have also added an <code class="inlineCode">@ExceptionHandler</code> for <code class="inlineCode">400</code> (<code class="inlineCode">BAD_REQUEST</code>) errors in <code class="inlineCode">GlobalControllerExceptionHandler.java</code>.</p>
    <p class="normal">The<a id="_idIndexMarker342"/> documentation of the API on the resource level, corresponding to the Java interface declaration, looks as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta">@Tag(name = "ProductComposite", description = </span>
<span class="hljs-meta">  "REST API for composite product information.")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ProductCompositeService</span> {
</code></pre>
    <p class="normal">For the <a id="_idIndexMarker343"/>API operation, we have extracted the actual text used in the <code class="inlineCode">@Operation</code> and <code class="inlineCode">@ApiResponse</code> annotations to the property file. The annotations contain property placeholders, like <code class="inlineCode">${name-of-the-property}</code>, that springdoc-openapi will use to look up the actual text from the property file at runtime. The API operation is documented as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta">@Operation( </span>
<span class="hljs-meta">  summary = </span>
<span class="hljs-meta">    "${api.product-composite.get-composite-product.description}",</span>
<span class="hljs-meta">  description = </span>
<span class="hljs-meta">    "${api.product-composite.get-composite-product.notes}")</span>
<span class="hljs-meta">@ApiResponses(value = {</span>
<span class="hljs-meta">  @ApiResponse(responseCode = "200", description = </span>
<span class="hljs-meta">    "${api.responseCodes.ok.description}"),</span>
<span class="hljs-meta">  @ApiResponse(responseCode = "</span><span class="code-highlight"><strong class="hljs-meta-slc">400</strong></span><span class="hljs-meta">", description = </span>
<span class="hljs-meta">    "${api.responseCodes.badRequest.description}"),</span>
<span class="hljs-meta">  @ApiResponse(responseCode = "</span><span class="code-highlight"><strong class="hljs-meta-slc">404</strong></span><span class="hljs-meta">", description =   </span>
<span class="hljs-meta">    "${api.responseCodes.notFound.description}"),</span>
<span class="hljs-meta">  @ApiResponse(responseCode = "</span><span class="code-highlight"><strong class="hljs-meta-slc">422</strong></span><span class="hljs-meta">", description =   </span>
<span class="hljs-meta">    "${api.responseCodes.unprocessableEntity.description}")</span>
<span class="hljs-meta">})</span>
<span class="code-highlight"><strong class="hljs-meta-slc">@GetMapping</strong></span><span class="hljs-meta">(</span>
<span class="hljs-meta">  value = </span><span class="code-highlight"><strong class="hljs-meta-slc">"/product-composite/{productId}"</strong></span><span class="hljs-meta">,</span>
<span class="hljs-meta">  produces = "application/json")</span>
ProductAggregate <span class="hljs-title">getProduct</span><span class="code-highlight"><strong class="hljs-params-slc">(</strong><strong class="hljs-meta-slc">@PathVariable</strong><strong class="hljs-params-slc"> </strong><strong class="hljs-type-slc">int</strong><strong class="hljs-params-slc"> productId)</strong></span>;
</code></pre>
    <p class="normal">From the preceding source code, springdoc-openapi will be able to extract the following information about the operation:</p>
    <ul>
      <li class="bulletList">The operation accepts HTTP GET requests to the URL <code class="inlineCode">/product-composite/{productid}</code>, where the last part of the URL, <code class="inlineCode">{productid}</code>, is used as an input parameter to the request.</li>
      <li class="bulletList">A successful response will produce a JSON structure corresponding to the Java class, <code class="inlineCode">ProductAggregate</code>.</li>
      <li class="bulletList">In the event of an error, an HTTP error code of either <code class="inlineCode">400</code>, <code class="inlineCode">404</code>, or <code class="inlineCode">422</code> will be returned together with error information in the body, as described by <code class="inlineCode">@ExceptionHandler</code> in the Java class <code class="inlineCode">GlobalControllerExceptionHandler.java</code> in the <code class="inlineCode">util</code> project, as described above.</li>
    </ul>
    <p class="normal">For the <a id="_idIndexMarker344"/>values specified in the <code class="inlineCode">@Operation</code> and <code class="inlineCode">@ApiResponse</code> annotations, we can use property placeholders directly, without using Spring <code class="inlineCode">@Value</code> annotations. The actual values <a id="_idIndexMarker345"/>are set in the property file, <code class="inlineCode">application.yml</code>, like this:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-attr-slc">api:</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">responseCodes:</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">ok.description:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">OK</strong></span>
    <span class="hljs-attr">badRequest.description:</span> <span class="hljs-string">Bad</span> <span class="hljs-string">Request,</span> <span class="hljs-string">invalid</span> <span class="hljs-string">format</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">request.</span> <span class="hljs-string">See</span> <span class="hljs-string">response</span> <span class="hljs-string">message</span> <span class="hljs-string">for</span> <span class="hljs-string">more</span> <span class="hljs-string">information</span>
    <span class="hljs-attr">notFound.description:</span> <span class="hljs-string">Not</span> <span class="hljs-string">found,</span> <span class="hljs-string">the</span> <span class="hljs-string">specified</span> <span class="hljs-string">id</span> <span class="hljs-string">does</span> <span class="hljs-string">not</span> <span class="hljs-string">exist</span>
    <span class="hljs-attr">unprocessableEntity.description:</span> <span class="hljs-string">Unprocessable</span> <span class="hljs-string">entity,</span> <span class="hljs-string">input</span> <span class="hljs-string">parameters</span> <span class="hljs-string">caused</span> <span class="hljs-string">the</span> <span class="hljs-string">processing</span> <span class="hljs-string">to</span> <span class="hljs-string">fail.</span> <span class="hljs-string">See</span> <span class="hljs-string">response</span> <span class="hljs-string">message</span> <span class="hljs-string">for</span> <span class="hljs-string">more</span> <span class="hljs-string">information</span>
  <span class="hljs-attr">product-composite:</span>
    <span class="hljs-attr">get-composite-product:</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">Returns</span> <span class="hljs-string">a</span> <span class="hljs-string">composite</span> <span class="hljs-string">view</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">specified</span> <span class="hljs-string">product</span> <span class="hljs-string">id</span>
      <span class="hljs-attr">notes:</span> <span class="code-highlight"><strong class="hljs-string-slc">|</strong></span>
        <span class="hljs-comment"># Normal response</span>
        <span class="hljs-attr">If the requested product id is found the method will return information regarding:</span>
        <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">Base</span> <span class="hljs-string">product</span> <span class="hljs-string">information</span>
        <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">Reviews</span>
        <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">Recommendations</span>
        <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">Service</span> <span class="hljs-string">Addresses\n(technical</span> <span class="hljs-string">information</span> <span class="hljs-string">regarding</span> <span class="hljs-string">the</span> <span class="hljs-string">addresses</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">microservices</span> <span class="hljs-string">that</span> <span class="hljs-string">created</span> <span class="hljs-string">the</span> <span class="hljs-string">response)</span>
        <span class="hljs-comment"># Expected partial and error responses</span>
        <span class="hljs-string">In</span> <span class="hljs-string">the</span> <span class="hljs-string">following</span> <span class="hljs-string">cases,</span> <span class="hljs-string">only</span> <span class="hljs-string">a</span> <span class="hljs-string">partial</span> <span class="hljs-string">response</span> <span class="hljs-string">be</span> <span class="hljs-string">created</span> <span class="hljs-string">(used</span> <span class="hljs-string">to</span> <span class="hljs-string">simplify</span> <span class="hljs-string">testing</span> <span class="hljs-string">of</span> <span class="hljs-string">error</span> <span class="hljs-string">conditions)</span>
        <span class="hljs-comment">## Product id 113</span>
        <span class="hljs-number">200</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Ok,</span> <span class="hljs-string">but</span> <span class="hljs-literal">no</span> <span class="hljs-string">recommendations</span> <span class="hljs-string">will</span> <span class="hljs-string">be</span> <span class="hljs-string">returned</span>
        <span class="hljs-comment">## Product id 213</span>
        <span class="hljs-number">200</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Ok,</span> <span class="hljs-string">but</span> <span class="hljs-literal">no</span> <span class="hljs-string">reviews</span> <span class="hljs-string">will</span> <span class="hljs-string">be</span> <span class="hljs-string">returned</span>
        <span class="hljs-comment">## Non-numerical product id</span>
        <span class="hljs-number">400</span> <span class="hljs-bullet">-</span> <span class="hljs-string">A</span> <span class="hljs-string">**Bad</span> <span class="hljs-string">Request**</span> <span class="hljs-string">error</span> <span class="hljs-string">will</span> <span class="hljs-string">be</span> <span class="hljs-string">returned</span>
        <span class="hljs-comment">## Product id 13</span>
        <span class="hljs-number">404</span> <span class="hljs-bullet">-</span> <span class="hljs-string">A</span> <span class="hljs-string">**Not</span> <span class="hljs-string">Found**</span> <span class="hljs-string">error</span> <span class="hljs-string">will</span> <span class="hljs-string">be</span> <span class="hljs-string">returned</span>
        <span class="hljs-comment">## Negative product ids</span>
        <span class="hljs-number">422</span> <span class="hljs-bullet">-</span> <span class="hljs-string">An</span> <span class="hljs-string">**Unprocessable</span> <span class="hljs-string">Entity**</span> <span class="hljs-string">error</span> <span class="hljs-string">will</span> <span class="hljs-string">be</span> <span class="hljs-string">returned</span>
</code></pre>
    <p class="normal">From the <a id="_idIndexMarker346"/>preceding configuration, we can learn the following:</p>
    <ul>
      <li class="bulletList">A property placeholder such as <code class="inlineCode">${api.responseCodes.ok.description}</code> will be translated to <code class="inlineCode">OK</code>. Note the hierarchical structure of the YAML-based property file:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">api:</span>
  <span class="hljs-attr">responseCodes:</span>
    <span class="hljs-attr">ok.description:</span> <span class="hljs-string">OK</span>
</code></pre>
      </li>
      <li class="bulletList">A multi-line value starts with <code class="inlineCode">|</code> like the one for the property <code class="inlineCode">api.get-composite-product.description.notes</code>. Also note that springdoc-openapi supports the <a id="_idIndexMarker347"/>provision of a multi-line description using <strong class="keyWord">Markdown</strong> syntax.</li>
    </ul>
    <p class="normal">For <a id="_idIndexMarker348"/>details, see the service interface class <code class="inlineCode">ProductCompositeService.java</code> in the <code class="inlineCode">api</code> project and the property file, <code class="inlineCode">application.yml</code>, in the <code class="inlineCode">product-composite-service</code> project.</p>
    <div class="packt_tip">
      <p class="normal">If you want to find out more about how a YAML file is constructed, view the specification: <a href="https://yaml.org/spec/1.2/spec.html"><span class="url">https://yaml.org/spec/1.2/spec.html</span></a>.</p>
    </div>
    <h1 id="_idParaDest-147" class="heading-1">Building and starting the microservice landscape</h1>
    <p class="normal">Before we<a id="_idIndexMarker349"/> can try out the OpenAPI documentation, we need to build and start the microservice landscape!</p>
    <p class="normal">This can be done with the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con">cd $BOOK_HOME/Chapter05
./gradlew build &amp;&amp; docker-compose build &amp;&amp; docker-compose up -d
</code></pre>
    <p class="normal">You may run into an <a id="_idIndexMarker350"/>error message regarding port <code class="inlineCode">8080</code> already being allocated. This will look as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">ERROR: for product-composite Cannot start service product-composite: driver failed programming external connectivity on endpoint chapter05_product-composite_1 (0138d46f2a3055ed1b90b3b3daca92330919a1e7fec20351728633222db5e737): Bind for 0.0.0.0:8080 failed: port is already allocated
</code></pre>
    <p class="normal">If this is the case, you might have forgotten to bring down the microservice landscape from the previous chapter. To find out the names of the executing containers, run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"> docker ps --format {{.Names}}
</code></pre>
    <p class="normal">A sample response when a microservice landscape from the previous chapter is still running is as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">chapter05_review_1
chapter05_product_1
chapter05_recommendation_1
chapter04_review_1
chapter04_product-composite_1
chapter04_product_1
chapter04_recommendation_1
</code></pre>
    <p class="normal">If you find containers from other chapters in the output from the command, for example, from <em class="chapterRef">Chapter 4</em>, <em class="italic">Deploying Our Microservices Using Docker</em>, as in the preceding example, you need to jump over to the source code folder for that chapter and bring down its containers:</p>
    <pre class="programlisting con"><code class="hljs-con">cd ../Chapter04
docker-compose down
</code></pre>
    <p class="normal">Now, you can bring up the missing container for this chapter:</p>
    <pre class="programlisting con"><code class="hljs-con">cd ../Chapter05
docker-compose up -d
</code></pre>
    <p class="normal">Note that only the missing container, <code class="inlineCode">product-composite</code>, is started by the command since the other ones were already started successfully:</p>
    <pre class="programlisting con"><code class="hljs-con">Starting chapter05_product-composite_1 ... done
</code></pre>
    <p class="normal">To wait for<a id="_idIndexMarker351"/> the microservice landscape to start up and verify that it works, you can run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">./test-em-all.bash
</code></pre>
    <p class="normal">Note that<a id="_idIndexMarker352"/> the test script, <code class="inlineCode">test-em-all.bash</code>, has been extended with a set of tests that verifies that the Swagger UI endpoints work as expected:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"># </span>Verify access to Swagger and OpenAPI URLs
echo "Swagger/OpenAPI tests"
assertCurl 302 "curl -s  http://$HOST:$PORT/openapi/swagger-ui.html"
assertCurl 200 "curl -sL http://$HOST:$PORT/openapi/swagger-ui.html"
assertCurl 200 "curl -s  http://$HOST:$PORT/openapi/webjars/swagger-ui/index.html?configUrl=/v3/api-docs/swagger-config"
assertCurl 200 "curl -s  http://$HOST:$PORT/openapi/v3/api-docs"
assertEqual "3.0.1" "$(echo $RESPONSE | jq -r .openapi)"
assertEqual "http://$HOST:$PORT" "$(echo $RESPONSE | jq -r '.servers[0].url')"
assertCurl 200 "curl -s  http://$HOST:$PORT/openapi/v3/api-docs.yaml"
</code></pre>
    <p class="normal">With the successful startup of the microservices, we can move on and try out the OpenAPI documentation exposed by the <code class="inlineCode">product-composite</code> microservice using its embedded Swagger UI viewer.</p>
    <h1 id="_idParaDest-148" class="heading-1">Trying out the OpenAPI documentation</h1>
    <p class="normal">To browse the <a id="_idIndexMarker353"/>OpenAPI documentation, we will use the embedded Swagger UI viewer. If we open the <a href="http://localhost:8080/openapi/swagger-ui.html"><span class="url">http://localhost:8080/openapi/swagger-ui.html</span></a> URL in a web browser, we will see a web page that looks something like the following screenshot:</p>
    <figure class="mediaobject"><img src="../Images/B19825_05_02.png" alt="Graphical user interface, text, application  Description automatically generated" width="878" height="561"/></figure>
    <p class="packt_figref">Figure 5.2: OpenAPI documentation with the Swagger UI viewer</p>
    <p class="normal">Here, we can <a id="_idIndexMarker354"/>ascertain the following:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">The general information we specified in the springdoc-openapi <code class="inlineCode">OpenAPI</code> bean and a link to the actual OpenAPI document, <strong class="keyWord">/openapi/v3/api-docs</strong>, pointing to <code class="inlineCode">http://localhost:8080/openapi/v3/api-docs</code>.<div class="note">
          <p class="normal">Note that this is the link to the OpenAPI document that can be exported to an API Gateway, as discussed in the <em class="italic">Introduction to using springdoc-openapi</em> section above.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">A list of API <a id="_idIndexMarker355"/>resources; in our case, the <strong class="keyWord">ProductComposite</strong> API.</li>
      <li class="numberedList">At the bottom of the page, there is a section where we can inspect the schemas used in the API. <p class="normal">Proceed with the examination of the API documentation as follows.</p>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Click <a id="_idIndexMarker356"/>on the <strong class="keyWord">ProductComposite</strong> API resource to expand it. You will get a list of operations that are available on the resource. You will only see one operation, <strong class="keyWord">/product-composite/{productId}</strong>.</li>
      <li class="numberedList">Click on it to expand it. You will see the documentation of the operation that we specified in the <code class="inlineCode">ProductCompositeService</code> Java interface:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B19825_05_03.png" alt="Graphical user interface, application  Description automatically generated" width="812" height="641"/></figure>
    <p class="packt_figref">Figure 5.3: ProductComposite API documentation</p>
    <p class="normal">Here, we can see<a id="_idIndexMarker357"/> the following:</p>
    <ul>
      <li class="bulletList">The one-line description of the operation.</li>
      <li class="bulletList">A section with details regarding the operation, including the input parameters it supports. Note how the Markdown syntax from the <code class="inlineCode">notes</code> field in the <code class="inlineCode">@ApiOperation</code> annotation has been nicely rendered!</li>
    </ul>
    <p class="normal">If you scroll down the web page, you will also find documentation regarding the expected responses and their structure, both for a normal <strong class="keyWord">200</strong> (<strong class="keyWord">OK</strong>) response…</p>
    <figure class="mediaobject"><img src="../Images/B19825_05_04.png" alt="Graphical user interface, text, application  Description automatically generated" width="877" height="764"/></figure>
    <p class="packt_figref">Figure 5.4: Documentation for a 200 response</p>
    <p class="normal">…and the various 4xx error responses <a id="_idIndexMarker358"/>we defined earlier, as shown in the following screenshot:</p>
    <figure class="mediaobject"><img src="../Images/B19825_05_05.png" alt="Graphical user interface, application  Description automatically generated" width="877" height="940"/></figure>
    <p class="packt_figref">Figure 5.5: Documentation for 4xx responses</p>
    <p class="normal">For each documented potential error response, we can learn about its meaning and the structure of the response body.</p>
    <p class="normal">If we scroll back up <a id="_idIndexMarker359"/>to the parameter description, we will find the <strong class="screenText">Try it out</strong> button. If we click on the button, we can fill in actual parameter values and send a request to the API by clicking on the <strong class="screenText">Execute</strong> button. For example, if we enter <code class="inlineCode">123</code> in the <strong class="screenText">productId</strong><strong class="keyWord"> </strong>field, we will get the following response:</p>
    <figure class="mediaobject"><img src="../Images/B19825_05_06.png" alt="Graphical user interface, application  Description automatically generated" width="878" height="996"/></figure>
    <p class="packt_figref">Figure 5.6: Response after sending a request for an existing product</p>
    <p class="normal">We will get an<a id="_idIndexMarker360"/> expected <strong class="screenText">200</strong> (OK) as the response code and a JSON structure in the response body that we are already familiar with!</p>
    <p class="normal">If we enter an incorrect input, such as <code class="inlineCode">-1</code>, we will get a proper error code as the response code, <strong class="screenText">422</strong>, and a corresponding JSON-based error description in the response <a id="_idIndexMarker361"/>body:</p>
    <figure class="mediaobject"><img src="../Images/B19825_05_07.png" alt="Graphical user interface, application, Teams  Description automatically generated" width="877" height="997"/></figure>
    <p class="packt_figref">Figure 5.7: Response after sending a request with invalid input</p>
    <p class="normal">Note that the <strong class="screenText">message</strong> field in the response body clearly points out the problem: <strong class="screenText">“Invalid productId: -1”</strong>.</p>
    <p class="normal">If you want <a id="_idIndexMarker362"/>to try calling the API without using the Swagger UI viewer, you can copy the corresponding <code class="inlineCode">curl</code> command from the <strong class="screenText">Responses</strong> section and run it in a Terminal window, as shown in the preceding screenshot:</p>
    <pre class="programlisting con"><code class="hljs-con">curl -X GET "http://localhost:8080/product-composite/123" -H "accept: application/json"
</code></pre>
    <p class="normal">Great, isn’t it?</p>
    <h1 id="_idParaDest-149" class="heading-1">Summary</h1>
    <p class="normal">Good documenting of an API is essential for its acceptance, and OpenAPI is one of the most commonly used specifications when it comes to documenting RESTful services. springdoc-openapi is an open source project that makes it possible to create OpenAPI-based API documentation on the fly at runtime by inspecting Spring WebFlux and Swagger annotations. Textual descriptions of an API can be extracted from the annotations in the Java source code and placed in a property file for ease of editing. springdoc-openapi can be configured to bring an embedded Swagger UI viewer into a microservice, which makes it very easy to read about APIs that have been exposed by the microservice and also try them out from the viewer.</p>
    <p class="normal">Now, what about bringing some life to our microservices by adding persistence, that is, the capability to save those microservices’ data in a database? To do this, we will need to add some more APIs so that we can create and delete the information that’s handled by the microservices. Head over to the next chapter to find out more!</p>
    <h1 id="_idParaDest-150" class="heading-1">Questions</h1>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">How does springdoc-openapi help us create API documentation for RESTful services?</li>
      <li class="numberedList">What specification for documenting APIs does springdoc-openapi support?</li>
      <li class="numberedList">What is the purpose of the springdoc-openapi <code class="inlineCode">OpenAPI</code> bean?</li>
      <li class="numberedList">Name some annotations that springdoc-openapi reads at runtime to create the API documentation on the fly.</li>
      <li class="numberedList">What does the code “<code class="inlineCode">: |</code>" mean in a YAML file?</li>
      <li class="numberedList">How can you repeat a call to an API that was performed using the embedded Swagger UI viewer without using the viewer again?</li>
    </ol>
  </div>
  <div id="_idContainer134">
    <h1 id="_idParaDest-151" class="heading-1">Join our community on Discord</h1>
    <p class="normal">Join our community’s Discord space for discussion with the author and other readers:</p>
    <p class="normal"><a href="https://packt.link/SpringBoot3e"><span class="url">https://packt.link/SpringBoot3e</span></a></p>
    <p class="normal"><img src="../Images/QR_Code1849216352344398875.png" alt="" role="presentation" width="177" height="177"/></p>
  </div>
</div>
</div>
</body></html>