<html><head></head><body>
<div id="_idContainer017">
<h1 class="chapter-number" id="_idParaDest-98"><a id="_idTextAnchor097"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-99"><a id="_idTextAnchor098"/><span class="koboSpan" id="kobo.2.1">Writing Business Logic for APIs</span></h1>
<p><span class="koboSpan" id="kobo.3.1">You defined API specs using OpenAPI in the previous chapter. </span><span class="koboSpan" id="kobo.3.2">API Java interfaces and models were generated by the OpenAPI (Swagger Codegen). </span><span class="koboSpan" id="kobo.3.3">In this chapter, you will implement the API’s code in terms of both business logic and data persistence. </span><span class="koboSpan" id="kobo.3.4">Here, business logic refers to the actual code you are writing for domain functionalities, which in our case comprise operations performed for e-commerce, such as checking out the </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">shopping cart.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">You will write services</span><a id="_idIndexMarker210"/><span class="koboSpan" id="kobo.6.1"> and repositories</span><a id="_idIndexMarker211"/><span class="koboSpan" id="kobo.7.1"> for implementation and add hypermedia and </span><strong class="bold"><span class="koboSpan" id="kobo.8.1">entity tags</span></strong><span class="koboSpan" id="kobo.9.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.10.1">ETags</span></strong><span class="koboSpan" id="kobo.11.1">) to API responses. </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">Hypermedia As The Engine Of Application State</span></strong><span class="koboSpan" id="kobo.13.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.14.1">HATEOAS</span></strong><span class="koboSpan" id="kobo.15.1">) will be implemented using Spring and </span><strong class="bold"><span class="koboSpan" id="kobo.16.1">Hypertext Application Language</span></strong><span class="koboSpan" id="kobo.17.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.18.1">HAL</span></strong><span class="koboSpan" id="kobo.19.1">). </span><span class="koboSpan" id="kobo.19.2">HAL is one of the standards to implement</span><a id="_idIndexMarker212"/><span class="koboSpan" id="kobo.20.1"> HATEOAS. </span><span class="koboSpan" id="kobo.20.2">Others are </span><em class="italic"><span class="koboSpan" id="kobo.21.1">Collection+JSON</span></em><span class="koboSpan" id="kobo.22.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.23.1">JSON-LD</span></em><span class="koboSpan" id="kobo.24.1">. </span><span class="koboSpan" id="kobo.24.2">You are going to use HAL in this book. </span><span class="koboSpan" id="kobo.24.3">You can find a sample of it in the first example in the </span><em class="italic"><span class="koboSpan" id="kobo.25.1">Adding ETags to API responses</span></em><span class="koboSpan" id="kobo.26.1"> section denoted by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.27.1">"_links"</span></strong><span class="koboSpan" id="kobo.28.1"> field. </span><span class="koboSpan" id="kobo.28.2">It is worth noting that the code provided only consists of the important lines and not the whole file in the interest of brevity. </span><span class="koboSpan" id="kobo.28.3">You can always access the links given after the code to view the </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">complete file.</span></span></p>
<p><span class="koboSpan" id="kobo.30.1">This chapter covers the </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.32.1">Overview of the </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">service design</span></span></li>
<li><span class="koboSpan" id="kobo.34.1">Adding a </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">repository component</span></span></li>
<li><span class="koboSpan" id="kobo.36.1">Adding </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">service components</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.38.1">Implementing hypermedia</span></span></li>
<li><span class="koboSpan" id="kobo.39.1">Enhancing the controller with a service </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">and HATEOAS</span></span></li>
<li><span class="koboSpan" id="kobo.41.1">Adding ETags to </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">API responses</span></span></li>
<li><span class="koboSpan" id="kobo.43.1">Testing </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">the APIs</span></span></li>
</ul>
<h1 id="_idParaDest-100"><a id="_idTextAnchor099"/><span class="koboSpan" id="kobo.45.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.46.1">To execute the instructions in this and the following chapters, you will need any REST API client, such as </span><em class="italic"><span class="koboSpan" id="kobo.47.1">Insomnia</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.48.1">or </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.49.1">Postman</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.51.1">You can find the code files for this chapter on GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04"><span class="No-Break"><span class="koboSpan" id="kobo.53.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.54.1">.</span></span></p>
<h1 id="_idParaDest-101"><a id="_idTextAnchor100"/><span class="koboSpan" id="kobo.55.1">Overview of the service design</span></h1>
<p><span class="koboSpan" id="kobo.56.1">We are going to implement</span><a id="_idIndexMarker213"/><span class="koboSpan" id="kobo.57.1"> a multi-layered architecture that comprises four layers – the presentation layer, application layer, domain layer, and infrastructure layer. </span><span class="koboSpan" id="kobo.57.2">Multi-layered architecture is a fundamental building</span><a id="_idIndexMarker214"/><span class="koboSpan" id="kobo.58.1"> block in the architecture style known as </span><strong class="bold"><span class="koboSpan" id="kobo.59.1">domain-driven design</span></strong><span class="koboSpan" id="kobo.60.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.61.1">DDD</span></strong><span class="koboSpan" id="kobo.62.1">). </span><span class="koboSpan" id="kobo.62.2">Let’s have a brief look at each of </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">these layers:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.64.1">Presentation layer</span></strong><span class="koboSpan" id="kobo.65.1">: This layer represents the </span><strong class="bold"><span class="koboSpan" id="kobo.66.1">user interface</span></strong><span class="koboSpan" id="kobo.67.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.68.1">UI</span></strong><span class="koboSpan" id="kobo.69.1">). </span><span class="koboSpan" id="kobo.69.2">In </span><a href="B19349_07.xhtml#_idTextAnchor169"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.70.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.71.1">, </span><em class="italic"><span class="koboSpan" id="kobo.72.1">Designing a User Interface</span></em><span class="koboSpan" id="kobo.73.1">, you’ll develop</span><a id="_idIndexMarker215"/><span class="koboSpan" id="kobo.74.1"> the UI </span><a id="_idIndexMarker216"/><span class="koboSpan" id="kobo.75.1">for a sample </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">e-commerce app.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.77.1">Application layer</span></strong><span class="koboSpan" id="kobo.78.1">: The application layer contains the application</span><a id="_idIndexMarker217"/><span class="koboSpan" id="kobo.79.1"> logic and maintains and coordinates the overall flow of the application. </span><span class="koboSpan" id="kobo.79.2">Just to remind you, it only contains the application logic and </span><em class="italic"><span class="koboSpan" id="kobo.80.1">not</span></em><span class="koboSpan" id="kobo.81.1"> the business logic. </span><span class="koboSpan" id="kobo.81.2">RESTful web services, async APIs, gRPC APIs, and GraphQL APIs are a part of </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">this layer.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.83.1">We already covered REST APIs and controllers in </span><a href="B19349_03.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.84.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.85.1">, </span><em class="italic"><span class="koboSpan" id="kobo.86.1">API Specifications and Implementation</span></em><span class="koboSpan" id="kobo.87.1">, which are part of the application layer. </span><span class="koboSpan" id="kobo.87.2">We implemented the controllers for demonstration purposes in the previous chapter. </span><span class="koboSpan" id="kobo.87.3">In this chapter, we’ll implement a controller extensively to serve </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">real data.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.89.1">Domain layer</span></strong><span class="koboSpan" id="kobo.90.1">: This layer contains the business logic and domain</span><a id="_idIndexMarker218"/><span class="koboSpan" id="kobo.91.1"> information. </span><span class="koboSpan" id="kobo.91.2">It contains the state of the business objects, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">Order</span></strong><span class="koboSpan" id="kobo.93.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">Product</span></strong><span class="koboSpan" id="kobo.95.1">. </span><span class="koboSpan" id="kobo.95.2">It is responsible for reading/persisting these objects to the infrastructure layer. </span><span class="koboSpan" id="kobo.95.3">The domain layer consists of services and repositories too. </span><span class="koboSpan" id="kobo.95.4">We’ll also be covering</span><a id="_idIndexMarker219"/><span class="koboSpan" id="kobo.96.1"> these in </span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">this chapter.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.98.1">Infrastructure layer</span></strong><span class="koboSpan" id="kobo.99.1">: The infrastructure layer</span><a id="_idIndexMarker220"/><span class="koboSpan" id="kobo.100.1"> provides support to all other layers. </span><span class="koboSpan" id="kobo.100.2">It is responsible for communication, such as interaction with the database, message brokers, and filesystems. </span><span class="koboSpan" id="kobo.100.3">Spring Boot works as an infrastructure layer and provides support for communication and interaction with both external and internal systems, such as databases and </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">message brokers.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.102.1">We’ll use the bottom-to-top approach. </span><span class="koboSpan" id="kobo.102.2">Let’s</span><a id="_idIndexMarker221"/><span class="koboSpan" id="kobo.103.1"> start implementing the domain layer with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">@</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.105.1">Repository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.106.1"> component.</span></span></p>
<h1 id="_idParaDest-102"><a id="_idTextAnchor101"/><span class="koboSpan" id="kobo.107.1">Adding a Repository component</span></h1>
<p><span class="koboSpan" id="kobo.108.1">We’ll use the bottom-to-top approach</span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.109.1"> to add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.110.1">@Repository</span></strong><span class="koboSpan" id="kobo.111.1"> component. </span><span class="koboSpan" id="kobo.111.2">Let’s start implementing the domain layer with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">@Repository</span></strong><span class="koboSpan" id="kobo.113.1"> component. </span><span class="koboSpan" id="kobo.113.2">We’ll implement the service and enhance the </span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">@Controller</span></strong><span class="koboSpan" id="kobo.115.1"> component in subsequent sections accordingly. </span><span class="koboSpan" id="kobo.115.2">We will code the </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">@Repository</span></strong><span class="koboSpan" id="kobo.117.1"> component first, then use it in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">@Service</span></strong><span class="koboSpan" id="kobo.119.1"> component using constructor injection. </span><span class="koboSpan" id="kobo.119.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">@Controller</span></strong><span class="koboSpan" id="kobo.121.1"> component will be enhanced using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">@Service</span></strong><span class="koboSpan" id="kobo.123.1"> component, which will also be injected into the Controller using </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">constructor injection.</span></span></p>
<h2 id="_idParaDest-103"><a id="_idTextAnchor102"/><span class="koboSpan" id="kobo.125.1">The @Repository annotation</span></h2>
<p><span class="koboSpan" id="kobo.126.1">Repository components</span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.127.1"> are Java classes marked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">@Repository</span></strong><span class="koboSpan" id="kobo.129.1"> annotation. </span><span class="koboSpan" id="kobo.129.2">This is a special Spring component that is used for interacting </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">with databases.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">@Repository</span></strong><span class="koboSpan" id="kobo.132.1"> is a general-purpose</span><a id="_idIndexMarker224"/><span class="koboSpan" id="kobo.133.1"> stereotype that represents both DDD’s Repository and the </span><strong class="bold"><span class="koboSpan" id="kobo.134.1">Java Enterprise Edition</span></strong><span class="koboSpan" id="kobo.135.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.136.1">JEE</span></strong><span class="koboSpan" id="kobo.137.1">) </span><strong class="bold"><span class="koboSpan" id="kobo.138.1">data access object</span></strong><span class="koboSpan" id="kobo.139.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.140.1">DAO</span></strong><span class="koboSpan" id="kobo.141.1">) pattern. </span><span class="koboSpan" id="kobo.141.2">Developers and teams</span><a id="_idIndexMarker225"/><span class="koboSpan" id="kobo.142.1"> should handle repository objects based on the underlying approach. </span><span class="koboSpan" id="kobo.142.2">In DDD, a repository is a central object that carries references to all the objects and should return the reference of a requested object. </span><span class="koboSpan" id="kobo.142.3">We need to have all the required dependencies and configurations in place before we start writing classes marked </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">@Repository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.146.1">You’ll use the following libraries as </span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">database dependencies:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.148.1">H2 database for persisting data</span></strong><span class="koboSpan" id="kobo.149.1">: We are going to use H2’s memory instance; however, you can also use a </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">file-based instance</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.151.1">Hibernate object relational mapping (ORM)</span></strong><span class="koboSpan" id="kobo.152.1">: For database </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">object mapping</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.154.1">Flyway for database migration</span></strong><span class="koboSpan" id="kobo.155.1">: This helps maintain the database and maintains a database changes history that allows rollbacks, version upgrades, and </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">so on</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.157.1">Let’s add these dependencies </span><a id="_idIndexMarker226"/><span class="koboSpan" id="kobo.158.1">to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">build.gradle</span></strong><span class="koboSpan" id="kobo.160.1"> file. </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">org.springframework.boot:spring-boot-starter-data-jpa</span></strong><span class="koboSpan" id="kobo.162.1"> adds all the required JPA dependencies, </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">including Hibernate:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.164.1">
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'implementation 'org.flywaydb:flyway-core'
runtimeOnly    'com.h2database:h2'</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/build.gradle"><span class="No-Break"><span class="koboSpan" id="kobo.165.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/build.gradle</span></span></a></p>
<p><span class="koboSpan" id="kobo.166.1">After adding the dependencies, we can add the configuration related to </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">the database.</span></span></p>
<h2 id="_idParaDest-104"><a id="_idTextAnchor103"/><span class="koboSpan" id="kobo.168.1">Configuring the database and JPA</span></h2>
<p><span class="koboSpan" id="kobo.169.1">We also need to modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.170.1">application.properties</span></strong><span class="koboSpan" id="kobo.171.1"> file with the following configuration. </span><span class="koboSpan" id="kobo.171.2">The configuration file is available </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/src/main/resources/application.properties"><span class="No-Break"><span class="koboSpan" id="kobo.173.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/src/main/resources/application.properties</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.174.1">:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.175.1">Datasource configuration</span></strong><span class="koboSpan" id="kobo.176.1">: The following</span><a id="_idIndexMarker227"/><span class="koboSpan" id="kobo.177.1"> are the Spring </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">datasource configurations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.179.1">
spring.datasource.name=</span><strong class="bold"><span class="koboSpan" id="kobo.180.1">ecomm</span></strong><span class="koboSpan" id="kobo.181.1">spring.datasource.url=</span><strong class="bold"><span class="koboSpan" id="kobo.182.1">jdbc:h2:mem:ecomm;DB_CLOSE_DELAY=-1;IGNORECASE=TRUE;DATABASE_TO_UPPER=false</span></strong><span class="koboSpan" id="kobo.183.1">spring.datasource.driverClassName=</span><strong class="bold"><span class="koboSpan" id="kobo.184.1">org.h2.Driver</span></strong><span class="koboSpan" id="kobo.185.1">spring.datasource.username=</span><strong class="bold"><span class="koboSpan" id="kobo.186.1">sa</span></strong><span class="koboSpan" id="kobo.187.1">spring.datasource.password=</span></pre></li> </ul>
<p><span class="koboSpan" id="kobo.188.1">We need to add H2-specific properties to the data source. </span><span class="koboSpan" id="kobo.188.2">The URL value suggests that a memory-based H2 database</span><a id="_idIndexMarker228"/><span class="koboSpan" id="kobo.189.1"> instance will </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">be used.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.191.1">H2 database configuration</span></strong><span class="koboSpan" id="kobo.192.1">: The following are the two H2 </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">database</span></span><span class="No-Break"><a id="_idIndexMarker229"/></span><span class="No-Break"><span class="koboSpan" id="kobo.194.1"> configurations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.195.1">
spring.h2.console.enabled=</span><strong class="bold"><span class="koboSpan" id="kobo.196.1">true</span></strong><span class="koboSpan" id="kobo.197.1">spring.h2.console.settings.web-allow-others=</span><strong class="bold"><span class="koboSpan" id="kobo.198.1">false</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.199.1">Here, the H2 console is the H2 web client that allows you to perform different operations on H2, such as viewing tables and executing queries. </span><span class="koboSpan" id="kobo.199.2">The H2 console is enabled for local access only; this means you can access the H2 console only on localhost. </span><span class="koboSpan" id="kobo.199.3">Also, remote access is disabled by setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">web-allow-others</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.201.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">false</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.204.1">JPA configuration</span></strong><span class="koboSpan" id="kobo.205.1">: The following are the </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">JPA/Hibernate</span></span><span class="No-Break"><a id="_idIndexMarker230"/></span><span class="No-Break"><span class="koboSpan" id="kobo.207.1"> configurations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.208.1">
spring.jpa.properties.hibernate.default_schema=</span><strong class="bold"><span class="koboSpan" id="kobo.209.1">ecomm</span></strong><span class="koboSpan" id="kobo.210.1">spring.jpa.database-platform=</span><strong class="bold"><span class="koboSpan" id="kobo.211.1">org.hibernate.dialect.H2Dialect</span></strong><span class="koboSpan" id="kobo.212.1">spring.jpa.show-sql=</span><strong class="bold"><span class="koboSpan" id="kobo.213.1">true</span></strong><span class="koboSpan" id="kobo.214.1">spring.jpa.format_sql=</span><strong class="bold"><span class="koboSpan" id="kobo.215.1">true</span></strong><span class="koboSpan" id="kobo.216.1">spring.jpa.generate-ddl=</span><strong class="bold"><span class="koboSpan" id="kobo.217.1">false</span></strong><span class="koboSpan" id="kobo.218.1">spring.jpa.hibernate.ddl-auto=</span><strong class="bold"><span class="koboSpan" id="kobo.219.1">none</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.220.1">We don’t want to generate the DDL or process the SQL file, because we want to use Flyway for database migrations. </span><span class="koboSpan" id="kobo.220.2">Therefore, </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">generate-ddl</span></strong><span class="koboSpan" id="kobo.222.1"> is marked with </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">false</span></strong><span class="koboSpan" id="kobo.224.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">ddl-auto</span></strong><span class="koboSpan" id="kobo.226.1"> is set </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">none</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.230.1">Flyway configuration</span></strong><span class="koboSpan" id="kobo.231.1">: The following are the </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">Flyway</span></span><span class="No-Break"><a id="_idIndexMarker231"/></span><span class="No-Break"><span class="koboSpan" id="kobo.233.1"> configurations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.234.1">
spring.flyway.url=</span><strong class="bold"><span class="koboSpan" id="kobo.235.1">jdbc:h2:mem:ecomm</span></strong><span class="koboSpan" id="kobo.236.1">spring.flyway.schemas=</span><strong class="bold"><span class="koboSpan" id="kobo.237.1">ecomm</span></strong><span class="koboSpan" id="kobo.238.1">spring.flyway.user=</span><strong class="bold"><span class="koboSpan" id="kobo.239.1">sa</span></strong><span class="koboSpan" id="kobo.240.1">spring.flyway.password=</span></pre></li> </ul>
<p><span class="koboSpan" id="kobo.241.1">Here, properties that are required for Flyway to connect to the database have </span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">been set.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.243.1">Accessing the H2 database</span></p>
<p class="callout"><span class="koboSpan" id="kobo.244.1">You can access the H2 database</span><a id="_idIndexMarker232"/><span class="koboSpan" id="kobo.245.1"> console using </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1">/h2-console</span></strong><span class="koboSpan" id="kobo.247.1">. </span><span class="koboSpan" id="kobo.247.2">For example, if your server is running on localhost and port </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">8080</span></strong><span class="koboSpan" id="kobo.249.1">, then you can access it </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">using </span></span><a href="http://localhost:8080/h2-console/"><span class="No-Break"><span class="koboSpan" id="kobo.251.1">http://localhost:8080/h2-console/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.252.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.253.1">You are done with setting up the database configuration. </span><span class="koboSpan" id="kobo.253.2">Let’s create the database schema and seed data script in the </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">next subsection.</span></span></p>
<h2 id="_idParaDest-105"><a id="_idTextAnchor104"/><span class="koboSpan" id="kobo.255.1">The database and seed data script</span></h2>
<p><span class="koboSpan" id="kobo.256.1">Now, we are</span><a id="_idIndexMarker233"/><span class="koboSpan" id="kobo.257.1"> done configuring</span><a id="_idIndexMarker234"/><span class="koboSpan" id="kobo.258.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">build.gradle</span></strong><span class="koboSpan" id="kobo.260.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">application.properties</span></strong><span class="koboSpan" id="kobo.262.1"> files and we can start writing the code. </span><span class="koboSpan" id="kobo.262.2">First, we’ll add the Flyway database migration script. </span><span class="koboSpan" id="kobo.262.3">This script can be written in SQL only. </span><span class="koboSpan" id="kobo.262.4">You can place this file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">db/migration</span></strong><span class="koboSpan" id="kobo.264.1"> directory inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">src/main/resources</span></strong><span class="koboSpan" id="kobo.266.1"> directory. </span><span class="koboSpan" id="kobo.266.2">We’ll follow the Flyway naming convention (</span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">V&lt;version&gt;.&lt;name&gt;.sql</span></strong><span class="koboSpan" id="kobo.268.1">) and create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">V1.0.0__Init.sql</span></strong><span class="koboSpan" id="kobo.270.1"> file inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">db/migration</span></strong><span class="koboSpan" id="kobo.272.1"> directory. </span><span class="koboSpan" id="kobo.272.2">You can then add the following script to </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">this file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.274.1">
create schema if not exists ecomm;create TABLE IF NOT EXISTS ecomm.product (
   id uuid NOT NULL DEFAULT random_uuid(),
   name varchar(56) NOT NULL,
   description varchar(200),
   price numeric(16, 4) DEFAULT 0 NOT NULL,
   count numeric(8, 0),
   image_url varchar(40),
   PRIMARY KEY(id)
);
create TABLE IF NOT EXISTS ecomm.tag (
   id uuid NOT NULL DEFAULT random_uuid(),
   name varchar(20),
   PRIMARY KEY(id)
);
-- Other code is removed for brevity</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/src/main/resources/db/migration/V1.0.0__Init.sql"><span class="No-Break"><span class="koboSpan" id="kobo.275.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/src/main/resources/db/migration/V1.0.0__Init.sql</span></span></a></p>
<p><span class="koboSpan" id="kobo.276.1">This script</span><a id="_idIndexMarker235"/><span class="koboSpan" id="kobo.277.1"> creates the </span><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">ecomm</span></strong><span class="koboSpan" id="kobo.279.1"> schema and adds all the tables required</span><a id="_idIndexMarker236"/><span class="koboSpan" id="kobo.280.1"> for our sample e-commerce app. </span><span class="koboSpan" id="kobo.280.2">It also adds </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">insert</span></strong><span class="koboSpan" id="kobo.282.1"> statements for the </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">seed data.</span></span></p>
<h2 id="_idParaDest-106"><a id="_idTextAnchor105"/><span class="koboSpan" id="kobo.284.1">Adding entities</span></h2>
<p><span class="koboSpan" id="kobo.285.1">Now, we can add the entities. </span><span class="koboSpan" id="kobo.285.2">An entity</span><a id="_idIndexMarker237"/><span class="koboSpan" id="kobo.286.1"> is a special object marked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">@Entity</span></strong><span class="koboSpan" id="kobo.288.1"> annotation that maps directly to the database table using an ORM implementation such as </span><em class="italic"><span class="koboSpan" id="kobo.289.1">Hibernate</span></em><span class="koboSpan" id="kobo.290.1">. </span><span class="koboSpan" id="kobo.290.2">Another popular ORM is </span><em class="italic"><span class="koboSpan" id="kobo.291.1">EclipseLink</span></em><span class="koboSpan" id="kobo.292.1">. </span><span class="koboSpan" id="kobo.292.2">You can place all entity objects in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">com.packt.modern.api.entity</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.294.1"> package.</span></span></p>
<p><span class="koboSpan" id="kobo.295.1">Let’s create the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">CartEntity.java</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1"> file:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.298.1">@Entity</span></strong><strong class="bold"><span class="koboSpan" id="kobo.299.1">@Table(name = "cart")</span></strong><span class="koboSpan" id="kobo.300.1">
public class CartEntity {
 @Id
 @GeneratedValue
 @Column(name = "ID", updatable = false, nullable = false)
 private UUID id;
 </span><strong class="bold"><span class="koboSpan" id="kobo.301.1">@OneToOne</span></strong><span class="koboSpan" id="kobo.302.1">
 @JoinColumn(name = "USER_ID", referencedColumnName = "ID")
 private UserEntity user;
 </span><strong class="bold"><span class="koboSpan" id="kobo.303.1">@ManyToMany</span></strong><span class="koboSpan" id="kobo.304.1">( cascade = CascadeType.ALL )
 </span><strong class="bold"><span class="koboSpan" id="kobo.305.1">@JoinTable</span></strong><span class="koboSpan" id="kobo.306.1">(
  name = "CART_ITEM",
  joinColumns = @JoinColumn(name = "CART_ID"),
  inverseJoinColumns = @JoinColumn(name = "ITEM_ID")
 )
 private List&lt;ItemEntity&gt; items = Collections.emptyList();
 // Getters/Setter and other codes are removed for brevity</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/src/main/java/com/packt/modern/api/entity/CartEntity.java"><span class="No-Break"><span class="koboSpan" id="kobo.307.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/tree/main/Chapter04/src/main/java/com/packt/modern/api/entity/CartEntity.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.308.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">@Entity</span></strong><span class="koboSpan" id="kobo.310.1"> annotation</span><a id="_idIndexMarker238"/><span class="koboSpan" id="kobo.311.1"> is part of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">jakarta.persistence</span></strong><span class="koboSpan" id="kobo.313.1"> package, which denotes that it is an entity and should be mapped to the database table. </span><span class="koboSpan" id="kobo.313.2">By default, it takes the entity name; however, we are using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">@Table</span></strong><span class="koboSpan" id="kobo.315.1"> annotation to map to the database table. </span><span class="koboSpan" id="kobo.315.2">Earlier, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">javax.persistence</span></strong><span class="koboSpan" id="kobo.317.1"> package was part of Oracle. </span><span class="koboSpan" id="kobo.317.2">Once Oracle open sourced JEE and handed it over to the Eclipse Foundation, it was legally required to change the name of the package from </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">javax.persistence</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.319.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">jakarta.persistence</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.322.1">We are also using one-to-one and many-to-many annotations to map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">Cart</span></strong><span class="koboSpan" id="kobo.324.1"> entity to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">User</span></strong><span class="koboSpan" id="kobo.326.1"> entity and </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">Item</span></strong><span class="koboSpan" id="kobo.328.1"> entity, respectively. </span><span class="koboSpan" id="kobo.328.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">ItemEntity</span></strong><span class="koboSpan" id="kobo.330.1"> list is also associated with </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">@JoinTable</span></strong><span class="koboSpan" id="kobo.332.1">, because we are using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">CART_ITEM</span></strong><span class="koboSpan" id="kobo.334.1"> join table to map the cart and product items based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">CART_ID</span></strong><span class="koboSpan" id="kobo.336.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">ITEM_ID</span></strong><span class="koboSpan" id="kobo.338.1"> columns in their </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">respective tables.</span></span></p>
<p><span class="koboSpan" id="kobo.340.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">UserEntity</span></strong><span class="koboSpan" id="kobo.342.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">Cart</span></strong><span class="koboSpan" id="kobo.344.1"> entity has also been added to maintain the relationship, as shown in the following code block. </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">FetchType</span></strong><span class="koboSpan" id="kobo.346.1"> is marked as </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">LAZY</span></strong><span class="koboSpan" id="kobo.348.1">, which means the user’s cart will be loaded only when explicitly asked. </span><span class="koboSpan" id="kobo.348.2">Also, you want to remove the cart if it is not referenced by the user, which can be done by configuring </span><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">orphanRemoval</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.350.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">true</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.353.1">
@Entity@Table(name = "user")
public class UserEntity {
// other code
</span><strong class="bold"><span class="koboSpan" id="kobo.354.1">@OneToOne(mappedBy = "user", fetch = FetchType.LAZY, orphanRemoval = true)</span></strong><span class="koboSpan" id="kobo.355.1">
private CartEntity cart;
// other code…</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/entity/UserEntity.java"><span class="No-Break"><span class="koboSpan" id="kobo.356.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/entity/UserEntity.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.357.1">All other entities</span><a id="_idIndexMarker239"/><span class="koboSpan" id="kobo.358.1"> are being added to the entity package located </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/entity"><span class="No-Break"><span class="koboSpan" id="kobo.360.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/entity</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.361.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.362.1">Now, we can add </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">the repositories.</span></span></p>
<h2 id="_idParaDest-107"><a id="_idTextAnchor106"/><span class="koboSpan" id="kobo.364.1">Adding repositories</span></h2>
<p><span class="koboSpan" id="kobo.365.1">All the repositories</span><a id="_idIndexMarker240"/><span class="koboSpan" id="kobo.366.1"> have been added </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">to </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository"><span class="No-Break"><span class="koboSpan" id="kobo.368.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.369.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.370.1">Repositories are simplest to add for CRUD operations, thanks to Spring Data JPA. </span><span class="koboSpan" id="kobo.370.2">You just must extend the interfaces with default implementations, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">CrudRepository</span></strong><span class="koboSpan" id="kobo.372.1">, which provides all the CRUD operation implementations, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">save</span></strong><span class="koboSpan" id="kobo.374.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">saveAll</span></strong><span class="koboSpan" id="kobo.376.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">findById</span></strong><span class="koboSpan" id="kobo.378.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">findAll</span></strong><span class="koboSpan" id="kobo.380.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">findAllById</span></strong><span class="koboSpan" id="kobo.382.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">delete</span></strong><span class="koboSpan" id="kobo.384.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">deleteById</span></strong><span class="koboSpan" id="kobo.386.1">. </span><span class="koboSpan" id="kobo.386.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">save(Entity e)</span></strong><span class="koboSpan" id="kobo.388.1"> method is used for both create and update </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">entity operations.</span></span></p>
<p><span class="koboSpan" id="kobo.390.1">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">create </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">CartRepository.java</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.394.1">
public interface CartRepository extends    </span><strong class="bold"><span class="koboSpan" id="kobo.395.1">CrudRepository</span></strong><span class="koboSpan" id="kobo.396.1">&lt;CartEntity, UUID&gt; {
  </span><strong class="bold"><span class="koboSpan" id="kobo.397.1">@Query("select c from CartEntity c join c.user u</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.398.1">    where u.id = :customerId")</span></strong><span class="koboSpan" id="kobo.399.1">
  public Optional&lt;CartEntity&gt; findByCustomerId(
      @Param("customerId") UUID customerId);
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/CartRepository.java"><span class="No-Break"><span class="koboSpan" id="kobo.400.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/CartRepository.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.401.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">CartRepository</span></strong><span class="koboSpan" id="kobo.403.1"> interface extends</span><a id="_idIndexMarker241"/><span class="koboSpan" id="kobo.404.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">CrudRepository</span></strong><span class="koboSpan" id="kobo.406.1"> part of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.407.1">org. </span><span class="koboSpan" id="kobo.407.2">springframework.data.repository</span></strong><span class="koboSpan" id="kobo.408.1"> package. </span><span class="koboSpan" id="kobo.408.2">You can also add methods supported by the JPA query language marked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">@Query</span></strong><span class="koboSpan" id="kobo.410.1"> annotation (part of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">org.springframework.data.jpa.repository</span></strong><span class="koboSpan" id="kobo.412.1"> package). </span><span class="koboSpan" id="kobo.412.2">The query</span><a id="_idIndexMarker242"/><span class="koboSpan" id="kobo.413.1"> inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">@Query</span></strong><span class="koboSpan" id="kobo.415.1"> annotation is written in </span><strong class="bold"><span class="koboSpan" id="kobo.416.1">Java Persistence Query Language</span></strong><span class="koboSpan" id="kobo.417.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.418.1">JPQL</span></strong><span class="koboSpan" id="kobo.419.1">). </span><span class="koboSpan" id="kobo.419.2">JPQL is very similar to SQL; however, here we used the Java class name mapped to a database table instead of using the actual table name. </span><span class="koboSpan" id="kobo.419.3">Therefore, we have used </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">CartEntity</span></strong><span class="koboSpan" id="kobo.421.1"> as the table name instead </span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">Cart</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.425.1">Selecting columns in JPQL</span></p>
<p class="callout"><span class="koboSpan" id="kobo.426.1">Similarly, for columns, you</span><a id="_idIndexMarker243"/><span class="koboSpan" id="kobo.427.1"> should use the variable names given in the class for the fields, instead of using the database table fields. </span><span class="koboSpan" id="kobo.427.2">In any case, if you use the database table name or field name and it does not match the class and class members mapped to the actual table, you will get</span><a id="_idIndexMarker244"/> <span class="No-Break"><span class="koboSpan" id="kobo.428.1">an error.</span></span></p>
<p><span class="koboSpan" id="kobo.429.1">You must be wondering, </span><em class="italic"><span class="koboSpan" id="kobo.430.1">“What if I want to add my own custom method with JPQL or native SQL?”</span></em><span class="koboSpan" id="kobo.431.1"> Well, let me tell you, you can do this too. </span><span class="koboSpan" id="kobo.431.2">For orders, we have added a custom interface for this very purpose. </span><span class="koboSpan" id="kobo.431.3">First, let’s have a look at </span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">OrderRepository</span></strong><span class="koboSpan" id="kobo.433.1">, which is very similar </span><span class="No-Break"><span class="koboSpan" id="kobo.434.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">CartRepository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.437.1">
@Repositorypublic interface OrderRepository extends
    CrudRepository&lt;OrderEntity, UUID&gt;, </span><strong class="bold"><span class="koboSpan" id="kobo.438.1">OrderRepositoryExt</span></strong><span class="koboSpan" id="kobo.439.1"> {
  @Query("select o from OrderEntity o join o.userEntity u
    where u.id = :customerId")
  public Iterable&lt;OrderEntity&gt; findByCustomerId(
      @Param("customerId") UUID customerId);
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/OrderRepository.java"><span class="No-Break"><span class="koboSpan" id="kobo.440.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/OrderRepository.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.441.1">If you look closely, we have</span><a id="_idIndexMarker245"/><span class="koboSpan" id="kobo.442.1"> extended an extra interface – </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">OrderRepositoryExt</span></strong><span class="koboSpan" id="kobo.444.1">. </span><span class="koboSpan" id="kobo.444.2">This is our extra interface for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">Order</span></strong><span class="koboSpan" id="kobo.446.1"> repository and consists of the </span><span class="No-Break"><span class="koboSpan" id="kobo.447.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.448.1">
public interface OrderRepositoryExt {  Optional&lt;OrderEntity&gt; insert(NewOrder m);
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/OrderRepositoryExt.java"><span class="No-Break"><span class="koboSpan" id="kobo.449.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/OrderRepositoryExt.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.450.1">We already have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">save()</span></strong><span class="koboSpan" id="kobo.452.1"> method for this purpose in </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">CrudRepository</span></strong><span class="koboSpan" id="kobo.454.1">; however, we want to use a different implementation. </span><span class="koboSpan" id="kobo.454.2">For this purpose, and to demonstrate how you can create your own repository method implementation, we are adding this extra </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">repository interface.</span></span></p>
<p><span class="koboSpan" id="kobo.456.1">Now, let’s create</span><a id="_idIndexMarker246"/><span class="koboSpan" id="kobo.457.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">OrderRepositoryExt</span></strong><span class="koboSpan" id="kobo.459.1"> interface implementation, as </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">shown here:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.461.1">@Repository</span></strong><strong class="bold"><span class="koboSpan" id="kobo.462.1">@Transactional</span></strong><span class="koboSpan" id="kobo.463.1">
public class OrderRepositoryImpl implements
  OrderRepositoryExt {
  </span><strong class="bold"><span class="koboSpan" id="kobo.464.1">@PersistenceContext</span></strong><span class="koboSpan" id="kobo.465.1">
  private EntityManager em;
  private final ItemRepository itemRepo;
  private final CartRepository cRepo;
  private final OrderItemRepository oiRepo;
  public OrderRepositoryImpl(EntityManager em,CartRepository cRepo,       OrderItemRepository oiRepo) {
    this.em = em;
    this.cRepo = cRepo;
    this.oiRepo= oiRepo;
}
// rest of the code</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/OrderRepositoryImpl.java"><span class="No-Break"><span class="koboSpan" id="kobo.466.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository/OrderRepositoryImpl.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.467.1">This way, we can</span><a id="_idIndexMarker247"/><span class="koboSpan" id="kobo.468.1"> also have our own implementation in JPQL/</span><strong class="bold"><span class="koboSpan" id="kobo.469.1">Hibernate Query Language</span></strong><span class="koboSpan" id="kobo.470.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.471.1">HQL</span></strong><span class="koboSpan" id="kobo.472.1">), or in native SQL. </span><span class="koboSpan" id="kobo.472.2">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">@Repository</span></strong><span class="koboSpan" id="kobo.474.1"> annotation tells the Spring container that this special component is a repository and should be used to interact with the database using the </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">underlying JPA.</span></span></p>
<p><span class="koboSpan" id="kobo.476.1">It is also marked as </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">@Transactional</span></strong><span class="koboSpan" id="kobo.478.1">, which is a special annotation that means that transactions performed by methods in this class will be managed by Spring. </span><span class="koboSpan" id="kobo.478.2">It removes all the manual work of adding commits and rollbacks. </span><span class="koboSpan" id="kobo.478.3">You can also add this annotation to a specific method inside </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">the class.</span></span></p>
<p><span class="koboSpan" id="kobo.480.1">We are also using </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">@PersistenceContext</span></strong><span class="koboSpan" id="kobo.482.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">EntityManager</span></strong><span class="koboSpan" id="kobo.484.1"> class, which allows us to create</span><a id="_idIndexMarker248"/><span class="koboSpan" id="kobo.485.1"> and execute the query manually, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.487.1">
@Overridepublic Optional&lt;OrderEntity&gt; insert(NewOrder m) {
 Iterable&lt;ItemEntity&gt; dbItems = itemRepo.findByCustomerId(m.getCustomerId());
 List&lt;ItemEntity&gt; items = StreamSupport.stream(
            dbItems.spliterator(), false).collect
              (toList());
 if (items.size() &lt; 1) {
  throw new ResourceNotFoundException(String.format("There
     is no item found in customer's (ID: %s) cart.",
        m.getCustomerId()));
 }
 BigDecimal total = BigDecimal.ZERO;
 for (ItemEntity i : items) {
   total = (BigDecimal.valueOf(i.getQuantity()).multiply(
      i.getPrice())).add(total);
 }
 Timestamp orderDate = Timestamp.from(Instant.now());
 em.createNativeQuery("""
  INSERT INTO ecomm.orders (address_id, card_id,
    customer_id
  order_date, total, status) VALUES(?, ?, ?, ?, ?, ?)
  """)
 .setParameter(1, m.getAddress().getId())
 .setParameter(2, m.getCard().getId())
 .setParameter(3, m.getCustomerId())
 .setParameter(4, orderDate)
 .setParameter(5, total)
 .setParameter(6, StatusEnum.CREATED.getValue())
 .executeUpdate();
 Optional&lt;CartEntity&gt; oCart =
  cRepo.findByCustomerId(UUID.fromString
   (m. </span><span class="koboSpan" id="kobo.487.2">getCustomerId()));
 CartEntity cart = oCart.orElseThrow(() -&gt; new
  ResourceNotFoundException(String.format
("Cart not found for given customer (ID: %s)", m.getCustomerId())));
 itemRepo.deleteCartItemJoinById(cart.getItems().stream()
  .map(i -&gt; i.getId()).collect(toList()), cart. </span><span class="koboSpan" id="kobo.487.3">getId());
 OrderEntity entity = (OrderEntity)
    em.createNativeQuery("""
 SELECT o.* FROM ecomm.orders o WHERE o.customer_id = ? </span><span class="koboSpan" id="kobo.487.4">AND
 o.order_date &gt;= ?
 </span><span class="koboSpan" id="kobo.487.5">""", OrderEntity.class)
 .setParameter(1, m.getCustomerId())
 .setParameter(2, OffsetDateTime.ofInstant(orderDate.
</span><span class="koboSpan" id="kobo.487.6">   toInstant(),ZoneId.of("Z")).truncatedTo(ChronoUnit.MICROS))
    .getSingleResult();
 oiRepo.saveAll(cart.getItems().stream()
  .map(i -&gt; new OrderItemEntity().setOrderId
    (entity. </span><span class="koboSpan" id="kobo.487.7">getId())
  .setItemId(i.getId())).collect(toList()));
 return Optional.of(entity);
}</span></pre>
<p><span class="koboSpan" id="kobo.488.1">This method basically first fetches the items in the customer’s cart. </span><span class="koboSpan" id="kobo.488.2">Then, it calculates the order total, creates a new order, and saves it in the database. </span><span class="koboSpan" id="kobo.488.3">Next, it removes the items from the cart by removing the mapping because cart items are now part of the order. </span><span class="koboSpan" id="kobo.488.4">After that, it saves the mapping of the order and </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">cart items.</span></span></p>
<p><span class="koboSpan" id="kobo.490.1">Order creation is done using the native SQL query with the </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">prepared statement.</span></span></p>
<p><span class="koboSpan" id="kobo.492.1">If you look</span><a id="_idIndexMarker249"/><span class="koboSpan" id="kobo.493.1"> closely, you’ll also</span><a id="_idIndexMarker250"/><span class="koboSpan" id="kobo.494.1"> find that we have used the official </span><em class="italic"><span class="koboSpan" id="kobo.495.1">Java 15</span></em><span class="koboSpan" id="kobo.496.1"> feature, </span><strong class="bold"><span class="koboSpan" id="kobo.497.1">text </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.498.1">blocks</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.499.1"> (</span></span><a href="https://docs.oracle.com/en/java/javase/15/text-blocks/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.500.1">https://docs.oracle.com/en/java/javase/15/text-blocks/index.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.501.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.502.1">Similarly, you can create a repository</span><a id="_idIndexMarker251"/><span class="koboSpan" id="kobo.503.1"> for all other entities. </span><span class="koboSpan" id="kobo.503.2">All the repositories are available </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository"><span class="No-Break"><span class="koboSpan" id="kobo.505.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/repository</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.506.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.507.1">Now that we have created the repositories, we can move on to </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">adding services.</span></span></p>
<h1 id="_idParaDest-108"><a id="_idTextAnchor107"/><span class="koboSpan" id="kobo.509.1">Adding a Service component</span></h1>
<p><span class="koboSpan" id="kobo.510.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">@Service</span></strong><span class="koboSpan" id="kobo.512.1"> component is an interface</span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.513.1"> that works between controllers and repositories and is where we’ll add the business logic. </span><span class="koboSpan" id="kobo.513.2">Though you can directly call repositories from controllers, it is not a good practice as repositories should only be part of the data retrieval and persistence functionalities. </span><span class="koboSpan" id="kobo.513.3">Service components also help in sourcing data from various sources, such as databases and other </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">external applications.</span></span></p>
<p><span class="koboSpan" id="kobo.515.1">Service components are marked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">@Service</span></strong><span class="koboSpan" id="kobo.517.1"> annotation, which is a specialized Spring </span><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">@Component</span></strong><span class="koboSpan" id="kobo.519.1"> that allows implemented classes to be auto-detected using class-path scanning. </span><span class="koboSpan" id="kobo.519.2">Service classes are used to add business logic. </span><span class="koboSpan" id="kobo.519.3">Like </span><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">Repository</span></strong><span class="koboSpan" id="kobo.521.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">Service</span></strong><span class="koboSpan" id="kobo.523.1"> object also represents both DDD’s Service and JEE’s Business Service Façade patterns. </span><span class="koboSpan" id="kobo.523.2">Like </span><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">Repository</span></strong><span class="koboSpan" id="kobo.525.1">, it is also a general-purpose stereotype and can be used according to the </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">underlying approach.</span></span></p>
<p><span class="koboSpan" id="kobo.527.1">First, we’ll create the service interface, which is a normal Java interface with all the desired method signatures. </span><span class="koboSpan" id="kobo.527.2">This interface will expose all the operations that can be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">CartService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.531.1">
public interface CartService {  public List&lt;Item&gt; addCartItemsByCustomerId(String customerId, @Valid Item item);
  public List&lt;Item&gt; addOrReplaceItemsByCustomerId(String customerId, @Valid Item item);
  public void deleteCart(String customerId);
  public void deleteItemFromCart(String customerId, String itemId);
  public CartEntity getCartByCustomerId(String customerId);
  public List&lt;Item&gt; getCartItemsByCustomerId(String customerId);
  public Item getCartItemsByItemId(String customerId, String itemId);
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/service/CartService.java"><span class="No-Break"><span class="koboSpan" id="kobo.532.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/service/CartService.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.533.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">CartServiceImpl</span></strong><span class="koboSpan" id="kobo.535.1"> class is annotated with </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">@Service</span></strong><span class="koboSpan" id="kobo.537.1">, therefore it would be auto-detected and available for injection. </span><span class="koboSpan" id="kobo.537.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">CartRepository</span></strong><span class="koboSpan" id="kobo.539.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">UserRepository</span></strong><span class="koboSpan" id="kobo.541.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">ItemService</span></strong><span class="koboSpan" id="kobo.543.1"> class dependencies are injected using </span><span class="No-Break"><span class="koboSpan" id="kobo.544.1">constructor injection.</span></span></p>
<p><span class="koboSpan" id="kobo.545.1">Let’s have a look at one more method implementation</span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.546.1"> of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">CartService</span></strong><span class="koboSpan" id="kobo.548.1"> interface. </span><span class="koboSpan" id="kobo.548.2">Check the following code. </span><span class="koboSpan" id="kobo.548.3">It adds an item, or updates the price and quantity if the item </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">already exists:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.550.1">
@Overridepublic List&lt;Item&gt; addOrReplaceItemsByCustomerId(
  String customerId, @Valid Item item) {
  </span><strong class="bold"><span class="koboSpan" id="kobo.551.1">// 1</span></strong><span class="koboSpan" id="kobo.552.1">
  CartEntity entity = getCartByCustomerId(customerId);
  List&lt;ItemEntity&gt; items = Objects.nonNull
    (entity.getItems())
               ? </span><span class="koboSpan" id="kobo.552.2">entity.getItems() : Collections.
</span><span class="koboSpan" id="kobo.552.3">                 emptyList();
  AtomicBoolean itemExists = new AtomicBoolean(false);
  </span><strong class="bold"><span class="koboSpan" id="kobo.553.1">// 2</span></strong><span class="koboSpan" id="kobo.554.1">
  items.forEach(i -&gt; {
    if(i.getProduct().getId().equals(UUID.fromString(
        item.getId()))) {
     i.setQuantity(item.getQuantity()).
</span><span class="koboSpan" id="kobo.554.2">       setPrice(i.getPrice());
     itemExists.set(true);
    }
  });
  if (!itemExists.get()) {
    items.add(itemService.toEntity(item));
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.555.1">// 3</span></strong><span class="koboSpan" id="kobo.556.1">
  return itemService.toModelList(
       repository.save(entity).getItems());
}</span></pre>
<p><span class="koboSpan" id="kobo.557.1">In the preceding code, we are not managing the application state, but are instead writing the sort of business logic that queries the database, sets the entity object, persists the object, and then returns the model class. </span><span class="koboSpan" id="kobo.557.2">Let’s have a look at the statement blocks as numbered in the </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">previous code:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.559.1">The method only has </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">customerId</span></strong><span class="koboSpan" id="kobo.561.1"> as a parameter and there is no </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">Cart</span></strong><span class="koboSpan" id="kobo.563.1"> parameter. </span><span class="koboSpan" id="kobo.563.2">Therefore, first we get </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">CartEntity</span></strong><span class="koboSpan" id="kobo.565.1"> from the database based on the </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">given </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">customerId</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.569.1">The program control iterates through the items retrieved from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">CartEntity</span></strong><span class="koboSpan" id="kobo.571.1"> object. </span><span class="koboSpan" id="kobo.571.2">If the given item already exists, then the quantity and price are changed. </span><span class="koboSpan" id="kobo.571.3">Else, it creates a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">Item</span></strong><span class="koboSpan" id="kobo.573.1"> entity from the given </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">Item</span></strong><span class="koboSpan" id="kobo.575.1"> model and then saves it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">CartEntity</span></strong><span class="koboSpan" id="kobo.577.1"> object. </span><span class="koboSpan" id="kobo.577.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">itemExists</span></strong><span class="koboSpan" id="kobo.579.1"> flag is used to find out whether we need to update the existing </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">Item</span></strong><span class="koboSpan" id="kobo.581.1"> or add a </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">new one.</span></span></li>
<li><span class="koboSpan" id="kobo.583.1">Finally, the updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">CartEntity</span></strong><span class="koboSpan" id="kobo.585.1"> object is saved in the database. </span><span class="koboSpan" id="kobo.585.2">The latest </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">Item</span></strong><span class="koboSpan" id="kobo.587.1"> entity is retrieved from the database, and then gets converted into a model collection and returned to the </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">calling program.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.589.1">Similarly, you can write </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">Service</span></strong><span class="koboSpan" id="kobo.591.1"> components for others the way you have implemented</span><a id="_idIndexMarker254"/><span class="koboSpan" id="kobo.592.1"> them for </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">Cart</span></strong><span class="koboSpan" id="kobo.594.1">. </span><span class="koboSpan" id="kobo.594.2">Before we start enhancing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">Controller</span></strong><span class="koboSpan" id="kobo.596.1"> classes, we need to add a final frontier to our </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">overall feature.</span></span></p>
<h1 id="_idParaDest-109"><a id="_idTextAnchor108"/><span class="koboSpan" id="kobo.598.1">Implementing hypermedia</span></h1>
<p><span class="koboSpan" id="kobo.599.1">We learned about hypermedia</span><a id="_idIndexMarker255"/><span class="koboSpan" id="kobo.600.1"> and HATEOAS in </span><a href="B19349_01.xhtml#_idTextAnchor014"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.601.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.602.1">, </span><em class="italic"><span class="koboSpan" id="kobo.603.1">RESTful Web Service Fundamentals</span></em><span class="koboSpan" id="kobo.604.1">. </span><span class="koboSpan" id="kobo.604.2">Spring provides state-of-the-art support to HATEOAS using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">org.springframework.boot: </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">spring-boot-starter-hateoas</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.607.1"> dependency.</span></span></p>
<p><span class="koboSpan" id="kobo.608.1">First, we need to make sure that all models returned as part of the API response contain the link field. </span><span class="koboSpan" id="kobo.608.2">There are different ways to associate links (that is, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">org.springframework.hateoas.Link</span></strong><span class="koboSpan" id="kobo.610.1"> class) with models, either manually or via auto-generation. </span><span class="koboSpan" id="kobo.610.2">Spring HATEOAS’s links and attributes are implemented according to </span><em class="italic"><span class="koboSpan" id="kobo.611.1">RFC-8288</span></em><span class="koboSpan" id="kobo.612.1"> (</span><a href="https://tools.ietf.org/html/rfc8288"><span class="koboSpan" id="kobo.613.1">https://tools.ietf.org/html/rfc8288</span></a><span class="koboSpan" id="kobo.614.1">). </span><span class="koboSpan" id="kobo.614.2">For example, you can create a self-link manually </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.616.1">
import static org.springframework.hateoas.server.mvc. </span><span class="koboSpan" id="kobo.616.2">WebMvcLinkBuilder.linkTo;import static org.springframework.hateoas.server.mvc. </span><span class="koboSpan" id="kobo.616.3">WebMvcLinkBuilder.methodOn;
// other code blocks…
responseModel.setSelf(</span><strong class="bold"><span class="koboSpan" id="kobo.617.1">linkTo</span></strong><span class="koboSpan" id="kobo.618.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.619.1">methodOn</span></strong><span class="koboSpan" id="kobo.620.1">(CartController.class)  .getItemsByUserId(userId,item)).</span><strong class="bold"><span class="koboSpan" id="kobo.621.1">withSelfRel</span></strong><span class="koboSpan" id="kobo.622.1">())</span></pre>
<p><span class="koboSpan" id="kobo.623.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.624.1">responseModel</span></strong><span class="koboSpan" id="kobo.625.1"> is a model object that is returned by the API. </span><span class="koboSpan" id="kobo.625.2">It has a field called </span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">_self</span></strong><span class="koboSpan" id="kobo.627.1"> that is set using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">linkTo</span></strong><span class="koboSpan" id="kobo.629.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">methodOn</span></strong><span class="koboSpan" id="kobo.631.1"> static methods. </span><span class="koboSpan" id="kobo.631.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">linkTo</span></strong><span class="koboSpan" id="kobo.633.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">methodOn</span></strong><span class="koboSpan" id="kobo.635.1"> methods are provided by the Spring HATEOAS library and allow us to generate</span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.636.1"> a self-link for a given </span><span class="No-Break"><span class="koboSpan" id="kobo.637.1">controller method.</span></span></p>
<p><span class="koboSpan" id="kobo.638.1">This can also be done automatically by using Spring HATEOAS’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.639.1">RepresentationModelAssembler</span></strong><span class="koboSpan" id="kobo.640.1"> interface. </span><span class="koboSpan" id="kobo.640.2">This interface mainly exposes two methods – </span><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">toModel(T model)</span></strong><span class="koboSpan" id="kobo.642.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">toCollectionModel(Iterable&lt;? </span><span class="koboSpan" id="kobo.643.2">extends T&gt; entities)</span></strong><span class="koboSpan" id="kobo.644.1"> – that convert the given entity/entities into Model and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">CollectionModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.646.1">, respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.647.1">Spring HATEOAS provides the following classes to enrich the user-defined models with hypermedia. </span><span class="koboSpan" id="kobo.647.2">It basically provides a class that contains links and methods to add those to </span><span class="No-Break"><span class="koboSpan" id="kobo.648.1">the model:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">RepresentationModel</span></strong><span class="koboSpan" id="kobo.650.1">: Models/DTOs can extend this to collect </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">the links.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">EntityModel</span></strong><span class="koboSpan" id="kobo.653.1">: This extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">RepresentationModel</span></strong><span class="koboSpan" id="kobo.655.1"> and wraps the domain object (that is, the model) inside it with the content private field. </span><span class="koboSpan" id="kobo.655.2">Therefore, it contains the domain model/DTO and </span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">the links.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.657.1">CollectionModel</span></strong><span class="koboSpan" id="kobo.658.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.659.1">CollectionModel</span></strong><span class="koboSpan" id="kobo.660.1"> also extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">RepresentationModel</span></strong><span class="koboSpan" id="kobo.662.1">. </span><span class="koboSpan" id="kobo.662.2">It wraps the collection of models and provides a way to maintain and store </span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">the links.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">PageModel</span></strong><span class="koboSpan" id="kobo.665.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">PageModel</span></strong><span class="koboSpan" id="kobo.667.1"> extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.668.1">CollectionModel</span></strong><span class="koboSpan" id="kobo.669.1"> and provides ways to iterate through the pages, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.670.1">getNextLink()</span></strong><span class="koboSpan" id="kobo.671.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">getPreviousLink()</span></strong><span class="koboSpan" id="kobo.673.1">, and through page metadata with </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">getTotalPages()</span></strong><span class="koboSpan" id="kobo.675.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">among others.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.677.1">The default way to work</span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.678.1"> with Spring HATEOAS is to extend </span><strong class="source-inline"><span class="koboSpan" id="kobo.679.1">RepresentationModel</span></strong><span class="koboSpan" id="kobo.680.1"> with domain models, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">following snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.682.1">
public class Cart extends </span><strong class="bold"><span class="koboSpan" id="kobo.683.1">RepresentationModel</span></strong><span class="koboSpan" id="kobo.684.1">&lt;Cart&gt;implements Serializable {  private static final long serialVersionUID = 1L;
  @JsonProperty("id")
  private String id;
  @JsonProperty("customerId")
  @JacksonXmlProperty(localName = "customerId")
  private String customerId;Implementing hypermedia 101
  @JsonProperty("items")
  @JacksonXmlProperty(localName = "items")
  @Valid
  private List&lt;Item&gt; items = null;
  // Rest of the code is removed for brevity</span></pre>
<p><span class="koboSpan" id="kobo.685.1">Extending </span><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">RepresentationModel</span></strong><span class="koboSpan" id="kobo.687.1"> enhances the model with additional methods, including </span><strong class="source-inline"><span class="koboSpan" id="kobo.688.1">getLink()</span></strong><span class="koboSpan" id="kobo.689.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">hasLink()</span></strong><span class="koboSpan" id="kobo.691.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">add()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.694.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.695.1">You know that all these models are being generated by the OpenAPI Codegen; therefore, we need to configure the OpenAPI Codegen to generate new models that support hypermedia, which is done using the following </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">config.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.697.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.698.1">
{  // …
  "apiPackage": "com.packt.modern.api",
  "invokerPackage": "com.packt.modern.api",
  "serializableModel": true,
  "useTags": true,
  "useGzipFeature": true,
  </span><strong class="bold"><span class="koboSpan" id="kobo.699.1">"hateoas": true,</span></strong><span class="koboSpan" id="kobo.700.1">
  "unhandledException": true,
  // …
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/resources/api/config.json"><span class="No-Break"><span class="koboSpan" id="kobo.701.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/resources/api/config.json</span></span></a></p>
<p><span class="koboSpan" id="kobo.702.1">Adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">hateoas</span></strong><span class="koboSpan" id="kobo.704.1"> property and setting it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.705.1">true</span></strong><span class="koboSpan" id="kobo.706.1"> would automatically generate models that would extend the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">RepresentationModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.708.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.709.1">We are halfway there to implement</span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.710.1"> the API business logic. </span><span class="koboSpan" id="kobo.710.2">Now, we need to make sure that links will be populated with the appropriate URL automatically. </span><span class="koboSpan" id="kobo.710.3">For that purpose, we’ll extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">RepresentationModelAssemblerSupport</span></strong><span class="koboSpan" id="kobo.712.1"> abstract class, which internally implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.713.1">RepresentationModelAssembler</span></strong><span class="koboSpan" id="kobo.714.1">. </span><span class="koboSpan" id="kobo.714.2">Let’s write the assembler for </span><strong class="source-inline"><span class="koboSpan" id="kobo.715.1">Cart</span></strong><span class="koboSpan" id="kobo.716.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.718.1">
@Componentpublic class CartRepresentationModelAssembler extends
    </span><strong class="bold"><span class="koboSpan" id="kobo.719.1">RepresentationModelAssemblerSupport</span></strong><span class="koboSpan" id="kobo.720.1">&lt;CartEntity, Cart&gt; {
  private final ItemService itemService;
  public CartRepresentationModelAssembler(ItemService itemService) {
    </span><strong class="bold"><span class="koboSpan" id="kobo.721.1">super(CartsController.class, Cart.class)</span></strong><span class="koboSpan" id="kobo.722.1">;
    this.itemService = itemService;
  }
  @Override
  public Cart </span><strong class="bold"><span class="koboSpan" id="kobo.723.1">toModel</span></strong><span class="koboSpan" id="kobo.724.1">(CartEntity entity) {
    String uid = Objects.nonNull(entity.getUser()) ?
</span><span class="koboSpan" id="kobo.724.2">      entity.getUser().getId().toString() : null;
    String cid = Objects.nonNull(entity.getId()) ?
</span><span class="koboSpan" id="kobo.724.3">       entity.getId().toString() : null;
    Cart resource = new Cart();
    BeanUtils.copyProperties(entity, resource);
    resource.id(cid).customerId(uid)
      .items(itemService.toModelList(entity.getItems()));
    resource.add(linkTo(methodOn(CartsController.class)
      .getCartByCustomerId(uid)).withSelfRel());
    resource.add(linkTo(methodOn(CartsController.class)
     .getCartItemsByCustomerId(uid))
        .withRel("cart-items"));
    return resource;
  }
  public List&lt;Cart&gt; toListModel(
     Iterable&lt;CartEntity&gt; entities) {
    if (Objects.isNull(entities)){return List.of();}
    return StreamSupport.stream(
       entities.spliterator(), false).map(this::toModel)
       .collect(toList());
  }
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/hateoas/CartRepresentationModelAssembler.java"><span class="No-Break"><span class="koboSpan" id="kobo.725.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/hateoas/CartRepresentationModelAssembler.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.726.1">In the previous code, the important part in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.727.1">Cart</span></strong><span class="koboSpan" id="kobo.728.1"> assembler is extending </span><strong class="source-inline"><span class="koboSpan" id="kobo.729.1">RepresentationModelAssemblerSupport</span></strong><span class="koboSpan" id="kobo.730.1"> and overriding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.731.1">toModel()</span></strong><span class="koboSpan" id="kobo.732.1"> method. </span><span class="koboSpan" id="kobo.732.2">If you look closely, you’ll see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">CartController.class</span></strong><span class="koboSpan" id="kobo.734.1">, along with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">Cart</span></strong><span class="koboSpan" id="kobo.736.1"> model, is also passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">Rep</span></strong><span class="koboSpan" id="kobo.738.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">super()</span></strong><span class="koboSpan" id="kobo.740.1"> call. </span><span class="koboSpan" id="kobo.740.2">This allows the assembler to generate the links appropriately as is required for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">methodOn</span></strong><span class="koboSpan" id="kobo.742.1"> method shared earlier. </span><span class="koboSpan" id="kobo.742.2">This way, you can generate the </span><span class="No-Break"><span class="koboSpan" id="kobo.743.1">link automatically.</span></span></p>
<p><span class="koboSpan" id="kobo.744.1">You may also need</span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.745.1"> to add additional links to other resource controllers. </span><span class="koboSpan" id="kobo.745.2">You can achieve this by writing a bean that implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.746.1">RepresentationModelProcessor</span></strong><span class="koboSpan" id="kobo.747.1"> and then override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.748.1">process()</span></strong><span class="koboSpan" id="kobo.749.1"> method, as </span><span class="No-Break"><span class="koboSpan" id="kobo.750.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.751.1">
@Overridepublic Order process(Order model) {
  model.add(Link.of("/payments/{orderId}").withRel(
    LinkRelation.of("payments")).expand(model.getOrderId()));
  return model;
}</span></pre>
<p><span class="koboSpan" id="kobo.752.1">You can always</span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.753.1"> refer to </span><a href="https://docs.spring.io/spring-hateoas/docs/current/reference/html/"><span class="koboSpan" id="kobo.754.1">https://docs.spring.io/spring-hateoas/docs/current/reference/html/</span></a><span class="koboSpan" id="kobo.755.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.756.1">more information.</span></span></p>
<p><span class="koboSpan" id="kobo.757.1">Let’s make use of the services</span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.758.1"> and HATEOAS enablers you created in the controller classes in the </span><span class="No-Break"><span class="koboSpan" id="kobo.759.1">next section.</span></span></p>
<h1 id="_idParaDest-110"><a id="_idTextAnchor109"/><span class="koboSpan" id="kobo.760.1">Enhancing the controller with a service and HATEOAS</span></h1>
<p><span class="koboSpan" id="kobo.761.1">In </span><a href="B19349_03.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.762.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.763.1">, </span><em class="italic"><span class="koboSpan" id="kobo.764.1">API Specifications and Implementation</span></em><span class="koboSpan" id="kobo.765.1">, we</span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.766.1"> created</span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.767.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">Controller</span></strong><span class="koboSpan" id="kobo.769.1"> class</span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.770.1"> for </span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.771.1">the Cart API – </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">CartController</span></strong><span class="koboSpan" id="kobo.773.1"> – which just implements the OpenAPI Codegen-generated API specification interface – </span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">CartApi</span></strong><span class="koboSpan" id="kobo.775.1">. </span><span class="koboSpan" id="kobo.775.2">It was just a mere block of code without any business logic or data </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">persistence calls.</span></span></p>
<p><span class="koboSpan" id="kobo.777.1">Now, since we have written the repositories, services, and HATEOAS assemblers, we can enhance the API controller class, as </span><span class="No-Break"><span class="koboSpan" id="kobo.778.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.779.1">
@RestControllerpublic class CartsController implements CartApi {
  private CartService service;
  private final CartRepresentationModelAssembler assembler;
  public CartsController(CartService service,
     CartRepresentationModelAssembler assembler) {
    this.service = service;
    this.assembler = assembler;
  }</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/controller/CartsController.java"><span class="No-Break"><span class="koboSpan" id="kobo.780.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/controller/CartsController.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.781.1">You can see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">CartService</span></strong><span class="koboSpan" id="kobo.783.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.784.1">CartRepresentationModelAssembler</span></strong><span class="koboSpan" id="kobo.785.1"> are injected using the constructor. </span><span class="koboSpan" id="kobo.785.2">The Spring container injects these dependencies at runtime. </span><span class="koboSpan" id="kobo.785.3">Then, these can be used as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.786.1">code block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.787.1">
@Overridepublic ResponseEntity&lt;Cart&gt; getCartByCustomerId(  String customerId) {
  return ok(</span><strong class="bold"><span class="koboSpan" id="kobo.788.1">assembler</span></strong><span class="koboSpan" id="kobo.789.1">.toModel(service.getCartByCustomerId
   (customerId)));
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/controller/CartsController.java"><span class="No-Break"><span class="koboSpan" id="kobo.790.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/controller/CartsController.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.791.1">In the preceding code, you can see that the service retrieves the </span><strong class="source-inline"><span class="koboSpan" id="kobo.792.1">Cart</span></strong><span class="koboSpan" id="kobo.793.1"> entity based on </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">customerId</span></strong><span class="koboSpan" id="kobo.795.1"> (which internally retrieves it from the repository). </span><span class="koboSpan" id="kobo.795.2">This </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">Cart</span></strong><span class="koboSpan" id="kobo.797.1"> entity then gets converted into a model that also contains the hypermedia links made available by Spring HATEOAS’s </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">RepresentationModelAssemblerSupport</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.799.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.800.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">ok()</span></strong><span class="koboSpan" id="kobo.802.1"> static method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">ResponseEntity</span></strong><span class="koboSpan" id="kobo.804.1"> is used to wrap the returned model that also contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">200 </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.806.1">OK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.807.1"> status.</span></span></p>
<p><span class="koboSpan" id="kobo.808.1">This way, you</span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.809.1"> can</span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.810.1"> also enhance and implement the other</span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.811.1"> controllers. </span><span class="koboSpan" id="kobo.811.2">Now, we can also add an ETag</span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.812.1"> to our </span><span class="No-Break"><span class="koboSpan" id="kobo.813.1">API responses.</span></span></p>
<h1 id="_idParaDest-111"><a id="_idTextAnchor110"/><span class="koboSpan" id="kobo.814.1">Adding ETags to API responses</span></h1>
<p><span class="koboSpan" id="kobo.815.1">An ETag is an HTTP response</span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.816.1"> header that contains a computed hash or equivalent</span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.817.1"> value of the response entity, and a minor change in the entity must change its value. </span><span class="koboSpan" id="kobo.817.2">HTTP request objects can then contain the </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">If-None-Match</span></strong><span class="koboSpan" id="kobo.819.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">If-Match</span></strong><span class="koboSpan" id="kobo.821.1"> headers to receive the </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1">conditional responses.</span></span></p>
<p><span class="koboSpan" id="kobo.823.1">Let’s call an API to retrieve the response with an ETag, as </span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">shown next:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.825.1">
$ curl -v --location --request GET 'http://localhost:8080/ api/v1/products/6d62d909-f957-430e-8689-b5129c0bb75e' –-header 'Content-Type: application/json' --header 'Accept: application/json'* … text trimmed
&gt; GET /api/v1/products/6d62d909-f957-430e-8689-b5129c0bb75e HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.55.1
&gt; Content-Type: application/json
&gt; Accept: application/json
&gt;
&lt; HTTP/1.1 200
&lt; ETag: "098e97de3b61db55286f5f2812785116f"
&lt; Content-Type: application/json
&lt; Content-Length: 339
&lt;
{
  "_links": {
    "self": {
      "href": "http://localhost:8080/6d62d909-f957-430e
              -8689-b5129c0bb75e"
    }
  },
  "id": "6d62d909-f957-430e-8689-b5129c0bb75e",
  "name": "Antifragile",
  "description": "Antifragile - Things …",
  "imageUrl": "/images/Antifragile.jpg",
  "price": 17.1500,
  "count": 33,
  "tag": ["psychology", "book"]
}</span></pre>
<p><span class="koboSpan" id="kobo.826.1">Then, you can copy</span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.827.1"> the value from the ETag header to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.828.1">If-None-Match</span></strong><span class="koboSpan" id="kobo.829.1"> header </span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.830.1">and send the same request again with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.831.1">If-None-Match</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.832.1"> header:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.833.1">
$ curl -v --location --request GET 'http://localhost:8080/ api/v1/products/6d62d909-f957-430e-8689-b5129c0bb75e' --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'If-None-Match: "098e97de3b61db55286f5f2812785116f"'* … text trimmed
&gt; GET /api/v1/products/6d62d909-f957-430e-8689-b5129c0bb75e HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.55.1
&gt; Content-Type: application/json
&gt; Accept: application/jsonAdding ETags to API responses 107
&gt; If-None-Match: "098e97de3b61db55286f5f2812785116f"
&gt;
&lt; HTTP/1.1 304
&lt; ETag: "098e97de3b61db55286f5f2812785116f"</span></pre>
<p><span class="koboSpan" id="kobo.834.1">You can see that since there is no change to the entity in the database, and it contains the same entity, it sends a </span><strong class="source-inline"><span class="koboSpan" id="kobo.835.1">304</span></strong><span class="koboSpan" id="kobo.836.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">NOT MODIFIED</span></strong><span class="koboSpan" id="kobo.838.1">) response instead of sending the proper response with </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">200 OK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.841.1">The easiest way</span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.842.1"> to implement ETags</span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.843.1"> is using Spring’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.844.1">ShallowEtagHeaderFilter</span></strong><span class="koboSpan" id="kobo.845.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.846.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.847.1">
@Beanpublic ShallowEtagHeaderFilter shallowEtagHeaderFilter() {
  return new ShallowEtagHeaderFilter();
}</span></pre>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/AppConfig.java"><span class="No-Break"><span class="koboSpan" id="kobo.848.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/src/main/java/com/packt/modern/api/AppConfig.java</span></span></a></p>
<p><span class="koboSpan" id="kobo.849.1">For this implementation, Spring calculates the MD5 hash from the cached content written to the response. </span><span class="koboSpan" id="kobo.849.2">Next time, when it receives a request with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.850.1">If-None-Match</span></strong><span class="koboSpan" id="kobo.851.1"> header, it again creates the MD5 hash from the cached content written to the response and then compares these two hashes. </span><span class="koboSpan" id="kobo.851.2">If both are the same, it sends the </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">304 NOT MODIFIED</span></strong><span class="koboSpan" id="kobo.853.1"> response. </span><span class="koboSpan" id="kobo.853.2">This way, it will save bandwidth, but the same CPU computation will </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">be required.</span></span></p>
<p><span class="koboSpan" id="kobo.855.1">We can use the HTTP cache control (</span><strong class="source-inline"><span class="koboSpan" id="kobo.856.1">org.springframework.http.CacheControl</span></strong><span class="koboSpan" id="kobo.857.1">) class and use the version or a similar attribute that gets updated with each change, if available, to avoid unnecessary CPU computation and for better ETag handling, as </span><span class="No-Break"><span class="koboSpan" id="kobo.858.1">shown next:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.859.1">
return ResponseEntity.ok()       .cacheControl(CacheControl.maxAge(5, TimeUnit.DAYS))
       .eTag(prodcut.getModifiedDateInEpoch())
       .body(product);</span></pre>
<p><span class="koboSpan" id="kobo.860.1">Adding an ETag to the response also allows UI apps to determine whether a page/object refresh is required, or an event needs</span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.861.1"> to be triggered, especially where data changes frequently in applications, such as providing</span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.862.1"> live scores or </span><span class="No-Break"><span class="koboSpan" id="kobo.863.1">stock quotes.</span></span></p>
<p><span class="koboSpan" id="kobo.864.1">Now, you have implemented fully functional APIs. </span><span class="koboSpan" id="kobo.864.2">Let’s test </span><span class="No-Break"><span class="koboSpan" id="kobo.865.1">them next.</span></span></p>
<h1 id="_idParaDest-112"><a id="_idTextAnchor111"/><span class="koboSpan" id="kobo.866.1">Testing the APIs</span></h1>
<p><span class="koboSpan" id="kobo.867.1">Now, you must be looking</span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.868.1"> forward to testing. </span><span class="koboSpan" id="kobo.868.2">You can find the API client collection at the following location, which is an HTTP Archive file and can be used by Insomnia or Postman API clients. </span><span class="koboSpan" id="kobo.868.3">You can import it and then test </span><span class="No-Break"><span class="koboSpan" id="kobo.869.1">the APIs:</span></span></p>
<p><a href="https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/Chapter04-API-Collection.har"><span class="No-Break"><span class="koboSpan" id="kobo.870.1">https://github.com/PacktPublishing/Modern-API-Development-with-Spring-6-and-Spring-Boot-3/blob/main/Chapter04/Chapter04-API-Collection.har</span></span></a></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.871.1">Building and running the Chapter 4 code</span></p>
<p class="callout"><span class="koboSpan" id="kobo.872.1">You can build the code by running </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">gradlew clean build</span></strong><span class="koboSpan" id="kobo.874.1"> from the root of the project and run the service using </span><strong class="source-inline"><span class="koboSpan" id="kobo.875.1">java -jar build/libs/Chapter04-0.0.1-SNAPSHOT.jar</span></strong><span class="koboSpan" id="kobo.876.1">. </span><span class="koboSpan" id="kobo.876.2">Make sure to use Java 17 in </span><span class="No-Break"><span class="koboSpan" id="kobo.877.1">the path.</span></span></p>
<h1 id="_idParaDest-113"><a id="_idTextAnchor112"/><span class="koboSpan" id="kobo.878.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.879.1">In this chapter, we have learned about database migration using Flyway, maintaining and persisting data using repositories, and writing business logic to services. </span><span class="koboSpan" id="kobo.879.2">We have also learned how hypermedia can automatically be added to API responses using Spring HATEOAS assemblers. </span><span class="koboSpan" id="kobo.879.3">You have now learned about all the RESTful API development practices, which allows you to use this skill in your day-to-day work involving RESTful </span><span class="No-Break"><span class="koboSpan" id="kobo.880.1">API development.</span></span></p>
<p><span class="koboSpan" id="kobo.881.1">So far, we have written synchronous APIs. </span><span class="koboSpan" id="kobo.881.2">In the next chapter, you will learn about async APIs and how to implement them </span><span class="No-Break"><span class="koboSpan" id="kobo.882.1">using Spring.</span></span></p>
<h1 id="_idParaDest-114"><a id="_idTextAnchor113"/><span class="koboSpan" id="kobo.883.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.884.1">Why is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.885.1">@Repository</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.886.1">class used?</span></span></li>
<li><span class="koboSpan" id="kobo.887.1">Is it possible to add extra imports or annotations to Swagger-generated classes </span><span class="No-Break"><span class="koboSpan" id="kobo.888.1">or models?</span></span></li>
<li><span class="koboSpan" id="kobo.889.1">How are </span><span class="No-Break"><span class="koboSpan" id="kobo.890.1">ETags useful?</span></span></li>
</ol>
<h1 id="_idParaDest-115"><a id="_idTextAnchor114"/><span class="koboSpan" id="kobo.891.1">Answers</span></h1>
<ol>
<li value="1"><span class="koboSpan" id="kobo.892.1">Repository classes are marked with </span><strong class="source-inline"><span class="koboSpan" id="kobo.893.1">@Repository</span></strong><span class="koboSpan" id="kobo.894.1">, which is a specialized </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">@Component</span></strong><span class="koboSpan" id="kobo.896.1"> that makes these classes auto-detectable by package-level auto-scanning and makes them available for injection. </span><span class="koboSpan" id="kobo.896.2">Spring provides these classes especially for DDD repositories and the JEE DAO pattern. </span><span class="koboSpan" id="kobo.896.3">This is the layer used by the application for interacting with the database – retrieval and persistence as a </span><span class="No-Break"><span class="koboSpan" id="kobo.897.1">central repository.</span></span></li>
<li><span class="koboSpan" id="kobo.898.1">It is possible to change the way models and APIs are generated. </span><span class="koboSpan" id="kobo.898.2">You must copy the template that you want to modify and then place it in the resources folder. </span><span class="koboSpan" id="kobo.898.3">Then, you have to modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.899.1">swaggerSources</span></strong><span class="koboSpan" id="kobo.900.1"> block in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.901.1">build.gradle</span></strong><span class="koboSpan" id="kobo.902.1"> file by adding an extra configuration parameter to point to the template source, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.903.1">templateDir = file("${rootDir}/src/main/resources/ templates")</span></strong><span class="koboSpan" id="kobo.904.1">. </span><span class="koboSpan" id="kobo.904.2">This is the place where you keep modified templates such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">api. </span><span class="koboSpan" id="kobo.905.2">mustache</span></strong><span class="koboSpan" id="kobo.906.1">. </span><span class="koboSpan" id="kobo.906.2">This will extend the OpenAPI Codegen templates. </span><span class="koboSpan" id="kobo.906.3">You can find all the templates inside the OpenAPI generator JAR file, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.907.1">openapi-generator-cli-4.3.1.jar</span></strong><span class="koboSpan" id="kobo.908.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.909.1">\JavaSpring</span></strong><span class="koboSpan" id="kobo.910.1"> directory. </span><span class="koboSpan" id="kobo.910.2">You can copy the one you want to modify in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.911.1">src/main/resource/templates</span></strong><span class="koboSpan" id="kobo.912.1"> directory and then play with it. </span><span class="koboSpan" id="kobo.912.2">You can make use of the </span><span class="No-Break"><span class="koboSpan" id="kobo.913.1">following resources:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.914.1">JavaSpring </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.915.1">templates</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.916.1">: </span></span><a href="https://github.com/swagger-api/swagger-codegen/tree/master/modules/swagger-codegen/src/main/resources/JavaSpring"><span class="No-Break"><span class="koboSpan" id="kobo.917.1">https://github.com/swagger-api/swagger-codegen/tree/master/modules/swagger-codegen/src/main/resources/JavaSpring</span></span></a></li><li><strong class="bold"><span class="koboSpan" id="kobo.918.1">Mustache template </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.919.1">variables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.920.1">: </span></span><a href="https://github.com/swagger-api/swagger-codegen/wiki/Mustache-Template-Variables"><span class="No-Break"><span class="koboSpan" id="kobo.921.1">https://github.com/swagger-api/swagger-codegen/wiki/Mustache-Template-Variables</span></span></a></li><li><strong class="bold"><span class="koboSpan" id="kobo.922.1">An article explaining implementing a similar </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.923.1">approach</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.924.1">: </span></span><a href="https://arnoldgalovics.com/swagger-codegen-custom-template/"><span class="No-Break"><span class="koboSpan" id="kobo.925.1">https://arnoldgalovics.com/swagger-codegen-custom-template/</span></span></a></li></ul></li>
<li><span class="koboSpan" id="kobo.926.1">ETags help to improve the REST/HTTP client performance and user experience by only re-rendering the page/section when the underlying API response is updated. </span><span class="koboSpan" id="kobo.926.2">They also save bandwidth by carrying the response body only when required. </span><span class="koboSpan" id="kobo.926.3">CPU utilization can be optimized if the ETag is generated based on values retrieved from the database, for example, the version or date </span><span class="No-Break"><span class="koboSpan" id="kobo.927.1">last modified.</span></span></li>
</ol>
<h1 id="_idParaDest-116"><a id="_idTextAnchor115"/><span class="koboSpan" id="kobo.928.1">Further reading</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.929.1">Spring </span><span class="No-Break"><span class="koboSpan" id="kobo.930.1">HATEOAS: </span></span><a href="https://docs.spring.io/spring-hateoas/docs/current/reference/html/"><span class="No-Break"><span class="koboSpan" id="kobo.931.1">https://docs.spring.io/spring-hateoas/docs/current/reference/html/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.932.1">RFC-8288: </span></span><a href="https://tools.ietf.org/html/rfc8288"><span class="No-Break"><span class="koboSpan" id="kobo.933.1">https://tools.ietf.org/html/rfc8288</span></span></a></li>
</ul>
</div>
</body></html>