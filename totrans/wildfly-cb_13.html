<html><head></head><body><div class="chapter" title="Chapter&#xA0;13.&#xA0;Messaging with WildFly"><div class="titlepage"><div><div><h1 class="title"><a id="ch13"/>Chapter 13. Messaging with WildFly</h1></div></div></div><p>In this chapter, you will learn the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Running the messaging system using HornetQ</li><li class="listitem" style="list-style-type: disc">Sending and receiving messages to/from a JMS queue destination</li><li class="listitem" style="list-style-type: disc">Clustering HornetQ using a shared store</li><li class="listitem" style="list-style-type: disc">Clustering HornetQ using message replication</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec104"/>Introduction</h1></div></div></div><p>In this chapter, you will learn how to configure HornetQ embedded in our WildFly in order to provide JMS capabilities to our applications. As WildFly is a Java EE 7-certified application server, it implements the JMS specification version 2.0.</p><p>HornetQ is a <a id="id965" class="indexterm"/><span class="strong"><strong>Message oriented middleware</strong></span> (<span class="strong"><strong>MOM</strong></span>) used to exchange messages in clustered and asynchronous systems. It can run standalone (I'm not talking about the WildFly standalone mode) or embedded, that is inside an <a id="id966" class="indexterm"/>application server such as WildFly, by using the <span class="strong"><strong>Java EE Connector Architecture</strong></span> (<span class="strong"><strong>JCA</strong></span>).</p><p>Because HornetQ uses the JCA to integrate itself with WildFly, it also provides out-of-the-box support for connection pooling, JTA transactions, and container managed security, features that simplify a developer's life. Thus, integrating your EJB application with the JMS system will not need additional work.</p><p>HornetQ uses two fundamental concepts, that is, acceptors and connectors. Acceptors determine how the HornetQ server accepts incoming connections, while connectors determine how to make connections with other HornetQ servers or JMS clients.</p><p>Two types of <a id="id967" class="indexterm"/>acceptors and <a id="id968" class="indexterm"/>connectors exist:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>invm</strong></span>: The connections within the same JVM (more performance, obviously)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>netty</strong></span>: The connections to/from remote JVMs</li></ul></div><p>Each configured connector <a id="id969" class="indexterm"/>is used just to reach a server if there is the same type of acceptor configured on the other server. In other words, if we are making a connection with an <code class="literal">invm</code> connector, the other server must have an <code class="literal">invm</code> acceptor configured. On the other hand, if we are making a connection with a <code class="literal">netty</code> connector, the other server must have a <code class="literal">netty</code> acceptor configured.</p><p>HornetQ provides HA capabilities using a live server and a backup server. The backup server is in idle mode; it does not work until the live server fails.</p><p>Essentially, all messages are constantly replicated from the live server to the backup server. This synchronization is achieved in two ways: shared store and message replication. Shared store essentially means that both the live and backup servers share the same filesystem where messages are stored. Message replication, on the other hand, works via network traffic. Each server will then persist messages in its own local filesystem.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>Only persistent messages are replicated; thus they survive a server crash.</p></div></div><p>HornetQ has its own persistence, which is based on a high-performance journal filesystem. HornetQ uses three different journals:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Bindings journal</li><li class="listitem" style="list-style-type: disc">JMS journal</li><li class="listitem" style="list-style-type: disc">Message journal</li></ul></div><p>HornetQ supports two different configurations for shared stores:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">GFS2 on a SAN, using the AsyncIO journal type</li><li class="listitem" style="list-style-type: disc">NFSv4, using either the AsyncIO or NIO journal type<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>NFS should only be used in a development environment, because of its performance issues.</p></div></div></li></ul></div><p>We can find the HornetQ configuration embedded into our WildFly configuration files, more precisely in the <code class="literal">standalone-full.xml</code> and <code class="literal">standalone-full-ha.xml</code>, if we are running in the standalone mode. However, if we are running in the domain mode, we can find the proper HornetQ configuration in the WildFly provided profiles such as <code class="literal">full</code> and <code class="literal">full-ha</code>. The <code class="literal">full</code> configuration enables the messaging systems, while the <code class="literal">full-ha</code> adds clustering and load-balancing capabilities.</p><p>For this chapter, it's assumed that you are familiar with JMS concepts such as Queue, Topic, MDB, DLQ, ExpiryQueue, point-to-point, and publish/subscribe, because we will not go too deep into JMS specification details. If you want to start learning about HornetQ, I really suggest you to read the excellent book <span class="emphasis"><em>HornetQ Messaging Developer's Guide</em></span>, <span class="emphasis"><em>Piero Giacomelli</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>, which goes deep into the development aspects of the framework and the JMS specification.</p><p>There are also alternatives to <a id="id970" class="indexterm"/>HornetQ, such as ActiveMQ. For a deeper look into ActiveMQ, please refer to official documentation at <a class="ulink" href="http://activemq.apache.org">http://activemq.apache.org</a>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip15"/>Tip</h3><p>Architecting a messaging system is a hard and complex task; it involves a lot of aspects (memory, performance, network, storage, clustering, and so on) and there is no one-fits-all configuration. Every messaging system needs to be configured adhoc, tested and tuned a lot of times before going into production.</p></div></div></div></div>
<div class="section" title="Running the messaging system using HornetQ"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec105"/>Running the messaging system using HornetQ</h1></div></div></div><p>In this <a id="id971" class="indexterm"/>recipe, you will learn how to configure <a id="id972" class="indexterm"/>and run the WildFly messaging system provided by HornetQ. This is a warm-up recipe, just to get you ready.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec295"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">adhoc</code> folder to run our WildFly. In a terminal window enter the following commands:</p><div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone jms-std-node-1</pre></div><p>Now it's time to run our WildFly!!!</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec296"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal window and execute the following:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=jms-std-node-1 --server-config=standalone-full.xml</pre></div></li><li class="listitem">Now if we open the Web Console, we should find the <span class="strong"><strong>Messaging</strong></span> subsystem as well, as depicted in the following screenshot:<div class="mediaobject"><img src="graphics/3744_13_01.jpg" alt="How to do it…"/><div class="caption"><p>Admin Console showing the Messaging subsystem</p></div></div></li></ol></div><p>Well, that was <a id="id973" class="indexterm"/>quite simple! Let's try something more <a id="id974" class="indexterm"/>exciting with the following recipes of this chapter.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec297"/>How it works…</h2></div></div></div><p>First of all, you should have noticed that we specified the <code class="literal">--server-config</code> directive, which overrides the default configuration filename, that is, <code class="literal">standalone.xml</code> for the standalone mode, and <code class="literal">host.xml</code> for the domain mode.</p><p>The configuration filename specified is the one which has the messaging system pre-configured. If you remember from the earlier recipes of the book, in WildFly (as also in JBoss AS, and JBoss EAP) we have the following for different profiles:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">default</code>: This should be used for common web applications (including REST backend)</li><li class="listitem" style="list-style-type: disc"><code class="literal">full</code>: This <a id="id975" class="indexterm"/>should be used for applications with JMS capabilities</li><li class="listitem" style="list-style-type: disc"><code class="literal">ha</code>: This should <a id="id976" class="indexterm"/>be used for common web applications that require clustering and balancing capabilities</li><li class="listitem" style="list-style-type: disc"><code class="literal">full-ha</code>: This should be used for applications that require JMS, clustering, and balancing capabilities all together</li></ul></div><p>Thus, the <code class="literal">standalone-full.xml</code> file gives us the proper configuration to run applications with JMS capabilities.</p><p>After we launched the start-up script, the log showed us various entries. Take for example the following entry:</p><div class="informalexample"><pre class="programlisting">07:49:49,151 WARN  [org.jboss.as.messaging] (MSC service thread 1-11) WFLYMSG0075: AIO wasn't located on this platform, it will fall back to using pure Java NIO. Your platform is Linux, install LibAIO to enable the AIO journal.</pre></div><p>It is complaining about the use of the native API to access the filesystem instead of using the Java NIO ones. This is because, as mentioned in the introduction, HornetQ persists JMS messages on the filesystem, so a better performant API is preferred.</p><p>Other interesting log entries are the following:</p><div class="informalexample"><pre class="programlisting">07:49:50,249 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221043: Adding protocol support CORE
07:49:50,262 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221043: Adding protocol support AMQP
07:49:50,268 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221043: Adding protocol support STOMP
07:49:50,535 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221034: Waiting to obtain live lock
07:49:50,536 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221035: Live Server Obtained live lock
07:49:50,585 INFO  [org.jboss.messaging] (MSC service thread 1-12) WFLYMSG0016: Registered HTTP upgrade for hornetq-remoting protocol handled by http-acceptor-throughput acceptor
07:49:50,585 INFO  [org.jboss.messaging] (MSC service thread 1-3) WFLYMSG0016: Registered HTTP upgrade for hornetq-remoting protocol handled by http-acceptor acceptor
07:49:50,710 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221007: Server is now live
07:49:50,711 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221001: HornetQ Server version 2.4.5.FINAL (Wild Hornet, 124) [48a0b5e3-1b30-11e5-838f-0fbc7481b7aa]</pre></div><p>The preceding entries are relative to the multi-protocol interoperability that HornetQ provides (it doesn't implement just the JMS specification). They imply that the server (meaning HornetQ) is now ready to produce and consume messages, and all that comes with it.</p><p>Last, but not <a id="id977" class="indexterm"/>least, the following entries describe <a id="id978" class="indexterm"/>the resource that we have preconfigured:</p><div class="informalexample"><pre class="programlisting">07:49:50,740 INFO  [org.jboss.as.messaging] (ServerService Thread Pool -- 68) WFLYMSG0002: Bound messaging object to jndi name java:jboss/exported/jms/RemoteConnectionFactory
07:49:50,765 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 70) HQ221003: trying to deploy queue jms.queue.DLQ
07:49:50,849 INFO  [org.jboss.as.messaging] (ServerService Thread Pool -- 71) WFLYMSG0002: Bound messaging object to jndi name java:/ConnectionFactory
07:49:50,851 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 69) HQ221003: trying to deploy queue jms.queue.ExpiryQueue
07:49:50,878 INFO  [org.jboss.as.connector.deployment] (MSC service thread 1-7) WFLYJCA0007: Registered connection factory java:/JmsXA
07:49:50,930 INFO  [org.hornetq.ra] (MSC service thread 1-7) HornetQ resource adaptor started
07:49:50,931 INFO  [org.jboss.as.connector.services.resourceadapters.ResourceAdapterActivatorService$ResourceAdapterActivator] (MSC service thread 1-7) IJ020002: Deployed: file://RaActivatorhornetq-ra
07:49:50,937 INFO  [org.jboss.as.connector.deployment] (MSC service thread 1-13) WFLYJCA0002: Bound JCA ConnectionFactory [java:/JmsXA]
07:49:50,938 INFO  [org.jboss.as.messaging] (MSC service thread 1-16) WFLYMSG0002: Bound messaging object to jndi name java:jboss/DefaultJMSConnectionFactory</pre></div><p>We have connection factories, which are used to connect and obtain a session from the server to send and receive messages.</p><p>We also have two destinations: <code class="literal">jms.queue.DLQ</code> and <code class="literal">jms.queue.ExpiryQueue</code>.</p><p>The first one is the <span class="emphasis"><em>dead letter queue</em></span>, where all messages that couldn't be successfully processed (consumed) go to. When something goes wrong while consuming a message with a <span class="strong"><strong>Message Driven Bean</strong></span> (<span class="strong"><strong>MDB</strong></span>), the message gets rolled back and goes directly to the DLQ. Nevertheless, there are redelivery policies that can try to send our message again.</p><p>All expired <a id="id979" class="indexterm"/>messages go to the queue called <a id="id980" class="indexterm"/><code class="literal">ExpiryQueue</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>If you are running on Mac and using the <code class="literal">full-ha</code> profile, beware of the following network issue you might meet:</p><p>
<code class="literal">HQ224033</code>: Failed to broadcast connector <code class="literal">configs: java.io.IOException</code>; Can't assign requested address</p><p>The <code class="literal">full-ha</code> profile, because of its additional clustering and balancing capabilities, provides auto-discovery to its HornetQ server, and it does so by using the multicast address. Often, UDP traffic gets dropped, so make sure that the environment you are in accepts UDP traffic.</p><p>For example, in our case, we are probably trying the recipe at home, and UDP traffic gets forwarded to the ISP that drops such traffic. What we need to do is create a local route to redirect the UDP traffic to our loopback interface, which is our localhost, <code class="literal">127.0.0.1</code> IP address.</p><p>You can add the multicast route to the loopback interface as follows:</p><p>
<code class="literal">sudo route add 224.0.0.0 127.0.0.1 -netmask 240.0.0.0</code>
</p><p>Beware that when running in a production environment, adding this loopback route will prevent any and all multicast messages from reaching other servers.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec298"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a deeper understanding <a id="id981" class="indexterm"/>of the HornetQ server principles, please refer to the official documentation at <a class="ulink" href="http://hornetq.jboss.org">http://hornetq.jboss.org</a>.</li></ul></div></div></div>
<div class="section" title="Sending and receiving messages to/from a JMS queue destination"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec106"/>Sending and receiving messages to/from a JMS queue destination</h1></div></div></div><p>In this <a id="id982" class="indexterm"/>recipe, we will learn how to produce <a id="id983" class="indexterm"/>and consume a JMS queue <a id="id984" class="indexterm"/>message. We will use two little applications, one <a id="id985" class="indexterm"/>that produces messages, and another one that consumes messages.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec299"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To get started, let's first create an <code class="literal">adhoc</code> folder to run our WildFly. In a terminal window enter the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone jms-std-node-2</pre></div></li><li class="listitem">In this <a id="id986" class="indexterm"/>recipe, we will need <a id="id987" class="indexterm"/>an application to test our configuration. For this recipe, we will need the applications named <code class="literal">jms-producer</code> and <code class="literal">jms-consumer</code>, which you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe of <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</li><li class="listitem">To build the application, enter the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/github/wildfly-cookbook
$ cd jms-producer
$ mvn clean package</pre></div></li></ol></div><p>Now it's time to run our WildFly!!!</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec300"/>How to do it…</h2></div></div></div><p>First of all, we need to <a id="id988" class="indexterm"/>add a user to the <code class="literal">ApplicationRealm</code> realm, which is the one used by the remoting subsystem and hence, the messaging subsystem.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal window and execute the following:<div class="informalexample"><pre class="programlisting">$ ./bin/add-user.sh -sc jms-std-node-2/configuration

What type of user do you wish to add?
 a) Management User (mgmt-users.properties)
 b) Application User (application-users.properties)
(a): <span class="strong"><strong>b</strong></span>

Enter the details of the new user to add.
Using realm 'ApplicationRealm' as discovered from the existing property files.
Username : <span class="strong"><strong>jmsuser</strong></span>
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
 - The password should be different from the username
Password : <span class="strong"><strong>[jmsuser.2015]</strong></span>
Re-enter Password : <span class="strong"><strong>[jmsuser.2015]</strong></span>
What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]: <span class="strong"><strong>guest</strong></span>
About to add user 'jmsuser' for realm 'ApplicationRealm'
Is this correct yes/no? yes
Added user 'jmsuser' to file '/opt/wildfly/jms-std-node-2/configuration/application-users.properties'
Added user 'jmsuser' with groups guest to file '/opt/wildfly/jms-std-node-2/configuration/application-roles.properties'
Is this new user going to be used for one AS process to connect to another AS process?
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? no</pre></div></li><li class="listitem">Now <a id="id989" class="indexterm"/>it's time to run our WildFly <a id="id990" class="indexterm"/>as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=jms-std-node-2 --server-config=standalone-full.xml</pre></div></li><li class="listitem">Once <a id="id991" class="indexterm"/>started, let's connect to <a id="id992" class="indexterm"/>the CLI in a new terminal and create the queue, as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/jboss-cli.sh
You are disconnected at the moment. Type 'connect' to connect to the server or 'help' for the list of supported commands.
[disconnected /] connect
[standalone@localhost:9990 /] jms-queue add --queue-address=WildFlyCookbookQueue --entries=queue/test,java:jboss/exported/jms/queue/test
[standalone@localhost:9990 /]</pre></div></li><li class="listitem">In our <code class="literal">server.log</code>, we should find the following entries:<div class="informalexample"><pre class="programlisting">12:02:52,183 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 60) HQ221003: trying to deploy queue jms.queue.WildFlyCookbookQueue</pre></div><p>Great, we've successfully created our queue destination!!!</p></li><li class="listitem">Now it's <a id="id993" class="indexterm"/>time to run our <code class="literal">jms-producer</code> and send a message to our <code class="literal">WildFlyCookbookQueue</code> queue. Let's <a id="id994" class="indexterm"/>compile it and run it, as <a id="id995" class="indexterm"/>follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/github/wildfly-cookbook/jms-producer
$ mvn clean compile exec:java</pre></div><p>The result of the <a id="id996" class="indexterm"/>preceding command is depicted in the following image:</p><div class="mediaobject"><img src="graphics/3744_13_02.jpg" alt="How to do it…"/></div><p>Our producer sent ten text messages containing the following text: <code class="literal">A message by WildFly Cookbook</code>.</p></li><li class="listitem">So if we now connect to the CLI, we can count the number of messages in our <code class="literal">WildFlyCookbookQueue</code> destination, as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/jboss-cli.sh
You are disconnected at the moment. Type 'connect' to connect to the server or 'help' for the list of supported commands.
[disconnected /] connect
[standalone@localhost:9990 /] jms-queue count-messages --queue-address=WildFlyCookbookQueue
10L</pre></div></li><li class="listitem">The <a id="id997" class="indexterm"/>preceding CLI command <a id="id998" class="indexterm"/>shows, effectively, the <a id="id999" class="indexterm"/>number of messages we <a id="id1000" class="indexterm"/>were expecting. Let's try our consumer by executing the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/github/wildfly-cookbook/jms-consumer
$ mvn clean compile exec:java</pre></div><p>The result of the preceding command is depicted in the following image:</p><div class="mediaobject"><img src="graphics/3744_13_03.jpg" alt="How to do it…"/></div></li></ol></div><p>Great, we <a id="id1001" class="indexterm"/>successfully consumed the messages <a id="id1002" class="indexterm"/>that were stored in our queue!!!</p><p>Furthermore, when <a id="id1003" class="indexterm"/>consuming a message with an <a id="id1004" class="indexterm"/>MDB, if your MDB has a bug, or if it gets an exception for any reason, its process gets rolled back; thus, the message goes to the DLQ.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec301"/>How it works…</h2></div></div></div><p>To be able to understand what we have done and why, we need to look at the default messaging subsystem configuration. For the purpose of this recipe, we will analyze a specific setting such as the <code class="literal">security-setting</code>:</p><div class="informalexample"><pre class="programlisting">&lt;security-settings&gt;
    &lt;security-setting match="#"&gt;
        &lt;permission type="send" roles="guest"/&gt;
        &lt;permission type="consume" roles="guest"/&gt;
        &lt;permission type="createNonDurableQueue" roles="guest"/&gt;
        &lt;permission type="deleteNonDurableQueue" roles="guest"/&gt;
    &lt;/security-setting&gt;
&lt;/security-settings&gt;</pre></div><p>The above XML code snippet defines that any ("#" symbol is a wildcard to indicate any) destination needs to have a specific roles for a specific permission, such as sending and consuming a message. Default settings specify the "guest" role for sending and consuming a message from any queue.</p><p>That's why we <a id="id1005" class="indexterm"/>need to add a user, using the <a id="id1006" class="indexterm"/><code class="literal">add-user</code> script with the role, <code class="literal">guest</code>. Furthermore, why did we need a user at all? </p><p>As we are connecting to the destination remotely using the <code class="literal">http-remoting://localhost:8080</code> address, WildFly uses the remoting subsystem to handle remote connections, which has the following configuration:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;endpoint worker="default"/&gt;
    &lt;http-connector name="http-remoting-connector" connector-ref="default" security-realm="ApplicationRealm"/&gt;
&lt;/subsystem&gt;</pre></div><p>The remoting subsystem <a id="id1007" class="indexterm"/>references the <code class="literal">ApplicationRealm</code> realm, that's why we added the <code class="literal">jmsuser</code> user to that realm.</p><p>On the Java code <a id="id1008" class="indexterm"/>side, we added the user's reference as follows:</p><div class="informalexample"><pre class="programlisting">final Properties env = new Properties();
env.put(Context.INITIAL_CONTEXT_FACTORY, INITIAL_CONTEXT_FACTORY);
env.put(Context.PROVIDER_URL, System.getProperty(Context.PROVIDER_URL, PROVIDER_URL));
<span class="strong"><strong>env.put(Context.SECURITY_PRINCIPAL, System.getProperty("username", DEFAULT_USERNAME));</strong></span>
<span class="strong"><strong>env.put(Context.SECURITY_CREDENTIALS, System.getProperty("password", DEFAULT_PASSWORD));</strong></span>
context = new InitialContext(env);</pre></div><p>If we hadn't specified a user in the Java code (actually omitting the <code class="literal">SECURITY_PRINCIPAL</code> and <code class="literal">SECURITY_CREDENTIALS</code> properties), or even added to the realm, we would have ended up with the following error:</p><div class="informalexample"><pre class="programlisting">Attempting to acquire connection factory "jms/RemoteConnectionFactory"
Found connection factory "jms/RemoteConnectionFactory" in JNDI
Attempting to acquire destination "jms/queue/test"
Found destination "jms/queue/test" in JNDI
<span class="strong"><strong>javax.jms.JMSSecurityException: HQ119031: Unable to validate user: null</strong></span>
<span class="strong"><strong>  at org.hornetq.core.protocol.core.impl.ChannelImpl.sendBlocking(ChannelImpl.java:394)</strong></span>
<span class="strong"><strong>  at org.hornetq.core.client.impl.ClientSessionFactoryImpl.createSessionInternal(ClientSessionFactoryImpl.java:891)</strong></span>
<span class="strong"><strong>  at org.hornetq.core.client.impl.ClientSessionFactoryImpl.createSessionInternal(ClientSessionFactoryImpl.java:800)</strong></span>
<span class="strong"><strong>  at org.hornetq.core.client.impl.ClientSessionFactoryImpl.createSession(ClientSessionFactoryImpl.java:337)</strong></span>
<span class="strong"><strong>  at org.hornetq.jms.client.HornetQConnection.authorize(HornetQConnection.java:719)</strong></span>
<span class="strong"><strong>  at org.hornetq.jms.client.HornetQConnectionFactory.createConnectionInternal(HornetQConnectionFactory.java:762)</strong></span>
<span class="strong"><strong>  at org.hornetq.jms.client.HornetQConnectionFactory.createConnection(HornetQConnectionFactory.java:112)</strong></span>
<span class="strong"><strong>  at org.hornetq.jms.client.HornetQConnectionFactory.createConnection(HornetQConnectionFactory.java:107)</strong></span>
<span class="strong"><strong>  at com.packtpub.wildflycookbook.JMSProducer.main(JMSProducer.java:59)</strong></span>
<span class="strong"><strong>  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</strong></span>
<span class="strong"><strong>  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</strong></span>
<span class="strong"><strong>  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</strong></span>
<span class="strong"><strong>  at java.lang.reflect.Method.invoke(Method.java:483)</strong></span>
<span class="strong"><strong>  at org.codehaus.mojo.exec.ExecJavaMojo$1.run(ExecJavaMojo.java:283)</strong></span>
<span class="strong"><strong>  at java.lang.Thread.run(Thread.java:745)</strong></span>
<span class="strong"><strong>Caused by: HornetQSecurityException[errorType=SECURITY_EXCEPTION message=HQ119031: Unable to validate user: null]</strong></span>
<span class="strong"><strong>  ... 15 more</strong></span>
</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec302"/>There's more…</h2></div></div></div><p>The logic seen <a id="id1009" class="indexterm"/>in the preceding example, also <a id="id1010" class="indexterm"/>applies to Topic. Within the CLI, we <a id="id1011" class="indexterm"/>have pretty much the same commands <a id="id1012" class="indexterm"/>for adding a <code class="literal">topic</code>:</p><div class="informalexample"><pre class="programlisting">[standalone@localhost:9990 /] jms-topic add --topic-address=WildFlyCookbookTopic --entries=topic/test,java:jboss/exported/jms/topic/test</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec303"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Information about the <a id="id1013" class="indexterm"/>JMS specification can be found at <a class="ulink" href="https://jcp.org/aboutJava/communityprocess/final/jsr343/index.html">https://jcp.org/aboutJava/communityprocess/final/jsr343/index.html</a></li><li class="listitem" style="list-style-type: disc">For a deeper understanding of <a id="id1014" class="indexterm"/>the HornetQ server principles, please refer to the official documentation at <a class="ulink" href="http://hornetq.jboss.org">http://hornetq.jboss.org</a></li></ul></div></div></div>
<div class="section" title="Clustering HornetQ using a shared store"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec107"/>Clustering HornetQ using a shared store</h1></div></div></div><p>In this recipe, you <a id="id1015" class="indexterm"/>will learn how to configure HornetQ <a id="id1016" class="indexterm"/>to provide clustering features by configuring to WildFly instances; one acting as a <span class="strong"><strong>Live</strong></span> HornetQ server, the other one acting as a <span class="strong"><strong>Backup</strong></span> HornetQ server.</p><p>The overall configuration can be represented as seen in the following image:</p><div class="mediaobject"><img src="graphics/3744_13_04.jpg" alt="Clustering HornetQ using a shared store"/><div class="caption"><p>Shared store configuration</p></div></div><p>Within the recipe, we will use a local shared store by giving each live and backup server pair the same <code class="literal">data</code> directory. This kind of configuration can also be very useful in both development and test environments to easily simulate high availability and failover capabilities.</p><p>In a production environment, you should provide high availability by having more pairs of live and backup servers, and use a proper filesystem as depicted in the following image:</p><div class="mediaobject"><img src="graphics/3744_13_05.jpg" alt="Clustering HornetQ using a shared store"/><div class="caption"><p>Shared store configuration with high-availability</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec304"/>Getting ready</h2></div></div></div><p>To get started, let's <a id="id1017" class="indexterm"/>first create two <code class="literal">adhoc</code> folders to <a id="id1018" class="indexterm"/>run our WildFly.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In a terminal window, run the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone hq-live
$ cp -a standalone hq-backup</pre></div></li><li class="listitem">For this recipe, we will need two applications named <code class="literal">jms-producer</code> and <code class="literal">jms-consumer</code>, which you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe of <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</li><li class="listitem">To build the application, execute the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/github/wildfly-cookbook
$ cd jms-producer
$ mvn clean package</pre></div></li></ol></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec305"/>How to do it…</h2></div></div></div><p>First of all, we need to <a id="id1019" class="indexterm"/>add a user to the <code class="literal">ApplicationRealm</code> <a id="id1020" class="indexterm"/>realm, which is the one used by the remoting subsystem and hence, the messaging subsystem:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal window and enter the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/add-user.sh --silent -a -u jmsuser -p jmsuser.2015 -g guest -sc hq-live/configuration
$ ./bin/add-user.sh --silent -a -u jmsuser -p jmsuser.2015 -g guest -sc hq-backup/configuration</pre></div></li><li class="listitem">Now edit the file <code class="literal">standalone-full-ha.xml</code> of the <code class="literal">hq-live server</code>, and replace the <code class="literal">messaging</code> subsystem with the following:<div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;hornetq-server&gt;
        &lt;clustered&gt;true&lt;/clustered&gt;
        &lt;persistence-enabled&gt;true&lt;/persistence-enabled&gt;
        &lt;cluster-user&gt;us3r&lt;/cluster-user&gt;
        &lt;cluster-password&gt;p@ssw0rd&lt;/cluster-password&gt;
        &lt;backup&gt;false&lt;/backup&gt;
        &lt;allow-failback&gt;true&lt;/allow-failback&gt;
        &lt;failover-on-shutdown&gt;true&lt;/failover-on-shutdown&gt;
        &lt;check-for-live-server&gt;true&lt;/check-for-live-server&gt;
        &lt;backup-group-name&gt;backup-group-2&lt;/backup-group-name&gt;
        &lt;shared-store&gt;true&lt;/shared-store&gt;
        &lt;journal-type&gt;NIO&lt;/journal-type&gt;
        &lt;journal-min-files&gt;2&lt;/journal-min-files&gt;
        &lt;journal-file-size&gt;102400&lt;/journal-file-size&gt;
        &lt;paging-directory path="hq-data/paging" relative-to="user.home"/&gt;
        &lt;bindings-directory path="hq-data/bindings" relative-to="user.home"/&gt;
        &lt;journal-directory path="hq-data/journal" relative-to="user.home"/&gt;
        &lt;large-messages-directory path="hq-data/large-messages" relative-to="user.home"/&gt;
        &lt;connectors&gt;
            &lt;http-connector name="http-connector" socket-binding="http"&gt;
                &lt;param key="http-upgrade-endpoint" value="http-acceptor"/&gt;
            &lt;/http-connector&gt;
            &lt;http-connector name="http-connector-throughput" socket-binding="http"&gt;
                &lt;param key="http-upgrade-endpoint" value="http-acceptor-throughput"/&gt;
                &lt;param key="batch-delay" value="50"/&gt;
            &lt;/http-connector&gt;
            &lt;in-vm-connector name="in-vm" server-id="0"/&gt;
        &lt;/connectors&gt;
        &lt;acceptors&gt;
            &lt;http-acceptor name="http-acceptor" http-listener="default"/&gt;
            &lt;http-acceptor name="http-acceptor-throughput" http-listener="default"&gt;
                &lt;param key="batch-delay" value="50"/&gt;
                &lt;param key="direct-deliver" value="false"/&gt;
            &lt;/http-acceptor&gt;
            &lt;in-vm-acceptor name="in-vm" server-id="0"/&gt;
        &lt;/acceptors&gt;
        &lt;broadcast-groups&gt;
            &lt;broadcast-group name="bg-group1"&gt;
                &lt;socket-binding&gt;messaging-group&lt;/socket-binding&gt;
                &lt;connector-ref&gt;http-connector&lt;/connector-ref&gt;
            &lt;/broadcast-group&gt;
        &lt;/broadcast-groups&gt;
        &lt;discovery-groups&gt;
            &lt;discovery-group name="dg-group1"&gt;
                &lt;socket-binding&gt;messaging-group&lt;/socket-binding&gt;
            &lt;/discovery-group&gt;
        &lt;/discovery-groups&gt;
        &lt;cluster-connections&gt;
            &lt;cluster-connection name="my-cluster"&gt;
                &lt;address&gt;jms&lt;/address&gt;
                &lt;connector-ref&gt;http-connector&lt;/connector-ref&gt;
                &lt;discovery-group-ref discovery-group-name="dg-group1"/&gt;
            &lt;/cluster-connection&gt;
        &lt;/cluster-connections&gt;
        &lt;security-settings&gt;
            &lt;security-setting match="#"&gt;
                &lt;permission type="send" roles="guest"/&gt;
                &lt;permission type="consume" roles="guest"/&gt;
                &lt;permission type="createNonDurableQueue" roles="guest"/&gt;
                &lt;permission type="deleteNonDurableQueue" roles="guest"/&gt;
            &lt;/security-setting&gt;
        &lt;/security-settings&gt;
        &lt;address-settings&gt;
            &lt;!--default for catch all--&gt;
            &lt;address-setting match="#"&gt;
                &lt;dead-letter-address&gt;jms.queue.DLQ&lt;/dead-letter-address&gt;
                &lt;expiry-
                address&gt;jms.queue.ExpiryQueue&lt;/expiry-
                address&gt;
                &lt;redistribution-delay&gt;1000&lt;/redistribution-delay&gt;
                &lt;max-size-bytes&gt;10485760&lt;/max-size-bytes&gt;
                &lt;page-size-bytes&gt;2097152&lt;/page-size-bytes&gt;
                &lt;message-counter-history-day-limit&gt;10&lt;/message-counter-history-day-
                limit&gt;
            &lt;/address-setting&gt;
        &lt;/address-settings&gt;
        &lt;jms-connection-factories&gt;
            &lt;connection-factory 
            name="InVmConnectionFactory"&gt;
                &lt;connectors&gt;
                    &lt;connector-ref connector-name="in-vm"/&gt;
                &lt;/connectors&gt;
                &lt;entries&gt;
                    &lt;entry name="java:/ConnectionFactory"/&gt;
                &lt;/entries&gt;
            &lt;/connection-factory&gt;
            &lt;connection-factory 
            name="RemoteConnectionFactory"&gt;
                &lt;connectors&gt;
                    &lt;connector-ref connector-name="http-connector"/&gt;
                &lt;/connectors&gt;
                &lt;entries&gt;
                    &lt;entry name="java:jboss/exported/jms/RemoteConnectionFactory"/&gt;
                &lt;/entries&gt;
                &lt;ha&gt;true&lt;/ha&gt;
                &lt;block-on-acknowledge&gt;true&lt;/block-on-acknowledge&gt;
                &lt;retry-interval&gt;500&lt;/retry-interval&gt;
                &lt;retry-interval-multiplier&gt;1.5&lt;/retry-interval-multiplier&gt;
                &lt;max-retry-interval&gt;60000&lt;/max-retry-interval&gt;
                &lt;reconnect-attempts&gt;-1&lt;/reconnect-attempts&gt;
            &lt;/connection-factory&gt;
            &lt;pooled-connection-factory name="hornetq-ra"&gt;
                &lt;transaction mode="xa"/&gt;
                &lt;connectors&gt;
                    &lt;connector-ref connector-name="in-vm"/&gt;
                &lt;/connectors&gt;
                &lt;entries&gt;
                    &lt;entry name="java:/JmsXA"/&gt;
                    &lt;!-- Global JNDI entry used to provide a default JMS Connection factory to EE application --&gt;
                    &lt;entry name="java:jboss/DefaultJMSConnectionFactory"/&gt;
                &lt;/entries&gt;
                &lt;ha&gt;true&lt;/ha&gt;
                &lt;block-on-acknowledge&gt;true&lt;/block-on-acknowledge&gt;
                &lt;retry-interval&gt;500&lt;/retry-interval&gt;
                &lt;retry-interval-multiplier&gt;1.5&lt;/retry-interval-multiplier&gt;
                &lt;max-retry-interval&gt;60000&lt;/max-retry-interval&gt;
                &lt;reconnect-attempts&gt;1000&lt;/reconnect-attempts&gt;
            &lt;/pooled-connection-factory&gt;
        &lt;/jms-connection-factories&gt;
        &lt;jms-destinations&gt;
            &lt;jms-queue name="ExpiryQueue"&gt;
                &lt;entry name="java:/jms/queue/ExpiryQueue"/&gt;
            &lt;/jms-queue&gt;
            &lt;jms-queue name="DLQ"&gt;
                &lt;entry name="java:/jms/queue/DLQ"/&gt;
            &lt;/jms-queue&gt;
            &lt;jms-queue name="WildFlyCookbookQueue"&gt;
                &lt;entry name="queue/test"/&gt;
                &lt;entry name="java:jboss/exported/jms/queue/test"/&gt;
                &lt;durable&gt;true&lt;/durable&gt;
            &lt;/jms-queue&gt;
        &lt;/jms-destinations&gt;
    &lt;/hornetq-server&gt;
&lt;/subsystem&gt;</pre></div></li><li class="listitem">Now it's time to run our WildFly <code class="literal">live</code> instance as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/standalone.sh -Djboss.server.base.dir=hq-live --server-config=standalone-full-ha.xml -Djboss.socket.binding.port-offset=100</pre></div></li><li class="listitem">While <a id="id1021" class="indexterm"/>starting the <code class="literal">live</code> server, edit <a id="id1022" class="indexterm"/>the file <code class="literal">standalone-full-ha.xml</code> of the <code class="literal">hq-backup</code> server, and replace the <code class="literal">messaging</code> subsystem with the following:<div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
    &lt;hornetq-server&gt;
        &lt;clustered&gt;true&lt;/clustered&gt;
        &lt;persistence-enabled&gt;true&lt;/persistence-enabled&gt;
        &lt;cluster-user&gt;us3r&lt;/cluster-user&gt;
        &lt;cluster-password&gt;p@ssw0rd&lt;/cluster-password&gt;
        &lt;backup&gt;true&lt;/backup&gt;
        &lt;allow-failback&gt;true&lt;/allow-failback&gt;
        &lt;failover-on-shutdown&gt;true&lt;/failover-on-shutdown&gt;
        &lt;check-for-live-server&gt;true&lt;/check-for-live-server&gt;
        &lt;backup-group-name&gt;backup-group-2&lt;/backup-group-name&gt;
        &lt;shared-store&gt;true&lt;/shared-store&gt;
        &lt;journal-type&gt;NIO&lt;/journal-type&gt;
        &lt;journal-min-files&gt;2&lt;/journal-min-files&gt;
        &lt;journal-file-size&gt;102400&lt;/journal-file-size&gt;
        &lt;paging-directory path="hq-data/paging" relative-to="user.home"/&gt;
        &lt;bindings-directory path="hq-data/bindings" relative-to="user.home"/&gt;
        &lt;journal-directory path="hq-data/journal" relative-to="user.home"/&gt;
        &lt;large-messages-directory path="hq-data/large-messages" relative-to="user.home"/&gt;
        &lt;connectors&gt;
            &lt;http-connector name="http-connector" socket-binding="http"&gt;
                &lt;param key="http-upgrade-endpoint" value="http-acceptor"/&gt;
            &lt;/http-connector&gt;
            &lt;http-connector name="http-connector-throughput" socket-binding="http"&gt;
                &lt;param key="http-upgrade-endpoint" value="http-acceptor-throughput"/&gt;
                &lt;param key="batch-delay" value="50"/&gt;
            &lt;/http-connector&gt;
            &lt;in-vm-connector name="in-vm" server-id="0"/&gt;
        &lt;/connectors&gt;
        &lt;acceptors&gt;
            &lt;http-acceptor name="http-acceptor" http-listener="default"/&gt;
            &lt;http-acceptor name="http-acceptor-throughput" http-listener="default"&gt;
                &lt;param key="batch-delay" value="50"/&gt;
                &lt;param key="direct-deliver" value="false"/&gt;
            &lt;/http-acceptor&gt;
            &lt;in-vm-acceptor name="in-vm" server-id="0"/&gt;
        &lt;/acceptors&gt;
        &lt;broadcast-groups&gt;
            &lt;broadcast-group name="bg-group1"&gt;
                &lt;socket-binding&gt;messaging-group&lt;/socket-binding&gt;
                &lt;connector-ref&gt;http-connector&lt;/connector-ref&gt;
            &lt;/broadcast-group&gt;
        &lt;/broadcast-groups&gt;
        &lt;discovery-groups&gt;
            &lt;discovery-group name="dg-group1"&gt;
                &lt;socket-binding&gt;messaging-group&lt;/socket-
                binding&gt;
            &lt;/discovery-group&gt;
        &lt;/discovery-groups&gt;
        &lt;cluster-connections&gt;
            &lt;cluster-connection name="my-cluster"&gt;
                &lt;address&gt;jms&lt;/address&gt;
                &lt;connector-ref&gt;http-connector&lt;/connector-ref&gt;
                &lt;discovery-group-ref discovery-group-name="dg-group1"/&gt;
            &lt;/cluster-connection&gt;
        &lt;/cluster-connections&gt;
        &lt;security-settings&gt;
            &lt;security-setting match="#"&gt;
                &lt;permission type="send" roles="guest"/&gt;
                &lt;permission type="consume" roles="guest"/&gt;
                &lt;permission type="createNonDurableQueue" roles="guest"/&gt;
                &lt;permission type="deleteNonDurableQueue" roles="guest"/&gt;
            &lt;/security-setting&gt;
        &lt;/security-settings&gt;
        &lt;address-settings&gt;
            &lt;!--default for catch all--&gt;
            &lt;address-setting match="#"&gt;
                &lt;dead-letter-address&gt;jms.queue.DLQ&lt;/dead-letter-address&gt;
                &lt;expiry-address&gt;jms.queue.ExpiryQueue&lt;/expiry-address&gt;
                &lt;redistribution-delay&gt;1000&lt;/redistribution-delay&gt;
                &lt;max-size-bytes&gt;10485760&lt;/max-size-bytes&gt;
                &lt;page-size-bytes&gt;2097152&lt;/page-size-bytes&gt;
                &lt;message-counter-history-day-limit&gt;10&lt;/message-counter-history-day-limit&gt;
            &lt;/address-setting&gt;
        &lt;/address-settings&gt;
        &lt;jms-connection-factories&gt;
            &lt;connection-factory name="InVmConnectionFactory"&gt;
                &lt;connectors&gt;
                    &lt;connector-ref connector-name="in-vm"/&gt;
                &lt;/connectors&gt;
                &lt;entries&gt;
                    &lt;entry name="java:/ConnectionFactory"/&gt;
                &lt;/entries&gt;
            &lt;/connection-factory&gt;
            &lt;connection-factory name="RemoteConnectionFactory"&gt;
                &lt;connectors&gt;
                    &lt;connector-ref connector-name="http-connector"/&gt;
                &lt;/connectors&gt;
                &lt;entries&gt;
                    &lt;entry name="java:jboss/exported/jms/RemoteConnectionFactory"/&gt;
                &lt;/entries&gt;
                &lt;ha&gt;true&lt;/ha&gt;
                &lt;block-on-acknowledge&gt;true&lt;/block-on-acknowledge&gt;
                &lt;retry-interval&gt;500&lt;/retry-interval&gt;
                &lt;retry-interval-multiplier&gt;1.5&lt;/retry-interval-multiplier&gt;
                &lt;max-retry-interval&gt;60000&lt;/max-retry-interval&gt;
                &lt;reconnect-attempts&gt;1000&lt;/reconnect-attempts&gt;
            &lt;/connection-factory&gt;
            &lt;pooled-connection-factory name="hornetq-ra"&gt;
                &lt;transaction mode="xa"/&gt;
                &lt;connectors&gt;
                    &lt;connector-ref connector-name="in-vm"/&gt;
                &lt;/connectors&gt;
                &lt;entries&gt;
                    &lt;entry name="java:/JmsXA"/&gt;
                    &lt;!-- Global JNDI entry used to provide a default JMS Connection factory to EE 
                    application --&gt;
                    &lt;entry name="java:jboss/DefaultJMSConnectionFactory"/&gt;
                &lt;/entries&gt;
                &lt;ha&gt;true&lt;/ha&gt;
            &lt;/pooled-connection-factory&gt;
        &lt;/jms-connection-factories&gt;
        &lt;jms-destinations&gt;
            &lt;jms-queue name="ExpiryQueue"&gt;
                &lt;entry name="java:/jms/queue/ExpiryQueue"/&gt;
            &lt;/jms-queue&gt;
            &lt;jms-queue name="DLQ"&gt;
                &lt;entry name="java:/jms/queue/DLQ"/&gt;
            &lt;/jms-queue&gt;
            &lt;jms-queue name="WildFlyCookbookQueue"&gt;
                &lt;entry name="queue/test"/&gt;
                &lt;entry name="java:jboss/exported/jms/queue/test"/&gt;
                &lt;durable&gt;true&lt;/durable&gt;
            &lt;/jms-queue&gt;
        &lt;/jms-destinations&gt;
    &lt;/hornetq-server&gt;
&lt;/subsystem&gt;</pre></div></li><li class="listitem">You can now start the WildFly <code class="literal">backup</code> instance as follows:<div class="informalexample"><pre class="programlisting">/bin/standalone.sh -Djboss.server.base.dir=hq-backup -c standalone-full-ha.xml -Djboss.socket.binding.port-offset=200</pre></div></li><li class="listitem">Within the <a id="id1023" class="indexterm"/>live server's log you should <a id="id1024" class="indexterm"/>find the following entries:<div class="informalexample"><pre class="programlisting">...
16:48:42,918 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221034: Waiting to obtain live lock
16:48:42,918 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221035: Live Server Obtained live lock
16:48:43,073 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221007: Server is now live
16:48:43,073 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 68) HQ221001: HornetQ Server version 2.4.5.FINAL (Wild Hornet, 124) [adcd3a5c-1e60-11e5-877d-c36458d7eaba]
...
16:48:43,326 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:10090/management
16:48:43,327 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:10090
16:48:43,327 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 9.0.0.Beta2 (WildFly Core 1.0.0.Beta2) started in 3298ms - Started 249 of 481 services (282 services are lazy, passive or on-demand)</pre></div></li><li class="listitem">Whilst <a id="id1025" class="indexterm"/>within the backup server's log, you <a id="id1026" class="indexterm"/>should find the following entries:<div class="informalexample"><pre class="programlisting">16:51:21,298 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221032: Waiting to become backup node
16:51:21,301 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221033: ** got backup lock
16:51:21,329 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221013: Using NIO Journal
16:51:21,636 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221043: Adding protocol support CORE
16:51:21,641 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221043: Adding protocol support AMQP
16:51:21,645 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221043: Adding protocol support STOMP
16:51:21,667 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221109: HornetQ Backup Server version 2.4.5.FINAL (Wild Hornet, 124) [adcd3a5c-1e60-11e5-877d-c36458d7eaba] started, waiting live to fail before it gets active
16:51:21,742 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:10190/management
16:51:21,742 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:10190
16:51:21,742 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 9.0.0.Beta2 (WildFly Core 1.0.0.Beta2) started in 3001ms - Started 235 of 475 services (281 services are lazy, passive or on-demand)
16:51:23,288 INFO  [org.hornetq.core.server] (Thread-0 (HornetQ-server-HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba-640469128)) HQ221031: backup announced</pre></div><p>Both the <a id="id1027" class="indexterm"/>live and backup <a id="id1028" class="indexterm"/>servers' log entries confirm our configuration: the live server had gained the lock of the data directory, while the backup is waiting to acquire the lock and it has announced itself as the backup.</p></li></ol></div><p>Now it's time to do some tests.</p><div class="section" title="Testing"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl3sec68"/>Testing</h3></div></div></div><p>To test our configurations, we <a id="id1029" class="indexterm"/>need to first produce some messages, then check if the messages have been stored, and then consume them. In this case, compile the <code class="literal">jms-producer</code> project as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's produce some messages with the <code class="literal">jms-producer</code> project as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/github/wildfly-cookbook
$ cd jms-producer
$ mvn clean package
$ mvn exec:java
...
Attempting to acquire connection factory "jms/RemoteConnectionFactory"
Found connection factory "jms/RemoteConnectionFactory" in JNDI
Attempting to acquire destination "jms/queue/test"
Found destination "jms/queue/test" in JNDI
Sending messages with content: A message by WildFly Cookbook
    Sending messages with content [0]: A message by WildFly Cookbook
    Sending messages with content [1]: A message by WildFly Cookbook
    Sending messages with content [2]: A message by WildFly 
    Cookbook
    Sending messages with content [3]: A message by WildFly Cookbook
    Sending messages with content [4]: A message by WildFly Cookbook
    Sending messages with content [5]: A message by WildFly Cookbook
    Sending messages with content [6]: A message by WildFly Cookbook
    Sending messages with content [7]: A message by WildFly Cookbook
    Sending messages with content [8]: A message by WildFly Cookbook
    Sending messages with content [9]: A message by WildFly Cookbook
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 11.234 s
[INFO] Finished at: 2015-06-29T16:03:33+02:00
[INFO] Final Memory: 15M/298M
[INFO] ------------------------------------------------------------------------</pre></div></li><li class="listitem">Now, if you check the <a id="id1030" class="indexterm"/>message count, you will find ten messages on the live server. To check, execute the following:<div class="informalexample"><pre class="programlisting">[standalone@127.0.0.1:10090 /] jms-queue count-messages --queue-address=WildFlyCookbookQueue
10L
[standalone@127.0.0.1:10090 /]</pre></div></li><li class="listitem">If you invoke the preceding command on the backup server, you will get the following error:<div class="informalexample"><pre class="programlisting">[standalone@127.0.0.1:10190 /] jms-queue count-messages --queue-address=WildFlyCookbookQueue
WFLYMSG0066: Resource at the address [
    ("subsystem" =&gt; "messaging"),
    ("hornetq-server" =&gt; "default"),
    ("jms-queue" =&gt; "WildFlyCookbookQueue")
] can not be managed, the hornetq-server is in backup mode
[standalone@127.0.0.1:10190 /]</pre></div></li><li class="listitem">If you stop the live <a id="id1031" class="indexterm"/>server, the backup server should become the new live server. You should find the following log entries on the backup server:<div class="informalexample"><pre class="programlisting">17:58:09,698 WARN  [org.hornetq.core.client] (Thread-1 (HornetQ-client-global-threads-1744891225)) HQ212037: Connection failure has been detected: HQ119015: The connection was disconnected because of server shutdown [code=DISCONNECTED]
17:58:09,898 INFO  [org.jboss.messaging] (MSC service thread 1-10) WFLYMSG0016: Registered HTTP upgrade for hornetq-remoting protocol handled by http-acceptor acceptor
17:58:09,898 INFO  [org.jboss.messaging] (MSC service thread 1-16) WFLYMSG0016: Registered HTTP upgrade for hornetq-remoting protocol handled by http-acceptor-throughput acceptor
17:58:09,900 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 72) HQ221003: trying to deploy queue jms.queue.ExpiryQueue
17:58:09,905 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 76) HQ221003: trying to deploy queue jms.queue.WildFlyCookbookQueue
17:58:09,916 INFO  [org.jboss.as.messaging] (ServerService Thread Pool -- 75) WFLYMSG0002: Bound messaging object to jndi name java:jboss/exported/jms/RemoteConnectionFactory
17:58:09,916 INFO  [org.hornetq.core.server] (ServerService Thread Pool -- 74) HQ221003: trying to deploy queue jms.queue.DLQ
17:58:09,918 INFO  [org.jboss.as.messaging] (ServerService Thread Pool -- 73) WFLYMSG0002: Bound messaging object to jndi name java:/ConnectionFactory
17:58:09,918 INFO  [org.hornetq.core.server] (HQ119000: Activation for server HornetQServerImpl::serverUUID=adcd3a5c-1e60-11e5-877d-c36458d7eaba) HQ221010: Backup Server is now live
17:58:09,956 INFO  [org.jboss.as.connector.deployment] (MSC service thread 1-2) WFLYJCA0007: Registered connection factory java:/JmsXA
17:58:09,971 INFO  [org.hornetq.ra] (MSC service thread 1-2) HornetQ resource adaptor started
17:58:09,971 INFO  [org.jboss.as.connector.services.resourceadapters.ResourceAdapterActivatorService$ResourceAdapterActivator] (MSC service thread 1-2) IJ020002: Deployed: file://RaActivatorhornetq-ra
17:58:09,973 INFO  [org.jboss.as.connector.deployment] (MSC service thread 1-4) WFLYJCA0002: Bound JCA ConnectionFactory [java:/JmsXA]
17:58:09,973 INFO  [org.jboss.as.messaging] (MSC service thread 1-11) WFLYMSG0002: Bound messaging object to jndi name java:jboss/DefaultJMSConnectionFactory</pre></div></li><li class="listitem">If you invoke the count <a id="id1032" class="indexterm"/>message command on the old backup server again, you will see it has all the messages that were produced earlier:<div class="informalexample"><pre class="programlisting">[standalone@127.0.0.1:10190 /] jms-queue count-messages --queue-address=WildFlyCookbookQueue
10L
[standalone@127.0.0.1:10190 /]</pre></div></li></ol></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec306"/>How it works…</h2></div></div></div><p>The mechanism behind the failover is pretty simple; because HornetQ bases its persistence on filesystem, it makes a lock on the data storage folder. Basically, for the same folder, the first server to arrive owns the lock and hence, wins. The second server then keeps on trying to gain the lock on the same data directory until it gets it, which means the live server has shutdown or crashed.</p><p>When the backup server gains the lock, it reads all the messages stored in the data directory; it is available to store more messages and clients consume them.</p><p>What happens if the live server crashes while a client is producing or consuming messages?</p><p>Because of the failover and high-availability configuration (<code class="literal">&lt;ha&gt;true&lt;/ha&gt;</code> in both, <code class="literal">&lt;connection-factory name="RemoteConnectionFactory"&gt;</code> and <code class="literal">&lt;pooled-connection-factory name="hornetq-ra"&gt;</code>), the client automatically reconnects to the first available live server. The client has the topology on the live and backup servers.</p><p>While producing the messages, try stopping the live server. You should get an output similar to what is depicted in the following image:</p><div class="mediaobject"><img src="graphics/3744_13_06.jpg" alt="How it works…"/><div class="caption"><p>Client reconnects to the first available live server while producing messages</p></div></div><p>The same applies when consuming <a id="id1033" class="indexterm"/>messages. Following is an image showing what you should get:</p><div class="mediaobject"><img src="graphics/3744_13_07.jpg" alt="How it works…"/><div class="caption"><p>Client reconnects to the first available live server while consuming messages</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec307"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">As mentioned in the introduction, there is a lot to talk about HornetQ, JMS, and MOM in general, but it's out of the scope of this book. For this reason, I suggest you read the book <span class="emphasis"><em>HornetQ Messaging Developer's Guide</em></span>, <span class="emphasis"><em>Piero Giacomelli</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>, which goes deep into the development aspects of the framework and the JMS specification.</li><li class="listitem" style="list-style-type: disc">Also, the jboss.org community has done a great job in providing us all with information about HornetQ, which <a id="id1034" class="indexterm"/>is freely available at <a class="ulink" href="http://hornetq.jboss.org">http://hornetq.jboss.org</a>.</li><li class="listitem" style="list-style-type: disc">Last, but not least, the <a id="id1035" class="indexterm"/>JMS specification is available at <a class="ulink" href="https://jcp.org/aboutJava/communityprocess/final/jsr343/index.html">https://jcp.org/aboutJava/communityprocess/final/jsr343/index.html</a>.</li></ul></div></div></div>
<div class="section" title="Clustering HornetQ using message replication"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec108"/>Clustering HornetQ using message replication</h1></div></div></div><p>In this <a id="id1036" class="indexterm"/>recipe, we will learn how to configure a <a id="id1037" class="indexterm"/>cluster with a live and a backup HornetQ server.</p><p>HornetQ cluster environment can be achieved by using a shared store (live and backup servers share the same and the entire data directory) as per the previous recipe, or via message replication which happens at the network layer—message replication mode can be achieved using the following setting:</p><div class="informalexample"><pre class="programlisting">&lt;shared-store&gt;false&lt;/shared-store&gt;</pre></div><p>Our final configuration should provide the following architecture:</p><div class="mediaobject"><img src="graphics/3744_13_08.jpg" alt="Clustering HornetQ using message replication"/><div class="caption"><p>Message replication configuration</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec308"/>Getting ready</h2></div></div></div><p>To get started, let's first create an <code class="literal">adhoc</code> folder to run our WildFly.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In a terminal window, enter the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ cp -a standalone hq-node-1
$ cp -a standalone hq-node-2</pre></div></li><li class="listitem">Provide the application user for both the servers to send and receive messages, as follows:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME
$ ./bin/add-user.sh --silent -a -u jmsuser -p jmsuser.2015 -g guest -sc hq-node-1/configuration
$ ./bin/add-user.sh --silent -a -u jmsuser -p jmsuser.2015 -g guest -sc hq-node-1/configuration</pre></div></li><li class="listitem">For this <a id="id1038" class="indexterm"/>recipe, we will need an application named <code class="literal">cluster-jms-replication</code>, which you can find in my GitHub repository. If you skipped the <span class="emphasis"><em>Managing applications using the deployments folder</em></span> recipe of <a class="link" href="ch02.html" title="Chapter 2. Running WildFly in Standalone Mode">Chapter 2</a>, <span class="emphasis"><em>Running WildFly in Standalone Mode</em></span>, please refer to it to download all the source code and projects that you will need.</li><li class="listitem">To build the application, run the following commands:<div class="informalexample"><pre class="programlisting">$ cd $WILDFLY_HOME/github/wildfly-cookbook
$ cd cluster-jms-replication
$ mvn clean package</pre></div></li></ol></div><p>Now it's time to configure our HornetQ servers in WildFly!!!</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec309"/>How to do it…</h2></div></div></div><p>To configure our servers, we will rely on the configuration present in my GitHub repository, named <code class="literal">wildfly-cookbook</code>. There you can find a project named <code class="literal">cluster-jms-replication</code>, which has been provided by the reviewer Kylin Soong.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the folder where you download the repository (<code class="literal">~/WFC/github/wildfly-cookbook</code>), there is a project called <code class="literal">cluster-jms-replication</code>. From within the folder of the project, execute the following:<div class="informalexample"><pre class="programlisting">$ mvn clean install
$ cp standalone-full-ha-1.xml $WILDFLY_HOME/node1/configuration/
$ cp standalone-full-ha-2.xml $WILDFLY_HOME/node2/configuration/
$ cp queue-jms.xml $WILDFLY_HOME/node1/deployments/
$ cp queue-jms.xml $WILDFLY_HOME/node2/deployments/
$ cp target/cluster-demo-jms.jar $WILDFLY_HOME/node1/deployments/
$ cp target/cluster-demo-jms.jar $WILDFLY_HOME/node2/deployments/</pre></div></li><li class="listitem">Now we are ready to start our servers as follows:<div class="informalexample"><pre class="programlisting">$ ./bin/standalone.sh -c standalone-full-ha-1.xml -Djboss.server.base.dir=node1
$ ./bin/standalone.sh -c standalone-full-ha-2.xml -Djboss.server.base.dir=node2 -Djboss.socket.binding.port-offset=100</pre></div></li><li class="listitem">Once the <a id="id1039" class="indexterm"/>servers are started, go to the <code class="literal">cluster-jms-replication</code> project folder and invoke the following command:<div class="informalexample"><pre class="programlisting">$ mvn exec:java</pre></div></li><li class="listitem">This will send ten messages to the HornetQ cluster. In the <code class="literal">node1</code> server log entries, you should find the following:<div class="informalexample"><pre class="programlisting">12:07:02,323 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-1050658442)) 3: WildFly 9 HornetQ Messaging High Available
12:07:12,334 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-1050658442)) 5: WildFly 9 HornetQ Messaging High Available
12:07:22,344 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-1050658442)) 7: WildFly 9 HornetQ Messaging High Available
12:07:32,355 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-1050658442)) 9: WildFly 9 HornetQ Messaging High Available</pre></div><p>Within the <code class="literal">node2</code> server log entries, you should find the following:</p><div class="informalexample"><pre class="programlisting">12:06:52,350 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-589728564)) 2: WildFly 9 HornetQ Messaging High Available
12:07:02,358 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-589728564)) 4: WildFly 9 HornetQ Messaging High Available
12:07:12,363 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-589728564)) 6: WildFly 9 HornetQ Messaging High Available
12:07:22,370 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-589728564)) 8: WildFly 9 HornetQ Messaging High Available
12:07:32,379 INFO  [stdout] (Thread-7 (HornetQ-client-global-threads-589728564)) 10: WildFly 9 HornetQ Messaging High Available</pre></div></li><li class="listitem">Now we will try a failover test by sending the first couple of messages to <code class="literal">node1</code>, and then stop it (regular shutdown or kill is the same). Again go to the <code class="literal">cluster-jms-replication</code> project folder, and invoke the following command:<div class="informalexample"><pre class="programlisting">$ mvn exec:java</pre></div></li><li class="listitem">Now, as <a id="id1040" class="indexterm"/>soon as you get the first two messages on server <code class="literal">node1</code>, stop it. At the end of the process, you should get the following log entries:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">node1</code><div class="informalexample"><pre class="programlisting">12:15:44,592 INFO  [stdout] (Thread-13 (HornetQ-client-global-threads-1050658442)) 1: WildFly 9 HornetQ Messaging High Available
12:15:54,602 INFO  [stdout] (Thread-13 (HornetQ-client-global-threads-1050658442)) 3: WildFly 9 HornetQ Messaging High Available</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">node2</code><div class="informalexample"><pre class="programlisting">12:15:44,599 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 2: WildFly 9 HornetQ Messaging High Available
12:15:54,606 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 4: WildFly 9 HornetQ Messaging High Available
12:16:04,613 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 6: WildFly 9 HornetQ Messaging High Available
<span class="strong"><strong>... Errors and Warnings ...</strong></span>
12:16:14,622 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 8: WildFly 9 HornetQ Messaging High Available
12:16:24,629 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 10: WildFly 9 HornetQ Messaging High Available
12:16:34,642 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 5: WildFly 9 HornetQ Messaging High Available
12:16:44,653 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 7: WildFly 9 HornetQ Messaging High Available
12:16:54,663 INFO  [stdout] (Thread-12 (HornetQ-client-global-threads-589728564)) 9: WildFly 9 HornetQ Messaging High Available</pre></div></li></ul></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec310"/>How it works…</h2></div></div></div><p>There are quite a few things that need to be explained. Beware that only the persistent messages are replicated to the backup server. Thus, non-persistent messages will not fail over. In the live configuration, we added the following directives:</p><div class="informalexample"><pre class="programlisting">&lt;backup&gt;false&lt;/backup&gt;
&lt;failover-on-shutdown&gt;true&lt;/failover-on-shutdown&gt;
&lt;check-for-live-server&gt;true&lt;/check-for-live-server&gt;</pre></div><p>The first one is <a id="id1041" class="indexterm"/>quite obvious; it defines that the server will be the live one. The <code class="literal">failover-on-shutdown</code> means that the server will fail over to the backup servers, even in case of normal server shutdown, as we did in our test.</p><p>The <code class="literal">check-for-live-server</code> directive is used along with the <code class="literal">allow-failback</code>, present in the backup server configuration:</p><div class="informalexample"><pre class="programlisting">&lt;backup&gt;true&lt;/backup&gt;
&lt;failover-on-shutdown&gt;true&lt;/failover-on-shutdown&gt;
&lt;allow-failback&gt;true&lt;/allow-failback&gt;</pre></div><p>Basically, when the live server comes back up, it checks if there was a failover by contacting the other backup servers, and issuing a shutdown on the current live one for it to take over.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec311"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">As mentioned in the introduction, there is a lot to talk about HornetQ, JMS, and MOM in general, but it's out of the scope of this book. For this reason, I suggest you read the book <span class="emphasis"><em>HornetQ Messaging Developer's Guide</em></span>, <span class="emphasis"><em>Piero Giacomelli</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>, which goes deep into the development aspects of the framework and the JMS specification.</li><li class="listitem" style="list-style-type: disc">Also, the jboss.org community has done a great job in providing us all with information about HornetQ, which is freely available at <a class="ulink" href="http://hornetq.jboss.org">http://hornetq.jboss.org</a>.</li><li class="listitem" style="list-style-type: disc">Last, but not least, the <a id="id1042" class="indexterm"/>JMS specification is available at <a class="ulink" href="https://jcp.org/aboutJava/communityprocess/final/jsr343/index.html">https://jcp.org/aboutJava/communityprocess/final/jsr343/index.html</a>.</li></ul></div></div></div></body></html>